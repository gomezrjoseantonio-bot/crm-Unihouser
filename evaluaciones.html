<!DOCTYPE html>
<html lang="es" data-theme="professional">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluaciones</title>
<link rel="icon" href="data:,">
<link rel="stylesheet" href="css/style.css">

<script>
/* Apply brand settings from configuration */
try{
  const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
  if(cfg.brand_color) document.documentElement.style.setProperty('--brand-primary', cfg.brand_color);
  if(cfg.ui_font) document.documentElement.style.setProperty('--font-family', cfg.ui_font);
  if(cfg.ui_font_size) document.documentElement.style.setProperty('--font-size-base', (''+cfg.ui_font_size).replace('px','')+'px');
  if(cfg.ui_theme) document.documentElement.setAttribute('data-theme', cfg.ui_theme);
  if(cfg.brand_logo) {
    window.addEventListener('DOMContentLoaded', () => {
      const logoBox = document.getElementById('logoBox');
      if(logoBox && cfg.brand_logo) {
        logoBox.innerHTML = `<img src="${cfg.brand_logo}" alt="Logo">`;
      }
    });
  }
}catch(_){}
</script>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="brand">
        <div class="logo-container" id="logoBox">
          <div class="logo-fallback">U</div>
        </div>
        <div class="title" id="brandTitle">Unihouser — Evaluaciones</div>
      </div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html" class="active">Evaluaciones</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
h2{margin:0 0 8px}
h3{margin:0 0 6px;font-size:14px;color:#444}

/* KPIs */
.kpis{display:grid;gap:8px;grid-template-columns:repeat(4,1fr)}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.kpi .lab{font-size:11px;color:#667085}
.kpi .val{font-weight:800;font-size:18px}

/* Filtros */
.filters .row{display:grid;gap:8px;grid-template-columns:2fr 1fr 1fr 1fr auto auto auto}
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:11px;color:#555}
input,select,textarea{border:1px solid var(--line);border-radius:10px;padding:6px 7px;background:#fff;font-size:12px;color:#1a1f23}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:800;font-size:12px}
.btn.primary{background:var(--brand);color:#fff;border:none}

/* Tabla responsive */
.table-wrap{overflow:auto}
.table{min-width:980px;width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{padding:9px 10px;border-bottom:1px dashed var(--line);text-align:left;font-size:12px;white-space:nowrap}
.table th{background:#FAF8F7;color:#1a1f23;cursor:pointer;position:sticky;top:0;z-index:1}
.table tr:last-child td{border-bottom:none}
.pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;background:var(--chip);font-size:11px;border:1px solid var(--line)}

/* Acciones */
.actions-cell{display:flex;gap:6px;align-items:center}
.iconbtn{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.iconbtn:hover{background:#f3efe9}
.icon{width:18px;height:18px;display:block}

/* Modal (sustituye drawer) */
.modal-back{position:fixed;inset:0;background:rgba(15,18,20,.28);display:none;align-items:center;justify-content:center;z-index:120}
.modal-back.open{display:flex}
.modal{width:960px;max-width:95vw;max-height:90vh;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.22);display:flex;flex-direction:column;overflow:hidden}
.modal header{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
.modal h4{margin:0}
.modal .body{padding:12px;display:grid;gap:10px;grid-template-columns:1.2fr 1fr}
@media(max-width:980px){.modal .body{grid-template-columns:1fr}}
.modal footer{padding:10px 12px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

/* Bloques modal */
.block{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:8px}
.block h4{margin:0 0 6px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
.kv .k{font-size:11px;color:#667085}
.kv .v{font-weight:700}

/* Adjuntos */
.attach-wrap{display:grid;gap:8px}
.attach-grid{display:grid;gap:6px;grid-template-columns:repeat(auto-fit,minmax(90px,1fr))}
.thumb{position:relative;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:#fff;height:64px;cursor:pointer}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.thumb .mini{display:flex;align-items:center;justify-content:center;height:100%;font-size:10px;color:#333;text-align:center;line-height:1.15}
.thumb .x{position:absolute;top:3px;right:3px;background:#fff;border:1px solid var(--line);border-radius:8px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* Candidatos (solo lectura) */
.cands{display:grid;gap:8px}
.cand{border:1px solid var(--line);border-radius:10px;padding:8px;display:grid;gap:4px}
.cand .top{display:flex;align-items:center;gap:8px}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.dot.g{background:#16a34a}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
.badges{display:flex;flex-wrap:wrap;gap:6px}
.badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid var(--line);background:#f9fafb}
.badge.warn{border-color:#fde68a;background:#fff7ed;color:#b45309}
.badge small{font-weight:700}
.note{font-size:11px;color:#667085}

/* Lightbox imágenes */
.lb-back{position:fixed;inset:0;background:rgba(0,0,0,.82);display:none;align-items:center;justify-content:center;z-index:130}
.lb-back.open{display:flex}
.lb-inner{position:relative;max-width:95vw;max-height:90vh}
.lb-inner img{max-width:95vw;max-height:90vh;display:block}
.lb-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.2);border:none;color:#fff;font-weight:800;border-radius:10px;padding:10px;cursor:pointer}
.lb-prev{left:-52px} .lb-next{right:-52px}
.lb-close{position:absolute;top:-44px;right:0;background:#fff;border:none;border-radius:999px;padding:6px 10px;cursor:pointer}

/* Toasts */
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:140}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}

/* Footer centered */
.footer{margin:14px 0 22px;text-align:center;color:#888;font-size:11px}

@media (max-width:1100px){.filters .row{grid-template-columns:1fr 1fr}}
</style>

<script>
/* Aplicar marca y tipografía desde cfg */
try{
  const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
  if(cfg.brand_color) document.documentElement.style.setProperty('--brand', cfg.brand_color);
  if(cfg.ui_font) document.documentElement.style.setProperty('--ui-font', cfg.ui_font);
  if(cfg.ui_font_size) document.documentElement.style.setProperty('--ui-font-size', (''+cfg.ui_font_size).replace('px','')+'px');
}catch(_){}
</script>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo" id="logoTop">U</div><div class="title" id="titleTop">Unihouser — Evaluaciones</div></div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a class="active" href="evaluaciones.html">Evaluaciones</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <section class="card">
      <h2>Evaluaciones</h2>

      <div class="kpis" style="margin-top:6px">
        <div class="kpi"><div class="lab">Total evaluaciones</div><div class="val" id="k_total">0</div></div>
        <div class="kpi"><div class="lab">Asignadas</div><div class="val" id="k_asig">0</div></div>
        <div class="kpi"><div class="lab">Bruta media</div><div class="val" id="k_bruta">0,0 %</div></div>
        <div class="kpi"><div class="lab">Neta media</div><div class="val" id="k_neta">0,0 %</div></div>
      </div>

      <div class="card" style="margin-top:10px">
        <h3 style="margin:0 0 6px">Filtros</h3>
        <div class="filters">
          <div class="row">
            <div class="field"><label>Buscar</label><input id="f_text" placeholder="Localidad o calle"></div>
            <div class="field"><label>Tipo</label>
              <select id="f_tipo"><option value="">Todos</option><option>Tradicional</option><option>Habitaciones</option></select>
            </div>
            <div class="field"><label>Desde</label><input id="f_desde" type="date"></div>
            <div class="field"><label>Hasta</label><input id="f_hasta" type="date"></div>
            <div class="field" style="align-self:end"><button class="btn" id="b_limpiar">Limpiar</button></div>
            <div class="field" style="align-self:end"><button class="btn primary" id="b_filtrar">Filtrar</button></div>
            <div class="field" style="align-self:end"><button class="btn" id="b_export">Exportar CSV</button></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="table-wrap">
          <table class="table" id="tbl">
            <thead>
              <tr>
                <th data-k="ts">Fecha</th>
                <th data-k="loc">Localidad</th>
                <th data-k="calle">Calle</th>
                <th data-k="tipo">Tipo</th>
                <th data-k="precio" style="text-align:right">Precio</th>
                <th data-k="alq" style="text-align:right">Alquiler</th>
                <th data-k="kpi_bruta" style="text-align:right">Bruta %</th>
                <th data-k="kpi_neta" style="text-align:right">Neta %</th>
                <th data-k="kpi_flujo" style="text-align:right">Flujo</th>
                <th data-k="pmax" style="text-align:right">P. máx</th>
                <th data-k="adj" style="text-align:center">Adjuntos</th>
                <th data-k="asig" style="text-align:center">Asignados</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <footer class="footer">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</footer>

  <!-- MODAL FICHA + ADJUNTOS -->
  <div id="mBack" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Ficha de evaluación" aria-modal="true">
      <header>
        <h4 id="m_title">Ficha</h4>
        <div style="display:flex;gap:8px">
          <button class="btn" id="m_eval">Abrir en Evaluar</button>
          <button class="btn" id="m_close">Cerrar</button>
        </div>
      </header>
      <div class="body">
        <!-- IZQUIERDA: RESUMEN + CANDIDATOS -->
        <div style="display:grid;gap:10px">
          <div class="block">
            <h4>Resumen</h4>
            <div class="kv">
              <div class="k">Fecha</div><div class="v" id="m_fecha">—</div>
              <div class="k">Localidad</div><div class="v" id="m_loc">—</div>
              <div class="k">Calle</div><div class="v" id="m_calle">—</div>
              <div class="k">Tipo</div><div class="v" id="m_tipo">—</div>
              <div class="k">Precio</div><div class="v" id="m_precio">—</div>
              <div class="k">ITP</div><div class="v" id="m_itp">—</div>
              <div class="k">Notaría</div><div class="v" id="m_notaria">—</div>
              <div class="k">PSI</div><div class="v" id="m_psi">—</div>
              <div class="k">Reforma</div><div class="v" id="m_reforma">—</div>
              <div class="k">Inversión total</div><div class="v" id="m_inv">—</div>
              <div class="k">Alquiler</div><div class="v" id="m_alq">—</div>
              <div class="k">Bruta</div><div class="v" id="m_bruta">—</div>
              <div class="k">Neta</div><div class="v" id="m_neta">—</div>
              <div class="k">Flujo anual</div><div class="v" id="m_flujo">—</div>
              <div class="k">P. máx</div><div class="v" id="m_pmax">—</div>
              <div class="k">URL</div><div class="v" id="m_url">—</div>
            </div>
          </div>

          <div class="block">
            <h4>Candidatos potenciales</h4>
            <div id="m_hint" class="note">—</div>
            <div id="m_cands" class="cands">—</div>
          </div>
        </div>

        <!-- DERECHA: ADJUNTOS -->
        <div class="block">
          <h4>Adjuntar archivos</h4>
          <div class="attach-wrap">
            <div>
              <div class="uploader"><strong>Imágenes</strong> <input id="up_imgs" type="file" accept="image/*" multiple></div>
              <div id="grid_imgs" class="attach-grid"></div>
            </div>
            <div>
              <div class="uploader"><strong>Vídeos</strong> <input id="up_vids" type="file" accept="video/*" multiple></div>
              <div id="grid_vids" class="attach-grid"></div>
            </div>
            <div>
              <div class="uploader"><strong>PDFs</strong> <input id="up_pdfs" type="file" accept="application/pdf" multiple></div>
              <div id="grid_pdfs" class="attach-grid"></div>
            </div>
          </div>
        </div>
      </div>
      <footer>
        <span class="note" id="m_note">Los adjuntos se guardan automáticamente.</span>
      </footer>
    </div>
  </div>

  <!-- Lightbox imágenes -->
  <div class="lb-back" id="lbBack" aria-hidden="true">
    <div class="lb-inner">
      <button class="lb-btn lb-prev" id="lbPrev" aria-label="Anterior">‹</button>
      <img id="lbImg" alt="Vista" />
      <button class="lb-btn lb-next" id="lbNext" aria-label="Siguiente">›</button>
      <button class="lb-close" id="lbClose" aria-label="Cerrar">✕</button>
    </div>
  </div>

  <div id="toasts" class="toast-wrap"></div>

<script>
(function(){
"use strict";

/* Brand name/initial */
try{
  const cfg=JSON.parse(localStorage.getItem('cfg')||'{}')||{};
  const name=cfg.brand_name||cfg.company_name||'Unihouser';
  document.getElementById('titleTop').textContent = name+' — Evaluaciones';
  document.getElementById('logoTop').textContent  = (name||'U').toString().trim().charAt(0).toUpperCase()||'U';
}catch(_){}

/* Utils */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
const n0 = v=>fmtN0.format(Number(v||0));
const parseNum = v=>Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
function toPct(raw){ let v=Number(raw||0); if(v>0&&v<=1)v*=100; while(v>=100)v/=10; return v; }
function toast(msg,kind){
  const wrap=id('toasts'); const el=document.createElement('div');
  el.className='toast '+(kind||''); el.textContent=msg; wrap.appendChild(el);
  setTimeout(()=>el.style.opacity='0',1600); setTimeout(()=>{try{wrap.removeChild(el)}catch(_){}} ,2200);
}
function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function fold(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();}

/* Store */
const Store={
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}
};

/* CFG helpers (umbrales y objetivos mínimos) */
function cfgThresholds(){
  const c=Store.cfg||{}; const m=(c.match&&c.match.thresholds)||{green:1,amber:0.95};
  return {g:Number(m.green||1), a:Number(m.amber||0.95)};
}
function cfgCosts(){
  const c=Store.cfg||{}; const itp_raw=Number(c.itp_pct??c.itp??8); // acepta 8 o 0.08*100
  const itp = (itp_raw<1? itp_raw : itp_raw/100);
  const notaria = Number(c.notaria ?? c.notaria_eur ?? 1500);
  const psi = Number(c.honorarios ?? c.psi_fee_eur ?? 4235);
  return {itp, notaria, psi};
}
function cfgObjMinBruta(tipo){
  const c=Store.cfg||{}; const o=c.objetivos||{};
  if(fold(tipo)==='habitaciones') return Number((o.habitaciones&&o.habitaciones.bruta_pct)||12)||12;
  return Number((o.tradicional&&o.tradicional.bruta_pct)||10)||10;
}

/* Estado tabla */
let data=[], view=[], sortKey='ts', sortAsc=true;

/* Carga y KPIs */
function load(){
  data=(Store.evals||[]).map(e=>{
    const asig=(e.prospect_ids||[]).length;
    const files=e.files||{images:[],videos:[],pdfs:[]};
    return {...e, asig, _adj:{i:(files.images||[]).length, v:(files.videos||[]).length, p:(files.pdfs||[]).length}};
  });
  applyFilters(); kpis();
}
function kpis(){
  id('k_total').textContent = data.length;
  id('k_asig').textContent  = data.reduce((a,b)=>a+(b.asig||0),0);
  id('k_bruta').textContent = fmtN1.format(avg(data.map(x=>toPct(x.kpi_bruta))))+' %';
  id('k_neta').textContent  = fmtN1.format(avg(data.map(x=>toPct(x.kpi_neta))))+' %';
}
const avg = arr => arr.length? arr.reduce((a,b)=>a+Number(b||0),0)/arr.length : 0;

/* Filtros/orden */
function applyFilters(){
  const q=(id('f_text').value||'').toLowerCase().trim();
  const t=id('f_tipo').value||'';
  const d=id('f_desde').value? new Date(id('f_desde').value+'T00:00:00Z').getTime():0;
  const h=id('f_hasta').value? new Date(id('f_hasta').value+'T23:59:59Z').getTime():Infinity;
  view=data.filter(e=>{
    const ts=new Date(e.ts||e.id?.slice(3)).getTime();
    const txt=((e.loc||'')+' '+(e.calle||'')).toLowerCase();
    return (!q || txt.includes(q)) && (!t || e.tipo===t) && ts>=d && ts<=h;
  });
  sort(); render();
}
function sort(){
  view.sort((a,b)=>{
    const va=get(a,sortKey), vb=get(b,sortKey);
    return (va<vb? -1: va>vb? 1: 0) * (sortAsc?1:-1);
  });
}
function get(o,k){
  if(k==='ts') return new Date(o.ts||o.id?.slice(3)).getTime();
  if(k==='asig') return (o.prospect_ids||[]).length;
  if(k==='kpi_bruta') return toPct(o.kpi_bruta);
  if(k==='kpi_neta')  return toPct(o.kpi_neta);
  if(k==='kpi_flujo') return Number(o.kpi_flujo||0);
  if(k==='pmax') return Number(o.pmax||0);
  if(k==='precio') return Number(o.precio||0);
  if(k==='alq') return Number(o.alq||0);
  if(k==='adj') return Number((o._adj?.i||0)+(o._adj?.v||0)+(o._adj?.p||0));
  if(k==='calle') return (o.calle||'').toLowerCase();
  return (o[k]||'').toString().toLowerCase();
}

/* Render tabla */
function render(){
  const tb=id('tbody'); tb.innerHTML='';
  view.forEach(e=>{
    const tr=document.createElement('tr'); tr.dataset.id=e.id;
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    let html='';
    html += '<td>'+f+'</td>';
    html += '<td>'+esc(e.loc||'')+'</td>';
    html += '<td>'+esc(e.calle||'')+'</td>';
    html += '<td><span class="pill">'+esc(e.tipo||'-')+'</span></td>';
    html += '<td style="text-align:right">'+e0(e.precio)+'</td>';
    html += '<td style="text-align:right">'+e0(e.alq)+'</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_bruta))+' %</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_neta))+' %</td>';
    html += '<td style="text-align:right">'+e0(e.kpi_flujo)+'</td>';
    html += '<td style="text-align:right">'+e0(e.pmax)+'</td>';
    const adj=e._adj||{i:0,v:0,p:0};
    html += '<td style="text-align:center">'+adj.i+'/'+adj.v+'/'+adj.p+'</td>';
    html += '<td style="text-align:center">'+(e.prospect_ids||[]).length+'</td>';
    html += '<td><div class="actions-cell">'+iconBtn('ver','Ver')+iconBtn('del','Borrar')+'</div></td>';
    tr.innerHTML = html; tb.appendChild(tr);
  });
}
function iconBtn(action,title){
  if(action==='ver'){
    return '<button class="iconbtn" title="'+title+'" data-act="ver" aria-label="'+title+'">'+
      '<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">'+
      '<path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z" stroke="#1a1f23" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>'+
      '<circle cx="12" cy="12" r="3.2" stroke="#1a1f23" stroke-width="1.6" /></svg></button>';
  }
  return '<button class="iconbtn" title="'+title+'" data-act="del" aria-label="'+title+'">'+
    '<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">'+
    '<path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 7l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12" stroke="#1a1f23" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>'+
    '<path d="M10 10v7M14 10v7" stroke="#1a1f23" stroke-width="1.6" stroke-linecap="round"/></svg></button>';
}

/* Click tabla */
function onTableClick(ev){
  const btn=ev.target.closest('button[data-act]'); const tr=ev.target.closest('tr');
  if(!tr) return; const idEv=tr.dataset.id;
  if(btn){
    const act=btn.dataset.act;
    if(act==='ver') openModal(idEv);
    if(act==='del'){ if(confirm('¿Borrar esta evaluación?')){ Store.evals=(Store.evals||[]).filter(x=>x.id!==idEv); load(); } }
  }else{
    openModal(idEv);
  }
}

/* MODAL ===== */
let OPEN_ID=null;
function openModal(idEv){
  OPEN_ID=idEv;
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;
  const files=e.files = e.files || {images:[],videos:[],pdfs:[]};

  // Header
  id('m_title').textContent = 'Ficha — '+(e.loc||'-')+' · '+(e.calle||'-');
  id('m_fecha').textContent = new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');

  // Resumen
  fillKV('m_loc', e.loc); fillKV('m_calle', e.calle); fillKV('m_tipo', e.tipo);
  fillKV('m_precio', e0(e.precio)); fillKV('m_itp', e0(e.itp));
  fillKV('m_notaria', e0(e.notaria)); fillKV('m_psi', e0(e.psi));
  fillKV('m_reforma', e0(e.reforma)); fillKV('m_inv', e0(e.inv_total));
  fillKV('m_alq', e0(e.alq));
  fillKV('m_bruta', fmtN1.format(toPct(e.kpi_bruta))+' %');
  fillKV('m_neta', fmtN1.format(toPct(e.kpi_neta))+' %');
  fillKV('m_flujo', e0(e.kpi_flujo));
  fillKV('m_pmax', e0(e.pmax));
  if(e.url){ id('m_url').innerHTML='<a href="'+esc(e.url)+'" target="_blank" rel="noopener">Abrir anuncio</a>'; } else { id('m_url').textContent='—'; }

  // Candidatos (solo lectura) + hint
  renderCandidates(e);

  // Adjuntos
  renderAttachments(e);

  // Botones
  id('m_eval').onclick=function(){ goEvaluar(e.id); };
  id('m_close').onclick=closeModal;

  id('mBack').classList.add('open');
}
function closeModal(){
  id('mBack').classList.remove('open');
  OPEN_ID=null; load(); // refresco contadores de adjuntos en la tabla
}
function fillKV(el,val){ id(el).textContent = (val==null||val==='')? '—' : String(val); }

/* Candidatos — solo lectura con dots, avisos y sugerencias */
function isEligibleProspect(p){
  const f=fold(p.fase||'');
  if(f.includes('compraven')||f.includes('compra')) return false; // excluir compraventa
  return true;
}
function prosTipo(p){ return fold(p.pref_tipo|| (p.prefs&&p.prefs.tipo) || 'Tradicional'); }
function prosLocsArr(p){
  const s=(p.locs_text || (p.prefs&&p.prefs.localidades) || '').toString();
  return s.split(',').map(x=>fold(x)).filter(Boolean);
}
function wantsElev(p){
  const v=(p.prefs&&p.prefs.ascensor)||p.ascensor||'Indiferente';
  return fold(v)==='requiere';
}
function wantsNoRef(p){
  const v=(p.prefs&&p.prefs.reforma)||p.reforma||'Indiferente';
  return fold(v)==='no';
}
function wantsNoBajo(p){
  const v=(p.prefs&&p.prefs.evitar_bajos)||p.evitar_bajos||'No';
  const s=fold(v); return (s==='si'||s==='sí');
}
function clientBudgetCTO(p){
  // CTO cliente desde p.inv_pmax y policy PSI
  const {psi}=cfgCosts();
  const pmax = Number(p.inv_pmax||0);
  const inclPsi = !!p.psi_in_presupuesto;
  if(pmax<=0) return 0;
  return inclPsi ? pmax : (pmax + psi);
}
function getTargetMain(p){
  const kind=fold(p.obj_main||p.obj_tipo||'');
  let val=0;
  if(kind==='bruta') val=Number(p.obj_bruta||0); if(kind==='neta') val=Number(p.obj_neta||0);
  if(kind==='flujo') val=Number(p.obj_flujo_anual|| (p.obj_flujo?Number(p.obj_flujo)*12:0) );
  if(kind!=='flujo'){ if(val>0 && val<=1) val=val*100; } // normaliza %
  return {kind, val};
}
function classify(actual,target){
  if(!target||target<=0) return {cls:'r',ratio:0};
  const th=cfgThresholds();
  const ratio=actual/target;
  const cls = ratio>=th.g ? 'g' : (ratio>=th.a ? 'y' : 'r');
  return {cls, ratio};
}
function candidateWarns(e,p,cls){
  const warns=[];
  const necesitaReforma = (e.ref_tip && e.ref_tip!=='no');
  const sinAscensor = fold(e.asc||'sí')==='no';
  const esBajo = fold(e.bajo||'no')==='si' || fold(e.bajo||'no')==='sí';
  const ctoCli = clientBudgetCTO(p);
  if(cls==='g'){
    if(necesitaReforma && wantsNoRef(p)) warns.push('Requiere reforma y el cliente no quiere');
    if(sinAscensor && wantsElev(p)) warns.push('Sin ascensor y el cliente requiere ascensor');
    if(esBajo && wantsNoBajo(p)) warns.push('Bajo y el cliente evita bajos');
    if(ctoCli>0 && Number(e.inv_total||0) > ctoCli) warns.push('Excede presupuesto del cliente');
  }
  return warns;
}
function suggestionText(e, p, main, cls, ratio){
  if(cls==='g') return ''; // ya verde
  const th=cfgThresholds(), {itp, notaria, psi}=cfgCosts();
  const inv=Number(e.inv_total||0);
  const precio=Number(e.precio||0);
  const alq_a=(Number(e.alq||0))*12;
  const gastos=Number(e.comu||0)+Number(e.ibi||0)+Number(e.hogar||0)+Number(e.impago||0)+Number(e.gestion||0);

  // target requerido para entrar en verde (≥ green)
  if(main.kind==='bruta'){
    const targetPct = (Number(main.val)||0)/100 * th.g; // porcentaje (0.xx)
    if(targetPct<=0) return '';
    const inv_limit = alq_a / targetPct; // máximo CTO permitido
    const K = (notaria + Number(e.psi||0) + Number(e.reforma||0)); // extras fijos
    const Pmax = (inv_limit - K) / (1 + itp); // precio máximo de compra
    const dPrecio = Math.max(0, precio - Pmax);
    const alq_needed = (inv * targetPct)/12;
    const dAlq = Math.max(0, alq_needed - Number(e.alq||0));
    if(dPrecio>0 || dAlq>0){
      return (dPrecio>0?('−'+e0(dPrecio)+' en precio'): '') + (dPrecio>0 && dAlq>0?' / ':'') + (dAlq>0?('+'+e0(dAlq)+' de alquiler'):'');
    }
    return '';
  }
  if(main.kind==='neta'){
    const targetPct = (Number(main.val)||0)/100 * th.g;
    const inv_limit = (alq_a - gastos) / targetPct;
    const K = (notaria + Number(e.psi||0) + Number(e.reforma||0));
    const Pmax = (inv_limit - K) / (1 + itp);
    const dPrecio = Math.max(0, precio - Pmax);
    const alq_needed = ((inv*targetPct)+gastos)/12;
    const dAlq = Math.max(0, alq_needed - Number(e.alq||0));
    if(dPrecio>0 || dAlq>0){
      return (dPrecio>0?('−'+e0(dPrecio)+' en precio'): '') + (dPrecio>0 && dAlq>0?' / ':'') + (dAlq>0?('+'+e0(dAlq)+' de alquiler'):'');
    }
    return '';
  }
  if(main.kind==='flujo'){
    const target = Number(main.val||0) * th.g; // flujo anual mínimo
    const alq_needed = (target + gastos)/12;
    const dAlq = Math.max(0, alq_needed - Number(e.alq||0));
    return dAlq>0 ? ('+'+e0(dAlq)+' de alquiler') : '';
  }
  return '';
}
function renderCandidates(e){
  const wrap=id('m_cands'); const hint=id('m_hint');
  wrap.innerHTML='—'; hint.textContent='—';

  const pros=(Store.pros||[]).filter(isEligibleProspect);
  if(!pros.length){ wrap.textContent='No hay clientes activos en fases previas a compraventa.'; hint.textContent='—'; return; }

  const list=[];
  pros.forEach(p=>{
    // Filtros duros: tipo + localidad
    if(fold(e.tipo)!==prosTipo(p)) return;
    const locs=prosLocsArr(p); if(locs.length && !locs.includes(fold(e.loc))) return;

    const main=getTargetMain(p); if(!main.kind||!main.val) return;

    // KPI del activo según objetivo del cliente
    const k_actual = (main.kind==='bruta') ? toPct(e.kpi_bruta)
                   : (main.kind==='neta')  ? toPct(e.kpi_neta)
                   : Number(e.kpi_flujo||0);

    const c = classify(k_actual, Number(main.val));
    const warns = candidateWarns(e,p,c.cls);
    const sugg = suggestionText(e,p,main,c.cls,c.ratio);

    list.push({p, cls:c.cls, main, warns, sugg});
  });

  if(!list.length){
    // Sin candidatos: evaluar si es buen activo (mínimo global de bruta por tipo) o sugerir negociación
    const br = toPct(e.kpi_bruta||0);
    const min = cfgObjMinBruta(e.tipo||'Tradicional');
    const c = classify(br, min);
    if(c.cls==='g'){
      hint.textContent='Buen activo para guardar (bruta supera el mínimo de configuración).';
    }else{
      // sugerir negociación sobre bruta mínima
      const {itp, notaria}=cfgCosts(); const psi=Number(e.psi||0), ref=Number(e.reforma||0);
      const alq_a=(Number(e.alq||0))*12;
      const targetPct = (Number(min)||0)/100*cfgThresholds().g;
      if(targetPct>0){
        const inv_limit = alq_a/targetPct;
        const K = notaria + psi + ref;
        const Pmax = (inv_limit - K)/(1+itp);
        const dPrecio = Math.max(0, Number(e.precio||0) - Pmax);
        hint.textContent = 'Sugerir negociación: −'+e0(dPrecio)+' en precio (para alcanzar verde con la bruta mínima).';
      }else{
        hint.textContent='Sin candidatos. Considerar revisar precio/alquiler.';
      }
    }
    wrap.textContent='—';
    return;
  }

  // Orden: verde (con aviso primero), ámbar, rojo
  list.sort((a,b)=>{
    const ord = (cls)=> cls==='g'?0: (cls==='y'?1:2);
    const av=(x)=> (x.warns&&x.warns.length)?0:1; // avisos primero dentro de verdes
    if(ord(a.cls)!==ord(b.cls)) return ord(a.cls)-ord(b.cls);
    if(a.cls==='g' && av(a)!==av(b)) return av(a)-av(b);
    return (a.p.nombre||'').localeCompare(b.p.nombre||'');
  });

  wrap.innerHTML='';
  list.forEach(o=>{
    const row=document.createElement('div'); row.className='cand';
    const top=document.createElement('div'); top.className='top';
    const dot=document.createElement('span'); dot.className='dot '+o.cls;
    const title=document.createElement('div');
    title.innerHTML='<strong>'+esc(o.p.nombre||'-')+'</strong> <span class="note">('+o.main.kind+': real vs objetivo)</span>';
    top.appendChild(dot); top.appendChild(title); row.appendChild(top);

    const badges=document.createElement('div'); badges.className='badges';
    if(o.cls==='g'){
      // avisos explícitos si falla algún criterio aunque sea verde
      (o.warns||[]).forEach(w=>{
        const b=document.createElement('span'); b.className='badge warn'; b.innerHTML='<small>!</small> '+esc(w); badges.appendChild(b);
      });
      if(!(o.warns&&o.warns.length)){
        const b=document.createElement('span'); b.className='badge'; b.innerHTML='<small>✓</small> Encaja'; badges.appendChild(b);
      }
    }else{
      const b=document.createElement('span'); b.className='badge'; b.textContent='No encaja';
      badges.appendChild(b);
    }

    // Sugerencia (si no verde)
    if(o.sugg){
      const b=document.createElement('span'); b.className='badge warn'; b.innerHTML='<small>→</small> Ajuste sugerido: '+esc(o.sugg);
      badges.appendChild(b);
    }

    row.appendChild(badges);
    wrap.appendChild(row);
  });

  hint.textContent = list.filter(x=>x.cls==='g').length+' en verde · '+list.filter(x=>x.cls==='y').length+' ámbar · '+list.filter(x=>x.cls==='r').length+' rojo';
}

/* Adjuntos + Lightbox/Persistencia */
const MAX_VIDEO_BYTES = 2*1024*1024;
let LB={arr:[],idx:0};
function openLB(arr,idx){ LB.arr=arr||[]; LB.idx=idx||0; if(!LB.arr.length) return; id('lbBack').classList.add('open'); paintLB(); }
function closeLB(){ id('lbBack').classList.remove('open'); }
function nextLB(){ if(!LB.arr.length) return; LB.idx=(LB.idx+1)%LB.arr.length; paintLB(); }
function prevLB(){ if(!LB.arr.length) return; LB.idx=(LB.idx-1+LB.arr.length)%LB.arr.length; paintLB(); }
function paintLB(){ const im=LB.arr[LB.idx]; id('lbImg').src=im.data; }
function renderAttachments(e){
  const gI=id('grid_imgs'), gV=id('grid_vids'), gP=id('grid_pdfs');
  gI.innerHTML=''; gV.innerHTML=''; gP.innerHTML='';
  e.files = e.files || {images:[],videos:[],pdfs:[]};

  e.files.images.forEach((f,idx)=>{ gI.appendChild(thumbImg(f, ()=>{ e.files.images.splice(idx,1); persistFiles(e); renderAttachments(e);}, ()=>openLB(e.files.images, idx))); });
  e.files.videos.forEach((f,idx)=>{ gV.appendChild(thumbVideo(f, ()=>{ e.files.videos.splice(idx,1); persistFiles(e); renderAttachments(e);})); });
  e.files.pdfs.forEach((f,idx)=>{ gP.appendChild(thumbPdf(f, ()=>{ e.files.pdfs.splice(idx,1); persistFiles(e); renderAttachments(e);}, ()=>window.open(f.data,'_blank'))); });

  id('up_imgs').onchange = (ev)=>{ handleFiles(e, ev.target.files, 'images'); ev.target.value=''; };
  id('up_vids').onchange = (ev)=>{ handleFiles(e, ev.target.files, 'videos'); ev.target.value=''; };
  id('up_pdfs').onchange = (ev)=>{ handleFiles(e, ev.target.files, 'pdfs');   ev.target.value=''; };

  function handleFiles(E, fileList, kind){
    const arr = Array.prototype.slice.call(fileList||[]);
    if(!arr.length) return;
    arr.forEach(file=>{
      if(kind==='videos' && file.size>MAX_VIDEO_BYTES){ toast('Vídeo "'+file.name+'" supera 2 MB','warn'); return; }
      const r=new FileReader();
      r.onload = function(){
        const rec={name:file.name,size:file.size,type:file.type,data:r.result};
        if(kind==='images') E.files.images.push(rec);
        if(kind==='videos') E.files.videos.push(rec);
        if(kind==='pdfs')   E.files.pdfs.push(rec);
        persistFiles(E); renderAttachments(E);
      };
      r.readAsDataURL(file);
    });
  }
  function thumbImg(f, onX, onOpen){const d=document.createElement('div'); d.className='thumb'; const img=new Image(); img.src=f.data; d.appendChild(img); d.appendChild(xBtn(onX)); d.onclick=onOpen; return d;}
  function thumbVideo(f, onX){const d=document.createElement('div'); d.className='thumb'; const inner=document.createElement('div'); inner.className='mini'; inner.innerHTML='▶<br>'+esc(trimName(f.name)); d.appendChild(inner); d.appendChild(xBtn(onX)); return d;}
  function thumbPdf(f, onX, onOpen){const d=document.createElement('div'); d.className='thumb'; const inner=document.createElement('div'); inner.className='mini'; inner.innerHTML='PDF<br>'+esc(trimName(f.name)); d.appendChild(inner); d.appendChild(xBtn(onX)); d.onclick=onOpen; return d;}
  function xBtn(onX){const b=document.createElement('div'); b.className='x'; b.title='Quitar'; b.innerHTML='×'; b.onclick=function(ev){ ev.stopPropagation(); onX(); }; return b;}
  function trimName(n){ n=String(n||''); return n.length>14? n.slice(0,12)+'…': n; }
}
function persistFiles(e){
  const list=Store.evals||[]; const i=list.findIndex(x=>x.id===e.id); if(i<0) return;
  list[i].files = e.files; Store.evals=list; toast('Adjuntos guardados','ok');
}

/* Abrir en Evaluar */
function goEvaluar(idEv){
  localStorage.setItem('load_eval', idEv);
  location.href = 'evaluar.html';
}

/* Export CSV */
function toCSV(rows){
  const headers=["Id","Fecha","Localidad","Calle","Tipo","Precio","ITP","Notaría","PSI","Reforma","Comunidad","IBI","Hogar","Impago","Gestión","Alquiler","Bruta%","Neta%","Flujo","Pmax","InvTotal","Asignados","URL","Imgs","Vids","PDFs"];
  const lines=[headers.join(';')];
  rows.forEach(function(e){
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    const files=e.files||{images:[],videos:[],pdfs:[]};
    lines.push([
      e.id, f, safe(e.loc), safe(e.calle), safe(e.tipo),
      n0(e.precio), n0(e.itp), n0(e.notaria), n0(e.psi), n0(e.reforma),
      n0(e.comu), n0(e.ibi), n0(e.hogar), n0(e.impago), n0(e.gestion),
      n0(e.alq), fmtN1.format(toPct(e.kpi_bruta)), fmtN1.format(toPct(e.kpi_neta)), n0(e.kpi_flujo),
      n0(e.pmax), n0(e.inv_total), (e.prospect_ids||[]).length,
      safe(e.url), (files.images||[]).length, (files.videos||[]).length, (files.pdfs||[]).length
    ].join(';'));
  });
  return lines.join('\n');
}
const safe=s=>(s??'').toString().replace(/;/g,',');

function download(name,content){
  const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* Sort headers */
function bindSort(){
  const ths=document.querySelectorAll('#tbl th[data-k]');
  ths.forEach(function(th){
    th.addEventListener('click',function(){
      const k=th.dataset.k; if(sortKey===k) sortAsc=!sortAsc; else{sortKey=k; sortAsc=true;}
      sort(); render();
    });
  });
}

/* Eventos globales */
function attach(){
  id('b_filtrar').addEventListener('click',applyFilters);
  id('b_limpiar').addEventListener('click',function(){
    id('f_text').value=''; id('f_tipo').value=''; id('f_desde').value=''; id('f_hasta').value=''; applyFilters();
  });
  id('b_export').addEventListener('click',function(){
    download('evaluaciones.csv', toCSV(view.length?view:data));
  });
  id('tbl').addEventListener('click', onTableClick);

  // Lightbox handlers
  id('lbPrev').addEventListener('click', prevLB);
  id('lbNext').addEventListener('click', nextLB);
  id('lbClose').addEventListener('click', closeLB);
  id('lbBack').addEventListener('click', function(ev){ if(ev.target.id==='lbBack') closeLB(); });
  document.addEventListener('keydown', function(ev){
    if(ev.key==='Escape'){ if(id('mBack').classList.contains('open')) closeModal(); if(id('lbBack').classList.contains('open')) closeLB(); }
    if(id('lbBack').classList.contains('open')){
      if(ev.key==='ArrowRight') nextLB();
      if(ev.key==='ArrowLeft')  prevLB();
    }
  });

  load(); bindSort();
}
document.addEventListener('DOMContentLoaded', attach);
})();
</script>
</body>
</html>
