<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser â€” Evaluaciones</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* Overlay + Drawer */
.uh-overlay{position:fixed;inset:0;background:rgba(15,18,20,.28);backdrop-filter:blur(2px);display:none;z-index:80}
.uh-overlay.open{display:block}
.uh-drawer{position:fixed;top:0;right:-560px;height:100%;width:560px;max-width:100%;background:#fff;border-left:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(0,0,0,.25);transition:right .2s ease;z-index:90}
.uh-drawer.open{right:0}
.uh-d-head{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid #eef2f7}
.uh-d-body{padding:16px 16px 24px;overflow:auto;height:calc(100% - 60px)}
.uh-meta{font-size:12px;color:#667085;margin-bottom:12px}
.section-title{margin:10px 0 6px;font-weight:700}

/* KPIs */
.kpi{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
.kpi .lab{font-size:12px;color:#667085}.kpi .val{font-weight:800;font-size:20px}
.kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}

/* Tabla */
table.table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;white-space:nowrap}
.table th{background:#f8fafc;color:#111827;cursor:pointer}
.table tr:last-child td{border-bottom:none}
.table tr{cursor:pointer}
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;font-size:12px}

/* Acciones */
.actions-cell{display:flex;gap:6px;align-items:center}
.iconbtn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
.iconbtn:hover{background:#f8fafc}
.icon{width:18px;height:18px;display:block}

/* Drawer: pares clave-valor */
.kv{display:grid;grid-template-columns:auto 1fr;gap:4px 10px;margin-bottom:6px}
.kv .k{color:#667085;font-size:12px;line-height:1.2}
.kv .v{font-weight:600;font-size:14px;line-height:1.2}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.block{border:1px solid #eef2f7;border-radius:12px;padding:10px;background:#fff;margin-bottom:10px}

/* Prospects list */
.uh-list-pros{display:grid;gap:6px}
.uh-list-pros label{display:flex;gap:8px;align-items:center;padding:6px 8px;border:1px solid #eef2f7;border-radius:10px;background:#fff}
.uh-list-pros input{width:16px;height:16px}
.pros-head{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
.small{font-size:12px;color:#667085}

/* Badges de aviso */
.badges{display:inline-flex;gap:6px;margin-left:6px;flex-wrap:wrap}
.badge-warn{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#b45309;background:#fff7ed;border:1px solid #fde68a;border-radius:999px;padding:2px 6px}
.badge-warn .ico{width:12px;height:12px;display:inline-block}

/* Adjuntos */
.att-actions{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.att-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
@media(max-width:640px){.att-grid{grid-template-columns:1fr 1fr 1fr}}
.att-card{position:relative;border:1px solid #e5e7eb;border-radius:10px;background:#fff;padding:6px;display:flex;flex-direction:column;gap:6px}
.att-thumb{width:100%;height:72px;object-fit:cover;border-radius:6px;border:1px solid #eef2f7;background:#f8fafc}
.att-name{font-size:12px;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.att-ctl{display:flex;gap:6px}
.att-ctl .mini{padding:4px 6px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;font-size:12px;cursor:pointer}
.att-ctl .mini:hover{background:#f8fafc}
.att-empty{font-size:12px;color:#667085}
.att-section h4{margin:10px 0 6px}
.btn-ghost{background:#fff;border:1px dashed #e5e7eb}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser â€” CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html" class="active">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">ConfiguraciÃ³n</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Evaluaciones</h2>

    <div class="kpis" style="margin-top:6px">
      <div class="kpi"><div class="lab">Total evaluaciones</div><div class="val" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">Asignadas</div><div class="val" id="k_asig">0</div></div>
      <div class="kpi"><div class="lab">Bruta media</div><div class="val" id="k_bruta">0,0 %</div></div>
      <div class="kpi"><div class="lab">Neta media</div><div class="val" id="k_neta">0,0 %</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Filtros</h3>
      <div class="filters">
        <div class="row">
          <div class="field"><label>Buscar</label><input id="f_text" placeholder="Localidad o calle"></div>
          <div class="field"><label>Tipo</label>
            <select id="f_tipo"><option value="">Todos</option><option>Tradicional</option><option>Habitaciones</option></select>
          </div>
          <div class="field"><label>Desde</label><input id="f_desde" type="date"></div>
          <div class="field"><label>Hasta</label><input id="f_hasta" type="date"></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_limpiar">Limpiar</button></div>
          <div class="field" style="align-self:end"><button class="btn primary" id="b_filtrar">Filtrar</button></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_export">Exportar CSV</button></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th data-k="ts">Fecha</th>
            <th data-k="loc">Localidad</th>
            <th data-k="calle">Calle</th>
            <th data-k="tipo">Tipo</th>
            <th data-k="precio" style="text-align:right">Precio</th>
            <th data-k="alq" style="text-align:right">Alquiler</th>
            <th data-k="kpi_bruta" style="text-align:right">Bruta %</th>
            <th data-k="kpi_neta" style="text-align:right">Neta %</th>
            <th data-k="kpi_flujo" style="text-align:right">Flujo</th>
            <th data-k="pmax" style="text-align:right">P. mÃ¡x</th>
            <th data-k="asig" style="text-align:center">Asignados</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="foot"><div class="container foot-inner">Â© 2025 Unihouser Â· unihouser.es Â· info@unihouser.es Â· 644 300 200</div></footer>

<div id="uhOverlay" class="uh-overlay"></div>
<aside id="uhDrawer" class="uh-drawer" aria-hidden="true">
  <div class="uh-d-head">
    <strong>Detalle de evaluaciÃ³n</strong>
    <button class="btn" id="d_cerrar">Cerrar</button>
  </div>
  <div class="uh-d-body">
    <div class="uh-meta" id="d_fecha">â€”</div>

    <!-- 1) Datos del inmueble -->
    <h3 class="section-title">Datos del inmueble</h3>
    <div class="block grid3">
      <div class="kv"><div class="k">Localidad</div><div class="v" id="d_loc">â€”</div></div>
      <div class="kv"><div class="k">Calle</div><div class="v" id="d_calle">â€”</div></div>
      <div class="kv"><div class="k">Tipo</div><div class="v" id="d_tipo">â€”</div></div>
      <div class="kv"><div class="k">Superficie</div><div class="v" id="d_m2">â€”</div></div>
      <div class="kv"><div class="k">AÃ±o</div><div class="v" id="d_anio">â€”</div></div>
      <div class="kv"><div class="k">Altura</div><div class="v" id="d_alt">â€”</div></div>
      <div class="kv"><div class="k">Ascensor</div><div class="v" id="d_asc">â€”</div></div>
      <div class="kv"><div class="k">Bajo</div><div class="v" id="d_bajo">â€”</div></div>
      <div class="kv"><div class="k">Hab./BaÃ±os</div><div class="v" id="d_hb">â€”</div></div>
      <div class="kv" style="grid-column:1/-1"><div class="k">URL</div><div class="v" id="d_url">â€”</div></div>
    </div>

    <!-- 2) Gastos de adquisiciÃ³n -->
    <h3 class="section-title">Gastos de adquisiciÃ³n</h3>
    <div class="block grid3">
      <div class="kv"><div class="k">Precio</div><div class="v" id="d_precio">â€”</div></div>
      <div class="kv"><div class="k">ITP</div><div class="v" id="d_itp">â€”</div></div>
      <div class="kv"><div class="k">NotarÃ­a</div><div class="v" id="d_notaria">â€”</div></div>
      <div class="kv"><div class="k">PSI</div><div class="v" id="d_psi">â€”</div></div>
      <div class="kv"><div class="k">Reforma</div><div class="v" id="d_ref_tip">â€”</div></div>
    </div>

    <!-- 3) Gastos de mantenimiento -->
    <h3 class="section-title">Gastos de mantenimiento</h3>
    <div class="block grid3">
      <div class="kv"><div class="k">Comunidad</div><div class="v" id="d_comu">â€”</div></div>
      <div class="kv"><div class="k">IBI</div><div class="v" id="d_ibi">â€”</div></div>
      <div class="kv"><div class="k">Hogar</div><div class="v" id="d_hogar">â€”</div></div>
      <div class="kv"><div class="k">Impago</div><div class="v" id="d_impago">â€”</div></div>
      <div class="kv"><div class="k">GestiÃ³n</div><div class="v" id="d_gestion">â€”</div></div>
    </div>

    <!-- 4) ExplotaciÃ³n e ingresos -->
    <h3 class="section-title">ExplotaciÃ³n e ingresos</h3>
    <div class="block grid3">
      <div class="kv"><div class="k">Alquiler</div><div class="v" id="d_alq">â€”</div></div>
      <div class="kv"><div class="k">Bruta</div><div class="v" id="d_bruta">â€”</div></div>
      <div class="kv"><div class="k">Neta</div><div class="v" id="d_neta">â€”</div></div>
      <div class="kv"><div class="k">Flujo</div><div class="v" id="d_flujo">â€”</div></div>
      <div class="kv"><div class="k">InversiÃ³n</div><div class="v" id="d_inv">â€”</div></div>
      <div class="kv"><div class="k">P. mÃ¡x</div><div class="v" id="d_pmax">â€”</div></div>
    </div>

    <!-- 5) AsignaciÃ³n (AHORA VA ANTES DE ADJUNTOS) -->
    <h3 class="section-title">Asignar a prospects</h3>
    <div class="pros-head">
      <div class="small" id="pros_info">â€”</div>
      <label class="small"><input type="checkbox" id="pros_show_all"> Ver todos</label>
    </div>
    <div id="p_list" class="uh-list-pros">â€”</div>

    <!-- 6) Adjuntos (secciones separadas) -->
    <h3 class="section-title">Adjuntos</h3>
    <div class="block att-section">
      <h4>ImÃ¡genes</h4>
      <div class="att-actions">
        <button class="btn" id="a_img_upload">Subir imÃ¡genes</button>
        <input type="file" id="a_img_file" accept="image/*" multiple hidden>
        <button class="btn btn-ghost" id="a_img_link">AÃ±adir enlace</button>
        <div class="small">Miniaturas. MÃ¡x 2 MB/imagen.</div>
      </div>
      <div id="att_images" class="att-grid"><div class="att-empty">Sin imÃ¡genes.</div></div>
    </div>

    <div class="block att-section">
      <h4>VÃ­deos</h4>
      <div class="att-actions">
        <button class="btn" id="a_vid_upload">Subir vÃ­deos</button>
        <input type="file" id="a_vid_file" accept="video/*" multiple hidden>
        <button class="btn btn-ghost" id="a_vid_link">AÃ±adir enlace</button>
        <div class="small">Para vÃ­deos pesados, usa enlace (YouTube/Drive).</div>
      </div>
      <div id="att_videos" class="att-grid"><div class="att-empty">Sin vÃ­deos.</div></div>
    </div>

    <div class="block att-section">
      <h4>PDFs</h4>
      <div class="att-actions">
        <button class="btn" id="a_pdf_upload">Subir PDFs</button>
        <input type="file" id="a_pdf_file" accept=".pdf,application/pdf" multiple hidden>
        <button class="btn btn-ghost" id="a_pdf_link">AÃ±adir enlace</button>
        <div class="small">Puedes fusionarlos con el Informe al exportar.</div>
      </div>
      <div id="att_pdfs" class="att-grid"><div class="att-empty">Sin PDFs.</div></div>
    </div>

    <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button class="btn primary" id="d_guardar">Guardar asignaciÃ³n</button>
      <button class="btn" id="d_pdf">PDF</button>
      <button class="btn" id="d_editar">Abrir en Evaluar</button>
    </div>
  </div>
</aside>

<div id="toasts" class="toast-wrap"></div>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
const parseNum = v=>Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
function toast(msg,kind){
  const wrap=id('toasts'); if(!wrap) return;
  const el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(()=>el.style.opacity='0',1600);
  setTimeout(()=>{try{wrap.removeChild(el)}catch(_){}} ,2200);
}
function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function toPct(raw){ let v=Number(raw||0); if(v>0&&v<=1)v*=100; while(v>=100)v/=10; return v; }
function fold(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
function boolLike(x){ if(x===true) return true; if(x===false) return false; const s=String(x||'').toLowerCase(); return s==='si'||s==='sÃ­'||s==='true'||s==='1'; }

/* ===== Store ===== */
const Store={
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))}
};

/* ===== Estado ===== */
let data=[], view=[], sortKey='ts', sortAsc=true, openId=null;

/* ===== Carga y KPIs ===== */
function load(){
  data=(Store.evals||[]).map(e=>({...e, asig:(e.prospect_ids||[]).length}));
  applyFilters();
  kpis();
}
function kpis(){
  id('k_total').textContent = data.length;
  id('k_asig').textContent  = data.reduce((a,b)=>a+(b.asig||0),0);
  id('k_bruta').textContent = fmtN1.format(avg(data.map(x=>toPct(x.kpi_bruta))))+' %';
  id('k_neta').textContent  = fmtN1.format(avg(data.map(x=>toPct(x.kpi_neta))))+' %';
}
const avg = arr => arr.length? arr.reduce((a,b)=>a+Number(b||0),0)/arr.length : 0;

/* ===== Filtros/orden ===== */
function applyFilters(){
  const q=(id('f_text').value||'').toLowerCase().trim();
  const t=id('f_tipo').value||'';
  const d=id('f_desde').value? new Date(id('f_desde').value+'T00:00:00Z').getTime():0;
  const h=id('f_hasta').value? new Date(id('f_hasta').value+'T23:59:59Z').getTime():Infinity;
  view=data.filter(e=>{
    const ts=new Date(e.ts||e.id?.slice(3)).getTime();
    const txt=((e.loc||'')+' '+(e.calle||'')).toLowerCase();
    return (!q || txt.includes(q)) && (!t || e.tipo===t) && ts>=d && ts<=h;
  });
  sort(); render();
}
function sort(){
  view.sort((a,b)=>{
    const va=get(a,sortKey), vb=get(b,sortKey);
    return (va<vb? -1: va>vb? 1: 0) * (sortAsc?1:-1);
  });
}
function get(o,k){
  if(k==='ts') return new Date(o.ts||o.id?.slice(3)).getTime();
  if(k==='asig') return (o.prospect_ids||[]).length;
  if(k==='kpi_bruta') return toPct(o.kpi_bruta);
  if(k==='kpi_neta') return toPct(o.kpi_neta);
  if(k==='kpi_flujo') return Number(parseNum(o.kpi_flujo));
  if(k==='pmax') return Number(o.pmax||0);
  if(k==='precio') return Number(o.precio||0);
  if(k==='alq') return Number(o.alq||0);
  if(k==='calle') return (o.calle||'').toLowerCase();
  return (o[k]||'').toString().toLowerCase();
}

/* ===== Render tabla ===== */
function render(){
  const tb=id('tbody'); tb.innerHTML='';
  view.forEach(e=>{
    const tr=document.createElement('tr'); tr.dataset.id=e.id;
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');

    let html='';
    html += '<td>'+f+'</td>';
    html += '<td>'+esc(e.loc||'')+'</td>';
    html += '<td>'+esc(e.calle||'')+'</td>';
    html += '<td><span class="pill">'+esc(e.tipo||'-')+'</span></td>';
    html += '<td style="text-align:right">'+e0(e.precio)+'</td>';
    html += '<td style="text-align:right">'+e0(e.alq)+'</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_bruta))+' %</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_neta))+' %</td>';
    html += '<td style="text-align:right">'+e0(e.kpi_flujo)+'</td>';
    html += '<td style="text-align:right">'+e0(e.pmax)+'</td>';
    html += '<td style="text-align:center">'+(e.prospect_ids||[]).length+'</td>';
    html += '<td><div class="actions-cell">';

    html += '<button class="iconbtn" title="Ver" data-act="ver" aria-label="Ver">'+
              '<svg class="icon" viewBox="0 0 24 24" fill="none">'+
              '<path d="M12 5c5 0 9 4 10 7-1 3-5 7-10 7S3 15 2 12c1-3 5-7 10-7Z" stroke="#111827" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>'+
              '<circle cx="12" cy="12" r="3" stroke="#111827" stroke-width="1.5"/></svg>'+
            '</button>';

    html += '<button class="iconbtn" title="Borrar" data-act="del" aria-label="Borrar">'+
              '<svg class="icon" viewBox="0 0 24 24" fill="none">'+
              '<path d="M6 7h12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2m-1 0-1 12a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2L7 7" stroke="#111827" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>'+
            '</button>';

    html += '</div></td>';

    tr.innerHTML = html;
    tb.appendChild(tr);
  });
}

/* ===== Drawer detalle + asignaciÃ³n ===== */
function openDrawer(idEv){
  openId=idEv;
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;

  id('d_fecha').textContent=new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');

  /* Datos del inmueble */
  id('d_loc').textContent =e.loc||'â€”';
  id('d_calle').textContent=e.calle||'â€”';
  id('d_tipo').textContent =e.tipo||'â€”';
  id('d_m2').textContent = (e.m2||'â€”');
  id('d_anio').textContent = (e.anio||'â€”');
  id('d_alt').textContent = (e.alt||'â€”');
  id('d_asc').textContent = (e.asc||'â€”');
  id('d_bajo').textContent = (e.bajo||'â€”');
  id('d_hb').textContent = (e.habs||'-')+' / '+(e.banos||'-');
  if(e.url){ id('d_url').innerHTML = '<a href="'+esc(e.url)+'" target="_blank" rel="noopener">Abrir anuncio</a>'; } else { id('d_url').textContent = 'â€”'; }

  /* AdquisiciÃ³n */
  id('d_precio').textContent=e0(e.precio);
  id('d_itp').textContent = e0(e.itp||0);
  id('d_notaria').textContent = e0(e.notaria||0);
  id('d_psi').textContent = e0(e.psi||0);
  id('d_ref_tip').textContent = (e.ref_tip||'â€”');

  /* Mantenimiento */
  id('d_comu').textContent = e0(e.comu||0);
  id('d_ibi').textContent = e0(e.ibi||0);
  id('d_hogar').textContent = e0(e.hogar||0);
  id('d_impago').textContent = e0(e.impago||0);
  id('d_gestion').textContent = e0(e.gestion||0);

  /* ExplotaciÃ³n e ingresos */
  id('d_alq').textContent = e0(e.alq);
  id('d_bruta').textContent = fmtN1.format(toPct(e.kpi_bruta))+' %';
  id('d_neta').textContent  = fmtN1.format(toPct(e.kpi_neta))+' %';
  id('d_flujo').textContent = e0(e.kpi_flujo);
  id('d_inv').textContent   = e0(e.inv_total);
  id('d_pmax').textContent  = e0(e.pmax);

  /* Prospects */
  const showAllChk = id('pros_show_all'); showAllChk.checked = false;
  drawProspectsList(e, showAllChk.checked);
  showAllChk.onchange = function(){ drawProspectsList(e, showAllChk.checked); };

  /* Adjuntos: binds por secciÃ³n */
  id('a_img_upload').onclick = ()=> id('a_img_file').click();
  id('a_img_file').onchange = ev => { if(ev.target.files && ev.target.files.length){ addFilesToEval(e.id, ev.target.files, 'image'); ev.target.value=''; } };
  id('a_img_link').onclick = ()=>{ const url=prompt('URL de la imagen'); if(url){ addLinkToEval(e.id,url,'image'); } };

  id('a_vid_upload').onclick = ()=> id('a_vid_file').click();
  id('a_vid_file').onchange = ev => { if(ev.target.files && ev.target.files.length){ addFilesToEval(e.id, ev.target.files, 'video'); ev.target.value=''; } };
  id('a_vid_link').onclick = ()=>{ const url=prompt('URL del vÃ­deo (YouTube/Drive/MP4)'); if(url){ addLinkToEval(e.id,url,'video'); } };

  id('a_pdf_upload').onclick = ()=> id('a_pdf_file').click();
  id('a_pdf_file').onchange = ev => { if(ev.target.files && ev.target.files.length){ addFilesToEval(e.id, ev.target.files, 'pdf'); ev.target.value=''; } };
  id('a_pdf_link').onclick = ()=>{ const url=prompt('URL del PDF'); if(url){ addLinkToEval(e.id,url,'pdf'); } };

  renderAttachments(e.id);

  id('uhOverlay').classList.add('open');
  id('uhDrawer').classList.add('open');

  id('d_guardar').onclick = saveAssign;
  id('d_pdf').onclick = function(){ quickPDF(e.id); };
  id('d_editar').onclick = function(){ goEvaluar(e.id); };
}

function closeDrawer(){
  id('uhOverlay').classList.remove('open');
  id('uhDrawer').classList.remove('open');
  openId=null;
}

/* ===== Matching en Drawer ===== */
function isSearching(p){ const f=fold(p.fase||''); return f.includes('busq'); }
function wantsNoReform(p){ return boolLike(p.no_reformas)||boolLike(p.no_reforma)||fold(p.reforma)==='no'||fold(p.pref_reforma)==='no'||boolLike(p.prefiere_sin_reforma); }
function wantsElevator(p){ return boolLike(p.requiere_ascensor)||boolLike(p.quiere_ascensor)||fold(p.ascensor)==='si'; }
function wantsNoBajo(p){ return boolLike(p.no_bajos)||boolLike(p.no_bajo)||fold(p.pref_bajo)==='no'; }
function prospectBudget(p){ const cand = p.presupuesto_max??p.presupuesto??p.budget_max??p.budget; return Number(String(cand??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0; }
function hasAnyTargetMatch(e,p){
  const b=Number(p.obj_bruta||0), n=Number(p.obj_neta||0), fm=Number(p.obj_flujo||0), fa=Number(p.obj_flujo_anual||0);
  const flujoObj = fa>0? fa : (fm>0? fm*12 : 0);
  const okB = b>0 && Number(toPct(e.kpi_bruta))>=b;
  const okN = n>0 && Number(toPct(e.kpi_neta)) >=n;
  const okF = flujoObj>0 && Number(e.kpi_flujo)>=flujoObj;
  return okB || okN || okF;
}
function warnBadgesFor(p, e){
  const warns=[];
  const necesitaReforma = (String(e.ref_tip||'no').toLowerCase()!=='no');
  const sinAscensor = String(e.asc||'SÃ­').toLowerCase()==='no';
  const esBajo = String(e.bajo||'No').toLowerCase()==='sÃ­';
  const budget = prospectBudget(p);
  if(necesitaReforma && wantsNoReform(p)){ warns.push({title:'No quiere reforma', icon:'ðŸš§'}); }
  if(sinAscensor && wantsElevator(p)){ warns.push({title:'Requiere ascensor', icon:'ðŸ›—'}); }
  if(esBajo && wantsNoBajo(p)){ warns.push({title:'No quiere bajos', icon:'â¬‡'}); }
  if(budget>0 && Number(e.inv_total||0)>budget){ warns.push({title:'Excede presupuesto', icon:'ðŸ’°'}); }
  return warns;
}
function drawProspectsList(e, showAll){
  const wrap=id('p_list'); wrap.innerHTML='';
  const pros=Store.pros||[];
  const set=new Set(e.prospect_ids||[]);
  const wantTipo=fold(e.tipo||''); const wantLoc =fold(e.loc||'');

  const matches=[], others=[];
  pros.forEach(function(p){
    const idp = p.id||p.email||p.nombre||('p_'+Math.random().toString(36).slice(2,7));
    const sameTipo = fold(p.pref_tipo).includes(wantTipo) || wantTipo.includes(fold(p.pref_tipo));
    const locs=(p.locs_text||'').split(',').map(fold).filter(Boolean);
    const sameLoc = locs.some(l=>l===wantLoc || l.includes(wantLoc) || wantLoc.includes(l));
    const faseOK  = isSearching(p);
    const kpiOK = hasAnyTargetMatch(e,p);

    const rowObj = {p, idp, warns: warnBadgesFor(p,e), checked:set.has(idp), faseOK, sameTipo, sameLoc, kpiOK};
    if(faseOK && sameTipo && sameLoc && kpiOK){ matches.push(rowObj); } else { others.push(rowObj); }
  });

  id('pros_info').textContent = matches.length+' coincidencia(s) Â· '+pros.length+' total';

  function isAssigned(o){ return o.checked; }
  const listToRender = showAll
    ? [...matches.sort((a,b)=>isAssigned(b)-isAssigned(a)), ...others.sort((a,b)=>isAssigned(b)-isAssigned(a))]
    : [...matches.sort((a,b)=>isAssigned(b)-isAssigned(a))];

  if(!listToRender.length){
    const empty=document.createElement('div'); empty.className='small';
    empty.textContent = showAll? 'No hay prospects.' : 'No hay coincidencias. Activa â€œVer todosâ€.';
    wrap.appendChild(empty); return;
  }

  listToRender.forEach(function(o){
    const row=document.createElement('label');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.value=o.idp; cb.checked=o.checked; row.appendChild(cb);
    const name=document.createElement('span'); name.textContent = (o.p.nombre||'â€”'); row.appendChild(name);
    if(o.warns.length){
      const bWrap=document.createElement('span'); bWrap.className='badges';
      o.warns.forEach(function(w){
        const b=document.createElement('span'); b.className='badge-warn'; b.title=w.title;
        const i=document.createElement('span'); i.className='ico'; i.textContent=w.icon; b.appendChild(i);
        const t=document.createElement('span'); t.textContent=w.title; b.appendChild(t);
        bWrap.appendChild(b);
      });
      row.appendChild(bWrap);
    }
    if(!o.faseOK || !o.sameTipo || !o.sameLoc || !o.kpiOK){ row.style.opacity = showAll ? .72 : 1; }
    wrap.appendChild(row);
  });
}
function saveAssign(){
  if(!openId) return;
  const list=Store.evals||[];
  const idx=list.findIndex(x=>x.id===openId); if(idx<0) return;
  const choices=[].slice.call(id('p_list').querySelectorAll('input[type=checkbox]'));
  const selected = choices.filter(c=>c.checked).map(c=>c.value);
  list[idx].prospect_ids = selected;
  Store.evals=list;
  toast('AsignaciÃ³n guardada para '+selected.length+' prospecto(s)','ok');
  closeDrawer(); load();
}

/* ===== Adjuntos ===== */
const MAX_FILE_BYTES = 2*1024*1024; // 2MB/archivo
function mimeKind(m){
  m = (m||'').toLowerCase();
  if(m.startsWith('image/')) return 'image';
  if(m.startsWith('video/')) return 'video';
  if(m==='application/pdf' || m.endsWith('/pdf')) return 'pdf';
  return 'file';
}
function urlKind(url){
  const u = String(url||'').toLowerCase();
  if(/\.(png|jpg|jpeg|webp|gif)(\?|$)/.test(u)) return 'image';
  if(/\.(mp4|webm|ogg|mov)(\?|$)/.test(u) || /youtube\.com|youtu\.be|vimeo\.com/.test(u)) return 'video';
  if(/\.pdf(\?|$)/.test(u)) return 'pdf';
  return 'link';
}
function getEvalById(eid){
  const list=Store.evals||[]; const idx=list.findIndex(x=>x.id===eid);
  if(idx<0) return {list, idx:-1};
  return {list, idx};
}
function persistEval(list){ Store.evals=list; load(); }

function addFilesToEval(eid, fileList, forceKind){
  const {list, idx} = getEvalById(eid); if(idx<0) return;
  list[idx].attachments = list[idx].attachments || [];
  const att=list[idx].attachments;
  const files = Array.from(fileList||[]);
  let added=0, skipped=0;

  const next = (i)=>{
    if(i>=files.length){
      persistEval(list); renderAttachments(eid);
      toast('Adjuntos: '+added+' aÃ±adido(s), '+skipped+' omitido(s)','ok'); return;
    }
    const f = files[i];
    if(f.size>MAX_FILE_BYTES){ skipped++; return next(i+1); }
    const reader = new FileReader();
    reader.onload = function(){
      const kind = forceKind || mimeKind(f.type);
      const item = {
        id: 'att_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),
        name: f.name || ('archivo.'+(f.type.split('/')[1]||'bin')),
        type: f.type || '',
        size: f.size || 0,
        kind,
        src: reader.result
      };
      att.push(item);
      try { Store.evals=list; added++; } catch(e){ att.pop(); skipped++; toast('Sin espacio para guardar en el navegador','bad'); }
      next(i+1);
    };
    reader.onerror = function(){ skipped++; next(i+1); };
    reader.readAsDataURL(f);
  };
  next(0);
}
function addLinkToEval(eid, url, forceKind){
  const {list, idx} = getEvalById(eid); if(idx<0) return;
  list[idx].attachments = list[idx].attachments || [];
  const kind = forceKind || urlKind(url);
  list[idx].attachments.push({
    id: 'att_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),
    name: url.split('/').pop() || 'enlace',
    type: 'link', size: 0, kind, src: url
  });
  persistEval(list); renderAttachments(eid); toast('Enlace aÃ±adido','ok');
}
function deleteAttachment(eid, aid){
  const {list, idx} = getEvalById(eid); if(idx<0) return;
  const arr = list[idx].attachments||[];
  list[idx].attachments = arr.filter(x=>x.id!==aid);
  persistEval(list); renderAttachments(eid); toast('Adjunto eliminado','ok');
}
function renderAttachments(eid){
  const {list, idx} = getEvalById(eid); if(idx<0) return;
  const atts = (list[idx].attachments||[]);
  const imgs = atts.filter(a=>a.kind==='image');
  const vids = atts.filter(a=>a.kind==='video');
  const pdfs = atts.filter(a=>a.kind==='pdf');

  const gImg=id('att_images'), gVid=id('att_videos'), gPdf=id('att_pdfs');
  function fillGrid(grid, arr, placeholder){
    grid.innerHTML='';
    if(!arr.length){ const d=document.createElement('div'); d.className='att-empty'; d.textContent=placeholder; grid.appendChild(d); return; }
    arr.forEach(a=>{
      const card=document.createElement('div'); card.className='att-card';
      if(a.kind==='image'){
        const img=document.createElement('img'); img.className='att-thumb'; img.alt=a.name; img.src=a.src; card.appendChild(img);
      }else if(a.kind==='video'){
        const thumb=document.createElement('div'); thumb.className='att-thumb'; thumb.style.display='flex'; thumb.style.alignItems='center'; thumb.style.justifyContent='center'; thumb.textContent='ðŸŽ¬'; card.appendChild(thumb);
      }else if(a.kind==='pdf'){
        const thumb=document.createElement('div'); thumb.className='att-thumb'; thumb.style.display='flex'; thumb.style.alignItems='center'; thumb.style.justifyContent='center'; thumb.textContent='ðŸ“„'; card.appendChild(thumb);
      }
      const name=document.createElement('div'); name.className='att-name'; name.textContent=a.name; card.appendChild(name);
      const ctl=document.createElement('div'); ctl.className='att-ctl';
      const bOpen=document.createElement('button'); bOpen.className='mini'; bOpen.textContent='Abrir'; bOpen.onclick=()=>window.open(a.src,'_blank'); ctl.appendChild(bOpen);
      if(a.src.startsWith('data:')){ const bDl=document.createElement('a'); bDl.className='mini'; bDl.textContent='Descargar'; bDl.href=a.src; bDl.download=a.name||'archivo'; ctl.appendChild(bDl); }
      const bDel=document.createElement('button'); bDel.className='mini'; bDel.textContent='Borrar'; bDel.onclick=()=>deleteAttachment(eid, a.id); ctl.appendChild(bDel);
      card.appendChild(ctl); grid.appendChild(card);
    });
  }
  fillGrid(gImg, imgs, 'Sin imÃ¡genes.');
  fillGrid(gVid, vids, 'Sin vÃ­deos.');
  fillGrid(gPdf, pdfs, 'Sin PDFs.');
}

/* ===== PDF (pregunta si fusionar y look&feel Unihouser) ===== */
function quickPDF(idEv){
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e){toast('No encontrado','bad');return;}
  const wantsMerge = confirm('Â¿Quieres fusionar el Informe con los PDFs adjuntos (si hay)?');
  if(wantsMerge){
    const pdfs = (e.attachments||[]).filter(a=>a.kind==='pdf');
    if(!pdfs.length){ alert('No hay PDFs adjuntos. Genero solo el Informe.'); }
    else if(!window.PDFLib){ alert('Para fusionar en navegador necesitas PDF-LIB (window.PDFLib). De momento genero el Informe y podrÃ¡s unirlos manualmente.'); }
  }

  const fecha=new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');
  const css=[
    '*{box-sizing:border-box} body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;color:#0f172a}',
    '.brand{display:flex;align-items:center;gap:12px;padding:16px 20px;background:#0f172a;color:#fff;border-bottom:4px solid #ff5a1f}',
    '.brand .title{font-weight:900;font-size:18px;letter-spacing:.2px}.brand .meta{margin-left:auto;font-size:12px;opacity:.9}',
    '.wrap{padding:18px}',
    '.grid{display:grid;gap:12px}.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr 1fr 1fr}',
    '.card{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff;box-shadow:0 1px 0 rgba(15,23,42,.03)}',
    '.h{margin:0 0 8px;font-size:16px}',
    '.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}.kv .k{font-size:12px;color:#64748b}.kv .v{font-weight:700}',
    '.kpi{display:flex;flex-direction:column;gap:4px;text-align:center}.kpi .big{font-size:22px;font-weight:900;color:#0f172a}',
    '.muted{color:#64748b;font-size:12px}',
    '.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff1e8;color:#7a2e0e;font-weight:700;font-size:12px}'
  ].join('');

  const html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>Informe â€” '+esc(e.loc||'')+
  '</title><style>'+css+'</style></head><body>'+
  '<div class="brand"><div class="title">Unihouser â€” Informe BuyBox</div><div class="pill">Privado</div><div class="meta">'+esc(fecha)+'</div></div>'+
  '<div class="wrap grid g2">'+
    '<div class="card"><h3 class="h">Resumen KPIs</h3>'+
      '<div class="grid g3">'+
        '<div class="kpi"><div class="muted">Bruta</div><div class="big">'+fmtN1.format(toPct(e.kpi_bruta))+' %</div></div>'+
        '<div class="kpi"><div class="muted">Neta</div><div class="big">'+fmtN1.format(toPct(e.kpi_neta))+' %</div></div>'+
        '<div class="kpi"><div class="muted">Flujo anual</div><div class="big">'+fmtE0.format(parseNum(e.kpi_flujo))+'</div></div>'+
        '<div class="kpi"><div class="muted">Precio mÃ¡x</div><div class="big">'+fmtE0.format(e.pmax||0)+'</div></div>'+
        '<div class="kpi"><div class="muted">Alquiler</div><div class="big">'+fmtE0.format(e.alq||0)+'</div></div>'+
        '<div class="kpi"><div class="muted">InversiÃ³n</div><div class="big">'+fmtE0.format(e.inv_total||0)+'</div></div>'+
      '</div>'+
    '</div>'+
    '<div class="card"><h3 class="h">Datos del inmueble</h3>'+
      '<div class="kv"><div class="k">Localidad</div><div class="v">'+esc(e.loc||'-')+'</div></div>'+
      '<div class="kv"><div class="k">Calle</div><div class="v">'+esc(e.calle||'-')+'</div></div>'+
      '<div class="kv"><div class="k">Tipo</div><div class="v">'+esc(e.tipo||'-')+'</div></div>'+
      '<div class="kv"><div class="k">mÂ²</div><div class="v">'+esc(e.m2||'-')+'</div></div>'+
      '<div class="kv"><div class="k">AÃ±o</div><div class="v">'+esc(e.anio||'-')+'</div></div>'+
      '<div class="kv"><div class="k">Altura</div><div class="v">'+esc(e.alt||'-')+'</div></div>'+
      '<div class="kv"><div class="k">Ascensor</div><div class="v">'+esc(e.asc||'-')+'</div></div>'+
      '<div class="kv"><div class="k">Bajo</div><div class="v">'+esc(e.bajo||'-')+'</div></div>'+
      '<div class="kv"><div class="k">Hab./BaÃ±os</div><div class="v">'+esc((e.habs||'-')+' / '+(e.banos||'-'))+'</div></div>'+
      (e.url? '<div class="kv"><div class="k">URL</div><div class="v">'+esc(e.url)+'</div></div>' : '')+
    '</div>'+
    '<div class="card"><h3 class="h">Gastos de adquisiciÃ³n</h3>'+
      '<div class="kv"><div class="k">Precio</div><div class="v">'+fmtE0.format(e.precio||0)+'</div></div>'+
      '<div class="kv"><div class="k">ITP</div><div class="v">'+fmtE0.format(e.itp||0)+'</div></div>'+
      '<div class="kv"><div class="k">NotarÃ­a</div><div class="v">'+fmtE0.format(e.notaria||0)+'</div></div>'+
      '<div class="kv"><div class="k">PSI</div><div class="v">'+fmtE0.format(e.psi||0)+'</div></div>'+
      '<div class="kv"><div class="k">Reforma</div><div class="v">'+esc(e.ref_tip||'-')+'</div></div>'+
    '</div>'+
    '<div class="card"><h3 class="h">Gastos de mantenimiento</h3>'+
      '<div class="kv"><div class="k">Comunidad</div><div class="v">'+fmtE0.format(e.comu||0)+'</div></div>'+
      '<div class="kv"><div class="k">IBI</div><div class="v">'+fmtE0.format(e.ibi||0)+'</div></div>'+
      '<div class="kv"><div class="k">Hogar</div><div class="v">'+fmtE0.format(e.hogar||0)+'</div></div>'+
      '<div class="kv"><div class="k">Impago</div><div class="v">'+fmtE0.format(e.impago||0)+'</div></div>'+
      '<div class="kv"><div class="k">GestiÃ³n</div><div class="v">'+fmtE0.format(e.gestion||0)+'</div></div>'+
    '</div>'+
  '</div>'+
  '</body></html>';

  const w=window.open('','_blank'); if(!w) return;
  w.document.open(); w.document.write(html); w.document.close();
  const tryPrint=function(){try{w.focus(); w.print();}catch(_){}}; w.onload=tryPrint; setTimeout(tryPrint,600);
}

/* ===== Export CSV ===== */
function toCSV(rows){
  const headers=["Id","Fecha","Localidad","Calle","Tipo","Precio","ITP","NotarÃ­a","PSI","Reforma","Comunidad","IBI","Hogar","Impago","GestiÃ³n","Alquiler","Bruta%","Neta%","Flujo","Pmax","InvTotal","Asignados","URL"];
  const lines=[headers.join(';')];
  rows.forEach(function(e){
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    lines.push([
      e.id, f, safe(e.loc), safe(e.calle), safe(e.tipo),
      n(e.precio), n(e.itp), n(e.notaria), n(e.psi), n(e.reforma),
      n(e.comu), n(e.ibi), n(e.hogar), n(e.impago), n(e.gestion),
      n(e.alq), p(toPct(e.kpi_bruta)), p(toPct(e.kpi_neta)), n(e.kpi_flujo),
      n(e.pmax), n(e.inv_total), (e.prospect_ids||[]).length, safe(e.url)
    ].join(';'));
  });
  return lines.join('\n');
}
const n=v=>fmtN0.format(Number(parseNum(v)||v||0));
const p=v=>fmtN1.format(Number(v||0));
const safe=s=>(s??'').toString().replace(/;/g,',');

function download(name,content){
  const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* ===== Eventos tabla/UI ===== */
function onTableClick(ev){
  const btn=ev.target.closest('button[data-act]'); const tr=ev.target.closest('tr');
  if(!tr) return; const idEv=tr.dataset.id;
  if(btn){
    const act=btn.dataset.act;
    if(act==='ver') openDrawer(idEv);
    if(act==='del'){ if(confirm('Â¿Borrar esta evaluaciÃ³n?')){ Store.evals=(Store.evals||[]).filter(x=>x.id!==idEv); load(); } }
  }else{ openDrawer(idEv); }
}
function bindSort(){
  const ths=document.querySelectorAll('#tbl th[data-k]');
  ths.forEach(function(th){
    th.addEventListener('click',function(){
      const k=th.dataset.k; if(sortKey===k) sortAsc=!sortAsc; else{sortKey=k; sortAsc=true;}
      sort(); render();
    });
  });
}

/* ===== Abrir en Evaluar ===== */
function goEvaluar(idEv){
  localStorage.setItem('load_eval', idEv);
  location.href = 'evaluar.html';
}

/* ===== Attach ===== */
function attach(){
  id('b_filtrar').addEventListener('click',applyFilters);
  id('b_limpiar').addEventListener('click',function(){
    id('f_text').value=''; id('f_tipo').value=''; id('f_desde').value=''; id('f_hasta').value=''; applyFilters();
  });
  id('b_export').addEventListener('click',function(){
    if(!view.length){toast('Nada que exportar','warn');return;}
    download('evaluaciones.csv',toCSV(view));
  });
  id('tbody').addEventListener('click',onTableClick);
  id('d_cerrar').addEventListener('click',closeDrawer);
  id('uhOverlay').addEventListener('click',closeDrawer);
  bindSort(); load();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>
</body>
</html>
