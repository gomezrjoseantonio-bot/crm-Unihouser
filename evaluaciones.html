<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser ‚Äî Evaluaciones</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* ===== Estilos coherentes con Evaluar/Dashboard ===== */
.uh-overlay{position:fixed;inset:0;background:rgba(15,18,20,.28);backdrop-filter:blur(2px);display:none;z-index:80}
.uh-overlay.open{display:block}
.uh-drawer{position:fixed;top:0;right:-520px;height:100%;width:520px;max-width:100%;background:#fff;border-left:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(0,0,0,.22);transition:right .2s ease;z-index:90}
.uh-drawer.open{right:0}
.uh-d-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
.uh-d-body{padding:14px 16px 20px;overflow:auto;height:calc(100% - 56px);font-size:14px}
.uh-meta{font-size:12px;color:#667085;margin:2px 0 10px}
.uh-kv{display:flex;justify-content:space-between;border-bottom:1px dashed #eef2f7;padding:6px 0}
.uh-kv .k{color:#667085}
.uh-kv .v{font-weight:600}
.uh-list-pros label{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;padding:6px 0;border-bottom:1px solid #f3f4f6}

.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}

.kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
.kpi{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
.kpi .lab{font-size:12px;color:#667085}.kpi .val{font-weight:800;font-size:20px}

/* Tabla contenida */
.table-wrap{overflow:auto}
table.table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;white-space:nowrap;vertical-align:middle}
.table th{background:#f8fafc;color:#111827;cursor:pointer}
.table tr:last-child td{border-bottom:none}
.table tr{cursor:pointer}
th.num, td.num{text-align:right}
th.center, td.center{text-align:center}

/* Acciones */
.actions-cell{display:flex;gap:6px;justify-content:center}
.icon-btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;min-width:34px;height:34px;padding:0 8px;display:inline-flex;align-items:center;justify-content:center;font-size:16px;line-height:1}
.icon-btn:hover{background:#f8fafc}

.btn.sm{padding:8px 10px;font-size:13px;border-radius:10px}
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;font-size:12px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser ‚Äî CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html" class="active">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuraci√≥n</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Evaluaciones</h2>

    <div class="kpis" style="margin-top:6px">
      <div class="kpi"><div class="lab">Total evaluaciones</div><div class="val" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">Asignadas</div><div class="val" id="k_asig">0</div></div>
      <div class="kpi"><div class="lab">Bruta media</div><div class="val" id="k_bruta">0,0 %</div></div>
      <div class="kpi"><div class="lab">Neta media</div><div class="val" id="k_neta">0,0 %</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Filtros</h3>
      <div class="filters">
        <div class="row" style="display:grid;gap:10px;grid-template-columns:2fr 1fr 1fr 1fr auto auto auto">
          <div class="field"><label>Buscar</label><input id="f_text" placeholder="Localidad o calle"></div>
          <div class="field"><label>Tipo</label>
            <select id="f_tipo"><option value="">Todos</option><option>Tradicional</option><option>Habitaciones</option></select>
          </div>
          <div class="field"><label>Desde</label><input id="f_desde" type="date"></div>
          <div class="field"><label>Hasta</label><input id="f_hasta" type="date"></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_limpiar">Limpiar</button></div>
          <div class="field" style="align-self:end"><button class="btn primary" id="b_filtrar">Filtrar</button></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_export">Exportar CSV</button></div>
        </div>
      </div>
    </div>

    <div class="card table-wrap" style="margin-top:12px">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th data-k="ts">Fecha</th>
            <th data-k="loc">Localidad</th>
            <th data-k="calle">Calle</th>
            <th data-k="tipo">Tipo</th>
            <th data-k="precio" class="num">Precio</th>
            <th data-k="alq" class="num">Alquiler</th>
            <th data-k="kpi_bruta" class="num">Bruta %</th>
            <th data-k="kpi_neta" class="num">Neta %</th>
            <th data-k="kpi_flujo" class="num">Flujo</th>
            <th data-k="pmax" class="num">P. m√°x</th>
            <th data-k="asig" class="center">Asignados</th>
            <th class="center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="foot"><div class="container foot-inner">¬© 2025 Unihouser ¬∑ unihouser.es ¬∑ info@unihouser.es ¬∑ 644 300 200</div></footer>

<div id="uhOverlay" class="uh-overlay"></div>
<aside id="uhDrawer" class="uh-drawer" aria-hidden="true">
  <div class="uh-d-head">
    <strong>Detalle de evaluaci√≥n</strong>
    <button class="btn" id="d_cerrar">Cerrar</button>
  </div>
  <div class="uh-d-body">
    <div class="uh-meta" id="d_fecha">‚Äî</div>

    <div class="uh-kv"><div class="k">Localidad</div><div class="v" id="d_loc">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Calle</div><div class="v" id="d_calle">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Tipo</div><div class="v" id="d_tipo">‚Äî</div></div>

    <div class="uh-kv"><div class="k">Precio</div><div class="v" id="d_precio">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Alquiler</div><div class="v" id="d_alq">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Bruta</div><div class="v" id="d_bruta">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Neta</div><div class="v" id="d_neta">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Flujo</div><div class="v" id="d_flujo">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Precio m√°x.</div><div class="v" id="d_pmax">‚Äî</div></div>
    <div class="uh-kv"><div class="k">Inversi√≥n</div><div class="v" id="d_inv">‚Äî</div></div>
    <div class="uh-kv"><div class="k">URL</div><div class="v" id="d_url">‚Äî</div></div>

    <h3 style="margin:14px 0 8px">Asignar a prospects</h3>
    <div id="p_list" class="uh-list-pros">‚Äî</div>

    <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button class="btn primary" id="d_guardar">Guardar asignaci√≥n</button>
      <button class="btn" id="d_pdf">PDF</button>
      <button class="btn" id="d_editar">Abrir en Evaluar</button>
    </div>
  </div>
</aside>

<div id="toasts" class="toast-wrap"></div>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
const parseNum = v=>Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
const esc = s=>(s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function toast(msg,kind){ const w=id('toasts'); const el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg; w.appendChild(el); setTimeout(()=>el.style.opacity='0',1600); setTimeout(()=>{try{w.removeChild(el)}catch(_){}} ,2200); }
function toPct(raw){ let v=Number(raw||0); if(v>0 && v<=1) v*=100; while(v>=100) v/=10; return v; }

/* ===== Store ===== */
const Store={
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))}
};

/* ===== Estado ===== */
let data=[], view=[], sortKey='ts', sortAsc=true, openId=null;

/* ===== Carga y KPIs ===== */
function load(){
  data=(Store.evals||[]).map(e=>({...e, asig:(e.prospect_ids||[]).length}));
  applyFilters();
  kpis();
}
function kpis(){
  id('k_total').textContent = data.length;
  id('k_asig').textContent  = data.reduce((a,b)=>a+(b.asig||0),0);
  id('k_bruta').textContent = fmtN1.format(avg(data.map(x=>toPct(x.kpi_bruta))))+' %';
  id('k_neta').textContent  = fmtN1.format(avg(data.map(x=>toPct(x.kpi_neta))))+' %';
}
const avg = arr => arr.length? arr.reduce((a,b)=>a+Number(b||0),0)/arr.length : 0;

/* ===== Filtros/orden ===== */
function applyFilters(){
  const q=(id('f_text').value||'').toLowerCase().trim();
  const t=id('f_tipo').value||'';
  const d=id('f_desde').value? new Date(id('f_desde').value+'T00:00:00Z').getTime():0;
  const h=id('f_hasta').value? new Date(id('f_hasta').value+'T23:59:59Z').getTime():Infinity;
  view=data.filter(e=>{
    const ts=new Date(e.ts||e.id?.slice(3)).getTime();
    const txt=((e.loc||'')+' '+(e.calle||'')).toLowerCase();
    return (!q || txt.includes(q)) && (!t || e.tipo===t) && ts>=d && ts<=h;
  });
  sort(); render();
}
function sort(){
  view.sort((a,b)=>{ const va=get(a,sortKey), vb=get(b,sortKey); return (va<vb? -1: va>vb? 1: 0) * (sortAsc?1:-1); });
}
function get(o,k){
  if(k==='ts') return new Date(o.ts||o.id?.slice(3)).getTime();
  if(k==='asig') return (o.prospect_ids||[]).length;
  if(k==='kpi_bruta') return toPct(o.kpi_bruta);
  if(k==='kpi_neta') return toPct(o.kpi_neta);
  if(k==='kpi_flujo') return Number(parseNum(o.kpi_flujo));
  if(k==='pmax') return Number(o.pmax||0);
  if(k==='precio') return Number(o.precio||0);
  if(k==='alq') return Number(o.alq||0);
  if(k==='calle') return (o.calle||'').toLowerCase();
  return (o[k]||'').toString().toLowerCase();
}

/* ===== Render tabla ===== */
function render(){
  const tb=id('tbody'); tb.innerHTML='';
  view.forEach(e=>{
    const tr=document.createElement('tr'); tr.dataset.id=e.id;
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    tr.innerHTML=`
      <td>${f}</td>
      <td>${esc(e.loc||'')}</td>
      <td>${esc(e.calle||'')}</td>
      <td><span class="pill">${esc(e.tipo||'-')}</span></td>
      <td class="num">${e0(e.precio)}</td>
      <td class="num">${e0(e.alq)}</td>
      <td class="num">${fmtN1.format(toPct(e.kpi_bruta))} %</td>
      <td class="num">${fmtN1.format(toPct(e.kpi_neta))} %</td>
      <td class="num">${e0(e.kpi_flujo)}</td>
      <td class="num">${e0(e.pmax)}</td>
      <td class="center">${(e.prospect_ids||[]).length}</td>
      <td class="center">
        <div class="actions-cell">
          <button class="icon-btn" data-act="ver" title="Ver">üëÅ</button>
          <button class="icon-btn" data-act="del" title="Borrar">üóë</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
}

/* ===== Drawer detalle + asignaci√≥n ===== */
function openDrawer(idEv){
  openId=idEv;
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;

  id('d_fecha').textContent=new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');
  id('d_loc').textContent =e.loc||'‚Äî';
  id('d_calle').textContent=e.calle||'‚Äî';
  id('d_tipo').textContent =e.tipo||'‚Äî';
  id('d_precio').textContent=e0(e.precio);
  id('d_alq').textContent =e0(e.alq);
  id('d_bruta').textContent =fmtN1.format(toPct(e.kpi_bruta))+' %';
  id('d_neta').textContent =fmtN1.format(toPct(e.kpi_neta))+' %';
  id('d_flujo').textContent =e0(e.kpi_flujo);
  id('d_pmax').textContent =e0(e.pmax);
  id('d_inv').textContent =e0(e.inv_total);
  id('d_url').innerHTML =e.url? <a href="${e.url}" target="_blank" rel="noopener">Abrir</a>:'‚Äî';

  const wrap=id('p_list'); wrap.innerHTML='';
  const pros=Store.pros||[]; const set=new Set(e.prospect_ids||[]);
  if(!pros.length){ wrap.textContent='No hay prospects guardados.'; }
  else{
    pros.forEach(p=>{
      const row=document.createElement('label');
      const cb=document.createElement('input'); cb.type='checkbox';
      cb.value=p.id||p.email||p.nombre; cb.checked=set.has(cb.value);
      const sp=document.createElement('span');
      sp.textContent=${p.nombre||'‚Äî'} ¬∑ ${p.pref_tipo||'-'} ¬∑ ${(p.locs_text||'')};
      row.appendChild(cb); row.appendChild(sp);
      wrap.appendChild(row);
    });
  }

  id('uhOverlay').classList.add('open');
  id('uhDrawer').classList.add('open');

  id('d_guardar').onclick = saveAssign;
  id('d_pdf').onclick     = ()=>quickPDF(e.id);
  id('d_editar').onclick  = ()=>goEvaluar(e.id);
}
function closeDrawer(){ id('uhOverlay').classList.remove('open'); id('uhDrawer').classList.remove('open'); openId=null; }
function saveAssign(){
  if(!openId) return;
  const list=Store.evals||[];
  const idx=list.findIndex(x=>x.id===openId); if(idx<0) return;
  const choices=[...id('p_list').querySelectorAll('input[type=checkbox]')];
  list[idx].prospect_ids = choices.filter(c=>c.checked).map(c=>c.value);
  Store.evals=list; toast('Asignaci√≥n guardada','ok'); closeDrawer(); load();
}

/* ===== PDF simple ===== */
function quickPDF(idEv){
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e){toast('No encontrado','bad');return;}
  const fecha=new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Informe ‚Äî ${esc(e.loc||'')}</title>
  <style>body{font-family:Inter,Arial;color:#101828;margin:24px}h1{font-size:22px;margin:0 0 6px}
  h2{font-size:16px;margin:16px 0 8px}.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .box{border:1px solid #e5e7eb;border-radius:10px;padding:10px}.lab{font-size:12px;color:#667085}.val{font-weight:800}
  .foot{margin-top:16px;font-size:12px;color:#667085;text-align:center}</style></head><body>
  <h1>Informe BuyBox ‚Äî Unihouser</h1><div class="lab">${fecha}</div>
  <h2>Resumen financiero</h2><div class="grid">
  <div class="box"><div class="lab">Bruta</div><div class="val">${fmtN1.format(toPct(e.kpi_bruta))} %</div></div>
  <div class="box"><div class="lab">Neta</div><div class="val">${fmtN1.format(toPct(e.kpi_neta))} %</div></div>
  <div class="box"><div class="lab">Flujo anual</div><div class="val">${fmtE0.format(Number(parseNum(e.kpi_flujo)))}</div></div>
  <div class="box"><div class="lab">P. m√°x compra</div><div class="val">${fmtE0.format(e.pmax||0)}</div></div></div>
  <h2>Datos del inmueble</h2><div class="grid">
  <div class="box"><div class="lab">Localidad</div><div class="val">${esc(e.loc||'-')}</div></div>
  <div class="box"><div class="lab">Calle</div><div class="val">${esc(e.calle||'-')}</div></div>
  <div class="box"><div class="lab">Tipo</div><div class="val">${esc(e.tipo||'-')}</div></div>
  <div class="box"><div class="lab">Alquiler</div><div class="val">${fmtE0.format(e.alq||0)}</div></div>
  <div class="box"><div class="lab">Precio</div><div class="val">${fmtE0.format(e.precio||0)}</div></div>
  <div class="box"><div class="lab">Inversi√≥n total</div><div class="val">${fmtE0.format(e.inv_total||0)}</div></div></div>
  <div class="foot">¬© 2025 Unihouser ¬∑ unihouser.es ¬∑ info@unihouser.es ¬∑ 644 300 200</div></body></html>`;
  const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close();
  const tryPrint=()=>{ try{w.focus(); w.print();}catch(_){}}; w.onload=tryPrint; setTimeout(tryPrint,600);
}

/* ===== Export CSV (completo) ===== */
function toCSV(rows){
  const headers=["Id","Fecha","Localidad","Calle","Tipo","Precio","ITP","Notar√≠a","PSI","Reforma","Comunidad","IBI","Hogar","Impago","Gesti√≥n","Alquiler","Bruta%","Neta%","Flujo","Pmax","InvTotal","Asignados","URL"];
  const lines=[headers.join(';')];
  rows.forEach(e=>{
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    lines.push([
      e.id, f, safe(e.loc), safe(e.calle), safe(e.tipo),
      n(e.precio), n(e.itp), n(e.notaria), n(e.psi), n(e.reforma),
      n(e.comu), n(e.ibi), n(e.hogar), n(e.impago), n(e.gestion),
      n(e.alq), p(toPct(e.kpi_bruta)), p(toPct(e.kpi_neta)), n(e.kpi_flujo),
      n(e.pmax), n(e.inv_total), (e.prospect_ids||[]).length, safe(e.url)
    ].join(';'));
  });
  return lines.join('\n');
}
const n=v=>fmtN0.format(Number(parseNum(v)||v||0));
const p=v=>fmtN1.format(Number(v||0));
const safe=s=>(s??'').toString().replace(/;/g,',');

function download(name,content){
  const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* ===== Eventos tabla/UI ===== */
function onTableClick(ev){
  const btn=ev.target.closest('button[data-act]'); const tr=ev.target.closest('tr');
  if(!tr) return; const idEv=tr.dataset.id;
  if(btn){
    const act=btn.dataset.act;
    if(act==='ver') openDrawer(idEv);
    if(act==='del'){ if(confirm('¬øBorrar esta evaluaci√≥n?')){ Store.evals=(Store.evals||[]).filter(x=>x.id!==idEv); load(); } }
  }else{
    openDrawer(idEv);
  }
}
function bindSort(){
  document.querySelectorAll('#tbl th[data-k]').forEach(th=>{
    th.addEventListener('click',()=>{
      const k=th.dataset.k; if(sortKey===k) sortAsc=!sortAsc; else{sortKey=k; sortAsc=true;}
      sort(); render();
    });
  });
}

/* ===== Abrir en Evaluar ===== */
function goEvaluar(idEv){
  localStorage.setItem('_load_eval_', idEv);
  location.href = 'evaluar.html';
}

/* ===== Start ===== */
function attach(){
  id('b_filtrar').addEventListener('click',applyFilters);
  id('b_limpiar').addEventListener('click',()=>{id('f_text').value='';id('f_tipo').value='';id('f_desde').value='';id('f_hasta').value='';applyFilters();});
  id('b_export').addEventListener('click',()=>{ if(!view.length){toast('Nada que exportar','warn');return;} download('evaluaciones.csv',toCSV(view)); });
  id('tbody').addEventListener('click',onTableClick);
  id('d_cerrar').addEventListener('click',closeDrawer);
  id('uhOverlay').addEventListener('click',closeDrawer);
  bindSort(); load();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>
</body>
</html>
