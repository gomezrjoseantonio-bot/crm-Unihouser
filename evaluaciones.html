<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Unihouser — Evaluaciones</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html" class="active">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h1>Evaluaciones</h1>

    <div class="kpis">
      <div class="kpi"><div class="lab">Total evaluaciones</div><div class="val" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">Asignadas</div><div class="val" id="k_asig">0</div></div>
      <div class="kpi"><div class="lab">Bruta media</div><div class="val" id="k_bm">0,0 %</div></div>
      <div class="kpi"><div class="lab">Neta media</div><div class="val" id="k_nm">0,0 %</div></div>
    </div>

    <div class="section" style="margin-top:8px">
      <h3>Filtros</h3>
      <div class="row three">
        <div class="field">
          <label>Buscar</label>
          <input id="f_text" placeholder="Localidad o calle">
        </div>
        <div class="field">
          <label>Tipo</label>
          <select id="f_tipo">
            <option value="">Todos</option>
            <option>Tradicional</option>
            <option>Habitaciones</option>
          </select>
        </div>
        <div class="field">
          <label>Desde</label>
          <input id="f_desde" type="date" placeholder="dd/mm/aaaa">
        </div>
      </div>
      <div class="row three">
        <div class="field">
          <label>Hasta</label>
          <input id="f_hasta" type="date" placeholder="dd/mm/aaaa">
        </div>
        <div class="field"></div>
        <div class="field">
          <div class="actions" style="justify-content:flex-end">
            <button class="btn" id="b_limpiar">Limpiar</button>
            <button class="btn primary" id="b_filtrar">Filtrar</button>
            <button class="btn" id="b_export">Exportar CSV</button>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th data-k="ts">Fecha</th>
            <th data-k="loc">Localidad</th>
            <th data-k="calle">Calle</th>
            <th data-k="tipo">Tipo</th>
            <th data-k="precio">Precio</th>
            <th data-k="alq">Alquiler</th>
            <th data-k="kpi_bruta">Bruta %</th>
            <th data-k="kpi_neta">Neta %</th>
            <th data-k="kpi_flujo">Flujo</th>
            <th data-k="pmax">P. máx</th>
            <th data-k="pros">Asignados</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Drawer lateral -->
<aside id="drawer" class="card" style="position:fixed;top:80px;right:16px;bottom:16px;width:360px;max-width:92vw;overflow:auto;display:none;z-index:50">
  <div class="actions" style="justify-content:space-between;margin-bottom:6px">
    <h3 style="margin:0">Detalle</h3>
    <button class="btn" id="d_cerrar">Cerrar</button>
  </div>
  <div id="d_body" class="muted">—</div>
  <div class="actions" style="margin-top:10px">
    <button class="btn" id="d_asignar">Asignar a cliente</button>
    <button class="btn primary" id="d_abrir">Abrir en Evaluar</button>
    <button class="btn" id="d_borrar">Borrar</button>
  </div>
</aside>

<footer class="foot">
  <div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div>
</footer>

<!-- === JS inline: NO requiere js/evaluaciones.js === -->
<script>
// ===== Utils =====
const fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const id=s=>document.getElementById(s);
function parseNum(v){ if(v===null||v===undefined) return 0; if(typeof v==='number') return v; const s=String(v).trim().replace(/\./g,'').replace(',', '.'); const n=Number(s); return Number.isFinite(n)?n:0; }
function toPct(v){ const n=parseNum(v); return n<=1 ? n*100 : n; }
function esc(s){ return String(s??'').replace(/[<>&"]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;' }[m])); }

// ===== Store =====
const Store={
  get evals(){ try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch{ return [] } },
  set evals(v){ localStorage.setItem('evals', JSON.stringify(v)); },
  get pros(){ try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch{ return [] } },
  set pros(v){ localStorage.setItem('pros', JSON.stringify(v)); },
  set editingEval(v){ localStorage.setItem('editing_eval', JSON.stringify(v)); }
};

// ===== Estado =====
let rows=[], view=[], sortKey='ts', sortAsc=false, current=null;

// ===== Carga + KPIs =====
function load(){
  rows=(Store.evals||[]).map(e=>({
    ...e,
    ts:e.ts||Date.now(),
    loc:e.loc||e.localidad||'',
    calle:e.calle||'',
    tipo:e.tipo||(e.e_tipo||'Tradicional'),
    precio:parseNum(e.precio||e.e_precio),
    alq:parseNum(e.alq||e.e_alq),
    kpi_bruta:toPct(e.kpi_bruta),
    kpi_neta:toPct(e.kpi_neta),
    kpi_flujo:parseNum(e.kpi_flujo),
    pmax:parseNum(e.pmax),
    pros:(e.prospect_ids||[]).length,
    id:e.id||ev_${Math.random().toString(36).slice(2,8)}
  }));
  id('k_total').textContent=rows.length;
  id('k_asig').textContent=rows.reduce((a,b)=>a+(b.pros||0),0);
  const bm=rows.length?rows.reduce((a,b)=>a+Number(b.kpi_bruta||0),0)/rows.length:0;
  const nm=rows.length?rows.reduce((a,b)=>a+Number(b.kpi_neta||0),0)/rows.length:0;
  id('k_bm').textContent=${fmtN1.format(bm)} %;
  id('k_nm').textContent=${fmtN1.format(nm)} %;
  applyFilters();
}

// ===== Filtros =====
function applyFilters(){
  const q=(id('f_text').value||'').toLowerCase();
  const t=id('f_tipo').value||'';
  const d=id('f_desde').value?new Date(id('f_desde').value).getTime():0;
  const h=id('f_hasta').value?new Date(id('f_hasta').value).getTime()+24*3600*1000-1:Infinity;
  view=rows.filter(r=>{
    const inText=!q||(r.loc||'').toLowerCase().includes(q)||(r.calle||'').toLowerCase().includes(q);
    const inTipo=!t||r.tipo===t;
    const inFecha=(r.ts>=d && r.ts<=h);
    return inText&&inTipo&&inFecha;
  });
  sort(); render();
}
function sort(){
  view.sort((a,b)=>{const ka=a[sortKey], kb=b[sortKey]; if(ka==kb) return 0; return (ka>kb?1:-1)*(sortAsc?1:-1);});
}

// ===== Render =====
function render(){
  id('tbody').innerHTML=view.map(r=>`
    <tr data-id="${r.id}">
      <td>${new Date(r.ts).toLocaleDateString('es-ES')}</td>
      <td>${esc(r.loc)}</td>
      <td>${esc(r.calle)}</td>
      <td>${esc(r.tipo)}</td>
      <td>${fmtE0.format(r.precio||0)}</td>
      <td>${fmtE0.format(r.alq||0)}</td>
      <td>${fmtN1.format(r.kpi_bruta||0)} %</td>
      <td>${fmtN1.format(r.kpi_neta||0)} %</td>
      <td>${fmtE0.format(r.kpi_flujo||0)}</td>
      <td>${fmtE0.format(r.pmax||0)}</td>
      <td>${r.pros||0}</td>
      <td>
        <button class="btn" data-act="ver">Ver</button>
        <button class="btn" data-act="abrir">Abrir</button>
        <button class="btn" data-act="borrar">Borrar</button>
      </td>
    </tr>
  `).join('');
}

// ===== Drawer =====
function openDrawer(e){
  current=e;
  id('d_body').innerHTML=`
    <div class="kpis">
      <div class="kpi"><div class="lab">Localidad</div><div class="val">${esc(e.loc||'-')}</div></div>
      <div class="kpi"><div class="lab">Calle</div><div class="val">${esc(e.calle||'-')}</div></div>
      <div class="kpi"><div class="lab">Tipo</div><div class="val">${esc(e.tipo||'-')}</div></div>
      <div class="kpi"><div class="lab">Precio</div><div class="val">${fmtE0.format(e.precio||0)}</div></div>
      <div class="kpi"><div class="lab">Alquiler</div><div class="val">${fmtE0.format(e.alq||0)}</div></div>
      <div class="kpi"><div class="lab">Bruta</div><div class="val">${fmtN1.format(e.kpi_bruta||0)} %</div></div>
      <div class="kpi"><div class="lab">Neta</div><div class="val">${fmtN1.format(e.kpi_neta||0)} %</div></div>
      <div class="kpi"><div class="lab">Flujo</div><div class="val">${fmtE0.format(e.kpi_flujo||0)}</div></div>
      <div class="kpi"><div class="lab">P. máx</div><div class="val">${fmtE0.format(e.pmax||0)}</div></div>
    </div>`;
  id('drawer').style.display='block';
}
function closeDrawer(){ id('drawer').style.display='none'; current=null; }

// ===== Acciones tabla =====
function onTableClick(ev){
  const btn=ev.target.closest('button[data-act]'); if(!btn) return;
  const tr=ev.target.closest('tr'); if(!tr) return;
  const rid=tr.dataset.id;
  const e=view.find(x=>x.id===rid); if(!e) return;

  if(btn.dataset.act==='ver')   openDrawer(e);
  if(btn.dataset.act==='abrir') goEvaluar(e.id);
  if(btn.dataset.act==='borrar'){
    if(!confirm('¿Borrar esta evaluación?')) return;
    Store.evals=(Store.evals||[]).filter(x=>(x.id||'')!==e.id);
    load(); closeDrawer();
  }
}

// ===== Abrir en Evaluar =====
function goEvaluar(idEv){
  const e=(Store.evals||[]).find(x=>(x.id||'')===idEv);
  if(!e){ alert('No encontrado'); return; }
  Store.editingEval=e;
  location.href='evaluar.html?eid='+encodeURIComponent(e.id||'');
}

// ===== CSV =====
function toCSV(rows){
  const headers=["Fecha","Localidad","Calle","Tipo","Precio","Alquiler","Bruta%","Neta%","Flujo","Pmax","Asignados"];
  const lines=[headers.join(';')];
  rows.forEach(e=>{
    const f=new Date(e.ts).toLocaleDateString('es-ES');
    lines.push([ f, esc(e.loc), esc(e.calle), esc(e.tipo),
      fmtN0.format(parseNum(e.precio)), fmtN0.format(parseNum(e.alq)),
      fmtN1.format(parseNum(e.kpi_bruta)), fmtN1.format(parseNum(e.kpi_neta)),
      fmtN0.format(parseNum(e.kpi_flujo)), fmtN0.format(parseNum(e.pmax)),
      e.pros||0 ].join(';'));
  });
  return lines.join('\n');
}
function download(name,content){
  const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()},0);
}

// ===== Eventos =====
function bindSort(){
  document.querySelectorAll('#tbl th[data-k]').forEach(th=>{
    th.addEventListener('click',()=>{
      const k=th.dataset.k;
      if(sortKey===k) sortAsc=!sortAsc; else{sortKey=k; sortAsc=false;}
      sort(); render();
    });
  });
}
function attach(){
  id('b_filtrar').addEventListener('click',applyFilters);
  id('b_limpiar').addEventListener('click',()=>{
    id('f_text').value=''; id('f_tipo').value='';
    id('f_desde').value=''; id('f_hasta').value='';
    applyFilters();
  });
  id('b_export').addEventListener('click',()=>{ if(!view.length){alert('Nada que exportar');return;} download('evaluaciones.csv',toCSV(view)); });
  id('tbody').addEventListener('click',onTableClick);
  id('d_cerrar').addEventListener('click',closeDrawer);
  id('d_abrir').addEventListener('click',()=>{ if(current) goEvaluar(current.id); });
  id('d_borrar').addEventListener('click',()=>{ if(!current) return; if(!confirm('¿Borrar esta evaluación?')) return; Store.evals=Store.evals.filter(x=>(x.id||'')!==current.id); closeDrawer(); load(); });
  id('d_asignar').addEventListener('click',()=>{ location.href='dashboard.html'; }); // placeholder
  load(); bindSort();
}
document.addEventListener('DOMContentLoaded',attach);
</script>
</body>
</html>
