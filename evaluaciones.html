<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluaciones</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* Overlay + Drawer */
.uh-overlay{position:fixed;inset:0;background:rgba(15,18,20,.28);backdrop-filter:blur(2px);display:none;z-index:80}
.uh-overlay.open{display:block}
.uh-drawer{position:fixed;top:0;right:-560px;height:100%;width:560px;max-width:100%;background:#fff;border-left:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(0,0,0,.25);transition:right .2s ease;z-index:90}
.uh-drawer.open{right:0}
.uh-d-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
.uh-d-body{padding:14px 14px 22px;overflow:auto;height:calc(100% - 60px)}
.uh-meta{font-size:12px;color:#667085;margin-bottom:8px}

/* KPIs */
.kpi{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
.kpi .lab{font-size:12px;color:#667085}.kpi .val{font-weight:800;font-size:20px}
.kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}

/* Tabla */
table.table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;white-space:nowrap}
.table th{background:#f8fafc;color:#111827;cursor:pointer}
.table tr:last-child td{border-bottom:none}
.table tr{cursor:pointer}
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;font-size:12px}

/* Acciones */
.actions-cell{display:flex;gap:6px;align-items:center}
.iconbtn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
.iconbtn:hover{background:#f8fafc}
.icon{width:18px;height:18px;display:block}

/* Drawer detail list */
.block{border:1px solid #eef2f7;border-radius:10px;padding:10px;margin-bottom:10px;background:#fff}
.block h4{margin:0 0 8px 0;font-size:13px;color:#111827}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
.kv .k{color:#667085;font-size:12px}
.kv .v{font-weight:700}

/* Prospects */
.uh-list-pros{display:grid;gap:6px}
.uh-pro{display:flex;gap:8px;align-items:flex-start;padding:6px 8px;border:1px solid #eef2f7;border-radius:10px;background:#fff}
.uh-pro input{margin-top:3px}
.uh-pro .name{font-weight:700}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;border:1px solid #fcd34d;background:#fffbeb;color:#b45309;font-size:11px}
.badge svg{width:12px;height:12px}

/* Adjuntos */
.up-wrap{display:grid;gap:8px}
.up-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.thumb{width:78px;height:60px;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fafafa;position:relative}
.thumb img,.thumb video{max-width:100%;max-height:100%}
.thumb .x{position:absolute;top:2px;right:2px;background:#fff;border:1px solid #e5e7eb;border-radius:6px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.up-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.up-row input[type=file]{max-width:240px}

/* Filtros */
.filters .row{display:grid;gap:10px;grid-template-columns:2fr 1fr 1fr 1fr auto auto auto}
@media(max-width:1100px){.filters .row{grid-template-columns:1fr 1fr}}

/* Toasts */
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}
.small{font-size:12px;color:#667085}
.muted{color:#667085}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html" class="active">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Evaluaciones</h2>

    <div class="kpis" style="margin-top:6px">
      <div class="kpi"><div class="lab">Total evaluaciones</div><div class="val" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">Asignadas</div><div class="val" id="k_asig">0</div></div>
      <div class="kpi"><div class="lab">Bruta media</div><div class="val" id="k_bruta">0,0 %</div></div>
      <div class="kpi"><div class="lab">Neta media</div><div class="val" id="k_neta">0,0 %</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Filtros</h3>
      <div class="filters">
        <div class="row">
          <div class="field"><label>Buscar</label><input id="f_text" placeholder="Localidad o calle"></div>
          <div class="field"><label>Tipo</label>
            <select id="f_tipo"><option value="">Todos</option><option>Tradicional</option><option>Habitaciones</option></select>
          </div>
          <div class="field"><label>Desde</label><input id="f_desde" type="date"></div>
          <div class="field"><label>Hasta</label><input id="f_hasta" type="date"></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_limpiar">Limpiar</button></div>
          <div class="field" style="align-self:end"><button class="btn primary" id="b_filtrar">Filtrar</button></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_export">Exportar CSV</button></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th data-k="ts">Fecha</th>
            <th data-k="loc">Localidad</th>
            <th data-k="calle">Calle</th>
            <th data-k="tipo">Tipo</th>
            <th data-k="precio" style="text-align:right">Precio</th>
            <th data-k="alq" style="text-align:right">Alquiler</th>
            <th data-k="kpi_bruta" style="text-align:right">Bruta %</th>
            <th data-k="kpi_neta" style="text-align:right">Neta %</th>
            <th data-k="kpi_flujo" style="text-align:right">Flujo</th>
            <th data-k="pmax" style="text-align:right">P. máx</th>
            <th data-k="asig" style="text-align:center">Asignados</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<div id="uhOverlay" class="uh-overlay"></div>
<aside id="uhDrawer" class="uh-drawer" aria-hidden="true">
  <div class="uh-d-head">
    <strong>Detalle de evaluación</strong>
    <button class="btn" id="d_cerrar">Cerrar</button>
  </div>
  <div class="uh-d-body">
    <div class="uh-meta" id="d_fecha">—</div>

    <!-- ASIGNACIÓN -->
    <div class="block">
      <h4>Asignar a prospects <span class="small muted" id="d_match_info">—</span></h4>
      <div class="uh-list-pros" id="p_list">—</div>
      <div class="small muted" style="margin-top:6px">Se muestran primero las coincidencias (fase de búsqueda, tipo y localidad compatibles, y KPI ≥ objetivo). Se marcan avisos de reforma, ascensor, bajos, presupuesto.</div>
    </div>

    <!-- DATOS DEL INMUEBLE -->
    <div class="block">
      <h4>Datos del inmueble</h4>
      <div class="kv">
        <div class="k">Localidad</div><div class="v" id="d_loc">—</div>
        <div class="k">Calle</div><div class="v" id="d_calle">—</div>
        <div class="k">Superficie</div><div class="v" id="d_m2">—</div>
        <div class="k">Año</div><div class="v" id="d_anio">—</div>
        <div class="k">Ascensor</div><div class="v" id="d_asc">—</div>
        <div class="k">Planta</div><div class="v" id="d_alt">—</div>
        <div class="k">¿Bajo?</div><div class="v" id="d_bajo">—</div>
        <div class="k">Habitaciones</div><div class="v" id="d_habs">—</div>
        <div class="k">Baños</div><div class="v" id="d_banos">—</div>
        <div class="k">Reforma</div><div class="v" id="d_ref_tip">—</div>
        <div class="k">URL</div><div class="v" id="d_url">—</div>
      </div>
    </div>

    <!-- GASTOS ADQUISICIÓN -->
    <div class="block">
      <h4>Gastos de adquisición</h4>
      <div class="kv">
        <div class="k">Precio</div><div class="v" id="d_precio">—</div>
        <div class="k">ITP</div><div class="v" id="d_itp">—</div>
        <div class="k">Notaría</div><div class="v" id="d_notaria">—</div>
        <div class="k">PSI</div><div class="v" id="d_psi">—</div>
        <div class="k">Reforma (€)</div><div class="v" id="d_reforma">—</div>
      </div>
    </div>

    <!-- MANTENIMIENTO -->
    <div class="block">
      <h4>Gastos de mantenimiento</h4>
      <div class="kv">
        <div class="k">Comunidad</div><div class="v" id="d_comu">—</div>
        <div class="k">IBI</div><div class="v" id="d_ibi">—</div>
        <div class="k">Hogar</div><div class="v" id="d_hogar">—</div>
        <div class="k">Impago</div><div class="v" id="d_impago">—</div>
        <div class="k">Gestión</div><div class="v" id="d_gestion">—</div>
      </div>
    </div>

    <!-- INGRESOS Y KPIs -->
    <div class="block">
      <h4>Ingresos y KPIs</h4>
      <div class="kv">
        <div class="k">Tipo</div><div class="v" id="d_tipo">—</div>
        <div class="k">Alquiler mensual</div><div class="v" id="d_alq">—</div>
        <div class="k">Bruta</div><div class="v" id="d_bruta">—</div>
        <div class="k">Neta</div><div class="v" id="d_neta">—</div>
        <div class="k">Flujo anual</div><div class="v" id="d_flujo">—</div>
        <div class="k">Precio máx.</div><div class="v" id="d_pmax">—</div>
        <div class="k">Inversión total</div><div class="v" id="d_inv">—</div>
      </div>
    </div>

    <!-- ADJUNTOS -->
    <div class="block">
      <h4>Adjuntar archivos</h4>
      <div class="up-wrap">
        <div class="up-row">
          <strong>Imágenes</strong>
          <input type="file" id="up_img" accept="image/*" multiple>
        </div>
        <div class="up-grid" id="grid_img"></div>

        <div class="up-row" style="margin-top:6px">
          <strong>Vídeos</strong>
          <input type="file" id="up_vid" accept="video/*" multiple>
        </div>
        <div class="up-grid" id="grid_vid"></div>

        <div class="up-row" style="margin-top:6px">
          <strong>PDFs</strong>
          <input type="file" id="up_pdf" accept="application/pdf" multiple>
        </div>
        <div class="up-grid" id="grid_pdf"></div>

        <div class="small muted">Consejo: al ser almacenamiento local del navegador, usa archivos ligeros. Si no caben, te avisaré.</div>
      </div>
    </div>

    <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn primary" id="d_guardar">Guardar asignación</button>
      <button class="btn" id="d_pdf">Generar PDF</button>
      <button class="btn" id="d_editar">Abrir en Evaluar</button>
    </div>
  </div>
</aside>

<div id="toasts" class="toast-wrap"></div>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
const parseNum = v=>Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
function toast(msg,kind){
  const wrap=id('toasts'); if(!wrap) return;
  const el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(()=>el.style.opacity='0',1600);
  setTimeout(()=>{try{wrap.removeChild(el)}catch(_){}} ,2200);
}
function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function toPct(raw){ let v=Number(raw||0); if(v>0&&v<=1)v*=100; while(v>=100)v/=10; return v; }
function fold(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

/* ===== Store ===== */
const Store={
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  filesKey(id){return 'files_ev_'+id},
  getFiles(idEv){ try{return JSON.parse(localStorage.getItem(this.filesKey(idEv))||'{}')}catch(_){return{}} },
  setFiles(idEv,obj){ localStorage.setItem(this.filesKey(idEv), JSON.stringify(obj||{})); }
};

/* ===== Estado ===== */
let data=[], view=[], sortKey='ts', sortAsc=true, openId=null;

/* ===== Carga y KPIs ===== */
function load(){
  data=(Store.evals||[]).map(e=>({...e, asig:(e.prospect_ids||[]).length}));
  applyFilters();
  kpis();
}
function kpis(){
  id('k_total').textContent = data.length;
  id('k_asig').textContent  = data.reduce((a,b)=>a+(b.asig||0),0);
  id('k_bruta').textContent = fmtN1.format(avg(data.map(x=>toPct(x.kpi_bruta))))+' %';
  id('k_neta').textContent  = fmtN1.format(avg(data.map(x=>toPct(x.kpi_neta))))+' %';
}
const avg = arr => arr.length? arr.reduce((a,b)=>a+Number(b||0),0)/arr.length : 0;

/* ===== Filtros/orden ===== */
function applyFilters(){
  const q=(id('f_text').value||'').toLowerCase().trim();
  const t=id('f_tipo').value||'';
  const d=id('f_desde').value? new Date(id('f_desde').value+'T00:00:00Z').getTime():0;
  const h=id('f_hasta').value? new Date(id('f_hasta').value+'T23:59:59Z').getTime():Infinity;
  view=data.filter(e=>{
    const ts=new Date(e.ts||e.id?.slice(3)).getTime();
    const txt=((e.loc||'')+' '+(e.calle||'')).toLowerCase();
    return (!q || txt.includes(q)) && (!t || e.tipo===t) && ts>=d && ts<=h;
  });
  sort(); render();
}
function sort(){
  view.sort((a,b)=>{
    const va=get(a,sortKey), vb=get(b,sortKey);
    return (va<vb? -1: va>vb? 1: 0) * (sortAsc?1:-1);
  });
}
function get(o,k){
  if(k==='ts') return new Date(o.ts||o.id?.slice(3)).getTime();
  if(k==='asig') return (o.prospect_ids||[]).length;
  if(k==='kpi_bruta') return toPct(o.kpi_bruta);
  if(k==='kpi_neta') return toPct(o.kpi_neta);
  if(k==='kpi_flujo') return Number(parseNum(o.kpi_flujo));
  if(k==='pmax') return Number(o.pmax||0);
  if(k==='precio') return Number(o.precio||0);
  if(k==='alq') return Number(o.alq||0);
  if(k==='calle') return (o.calle||'').toLowerCase();
  return (o[k]||'').toString().toLowerCase();
}

/* ===== Render tabla ===== */
function render(){
  const tb=id('tbody'); tb.innerHTML='';
  view.forEach(e=>{
    const tr=document.createElement('tr'); tr.dataset.id=e.id;
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');

    let html='';
    html += '<td>'+f+'</td>';
    html += '<td>'+esc(e.loc||'')+'</td>';
    html += '<td>'+esc(e.calle||'')+'</td>';
    html += '<td><span class="pill">'+esc(e.tipo||'-')+'</span></td>';
    html += '<td style="text-align:right">'+e0(e.precio)+'</td>';
    html += '<td style="text-align:right">'+e0(e.alq)+'</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_bruta))+' %</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_neta))+' %</td>';
    html += '<td style="text-align:right">'+e0(e.kpi_flujo)+'</td>';
    html += '<td style="text-align:right">'+e0(e.pmax)+'</td>';
    html += '<td style="text-align:center">'+(e.prospect_ids||[]).length+'</td>';
    html += '<td><div class="actions-cell">';
    /* Ver */
    html += '<button class="iconbtn" title="Ver" data-act="ver" aria-label="Ver">'+
              '<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">'+
              '<path d="M2 12s4.5-7 10-7 10 7 10 7-4.5 7-10 7S2 12 2 12Z" stroke="#111827" stroke-width="1.5"/>'+
              '<circle cx="12" cy="12" r="3" stroke="#111827" stroke-width="1.5"/></svg>'+
            '</button>';
    /* Borrar */
    html += '<button class="iconbtn" title="Borrar" data-act="del" aria-label="Borrar">'+
              '<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">'+
              '<path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 7l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round"/>'+
              '<path d="M10 11v6m4-6v6" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round"/></svg>'+
            '</button>';
    html += '</div></td>';

    tr.innerHTML = html;
    tb.appendChild(tr);
  });
}

/* ===== Matching helpers ===== */
function isSearching(p){
  const f=fold(p.fase||'');
  return f.includes('busq') || f.includes('busc'); // BÚSQUEDA / BUSCANDO
}
function wantsNoReform(p){
  const r=fold(p.reforma||p.pref_reforma||'');
  return r==='no' || fold(p.no_reforma||'')==='si' || fold(p.prefiere_sin_reforma||'')==='si';
}
function wantsElevator(p){
  const a=fold(p.asc||p.ascensor||p.quiere_ascensor||'');
  return a==='si' || a==='sí' || a==='true' || a==='1';
}
function rejectsGround(p){
  const b=fold(p.bajos||p.bajo||'');
  return b==='no' || b==='false' || b==='0';
}
function prospectBudget(p){
  const candidates=[
    p.max_compra,p.pmax_compra,p.presupuesto_max,p.presupuesto,p.budget_max,p.budget
  ];
  for(const v of candidates){ const n=Number(String(v||'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.')); if(n>0) return n; }
  return 0;
}
function targetFrom(p){
  const kind=fold(p.obj_tipo||p.obj_main||'');
  const raw=Number(p.obj_raw||0);
  const br=Number(p.obj_bruta||0), ne=Number(p.obj_neta||0);
  const fm=Number(p.obj_flujo||0), fa=Number(p.obj_flujo_anual||0);
  if(kind==='bruta' && raw>0) return {kind:'bruta',val:raw};
  if(kind==='neta'  && raw>0) return {kind:'neta', val:raw};
  if(kind==='flujo' && (raw>0||fm>0||fa>0)) return {kind:'flujo',val:fa>0?fa:(raw>0?raw*12:fm*12)};
  if(br>0) return {kind:'bruta',val:br};
  if(ne>0) return {kind:'neta', val:ne};
  if(fm>0||fa>0) return {kind:'flujo',val:fa>0?fa:fm*12};
  return {kind:'',val:0};
}

/* ===== Drawer detalle + asignación ===== */
function openDrawer(idEv){
  openId=idEv;
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;

  // Meta + asignación
  id('d_fecha').textContent=new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');

  const pros=Store.pros||[];
  const plist=id('p_list'); plist.innerHTML='';
  let matches=0;

  const wantTipo=fold(e.tipo), wantLoc=fold(e.loc);
  pros.forEach(p=>{
    const row=document.createElement('label'); row.className='uh-pro';
    const cb=document.createElement('input'); cb.type='checkbox';
    const key=p.id||p.email||p.nombre; cb.value=key; cb.checked=(e.prospect_ids||[]).includes(key);

    const col=document.createElement('div');
    const title=document.createElement('div'); title.className='name';
    title.textContent=(p.nombre||'—');
    const meta=document.createElement('div'); meta.className='small muted';
    meta.textContent=(p.pref_tipo||'-')+' · '+(p.locs_text||'-');

    // lógica de coincidencia
    const locs=(p.locs_text||'').split(',').map(fold).filter(Boolean);
    const tgt=targetFrom(p);
    const ok=
      isSearching(p) &&
      fold(p.pref_tipo||'')===wantTipo &&
      locs.includes(wantLoc) &&
      (
        (tgt.kind==='bruta' && Number(e.kpi_bruta)>=tgt.val) ||
        (tgt.kind==='neta'  && Number(e.kpi_neta) >=tgt.val) ||
        (tgt.kind==='flujo' && Number(e.kpi_flujo)>=tgt.val)
      );
    if(ok) matches++;

    // avisos
    const warns=[];
    if((e.ref_tip||'no')!=='no' && wantsNoReform(p)) warns.push('Rechaza reforma');
    if(fold(e.asc||'si')==='no' && wantsElevator(p)) warns.push('Requiere ascensor');
    if(fold(e.bajo||'no')==='si' && rejectsGround(p)) warns.push('No quiere bajos');
    const bud=prospectBudget(p); if(bud>0 && Number(e.inv_total||0)>bud) warns.push('Excede presupuesto');

    const badges=document.createElement('div'); badges.className='badges';
    warns.forEach(w=>{
      const b=document.createElement('span'); b.className='badge';
      b.innerHTML='<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#b45309" stroke-width="1.2"/><path d="M12 7v6m0 4h.01" stroke="#b45309" stroke-width="1.6" stroke-linecap="round"/></svg>'+esc(w);
      badges.appendChild(b);
    });

    col.appendChild(title); col.appendChild(meta); if(warns.length) col.appendChild(badges);

    row.appendChild(cb); row.appendChild(col);

    // ordenar: coincidencias primero
    row.dataset.ok = ok? '1' : '0';
    plist.appendChild(row);
  });

  // reordenar: ok primero
  Array.from(plist.children).sort((a,b)=> (b.dataset.ok||'0').localeCompare(a.dataset.ok||'0')).forEach(el=>plist.appendChild(el));
  id('d_match_info').textContent = matches+' coincidencia(s) de '+pros.length;

  /* Rellenar bloques detalle */
  fillKV('d_loc', e.loc);             fillKV('d_calle', e.calle);
  fillKV('d_m2', e.m2? (e.m2+' m²'):'—'); fillKV('d_anio', e.anio||'—');
  fillKV('d_asc', e.asc||'—');        fillKV('d_alt', e.alt||'—');
  fillKV('d_bajo', e.bajo||'—');      fillKV('d_habs', e.habs||'—');
  fillKV('d_banos', e.banos||'—');    fillKV('d_ref_tip', e.ref_tip||'—');
  if(e.url){ id('d_url').innerHTML='<a href="'+esc(e.url)+'" target="_blank" rel="noopener">Abrir anuncio</a>'; } else { fillKV('d_url','—'); }

  fillKV('d_precio', e0(e.precio));   fillKV('d_itp', e0(e.itp));
  fillKV('d_notaria', e0(e.notaria)); fillKV('d_psi', e0(e.psi));
  fillKV('d_reforma', e0(e.reforma));

  fillKV('d_comu', e0(e.comu));       fillKV('d_ibi', e0(e.ibi));
  fillKV('d_hogar', e0(e.hogar));     fillKV('d_impago', e0(e.impago));
  fillKV('d_gestion', e0(e.gestion));

  fillKV('d_tipo', e.tipo||'—');      fillKV('d_alq', e0(e.alq));
  fillKV('d_bruta', fmtN1.format(toPct(e.kpi_bruta))+' %');
  fillKV('d_neta',  fmtN1.format(toPct(e.kpi_neta))+' %');
  fillKV('d_flujo', e0(e.kpi_flujo)); fillKV('d_pmax', e0(e.pmax));
  fillKV('d_inv',   e0(e.inv_total));

  // Adjuntos
  bindUploads(e.id);

  id('uhOverlay').classList.add('open');
  id('uhDrawer').classList.add('open');

  id('d_guardar').onclick = saveAssign;
  id('d_pdf').onclick = function(){ quickPDF(e.id); };
  id('d_editar').onclick = function(){ goEvaluar(e.id); };
}
function fillKV(k,v){ const el=id(k); if(el) el.textContent=(v==null||v==='')?'—':v; }

function closeDrawer(){
  id('uhOverlay').classList.remove('open');
  id('uhDrawer').classList.remove('open');
  openId=null;
}
function saveAssign(){
  if(!openId) return;
  const list=Store.evals||[];
  const idx=list.findIndex(x=>x.id===openId); if(idx<0) return;
  const choices=[].slice.call(id('p_list').querySelectorAll('input[type=checkbox]'));
  list[idx].prospect_ids = choices.filter(c=>c.checked).map(c=>c.value);
  Store.evals=list;
  toast('Asignación guardada','ok');
  closeDrawer();
  load();
}

/* ===== Adjuntos (localStorage, miniaturas) ===== */
const FILE_LIMIT_IMG = 800*1024;   // ~0.8 MB por imagen
const FILE_LIMIT_PDF = 1500*1024;  // ~1.5 MB por pdf
const FILE_LIMIT_VID = 2500*1024;  // ~2.5 MB por vídeo (ojo: localStorage total ~5MB)

function bindUploads(evId){
  const files=Store.getFiles(evId)||{};
  files.images = files.images||[];
  files.videos = files.videos||[];
  files.pdfs   = files.pdfs||[];
  const gridI=id('grid_img'), gridV=id('grid_vid'), gridP=id('grid_pdf');
  const drawAll=()=>{
    drawGrid(gridI, files.images, 'img', evId);
    drawGrid(gridV, files.videos, 'vid', evId);
    drawGrid(gridP, files.pdfs,   'pdf', evId);
  };
  drawAll();

  id('up_img').onchange = (e)=> handleFiles(e.target.files, 'img', evId, files, drawAll);
  id('up_vid').onchange = (e)=> handleFiles(e.target.files, 'vid', evId, files, drawAll);
  id('up_pdf').onchange = (e)=> handleFiles(e.target.files, 'pdf', evId, files, drawAll);
}
function handleFiles(fileList, kind, evId, files, redraw){
  if(!fileList||!fileList.length) return;
  const arr = Array.from(fileList);
  let pending=arr.length, added=0;
  arr.forEach(f=>{
    const limit = kind==='img'? FILE_LIMIT_IMG : (kind==='pdf'? FILE_LIMIT_PDF : FILE_LIMIT_VID);
    if(f.size>limit){ toast('Archivo grande: '+f.name,'warn'); if(--pending===0){saveAndRedraw();} return; }
    const reader=new FileReader();
    reader.onload = function(){
      const item={name:f.name, data:reader.result, ts:Date.now()};
      if(kind==='img') files.images.push(item);
      if(kind==='vid') files.videos.push(item);
      if(kind==='pdf') files.pdfs.push(item);
      added++; if(--pending===0){ saveAndRedraw(); }
    };
    reader.onerror = function(){ toast('Error leyendo '+f.name,'bad'); if(--pending===0){saveAndRedraw();} };
    reader.readAsDataURL(f);
  });
  function saveAndRedraw(){
    try{
      Store.setFiles(evId, files);
      if(added) toast('Adjuntados '+added+' archivo(s)','ok');
    }catch(_){
      toast('Espacio insuficiente en el navegador','bad');
    }
    redraw();
  }
}
function drawGrid(grid, items, kind, evId){
  grid.innerHTML='';
  items.forEach((it,idx)=>{
    const t=document.createElement('div'); t.className='thumb';
    const btn=document.createElement('div'); btn.className='x'; btn.innerHTML='×';
    btn.onclick=function(){
      items.splice(idx,1); Store.setFiles(evId, Store.getFiles(evId)); // guardar
      const f=Store.getFiles(evId); f[kind==='img'?'images':kind==='vid'?'videos':'pdfs']=items; Store.setFiles(evId,f);
      drawGrid(grid,items,kind,evId);
    };
    if(kind==='img'){
      const img=new Image(); img.src=it.data; img.alt=it.name; t.appendChild(img);
      t.appendChild(btn);
      t.onclick=function(){ openDataUrl(it.data,'_blank'); };
    }else if(kind==='vid'){
      const v=document.createElement('video'); v.src=it.data; v.muted=true; v.playsInline=true; v.loop=false; t.appendChild(v);
      t.appendChild(btn);
      t.onclick=function(){ openDataUrl(it.data,'_blank'); };
    }else{
      const span=document.createElement('span'); span.textContent='PDF'; t.appendChild(span);
      t.appendChild(btn);
      t.onclick=function(){ openDataUrl(it.data,'_blank'); };
    }
    grid.appendChild(t);
  });
}
function openDataUrl(dataUrl){
  const w=window.open('','_blank'); if(!w) return;
  if(dataUrl.startsWith('data:application/pdf')){
    w.document.write('<iframe src="'+dataUrl+'" style="border:0;position:fixed;inset:0;width:100%;height:100%"></iframe>');
  }else if(dataUrl.startsWith('data:video')){
    w.document.write('<video src="'+dataUrl+'" controls style="position:fixed;inset:0;width:100%;height:100%;background:#000"></video>');
  }else{
    w.document.write('<img src="'+dataUrl+'" style="position:fixed;inset:0;max-width:100%;max-height:100%;margin:auto">');
  }
  w.document.close();
}

/* ===== PDF simple (colores marca suaves) ===== */
function quickPDF(idEv){
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e){toast('No encontrado','bad');return;}
  const fecha=new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');
  // Paleta Unihouser aprox
  const c1='#E47D2C', c2='#2E6F6A', c3='#C24A3A';
  const html =
'<!DOCTYPE html><html><head><meta charset="utf-8"><title>Informe — '+(e.loc||'')+
'</title><style>body{font-family:Inter,Arial;color:#101828;margin:0} .band{height:10px;background:linear-gradient(90deg,'+c1+','+c2+','+c3+')} .wrap{padding:24px} h1{font-size:22px;margin:10px 0 6px}h2{font-size:16px;margin:16px 0 8px}.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}.box{border:1px solid #e5e7eb;border-radius:10px;padding:10px}.lab{font-size:12px;color:#667085}.val{font-weight:800}.foot{margin-top:16px;font-size:12px;color:#667085;text-align:center}</style></head><body>'+
'<div class="band"></div><div class="wrap">'+
'<h1>Informe BuyBox — Unihouser</h1><div class="lab">'+fecha+'</div>'+
'<h2>Resumen financiero</h2><div class="grid">'+
'<div class="box"><div class="lab">Bruta</div><div class="val">'+fmtN1.format(toPct(e.kpi_bruta))+' %</div></div>'+
'<div class="box"><div class="lab">Neta</div><div class="val">'+fmtN1.format(toPct(e.kpi_neta))+' %</div></div>'+
'<div class="box"><div class="lab">Flujo anual</div><div class="val">'+fmtE0.format(parseNum(e.kpi_flujo))+'</div></div>'+
'<div class="box"><div class="lab">P. máx compra</div><div class="val">'+fmtE0.format(e.pmax||0)+'</div></div></div>'+
'<h2>Datos del inmueble</h2><div class="grid">'+
'<div class="box"><div class="lab">Localidad</div><div class="val">'+esc(e.loc||'-')+'</div></div>'+
'<div class="box"><div class="lab">Calle</div><div class="val">'+esc(e.calle||'-')+'</div></div>'+
'<div class="box"><div class="lab">Tipo</div><div class="val">'+esc(e.tipo||'-')+'</div></div>'+
'<div class="box"><div class="lab">Alquiler</div><div class="val">'+fmtE0.format(e.alq||0)+'</div></div>'+
'<div class="box"><div class="lab">Precio</div><div class="val">'+fmtE0.format(e.precio||0)+'</div></div>'+
'<div class="box"><div class="lab">Inversión total</div><div class="val">'+fmtE0.format(e.inv_total||0)+'</div></div></div>'+
'<div class="foot">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></div></body></html>';

  const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close();
  const tryPrint=function(){try{w.focus(); w.print();}catch(_){}}; w.onload=tryPrint; setTimeout(tryPrint,600);
}

/* ===== Export CSV ===== */
function toCSV(rows){
  const headers=["Id","Fecha","Localidad","Calle","Tipo","Precio","ITP","Notaría","PSI","Reforma","Comunidad","IBI","Hogar","Impago","Gestión","Alquiler","Bruta%","Neta%","Flujo","Pmax","InvTotal","Asignados","URL"];
  const lines=[headers.join(';')];
  rows.forEach(function(e){
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    lines.push([
      e.id, f, safe(e.loc), safe(e.calle), safe(e.tipo),
      n(e.precio), n(e.itp), n(e.notaria), n(e.psi), n(e.reforma),
      n(e.comu), n(e.ibi), n(e.hogar), n(e.impago), n(e.gestion),
      n(e.alq), p(toPct(e.kpi_bruta)), p(toPct(e.kpi_neta)), n(e.kpi_flujo),
      n(e.pmax), n(e.inv_total), (e.prospect_ids||[]).length, safe(e.url)
    ].join(';'));
  });
  return lines.join('\n');
}
const n=v=>fmtN0.format(Number(parseNum(v)||v||0));
const p=v=>fmtN1.format(Number(v||0));
const safe=s=>(s??'').toString().replace(/;/g,',');

function download(name,content){
  const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* ===== Eventos tabla/UI ===== */
function onTableClick(ev){
  const btn=ev.target.closest('button[data-act]'); const tr=ev.target.closest('tr');
  if(!tr) return; const idEv=tr.dataset.id;
  if(btn){
    const act=btn.dataset.act;
    if(act==='ver') openDrawer(idEv);
    if(act==='del'){ if(confirm('¿Borrar esta evaluación?')){ Store.evals=(Store.evals||[]).filter(x=>x.id!==idEv); load(); } }
  }else{
    openDrawer(idEv);
  }
}
function bindSort(){
  const ths=document.querySelectorAll('#tbl th[data-k]');
  ths.forEach(function(th){
    th
