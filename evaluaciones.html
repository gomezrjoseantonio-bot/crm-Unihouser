<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluaciones</title>

<style>
/* ===== Tokens comunes ===== */
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
a{color:var(--brand);text-decoration:none}

/* Topbar unificado */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1100px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);padding:6px 10px;border-radius:10px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}

/* Contenedor / cards */
.container{max-width:1100px;margin:0 auto;padding:12px 14px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
h2{margin:0 0 8px;font-size:16px}
h3{margin:0 0 6px;font-size:14px;color:#444}

/* KPIs */
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpi .lab{font-size:12px;color:var(--ink2)}
.kpi .val{font-weight:800;font-size:20px}
.kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}

/* Filtros */
.filters .row{display:grid;gap:10px;grid-template-columns:2fr 1fr 1fr 1fr auto auto auto}
@media(max-width:1100px){.filters .row{grid-template-columns:1fr 1fr}}

/* Tabla */
table.table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;white-space:nowrap}
.table th{background:#f8fafc;color:#111827;cursor:pointer}
.table tr:last-child td{border-bottom:none}
.table tr{cursor:pointer}
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;font-size:12px}

/* Acciones */
.actions-cell{display:flex;gap:6px;align-items:center}
.iconbtn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.iconbtn:hover{background:#f8fafc}
.icon{width:18px;height:18px;display:block}

/* Overlay + Drawer */
.uh-overlay{position:fixed;inset:0;background:rgba(15,18,20,.28);backdrop-filter:blur(2px);display:none;z-index:80}
.uh-overlay.open{display:block}
.uh-drawer{position:fixed;top:0;right:-560px;height:100%;width:560px;max-width:100%;background:#fff;border-left:1px solid var(--line);box-shadow:0 10px 24px rgba(0,0,0,.25);transition:right .2s ease;z-index:90}
.uh-drawer.open{right:0}
.uh-d-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
.uh-d-title{font-weight:800}
.uh-d-body{padding:12px 14px 18px;overflow:auto;height:calc(100% - 54px)}

/* Bloques detalle */
.block{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0}
.block h4{margin:0 0 8px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 12px}
.kv .k{color:var(--ink2);font-size:12px}
.kv .v{font-weight:700}

/* Prospects */
.match-meta{font-size:12px;color:var(--ink2);margin:6px 0 4px}
.uh-list-pros{display:grid;gap:6px;margin-top:4px}
.uh-list-pros label{display:flex;gap:8px;align-items:flex-start;padding:6px 8px;border:1px solid #eef2f7;border-radius:10px;background:#fff}
.uh-list-pros input{width:16px;height:16px;margin-top:2px}
.p-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid #e5e7eb;background:#f9fafb}
.badge.ok{border-color:#86efac;background:#ecfdf5}
.badge.warn{border-color:#fde68a;background:#fff7ed;color:#b45309}
.badge small{font-weight:700}

/* Adjuntos */
.attach-wrap{display:grid;gap:10px}
.attach-grid{display:grid;gap:6px;grid-template-columns:repeat(6,1fr)}
.thumb{position:relative;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:#fff;height:64px}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.thumb .mini{display:flex;align-items:center;justify-content:center;height:100%;font-size:10px;color:#333}
.thumb .x{position:absolute;top:3px;right:3px;background:#fff;border:1px solid var(--line);border-radius:8px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.uploader{display:flex;align-items:center;gap:8px}
.uploader input{max-width:70%}

/* Botones */
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff;border:none}

/* Toasts */
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}

/* Modal enviar */
.modal-back{position:fixed;inset:0;background:rgba(15,18,20,.28);display:none;align-items:center;justify-content:center;z-index:120}
.modal{width:800px;max-width:95vw;max-height:88vh;background:#fff;border:2px solid #fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.22);display:flex;flex-direction:column;overflow:hidden}
.modal header{padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}
.modal h4{margin:0}
.modal .body{padding:10px 12px;display:grid;gap:8px;overflow:auto}
.modal footer{padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end}
.row-send{display:grid;gap:8px;grid-template-columns:1fr 2fr}
.send-to{border:1px solid #e5e7eb;border-radius:10px;padding:8px;max-height:180px;overflow:auto}
.send-to label{display:flex;align-items:center;gap:8px;padding:4px 6px}
.area{border:1px solid #e5e7eb;border-radius:10px;padding:8px}
.area input,.area textarea{width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px}
.area textarea{min-height:140px;resize:vertical}

.foot{margin:16px 0 20px;text-align:center;color:#888;font-size:11px}
</style>
</head>
<body>

<!-- Topbar unificado -->
<header class="topbar">
  <div class="top-inner">
    <div class="brand"><div class="logo" id="logoBox">U</div><div class="title" id="brandTitle">Unihouser — Evaluaciones</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html" class="active">Evaluaciones</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Evaluaciones</h2>

    <div class="kpis" style="margin-top:6px">
      <div class="kpi"><div class="lab">Total evaluaciones</div><div class="val" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">Asignadas</div><div class="val" id="k_asig">0</div></div>
      <div class="kpi"><div class="lab">Bruta media</div><div class="val" id="k_bruta">0,0 %</div></div>
      <div class="kpi"><div class="lab">Neta media</div><div class="val" id="k_neta">0,0 %</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Filtros</h3>
      <div class="filters">
        <div class="row">
          <div class="field"><label>Buscar</label><input id="f_text" placeholder="Localidad o calle"></div>
          <div class="field"><label>Tipo</label>
            <select id="f_tipo"><option value="">Todos</option><option>Tradicional</option><option>Habitaciones</option></select>
          </div>
          <div class="field"><label>Desde</label><input id="f_desde" type="date"></div>
          <div class="field"><label>Hasta</label><input id="f_hasta" type="date"></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_limpiar">Limpiar</button></div>
          <div class="field" style="align-self:end"><button class="btn primary" id="b_filtrar">Filtrar</button></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_export">Exportar CSV</button></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th data-k="ts">Fecha</th>
            <th data-k="loc">Localidad</th>
            <th data-k="calle">Calle</th>
            <th data-k="tipo">Tipo</th>
            <th data-k="precio" style="text-align:right">Precio</th>
            <th data-k="alq" style="text-align:right">Alquiler</th>
            <th data-k="kpi_bruta" style="text-align:right">Bruta %</th>
            <th data-k="kpi_neta" style="text-align:right">Neta %</th>
            <th data-k="kpi_flujo" style="text-align:right">Flujo</th>
            <th data-k="pmax" style="text-align:right">P. máx</th>
            <th data-k="asig" style="text-align:center">Asignados</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="foot"><div class="container">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<div id="uhOverlay" class="uh-overlay"></div>
<aside id="uhDrawer" class="uh-drawer" aria-hidden="true">
  <div class="uh-d-head">
    <span class="uh-d-title">Detalle de evaluación</span>
    <div style="display:flex;gap:6px">
      <button class="btn" id="d_enviar">Enviar</button>
      <button class="btn" id="d_cerrar">Cerrar</button>
    </div>
  </div>
  <div class="uh-d-body" id="drawerBody">
    <div class="uh-meta" id="d_fecha">—</div>

    <!-- ASIGNACIÓN -->
    <div class="block">
      <h4>Asignar a prospects</h4>
      <div class="match-meta" id="matchInfo">—</div>
      <div id="p_list" class="uh-list-pros">—</div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="btn primary" id="d_guardar">Guardar asignación</button>
        <button class="btn" id="d_pdf">PDF</button>
        <button class="btn" id="d_editar">Abrir en Evaluar</button>
      </div>
    </div>

    <!-- BLOQUES DETALLE -->
    <div class="block">
      <h4>Datos del inmueble</h4>
      <div class="kv">
        <div class="k">Localidad</div><div class="v" id="d_loc">—</div>
        <div class="k">Calle</div><div class="v" id="d_calle">—</div>
        <div class="k">Superficie</div><div class="v" id="d_m2">—</div>
        <div class="k">Año</div><div class="v" id="d_anio">—</div>
        <div class="k">Ascensor</div><div class="v" id="d_asc">—</div>
        <div class="k">Planta</div><div class="v" id="d_alt">—</div>
        <div class="k">¿Bajo?</div><div class="v" id="d_bajo">—</div>
        <div class="k">Habitaciones</div><div class="v" id="d_habs">—</div>
        <div class="k">Baños</div><div class="v" id="d_banos">—</div>
        <div class="k">Reforma</div><div class="v" id="d_ref">—</div>
        <div class="k">URL</div><div class="v" id="d_url">—</div>
      </div>
    </div>

    <div class="block">
      <h4>Gastos de adquisición</h4>
      <div class="kv">
        <div class="k">Precio</div><div class="v" id="d_precio">—</div>
        <div class="k">ITP</div><div class="v" id="d_itp">—</div>
        <div class="k">Notaría</div><div class="v" id="d_notaria">—</div>
        <div class="k">PSI</div><div class="v" id="d_psi">—</div>
        <div class="k">Reforma (€)</div><div class="v" id="d_reforma_eur">—</div>
        <div class="k">Inversión total</div><div class="v" id="d_inv">—</div>
      </div>
    </div>

    <div class="block">
      <h4>Gastos de mantenimiento</h4>
      <div class="kv">
        <div class="k">Comunidad/año</div><div class="v" id="d_comu">—</div>
        <div class="k">IBI/año</div><div class="v" id="d_ibi">—</div>
        <div class="k">Hogar/año</div><div class="v" id="d_hogar">—</div>
        <div class="k">Impago/año</div><div class="v" id="d_impago">—</div>
        <div class="k">Gestión/año</div><div class="v" id="d_gestion">—</div>
      </div>
    </div>

    <div class="block">
      <h4>Explotación e ingresos</h4>
      <div class="kv">
        <div class="k">Tipo alquiler</div><div class="v" id="d_tipo">—</div>
        <div class="k">Alquiler mensual</div><div class="v" id="d_alq">—</div>
        <div class="k">Bruta</div><div class="v" id="d_bruta">—</div>
        <div class="k">Neta</div><div class="v" id="d_neta">—</div>
        <div class="k">Flujo anual</div><div class="v" id="d_flujo">—</div>
        <div class="k">Precio máx.</div><div class="v" id="d_pmax">—</div>
      </div>
    </div>

    <!-- ADJUNTOS -->
    <div class="block">
      <h4>Adjuntar archivos</h4>
      <div class="attach-wrap">
        <div>
          <div class="uploader"><strong>Imágenes</strong><input id="up_imgs" type="file" accept="image/*" multiple></div>
          <div id="grid_imgs" class="attach-grid"></div>
        </div>
        <div>
          <div class="uploader"><strong>Vídeos</strong><input id="up_vids" type="file" accept="video/*" multiple></div>
          <div id="grid_vids" class="attach-grid"></div>
        </div>
        <div>
          <div class="uploader"><strong>PDFs</strong><input id="up_pdfs" type="file" accept="application/pdf" multiple></div>
          <div id="grid_pdfs" class="attach-grid"></div>
        </div>
      </div>
    </div>
  </div>
</aside>

<!-- Modal Enviar -->
<div class="modal-back" id="sendBack">
  <div class="modal" role="dialog" aria-label="Enviar ficha" aria-modal="true">
    <header><h4>Enviar ficha</h4><button class="btn" id="sendClose">Cerrar</button></header>
    <div class="body">
      <div class="row-send">
        <div>
          <div class="area" style="margin-bottom:8px">
            <label>Canal</label>
            <select id="sendChannel">
              <option value="email">Email</option>
              <option value="whatsapp">WhatsApp</option>
            </select>
          </div>
          <div class="send-to" id="sendToBox">—</div>
          <div style="margin-top:6px"><small class="small">Puedes añadir manualmente al final si no aparece.</small></div>
        </div>
        <div class="area">
          <div style="display:grid;gap:6px">
            <label>Asunto (email) / Encabezado (WhatsApp)</label>
            <input id="sendSubject" placeholder="Asunto"/>
            <label>Mensaje</label>
            <textarea id="sendBody" placeholder="Texto a enviar…"></textarea>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <button class="btn" id="sendCopy">Copiar</button>
      <button class="btn" id="sendOpenWA">Abrir WhatsApp</button>
      <button class="btn primary" id="sendOpenMail">Abrir correo</button>
    </footer>
  </div>
</div>

<div id="toasts" class="toast-wrap"></div>

<script>
(function(){
"use strict";

/* === Marca desde cfg: color + nombre === */
try{
  var cfg0=JSON.parse(localStorage.getItem('cfg')||'{}')||{};
  var col=cfg0.brand_color || cfg0.brand || '#c7530c';
  document.documentElement.style.setProperty('--brand', col);
  var brandName = cfg0.company_name || cfg0.brand_name || 'Unihouser';
  document.getElementById('brandTitle').textContent = brandName+' — Evaluaciones';
  document.getElementById('logoBox').textContent = (brandName||'U').toString().trim().charAt(0).toUpperCase() || 'U';
}catch(_){}

/* ===== Utils ===== */
function id(x){return document.getElementById(x);}
var fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
var fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function e0(v){return fmtE0.format(Number(v||0));}
function parseNum(v){return Number(String(v==null?'':v).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;}
function toast(msg,kind){
  var wrap=id('toasts'); if(!wrap) return;
  var el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(function(){el.style.opacity='0';},1600);
  setTimeout(function(){try{wrap.removeChild(el)}catch(_){}} ,2200);
}
function esc(s){return (s==null?'':String(s)).replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]})}
function toPct(raw){ var v=Number(raw||0); if(v>0&&v<=1)v*=100; while(v>=100)v/=10; return v; }

/* Store */
var Store={
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}
};

/* Estado */
var data=[], view=[], sortKey='ts', sortAsc=true, openId=null;

/* Carga y KPIs */
function load(){
  data=(Store.evals||[]).map(function(e){return Object.assign({}, e, {asig:(e.prospect_ids||[]).length});});
  applyFilters();
  kpis();
}
function kpis(){
  id('k_total').textContent = data.length;
  id('k_asig').textContent  = data.reduce(function(a,b){return a+(b.asig||0)},0);
  id('k_bruta').textContent = fmtN1.format(avg(data.map(function(x){return toPct(x.kpi_bruta)})))+' %';
  id('k_neta').textContent  = fmtN1.format(avg(data.map(function(x){return toPct(x.kpi_neta)})))+' %';
}
function avg(arr){return arr.length? arr.reduce(function(a,b){return a+Number(b||0)},0)/arr.length : 0;}

/* Filtros/orden */
function applyFilters(){
  var q=(id('f_text').value||'').toLowerCase().trim();
  var t=id('f_tipo').value||'';
  var d=id('f_desde').value? new Date(id('f_desde').value+'T00:00:00Z').getTime():0;
  var h=id('f_hasta').value? new Date(id('f_hasta').value+'T23:59:59Z').getTime():Infinity;
  view=data.filter(function(e){
    var ts=new Date(e.ts || (e.id? e.id.slice(3): '')).getTime();
    var txt=((e.loc||'')+' '+(e.calle||'')).toLowerCase();
    return (!q || txt.includes(q)) && (!t || e.tipo===t) && ts>=d && ts<=h;
  });
  sort(); render();
}
function sort(){
  view.sort(function(a,b){
    var va=get(a,sortKey), vb=get(b,sortKey);
    return (va<vb? -1: va>vb? 1: 0) * (sortAsc?1:-1);
  });
}
function get(o,k){
  if(k==='ts') return new Date(o.ts || (o.id? o.id.slice(3): '')).getTime();
  if(k==='asig') return (o.prospect_ids||[]).length;
  if(k==='kpi_bruta') return toPct(o.kpi_bruta);
  if(k==='kpi_neta') return toPct(o.kpi_neta);
  if(k==='kpi_flujo') return Number(parseNum(o.kpi_flujo));
  if(k==='pmax') return Number(o.pmax||0);
  if(k==='precio') return Number(o.precio||0);
  if(k==='alq') return Number(o.alq||0);
  if(k==='calle') return (o.calle||'').toLowerCase();
  return (o[k]||'').toString().toLowerCase();
}

/* Render tabla */
function render(){
  var tb=id('tbody'); tb.innerHTML='';
  view.forEach(function(e){
    var tr=document.createElement('tr'); tr.dataset.id=e.id;
    var f=new Date(e.ts || (e.id? e.id.slice(3): '')).toLocaleDateString('es-ES');
    var html='';
    html += '<td>'+f+'</td>';
    html += '<td>'+esc(e.loc||'')+'</td>';
    html += '<td>'+esc(e.calle||'')+'</td>';
    html += '<td><span class="pill">'+esc(e.tipo||'-')+'</span></td>';
    html += '<td style="text-align:right">'+e0(e.precio)+'</td>';
    html += '<td style="text-align:right">'+e0(e.alq)+'</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_bruta))+' %</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_neta))+' %</td>';
    html += '<td style="text-align:right">'+e0(e.kpi_flujo)+'</td>';
    html += '<td style="text-align:right">'+e0(e.pmax)+'</td>';
    html += '<td style="text-align:center">'+(e.prospect_ids||[]).length+'</td>';
    html += '<td><div class="actions-cell">'+
      iconBtn('ver','Ver') + iconBtn('del','Borrar') +
    '</div></td>';
    tr.innerHTML = html;
    tb.appendChild(tr);
  });
}
function iconBtn(action,title){
  if(action==='ver'){
    return '<button class="iconbtn" title="'+title+'" data-act="ver" aria-label="'+title+'">'+
      '<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">'+
      '<path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z" stroke="#111827" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>'+
      '<circle cx="12" cy="12" r="3.2" stroke="#111827" stroke-width="1.6" /></svg></button>';
  }
  return '<button class="iconbtn" title="'+title+'" data-act="del" aria-label="'+title+'">'+
    '<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">'+
    '<path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 7l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12" stroke="#111827" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>'+
    '<path d="M10 10v7M14 10v7" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/></svg></button>';
}

/* Drawer */
function openDrawer(idEv){
  openId=idEv;
  var e=(Store.evals||[]).find(function(x){return x.id===idEv}); if(!e) return;

  id('d_fecha').textContent=new Date(e.ts || (e.id? e.id.slice(3): '')).toLocaleString('es-ES');
  renderProspects(e);

  fillKV('d_loc', e.loc);   fillKV('d_calle', e.calle);
  fillKV('d_m2', e.m2? e.m2+' m²':'—'); fillKV('d_anio', e.anio);
  fillKV('d_asc', e.asc);   fillKV('d_alt', e.alt);
  fillKV('d_bajo', e.bajo); fillKV('d_habs', e.habs);
  fillKV('d_banos', e.banos);
  fillKV('d_ref', refText(e.ref_tip));
  if(e.url){ id('d_url').innerHTML = '<a href="'+esc(e.url)+'" target="_blank" rel="noopener">Abrir anuncio</a>'; }
  else{ id('d_url').textContent='—'; }

  fillKV('d_precio', e0(e.precio)); fillKV('d_itp', e0(e.itp));
  fillKV('d_notaria', e0(e.notaria)); fillKV('d_psi', e0(e.psi));
  fillKV('d_reforma_eur', e0(e.reforma)); fillKV('d_inv', e0(e.inv_total));

  fillKV('d_comu', e0(e.comu)); fillKV('d_ibi', e0(e.ibi));
  fillKV('d_hogar', e0(e.hogar)); fillKV('d_impago', e0(e.impago));
  fillKV('d_gestion', e0(e.gestion));

  fillKV('d_tipo', e.tipo); fillKV('d_alq', e0(e.alq));
  fillKV('d_bruta', fmtN1.format(toPct(e.kpi_bruta))+' %');
  fillKV('d_neta', fmtN1.format(toPct(e.kpi_neta))+' %');
  fillKV('d_flujo', e0(e.kpi_flujo)); fillKV('d_pmax', e0(e.pmax));

  renderAttachments(e);

  id('uhOverlay').classList.add('open');
  id('uhDrawer').classList.add('open');

  id('d_guardar').onclick = function(){ saveAssignAndFiles(); };
  id('d_pdf').onclick = function(){ quickPDF(e.id); };
  id('d_editar').onclick = function(){ goEvaluar(e.id); };
  id('d_enviar').onclick = function(){ openSendModal(e); };
}
function refText(t){ if(!t) return '—'; if(t==='no') return 'No'; if(t==='lavado') return 'Lavado de cara'; if(t==='integral') return 'Reforma integral'; return t; }
function fillKV(el,val){ id(el).textContent = (val==null||val==='')? '—' : String(val); }
function closeDrawer(){
  id('uhOverlay').classList.remove('open');
  id('uhDrawer').classList.remove('open');
  openId=null;
}

/* Matching + avisos */
function fold(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
function isSearching(p){ return fold(p.fase).includes('busq'); }
function wantsNoReform(p){
  var s=fold(p.pref_reforma||p.reforma||p.no_reforma||'');
  return s==='no' || s.indexOf('sin')>-1 || s.indexOf('evitar')>-1;
}
function wantsElevator(p){
  var s=fold(p.quiere_ascensor||p.ascensor||p.requiere_ascensor||'');
  return s==='si' || s==='sí' || s==='true' || s==='1';
}
function wantsNoGround(p){
  var s=fold(p.no_bajo||p.evitar_bajos||p.pref_planta_alta||'');
  return s==='si' || s==='sí' || s.indexOf('evitar')>-1 || s.indexOf('alta')>-1;
}
function prospectBudget(p){
  var raw = p.presupuesto_max!=null?p.presupuesto_max:(p.presupuesto!=null?p.presupuesto:(p.budget_max!=null?p.budget_max:p.budget));
  return Number(String(raw==null?'':raw).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
}
function getTargetInfo(p){
  var kind=fold(p.obj_tipo||p.obj_main||'');
  var raw = Number(p.obj_raw || 0);
  var b   = Number(p.obj_bruta || 0);
  var n   = Number(p.obj_neta  || 0);
  var fm  = Number(p.obj_flujo || 0);
  var fa  = Number(p.obj_flujo_anual || 0);
  if(kind==='bruta' && raw>0) return {kind:'bruta',val:raw};
  if(kind==='neta'  && raw>0) return {kind:'neta', val:raw};
  if(kind==='flujo' && (raw>0||fm>0||fa>0)) return {kind:'flujo', val: fa>0?fa:(raw>0?raw*12:fm*12)};
  if(b>0) return {kind:'bruta',val:b};
  if(n>0) return {kind:'neta', val:n};
  if(fa>0||fm>0) return {kind:'flujo',val:(fa>0?fa:fm*12)};
  return {kind:'',val:0};
}
function matchEvalProspect(e,p){
  if(!isSearching(p)) return {ok:false,why:'fase'};
  if(fold(p.pref_tipo)!==fold(e.tipo)) return {ok:false,why:'tipo'};
  var locs=(p.locs_text||'').split(',').map(fold).filter(Boolean);
  if(locs.indexOf(fold(e.loc))===-1) return {ok:false,why:'localidad'};
  var tgt=getTargetInfo(p); if(!tgt.val) return {ok:false,why:'objetivo'};
  var br=Number(e.kpi_bruta||0), nt=Number(e.kpi_neta||0), fl=Number(e.kpi_flujo||0);
  if(tgt.kind==='bruta' && br>=tgt.val) return {ok:true,kind:'bruta'};
  if(tgt.kind==='neta'  && nt>=tgt.val) return {ok:true,kind:'neta'};
  if(tgt.kind==='flujo' && fl>=tgt.val) return {ok:true,kind:'flujo'};
  return {ok:false,why:'kpi'};
}
function warnBadges(e,p){
  var warns=[];
  var necesitaReforma = (e.ref_tip && e.ref_tip!=='no');
  var sinAscensor = String(e.asc||'Sí').toLowerCase()==='no';
  var esBajo = String(e.bajo||'No').toLowerCase()==='sí' || String(e.bajo||'No').toLowerCase()==='si';
  var budget = prospectBudget(p);
  if(necesitaReforma && wantsNoReform(p)){ warns.push('Requiere reforma y el prospect no quiere'); }
  if(sinAscensor && wantsElevator(p)){ warns.push('Sin ascensor y el prospect requiere ascensor'); }
  if(esBajo && wantsNoGround(p)){ warns.push('Bajo y el prospect evita bajos'); }
  if(budget>0 && Number(e.inv_total||0) > budget){ warns.push('Excede presupuesto'); }
  return warns;
}

/* Prospects drawer */
function renderProspects(e){
  var wrap=id('p_list'); wrap.innerHTML='';
  var pros=Store.pros||[];
  if(!pros.length){ wrap.textContent='No hay prospects guardados.'; id('matchInfo').textContent='—'; return; }

  var coinc=0;
  var setSel=new Set(e.prospect_ids||[]);
  var frag=document.createDocumentFragment();

  pros.forEach(function(p){
    var m=matchEvalProspect(e,p);
    var row=document.createElement('label');
    var cb=document.createElement('input'); cb.type='checkbox';
    var cbVal=p.id||p.email||p.nombre||('p_'+Math.random().toString(36).slice(2,7));
    cb.value=cbVal; cb.checked = setSel.has(cbVal);
    cb.dataset.email=p.email||''; cb.dataset.phone=p.phone||p.telefono||'';
    var content=document.createElement('div');
    var title=document.createElement('div');
    title.innerHTML='<strong>'+esc(p.nombre||'—')+'</strong>';
    var tags=document.createElement('div'); tags.className='p-tags';

    if(m.ok){ coinc++; tags.appendChild(badge('Coincide por ', m.kind, true)); }
    else { tags.appendChild(badge('No coincide', (m.why||'').toString(), false)); }

    var warns=warnBadges(e,p);
    warns.forEach(function(w){ tags.appendChild(warnBadge(w)); });

    content.appendChild(title);
    content.appendChild(tags);

    row.appendChild(cb);
    row.appendChild(content);
    frag.appendChild(row);
  });

  wrap.appendChild(frag);
  id('matchInfo').textContent = coinc+' coincidencias de '+pros.length;
}
function badge(text, kind, ok){
  var el=document.createElement('span'); el.className='badge '+(ok?'ok':'');
  var k=kind==='bruta'?'bruta':kind==='neta'?'neta':kind==='flujo'?'flujo':kind;
  el.innerHTML = (ok?'<small>✓</small> ':'')+ esc(text)+(ok?('<strong>'+k+'</strong>') : ' ('+esc(k)+')');
  return el;
}
function warnBadge(text){
  var el=document.createElement('span'); el.className='badge warn';
  el.innerHTML = '<small>!</small> '+esc(text);
  return el;
}

/* Adjuntos */
var MAX_VIDEO_BYTES = 2*1024*1024;
function renderAttachments(e){
  e.files = e.files || {images:[],videos:[],pdfs:[]};
  var gI=id('grid_imgs'), gV=id('grid_vids'), gP=id('grid_pdfs');
  gI.innerHTML=''; gV.innerHTML=''; gP.innerHTML='';

  e.files.images.forEach(function(f,idx){ gI.appendChild(thumbImg(f, function(){ e.files.images.splice(idx,1); renderAttachments(e);})); });
  e.files.videos.forEach(function(f,idx){ gV.appendChild(thumbVideo(f, function(){ e.files.videos.splice(idx,1); renderAttachments(e);})); });
  e.files.pdfs.forEach(function(f,idx){ gP.appendChild(thumbPdf(f, function(){ e.files.pdfs.splice(idx,1); renderAttachments(e);})); });

  id('up_imgs').onchange = function(ev){ handleFiles(ev.target.files, 'images'); ev.target.value=''; };
  id('up_vids').onchange = function(ev){ handleFiles(ev.target.files, 'videos'); ev.target.value=''; };
  id('up_pdfs').onchange = function(ev){ handleFiles(ev.target.files, 'pdfs'); ev.target.value=''; };

  function handleFiles(fileList, kind){
    var arr = Array.prototype.slice.call(fileList||[]);
    if(!arr.length) return;
    arr.forEach(function(file){
      if(kind==='videos' && file.size>MAX_VIDEO_BYTES){ toast('Vídeo "'+file.name+'" supera 2 MB','warn'); return; }
      var r=new FileReader();
      r.onload = function(){
        var rec={name:file.name,size:file.size,type:file.type,data:r.result};
        if(kind==='images') e.files.images.push(rec);
        if(kind==='videos') e.files.videos.push(rec);
        if(kind==='pdfs')   e.files.pdfs.push(rec);
        renderAttachments(e);
      };
      r.readAsDataURL(file);
    });
  }
  function thumbImg(f, onX){var d=document.createElement('div'); d.className='thumb'; var img=new Image(); img.src=f.data; d.appendChild(img); d.appendChild(xBtn(onX)); return d;}
  function thumbVideo(f, onX){var d=document.createElement('div'); d.className='thumb'; var inner=document.createElement('div'); inner.className='mini'; inner.innerHTML='▶<br>'+esc(trimName(f.name)); d.appendChild(inner); d.appendChild(xBtn(onX)); return d;}
  function thumbPdf(f, onX){var d=document.createElement('div'); d.className='thumb'; var inner=document.createElement('div'); inner.className='mini'; inner.innerHTML='PDF<br>'+esc(trimName(f.name)); d.appendChild(inner); d.appendChild(xBtn(onX)); return d;}
  function xBtn(onX){var b=document.createElement('div'); b.className='x'; b.title='Quitar'; b.innerHTML='×'; b.onclick=onX; return b;}
  function trimName(n){ n=String(n||''); return n.length>14? n.slice(0,12)+'…': n; }
}

/* Guardar asignación */
function saveAssignAndFiles(){
  if(!openId) return;
  var list=Store.evals||[];
  var idx=list.findIndex(function(x){return x.id===openId}); if(idx<0) return;

  var choices=[].slice.call(id('p_list').querySelectorAll('input[type=checkbox]'));
  list[idx].prospect_ids = choices.filter(function(c){return c.checked}).map(function(c){return c.value});

  Store.evals=list;
  toast('Asignación y adjuntos guardados','ok');
  load();
}

/* PDF rápido */
function quickPDF(idEv){
  var e=(Store.evals||[]).find(function(x){return x.id===idEv}); if(!e){toast('No encontrado','bad');return;}
  var fecha=new Date(e.ts || (e.id? e.id.slice(3): '')).toLocaleString('es-ES');
  var brand = (Store.cfg||{}).brand_name || 'Unihouser';
  var css=[
    'body{font-family:Inter,Arial;color:#101828;margin:24px}',
    '.brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}',
    '.brand .ttl{font-weight:800;font-size:22px}',
    '.bar{height:4px;background:'+getComputedStyle(document.documentElement).getPropertyValue('--brand')+';margin:8px 0 14px;border-radius:4px}',
    '.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}',
    '.box{border:1px solid #e5e7eb;border-radius:10px;padding:10px}',
    '.lab{font-size:12px;color:#667085}.val{font-weight:800}',
    'h2{font-size:16px;margin:16px 0 8px}',
    '.foot{margin-top:16px;font-size:12px;color:#667085;text-align:center}'
  ].join('');
  function kv(l,v){ return '<div class="box"><div class="lab">'+esc(l)+'</div><div class="val">'+esc(v)+'</div></div>'; }
  var html =
'<!DOCTYPE html><html><head><meta charset="utf-8"><title>'+esc(brand)+' — Informe</title>'+
'<style>'+css+'</style></head><body>'+
'<div class="brand"><div class="ttl">'+esc(brand)+' — Informe BuyBox</div></div>'+
'<div class="lab">'+fecha+'</div><div class="bar"></div>'+
'<h2>Resumen financiero</h2><div class="grid">'+
  kv('Bruta', fmtN1.format(toPct(e.kpi_bruta))+' %')+
  kv('Neta',  fmtN1.format(toPct(e.kpi_neta))+' %')+
  kv('Flujo anual', fmtE0.format(parseNum(e.kpi_flujo)))+
  kv('Precio máx compra', fmtE0.format(e.pmax||0))+
'</div>'+
'<h2>Datos del inmueble</h2><div class="grid">'+
  kv('Localidad', e.loc||'-')+ kv('Calle', e.calle||'-')+
  kv('Tipo', e.tipo||'-')+ kv('Alquiler (mes)', fmtE0.format(e.alq||0))+
  kv('Precio', fmtE0.format(e.precio||0))+ kv('Inversión total', fmtE0.format(e.inv_total||0))+
'</div>'+
'<div class="foot">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div>'+
'</body></html>';
  var w=window.open('','_blank'); if(!w){toast('Popup bloqueado','warn');return;}
  w.document.open(); w.document.write(html); w.document.close();
}

/* ===== Mensajería ===== */
function getCfg(){
  var c=Store.cfg||{}; 
  var brand=(c.brand_name||'Unihouser');
  var notifs=c.notifs||{};
  return {
    brand: brand,
    notifs:{
      /* 👇 Arreglo del bug: faltaban backticks */
      email_subject_tpl: notifs.email_subject_tpl || (${brand} · {loc} · {calle}),
      email_body_tpl: notifs.email_body_tpl || 
`Hola {name},

Te comparto una oportunidad en {loc} · {calle} ({tipo}).
• Precio: {precio} · Inversión: {inv}
• Bruta: {rb}% · Neta: {rn}% · Flujo anual: {fl}
• P. máx orientativo: {pmax}
{url}

Un saludo,
${brand}`,
      wa_text_tpl: notifs.wa_text_tpl || 
`Hola {name}, te comparto oportunidad: {loc} · {calle} ({tipo})
Precio {precio} | Inv {inv}
Bruta {rb}% · Neta {rn}% · Flujo {fl}
Pmax {pmax}
{url}`
    }
  };
}
function fillTpl(tpl, e, person){
  var rb = (Math.round(Number(e.kpi_bruta||0)*10)/10).toFixed(1).replace('.',',');
  var rn = (Math.round(Number(e.kpi_neta ||0)*10)/10).toFixed(1).replace('.',',');
  var out = tpl
    .replace(/\{brand\}/g, getCfg().brand)
    .replace(/\{name\}/g, (person && (person.nombre||person.name)) || '')
    .replace(/\{loc\}/g, e.loc||'')
    .replace(/\{calle\}/g, e.calle||'')
    .replace(/\{tipo\}/g, e.tipo||'')
    .replace(/\{precio\}/g, e0(e.precio||0))
    .replace(/\{inv\}/g, e0(e.inv_total||0))
    .replace(/\{rb\}/g, rb)
    .replace(/\{rn\}/g, rn)
    .replace(/\{fl\}/g, e0(e.kpi_flujo||0))
    .replace(/\{pmax\}/g, e0(e.pmax||0))
    .replace(/\{url\}/g, e.url||'');
  /* limpieza simple si no hay nombre */
  out = out.replace(/Hola\s*,/g,'Hola').replace(/\s{2,}/g,' ');
  return out;
}
function openSendModal(e){
  var back=id('sendBack'), box=id('sendToBox'); back.style.display='flex';
  var cfg=getCfg();

  // prospects marcados en el drawer
  box.innerHTML='';
  var checks=[].slice.call(id('p_list').querySelectorAll('input[type=checkbox]'));
  var targets = checks.filter(function(c){return c.checked}).map(function(c){
    var parent=c.parentElement; var strong=parent?parent.querySelector('strong'):null;
    return { name:(strong&&strong.textContent)||'-', email:c.dataset.email||'', phone:c.dataset.phone||'' };
  });
  if(!targets.length) box.textContent='Marca al menos un prospect arriba para proponerles este activo.';

  var rows=[];
  targets.forEach(function(t){
    var row=document.createElement('div'); row.className='area';
    row.innerHTML='<div><strong>'+esc(t.name)+'</strong></div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px">'+
      '<input value="'+esc(t.email)+'" placeholder="email">'+
      '<input value="'+esc(t.phone)+'" placeholder="móvil">'+
      '</div>';
    box.appendChild(row); rows.push(row);
  });

  var subjectEl=id('sendSubject'), bodyEl=id('sendBody');
  subjectEl.value = fillTpl(cfg.notifs.email_subject_tpl, e, targets[0]||{});
  bodyEl.value    = fillTpl(cfg.notifs.email_body_tpl, e, targets[0]||{});

  id('sendChannel').onchange=function(){
    if(this.value==='email'){
      subjectEl.disabled=false;
      subjectEl.value = fillTpl(cfg.notifs.email_subject_tpl, e, targets[0]||{});
      bodyEl.value    = fillTpl(cfg.notifs.email_body_tpl, e, targets[0]||{});
    }else{
      subjectEl.disabled=true; subjectEl.value='WhatsApp';
      bodyEl.value    = fillTpl(cfg.notifs.wa_text_tpl, e, targets[0]||{});
    }
  };

  id('sendCopy').onclick=function(){
    navigator.clipboard.writeText(subjectEl.value+'\n\n'+bodyEl.value).then(function(){toast('Copiado','ok')});
  };
  id('sendOpenMail').onclick=function(){
    var emails=[].slice.call(box.querySelectorAll('input[placeholder="email"]')).map(function(i){return i.value.trim()}).filter(function(v){return v.indexOf('@')>-1});
    var mailto='mailto:'+encodeURIComponent(emails.join(','))+'?subject='+encodeURIComponent(subjectEl.value)+'&body='+encodeURIComponent(bodyEl.value);
    window.open(mailto,'_blank');
  };
  id('sendOpenWA').onclick=function(){
    var phone= (box.querySelector('input[placeholder="móvil"]')?box.querySelector('input[placeholder="móvil"]').value:'').replace(/[^\d]/g,'');
    var url='https://wa.me/'+(phone||'')+'?text='+encodeURIComponent(bodyEl.value);
    window.open(url,'_blank');
  };
  id('sendClose').onclick=function(){ back.style.display='none'; };
}

/* Export CSV */
function toCSV(rows){
  var headers=["Id","Fecha","Localidad","Calle","Tipo","Precio","ITP","Notaría","PSI","Reforma","Comunidad","IBI","Hogar","Impago","Gestión","Alquiler","Bruta%","Neta%","Flujo","Pmax","InvTotal","Asignados","URL"];
  var lines=[headers.join(';')];
  rows.forEach(function(e){
    var f=new Date(e.ts || (e.id? e.id.slice(3): '')).toLocaleDateString('es-ES');
    lines.push([
      e.id, f, safe(e.loc), safe(e.calle), safe(e.tipo),
      n(e.precio), n(e.itp), n(e.notaria), n(e.psi), n(e.reforma),
      n(e.comu), n(e.ibi), n(e.hogar), n(e.impago), n(e.gestion),
      n(e.alq), p(toPct(e.kpi_bruta)), p(toPct(e.kpi_neta)), n(e.kpi_flujo),
      n(e.pmax), n(e.inv_total), (e.prospect_ids||[]).length, safe(e.url)
    ].join(';'));
  });
  return lines.join('\n');
}
var n=function(v){return fmtN0.format(Number(parseNum(v)||v||0))};
var p=function(v){return fmtN1.format(Number(v||0))};
function safe(s){s=(s==null?'':String(s)); return s.replace(/;/g,',');}

function download(name,content){
  var blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
  document.body.appendChild(a); a.click();
  setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},0);
}

/* Eventos tabla/UI */
function onTableClick(ev){
  var btn=ev.target.closest? ev.target.closest('button[data-act]') : null;
  var tr=ev.target.closest? ev.target.closest('tr') : null;
  if(!tr) return; var idEv=tr.dataset.id;
  if(btn){
    var act=btn.dataset.act;
    if(act==='ver') openDrawer(idEv);
    if(act==='del'){ if(confirm('¿Borrar esta evaluación?')){ Store.evals=(Store.evals||[]).filter(function(x){return x.id!==idEv}); load(); } }
  }else{
    openDrawer(idEv);
  }
}
function bindSort(){
  var ths=document.querySelectorAll('#tbl th[data-k]');
  [].forEach.call(ths,function(th){
    th.addEventListener('click',function(){
      var k=th.dataset.k; if(sortKey===k) sortAsc=!sortAsc; else{sortKey=k; sortAsc=true;}
      sort(); render();
    });
  });
}

/* Abrir en Evaluar */
function goEvaluar(idEv){
  localStorage.setItem('load_eval', idEv);
  location.href = 'evaluar.html';
}

/* Attach */
function attach(){
  id('b_filtrar').addEventListener('click',applyFilters);
  id('b_limpiar').addEventListener('click',function(){
    id('f_text').value=''; id('f_tipo').value=''; id('f_desde').value=''; id('f_hasta').value=''; applyFilters();
  });
  id('b_export').addEventListener('click',function(){
    if(!view.length){toast('Nada que exportar','warn');return;}
    download('evaluaciones.csv',toCSV(view));
  });
  id('tbody').addEventListener('click',onTableClick);
  id('d_cerrar').addEventListener('click',closeDrawer);
  id('uhOverlay').addEventListener('click',closeDrawer);
  bindSort(); load();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>
</body>
</html>
