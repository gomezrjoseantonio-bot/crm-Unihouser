<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluaciones</title>
<link rel="stylesheet" href="css/style.css">
<style>
:root{
  --dark:#0f172a;
  --ink:#111827;
  --muted:#667085;
  --line:#e5e7eb;
  --line2:#eef2f7;
  --bg:#ffffff;

  /* Colores logo Unihouser (aprox) */
  --u-orange:#e07a2c;
  --u-teal:#3a6d6a;
  --u-brick:#b5483a;
  --u-accent:#ff5a1f; /* para acentos UI */
}

/* Overlay + Drawer */
body.uh-noscroll{overflow:hidden}
.uh-overlay{position:fixed;inset:0;background:rgba(15,18,20,.28);backdrop-filter:blur(2px);display:none;z-index:80}
.uh-overlay.open{display:block}
.uh-drawer{position:fixed;top:0;right:-560px;height:100%;width:560px;max-width:100%;background:#fff;border-left:1px solid var(--line);box-shadow:0 10px 24px rgba(0,0,0,.25);transition:right .2s ease;z-index:90}
.uh-drawer.open{right:0}
.uh-d-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line2);background:var(--dark);color:#fff}
.uh-d-body{padding:12px 12px 18px;overflow:auto;height:calc(100% - 52px)}
.uh-meta{font-size:12px;color:var(--muted);margin:6px 0 10px}

/* KPIs */
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpi .lab{font-size:12px;color:var(--muted)} .kpi .val{font-weight:800;font-size:20px}
.kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}

/* Tabla */
table.table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line2);text-align:left;font-size:14px;white-space:nowrap}
.table th{background:#f8fafc;color:var(--ink);cursor:pointer}
.table tr:last-child td{border-bottom:none}
.table tr{cursor:pointer}
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;font-size:12px}

/* Acciones + iconos */
.actions-cell{display:flex;gap:6px;align-items:center}
.iconbtn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.iconbtn:hover{background:#f8fafc}
.icon{width:18px;height:18px;display:block;stroke:#334155;stroke-width:1.75;fill:none}

/* Drawer detail list */
.hgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:4px 10px;padding:8px;border:1px solid var(--line2);border-radius:10px;background:#fff}
.kv .k{color:var(--muted);font-size:11px}
.kv .v{font-weight:700}

/* Asignación */
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line2);border-radius:999px;padding:4px 8px;background:#fff;font-size:12px}
.badge .dot{width:8px;height:8px;border-radius:50%}
.dot.ok{background:#16a34a}.dot.warn{background:#f59e0b}.dot.bad{background:#ef4444}
.uh-list-pros{display:grid;gap:6px;margin-top:8px}
.uh-list-pros label{display:flex;gap:8px;align-items:center;padding:6px 8px;border:1px solid var(--line2);border-radius:10px;background:#fff}
.uh-list-pros input{width:16px;height:16px}

/* Adjuntos: miniaturas MUY compactas */
.attach-wrap{border:1px dashed var(--line);border-radius:10px;padding:8px;background:#fff}
.thumbs{display:grid;gap:6px;grid-template-columns:repeat(6,1fr)} /* 6 por fila en 560px caben bien */
.thumb{position:relative;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:#f8fafc}
.thumb img{display:block;width:100%;height:52px;object-fit:cover}
.thumb video{width:100%;height:52px;object-fit:cover;background:#000}
.thumb .tcap{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.45);color:#fff;font-size:10px;padding:2px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.thumb .x{position:absolute;top:4px;right:4px;background:#fff;border:1px solid var(--line);border-radius:50%;width:16px;height:16px;font-size:11px;line-height:14px;text-align:center;cursor:pointer}

/* Filtros */
.filters .row{display:grid;gap:10px;grid-template-columns:2fr 1fr 1fr 1fr auto auto auto}
@media(max-width:1100px){.filters .row{grid-template-columns:1fr 1fr}}

/* Toasts */
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}

/* Separadores de bloque del panel */
.block-title{margin:10px 0 6px;font-weight:800}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html" class="active">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Evaluaciones</h2>

    <div class="kpis" style="margin-top:6px">
      <div class="kpi"><div class="lab">Total evaluaciones</div><div class="val" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">Asignadas</div><div class="val" id="k_asig">0</div></div>
      <div class="kpi"><div class="lab">Bruta media</div><div class="val" id="k_bruta">0,0 %</div></div>
      <div class="kpi"><div class="lab">Neta media</div><div class="val" id="k_neta">0,0 %</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Filtros</h3>
      <div class="filters">
        <div class="row">
          <div class="field"><label>Buscar</label><input id="f_text" placeholder="Localidad o calle"></div>
          <div class="field"><label>Tipo</label>
            <select id="f_tipo"><option value="">Todos</option><option>Tradicional</option><option>Habitaciones</option></select>
          </div>
          <div class="field"><label>Desde</label><input id="f_desde" type="date"></div>
          <div class="field"><label>Hasta</label><input id="f_hasta" type="date"></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_limpiar">Limpiar</button></div>
          <div class="field" style="align-self:end"><button class="btn primary" id="b_filtrar">Filtrar</button></div>
          <div class="field" style="align-self:end"><button class="btn" id="b_export">Exportar CSV</button></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th data-k="ts">Fecha</th>
            <th data-k="loc">Localidad</th>
            <th data-k="calle">Calle</th>
            <th data-k="tipo">Tipo</th>
            <th data-k="precio" style="text-align:right">Precio</th>
            <th data-k="alq" style="text-align:right">Alquiler</th>
            <th data-k="kpi_bruta" style="text-align:right">Bruta %</th>
            <th data-k="kpi_neta" style="text-align:right">Neta %</th>
            <th data-k="kpi_flujo" style="text-align:right">Flujo</th>
            <th data-k="pmax" style="text-align:right">P. máx</th>
            <th data-k="asig" style="text-align:center">Asignados</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<div id="uhOverlay" class="uh-overlay"></div>
<aside id="uhDrawer" class="uh-drawer" aria-hidden="true">
  <div class="uh-d-head">
    <strong>Detalle de evaluación</strong>
    <button class="btn" id="d_cerrar">Cerrar</button>
  </div>
  <div class="uh-d-body">
    <div class="uh-meta" id="d_fecha">—</div>

    <!-- Resumen compacto -->
    <div class="hgrid">
      <div class="kv"><div class="k">Localidad</div><div class="v" id="d_loc">—</div></div>
      <div class="kv"><div class="k">Calle</div><div class="v" id="d_calle">—</div></div>
      <div class="kv"><div class="k">Tipo</div><div class="v" id="d_tipo">—</div></div>
      <div class="kv"><div class="k">URL</div><div class="v" id="d_url">—</div></div>
      <div class="kv"><div class="k">Precio</div><div class="v" id="d_precio">—</div></div>
      <div class="kv"><div class="k">Alquiler mensual</div><div class="v" id="d_alq">—</div></div>
      <div class="kv"><div class="k">Bruta</div><div class="v" id="d_bruta">—</div></div>
      <div class="kv"><div class="k">Neta</div><div class="v" id="d_neta">—</div></div>
      <div class="kv"><div class="k">Flujo anual</div><div class="v" id="d_flujo">—</div></div>
      <div class="kv"><div class="k">P. máx compra</div><div class="v" id="d_pmax">—</div></div>
      <div class="kv"><div class="k">Inversión total</div><div class="v" id="d_inv">—</div></div>
    </div>

    <!-- Asignación -->
    <h3 class="block-title">Asignar a prospects</h3>
    <div class="small" id="d_matches">0 coincidencias</div>
    <div id="p_list" class="uh-list-pros">—</div>

    <!-- Adjuntos -->
    <h3 class="block-title" style="margin-top:10px">Adjuntar archivos</h3>
    <div class="attach-wrap">
      <div class="small" style="margin-bottom:6px">Imágenes</div>
      <input id="up_img" type="file" accept="image/*" multiple>
      <div id="imgs" class="thumbs" style="margin-top:6px"></div>

      <div class="small" style="margin:10px 0 6px">Vídeos <span class="small">(máx 2 MB c/u)</span></div>
      <input id="up_vid" type="file" accept="video/*" multiple>
      <div id="vids" class="thumbs" style="margin-top:6px"></div>

      <div class="small" style="margin:10px 0 6px">PDFs</div>
      <input id="up_pdf" type="file" accept="application/pdf" multiple>
      <div id="pdfs" class="thumbs" style="margin-top:6px"></div>
    </div>

    <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button class="btn primary" id="d_guardar">Guardar asignación y adjuntos</button>
      <button class="btn" id="d_pdf">PDF</button>
      <button class="btn" id="d_editar">Abrir en Evaluar</button>
    </div>
  </div>
</aside>

<div id="toasts" class="toast-wrap"></div>

<!-- pdf-lib para fusionar PDFs -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
const parseNum = v=>Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
function toast(msg,kind){
  const wrap=id('toasts'); if(!wrap) return;
  const el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(()=>el.style.opacity='0',1600);
  setTimeout(()=>{try{wrap.removeChild(el)}catch(_){}} ,2200);
}
function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function toPct(raw){ let v=Number(raw||0); if(v>0&&v<=1)v*=100; while(v>=100)v/=10; return v; }
const avg = arr => arr.length? arr.reduce((a,b)=>a+Number(b||0),0)/arr.length : 0;

/* ===== Store ===== */
const Store={
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))}
};

/* ===== Estado ===== */
let data=[], view=[], sortKey='ts', sortAsc=true, openId=null;

/* ===== Carga y KPIs ===== */
function load(){
  data=(Store.evals||[]).map(e=>({...e, asig:(e.prospect_ids||[]).length}));
  applyFilters();
  kpis();
}
function kpis(){
  id('k_total').textContent = data.length;
  id('k_asig').textContent  = data.reduce((a,b)=>a+(b.asig||0),0);
  id('k_bruta').textContent = fmtN1.format(avg(data.map(x=>toPct(x.kpi_bruta))))+' %';
  id('k_neta').textContent  = fmtN1.format(avg(data.map(x=>toPct(x.kpi_neta))))+' %';
}

/* ===== Filtros/orden ===== */
function applyFilters(){
  const q=(id('f_text').value||'').toLowerCase().trim();
  const t=id('f_tipo').value||'';
  const d=id('f_desde').value? new Date(id('f_desde').value+'T00:00:00Z').getTime():0;
  const h=id('f_hasta').value? new Date(id('f_hasta').value+'T23:59:59Z').getTime():Infinity;
  view=data.filter(e=>{
    const ts=new Date(e.ts||e.id?.slice(3)).getTime();
    const txt=((e.loc||'')+' '+(e.calle||'')).toLowerCase();
    return (!q || txt.includes(q)) && (!t || e.tipo===t) && ts>=d && ts<=h;
  });
  sort(); render();
}
function sort(){
  view.sort((a,b)=>{
    const va=get(a,sortKey), vb=get(b,sortKey);
    return (va<vb? -1: va>vb? 1: 0) * (sortAsc?1:-1);
  });
}
function get(o,k){
  if(k==='ts') return new Date(o.ts||o.id?.slice(3)).getTime();
  if(k==='asig') return (o.prospect_ids||[]).length;
  if(k==='kpi_bruta') return toPct(o.kpi_bruta);
  if(k==='kpi_neta') return toPct(o.kpi_neta);
  if(k==='kpi_flujo') return Number(parseNum(o.kpi_flujo));
  if(k==='pmax') return Number(o.pmax||0);
  if(k==='precio') return Number(o.precio||0);
  if(k==='alq') return Number(o.alq||0);
  if(k==='calle') return (o.calle||'').toLowerCase();
  return (o[k]||'').toString().toLowerCase();
}

/* ===== Render tabla ===== */
function render(){
  const tb=id('tbody'); tb.innerHTML='';
  view.forEach(e=>{
    const tr=document.createElement('tr'); tr.dataset.id=e.id;
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    let html='';
    html += '<td>'+f+'</td>';
    html += '<td>'+esc(e.loc||'')+'</td>';
    html += '<td>'+esc(e.calle||'')+'</td>';
    html += '<td><span class="pill">'+esc(e.tipo||'-')+'</span></td>';
    html += '<td style="text-align:right">'+e0(e.precio)+'</td>';
    html += '<td style="text-align:right">'+e0(e.alq)+'</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_bruta))+' %</td>';
    html += '<td style="text-align:right">'+fmtN1.format(toPct(e.kpi_neta))+' %</td>';
    html += '<td style="text-align:right">'+e0(e.kpi_flujo)+'</td>';
    html += '<td style="text-align:right">'+e0(e.pmax)+'</td>';
    html += '<td style="text-align:center">'+(e.prospect_ids||[]).length+'</td>';
    html += '<td><div class="actions-cell">';
    html += '<button class="iconbtn" title="Ver" data-act="ver" aria-label="Ver">'+
              '<svg class="icon" viewBox="0 0 24 24"><path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z"/><circle cx="12" cy="12" r="3"/></svg>'+
            '</button>';
    html += '<button class="iconbtn" title="Borrar" data-act="del" aria-label="Borrar">'+
              '<svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M7 6l1 13a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-13"/></svg>'+
            '</button>';
    html += '</div></td>';
    tr.innerHTML = html;
    tb.appendChild(tr);
  });
}

/* ===== Drawer ===== */
function openDrawer(idEv){
  openId=idEv;
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;

  id('d_fecha').textContent=new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES');
  id('d_loc').textContent =e.loc||'—';
  id('d_calle').textContent=e.calle||'—';
  id('d_tipo').textContent =e.tipo||'—';
  id('d_precio').textContent=e0(e.precio);
  id('d_alq').textContent =e0(e.alq);
  id('d_bruta').textContent =fmtN1.format(toPct(e.kpi_bruta))+' %';
  id('d_neta').textContent =fmtN1.format(toPct(e.kpi_neta))+' %';
  id('d_flujo').textContent =e0(e.kpi_flujo);
  id('d_pmax').textContent =e0(e.pmax);
  id('d_inv').textContent =e0(e.inv_total);
  if(e.url){ id('d_url').innerHTML = '<a href="'+esc(e.url)+'" target="_blank" rel="noopener">Abrir anuncio</a>'; }
  else{ id('d_url').textContent = '—'; }

  // Asignación + coincidencias
  renderProspectsList(e);

  // Adjuntos
  renderAttachments(e);

  id('uhOverlay').classList.add('open');
  id('uhDrawer').classList.add('open');
  document.body.classList.add('uh-noscroll');

  id('d_guardar').onclick = saveAssignAndFiles;
  id('d_pdf').onclick = function(){ exportPDF(e.id); };
  id('d_editar').onclick = function(){ goEvaluar(e.id); };
}
function closeDrawer(){
  id('uhOverlay').classList.remove('open');
  id('uhDrawer').classList.remove('open');
  document.body.classList.remove('uh-noscroll');
  openId=null;
}

/* ==== Coincidencias ==== */
function fold(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
function isSearching(p){ const f=fold(p.fase); return f.includes('busq'); }
function targetInfo(p){
  const kind=(p.obj_tipo||p.obj_main||'').toLowerCase().trim();
  const raw=Number(p.obj_raw||0);
  const b=Number(p.obj_bruta||0), n=Number(p.obj_neta||0);
  const fM=Number(p.obj_flujo||0), fA=Number(p.obj_flujo_anual||0);
  if(kind==='bruta' && raw>0) return {k:'b',v:raw};
  if(kind==='neta' && raw>0)  return {k:'n',v:raw};
  if(kind==='flujo' && (raw||fM||fA)) return {k:'f',v: fA?fA:(raw?raw*12:fM*12)};
  if(b>0) return {k:'b',v:b}; if(n>0) return {k:'n',v:n};
  if(fA||fM) return {k:'f',v: fA?fA:fM*12};
  return {k:'',v:0};
}
function renderProspectsList(e){
  const pros=Store.pros||[];
  const wrap=id('p_list'); wrap.innerHTML='';
  if(!pros.length){ wrap.textContent='No hay prospects guardados.'; id('d_matches').textContent='0 coincidencias'; return; }

  const set=new Set(e.prospect_ids||[]);
  const wantTipo=fold(e.tipo), wantLoc=fold(e.loc);
  let matches=0;

  pros.forEach(p=>{
    const okFase=isSearching(p);
    const okTipo=fold(p.pref_tipo)===wantTipo;
    const okLoc =(p.locs_text||'').split(',').map(fold).includes(wantLoc);
    const tgt=targetInfo(p);
    let kpiOK=false;
    if(tgt.k==='b') kpiOK = Number(toPct(e.kpi_bruta))>=tgt.v;
    else if(tgt.k==='n') kpiOK = Number(toPct(e.kpi_neta))>=tgt.v;
    else if(tgt.k==='f') kpiOK = Number(e.kpi_flujo)>=tgt.v;

    const isMatch = okFase && okTipo && okLoc && kpiOK;
    if(isMatch) matches++;

    const row=document.createElement('label');
    const cb=document.createElement('input'); cb.type='checkbox';
    cb.value=p.id||p.email||p.nombre; cb.checked=set.has(cb.value);
    const sp=document.createElement('span');
    sp.textContent=(p.nombre||'—')+' · '+(p.pref_tipo||'-')+' · '+(p.locs_text||'');
    const b=document.createElement('span'); b.className='badge';
    b.innerHTML='<span class="dot '+(isMatch?'ok':'bad')+'"></span>'+(isMatch?'Coincide':'No coincide');
    row.appendChild(cb); row.appendChild(sp); row.appendChild(b);
    wrap.appendChild(row);
  });

  id('d_matches').textContent = matches+' coincidencias de '+pros.length;
}

/* ==== Adjuntos en evaluación ==== */
function ensureAttachFields(e){
  e.attach = e.attach || { imgs:[], vids:[], pdfs:[] }; // cada item: {name, dataURL o url, size}
  return e;
}
function renderAttachments(e){
  e=ensureAttachFields(e);
  const imgs=id('imgs'), vids=id('vids'), pdfs=id('pdfs');
  imgs.innerHTML=vids.innerHTML=pdfs.innerHTML='';

  e.attach.imgs.forEach((it,i)=>{
    const d=document.createElement('div'); d.className='thumb';
    d.innerHTML='<img src="'+it.data+'"><div class="tcap">'+esc(it.name||'img')+'</div><div class="x" data-kind="img" data-idx="'+i+'">×</div>';
    imgs.appendChild(d);
  });
  e.attach.vids.forEach((it,i)=>{
    const d=document.createElement('div'); d.className='thumb';
    const vid=document.createElement('video'); vid.src=it.data; vid.muted=true; vid.playsInline=true;
    d.appendChild(vid);
    const cap=document.createElement('div'); cap.className='tcap'; cap.textContent=it.name||'video';
    const x=document.createElement('div'); x.className='x'; x.dataset.kind='vid'; x.dataset.idx=i; x.textContent='×';
    d.appendChild(cap); d.appendChild(x);
    vids.appendChild(d);
  });
  e.attach.pdfs.forEach((it,i)=>{
    const d=document.createElement('div'); d.className='thumb';
    d.innerHTML='<img src="data:image/svg+xml;utf8,'+encodeURIComponent(pdfIcon())+'"><div class="tcap">'+esc(it.name||'pdf')+'</div><div class="x" data-kind="pdf" data-idx="'+i+'">×</div>';
    pdfs.appendChild(d);
  });

  // Borrar adjunto
  [imgs,vids,pdfs].forEach(container=>{
    container.onclick=function(ev){
      const x=ev.target.closest('.x'); if(!x||!openId) return;
      const kind=x.dataset.kind, idx=Number(x.dataset.idx);
      const list=Store.evals||[]; const i=list.findIndex(r=>r.id===openId); if(i<0) return;
      ensureAttachFields(list[i]);
      list[i].attach[kind+'s'].splice(idx,1);
      Store.evals=list;
      renderAttachments(list[i]);
    };
  });

  // Upload handlers
  id('up_img').onchange = async function(){
    if(!openId) return; const list=Store.evals||[]; const i=list.findIndex(r=>r.id===openId); if(i<0) return;
    ensureAttachFields(list[i]);
    const files=[...this.files];
    for(const f of files){
      const data = await fileToDataURL(f);
      list[i].attach.imgs.push({name:f.name,size:f.size,data});
    }
    Store.evals=list; renderAttachments(list[i]); this.value='';
  };
  id('up_vid').onchange = async function(){
    if(!openId) return; const list=Store.evals||[]; const i=list.findIndex(r=>r.id===openId); if(i<0) return;
    ensureAttachFields(list[i]);
    const files=[...this.files];
    for(const f of files){
      if(f.size>2_000_000){ toast('“'+f.name+'” supera 2 MB y no se adjunta','warn'); continue; }
      const data = await fileToDataURL(f);
      list[i].attach.vids.push({name:f.name,size:f.size,data});
    }
    Store.evals=list; renderAttachments(list[i]); this.value='';
  };
  id('up_pdf').onchange = async function(){
    if(!openId) return; const list=Store.evals||[]; const i=list.findIndex(r=>r.id===openId); if(i<0) return;
    ensureAttachFields(list[i]);
    const files=[...this.files];
    for(const f of files){
      const data = await fileToArrayBuffer(f); // guardamos como base64 para pdf-lib
      list[i].attach.pdfs.push({name:f.name,size:f.size,ab:arrayBufferToBase64(data)});
    }
    Store.evals=list; renderAttachments(list[i]); this.value='';
  };
}
function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }
function fileToArrayBuffer(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsArrayBuffer(file); }); }
function arrayBufferToBase64(ab){ let binary=''; const bytes=new Uint8Array(ab); const len=bytes.byteLength; for(let i=0;i<len;i++) binary+=String.fromCharCode(bytes[i]); return btoa(binary); }
function base64ToUint8(b64){ const binary=atob(b64); const len=binary.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i); return bytes; }
function pdfIcon(){
  return `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='60' viewBox='0 0 24 18'>
    <rect x='2' y='2' width='20' height='14' rx='2' fill='#fff' stroke='#cbd5e1'/>
    <rect x='2' y='2' width='20' height='4' fill='#e07a2c'/>
    <text x='12' y='13' font-family='Arial' font-size='6' text-anchor='middle' fill='#475569'>PDF</text>
  </svg>`;
}

/* Guardar asignación + adjuntos */
function saveAssignAndFiles(){
  if(!openId) return;
  const list=Store.evals||[]; const idx=list.findIndex(x=>x.id===openId); if(idx<0) return;
  const choices=[].slice.call(id('p_list').querySelectorAll('input[type=checkbox]'));
  list[idx].prospect_ids = choices.filter(c=>c.checked).map(c=>c.value);
  // adjuntos ya se van guardando on-change
  Store.evals=list;
  toast('Asignación y adjuntos guardados','ok');
  closeDrawer();
  load();
}

/* ===== PDF ===== */
async function exportPDF(idEv){
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e){toast('No encontrado','bad');return;}
  const wantMerge = confirm('¿Fusionar el informe con los PDFs adjuntos?');

  // 1) Informe de marca
  const brandBytes = await buildBrandPDF(e);

  if(!wantMerge || !(e.attach&&e.attach.pdfs&&e.attach.pdfs.length)){
    const blob=new Blob([brandBytes],{type:'application/pdf'});
    const url=URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url), 15000);
    return;
  }

  // 2) Fusionar con adjuntos (pdf-lib)
  try{
    const { PDFDocument } = window.PDFLib;
    const out = await PDFDocument.load(brandBytes);

    for(const pdf of e.attach.pdfs){
      const src = await PDFDocument.load(base64ToUint8(pdf.ab));
      const pages = await out.copyPages(src, src.getPageIndices());
      pages.forEach(p => out.addPage(p));
    }
    const merged = await out.save();
    const blob=new Blob([merged],{type:'application/pdf'});
    const url=URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url), 15000);
  }catch(err){
    console.error(err);
    toast('No se pudo fusionar. Abro el informe solo.','warn');
    const blob=new Blob([brandBytes],{type:'application/pdf'});
    const url=URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url), 15000);
  }
}

async function buildBrandPDF(e){
  const { PDFDocument, StandardFonts, rgb } = window.PDFLib;
  const doc = await PDFDocument.create();
  const page = doc.addPage([595, 842]); // A4
  const font = await doc.embedFont(StandardFonts.Helvetica);
  const bold = await doc.embedFont(StandardFonts.HelveticaBold);

  // Banda superior con los 3 colores del logo
  const w=595;
  page.drawRectangle({x:0,y:812,width:w/3,height:30,color:rgb(0.878,0.478,0.173)}); // orange
  page.drawRectangle({x:w/3,y:812,width:w/3,height:30,color:rgb(0.227,0.427,0.416)}); // teal
  page.drawRectangle({x:2*w/3,y:812,width:w/3,height:30,color:rgb(0.707,0.282,0.227)}); // brick

  // Título
  page.drawText('Unihouser — Informe de Evaluación', {x:40,y:780,size:18,font:bold,color:rgb(0.07,0.07,0.09)});
  page.drawText(new Date(e.ts||e.id?.slice(3)).toLocaleString('es-ES'), {x:40,y:760,size:10,font:font,color:rgb(0.4,0.42,0.47)});

  // Caja resumen
  const X=40, Y=720, W=515, H=110;
  page.drawRectangle({x:X,y:Y-H,width:W,height:H,borderColor:rgb(0.89,0.91,0.95),borderWidth:1,color:rgb(1,1,1)});
  const line=(t,v,yy)=>{ page.drawText(t,{x:X+12,y:yy,size:10,font:font,color:rgb(0.4,0.42,0.47)}); page.drawText(v,{x:X+180,y:yy,size:12,font:bold,color:rgb(0.08,0.09,0.1)}); };
  line('Localidad', String(e.loc||'-'), 702);
  line('Calle', String(e.calle||'-'), 686);
  line('Tipo', String(e.tipo||'-'), 670);
  line('URL', String(e.url||'-'), 654);

  // KPIs
  const kY=610;
  const k=(x,t,v)=>{ page.drawText(t,{x, y:kY, size:10, font:font, color:rgb(0.4,0.42,0.47)}); page.drawText(v,{x, y:kY-16, size:16, font:bold, color:rgb(0.08,0.09,0.1)}); };
  k(40,'Precio', e0(e.precio));
  k(180,'Alquiler (mes)', e0(e.alq));
  k(330,'Bruta', fmtN1.format(toPct(e.kpi_bruta))+' %');
  k(460,'Neta', fmtN1.format(toPct(e.kpi_neta))+' %');

  k(40,'Flujo anual', e0(e.kpi_flujo));
  k(180,'P. máx compra', e0(e.pmax));
  k(330,'Inversión total', e0(e.inv_total));

  // Pie
  page.drawText('© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200',{x:40,y:40,size:9,font:font,color:rgb(0.4,0.42,0.47)})

  return await doc.save();
}

/* ===== Export CSV ===== */
function toCSV(rows){
  const headers=["Id","Fecha","Localidad","Calle","Tipo","Precio","ITP","Notaría","PSI","Reforma","Comunidad","IBI","Hogar","Impago","Gestión","Alquiler","Bruta%","Neta%","Flujo","Pmax","InvTotal","Asignados","URL"];
  const lines=[headers.join(';')];
  rows.forEach(function(e){
    const f=new Date(e.ts||e.id?.slice(3)).toLocaleDateString('es-ES');
    lines.push([
      e.id, f, safe(e.loc), safe(e.calle), safe(e.tipo),
      n(e.precio), n(e.itp), n(e.notaria), n(e.psi), n(e.reforma),
      n(e.comu), n(e.ibi), n(e.hogar), n(e.impago), n(e.gestion),
      n(e.alq), p(toPct(e.kpi_bruta)), p(toPct(e.kpi_neta)), n(e.kpi_flujo),
      n(e.pmax), n(e.inv_total), (e.prospect_ids||[]).length, safe(e.url)
    ].join(';'));
  });
  return lines.join('\n');
}
const n=v=>fmtN0.format(Number(parseNum(v)||v||0));
const p=v=>fmtN1.format(Number(v||0));
const safe=s=>(s??'').toString().replace(/;/g,',');

function download(name,content){
  const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* ===== Eventos tabla/UI ===== */
function onTableClick(ev){
  const btn=ev.target.closest('button[data-act]'); const tr=ev.target.closest('tr');
  if(!tr) return; const idEv=tr.dataset.id;
  if(btn){
    const act=btn.dataset.act;
    if(act==='ver') openDrawer(idEv);
    if(act==='del'){ if(confirm('¿Borrar esta evaluación?')){ Store.evals=(Store.evals||[]).filter(x=>x.id!==idEv); load(); } }
  }else{
    openDrawer(idEv);
  }
}
function bindSort(){
  const ths=document.querySelectorAll('#tbl th[data-k]');
  ths.forEach(function(th){
    th.addEventListener('click',function(){
      const k=th.dataset.k; if(sortKey===k) sortAsc=!sortAsc; else{sortKey=k; sortAsc=true;}
      sort(); render();
    });
  });
}

/* ===== Abrir en Evaluar ===== */
function goEvaluar(idEv){
  localStorage.setItem('load_eval', idEv);
  location.href = 'evaluar.html';
}

/* ===== Attach ===== */
function attach(){
  id('b_filtrar').addEventListener('click',applyFilters);
  id('b_limpiar').addEventListener('click',function(){
    id('f_text').value=''; id('f_tipo').value=''; id('f_desde').value=''; id('f_hasta').value=''; applyFilters();
  });
  id('b_export').addEventListener('click',function(){
    if(!view.length){toast('Nada que exportar','warn');return;}
    download('evaluaciones.csv',toCSV(view));
  });
  id('tbody').addEventListener('click',onTableClick);
  id('d_cerrar').addEventListener('click',closeDrawer);
  id('uhOverlay').addEventListener('click',closeDrawer);
  bindSort(); load();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>
</body>
</html>
