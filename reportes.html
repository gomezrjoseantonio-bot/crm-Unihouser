<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FinanceManager â€” Reportes</title>
<link rel="stylesheet" href="css/style.css">
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#2E7D32; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}
.container{max-width:1200px;margin:12px auto;padding:0 14px}
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:var(--shadow);margin:16px 0}
.report-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:16px}
.stat-card{background:linear-gradient(135deg, var(--brand), var(--accent));color:white;border-radius:12px;padding:20px;text-align:center}
.stat-value{font-size:32px;font-weight:700;margin-bottom:8px}
.stat-label{font-size:14px;opacity:0.9}
.chart-placeholder{background:#f8f9fa;border:2px dashed #dee2e6;border-radius:8px;padding:40px;text-align:center;color:#666;margin:16px 0}
.btn{background:var(--brand);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:700;margin:4px}
.btn:hover{opacity:0.9}
.export-section{background:#f8f9fa;border-radius:8px;padding:16px;margin:16px 0}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo">â‚±</div><div class="title">FinanceManager â€” Reportes</div></div>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="ingresos.html">Ingresos</a>
        <a href="gastos.html">Gastos</a>
        <a href="presupuestos.html">Presupuestos</a>
        <a class="active" href="reportes.html">Reportes</a>
        <a href="configuracion.html">ConfiguraciÃ³n</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <h1>Reportes Financieros</h1>
    
    <div class="card">
      <h2>Resumen General</h2>
      <div class="report-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-balance">â‚¬0</div>
          <div class="stat-label">Balance Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-income">â‚¬0</div>
          <div class="stat-label">Ingresos Totales</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-expenses">â‚¬0</div>
          <div class="stat-label">Gastos Totales</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avg-monthly">â‚¬0</div>
          <div class="stat-label">Ahorro Promedio Mensual</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Filtros de Reporte</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
        <div>
          <label for="report-period">PerÃ­odo:</label>
          <select id="report-period" style="width: 100%; padding: 8px; margin-top: 4px;">
            <option value="all">Todos los datos</option>
            <option value="current-month">Mes actual</option>
            <option value="last-month">Mes anterior</option>
            <option value="current-year">AÃ±o actual</option>
            <option value="last-3-months">Ãšltimos 3 meses</option>
            <option value="last-6-months">Ãšltimos 6 meses</option>
          </select>
        </div>
        <div>
          <label for="report-category">CategorÃ­a:</label>
          <select id="report-category" style="width: 100%; padding: 8px; margin-top: 4px;">
            <option value="">Todas las categorÃ­as</option>
          </select>
        </div>
      </div>
      <button onclick="generateReport()" class="btn">Generar Reporte</button>
    </div>

    <div class="card">
      <h2>AnÃ¡lisis por CategorÃ­as</h2>
      <div id="category-analysis">
        <!-- AnÃ¡lisis de categorÃ­as se carga aquÃ­ -->
      </div>
    </div>

    <div class="card">
      <h2>Tendencias Mensuales</h2>
      <div class="chart-placeholder">
        <h3>ðŸ“Š GrÃ¡fico de Tendencias</h3>
        <p>AquÃ­ se mostrarÃ­a un grÃ¡fico con la evoluciÃ³n de ingresos y gastos por mes</p>
        <small>Funcionalidad de grÃ¡ficos disponible en versiÃ³n premium</small>
      </div>
      <div id="monthly-trends">
        <!-- Tendencias mensuales se cargan aquÃ­ -->
      </div>
    </div>

    <div class="card">
      <h2>Exportar Datos</h2>
      <div class="export-section">
        <p>Exporta tus datos financieros en diferentes formatos:</p>
        <button onclick="exportCSV()" class="btn">ðŸ“Š Exportar CSV</button>
        <button onclick="exportJSON()" class="btn">ðŸ“‹ Exportar JSON</button>
        <button onclick="generatePDFReport()" class="btn">ðŸ“„ Reporte PDF</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    
    const Store = {
      get transactions(){try{return JSON.parse(localStorage.getItem('transactions')||'[]')}catch(_){return[]}}, 
      get budgets(){try{return JSON.parse(localStorage.getItem('budgets')||'[]')}catch(_){return[]}}, 
      get goals(){try{return JSON.parse(localStorage.getItem('goals')||'[]')}catch(_){return[]}}
    };
    
    const $ = id => document.getElementById(id);
    const esc = s => (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtE2 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:2});
    const e2 = v => fmtE2.format(Number(v||0));
    
    function toast(msg, type='info') {
      const toast = document.createElement('div');
      toast.textContent = msg;
      toast.style.cssText = `position:fixed;top:20px;right:20px;background:${type==='ok'?'var(--ok)':'var(--bad)'};color:#fff;padding:12px 16px;border-radius:8px;z-index:1000`;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3000);
    }
    
    function calculateTotalBalance() {
      return Store.transactions.reduce((sum, t) => {
        return sum + (t.type === 'ingreso' ? t.amount : -t.amount);
      }, 0);
    }
    
    function calculateTotalIncome() {
      return Store.transactions
        .filter(t => t.type === 'ingreso')
        .reduce((sum, t) => sum + t.amount, 0);
    }
    
    function calculateTotalExpenses() {
      return Store.transactions
        .filter(t => t.type === 'gasto')
        .reduce((sum, t) => sum + t.amount, 0);
    }
    
    function calculateAverageMonthlySavings() {
      const monthlyData = {};
      
      Store.transactions.forEach(t => {
        const month = t.date.substring(0, 7);
        if (!monthlyData[month]) {
          monthlyData[month] = { income: 0, expenses: 0 };
        }
        
        if (t.type === 'ingreso') {
          monthlyData[month].income += t.amount;
        } else {
          monthlyData[month].expenses += t.amount;
        }
      });
      
      const monthlySavings = Object.values(monthlyData)
        .map(data => data.income - data.expenses);
      
      return monthlySavings.length > 0 
        ? monthlySavings.reduce((sum, savings) => sum + savings, 0) / monthlySavings.length
        : 0;
    }
    
    function updateGeneralStats() {
      $('total-balance').textContent = e2(calculateTotalBalance());
      $('total-income').textContent = e2(calculateTotalIncome());
      $('total-expenses').textContent = e2(calculateTotalExpenses());
      $('avg-monthly').textContent = e2(calculateAverageMonthlySavings());
    }
    
    function populateCategoryFilter() {
      const categories = [...new Set(Store.transactions.map(t => t.category))].sort();
      const select = $('report-category');
      
      select.innerHTML = '<option value="">Todas las categorÃ­as</option>' +
        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    }
    
    function generateCategoryAnalysis() {
      const transactions = Store.transactions;
      const categoryTotals = {};
      
      transactions.forEach(t => {
        if (!categoryTotals[t.category]) {
          categoryTotals[t.category] = { income: 0, expenses: 0 };
        }
        
        if (t.type === 'ingreso') {
          categoryTotals[t.category].income += t.amount;
        } else {
          categoryTotals[t.category].expenses += t.amount;
        }
      });
      
      const container = $('category-analysis');
      const categories = Object.entries(categoryTotals)
        .sort((a, b) => (b[1].expenses + b[1].income) - (a[1].expenses + a[1].income));
      
      if (categories.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No hay datos para mostrar</p>';
        return;
      }
      
      container.innerHTML = categories.map(([category, data]) => `
        <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 700; text-transform: capitalize;">${esc(category)}</div>
            <div style="font-size: 12px; color: #666;">
              ${data.income > 0 ? `Ingresos: ${e2(data.income)}` : ''}
              ${data.income > 0 && data.expenses > 0 ? ' â€¢ ' : ''}
              ${data.expenses > 0 ? `Gastos: ${e2(data.expenses)}` : ''}
            </div>
          </div>
          <div style="font-weight: 700; color: ${data.income - data.expenses >= 0 ? 'var(--ok)' : 'var(--bad)'};">
            ${e2(data.income - data.expenses)}
          </div>
        </div>
      `).join('');
    }
    
    function generateMonthlyTrends() {
      const monthlyData = {};
      
      Store.transactions.forEach(t => {
        const month = t.date.substring(0, 7);
        if (!monthlyData[month]) {
          monthlyData[month] = { income: 0, expenses: 0 };
        }
        
        if (t.type === 'ingreso') {
          monthlyData[month].income += t.amount;
        } else {
          monthlyData[month].expenses += t.amount;
        }
      });
      
      const container = $('monthly-trends');
      const months = Object.keys(monthlyData).sort();
      
      if (months.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No hay datos mensuales para mostrar</p>';
        return;
      }
      
      container.innerHTML = months.map(month => {
        const data = monthlyData[month];
        const net = data.income - data.expenses;
        
        return `
          <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: grid; grid-template-columns: 100px 1fr 1fr 1fr; gap: 12px; align-items: center;">
            <div style="font-weight: 700;">${month}</div>
            <div style="color: var(--ok);">Ingresos: ${e2(data.income)}</div>
            <div style="color: var(--bad);">Gastos: ${e2(data.expenses)}</div>
            <div style="font-weight: 700; color: ${net >= 0 ? 'var(--ok)' : 'var(--bad)'};">
              Neto: ${e2(net)}
            </div>
          </div>
        `;
      }).join('');
    }
    
    window.generateReport = function() {
      updateGeneralStats();
      generateCategoryAnalysis();
      generateMonthlyTrends();
      toast('Reporte generado correctamente', 'ok');
    };
    
    window.exportCSV = function() {
      const transactions = Store.transactions;
      const headers = ['Fecha', 'DescripciÃ³n', 'Tipo', 'CategorÃ­a', 'Cantidad', 'Notas'];
      const rows = [headers.join(',')];
      
      transactions.forEach(t => {
        rows.push([
          t.date,
          `"${t.description}"`,
          t.type,
          t.category,
          t.amount,
          `"${t.notes || ''}"`
        ].join(','));
      });
      
      const csv = rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'finanzas_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      
      toast('CSV exportado correctamente', 'ok');
    };
    
    window.exportJSON = function() {
      const data = {
        transactions: Store.transactions,
        budgets: Store.budgets,
        goals: Store.goals,
        exported: new Date().toISOString()
      };
      
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'finanzas_backup_' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
      
      toast('JSON exportado correctamente', 'ok');
    };
    
    window.generatePDFReport = function() {
      toast('Funcionalidad de PDF disponible en versiÃ³n premium', 'info');
    };
    
    // Initial load
    updateGeneralStats();
    populateCategoryFilter();
    generateCategoryAnalysis();
    generateMonthlyTrends();
    
    // Apply brand configuration
    try{
      const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
      if(cfg.brand_color) document.documentElement.style.setProperty('--brand', cfg.brand_color);
    }catch(_){}
  })();
  </script>
</body>
</html>