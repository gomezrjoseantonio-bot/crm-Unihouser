<!DOCTYPE html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Prospectos</title>
<link rel="stylesheet" href="css/style.css">
<style>
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px}
.badge.note{background:#0b0d0e;color:#9aa5af;border:1px solid #2b343a}
.toast{margin-top:8px;padding:10px 12px;border-radius:10px;font-weight:700}
.toast.success{background:#0f2318;color:#86efac;border:1px solid #14532d}
</style>
</head><body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html" class="active">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Prospecto</h2>
  <input type="hidden" id="p_idx" value="-1">

  <!-- 1. Datos personales -->
  <div class="section">
    <h3>1 · Datos personales</h3>
    <div class="row three">
      <div class="field"><label>Nombre y Apellidos</label><input id="p_nombre" placeholder="Nombre y apellidos"></div>
      <div class="field"><label>DNI</label><input id="p_dni" placeholder="00000000X"></div>
      <div class="field"><label>Teléfono</label><input id="p_tel" placeholder="644 300 200"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Email</label><input id="p_email" placeholder="email@dominio.com"></div>
      <div class="field"><label>Dirección</label><input id="p_dir" placeholder="C/ ... nº ..."></div>
      <div class="field"><label>Localidad (residencia)</label><input id="p_loc_res" placeholder="Oviedo"></div>
    </div>
  </div>

  <!-- 2. Características del activo / inversión -->
  <div class="section">
    <h3>2 · Características del activo / inversión</h3>
    <div class="row three">
      <div class="field"><label>Localidades objetivo (separadas por comas)</label><input id="p_locs_obj" placeholder="Oviedo, Gijón, Avilés"></div>
      <div class="field"><label>Tipo de alquiler</label>
        <select id="p_pref_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
      </div>
      <div class="field"><label>Nº de activos deseados</label><input id="p_num_activos" inputmode="numeric" placeholder="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>¿Ascensor?</label><select id="p_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>Altura máxima (planta)</label><input id="p_alt_max" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>¿Bajos?</label><select id="p_bajos"><option>No</option><option>Sí</option></select></div>
    </div>
    <div class="row three">
      <div class="field"><label>Acepta reforma</label>
        <select id="p_reforma"><option>No</option><option>Lavado de cara</option><option>Integral</option></select>
      </div>
      <div class="field"><label>Presupuesto TOTAL (€) (compra+ITP+notaría+honorarios)</label>
        <input id="p_budget" data-money placeholder="150.000">
      </div>
      <div class="field"><label>Precio máx. COMPRA (auto)</label>
        <input id="p_max_compra" data-money disabled>
        <small class="hint">Se calcula con ITP/Notaría (Config) y honorarios (3.500€+IVA).</small>
      </div>
    </div>
  </div>

  <!-- 3. Financiación -->
  <div class="section">
    <h3>3 · Financiación</h3>
    <div class="row three">
      <div class="field"><label>Financiación bancaria</label><select id="p_financia"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Necesita broker?</label><select id="p_broker"><option>No</option><option>Sí</option></select></div>
      <div class="field"><label>% financiación habitual</label><input id="p_pct_fin" placeholder="80,0"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Hipoteca estimada (auto)</label><input id="p_hipoteca" data-money disabled></div>
      <div class="field"><label>Fondos propios (auto)</label><input id="p_propios" data-money disabled></div>
      <div class="field"><span class="badge note">El % se aplica sobre el <b>precio máx. de compra</b></span></div>
    </div>
  </div>

  <!-- 4. Objetivos -->
  <div class="section">
    <h3>4 · Objetivos</h3>
    <div class="row three">
      <div class="field"><label>Objetivo principal</label>
        <select id="p_obj_tipo">
          <option value="bruta">Rentabilidad bruta (%)</option>
          <option value="neta">Rentabilidad neta (%)</option>
          <option value="flujo">Flujo de caja (€/mes)</option>
        </select>
      </div>
      <div class="field"><label>Valor objetivo</label><input id="p_obj_val" placeholder="7,5 o 300"></div>
      <div class="field"><label>Periodo de búsqueda</label>
        <div class="row two">
          <input id="p_mes_ini" placeholder="MM/AAAA">
          <input id="p_mes_fin" placeholder="MM/AAAA">
        </div>
        <small class="hint">Si indicas inicio, el fin se autocompleta +5 meses.</small>
      </div>
    </div>
    <div class="row three" id="row_alquiler_max" hidden>
      <div class="field">
        <label>Alquiler máx. (orientativo) para la rentabilidad bruta (€ / mes)</label>
        <input id="p_alq_max" data-money disabled>
        <small class="hint">Calculado como Rb% × (Presupuesto TOTAL / 12).</small>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="actions">
    <button class="btn primary" id="p_save" type="button">Guardar</button>
    <button class="btn ghost" id="p_clear" type="button">Limpiar</button>
    <button class="btn" id="p_mail_contacto" type="button">Email: contacto</button>
    <button class="btn" id="p_mail_resumen" type="button">Email: resumen reunión</button>
    <button class="btn" id="p_mail_contrato" type="button">Email: contrato</button>
  </div>
  <div id="p_toast" class="toast success" hidden>✅ Prospecto guardado</div>

  <div class="hr"></div>

  <!-- Listado -->
  <div class="section"><h3>Listado de prospectos</h3></div>
  <table class="table">
    <thead><tr>
      <th>Nombre</th><th>Email</th><th>Teléfono</th>
      <th>Objetivo</th><th>Tipo</th><th>Localidades</th>
      <th>Fase</th><th>Subestado</th><th>Acciones</th>
    </tr></thead>
    <tbody id="p_body"></tbody>
  </table>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<!-- ===== JS EMBEBIDO: SIN DEPENDENCIAS ===== -->
<script>
// --- Utilidades de formato y almacén (autosuficiente) ---
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function parseEs(str){ if(str==null) return NaN; const s=String(str).trim().replace(/\./g,'').replace(',','.'); if(!s) return NaN; const n=Number(s); return Number.isFinite(n)?n:NaN; }
// Money UX: puntos de miles
function setupMoneyFormatting(root=document){ root.querySelectorAll('input[data-money]').forEach(inp=>{
  inp.addEventListener('blur', ()=>{ const n=parseEs(inp.value); if(Number.isFinite(n)) inp.value = fmtN0.format(Math.round(n)); });
  inp.addEventListener('input', ()=>{ const digits=(inp.value||'').replace(/[^\d]/g,''); if(!digits){inp.value='';return;} inp.value=fmtN0.format(Number(digits)); });
});}
const Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}} },
  set cfg(v){ localStorage.setItem('cfg', JSON.stringify(v)); },
  get pros(){ try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]} },
  set pros(v){ localStorage.setItem('pros', JSON.stringify(v)); }
};

// --- Lógica Prospectos ---
document.addEventListener('DOMContentLoaded', ()=>{
  const $=id=>document.getElementById(id);
  setupMoneyFormatting(document);

  const nf0=fmtN0, nf1=fmtN1;
  const form={
    idx:$('p_idx'),
    nombre:$('p_nombre'), dni:$('p_dni'), email:$('p_email'), tel:$('p_tel'),
    dir:$('p_dir'), loc_res:$('p_loc_res'),
    locs_obj:$('p_locs_obj'), pref_tipo:$('p_pref_tipo'), num_activos:$('p_num_activos'),
    asc:$('p_asc'), alt_max:$('p_alt_max'), bajos:$('p_bajos'), reforma:$('p_reforma'),
    budget:$('p_budget'), max_compra:$('p_max_compra'),
    financia:$('p_financia'), broker:$('p_broker'), pct_fin:$('p_pct_fin'),
    hipoteca:$('p_hipoteca'), propios:$('p_propios'),
    obj_tipo:$('p_obj_tipo'), obj_val:$('p_obj_val'),
    mes_ini:$('p_mes_ini'), mes_fin:$('p_mes_fin'), alq_max:$('p_alq_max')
  };
  const tbody=$('p_body'), toast=$('p_toast');

  function showToast(msg){ toast.textContent=msg; toast.hidden=false; clearTimeout(window._p_toast); window._p_toast=setTimeout(()=>toast.hidden=true,1600); }
  function objLabel(p){ return p.obj_tipo==='flujo' ? nf0.format(p.obj_raw)+' €' : nf1.format(p.obj_raw)+' %'; }

  function recalcMaxCompra(){
    const cfg=Store.cfg||{};
    const B=parseEs(form.budget.value)||0;
    const itp=((cfg.c_itp??8)/100);
    const not=(cfg.c_notaria??1500);
    const honor=3500*1.21; // v1
    const compra=Math.max(0,(B-not-honor)/(1+itp));
    form.max_compra.value=nf0.format(Math.round(compra));
    recalcFinanciacion(); recalcAlquilerMax();
  }
  function recalcFinanciacion(){
    const financia=(form.financia.value==='Sí');
    const pct=(parseEs(form.pct_fin.value)||80)/100;
    const compra=parseEs(form.max_compra.value)||0;
    const presupuesto=parseEs(form.budget.value)||0;
    const hip=financia?Math.round(compra*pct):0;
    const propios=Math.max(0,presupuesto-hip);
    form.hipoteca.value=nf0.format(hip);
    form.propios.value=nf0.format(propios);
  }
  function recalcAlquilerMax(){
    const isBruta=(form.obj_tipo.value==='bruta');
    const row=document.getElementById('row_alquiler_max'); if(row) row.hidden=!isBruta;
    if(!isBruta){ form.alq_max.value=''; return; }
    const rb=parseEs(form.obj_val.value);
    const presupuesto=parseEs(form.budget.value)||0;
    if(!Number.isFinite(rb)||!presupuesto){ form.alq_max.value=''; return; }
    const alq=Math.max(0,(rb/100)*presupuesto/12);
    form.alq_max.value=nf0.format(Math.round(alq));
  }
  function autoMesFin(){
    const s=(form.mes_ini.value||'').trim(); if(!s || (form.mes_fin.value||'').trim()) return;
    const m=s.match(/^(\d{2})\/(\d{4})$/); if(!m) return;
    let mm=parseInt(m[1],10), yy=parseInt(m[2],10); mm+=5; while(mm>12){mm-=12;yy++}
    form.mes_fin.value=String(mm).padStart(2,'0')+'/'+yy;
  }
  ['input','change'].forEach(ev=>{
    form.budget.addEventListener(ev,recalcMaxCompra);
    form.financia.addEventListener(ev,recalcFinanciacion);
    form.pct_fin.addEventListener(ev,recalcFinanciacion);
    form.obj_tipo.addEventListener(ev,recalcAlquilerMax);
    form.obj_val.addEventListener(ev,recalcAlquilerMax);
    form.mes_ini.addEventListener(ev,autoMesFin);
  });

  function serialize(){
    const obj_raw=parseEs(form.obj_val.value);
    return {
      ts:Date.now(),
      nombre:form.nombre.value.trim(), dni:form.dni.value.trim(), email:form.email.value.trim(), tel:form.tel.value.trim(),
      dir:form.dir.value.trim(), loc_res:form.loc_res.value.trim(),
      locs_text:form.locs_obj.value.trim(),
      pref_tipo:form.pref_tipo.value, num_activos:parseEs(form.num_activos.value)||1,
      asc:form.asc.value, alt_max:parseEs(form.alt_max.value)||null, bajos:form.bajos.value, reforma:form.reforma.value,
      budget:parseEs(form.budget.value)||0, max_compra:parseEs(form.max_compra.value)||0,
      financia:form.financia.value, broker:form.broker.value, pct_fin:parseEs(form.pct_fin.value)||80,
      hipoteca:parseEs(form.hipoteca.value)||0, propios:parseEs(form.propios.value)||0,
      obj_tipo:form.obj_tipo.value, obj_raw:Number.isFinite(obj_raw)?obj_raw:0,
      mes_ini:form.mes_ini.value.trim(), mes_fin:form.mes_fin.value.trim(),
      fase:'CONTACTO', sub:'Pendiente contactar',
      alq_max:parseEs(form.alq_max.value)||0
    };
  }
  function hydrate(i){
    const p=(Store.pros||[])[i]; if(!p) return;
    form.idx.value=i;
    form.nombre.value=p.nombre||''; form.dni.value=p.dni||''; form.email.value=p.email||''; form.tel.value=p.tel||'';
    form.dir.value=p.dir||''; form.loc_res.value=p.loc_res||'';
    form.locs_obj.value=p.locs_text||''; form.pref_tipo.value=p.pref_tipo||'Tradicional';
    form.num_activos.value=p.num_activos||'';
    form.asc.value=p.asc||'Sí'; form.alt_max.value=p.alt_max||''; form.bajos.value=p.bajos||'No'; form.reforma.value=p.reforma||'No';
    form.budget.value=p.budget?nf0.format(p.budget):''; form.max_compra.value=p.max_compra?nf0.format(p.max_compra):'';
    form.financia.value=p.financia||'Sí'; form.broker.value=p.broker||'No'; form.pct_fin.value=p.pct_fin!=null?String(p.pct_fin).replace('.',','):'80,0';
    form.hipoteca.value=p.hipoteca?nf0.format(p.hipoteca):''; form.propios.value=p.propios?nf0.format(p.propios):'';
    form.obj_tipo.value=p.obj_tipo||'bruta'; form.obj_val.value=p.obj_tipo==='flujo'?nf0.format(p.obj_raw||0):String(p.obj_raw||'').replace('.',',');
    form.mes_ini.value=p.mes_ini||''; form.mes_fin.value=p.mes_fin||''; form.alq_max.value=p.alq_max?nf0.format(p.alq_max):'';
    recalcFinanciacion(); recalcAlquilerMax();
    window.scrollTo({top:0,behavior:'smooth'});
  }
  function clearForm(){
    form.idx.value=-1;
    ['p_nombre','p_dni','p_email','p_tel','p_dir','p_loc_res','p_locs_obj','p_num_activos','p_alt_max','p_budget','p_max_compra','p_pct_fin','p_hipoteca','p_propios','p_obj_val','p_mes_ini','p_mes_fin','p_alq_max']
      .forEach(id=>{ const el=$(id); if(el) el.value=''; });
    form.pref_tipo.value='Tradicional'; form.asc.value='Sí'; form.bajos.value='No'; form.reforma.value='No';
    form.financia.value='Sí'; form.broker.value='No'; form.obj_tipo.value='bruta';
  }

  function render(){
    tbody.innerHTML='';
    (Store.pros||[]).forEach((p,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${p.nombre||'—'}</td>
        <td>${p.email||'—'}</td>
        <td>${p.tel||'—'}</td>
        <td>${(p.obj_tipo||'').toUpperCase()} ${objLabel(p)}</td>
        <td>${p.pref_tipo||'—'}</td>
        <td>${p.locs_text||'—'}</td>
        <td>${p.fase||'CONTACTO'}</td>
        <td>${p.sub||'Pendiente contactar'}</td>
        <td>
          <button class="btn ghost" data-act="edit" data-i="${i}">Editar</button>
          <button class="btn" data-act="del" data-i="${i}">Eliminar</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function mailto(to, subject, body){
    if(!to){ showToast('⚠ Falta email'); return; }
    const url=mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)};
    window.location.href=url;
  }
  const plantillaContacto=p=>`Hola ${p.nombre||''},

Soy José Antonio de Unihouser. He recibido tu interés en inversión inmobiliaria.
¿Te viene bien agendar una reunión para concretar objetivos y financiación?

Gracias,
Unihouser · 644 300 200 · unihouser.es`;
  const plantillaResumen=p=>`Hola ${p.nombre||''},

Resumen de la reunión:
- Tipo alquiler: ${p.pref_tipo}
- Localidades objetivo: ${p.locs_text||'-'}
- Presupuesto total: ${nf0.format(p.budget)} €
- Precio máx. compra (estimado): ${nf0.format(p.max_compra)} €
- Financiación: ${p.financia} (${p.pct_fin||80}% sobre compra)
- Objetivo: ${p.obj_tipo.toUpperCase()} ${objLabel(p)}
- Periodo búsqueda: ${p.mes_ini||'-'} a ${p.mes_fin||'-'}

Si todo OK, te envío el contrato para firma.

Unihouser`;
  const plantillaContrato=p=>`Hola ${p.nombre||''},

Adjunto el contrato de servicios para firma.
En cuanto lo tengamos, iniciamos búsqueda (hasta 5 propuestas iniciales).

Gracias,
Unihouser`;

  // Delegación de eventos (funciona aunque el DOM cambie)
  document.addEventListener('click',(ev)=>{
    const t=ev.target; if(!(t instanceof HTMLElement)) return;

    if(t.id==='p_save'){
      const rec=serialize();
      const arr=Store.pros||[]; const idx=parseInt(form.idx.value||'-1',10);
      if(idx>=0) arr[idx]=rec; else arr.unshift(rec);
      Store.pros=arr; render(); showToast('✅ Prospecto guardado'); clearForm(); return;
    }
    if(t.id==='p_clear'){ clearForm(); showToast('↺ Limpio'); return; }

    if(t.id==='p_mail_contacto'){ const p=serialize(); mailto(p.email,'Unihouser · Primer contacto',plantillaContacto(p)); return; }
    if(t.id==='p_mail_resumen'){  const p=serialize(); mailto(p.email,'Unihouser · Resumen de reunión',plantillaResumen(p)); return; }
    if(t.id==='p_mail_contrato'){  const p=serialize(); mailto(p.email,'Unihouser · Contrato de servicios',plantillaContrato(p)); return; }

    if(t.dataset?.act==='edit'){ hydrate(parseInt(t.dataset.i,10)); return; }
    if(t.dataset?.act==='del'){
      const arr=Store.pros||[]; const i=parseInt(t.dataset.i,10);
      if(!arr[i]) return;
      if(confirm('¿Eliminar prospecto?')){ arr.splice(i,1); Store.pros=arr; render(); }
      return;
    }
  });

  // Init
  recalcMaxCompra();
  render();
});
</script>
</body></html>
