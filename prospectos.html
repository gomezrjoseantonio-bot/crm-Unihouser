<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Prospectos</title>
<link rel="stylesheet" href="css/style.css">
<style>
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px}
.badge.note{background:#0b0d0e;color:#9aa5af;border:1px solid #2b343a}
.toast{margin-top:8px;padding:10px 12px;border-radius:10px;font-weight:700}
.toast.success{background:#0f2318;color:#86efac;border:1px solid #14532d}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html" class="active">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Prospecto</h2>
  <input type="hidden" id="p_idx" value="-1">

  <!-- 1. Datos personales -->
  <div class="section">
    <h3>1 · Datos personales</h3>
    <div class="row three">
      <div class="field"><label>Nombre y Apellidos</label><input id="p_nombre" placeholder="Nombre y apellidos"></div>
      <div class="field"><label>DNI</label><input id="p_dni" placeholder="00000000X"></div>
      <div class="field"><label>Teléfono</label><input id="p_tel" placeholder="644 300 200"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Email</label><input id="p_email" placeholder="email@dominio.com"></div>
      <div class="field"><label>Dirección</label><input id="p_dir" placeholder="C/ ... nº ..."></div>
      <div class="field"><label>Localidad (residencia)</label><input id="p_loc_res" placeholder="Oviedo"></div>
    </div>
  </div>

  <!-- 2. Características del activo / inversión -->
  <div class="section">
    <h3>2 · Características del activo / inversión</h3>
    <div class="row three">
      <div class="field"><label>Localidades objetivo (separadas por comas)</label><input id="p_locs_obj" placeholder="Oviedo, Gijón, Avilés"></div>
      <div class="field"><label>Tipo de alquiler</label>
        <select id="p_pref_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
      </div>
      <div class="field"><label>Nº de activos deseados</label><input id="p_num_activos" inputmode="numeric" placeholder="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>¿Ascensor?</label><select id="p_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>Altura máxima (planta)</label><input id="p_alt_max" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>¿Bajos?</label><select id="p_bajos"><option>No</option><option>Sí</option></select></div>
    </div>
    <div class="row three">
      <div class="field"><label>Acepta reforma</label>
        <select id="p_reforma"><option>No</option><option>Lavado de cara</option><option>Integral</option></select>
      </div>
      <div class="field"><label>Presupuesto TOTAL (€) (compra+ITP+notaría+honorarios)</label>
        <input id="p_budget" data-money placeholder="150.000">
      </div>
      <div class="field"><label>Precio máx. COMPRA (auto)</label>
        <input id="p_max_compra" data-money disabled>
        <small class="hint">Se calcula con ITP/Notaría (Config) y honorarios (3.500€+IVA).</small>
      </div>
    </div>
  </div>

  <!-- 3. Financiación -->
  <div class="section">
    <h3>3 · Financiación</h3>
    <div class="row three">
      <div class="field"><label>Financiación bancaria</label><select id="p_financia"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Necesita broker?</label><select id="p_broker"><option>No</option><option>Sí</option></select></div>
      <div class="field"><label>% financiación habitual</label><input id="p_pct_fin" placeholder="80,0"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Hipoteca estimada (auto)</label><input id="p_hipoteca" data-money disabled></div>
      <div class="field"><label>Fondos propios (auto)</label><input id="p_propios" data-money disabled></div>
      <div class="field"><span class="badge note">El % se aplica sobre el <b>precio máx. de compra</b></span></div>
    </div>
  </div>

  <!-- 4. Objetivos -->
  <div class="section">
    <h3>4 · Objetivos</h3>
    <div class="row three">
      <div class="field"><label>Objetivo principal</label>
        <select id="p_obj_tipo">
          <option value="bruta">Rentabilidad bruta (%)</option>
          <option value="neta">Rentabilidad neta (%)</option>
          <option value="flujo">Flujo de caja (€/mes)</option>
        </select>
      </div>
      <div class="field"><label>Valor objetivo</label><input id="p_obj_val" placeholder="7,5 o 300"></div>
      <div class="field"><label>Periodo de búsqueda</label>
        <div class="row two">
          <input id="p_mes_ini" placeholder="MM/AAAA">
          <input id="p_mes_fin" placeholder="MM/AAAA">
        </div>
        <small class="hint">Si indicas inicio, el fin se autocompleta +5 meses.</small>
      </div>
    </div>
    <div class="row three" id="row_alquiler_max" hidden>
      <div class="field">
        <label>Alquiler máx. (orientativo) para la rentabilidad bruta (€ / mes)</label>
        <input id="p_alq_max" data-money disabled>
        <small class="hint">Calculado como Rb% × (Presupuesto TOTAL / 12).</small>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="actions">
    <button class="btn primary" id="p_save" type="button">Guardar</button>
    <button class="btn ghost" id="p_clear" type="button">Limpiar</button>
    <button class="btn" id="p_mail_contacto" type="button">Email: contacto</button>
    <button class="btn" id="p_mail_resumen" type="button">Email: resumen reunión</button>
    <button class="btn" id="p_mail_contrato" type="button">Email: contrato</button>
  </div>
  <div id="p_toast" class="toast success" hidden>✅ Prospecto guardado</div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<!-- ===== JS EMBEBIDO: 100% AUTÓNOMO ===== -->
<script>
(function(){
  "use strict";

  // ---- Formato y almacén ----
  var fmtE0 = new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",maximumFractionDigits:0});
  var fmtN0 = new Intl.NumberFormat("es-ES",{maximumFractionDigits:0});
  var fmtN1 = new Intl.NumberFormat("es-ES",{maximumFractionDigits:1});

  function parseEs(str){
    if(str==null) return NaN;
    var s=String(str).trim().replace(/\./g,"").replace(",",".");
    if(!s) return NaN;
    var n=Number(s);
    return isFinite(n)?n:NaN;
  }
  function setupMoneyFormatting(root){
    var nodes = root.querySelectorAll("input[data-money]");
    for(var i=0;i<nodes.length;i++){
      (function(inp){
        inp.addEventListener("blur", function(){
          var n=parseEs(inp.value);
          if(isFinite(n)) inp.value = fmtN0.format(Math.round(n));
        });
        inp.addEventListener("input", function(){
          var digits=(inp.value||"").replace(/[^\d]/g,"");
          if(!digits){ inp.value=""; return; }
          inp.value = fmtN0.format(Number(digits));
        });
      })(nodes[i]);
    }
  }
  var Store = {
    get cfg(){
      try{ return JSON.parse(localStorage.getItem("cfg")||"{}"); }catch(e){ return {}; }
    },
    set cfg(v){ localStorage.setItem("cfg", JSON.stringify(v)); },
    get pros(){
      try{ return JSON.parse(localStorage.getItem("pros")||"[]"); }catch(e){ return []; }
    },
    set pros(v){ localStorage.setItem("pros", JSON.stringify(v)); }
  };

  // ---- Util ----
  function $(id){ return document.getElementById(id); }
  function showToast(msg){
    var t=$("p_toast"); if(!t) return;
    t.textContent=msg; t.hidden=false;
    clearTimeout(window.__p_toast);
    window.__p_toast = setTimeout(function(){ t.hidden=true; }, 1600);
  }

  // ---- DOM refs ----
  var form = {
    idx:$("p_idx"),
    nombre:$("p_nombre"), dni:$("p_dni"), email:$("p_email"), tel:$("p_tel"),
    dir:$("p_dir"), loc_res:$("p_loc_res"),
    locs_obj:$("p_locs_obj"), pref_tipo:$("p_pref_tipo"), num_activos:$("p_num_activos"),
    asc:$("p_asc"), alt_max:$("p_alt_max"), bajos:$("p_bajos"), reforma:$("p_reforma"),
    budget:$("p_budget"), max_compra:$("p_max_compra"),
    financia:$("p_financia"), broker:$("p_broker"), pct_fin:$("p_pct_fin"),
    hipoteca:$("p_hipoteca"), propios:$("p_propios"),
    obj_tipo:$("p_obj_tipo"), obj_val:$("p_obj_val"),
    mes_ini:$("p_mes_ini"), mes_fin:$("p_mes_fin"), alq_max:$("p_alq_max")
  };

  // ---- Cálculos ----
  function recalcMaxCompra(){
    var cfg = Store.cfg || {};
    var B = parseEs(form.budget.value) || 0;
    var itp = ((cfg.c_itp!=null?cfg.c_itp:8))/100;
    var not = (cfg.c_notaria!=null?cfg.c_notaria:1500);
    var honor = 3500*1.21; // fijo v1
    var compra = Math.max(0, (B - not - honor) / (1 + itp));
    form.max_compra.value = fmtN0.format(Math.round(compra));
    recalcFinanciacion();
    recalcAlquilerMax();
  }
  function recalcFinanciacion(){
    var financia = (form.financia.value==="Sí");
    var pct = (parseEs(form.pct_fin.value)||80)/100;
    var compra = parseEs(form.max_compra.value)||0;
    var presupuesto = parseEs(form.budget.value)||0;
    var hip = financia ? Math.round(compra * pct) : 0;
    var propios = Math.max(0, presupuesto - hip);
    form.hipoteca.value = fmtN0.format(hip);
    form.propios.value  = fmtN0.format(propios);
  }
  function recalcAlquilerMax(){
    var isBruta = (form.obj_tipo.value==="bruta");
    var row = document.getElementById("row_alquiler_max");
    if(row) row.hidden = !isBruta;
    if(!isBruta){ form.alq_max.value=""; return; }
    var rb = parseEs(form.obj_val.value);
    var presupuesto = parseEs(form.budget.value)||0;
    if(!isFinite(rb) || !presupuesto){ form.alq_max.value=""; return; }
    var alq = Math.max(0, (rb/100) * presupuesto / 12);
    form.alq_max.value = fmtN0.format(Math.round(alq));
  }
  function autoMesFin(){
    var s = (form.mes_ini.value||"").trim();
    if(!s || (form.mes_fin.value||"").trim()) return;
    var m = s.match(/^(\d{2})\/(\d{4})$/);
    if(!m) return;
    var mm = parseInt(m[1],10), yy = parseInt(m[2],10);
    mm += 5;
    while(mm>12){ mm-=12; yy+=1; }
    form.mes_fin.value = (mm<10?"0"+mm:mm) + "/" + yy;
  }

  // ---- Serializar / Hidratar / Limpiar ----
  function serialize(){
    var raw = parseEs(form.obj_val.value);
    return {
      ts: Date.now(),
      nombre: (form.nombre.value||"").trim(),
      dni: (form.dni.value||"").trim(),
      email: (form.email.value||"").trim(),
      tel: (form.tel.value||"").trim(),
      dir: (form.dir.value||"").trim(),
      loc_res: (form.loc_res.value||"").trim(),
      locs_text: (form.locs_obj.value||"").trim(),
      pref_tipo: form.pref_tipo.value,
      num_activos: parseEs(form.num_activos.value)||1,
      asc: form.asc.value,
      alt_max: parseEs(form.alt_max.value)||null,
      bajos: form.bajos.value,
      reforma: form.reforma.value,
      budget: parseEs(form.budget.value)||0,
      max_compra: parseEs(form.max_compra.value)||0,
      financia: form.financia.value,
      broker: form.broker.value,
      pct_fin: parseEs(form.pct_fin.value)||80,
      hipoteca: parseEs(form.hipoteca.value)||0,
      propios: parseEs(form.propios.value)||0,
      obj_tipo: form.obj_tipo.value,
      obj_raw: isFinite(raw)? raw : 0,
      mes_ini: (form.mes_ini.value||"").trim(),
      mes_fin: (form.mes_fin.value||"").trim(),
      fase: "CONTACTO",
      sub: "Pendiente contactar",
      alq_max: parseEs(form.alq_max.value)||0
    };
  }
  function clearForm(){
    form.idx.value = -1;
    var ids = ["p_nombre","p_dni","p_email","p_tel","p_dir","p_loc_res","p_locs_obj","p_num_activos","p_alt_max","p_budget","p_max_compra","p_pct_fin","p_hipoteca","p_propios","p_obj_val","p_mes_ini","p_mes_fin","p_alq_max"];
    for(var i=0;i<ids.length;i++){ var el=$(ids[i]); if(el){ el.value=""; } }
    form.pref_tipo.value="Tradicional";
    form.asc.value="Sí";
    form.bajos.value="No";
    form.reforma.value="No";
    form.financia.value="Sí";
    form.broker.value="No";
    form.obj_tipo.value="bruta";
    recalcAlquilerMax();
  }

  // ---- Emails (mailto) ----
  function mailto(to, subject, body){
    if(!to){ showToast("⚠ Falta email"); return; }
    var url = "mailto:"+encodeURIComponent(to)+"?subject="+encodeURIComponent(subject)+"&body="+encodeURIComponent(body);
    window.location.href = url;
  }
  function objLabel(p){
    if(p.obj_tipo==="flujo") return fmtN0.format(p.obj_raw)+" €";
    return fmtN1.format(p.obj_raw)+" %";
  }
  function plantillaContacto(p){
    return "Hola "+(p.nombre||"")+",\n\nSoy José Antonio de Unihouser. He recibido tu interés en inversión inmobiliaria.\n¿Te viene bien agendar una reunión para concretar objetivos y financiación?\n\nGracias,\nUnihouser · 644 300 200 · unihouser.es";
  }
  function plantillaResumen(p){
    return "Hola "+(p.nombre||"")+",\n\nResumen de la reunión:\n- Tipo alquiler: "+p.pref_tipo+"\n- Localidades objetivo: "+(p.locs_text||"-")+"\n- Presupuesto total: "+fmtN0.format(p.budget)+" €\n- Precio máx. compra (estimado): "+fmtN0.format(p.max_compra)+" €\n- Financiación: "+p.financia+" ("+(p.pct_fin||80)+"% sobre compra)\n- Objetivo: "+(p.obj_tipo||"").toUpperCase()+" "+objLabel(p)+"\n- Periodo búsqueda: "+(p.mes_ini||"-")+" a "+(p.mes_fin||"-")+"\n\nSi todo OK, te envío el contrato para firma.\n\nUnihouser";
  }
  function plantillaContrato(p){
    return "Hola "+(p.nombre||"")+",\n\nAdjunto el contrato de servicios para firma.\nEn cuanto lo tengamos, iniciamos búsqueda (hasta 5 propuestas iniciales).\n\nGracias,\nUnihouser";
  }

  // ---- Eventos ----
  document.addEventListener("click", function(ev){
    var t = ev.target;
    if(!t || !t.id) return;

    if(t.id==="p_save"){
      var rec = serialize();
      var arr = Store.pros || [];
      var idx = parseInt(form.idx.value||"-1",10);
      if(idx>=0) arr[idx]=rec; else arr.unshift(rec);
      Store.pros = arr;
      showToast("✅ Prospecto guardado");
      clearForm();
      return;
    }
    if(t.id==="p_clear"){
      clearForm();
      showToast("↺ Limpio");
      return;
    }
    if(t.id==="p_mail_contacto"){
      var p1 = serialize();
      mailto(p1.email, "Unihouser · Primer contacto", plantillaContacto(p1));
      return;
    }
    if(t.id==="p_mail_resumen"){
      var p2 = serialize();
      mailto(p2.email, "Unihouser · Resumen de reunión", plantillaResumen(p2));
      return;
    }
    if(t.id==="p_mail_contrato"){
      var p3 = serialize();
      mailto(p3.email, "Unihouser · Contrato de servicios", plantillaContrato(p3));
      return;
    }
  });

  // ---- Listeners de cálculo en vivo ----
  function attachLive(){
    var evs=["input","change"];
    for(var i=0;i<evs.length;i++){
      form.budget.addEventListener(evs[i], recalcMaxCompra);
      form.financia.addEventListener(evs[i], recalcFinanciacion);
      form.pct_fin.addEventListener(evs[i], recalcFinanciacion);
      form.obj_tipo.addEventListener(evs[i], recalcAlquilerMax);
      form.obj_val.addEventListener(evs[i], recalcAlquilerMax);
      form.mes_ini.addEventListener(evs[i], autoMesFin);
    }
  }

  // ---- Init ----
  setupMoneyFormatting(document);
  attachLive();
  recalcMaxCompra();
  recalcAlquilerMax();
})();
</script>
</body>
</html>
