<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<style>
:root{
--accent:#ff6a3d; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
--muted:#667085; --border:#e5e7eb; --text:#101828; --bg:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:1100px;margin:0 auto;padding:16px}
.topbar{background:#fff;border-bottom:1px solid var(--border)}
.brand .title{font-weight:800}
.nav a{margin:0 8px;text-decoration:none;color:#475467}
.nav a.active{color:var(--accent);font-weight:800}
.page-title{margin:14px 0 8px;color:#101828;font-weight:800;letter-spacing:-.02em;font-size:clamp(22px,2.4vw,28px)}
.card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(16,24,40,.04);padding:12px;margin-bottom:12px}
.section{margin:8px 0 10px}
.section h3{margin:0 0 8px}
.grid2{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:720px){.grid2{grid-template-columns:1fr 1fr}}
.row{display:grid;gap:10px;grid-template-columns:1fr}
.row.two{grid-template-columns:1fr 1fr}
.field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,button{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}
input[disabled]{background:#f9fafb}
input.full{grid-column:1/-1}
.btn{background:#f9fafb;border:1px solid var(--border);color:var(--text);font-weight:700;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:transparent}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.kpis{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(min-width:900px){.kpis{grid-template-columns:repeat(5,1fr)}}
.kpi{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
.kpi .lab{font-size:12px;color:var(--muted)}
.kpi .val{font-size:20px;font-weight:800;margin-top:2px}
.dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-left:6px;vertical-align:middle}
.dot.green{background:var(--ok)} .dot.amber{background:var(--warn)} .dot.red{background:var(--bad)} .dot.gray{background:#d0d5dd}
.chartWrap{margin-top:10px;border:1px solid var(--border);border-radius:12px;padding:8px}
.muted{color:#667085}
.list{min-height:60px;border:1px dashed #e5e7eb;border-radius:10px;padding:8px}
.foot{text-align:center;color:#667085;margin:20px 0 10px}
.toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:80}
.toast{background:#111827;color:#fff;border-radius:10px;padding:10px 12px;box-shadow:0 10px 24px rgba(0,0,0,.25);opacity:.96}
.toast.ok{background:#15803d} .toast.warn{background:#b45309} .toast.bad{background:#b91c1c}
.hint{font-size:12px;color:#667085}
</style>
</head>
<body>
<header class="topbar">
<div class="container" style="display:flex;justify-content:space-between;align-items:center">
<div class="brand"><div class="title">Unihouser — CRM & BuyBox</div></div>
<nav class="nav">
<a href="evaluar.html" class="active">Evaluar</a>
<a href="evaluaciones.html">Evaluaciones</a>
<a href="prospectos.html">Prospectos</a>
<a href="dashboard.html">Dashboard</a>
<a href="configuracion.html">Configuración</a>
</nav>
</div>
</header>

<main class="container">
<h2 class="page-title">Evaluar Activo</h2>

<section class="card">
<!-- 1) DATOS DEL INMUEBLE (orden compacto 2 columnas) -->
<div class="section">
<h3>Datos del inmueble</h3>
<div class="grid2">
<div class="field"><label>Localidad</label><select id="e_loc"></select></div>
<div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>

<div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
<div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>

<div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
<div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>

<div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>
<div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>

<div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
<div class="field"><label>Necesita reforma</label>
<select id="e_reforma_tipo">
<option>No</option><option>Lavado de cara</option><option>Integral</option>
</select>
</div>

<div class="field" style="grid-column:1/-1"><label>URL Idealista (opcional)</label><input id="e_url" class="full" placeholder="https://www.idealista.com/inmueble/..."></div>
</div>
</div>

<!-- 2) GASTOS DE ADQUISICIÓN -->
<div class="section">
<h3>Gastos de adquisición</h3>
<div class="row two">
<div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
<div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
</div>
<div class="row two">
<div class="field"><label>ITP (€ — auto)</label><input id="e_itp_eur" data-money disabled></div>
<div class="field"><label>Notaría y Registro (€ — auto)</label><input id="e_notaria" data-money disabled></div>
</div>
<div class="row two">
<div class="field"><label>Incluir honorarios PSI (con IVA)</label><select id="e_honor"><option value="si">Sí</option><option value="no">No</option></select></div>
<div class="field"><label>Precio máx. compra (para alcanzar objetivos)</label><input id="e_pmax" data-money disabled></div>
</div>
<div class="hint">Se calcula con los objetivos de Configuración (Bruta y Neta) para el tipo elegido; se usa el más conservador.</div>
</div>

<!-- 3) GASTOS DE MANTENIMIENTO -->
<div class="section">
<h3>Gastos de mantenimiento</h3>
<div class="row two">
<div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
<div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
</div>
<div class="row two">
<div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money data-auto="1"></div>
<div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money data-auto="1"></div>
</div>
<div class="row two">
<div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money data-auto="1"></div>
<div class="field"><small class="muted">Se autocalculan con el alquiler y el tipo. Si los editas, dejan de auto-actualizarse (vuelven con “Limpiar”).</small></div>
</div>
</div>

<!-- 4) EXPLOTACIÓN -->
<div class="section">
<h3>Tipo de explotación e ingresos</h3>
<div class="row two">
<div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
<div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
</div>
<div class="row two">
<div class="field"><label>Otros ingresos (€/mes)</label><input id="e_otros" value="0" data-money></div>
<div class="field"><span class="muted">&nbsp;</span></div>
</div>
</div>

<div class="actions">
<button class="btn primary" id="e_calc">Calcular</button>
<button class="btn" id="e_clean">Limpiar</button>
</div>

<!-- 5) RESULTADOS -->
<div id="e_result" class="section" hidden>
<h3>Resultados</h3>
<div class="kpis">
<div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
<div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot gray"></span></div><div class="val"><span id="r_bruta">—</span> <span id="r_bruta_diff" class="muted"></span></div></div>
<div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot gray"></span></div><div class="val"><span id="r_neta">—</span> <span id="r_neta_diff" class="muted"></span></div></div>
<div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot gray"></span></div><div class="val" id="r_flujo">—</div></div>
<div class="kpi"><div class="lab">Precio máx. compra (usado)</div><div class="val" id="r_pmax">—</div></div>
</div>

<div class="chartWrap"><canvas id="chartKPI" width="460" height="220"></canvas></div>

<div class="card" style="margin-top:12px">
<h3 style="margin:0 0 8px">Clientes potenciales</h3>
<div id="matchList" class="list muted">—</div>
<div class="actions" style="margin-top:10px">
<select id="assign_cli" size="4" style="min-width:280px"></select>
<button class="btn" id="save_only">Guardar evaluación</button>
<button class="btn primary" id="save_assign">Guardar y asignar</button>
</div>
</div>
</div>
</section>
</main>

<div class="toast-wrap" id="toasts"></div>
<footer class="foot"><div class="container">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ====== Store / Config (PSI con IVA = 4.235 €) ====== */
const Store={get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}},set cfg(v){localStorage.setItem('cfg',JSON.stringify(v))},get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},set pros(v){localStorage.setItem('pros',JSON.stringify(v))},get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},set evals(v){localStorage.setItem('evals',JSON.stringify(v))}};
function cfgOrDefaults(){
const c=Store.cfg||{};
const itpPct = num(c.itp_pct)||8;
const notaria = num(c.notaria)||1500;
const basePsi = num(c.honorarios)||3500;
const honorIVA = Math.round(basePsi*1.21); // 4.235 €
const hogarPct = num(c.hogar_pct)||3.5;
const impagoTrad = num(c.impago_trad_pct)||4;
const impagoHab = num(c.impago_hab_pct)||4;
const gestTrad = num(c.gest_trad_pct)||15;
const gestHab = num(c.gest_hab_pct)||25;
const goals = {
bruta_trad:num(c.goal_bruta_trad)||10, neta_trad:num(c.goal_neta_trad)||6, flujo_trad:num(c.goal_flujo_trad)||0,
bruta_hab:num(c.goal_bruta_hab)||12, neta_hab:num(c.goal_neta_hab)||7, flujo_hab:num(c.goal_flujo_hab)||0
};
return {itpPct,notaria,honorIVA,hogarPct,impagoTrad,impagoHab,gestTrad,gestHab,goals};
}

/* ====== Utils & Formato ====== */
const fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function id(x){return document.getElementById(x)}
function text(n,t){if(id(n)) id(n).textContent=t}
function val(n){return id(n)?id(n).value:""}
function setv(n,v){if(id(n)) id(n).value=v}
function show(n,f){if(id(n)) id(n).hidden=!f}
function toast(msg,kind){const w=id("toasts");if(!w)return;const d=document.createElement("div");d.className="toast "+(kind||"");d.textContent=msg;w.appendChild(d);setTimeout(()=>d.style.opacity="0",1600);setTimeout(()=>{try{w.removeChild(d)}catch(_){}},2200)}
function num(v){const s=String(v||"").replace(/\./g,"").replace(",",".");const n=Number(s);return Number.isFinite(n)?n:0}
function moneyInputLive(){
document.addEventListener("input",e=>{
const t=e.target;if(!t.matches||!t.matches("input[data-money]"))return;
const digits=(t.value||"").replace(/[^\d]/g,"");t.value=digits?fmtN0.format(+digits):"";
});
document.addEventListener("blur",e=>{
const t=e.target;if(!t.matches||!t.matches("input[data-money]"))return;
t.value=num(t.value)?fmtN0.format(num(t.value)):"";
},true);
}

/* ====== Localidades AST ====== */
const AST=["Allande","Aller","Amieva","Avilés","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo","Cangas de Onís","Cangas del Narcea","Caravia","Carreño","Caso","Castrillón","Castropol","Coaña","Colunga","Corvera de Asturias","Cudillero","Degaña","Franco (El)","Gijón","Gozón","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo","Laviana","Lena","Llanera","Llanes","Mieres","Morcín","Muros de Nalón","Nava","Navia","Noreña","Onís","Oviedo","Parres","Peñamellera Alta","Peñamellera Baja","Pesoz","Piloña","Ponga","Pravia","Proaza","Quirós","Regueras (Las)","Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San Martín del Rey Aurelio","San Martín de Oscos","San Tirso de Abres","Santa Eulalia de Oscos","Santo Adriano","Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","Valdés","Vegadeo","Villanueva de Oscos","Villaviciosa"];
function fillLocalidades(){const sel=id("e_loc");sel.innerHTML="";AST.forEach(n=>{const o=document.createElement("option");o.textContent=n;sel.appendChild(o)})}

/* ====== Helpers autocalculables (marcado manual) ====== */
function markManualOnEdit(ids){
ids.forEach(x=>{
const el=id(x);
el?.addEventListener('input',()=>{el.removeAttribute('data-auto')});
el?.addEventListener('change',()=>{el.removeAttribute('data-auto')});
});
}
function setAutoIfAllowed(idField, val){
const el=id(idField); if(!el) return;
if(!el.hasAttribute('data-auto')) el.setAttribute('data-auto','1');
if(el.getAttribute('data-auto')==='1'){ el.value=fmtN0.format(Math.round(val)); }
}

/* ====== Semáforo & gráfico ====== */
function score(val,goal,kind){ if(kind==='eur'){ if(val>=goal) return 'green'; if(val>=goal*0.9) return 'amber'; return 'red'; } if(val>=goal) return 'green'; if(val>=goal-1) return 'amber'; return 'red'; }
function paintDot(dot,color){const el=id(dot); if(el) el.className='dot '+color}
function diff(val,goal,suf){const d=Math.round((val-goal)*10)/10; if(d===0) return '(= objetivo)'; const s=d>0?'+':''; return '('+s+fmtN1.format(d)+' '+suf+')'}
function drawChart(cid,data){
const c=id(cid); if(!c) return; const x=c.getContext('2d');
x.clearRect(0,0,c.width,c.height);
const pad=24,W=c.width-pad*2,H=c.height-pad*2;
x.strokeStyle="#e5e7eb"; x.strokeRect(pad,pad,W,H);
const maxv=Math.max(1,data.kpi,data.goal);
const kH=(data.kpi/maxv)*H;
x.fillStyle="#ff6a3d"; x.fillRect(pad+40,pad+(H-kH),60,kH);
const yGoal=pad+(H-(data.goal/maxv)*H);
x.strokeStyle="#111827"; x.setLineDash([6,6]); x.beginPath(); x.moveTo(pad+10,yGoal); x.lineTo(pad+W-10,yGoal); x.stroke(); x.setLineDash([]);
x.fillStyle="#111827"; x.font="12px Inter,Arial"; x.fillText(data.label,pad+20,pad+H+16);
}

/* ====== Cálculo de Pmáx para objetivos ====== */
function pmaxParaObjetivoBruta(annual, cfg, notaria, honor, reforma){
// bruta = annual / inv * 100 => inv = annual*100/goal
const goal = (val('e_tipo')==='Habitaciones')?cfg.goals.bruta_hab:cfg.goals.bruta_trad;
if(goal<=0) return 0;
const invNecesario = (annual*100)/goal;
// inv = P + ITP(P) + notaria + honor + reforma = P*(1+itp%) + K
const K = notaria + honor + reforma;
const P = (invNecesario - K) / (1 + cfg.itpPct/100);
return Math.max(0, Math.floor(P));
}
function pmaxParaObjetivoNeta(annual, gastosAnuales, cfg, notaria, honor, reforma){
// neta = (annual - gastos) / inv * 100 => inv = (annual - gastos)*100/goal
const goal = (val('e_tipo')==='Habitaciones')?cfg.goals.neta_hab:cfg.goals.neta_trad;
if(goal<=0) return 0;
const margen = annual - gastosAnuales;
if(margen<=0) return 0;
const invNecesario = (margen*100)/goal;
const K = notaria + honor + reforma;
const P = (invNecesario - K) / (1 + cfg.itpPct/100);
return Math.max(0, Math.floor(P));
}

/* ====== Calcular ====== */
function calcular(){
const cfg=cfgOrDefaults();
const tipo=val('e_tipo');

const precio=num(val('e_precio'));
const NOT=cfg.notaria;
const honorSi=val('e_honor')==='si';
const HON=honorSi?cfg.honorIVA:0;
const ref=num(val('e_reforma'));
const ITP=Math.round(precio*(cfg.itpPct/100));

setv('e_itp_eur',fmtN0.format(ITP));
setv('e_notaria',fmtN0.format(NOT));

const invTotal=precio+ITP+NOT+HON+ref;
text('r_inv',fmtN0.format(invTotal)+' €');

const alq=num(val('e_alq'));
const otros=num(val('e_otros'));
const anual=(alq+otros)*12;

// autogastos (mientras no se toquen a mano)
const hogar = anual*(cfg.hogarPct/100);
const impago= anual*((tipo==='Habitaciones'?cfg.impagoHab:cfg.impagoTrad)/100);
const gestion= anual*((tipo==='Habitaciones'?cfg.gestHab:cfg.gestTrad)/100);
setAutoIfAllowed('e_hogar',hogar);
setAutoIfAllowed('e_impago',impago);
setAutoIfAllowed('e_gestion',gestion);

const comunidad=num(val('e_comunidad'));
const ibi=num(val('e_ibi'));
const G_hogar=num(val('e_hogar'));
const G_impago=num(val('e_impago'));
const G_gestion=num(val('e_gestion'));
const gastosAnuales=comunidad+ibi+G_hogar+G_impago+G_gestion;

const bruta=invTotal>0?(anual/invTotal)*100:0;
const neta =invTotal>0?((anual-gastosAnuales)/invTotal)*100:0;
const flujo=(anual-gastosAnuales);

text('r_bruta',fmtN1.format(bruta)+' %');
text('r_neta', fmtN1.format(neta)+' %');
text('r_flujo',fmtN0.format(Math.round(flujo))+' €');

const g=cfg.goals;
const gbr=(tipo==='Habitaciones')?g.bruta_hab:g.bruta_trad;
const gne=(tipo==='Habitaciones')?g.neta_hab:g.neta_trad;
const gfl=(tipo==='Habitaciones')?g.flujo_hab:g.flujo_trad;

paintDot('sb',score(bruta,gbr,'pct'));
paintDot('sn',score(neta,gne,'pct'));
paintDot('sf',score(flujo,gfl,'eur'));
text('r_bruta_diff',diff(bruta,gbr,'%'));
text('r_neta_diff', diff(neta ,gne ,'%'));

// === NUEVO: Pmáx para alcanzar objetivos ===
const P_bruta = pmaxParaObjetivoBruta(anual,cfg,NOT,HON,ref);
const P_neta = pmaxParaObjetivoNeta(annual,gastosAnuales,cfg,NOT,HON,ref);
const P_usado = Math.min(P_bruta||Infinity, P_neta||Infinity);
const P_final = Number.isFinite(P_usado)?P_usado:0;

setv('e_pmax',fmtN0.format(P_final));
text('r_pmax',fmtN0.format(P_final)+' €');

drawChart('chartKPI',{kpi:bruta,goal:gbr,label:'Rent. bruta %'});

renderCandidates(tipo,val('e_loc'),invTotal,anual,bruta,neta,flujo);
show('e_result',true);
}

/* ====== Candidatos (match básico) ====== */
function renderCandidates(tipo,loc,costeTotal,anual,bruta,neta,flujo){
const list=id('matchList'); const sel=id('assign_cli');
const pros=Store.pros||[];
const matches=pros.filter(p=>{
if(p.pref_tipo && p.pref_tipo!==tipo) return false;
if(p.locs_text){
const want=String(p.locs_text).toLowerCase().split(',').map(s=>s.trim());
const aqui=String(loc||'').toLowerCase();
if(want.length && !want.some(w=>w && aqui.includes(w))) return false;
}
if(p.budget && costeTotal>p.budget*1.1) return false;
if(p.reforma && p.reforma!=='Indiferente'){
const need=val('e_reforma_tipo')||'No';
if(p.reforma!==need && p.reforma!=='Indiferente') return false;
}
return true;
});
if(!matches.length){list.textContent='Sin clientes potenciales para este activo.'; sel.innerHTML=''; return;}
list.textContent=matches.map(m=>`${m.nombre||'—'} · ${m.pref_tipo||'—'} · ${m.locs_text||''}`).join(' | ');
sel.innerHTML=matches.map((m,i)=>`<option value="${m.id||('p'+i)}">${m.nombre||'—'} — ${m.pref_tipo||'—'}</option>`).join('');
}

/* ====== Guardar evaluación ====== */
function parseNumText(t){return num(String(t||'').replace(/[^\d.,-]/g,''))}
function buildEval(){
const now=new Date();
return {
id:'ev_'+now.getTime(), ts:now.toISOString(),
loc:val('e_loc'),calle:val('e_calle'),url:val('e_url'),
m2:num(val('e_m2')),anio:num(val('e_anio')),asc:val('e_asc'),
alt:num(val('e_alt')),bajo:val('e_bajo'),habs:num(val('e_habs')),banos:num(val('e_banos')),
reforma:val('e_reforma_tipo'),
tipo:val('e_tipo'), precio:num(val('e_precio')), itp:num(val('e_itp_eur')), notaria:num(val('e_notaria')),
reforma_eur:num(val('e_reforma')), honor_incl:val('e_honor')==='si',
comunidad:num(val('e_comunidad')), ibi:num(val('e_ibi')), hogar:num(val('e_hogar')),
impago:num(val('e_impago')), gestion:num(val('e_gestion')),
alq:num(val('e_alq')), otros:num(val('e_otros')),
inv_total:parseNumText(id('r_inv')?.textContent), pmax:num(val('e_pmax')),
kpi_bruta:parseNumText(id('r_bruta')?.textContent), kpi_neta:parseNumText(id('r_neta')?.textContent), kpi_flujo:parseNumText(id('r_flujo')?.textContent),
prospect_ids:[]
};
}
function saveEval(assign){
const ev=buildEval(); const list=Store.evals||[];
if(assign){const sel=id('assign_cli'); if(sel && sel.selectedOptions?.length){ev.prospect_ids=Array.from(sel.selectedOptions).map(o=>o.value)}}
list.unshift(ev); Store.evals=list; toast(assign?'Guardado y asignado':'Guardado','ok');
}

/* ====== Eventos ====== */
function attach(){
moneyInputLive();
fillLocalidades();
markManualOnEdit(['e_hogar','e_impago','e_gestion']);

// Reacción al precio → ITP/Notaría
id('e_precio').addEventListener('input',()=>{const c=cfgOrDefaults(); setv('e_itp_eur',fmtN0.format(Math.round(num(val('e_precio'))*(c.itpPct/100)))); setv('e_notaria',fmtN0.format(c.notaria));});

// Reacción al alquiler/tipo → gastos auto
const recalcVars=()=>{const c=cfgOrDefaults(); const t=val('e_tipo'); const anual=(num(val('e_alq'))+num(val('e_otros')))*12;
setAutoIfAllowed('e_hogar', anual*(c.hogarPct/100));
setAutoIfAllowed('e_impago', anual*((t==='Habitaciones'?c.impagoHab:c.impagoTrad)/100));
setAutoIfAllowed('e_gestion',anual*((t==='Habitaciones'?c.gestHab:c.gestTrad)/100));
};
['e_alq','e_otros','e_tipo'].forEach(k=>id(k).addEventListener('input',recalcVars));
id('e_tipo').addEventListener('change',recalcVars);

id('e_calc').addEventListener('click',calcular);
id('e_clean').addEventListener('click',()=>{document.querySelectorAll('input').forEach(i=>{if(i.id!=='e_notaria'&&i.id!=='e_itp_eur')i.value=''; i.setAttribute('data-auto','1');}); id('e_honor').value='si'; id('e_tipo').value='Tradicional'; show('e_result',false); toast('Formulario limpiado','ok'); recalcVars();});
id('save_only')?.addEventListener('click',()=>saveEval(false));
id('save_assign')?.addEventListener('click',()=>saveEval(true));

// Autocalcular gastos si ya hay alquiler
recalcVars();
}

document.addEventListener('DOMContentLoaded',()=>{try{attach()}catch(e){console.error(e);toast('Error inicializando','bad')}});

})();
</script>
</body>
</html>
