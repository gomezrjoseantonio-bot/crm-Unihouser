<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
  .green{background:#16a34a}.yellow{background:#f59e0b}.red{background:#ef4444}
  .kpis3{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
  .kpi .lab{color:#667085;font-size:12px}
  .kpi .val{font-weight:800}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .muted{color:#667085}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- Datos del inmueble -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="grid3">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>

      <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
      <div class="field"><label>Necesita reforma</label><select id="e_reforma_tipo"><option>No</option><option>Lavado de cara</option><option>Integral</option></select></div>

      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
      <div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>

      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
      <div></div>
    </div>
  </div>

  <!-- Gastos de adquisición -->
  <div class="section">
    <h3>Gastos de adquisición</h3>
    <div class="grid3">
      <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (€ — auto)</label><input id="e_itp_eur" data-money disabled></div>
      <div class="field"><label>Notaría y Registro (€ — auto)</label><input id="e_notaria" data-money disabled></div>

      <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (con IVA)</label><select id="e_incluir_psi"><option value="si">Sí</option><option value="no">No</option></select></div>
      <div class="field"><label>Precio máx. compra (para cumplir BRUTA objetivo)</label><input id="e_pmax" data-money disabled></div>
    </div>
    <div class="muted" style="margin-top:6px">El objetivo BRUTA se toma de Configuración según tipo (Tradicional/Habitaciones).</div>
  </div>

  <!-- Gastos de mantenimiento -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="grid3">
      <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>

      <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
      <div></div>
    </div>
    <div class="muted" style="margin-top:6px">Hogar/impago/gestión se autocalculan al fijar el alquiler, según Configuración. Editables.</div>
  </div>

  <!-- Explotación -->
  <div class="section">
    <h3>Tipo de explotación e ingresos</h3>
    <div class="grid3">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
      <div class="field"><label>Otros ingresos (€/mes) — opcional</label><input id="e_otros" value="0" data-money></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_clean">Limpiar</button>
    <button class="btn" id="save_only">Guardar evaluación</button>
  </div>

  <!-- Resultados -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis3">
      <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">—</span> <span id="r_bruta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">—</span> <span id="r_neta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">—</div></div>
      <div class="kpi"><div class="lab">Precio máx. de compra</div><div class="val" id="r_pmax">—</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div class="grid3" id="matchCols"><div></div><div></div><div></div></div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
const id = s=>document.getElementById(s);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0  = v=>fmtE0.format(Number(v||0));
const n0  = v=>fmtN0.format(Number(v||0));
const pct = v=>fmtN1.format(Number(v||0))+' %';
const esc = s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function parseEs(str){ if(str==null) return 0; const s=String(str).trim().replace(/\./g,'').replace(',', '.'); const n=Number(s); return Number.isFinite(n)?n:0; }
function setMoney(inp, v){ inp.value = n0(Math.round(Number(v||0))); }
function setDot(el, color){ el.classList.remove('green','yellow','red'); el.classList.add(color); }
function goalDot(val, goal){ if(val>=goal) return 'green'; if(val>=goal*0.9) return 'yellow'; return 'red'; }

/* ===== Store ===== */
const Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}} },
  set cfg(v){ localStorage.setItem('cfg', JSON.stringify(v)); },
  get pros(){ try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]} },
  set pros(v){ localStorage.setItem('pros', JSON.stringify(v)); },
  get evals(){ try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]} },
  set evals(v){ localStorage.setItem('evals', JSON.stringify(v)); }
};

/* ===== Localidades ===== */
const LOCS = ["Allande","Avilés","Cangas","Gijón","Langreo","Llanera","Mieres","Oviedo","Siero","Villaviciosa"];

/* ===== Cargar selects y listeners ===== */
function mount(){
  // localidades
  const sel = id('e_loc'); sel.innerHTML = LOCS.map(x=><option>${x}</option>).join('');
  // formato dinero live
  document.querySelectorAll('input[data-money]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value = n0(digits);
    });
    inp.addEventListener('blur', ()=>{ setMoney(inp, parseEs(inp.value)); });
  });

  // autocalcular al cambiar precio / tipo / alquiler
  id('e_precio').addEventListener('input', autoAdquisicion);
  id('e_tipo').addEventListener('change', ()=>{ autoMantenimiento(); recalcPmax(); });
  id('e_alq').addEventListener('input', ()=>{ autoMantenimiento(); recalcPmax(); });

  id('e_calc').addEventListener('click', calcular);
  id('e_clean').addEventListener('click', limpiar);
  id('save_only').addEventListener('click', guardar);

  // precarga desde Evaluaciones
  preloadFromEvaluaciones();

  // arranque: poner notaría e itp base
  autoAdquisicion();
}

/* ===== Config con defaults ===== */
function CFG(){
  const c = Store.cfg || {};
  return {
    itp_pct: Number(c.itp_pct ?? 8),
    notaria_eur: Number(c.notaria_eur ?? 1500),
    psi_eur: Number(c.psi_eur ?? 4235),
    hogar_pct: Number(c.hogar_pct ?? 2),
    impago_pct_trad: Number(c.impago_pct_trad ?? 0),
    impago_pct_rooms: Number(c.impago_pct_rooms ?? 3),
    gestion_pct_trad: Number(c.gestion_pct_trad ?? 0),
    gestion_pct_rooms: Number(c.gestion_pct_rooms ?? 9),
    obj_bruta_trad: Number(c.obj_bruta_trad ?? 10),
    obj_bruta_rooms: Number(c.obj_bruta_rooms ?? 12),
    obj_neta_trad: Number(c.obj_neta_trad ?? 7.5),
    obj_neta_rooms: Number(c.obj_neta_rooms ?? 8.5)
  };
}

/* ===== Auto: ITP y Notaría ===== */
function autoAdquisicion(){
  const cfg = CFG();
  const precio = parseEs(id('e_precio').value);
  const itp = Math.round(precio * cfg.itp_pct/100);
  setMoney(id('e_itp_eur'), itp);
  setMoney(id('e_notaria'), cfg.notaria_eur);
  recalcPmax();
}

/* ===== Auto: hogar/impago/gestión al teclear alquiler ===== */
function autoMantenimiento(){
  const cfg = CFG();
  const tipo = id('e_tipo').value;
  const alq = parseEs(id('e_alq').value);

  const anual = alq*12 + parseEs(id('e_otros').value)*12;
  const hogar = Math.round(anual * (cfg.hogar_pct/100));
  const impago = Math.round(anual * ((tipo==='Tradicional'? cfg.impago_pct_trad: cfg.impago_pct_rooms)/100));
  const gestion = Math.round(anual * ((tipo==='Tradicional'? cfg.gestion_pct_trad: cfg.gestion_pct_rooms)/100));

  if(!isNaN(hogar)) setMoney(id('e_hogar'), hogar);
  if(!isNaN(impago)) setMoney(id('e_impago'), impago);
  if(!isNaN(gestion)) setMoney(id('e_gestion'), gestion);
}

/* ===== Precio máximo para cumplir BRUTA objetivo ===== */
function recalcPmax(){
  const cfg = CFG();
  const tipo = id('e_tipo').value;
  const goal = (tipo==='Tradicional'? cfg.obj_bruta_trad : cfg.obj_bruta_rooms) / 100;

  const alq = parseEs(id('e_alq').value);
  const otros = parseEs(id('e_otros').value);
  const ingresoAnual = (alq+otros)*12;

  const notaria = parseEs(id('e_notaria').value) || cfg.notaria_eur;
  const reforma = parseEs(id('e_reforma').value);
  const incluyePSI = id('e_incluir_psi').value==='si';
  const psi = incluyePSI ? cfg.psi_eur : 0;

  const itp_pct = cfg.itp_pct/100;
  // Resolviendo: ingreso / ( P*(1+itp_pct) + C ) = goal  ->  P = (ingreso/goal - C)/(1+itp_pct)
  const C = notaria + reforma + psi;
  const brutoObjetivoTotal = ingresoAnual/goal;
  const pmax = Math.max(0, Math.floor( (brutoObjetivoTotal - C) / (1+itp_pct) ));

  setMoney(id('e_pmax'), pmax);
}

/* ===== Calcular KPIs ===== */
function calcular(){
  const cfg = CFG();
  const precio = parseEs(id('e_precio').value);
  const itp = parseEs(id('e_itp_eur').value) || Math.round(precio*cfg.itp_pct/100);
  const notaria = parseEs(id('e_notaria').value) || cfg.notaria_eur;
  const reforma = parseEs(id('e_reforma').value);
  const incluyePSI = id('e_incluir_psi').value==='si';
  const psi = incluyePSI ? cfg.psi_eur : 0;

  const comunidad = parseEs(id('e_comunidad').value);
  const ibi = parseEs(id('e_ibi').value);
  const hogar = parseEs(id('e_hogar').value);
  const impago = parseEs(id('e_impago').value);
  const gestion = parseEs(id('e_gestion').value);

  const alq = parseEs(id('e_alq').value);
  const otros = parseEs(id('e_otros').value);

  const inversion = precio + itp + notaria + reforma + psi;
  const ingresoAnual = (alq+otros)*12;
  const gastosAnuales = comunidad + ibi + hogar + impago + gestion;

  const bruta = inversion>0 ? (ingresoAnual/inversion)*100 : 0;
  const neta  = inversion>0 ? ((ingresoAnual-gastosAnuales)/inversion)*100 : 0;
  const flujo = Math.max(0, ingresoAnual - gastosAnuales);

  const tipo = id('e_tipo').value;
  const gB = (tipo==='Tradicional'? cfg.obj_bruta_trad : cfg.obj_bruta_rooms);
  const gN = (tipo==='Tradicional'? cfg.obj_neta_trad  : cfg.obj_neta_rooms);

  // pintar
  id('e_result').hidden=false;
  id('r_inv').textContent = e0(inversion);
  id('r_bruta').textContent = pct(bruta);
  id('r_neta').textContent = pct(neta);
  id('r_flujo').textContent = e0(flujo);
  id('r_pmax').textContent = id('e_pmax').value? id('e_pmax').value+' €' : e0(0);

  const diffB = bruta - gB, diffN = neta - gN;
  id('r_bruta_diff').textContent = (diffB>=0? ' (+':' (') + fmtN1.format(diffB) + ' p.p.)';
  id('r_neta_diff').textContent  = (diffN>=0? ' (+':' (') + fmtN1.format(diffN) + ' p.p.)';

  setDot(id('sb'), goalDot(bruta, gB));
  setDot(id('sn'), goalDot(neta, gN));
  setDot(id('sf'), flujo>0 ? 'green' : 'red');

  // sugerencias de clientes (tres columnas)
  sugerirClientes({bruta, neta, flujo});
}

/* ===== Sugerencias de clientes (muy ligeras) ===== */
function sugerirClientes(kpi){
  const pros = Store.pros || [];
  const tipo = id('e_tipo').value;
  const loc = id('e_loc').value;

  const cols = id('matchCols').children;
  for(const c of cols) c.innerHTML='';

  const packs = [
    {key:'bruta', goal: (tipo==='Tradicional'? CFG().obj_bruta_trad : CFG().obj_bruta_rooms), box: cols[0], label:'Bruta %'},
    {key:'neta',  goal: (tipo==='Tradicional'? CFG().obj_neta_trad  : CFG().obj_neta_rooms),  box: cols[1], label:'Neta %'},
    {key:'flujo', goal: 0, box: cols[2], label:'Flujo anual'}
  ];

  packs.forEach(p=>{
    const wrap = document.createElement('div');
    wrap.className='card'; wrap.style.margin=0;
    wrap.innerHTML = <h4 style="margin:0 0 6px">${p.label}</h4><div class="muted" style="margin-bottom:6px">Objetivo: ${p.key==='flujo'? 'positivo' : fmtN1.format(p.goal)+' %'}</div>;
    const list = document.createElement('div');

    const matches = pros.filter(x=>{
      // tipo y localidad “soft”
      const okTipo = !x.pref_tipo || x.pref_tipo===tipo;
      const okLoc  = !x.locs_text || x.locs_text.toLowerCase().includes(loc.toLowerCase());
      return okTipo && okLoc;
    });

    if(!matches.length){ list.textContent='Sin clientes potenciales'; }
    else{
      matches.forEach(x=>{
        const diff = p.key==='flujo' ? kpi.flujo : (p.key==='bruta'? kpi.bruta : kpi.neta) - (p.key==='bruta'? p.goal : p.key==='neta'? p.goal : 0);
        const ok = p.key==='flujo' ? (kpi.flujo>0) : ((p.key==='bruta'? kpi.bruta : kpi.neta) >= p.goal);
        const dot = ok? '🟢':'🟡';
        const dv  = p.key==='flujo' ? e0(kpi.flujo) : (fmtN1.format(Math.abs(diff))+' p.p.');
        const row = document.createElement('div');
        row.className='uh-kv';
        row.innerHTML = <div class="k">${dot} ${(x.nombre||'—')}</div><div class="v">${ok? '+':''}${dv}</div>;
        list.appendChild(row);
      });
    }
    wrap.appendChild(list);
    p.box.appendChild(wrap);
  });
}

/* ===== Guardar evaluación ===== */
function buildEval(){
  const nowId = 'ev_'+Date.now();
  return {
    id: nowId, ts: Date.now(),
    loc: id('e_loc').value, calle: id('e_calle').value, url: id('e_url').value||'',
    tipo: id('e_tipo').value,
    precio: parseEs(id('e_precio').value),
    itp: parseEs(id('e_itp_eur').value),
    notaria: parseEs(id('e_notaria').value),
    reforma: parseEs(id('e_reforma').value),
    incluir_psi: id('e_incluir_psi').value==='si',
    comunidad: parseEs(id('e_comunidad').value),
    ibi: parseEs(id('e_ibi').value),
    hogar: parseEs(id('e_hogar').value),
    impago: parseEs(id('e_impago').value),
    gestion: parseEs(id('e_gestion').value),
    alq: parseEs(id('e_alq').value),
    otros: parseEs(id('e_otros').value),
    // KPIs actuales pintados
    kpi_bruta: Number((id('r_bruta').textContent||'').replace(/[^\d,.-]/g,'').replace(',', '.'))||0,
    kpi_neta:  Number((id('r_neta').textContent||'').replace(/[^\d,.-]/g,'').replace(',', '.'))||0,
    kpi_flujo: parseEs(id('r_flujo').textContent),
    pmax: parseEs(id('e_pmax').value||id('r_pmax').textContent),
    inv_total: parseEs(id('r_inv').textContent),
    prospect_ids: []
  };
}
function guardar(){
  if(id('e_result').hidden){ calcular(); } // por si no se calculó antes
  const list = Store.evals || [];
  const ev = buildEval();
  list.push(ev);
  Store.evals = list;
  alert('Evaluación guardada');
}

/* ===== Precarga si viene de Evaluaciones ===== */
function preloadFromEvaluaciones(){
  try{
    const url = new URL(location.href);
    const qid = url.searchParams.get('id');
    const mem = localStorage.getItem('_load_eval_');
    const idToLoad = qid || (mem||'').replace(/"/g,'');
    if(!idToLoad) return;

    const e = (Store.evals||[]).find(x=>x.id===idToLoad);
    if(!e) return;

    id('e_loc').value = e.loc||LOCS[0];
    id('e_calle').value = e.calle||'';
    id('e_url').value = e.url||'';
    id('e_tipo').value = e.tipo||'Tradicional';

    setMoney(id('e_precio'), e.precio);
    setMoney(id('e_itp_eur'), e.itp);
    setMoney(id('e_notaria'), e.notaria);
    setMoney(id('e_reforma'), e.reforma);
    id('e_incluir_psi').value = e.incluir_psi? 'si':'no';

    setMoney(id('e_comunidad'), e.comunidad);
    setMoney(id('e_ibi'), e.ibi);
    setMoney(id('e_hogar'), e.hogar);
    setMoney(id('e_impago'), e.impago);
    setMoney(id('e_gestion'), e.gestion);

    setMoney(id('e_alq'), e.alq);
    setMoney(id('e_otros'), e.otros);

    // recalcular y mostrar
    autoMantenimiento(); autoAdquisicion(); calcular();
    localStorage.removeItem('_load_eval_'); // limpiar
  }catch(_){}
}

/* ===== Limpiar ===== */
function limpiar(){
  document.querySelectorAll('input').forEach(i=>{ if(i.id!=='e_notaria' && i.id!=='e_itp_eur') i.value=''; });
  id('e_incluir_psi').value='si';
  id('e_tipo').value='Tradicional';
  autoAdquisicion();
  id('e_result').hidden=true;
}

document.addEventListener('DOMContentLoaded', mount);
})();
</script>
</body>
</html>
