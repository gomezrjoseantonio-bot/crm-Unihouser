<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser â€” Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* Dots KPIs */
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
.dot.g{background:#16a34a}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
.small{font-size:12px;color:#667085}
.kpi .muted{color:#667085;font-weight:600;margin-left:6px}
/* Canvas caja blanca */
.canvasWrap{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
/* Grid 3 columnas responsive */
.group3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
@media(max-width:1000px){.group3{grid-template-columns:1fr}}
/* Matching UI */
#matchWrap{display:grid;gap:8px}
.match-col{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
.match-col h4{margin:0 0 8px}
.tag{display:inline-flex;align-items:center;gap:6px;background:#eef2f7;border-radius:999px;padding:4px 10px;margin:3px 4px;font-size:12px}
.badge-warn{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#b45309;background:#fff7ed;border:1px solid #fde68a;border-radius:999px;padding:2px 6px}
.badge-warn svg{width:12px;height:12px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser â€” CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">ConfiguraciÃ³n</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- DATOS DEL INMUEBLE -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="row three">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>Superficie (mÂ²) â€” opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
    </div>
    <div class="row three">
      <div class="field"><label>AÃ±o construcciÃ³n â€” opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Ascensor</label><select id="e_asc"><option>SÃ­</option><option>No</option></select></div>
      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Â¿Es bajo?</label><select id="e_bajo"><option>No</option><option>SÃ­</option></select></div>
      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>BaÃ±os</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Necesita reforma</label>
        <select id="e_ref_nec">
          <option value="no">No</option>
          <option value="lavado">Lavado de cara</option>
          <option value="integral">Reforma integral</option>
        </select>
      </div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>
      <div class="field"></div>
    </div>
  </div>

  <!-- GASTOS DE ADQUISICIÃ“N -->
  <div class="section">
    <h3>Gastos de adquisiciÃ³n</h3>
    <div class="row three">
      <div class="field"><label>Precio de compra (â‚¬)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (â‚¬ auto)</label><input id="e_itp_eur" data-money></div>
      <div class="field"><label>NotarÃ­a y Registro (â‚¬ auto)</label><input id="e_notaria" data-money></div>
    </div>
    <div class="row three">
      <div class="field"><label>Reforma (â‚¬)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (â‚¬)</label>
        <select id="e_honor"><option value="si">SÃ­</option><option value="no" selected>No</option></select>
      </div>
      <div class="field"><label>Precio mÃ¡x. de compra (objetivo bruta)</label><input id="e_pmax" data-money disabled></div>
    </div>
  </div>

  <!-- GASTOS DE MANTENIMIENTO -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="row three">
      <div class="field"><label>Comunidad (â‚¬/aÃ±o)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (â‚¬/aÃ±o)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (â‚¬/aÃ±o â€” auto)</label><input id="e_hogar" value="0" data-money></div>
    </div>
    <div class="row three">
      <div class="field"><label>Seguro impago (â‚¬/aÃ±o â€” auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>GestiÃ³n (â‚¬/aÃ±o â€” auto)</label><input id="e_gestion" value="0" data-money></div>
      <div class="field"><small class="hint">Hogar/impago/gestiÃ³n se autocalculan desde Config al indicar alquiler (editables).</small></div>
    </div>
  </div>

  <!-- EXPLOTACIÃ“N E INGRESOS -->
  <div class="section">
    <h3>Tipo de explotaciÃ³n e ingresos</h3>
    <div class="row three">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (â‚¬)</label><input id="e_alq" data-money></div>
      <div class="field"></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_save">Guardar</button>
    <button class="btn" id="e_save_assign">Guardar y asignar</button>
    <button class="btn ghost" id="e_clean">Limpiar</button>
  </div>

  <!-- RESULTADOS -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis">
      <div class="kpi"><div class="lab">InversiÃ³n total</div><div class="val" id="r_inv">â€”</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">â€”</span><span id="r_bruta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">â€”</span><span id="r_neta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">â€”</div></div>
      <div class="kpi"><div class="lab">Precio mÃ¡x. de compra</div><div class="val" id="r_pmax">â€”</div></div>
    </div>

    <div class="canvasWrap" style="margin-top:10px">
      <canvas id="chartKPI" width="540" height="220"></canvas>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div id="matchWrap" class="group3">
        <div class="match-col"><h4>Bruta â‰¥ objetivo</h4><div id="m_bruta">â€”</div></div>
        <div class="match-col"><h4>Neta â‰¥ objetivo</h4><div id="m_neta">â€”</div></div>
        <div class="match-col"><h4>Flujo â‰¥ objetivo</h4><div id="m_flujo">â€”</div></div>
      </div>
      <div class="actions" style="margin-top:8px">
        <select id="assign_cli" size="6" style="min-width:320px"></select>
        <button class="btn" id="save_only">Guardar evaluaciÃ³n</button>
        <button class="btn primary" id="save_assign">Guardar y asignar</button>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">Â© 2025 Unihouser Â· unihouser.es Â· info@unihouser.es Â· 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ========= Utilidades ========= */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES', { style:'currency', currency:'EUR', maximumFractionDigits:0 });
const fmtN0 = new Intl.NumberFormat('es-ES', { maximumFractionDigits:0 });
const fmtN1 = new Intl.NumberFormat('es-ES', { maximumFractionDigits:1 });
const e0 = v => fmtE0.format(Number(v||0));
const n0 = v => fmtN0.format(Number(v||0));
const pct1 = v => fmtN1.format(Number(v||0))+' %';
function parseEs(str){
  if(str==null) return 0;
  const s=String(str).trim().replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
  const n=Number(s); return Number.isFinite(n)? n : 0;
}
function fold(s){
  return (s??'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
}
function num(x){ const n=Number(x); return Number.isFinite(n)?n:0; }

function moneyLive(){
  document.querySelectorAll('input[data-money]').forEach(inp=>{
    inp.addEventListener('input',()=>{
      const digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
    });
    inp.addEventListener('blur',()=>{
      const n = Math.round(parseEs(inp.value));
      inp.value = n? n0(n) : '';
    });
  });
}
function toast(msg,kind){
  const wrap = document.getElementById('toasts') || (()=>{const d=document.createElement('div');d.id='toasts';d.className='toast-wrap';document.body.appendChild(d);return d;})();
  const el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(()=>el.style.opacity='0',1600);
  setTimeout(()=>{ try{wrap.removeChild(el)}catch(_){}} ,2200);
}

/* ========= Store ========= */
const Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}} },
  set cfg(v){ localStorage.setItem('cfg', JSON.stringify(v)); },
  get pros(){ try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]} },
  set pros(v){ localStorage.setItem('pros', JSON.stringify(v)); },
  get evals(){ try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]} },
  set evals(v){ localStorage.setItem('evals', JSON.stringify(v)); }
};

/* ========= Localidades ========= */
const ASTURIAS = ["Allande","Aller","Amieva","AvilÃ©s","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo",
"Cangas de OnÃ­s","Cangas del Narcea","Caravia","CarreÃ±o","Caso","CastrillÃ³n","Castropol","CoaÃ±a","Colunga","Corvera de Asturias",
"Cudillero","DegaÃ±a","GijÃ³n","GozÃ³n","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo",
"Laviana","Lena","Llanera","Llanes","Mieres","MorcÃ­n","Muros de NalÃ³n","Nava","Navia","NoreÃ±a",
"OnÃ­s","Oviedo","Parres","PeÃ±amellera Alta","PeÃ±amellera Baja","Pesoz","PiloÃ±a","Pravia","Proaza","QuirÃ³s",
"Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San MartÃ­n de Oscos","San MartÃ­n del Rey Aurelio","San Tirso de Abres","Santa Eulalia de Oscos","Santo Adriano",
"Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","ValdÃ©s",
"Vegadeo","Villanueva de Oscos","Villaviciosa","VillayÃ³n","Todas"];
function loadLocalidades(){
  const s=id('e_loc'); s.innerHTML='';
  ASTURIAS.forEach(loc=>{
    const o=document.createElement('option'); o.textContent=loc; s.appendChild(o);
  });
}

/* ========= Config (con defaults) ========= */
function getCfg(){
  const c=Store.cfg||{};
  return {
    itp_pct: Number(c.itp_pct ?? 8),
    notaria_eur: Number(c.notaria_eur ?? 1500),
    psi_eur: Number(c.psi_fee_eur ?? 4235),
    hogar_pct: Number(c.hogar_pct ?? 3.5),
    impago_pct_trad: Number(c.impago_trad_pct ?? 4.0),
    impago_pct_hab: Number(c.impago_hab_pct ?? 4.0),
    gestion_pct_trad: Number(c.gestion_trad_pct ?? 15.0),
    gestion_pct_hab: Number(c.gestion_hab_pct ?? 25.0),
    obj_bruta_trad: Number((c.objetivos?.tradicional?.bruta_pct) ?? 10.0),
    obj_bruta_hab:  Number((c.objetivos?.habitaciones?.bruta_pct) ?? 12.0),
    obj_neta_trad:  Number((c.objetivos?.tradicional?.neta_pct) ?? 6.0),
    obj_neta_hab:   Number((c.objetivos?.habitaciones?.neta_pct) ?? 7.0)
  };
}

/* ========= AutocÃ¡lculos ========= */
function bindAuto(){
  const cfg=getCfg();
  const tipoEl=id('e_tipo');
  const alqEl=id('e_alq');
  const itpEl=id('e_itp_eur');
  const notEl=id('e_notaria');
  const precioEl=id('e_precio');

  const updPrecio=()=>{
    const precio=parseEs(precioEl.value);
    const itp=Math.round(precio*(cfg.itp_pct/100));
    itpEl.value = n0(itp);
    if(!parseEs(notEl.value)) notEl.value=n0(cfg.notaria_eur);
  };
  precioEl.addEventListener('input',updPrecio);
  precioEl.addEventListener('blur',updPrecio);

  const updAlq=()=>{
    const alq_m=parseEs(alqEl.value);
    const alq_a = alq_m*12;
    const tipo=(tipoEl.value||'Tradicional').toLowerCase();
    const impago_pct = (tipo==='habitaciones')? cfg.impago_pct_hab : cfg.impago_pct_trad;
    const gest_pct   = (tipo==='habitaciones')? cfg.gestion_pct_hab : cfg.gestion_pct_trad;

    const hogar   = Math.round(alq_a*(cfg.hogar_pct/100));
    const impago  = Math.round(alq_a*(impago_pct/100));
    const gestion = Math.round(alq_a*(gest_pct/100));

    id('e_hogar').value  = n0(hogar);
    id('e_impago').value = n0(impago);
    id('e_gestion').value= n0(gestion);
  };
  alqEl.addEventListener('input',updAlq);
  alqEl.addEventListener('blur',updAlq);
  tipoEl.addEventListener('change',updAlq);
}

/* ========= CÃ¡lculos financieros ========= */
function calc(){
  const cfg=getCfg();
  const tipo=(id('e_tipo').value||'Tradicional');
  const precio = parseEs(id('e_precio').value);
  const itp    = parseEs(id('e_itp_eur').value) || Math.round(precio*(cfg.itp_pct/100));
  const notari = parseEs(id('e_notaria').value) || cfg.notaria_eur;
  const ref    = parseEs(id('e_reforma').value);
  const honor  = (id('e_honor').value==='si') ? cfg.psi_eur : 0;

  const comu   = parseEs(id('e_comunidad').value);
  const ibi    = parseEs(id('e_ibi').value);
  const hogar  = parseEs(id('e_hogar').value);
  const impago = parseEs(id('e_impago').value);
  const gest   = parseEs(id('e_gestion').value);

  const alq_m  = parseEs(id('e_alq').value);
  const alq_a  = alq_m*12;

  const inv_total = precio + itp + notari + ref + honor;
  const gastos_a  = comu + ibi + hogar + impago + gest;

  const bruta = inv_total>0 ? (alq_a / inv_total * 100) : 0;
  const neta  = inv_total>0 ? ((alq_a - gastos_a) / inv_total * 100) : 0;
  const flujo = alq_a - gastos_a;

  const obj_bruta = (tipo==='Habitaciones')? cfg.obj_bruta_hab : cfg.obj_bruta_trad;
  const gapB = bruta - obj_bruta;
  const obj_neta = (tipo==='Habitaciones')? cfg.obj_neta_hab : cfg.obj_neta_trad;
  const gapN = neta - obj_neta;

  // Precio mÃ¡ximo para alcanzar objetivo bruta (con ITP)
  const rate = cfg.itp_pct/100;
  const targetInv = (obj_bruta>0)? (alq_a / (obj_bruta/100)) : 0;
  let pmax = 0;
  if(targetInv>0){
    const extras = (notari + ref + honor);
    pmax = Math.max(0, Math.floor((targetInv - extras) / (1+rate)));
  }

  // KPIs
  id('r_inv').textContent   = e0(inv_total);
  id('r_bruta').textContent = pct1(bruta);
  id('r_neta').textContent  = pct1(neta);
  id('r_flujo').textContent = e0(flujo);
  id('r_pmax').textContent  = e0(pmax);
  id('e_pmax').value        = n0(pmax);

  // Dots + diff
  paintDot('sb', gapB);
  paintDot('sn', gapN);
  paintDot('sf', flujo>=0? 1 : -1);
  id('r_bruta_diff').textContent = gapText(gapB);
  id('r_neta_diff').textContent  = gapText(gapN);

  // GrÃ¡fico
  drawChart(bruta, obj_bruta);

  // Sugerencias (con contexto para avisos)
  suggestProspects({
    tipo,
    loc: id('e_loc').value||'',
    bruta, neta, flujo,
    inv_total,
    ref_tip: id('e_ref_nec').value||'no',
    asc: id('e_asc').value||'SÃ­'
  });

  id('e_result').hidden=false;

  // objeto evaluaciÃ³n
  return {
    id: 'ev_'+Date.now(),
    ts: Date.now(),
    loc: id('e_loc').value || '',
    calle: id('e_calle').value || '',
    m2: id('e_m2').value || '',
    anio: id('e_anio').value || '',
    asc: id('e_asc').value || '',
    alt: id('e_alt').value || '',
    bajo: id('e_bajo').value || '',
    habs: id('e_habs').value || '',
    banos: id('e_banos').value || '',
    ref_tip: id('e_ref_nec').value || 'no',
    url: id('e_url').value || '',
    tipo,
    precio, itp, notaria:notari, psi: honor, reforma: ref,
    comu:comu, ibi:ibi, hogar:hogar, impago:impago, gestion:gest,
    alq: alq_m,
    inv_total, kpi_bruta: bruta, kpi_neta: neta, kpi_flujo: flujo,
    pmax
  };
}
function gapText(g){
  if(!isFinite(g)) return '';
  const s = (g>=0? '+' : 'âˆ’') + fmtN1.format(Math.abs(g)) + ' pts';
  return ' ('+s+')';
}
function paintDot(idDot, gap){
  const el=id(idDot); el.className='dot '+(gap>=0?'g':(gap>-1?'y':'r'));
}

/* ========= Mini chart ========= */
function drawChart(real, objetivo){
  const c=id('chartKPI'); const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const pad=36; const W=c.width, H=c.height;
  const max = Math.max( Math.ceil((Math.max(real, objetivo)+2)/2)*2 , 2);

  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  for(let y=0;y<=max;y+=2){
    const yy = H - pad - (H-2*pad)* (y/max);
    ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(W-pad,yy); ctx.stroke();
  }

  const barW=80;
  const realH=(H-2*pad)*(real/max);
  ctx.fillStyle='#ff5a1f';
  ctx.fillRect(W/2 - barW/2, H - pad - realH, barW, realH);

  const yObj = H - pad - (H-2*pad)*(objetivo/max);
  ctx.setLineDash([6,4]); ctx.strokeStyle='#9ca3af'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad, yObj); ctx.lineTo(W-pad, yObj); ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle='#111827'; ctx.font='12px Inter, Arial';
  ctx.fillText('Bruta real', W/2 - 30, H - 8);
  ctx.fillText('Objetivo', pad, yObj - 6);
}

/* ========= Matching prospects (tu esquema real) ========= */
function splitLocs(text){
  return (text||'').split(/[,;|Â·]/).map(fold).filter(Boolean);
}
function wantsNoReform(str){ return fold(str)==='no'; }
function prospectBudget(p){
  const a=num(String(p.max_compra||'').toString().replace(/[^\d]/g,'')); // tu campo real
  const b=num(String(p.budget||'').toString().replace(/[^\d]/g,''));     // alternativo
  return Math.max(a,b);
}
function warnBadges(p, ctx){
  const warns=[];
  const assetNeedsReform = (ctx.ref_tip && fold(ctx.ref_tip)!=='no');
  if(assetNeedsReform && wantsNoReform(p.reforma)){ warns.push({title:'No quiere inmuebles con reforma', icon:'ðŸš§'}); }
  const assetNoElevator = fold(ctx.asc)==='no';
  if(assetNoElevator && fold(p.asc)==='si'){ warns.push({title:'Requiere ascensor', icon:'ðŸ›—'}); }
  const budget = prospectBudget(p);
  if(budget>0 && Number(ctx.inv_total||0) > budget){ warns.push({title:'Excede su presupuesto mÃ¡ximo', icon:'ðŸ’°'}); }
  return warns;
}
function isSearching(p){ return fold(p.fase).includes('busc'); }

function suggestProspects(ctx){
  const list=Store.pros||[];
  const mB=id('m_bruta'), mN=id('m_neta'), mF=id('m_flujo');
  const asignSel=id('assign_cli');
  mB.innerHTML=mN.innerHTML=mF.innerHTML='â€”'; asignSel.innerHTML='';

  if(!list.length){ return; }

  const wantTipo = fold(ctx.tipo);
  const wantLoc  = fold(ctx.loc);

  const brutaOK=[], netaOK=[], flujoOK=[];
  const addOptionSet=new Set();

  list.forEach(p=>{
    if(!isSearching(p)) return;
    if(fold(p.pref_tipo)!==wantTipo) return;

    const locs=splitLocs(p.locs_text);
    if(!locs.includes(wantLoc)) return;

    const principal = fold(p.obj_tipo||p.obj_main||'');
    const raw = num(p.obj_raw);

    if(principal==='bruta' && raw>0 && Number(ctx.bruta) >= raw) brutaOK.push(p);
    if(principal==='neta'  && raw>0 && Number(ctx.neta)  >= raw) netaOK.push(p);
    if(principal==='flujo' && raw>0){
      const objetivoAnual = raw*12; // raw viene â‚¬/mes
      if(Number(ctx.flujo) >= objetivoAnual) flujoOK.push(p);
    }
  });

  const chip = (p, warns)=>{
    const span=document.createElement('span');
    span.className='tag';
    const name=document.createElement('span'); name.textContent=p.nombre||'-';
    span.appendChild(name);
    warns.forEach(w=>{
      const b=document.createElement('span'); b.className='badge-warn'; b.title=w.title;
      b.innerHTML='<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#b45309" stroke-width="1.2"/><path d="M12 7v6m0 4h.01" stroke="#b45309" stroke-width="1.6" stroke-linecap="round"/></svg>'+w.icon;
      span.appendChild(b);
    });
    return span;
  };

  const render = (arr, el)=>{
    if(!arr.length){ el.textContent='â€”'; return; }
    el.innerHTML='';
    arr.forEach(p=>{
      const warns = warnBadges(p, ctx);
      el.appendChild(chip(p, warns));
      const key=p.id||p.email||p.nombre||('p_'+Math.random().toString(36).slice(2,7));
      if(!addOptionSet.has(key)){ addOptionSet.add(key);
        const opt=document.createElement('option'); opt.value=key; opt.textContent=p.nombre||'-';
        asignSel.appendChild(opt);
      }
    });
  };

  render(brutaOK, mB);
  render(netaOK,  mN);
  render(flujoOK, mF);
}

/* ========= Guardar / Asignar ========= */
function gather(){ return calc(); }
function save(alsoAssign){
  const e=gather();
  const loaded = localStorage.getItem('load_eval'); // mantener tu clave estable
  let list=Store.evals||[];
  if(loaded){
    const idx=list.findIndex(x=>x.id===loaded);
    if(idx>=0){ e.id=list[idx].id; e.ts=list[idx].ts; }
    localStorage.removeItem('load_eval');
  }
  if(alsoAssign){
    const sel=[...document.getElementById('assign_cli').options].filter(o=>o.selected).map(o=>o.value);
    e.prospect_ids = sel;
  }
  const idx2=list.findIndex(x=>x.id===e.id);
  if(idx2>=0) list[idx2]=e; else list.push(e);
  Store.evals = list;
  toast('EvaluaciÃ³n guardada','ok');
}

/* ========= Limpiar ========= */
function limpiar(){
  document.querySelectorAll('input').forEach(i=>i.value='');
  document.querySelectorAll('select').forEach(s=>{
    if(s.id==='e_tipo'){ s.value='Tradicional'; }
    else if(s.id==='e_honor'){ s.value='no'; }
    else s.selectedIndex=0;
  });
  document.getElementById('e_result').hidden=true;
}

/* ========= Preload desde Evaluaciones ========= */
function preloadIfAny(){
  const evId = localStorage.getItem('load_eval');
  if(!evId) return; // abrir en blanco si no viene de Evaluaciones
  const e=(Store.evals||[]).find(x=>x.id===evId); if(!e) return;

  id('e_loc').value = e.loc || '';
  id('e_calle').value = e.calle||'';
  id('e_m2').value = e.m2||'';
  id('e_anio').value = e.anio||'';
  id('e_asc').value = e.asc||'SÃ­';
  id('e_alt').value = e.alt||'';
  id('e_bajo').value = e.bajo||'No';
  id('e_habs').value = e.habs||'';
  id('e_banos').value = e.banos||'';
  id('e_ref_nec').value = e.ref_tip||'no';
  id('e_url').value = e.url||'';
  id('e_tipo').value = e.tipo||'Tradicional';

  id('e_precio').value = n0(e.precio||0);
  id('e_itp_eur').value = n0(e.itp||0);
  id('e_notaria').value = n0(e.notaria||0);
  id('e_reforma').value = n0(e.reforma||0);
  id('e_honor').value = (e.psi&&e.psi>0)? 'si':'no';

  id('e_comunidad').value = n0(e.comu||0);
  id('e_ibi').value = n0(e.ibi||0);
  id('e_hogar').value = n0(e.hogar||0);
  id('e_impago').value = n0(e.impago||0);
  id('e_gestion').value = n0(e.gestion||0);

  id('e_alq').value = n0(e.alq||0);

  calc();
}

/* ========= PDF rÃ¡pido ========= */
function quickPDFfrom(e){
  const fecha=new Date(e.ts||Date.now()).toLocaleString('es-ES');
  const htmlParts = [
    '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Informe â€” ',
    escapeHtml(e.loc||''), '</title>',
    '<style>body{font-family:Inter,Arial;color:#101828;margin:24px}',
    'h1{font-size:22px;margin:0 0 6px}h2{font-size:16px;margin:16px 0 8px}',
    '.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}',
    '.box{border:1px solid #e5e7eb;border-radius:10px;padding:10px}',
    '.lab{font-size:12px;color:#667085}.val{font-weight:800}',
    '.foot{margin-top:16px;font-size:12px;color:#667085;text-align:center}',
    '</style></head><body>',
    '<h1>Informe BuyBox â€” Unihouser</h1>',
    '<div class="lab">', fecha, '</div>',
    '<h2>Resumen financiero</h2><div class="grid">',
      '<div class="box"><div class="lab">Bruta</div><div class="val">', fmtN1.format(e.kpi_bruta||0),' %</div></div>',
      '<div class="box"><div class="lab">Neta</div><div class="val">', fmtN1.format(e.kpi_neta||0),' %</div></div>',
      '<div class="box"><div class="lab">Flujo anual</div><div class="val">', e0(e.kpi_flujo||0),'</div></div>',
      '<div class="box"><div class="lab">P. mÃ¡x compra</div><div class="val">', e0(e.pmax||0),'</div></div>',
    '</div>',
    '<h2>Datos del inmueble</h2><div class="grid">',
      '<div class="box"><div class="lab">Localidad</div><div class="val">', escapeHtml(e.loc||'-'),'</div></div>',
      '<div class="box"><div class="lab">Calle</div><div class="val">', escapeHtml(e.calle||'-'),'</div></div>',
      '<div class="box"><div class="lab">Tipo</div><div class="val">', escapeHtml(e.tipo||'-'),'</div></div>',
      '<div class="box"><div class="lab">Alquiler</div><div class="val">', e0(e.alq*12||0),'</div></div>',
      '<div class="box"><div class="lab">Precio</div><div class="val">', e0(e.precio||0),'</div></div>',
      '<div class="box"><div class="lab">InversiÃ³n total</div><div class="val">', e0(e.inv_total||0),'</div></div>',
    '</div>',
    '<div class="foot">Â© 2025 Unihouser Â· unihouser.es Â· info@unihouser.es Â· 644 300 200</div>',
    '</body></html>'
  ];
  const html = htmlParts.join('');
  const w=window.open('','_blank'); if(!w) return;
  w.document.open(); w.document.write(html); w.document.close();
  const tryPrint=()=>{ try{w.focus(); w.print();}catch(_){}}; w.onload=tryPrint; setTimeout(tryPrint,600);
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ========= Arranque ========= */
function attach(){
  loadLocalidades();
  moneyLive();
  bindAuto();

  id('e_calc').addEventListener('click', calc);
  id('e_save').addEventListener('click', ()=>save(false));
  id('e_save_assign').addEventListener('click', ()=>save(true));
  id('save_only') && id('save_only').addEventListener('click', ()=>save(false));
  id('save_assign') && id('save_assign').addEventListener('click', ()=>save(true));
  id('e_clean').addEventListener('click', limpiar);

  preloadIfAny(); // solo precarga si venimos de Evaluaciones
}
document.addEventListener('DOMContentLoaded', attach);
})();
</script>
</body>
</html>
