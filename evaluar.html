<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
.dot.g{background:#16a34a}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
.small{font-size:12px;color:#667085}
.kpi .muted{color:#667085;font-weight:600;margin-left:6px}
.canvasWrap{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
.group3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
@media(max-width:1000px){.group3{grid-template-columns:1fr}}
#matchWrap{display:grid;gap:8px}
.match-col{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
.match-col h4{margin:0 0 8px}
.tag{display:inline-flex;align-items:center;gap:6px;background:#eef2f7;border-radius:999px;padding:4px 10px;margin:3px 4px;font-size:12px}
.badge-warn{display:inline-flex;align-items:center;gap:3px;font-size:11px;color:#b45309;background:#fff7ed;border:1px solid #fde68a;border-radius:999px;padding:2px 6px}
.badge-warn svg{width:12px;height:12px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- DATOS DEL INMUEBLE -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="row three">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Ascensor</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>
      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Necesita reforma</label>
        <select id="e_ref_nec">
          <option value="no">No</option>
          <option value="lavado">Lavado de cara</option>
          <option value="integral">Reforma integral</option>
        </select>
      </div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>
      <div class="field"></div>
    </div>
  </div>

  <!-- GASTOS DE ADQUISICIÓN -->
  <div class="section">
    <h3>Gastos de adquisición</h3>
    <div class="row three">
      <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (€ auto)</label><input id="e_itp_eur" data-money></div>
      <div class="field"><label>Notaría y Registro (€ auto)</label><input id="e_notaria" data-money></div>
    </div>
    <div class="row three">
      <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (4.235 €)</label>
        <select id="e_honor"><option value="si">Sí</option><option value="no" selected>No</option></select>
      </div>
      <div class="field"><label>Precio máx. de compra (objetivo bruta)</label><input id="e_pmax" data-money disabled></div>
    </div>
  </div>

  <!-- GASTOS DE MANTENIMIENTO -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="row three">
      <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>
    </div>
    <div class="row three">
      <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
      <div class="field"><small class="hint">Hogar/impago/gestión se autocalculan desde Config al indicar alquiler (editables).</small></div>
    </div>
  </div>

  <!-- EXPLOTACIÓN E INGRESOS -->
  <div class="section">
    <h3>Tipo de explotación e ingresos</h3>
    <div class="row three">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
      <div class="field"></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_save">Guardar</button>
    <button class="btn" id="e_save_assign">Guardar y asignar</button>
    <button class="btn ghost" id="e_clean">Limpiar</button>
  </div>

  <!-- RESULTADOS -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis">
      <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">—</span><span id="r_bruta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">—</span><span id="r_neta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">—</div></div>
      <div class="kpi"><div class="lab">Precio máx. de compra</div><div class="val" id="r_pmax">—</div></div>
    </div>

    <div class="canvasWrap" style="margin-top:10px">
      <canvas id="chartKPI" width="540" height="220"></canvas>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div id="matchWrap" class="group3">
        <div class="match-col"><h4>Bruta ≥ objetivo</h4><div id="m_bruta">—</div></div>
        <div class="match-col"><h4>Neta ≥ objetivo</h4><div id="m_neta">—</div></div>
        <div class="match-col"><h4>Flujo ≥ objetivo</h4><div id="m_flujo">—</div></div>
      </div>
      <div class="actions" style="margin-top:8px">
        <select id="assign_cli" size="6" style="min-width:320px"></select>
        <button class="btn" id="save_only">Guardar evaluación</button>
        <button class="btn primary" id="save_assign">Guardar y asignar</button>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Utils / formato ES ===== */
const id = function(x){return document.getElementById(x);};
const fmtE0 = new Intl.NumberFormat('es-ES', { style:'currency', currency:'EUR', maximumFractionDigits:0 });
const fmtN0 = new Intl.NumberFormat('es-ES', { maximumFractionDigits:0 });
const fmtN1 = new Intl.NumberFormat('es-ES', { maximumFractionDigits:1 });
function e0(v){ return fmtE0.format(Number(v||0)); }
function n0(v){ return fmtN0.format(Number(v||0)); }
function pct1(v){ return fmtN1.format(Number(v||0))+' %'; }
function parseEs(str){
  if(str==null) return 0;
  var s=String(str).trim().replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
  var n=Number(s); return Number.isFinite(n)? n : 0;
}
function moneyLive(){
  document.querySelectorAll('input[data-money]').forEach(function(inp){
    inp.addEventListener('input',function(){
      var digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
    });
    inp.addEventListener('blur',function(){
      var n = Math.round(parseEs(inp.value));
      inp.value = n? n0(n) : '';
    });
  });
}
function toast(msg,kind){
  var wrap = document.getElementById('toasts');
  if(!wrap){
    var d=document.createElement('div'); d.id='toasts'; d.className='toast-wrap'; document.body.appendChild(d); wrap=d;
  }
  var el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(function(){el.style.opacity='0';},1600);
  setTimeout(function(){ try{wrap.removeChild(el);}catch(_){}} ,2200);
}

/* ===== Store (localStorage) ===== */
var Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}');}catch(_){return{};} },
  set cfg(v){ localStorage.setItem('cfg', JSON.stringify(v)); },
  get pros(){ try{return JSON.parse(localStorage.getItem('pros')||'[]');}catch(_){return[];} },
  set pros(v){ localStorage.setItem('pros', JSON.stringify(v)); },
  get evals(){ try{return JSON.parse(localStorage.getItem('evals')||'[]');}catch(_){return[];} },
  set evals(v){ localStorage.setItem('evals', JSON.stringify(v)); }
};

/* ===== Localidades Asturias ===== */
var ASTURIAS = ["Allande","Aller","Amieva","Avilés","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo",
"Cangas de Onís","Cangas del Narcea","Caravia","Carreño","Caso","Castrillón","Castropol","Coaña","Colunga","Corvera de Asturias",
"Cudillero","Degaña","Gijón","Gozón","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo",
"Laviana","Lena","Llanera","Llanes","Mieres","Morcín","Muros de Nalón","Nava","Navia","Noreña",
"Onís","Oviedo","Parres","Peñamellera Alta","Peñamellera Baja","Pesoz","Piloña","Pravia","Proaza","Quirós",
"Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San Martín de Oscos","San Martín del Rey Aurelio","San Tirso de Abres","Santa Eulalia de Oscos","Santo Adriano",
"Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","Valdés",
"Vegadeo","Villanueva de Oscos","Villaviciosa","Villayón"];

/* ===== Cargar localidades ===== */
function loadLocalidades(){
  var s=id('e_loc'); s.innerHTML='';
  ASTURIAS.forEach(function(loc){
    var o=document.createElement('option'); o.textContent=loc; s.appendChild(o);
  });
}

/* ===== Leer cfg con defaults ===== */
function getCfg(){
  var c=Store.cfg||{};
  return {
    itp_pct: Number(c.itp_pct ?? 8),
    notaria_eur: Number(c.notaria_eur ?? 1500),
    psi_eur: Number(c.psi_fee_eur ?? 4235),
    hogar_pct: Number(c.hogar_pct ?? 3.5),
    impago_pct_trad: Number(c.impago_trad_pct ?? 4.0),
    impago_pct_hab: Number(c.impago_hab_pct ?? 4.0),
    gestion_pct_trad: Number(c.gestion_trad_pct ?? 15.0),
    gestion_pct_hab: Number(c.gestion_hab_pct ?? 25.0),
    obj_bruta_trad: Number((c.objetivos&&c.objetivos.tradicional?c.objetivos.tradicional.bruta_pct:undefined) ?? 10.0),
    obj_bruta_hab:  Number((c.objetivos&&c.objetivos.habitaciones?c.objetivos.habitaciones.bruta_pct:undefined) ?? 12.0),
    obj_neta_trad:  Number((c.objetivos&&c.objetivos.tradicional?c.objetivos.tradicional.neta_pct:undefined) ?? 6.0),
    obj_neta_hab:   Number((c.objetivos&&c.objetivos.habitaciones?c.objetivos.habitaciones.neta_pct:undefined) ?? 7.0)
  };
}

/* ===== Estado local de la página (id/ts para no duplicar) ===== */
var CUR = { id:null, ts:null };

/* ===== Autocálculos dependientes ===== */
function bindAuto(){
  var cfg=getCfg();
  var tipoEl=id('e_tipo');
  var alqEl=id('e_alq');
  var itpEl=id('e_itp_eur');
  var notEl=id('e_notaria');
  var precioEl=id('e_precio');

  function updPrecio(){
    var precio=parseEs(precioEl.value);
    var itp=Math.round(precio*(cfg.itp_pct/100));
    itpEl.value = n0(itp);
    if(!parseEs(notEl.value)) notEl.value=n0(cfg.notaria_eur);
  }
  precioEl.addEventListener('input',updPrecio);
  precioEl.addEventListener('blur',updPrecio);

  function updAlq(){
    var alq_m=parseEs(alqEl.value);
    var alq_a = alq_m*12;
    var tipo=(tipoEl.value||'Tradicional').toLowerCase();
    var impago_pct = (tipo==='habitaciones')? cfg.impago_pct_hab : cfg.impago_pct_trad;
    var gest_pct   = (tipo==='habitaciones')? cfg.gestion_pct_hab : cfg.gestion_pct_trad;

    var hogar   = Math.round(alq_a*(cfg.hogar_pct/100));
    var impago  = Math.round(alq_a*(impago_pct/100));
    var gestion = Math.round(alq_a*(gest_pct/100));

    id('e_hogar').value  = n0(hogar);
    id('e_impago').value = n0(impago);
    id('e_gestion').value= n0(gestion);
  }
  alqEl.addEventListener('input',updAlq);
  alqEl.addEventListener('blur',updAlq);
  tipoEl.addEventListener('change',updAlq);
}

/* ===== Cálculos financieros ===== */
function calc(){
  var cfg=getCfg();
  var tipo=(id('e_tipo').value||'Tradicional');
  var precio = parseEs(id('e_precio').value);
  var itp    = parseEs(id('e_itp_eur').value) || Math.round(precio*(cfg.itp_pct/100));
  var notari = parseEs(id('e_notaria').value) || cfg.notaria_eur;
  var ref    = parseEs(id('e_reforma').value);
  var honor  = (id('e_honor').value==='si') ? cfg.psi_eur : 0;

  var comu   = parseEs(id('e_comunidad').value);
  var ibi    = parseEs(id('e_ibi').value);
  var hogar  = parseEs(id('e_hogar').value);
  var impago = parseEs(id('e_impago').value);
  var gest   = parseEs(id('e_gestion').value);

  var alq_m  = parseEs(id('e_alq').value);
  var alq_a  = alq_m*12;

  var inv_total = precio + itp + notari + ref + honor;
  var gastos_a  = comu + ibi + hogar + impago + gest;

  var bruta = inv_total>0 ? (alq_a / inv_total * 100) : 0;
  var neta  = inv_total>0 ? ((alq_a - gastos_a) / inv_total * 100) : 0;
  var flujo = alq_a - gastos_a;

  var obj_bruta = (tipo==='Habitaciones')? cfg.obj_bruta_hab : cfg.obj_bruta_trad;
  var gapB = bruta - obj_bruta;
  var obj_neta = (tipo==='Habitaciones')? cfg.obj_neta_hab : cfg.obj_neta_trad;
  var gapN = neta - obj_neta;

  var rate = cfg.itp_pct/100;
  var targetInv = (obj_bruta>0)? (alq_a / (obj_bruta/100)) : 0;
  var pmax = 0;
  if(targetInv>0){
    var extras = (notari + ref + honor);
    pmax = Math.max(0, Math.floor((targetInv - extras) / (1+rate)));
  }

  id('r_inv').textContent   = e0(inv_total);
  id('r_bruta').textContent = pct1(bruta);
  id('r_neta').textContent  = pct1(neta);
  id('r_flujo').textContent = e0(flujo);
  id('r_pmax').textContent  = e0(pmax);
  id('e_pmax').value        = n0(pmax);

  paintDot('sb', gapB);
  paintDot('sn', gapN);
  paintDot('sf', flujo>=0? 1 : -1);
  id('r_bruta_diff').textContent = gapText(gapB);
  id('r_neta_diff').textContent  = gapText(gapN);

  drawChart(bruta, obj_bruta);

  suggestProspects({
    tipo: tipo,
    loc: id('e_loc').value||'',
    bruta: bruta, neta: neta, flujo: flujo,
    inv_total: inv_total,
    ref_tip: id('e_ref_nec').value||'no',
    asc: id('e_asc').value||'Sí'
  });

  id('e_result').hidden=false;

  return {
    loc: id('e_loc').value || '',
    calle: id('e_calle').value || '',
    m2: id('e_m2').value || '',
    anio: id('e_anio').value || '',
    asc: id('e_asc').value || '',
    alt: id('e_alt').value || '',
    bajo: id('e_bajo').value || '',
    habs: id('e_habs').value || '',
    banos: id('e_banos').value || '',
    ref_tip: id('e_ref_nec').value || 'no',
    url: id('e_url').value || '',
    tipo: tipo,
    precio: precio, itp: itp, notaria: notari, psi: honor, reforma: ref,
    comu: comu, ibi: ibi, hogar: hogar, impago: impago, gestion: gest,
    alq: alq_m,
    inv_total: inv_total, kpi_bruta: bruta, kpi_neta: neta, kpi_flujo: flujo,
    pmax: pmax
  };
}
function gapText(g){
  if(!isFinite(g)) return '';
  var s = (g>=0? '+' : '-') + fmtN1.format(Math.abs(g)) + ' pts';
  return ' ('+s+')';
}
function paintDot(idDot, gap){
  var el=id(idDot); el.className='dot '+(gap>=0?'g':(gap>-1?'y':'r'));
}

/* ===== Mini chart ===== */
function drawChart(real, objetivo){
  var c=id('chartKPI'); var ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  var pad=36; var W=c.width, H=c.height;
  var max = Math.max( Math.ceil((Math.max(real, objetivo)+2)/2)*2 , 2);

  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  for(var y=0;y<=max;y+=2){
    var yy = H - pad - (H-2*pad)* (y/max);
    ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(W-pad,yy); ctx.stroke();
  }

  var barW=80;
  var realH=(H-2*pad)*(real/max);
  ctx.fillStyle='#ff5a1f';
  ctx.fillRect(W/2 - barW/2, H - pad - realH, barW, realH);

  var yObj = H - pad - (H-2*pad)*(objetivo/max);
  ctx.setLineDash([6,4]); ctx.strokeStyle='#9ca3af'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad, yObj); ctx.lineTo(W-pad, yObj); ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle='#111827'; ctx.font='12px Inter, Arial';
  ctx.fillText('Bruta real', W/2 - 30, H - 8);
  ctx.fillText('Objetivo', pad, yObj - 6);
}

/* ===== Matching prospects ===== */
function isSearching(p){
  var f=(p.fase||'').toString().toLowerCase();
  return f.indexOf('busc')!==-1;
}
function fold(s){
  return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
}
function parseMoney(v){
  if(v==null) return 0;
  return Number(String(v).toString().replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
}
function boolLike(x){
  if(x===true) return true; if(x===false) return false;
  var s=String(x||'').toLowerCase();
  return s==='si'||s==='sí'||s==='true'||s==='1';
}
function wantsNoReform(p){
  return boolLike(p.no_reformas)||boolLike(p.no_reforma)||String(p.reforma||p.ref||'').toLowerCase()==='no'||
         String(p.pref_reforma||'').toLowerCase()==='no'||boolLike(p.prefiere_sin_reforma);
}
function wantsElevator(p){
  return boolLike(p.requiere_ascensor)||boolLike(p.quiere_ascensor)||String(p.ascensor||'').toLowerCase()==='si';
}
function prospectBudget(p){
  return parseMoney(p.presupuesto_max||p.max_compra||p.presupuesto||p.budget_max||p.budget);
}
function warnBadges(p, ctx){
  var warns=[];
  var necesitaReforma = (ctx.ref_tip && ctx.ref_tip !== 'no');
  var sinAscensor = String(ctx.asc||'Sí').toLowerCase()==='no';
  var budget = prospectBudget(p);
  if(necesitaReforma && wantsNoReform(p)) warns.push({icon:'🚧', title:'No quiere inmuebles con reforma'});
  if(sinAscensor && wantsElevator(p)) warns.push({icon:'🛗', title:'Requiere ascensor'});
  if(budget>0 && Number(ctx.inv_total||0) > budget) warns.push({icon:'💰', title:'Excede su presupuesto'});
  return warns;
}
function suggestProspects(ctx){
  var list=Store.pros||[];
  var mB=id('m_bruta'), mN=id('m_neta'), mF=id('m_flujo');
  var asignSel=id('assign_cli');
  mB.innerHTML=mN.innerHTML=mF.innerHTML='—'; asignSel.innerHTML='';

  if(!list.length){ return; }

  var wantTipo = fold(ctx.tipo);
  var wantLoc  = fold(ctx.loc);

  var brutaOK=[], netaOK=[], flujoOK=[];
  var addOptionSet=new Set();

  list.forEach(function(p){
    if(!isSearching(p)) return;
    if(fold(p.pref_tipo)!==wantTipo) return;
    var locs=(p.locs_text||'').split(',').map(fold).filter(Boolean);
    if(locs.indexOf(wantLoc)===-1) return;

    var main=(p.obj_main||p.obj_tipo||'bruta').toString().toLowerCase();
    var obB = Number(p.obj_bruta != null ? p.obj_bruta : (main==='bruta' ? p.obj_raw : 0)) || 0;
    var obN = Number(p.obj_neta  != null ? p.obj_neta  : (main==='neta'  ? p.obj_raw : 0)) || 0;
    var obFmes = Number(p.obj_flujo_mes != null ? p.obj_flujo_mes : (p.obj_flujo||0)) || 0;
    var obFano = obFmes>0 ? obFmes*12 : 0;

    if(obB>0 && Number(ctx.bruta)>=obB) brutaOK.push(p);
    if(obN>0 && Number(ctx.neta) >=obN) netaOK.push(p);
    if(obFano>0 && Number(ctx.flujo)>=obFano) flujoOK.push(p);
  });

  function chip(p, warns){
    var span=document.createElement('span');
    span.className='tag';
    var name=document.createElement('span'); name.textContent=p.nombre||'-';
    span.appendChild(name);
    warns.forEach(function(w){
      var b=document.createElement('span'); b.className='badge-warn'; b.title=w.title;
      b.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#b45309" stroke-width="1.2"/><path d="M12 7v6m0 4h.01" stroke="#b45309" stroke-width="1.6" stroke-linecap="round"/></svg>' + w.icon;
      span.appendChild(b);
    });
    return span;
  }
  function render(arr, el){
    if(!arr.length){ el.textContent='—'; return; }
    el.innerHTML='';
    arr.forEach(function(p){
      var warns = warnBadges(p, ctx);
      el.appendChild(chip(p, warns));
      var key=p.id||p.email||p.nombre||('p_'+Math.random().toString(36).slice(2,7));
      if(!addOptionSet.has(key)){ addOptionSet.add(key);
        var opt=document.createElement('option'); opt.value=key; opt.textContent=p.nombre||'-';
        asignSel.appendChild(opt);
      }
    });
  }
  render(brutaOK, mB);
  render(netaOK,  mN);
  render(flujoOK, mF);
}

/* ===== Guardar / Asignar ===== */
function selectedAssignIds(){
  return [].slice.call(document.getElementById('assign_cli').options)
          .filter(function(o){return o.selected;})
          .map(function(o){return o.value;});
}
function save(alsoAssign){
  var selIds = alsoAssign ? selectedAssignIds() : [];

  var core = calc();

  if(!CUR.id){ CUR.id = 'ev_'+Date.now(); CUR.ts = Date.now(); }

  var e = { id: CUR.id, ts: CUR.ts };
  for(var k in core){ e[k]=core[k]; }
  if(alsoAssign) e.prospect_ids = selIds;

  var list=Store.evals||[];
  var idx=list.findIndex(function(x){return x.id===e.id;});
  if(idx>=0) list[idx]=e; else list.push(e);
  Store.evals = list;

  if(alsoAssign) toast('Evaluación guardada y asignada ('+selIds.length+')','ok');
  else toast('Evaluación guardada','ok');
}

/* ===== Limpiar ===== */
function limpiar(){
  document.querySelectorAll('input').forEach(function(i){i.value='';});
  document.querySelectorAll('select').forEach(function(s){
    if(s.id==='e_tipo'){ s.value='Tradicional'; }
    else if(s.id==='e_honor'){ s.value='no'; }
    else s.selectedIndex=0;
  });
  document.getElementById('e_result').hidden=true;
  CUR.id=null; CUR.ts=null;
}

/* ===== Preload desde Evaluaciones ===== */
function preloadIfAny(){
  var evId = localStorage.getItem('load_eval');
  if(!evId) return;
  var e=(Store.evals||[]).find(function(x){return x.id===evId;}); if(!e) return;

  CUR.id = e.id; CUR.ts = e.ts;

  id('e_loc').value = e.loc || '';
  id('e_calle').value = e.calle||'';
  id('e_m2').value = e.m2||'';
  id('e_anio').value = e.anio||'';
  id('e_asc').value = e.asc||'Sí';
  id('e_alt').value = e.alt||'';
  id('e_bajo').value = e.bajo||'No';
  id('e_habs').value = e.habs||'';
  id('e_banos').value = e.banos||'';
  id('e_ref_nec').value = e.ref_tip||'no';
  id('e_url').value = e.url||'';
  id('e_tipo').value = e.tipo||'Tradicional';

  id('e_precio').value = n0(e.precio||0);
  id('e_itp_eur').value = n0(e.itp||0);
  id('e_notaria').value = n0(e.notaria||0);
  id('e_reforma').value = n0(e.reforma||0);
  id('e_honor').value = (e.psi&&e.psi>0)? 'si':'no';

  id('e_comunidad').value = n0(e.comu||0);
  id('e_ibi').value = n0(e.ibi||0);
  id('e_hogar').value = n0(e.hogar||0);
  id('e_impago').value = n0(e.impago||0);
  id('e_gestion').value = n0(e.gestion||0);

  id('e_alq').value = n0(e.alq||0);

  calc();
  localStorage.removeItem('load_eval');
}

/* ===== PDF rápido (opcional) ===== */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);}); }

/* ===== Eventos ===== */
function attach(){
  loadLocalidades();
  moneyLive();
  bindAuto();

  id('e_calc').addEventListener('click', calc);
  id('e_save').addEventListener('click', function(){save(false);});
  id('e_save_assign').addEventListener('click', function(){save(true);});
  var so=id('save_only'); if(so) so.addEventListener('click', function(){save(false);});
  var sa=id('save_assign'); if(sa) sa.addEventListener('click', function(){save(true);});
  id('e_clean').addEventListener('click', limpiar);

  preloadIfAny();
}
document.addEventListener('DOMContentLoaded', attach);
})();
</script>
</body>
</html>
