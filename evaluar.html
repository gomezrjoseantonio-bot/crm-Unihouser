<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpis5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
  .kpi .lab{color:#667085;font-size:12px}.kpi .val{font-weight:800}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
  .green{background:#16a34a}.yellow{background:#f59e0b}.red{background:#ef4444}
  .muted{color:#667085}
  canvas{max-width:100%;height:auto}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="grid3">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://..."></div>

      <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric"></div>
      <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric"></div>
      <div class="field"><label>Necesita reforma</label>
        <select id="e_reforma_tipo"><option>No</option><option>Lavado de cara</option><option>Integral</option></select>
      </div>

      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
      <div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>

      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric"></div>
      <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric"></div>
      <div></div>
    </div>
  </div>

  <div class="section">
    <h3>Gastos de adquisición</h3>
    <div class="grid3">
      <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (€ — auto)</label><input id="e_itp_eur" data-money disabled></div>
      <div class="field"><label>Notaría y Registro (€ — auto)</label><input id="e_notaria" data-money disabled></div>

      <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (con IVA)</label>
        <select id="e_incluir_psi"><option value="si">Sí</option><option value="no">No</option></select>
      </div>
      <div class="field"><label>Precio máx. compra (cumplir BRUTA)</label><input id="e_pmax" data-money disabled></div>
    </div>
    <div class="muted" style="margin-top:6px">El objetivo BRUTA se toma de Config según tipo.</div>
  </div>

  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="grid3">
      <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>

      <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
      <div></div>
    </div>
    <div class="muted" style="margin-top:6px">Hogar/impago/gestión se autocalculan al fijar el alquiler.</div>
  </div>

  <div class="section">
    <h3>Tipo de explotación e ingresos</h3>
    <div class="grid3">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
      <div class="field"><label>Otros ingresos (€/mes) — opcional</label><input id="e_otros" value="0" data-money></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_clean">Limpiar</button>
    <button class="btn" id="save_only">Guardar evaluación</button>
  </div>

  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis5">
      <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div>
        <div class="val"><span id="r_bruta">—</span> <span id="r_bruta_diff" class="muted"></span></div>
      </div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div>
        <div class="val"><span id="r_neta">—</span> <span id="r_neta_diff" class="muted"></span></div>
      </div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">—</div></div>
      <div class="kpi"><div class="lab">Precio máx. de compra</div><div class="val" id="r_pmax">—</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Gráfico · Rentabilidad bruta</h3>
      <canvas id="chartBruta" width="640" height="240"></canvas>
      <div class="muted" id="chartNote" style="margin-top:6px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div id="matchList" class="muted">—</div>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="save_assign">Guardar y asignar</button>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Helpers ===== */
function gid(s){return document.getElementById(s);}
var fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
var fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function e0(v){return fmtE0.format(Number(v||0));}
function n0(v){return fmtN0.format(Number(v||0));}
function pct(v){return fmtN1.format(Number(v||0))+' %';}
function parseEs(str){if(str==null)return 0;var s=String(str).trim().replace(/\./g,'').replace(',', '.');var n=Number(s);return isFinite(n)?n:0;}
function setMoney(inp,v){inp.value=n0(Math.round(Number(v||0)));}
function setDot(el,cls){el.className='dot '+cls;}
function goalDot(val,goal){return val>=goal?'green':(val>=goal*0.9?'yellow':'red');}
function genId(){var d=new Date();function pad(x){return String(x).padStart(2,'0');}var rnd=Math.random().toString(36).slice(2,5);return 'ev_'+d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+''+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds())+''+rnd;}

/* ===== Store ===== */
var Store={
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(e){return{}} },
  set cfg(v){localStorage.setItem('cfg',JSON.stringify(v));},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(e){return[]} },
  set pros(v){localStorage.setItem('pros',JSON.stringify(v));},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(e){return[]} },
  set evals(v){localStorage.setItem('evals',JSON.stringify(v));}
};

/* ===== Localidades (Asturias) ===== */
var LOCS=["Allande","Aller","Amieva","Avilés","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo","Cangas de Onís","Cangas del Narcea","Caravia","Carreño","Caso","Castrillón","Castropol","Coaña","Colunga","Corvera de Asturias","Cudillero","Degaña","Gijón","Gozón","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo","Laviana","Lena","Llanera","Llanes","Las Regueras","Morcín","Muros de Nalón","Mieres","Nava","Navia","Noreña","Onís","Oviedo","Parres","Peñamellera Alta","Peñamellera Baja","Pesoz","Piloña","Pravia","Proaza","Quirós","Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San Martín del Rey Aurelio","San Martín de Oscos","Santa Eulalia de Oscos","Santo Adriano","Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","Valdés","Vegadeo","Villanueva de Oscos","Villaviciosa","Villayón","Yernes y Tameza"];

/* ===== Config + match con defaults ===== */
function CFG(){
  var c=Store.cfg||{}, m=c.match||{};
  return {
    itp_pct: Number(c.itp_pct!=null?c.itp_pct:8),
    notaria_eur: Number(c.notaria_eur!=null?c.notaria_eur:1500),
    psi_eur: Number(c.psi_eur!=null?c.psi_eur:4235),
    hogar_pct: Number(c.hogar_pct!=null?c.hogar_pct:2),
    impago_pct_trad: Number(c.impago_pct_trad!=null?c.impago_pct_trad:0),
    impago_pct_rooms: Number(c.impago_pct_rooms!=null?c.impago_pct_rooms:4),
    gestion_pct_trad: Number(c.gestion_pct_trad!=null?c.gestion_pct_trad:15),
    gestion_pct_rooms: Number(c.gestion_pct_rooms!=null?c.gestion_pct_rooms:25),
    obj_bruta_trad: Number(c.obj_bruta_trad!=null?c.obj_bruta_trad:10),
    obj_bruta_rooms: Number(c.obj_bruta_rooms!=null?c.obj_bruta_rooms:12),
    obj_neta_trad: Number(c.obj_neta_trad!=null?c.obj_neta_trad:7.5),
    obj_neta_rooms: Number(c.obj_neta_rooms!=null?c.obj_neta_rooms:8.5),
    match:{
      weight_bruta: Number(m.weight_bruta!=null?m.weight_bruta:50),
      weight_presupuesto: Number(m.weight_presupuesto!=null?m.weight_presupuesto:25),
      weight_ubicacion_tipo: Number(m.weight_ubicacion_tipo!=null?m.weight_ubicacion_tipo:15),
      weight_condiciones: Number(m.weight_condiciones!=null?m.weight_condiciones:10),
      budget_tolerance_pct: Number(m.budget_tolerance_pct!=null?m.budget_tolerance_pct:10),
      cutoff_green: Number(m.cutoff_green!=null?m.cutoff_green:75),
      cutoff_amber: Number(m.cutoff_amber!=null?m.cutoff_amber:55),
      hard_require_ascensor: Boolean(m.hard_require_ascensor!=null?m.hard_require_ascensor:false),
      penaliza_bajo: Boolean(m.penaliza_bajo!=null?m.penaliza_bajo:false),
      default_acepta_reforma: (m.default_acepta_reforma!=null?m.default_acepta_reforma:'cualquiera')
    }
  };
}

/* ===== Estado ===== */
var currentId=null;

/* ===== Montaje ===== */
function mount(){
  // localidades
  var sel=gid('e_loc'); var opts=[]; for(var i=0;i<LOCS.length;i++){opts.push('<option>'+LOCS[i]+'</option>');}
  sel.innerHTML=opts.join('');

  // formatter inputs dinero
  var moneyInputs=document.querySelectorAll('input[data-money]');
  for(var j=0;j<moneyInputs.length;j++){
    (function(inp){
      inp.addEventListener('input',function(){
        var digits=(inp.value||'').replace(/[^\d]/g,'');
        inp.value=digits? n0(digits): '';
      });
      inp.addEventListener('blur',function(){ setMoney(inp, parseEs(inp.value)); });
    })(moneyInputs[j]);
  }

  // eventos
  gid('e_precio').addEventListener('input', autoAdquisicion);
  gid('e_tipo').addEventListener('change', function(){ autoMantenimiento(); recalcPmax(); });
  gid('e_alq').addEventListener('input', function(){ autoMantenimiento(); recalcPmax(); });

  gid('e_calc').addEventListener('click', calcular);
  gid('e_clean').addEventListener('click', limpiar);
  gid('save_only').addEventListener('click', guardar);
  gid('save_assign').addEventListener('click', guardarYAsignar);

  preloadFromEvaluaciones();
  autoAdquisicion();
}

/* ===== Auto ITP/Notaría ===== */
function autoAdquisicion(){
  var cfg=CFG(); var precio=parseEs(gid('e_precio').value);
  var itp=Math.round(precio*cfg.itp_pct/100);
  setMoney(gid('e_itp_eur'), itp);
  setMoney(gid('e_notaria'), cfg.notaria_eur);
  recalcPmax();
}

/* ===== Auto mantenimiento al escribir alquiler ===== */
function autoMantenimiento(){
  var cfg=CFG(), tipo=gid('e_tipo').value;
  var alq=parseEs(gid('e_alq').value), otros=parseEs(gid('e_otros').value);
  var anual=(alq+otros)*12;

  var hogar=Math.round(anual*(cfg.hogar_pct/100));
  var impago=Math.round(anual*((tipo==='Tradicional'?cfg.impago_pct_trad:cfg.impago_pct_rooms)/100));
  var gestion=Math.round(anual*((tipo==='Tradicional'?cfg.gestion_pct_trad:cfg.gestion_pct_rooms)/100));

  setMoney(gid('e_hogar'), hogar);
  setMoney(gid('e_impago'), impago);
  setMoney(gid('e_gestion'), gestion);
}

/* ===== Precio máx (cumplir bruta) ===== */
function recalcPmax(){
  var cfg=CFG(), tipo=gid('e_tipo').value;
  var goal=(tipo==='Tradicional'?cfg.obj_bruta_trad:cfg.obj_bruta_rooms)/100;
  var alq=parseEs(gid('e_alq').value), otros=parseEs(gid('e_otros').value);
  var ingresoAnual=(alq+otros)*12;
  var notaria=parseEs(gid('e_notaria').value)||cfg.notaria_eur;
  var reforma=parseEs(gid('e_reforma').value);
  var psi=(gid('e_incluir_psi').value==='si')? cfg.psi_eur : 0;
  var itp_pct=cfg.itp_pct/100;

  // P = (Ingreso/goal - (notaria+reforma+psi)) / (1+itp_pct)
  var C=notaria+reforma+psi;
  var brutoObj= ingresoAnual/goal;
  var pmax=Math.max(0, Math.floor((brutoObj - C)/(1+itp_pct)));
  setMoney(gid('e_pmax'), pmax);
}

/* ===== Calcular KPIs ===== */
function calcular(){
  var cfg=CFG();
  var precio=parseEs(gid('e_precio').value);
  var itp=parseEs(gid('e_itp_eur').value)||Math.round(precio*cfg.itp_pct/100);
  var notaria=parseEs(gid('e_notaria').value)||cfg.notaria_eur;
  var reforma=parseEs(gid('e_reforma').value);
  var psi=(gid('e_incluir_psi').value==='si')? cfg.psi_eur : 0;

  var comunidad=parseEs(gid('e_comunidad').value);
  var ibi=parseEs(gid('e_ibi').value);
  var hogar=parseEs(gid('e_hogar').value);
  var impago=parseEs(gid('e_impago').value);
  var gestion=parseEs(gid('e_gestion').value);

  var alq=parseEs(gid('e_alq').value);
  var otros=parseEs(gid('e_otros').value);

  var inversion=precio+itp+notaria+reforma+psi;
  var ingresoAnual=(alq+otros)*12;
  var gastosAnuales=comunidad+ibi+hogar+impago+gestion;

  var bruta=inversion>0? (ingresoAnual/inversion)*100:0;
  var neta =inversion>0? ((ingresoAnual-gastosAnuales)/inversion)*100:0;
  var flujo=ingresoAnual-gastosAnuales;

  var tipo=gid('e_tipo').value;
  var gB=(tipo==='Tradicional'?cfg.obj_bruta_trad:cfg.obj_bruta_rooms);
  var gN=(tipo==='Tradicional'?cfg.obj_neta_trad :cfg.obj_neta_rooms);

  gid('e_result').hidden=false;
  gid('r_inv').textContent=e0(inversion);
  gid('r_bruta').textContent=pct(bruta);
  gid('r_neta').textContent=pct(neta);
  gid('r_flujo').textContent=e0(flujo);
  gid('r_pmax').textContent=gid('e_pmax').value? (gid('e_pmax').value+' €'): e0(0);

  var diffB=bruta-gB, diffN=neta-gN;
  gid('r_bruta_diff').textContent=(diffB>=0?' (+' :' (')+fmtN1.format(diffB)+' p.p.)';
  gid('r_neta_diff').textContent =(diffN>=0?' (+' :' (')+fmtN1.format(diffN)+' p.p.)';

  setDot(gid('sb'), goalDot(bruta,gB));
  setDot(gid('sn'), goalDot(neta,gN));
  setDot(gid('sf'), flujo>0?'green':'red');

  drawBrutaChart(bruta,gB);
  sugerirClientes({bruta:bruta,inversion:inversion});
}

/* ===== Mini-gráfico (canvas) ===== */
function drawBrutaChart(real,goal){
  var c=gid('chartBruta'), ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  var W=c.width,H=c.height,pad=40,max=Math.max(goal,real,20);
  ctx.strokeStyle='#e5e7eb';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad,H-pad);ctx.lineTo(W-pad,H-pad);ctx.stroke();
  var barW=80,x=pad+40,y=H-pad,h=(Math.max(real,0)/max)*(H-2*pad);
  ctx.fillStyle= real>=goal? '#16a34a' : (real>=goal*0.9? '#f59e0b':'#ef4444');
  ctx.fillRect(x,y-h,barW,h);
  var yG=y-(goal/max)*(H-2*pad);
  ctx.strokeStyle='#94a3b8';ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(pad,yG);ctx.lineTo(W-pad,yG);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='#0f1112';ctx.font='13px Inter, Arial';
  ctx.fillText('Real: '+fmtN1.format(real)+' %', x, y-h-8);
  ctx.fillText('Objetivo: '+fmtN1.format(goal)+' %', W-pad-170, yG-6);
  var gap=real-goal, gtxt=(gap>=0?'+':'')+fmtN1.format(gap)+' p.p.';
  ctx.fillStyle=gap>=0?'#16a34a':'#ef4444';
  ctx.fillText('Δ '+gtxt, x+barW+16, y-h+14);
  gid('chartNote').textContent=(isFinite(real) && isFinite(goal))? '': 'Introduce precio/alquiler para ver el gráfico.';
}

/* ===== Matching prospects ===== */
function sugerirClientes(args){
  var bruta=args.bruta, inversion=args.inversion;
  var cfg=CFG(), M=cfg.match;
  var tipo=gid('e_tipo').value;
  var loc=(gid('e_loc').value||'').toLowerCase();
  var asc=gid('e_asc').value==='Sí';
  var bajo=gid('e_bajo').value==='Sí';
  var alt=parseEs(gid('e_alt').value);
  var ref=gid('e_reforma_tipo').value;

  var pros=Store.pros||[], list=[];
  for(var i=0;i<pros.length;i++){
    var p=pros[i], score=0, hard=false;

    var goalB = (p.obj_bruta>0? Number(p.obj_bruta): (tipo==='Tradicional'? cfg.obj_bruta_trad : cfg.obj_bruta_rooms));
    var partB = goalB>0? Math.max(0, Math.min(1, bruta/goalB)) : 0;
    score += partB * M.weight_bruta;

    var presu = Number(p.presupuesto_total||0);
    if(presu>0){
      if(inversion<=presu) score += M.weight_presupuesto;
      else{
        var tol=1+(M.budget_tolerance_pct/100);
        if(inversion<=presu*tol) score += 0.4*M.weight_presupuesto;
      }
    }

    var locs=(p.locs_text||'').toLowerCase();
    var okLoc=!locs || locs.indexOf(loc)>=0;
    var okTipo=!p.pref_tipo || p.pref_tipo===tipo;
    if(okLoc) score += 0.67*M.weight_ubicacion_tipo;
    if(okTipo) score += 0.33*M.weight_ubicacion_tipo;

    if(M.hard_require_ascensor && !asc) hard=true;
    if(!M.penaliza_bajo || !bajo) score += 0.3*M.weight_condiciones;
    if(alt>0 && p.altura_max>0 && alt<=p.altura_max) score += 0.3*M.weight_condiciones;
    var prefRef=(p.acepta_reforma || M.default_acepta_reforma);
    var okRef = prefRef==='cualquiera' || (prefRef==='no' && ref==='No') || (prefRef==='lavado' && (ref==='No'||ref==='Lavado de cara')) || (prefRef==='integral');
    if(okRef) score += 0.4*M.weight_condiciones;

    if(!hard) list.push({p:p,score:Math.round(score)});
  }
  list.sort(function(a,b){return b.score-a.score;});

  var html=[];
  for(var j=0;j<list.length;j++){
    var s=list[j].score; if(s<M.cutoff_amber) continue;
    var color=s>=M.cutoff_green?'🟢':'🟡';
    var p2=list[j].p;
    var line=color+' '+(p2.nombre||'—')+' · '+(p2.pref_tipo||'-')+' · '+(p2.locs_text||'-')+' · Score '+s;
    html.push('<label style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #eef2f7"><input type="checkbox" value="'+(p2.id||p2.email||p2.nombre)+'"> <span>'+line+'</span></label>');
  }
  gid('matchList').innerHTML= html.length? html.join('') : 'Sin clientes potenciales.';
}

/* ===== Guardar ===== */
function buildEvalFromUI(){
  var cfg=CFG();
  var base={
    id: currentId || genId(),
    ts: Date.now(),
    loc: gid('e_loc').value, calle: gid('e_calle').value, url: gid('e_url').value||'',
    anio: gid('e_anio').value, m2: gid('e_m2').value,
    reforma_tipo: gid('e_reforma_tipo').value, alt: gid('e_alt').value,
    ascensor: gid('e_asc').value, bajo: gid('e_bajo').value,
    habs: gid('e_habs').value, banos: gid('e_banos').value,
    tipo: gid('e_tipo').value,
    precio: parseEs(gid('e_precio').value),
    itp: parseEs(gid('e_itp_eur').value) || Math.round(parseEs(gid('e_precio').value)*cfg.itp_pct/100),
    notaria: parseEs(gid('e_notaria').value) || cfg.notaria_eur,
    psi_incluido: gid('e_incluir_psi').value==='si',
    psi: (gid('e_incluir_psi').value==='si')? cfg.psi_eur : 0,
    reforma: parseEs(gid('e_reforma').value),
    comunidad: parseEs(gid('e_comunidad').value),
    ibi: parseEs(gid('e_ibi').value),
    hogar: parseEs(gid('e_hogar').value),
    impago: parseEs(gid('e_impago').value),
    gestion: parseEs(gid('e_gestion').value),
    alq: parseEs(gid('e_alq').value),
    otros: parseEs(gid('e_otros').value)
  };
  var ingresoAnual=(base.alq+base.otros)*12;
  var inversion=base.precio+base.itp+base.notaria+base.reforma+base.psi;
  var gastos=base.comunidad+base.ibi+base.hogar+base.impago+base.gestion;
  var bruta=inversion>0? (ingresoAnual/inversion)*100:0;
  var neta =inversion>0? ((ingresoAnual-gastos)/inversion)*100:0;
  var flujo=ingresoAnual-gastos;
  var pmax=parseEs(gid('e_pmax').value);

  return {
    id: base.id, ts: base.ts, loc: base.loc, calle: base.calle, url: base.url,
    anio: base.anio, m2: base.m2, reforma_tipo: base.reforma_tipo, alt: base.alt,
    ascensor: base.ascensor, bajo: base.bajo, habs: base.habs, banos: base.banos,
    tipo: base.tipo, precio: base.precio, itp: base.itp, notaria: base.notaria,
    psi_incluido: base.psi_incluido, psi: base.psi, reforma: base.reforma,
    comunidad: base.comunidad, ibi: base.ibi, hogar: base.hogar, impago: base.impago, gestion: base.gestion,
    alq: base.alq, otros: base.otros,
    inv_total: inversion, kpi_bruta: Number(fmtN1.format(bruta).replace(',','.')), kpi_neta: Number(fmtN1.format(neta).replace(',','.')),
    kpi_flujo: flujo, pmax: pmax, prospect_ids: []
  };
}

function guardar(){
  if(gid('e_result').hidden) calcular();
  var list=Store.evals||[], ev=buildEvalFromUI();
  var idx=currentId? list.findIndex(function(x){return x.id===currentId;}): -1;
  if(idx>=0) list[idx]=ev; else list.push(ev);
  Store.evals=list;
  alert('Evaluación guardada');
}

function guardarYAsignar(){
  guardar();
  var checks=(gid('matchList').querySelectorAll('input[type=checkbox]')||[]);
  var ids=[]; for(var i=0;i<checks.length;i++){ if(checks[i].checked) ids.push(checks[i].value); }
  var list=Store.evals||[];
  var idx=currentId? list.findIndex(function(x){return x.id===currentId;}): list.length-1;
  if(idx>=0){ list[idx].prospect_ids=ids; Store.evals=list; alert('Evaluación guardada y asignada'); }
}

/* ===== Precarga desde Evaluaciones ===== */
function preloadFromEvaluaciones(){
  try{
    var mem=localStorage.getItem('_load_eval_'); if(!mem) return;
    localStorage.removeItem('_load_eval_');
    var idToLoad=String(mem).replace(/"/g,'');
    var list=Store.evals||[]; var e=null;
    for(var i=0;i<list.length;i++){ if(list[i].id===idToLoad){ e=list[i]; break; } }
    if(!e) return;

    currentId=e.id;
    gid('e_loc').value=e.loc||LOCS[0];
    gid('e_calle').value=e.calle||'';
    gid('e_url').value=e.url||'';
    gid('e_anio').value=e.anio||'';
    gid('e_m2').value=e.m2||'';
    gid('e_reforma_tipo').value=e.reforma_tipo||'No';
    gid('e_alt').value=e.alt||'';
    gid('e_asc').value=e.ascensor||'Sí';
    gid('e_bajo').value=e.bajo||'No';
    gid('e_habs').value=e.habs||'';
    gid('e_banos').value=e.banos||'';
    gid('e_tipo').value=e.tipo||'Tradicional';

    setMoney(gid('e_precio'),e.precio);
    setMoney(gid('e_itp_eur'),e.itp);
    setMoney(gid('e_notaria'),e.notaria);
    setMoney(gid('e_reforma'),e.reforma);
    gid('e_incluir_psi').value=e.psi_incluido?'si':'no';
    setMoney(gid('e_comunidad'),e.comunidad);
    setMoney(gid('e_ibi'),e.ibi);
    setMoney(gid('e_hogar'),e.hogar);
    setMoney(gid('e_impago'),e.impago);
    setMoney(gid('e_gestion'),e.gestion);
    setMoney(gid('e_alq'),e.alq);
    setMoney(gid('e_otros'),e.otros);

    autoMantenimiento(); autoAdquisicion(); calcular();
  }catch(e){}
}

/* ===== Limpiar ===== */
function limpiar(){
  currentId=null;
  var inputs=document.querySelectorAll('input'); 
  for(var i=0;i<inputs.length;i++){
    var el=inputs[i]; if(el.id==='e_notaria'||el.id==='e_itp_eur') continue; el.value='';
  }
  gid('e_incluir_psi').value='si';
  gid('e_tipo').value='Tradicional';
  autoAdquisicion();
  gid('e_result').hidden=true;
}

/* ===== Start ===== */
document.addEventListener('DOMContentLoaded', mount);
})();
</script>
</body>
</html>
