<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9Yf8Q0wAAAAASUVORK5CYII=">
<style>
/* Ajustes locales mínimos */
.grid3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
.grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(max-width:980px){.grid3,.grid2{grid-template-columns:1fr}}
.kpis .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px;vertical-align:middle}
.dot.ok{background:#16a34a}.dot.warn{background:#f59e0b}.dot.bad{background:#ef4444}
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;font-size:12px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- ==================== DATOS INMUEBLE ==================== -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="grid3">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://..."></div>

      <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
      <div class="field"><label>Necesita reforma</label>
        <select id="e_reforma_tipo"><option>No</option><option>Lavado de cara</option><option>Integral</option></select>
      </div>

      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
      <div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>

      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" value="3"></div>
      <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" value="1"></div>
      <div></div>
    </div>
  </div>

  <!-- ==================== ADQUISICIÓN ==================== -->
  <div class="section">
    <h3>Gastos de adquisición</h3>
    <div class="grid3">
      <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (€ — auto)</label><input id="e_itp_eur" data-money></div>
      <div class="field"><label>Notaría y Registro (€ — auto)</label><input id="e_notaria" data-money></div>

      <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (con IVA)</label>
        <select id="e_incluir_psi"><option value="si">Sí</option><option value="no">No</option></select>
      </div>
      <div class="field"><label>Precio máx. compra (estimado)</label><input id="e_pmax" data-money disabled></div>
    </div>
    <small class="hint">El <strong>precio máx.</strong> se calcula para alcanzar la <u>rentabilidad bruta objetivo</u> de Configuración, teniendo en cuenta ITP/Notaría y si marcas PSI.</small>
  </div>

  <!-- ==================== MANTENIMIENTO ==================== -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="grid3">
      <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>

      <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
      <div></div>
    </div>
    <small class="hint">Hogar/impago/gestión se autocompletan al indicar alquiler y tipo, según Config. Editables.</small>
  </div>

  <!-- ==================== EXPLOTACIÓN ==================== -->
  <div class="section">
    <h3>Tipo de explotación e ingresos</h3>
    <div class="grid3">
      <div class="field"><label>Tipo de alquiler</label>
        <select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
      </div>
      <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
      <div></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn ghost" id="e_clean">Limpiar</button>
  </div>

  <!-- ==================== RESULTADOS ==================== -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis">
      <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">—</span> <span id="r_bruta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">—</span> <span id="r_neta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Flujo de caja anual</div><div class="val" id="r_flujo">—</div></div>
      <div class="kpi"><div class="lab">Precio máx. compra</div><div class="val" id="r_pmax">—</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div id="matchList" class="muted">—</div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ============== Utils & Store ============== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
const pct = v=>fmtN1.format(Number(v||0))+' %';
const parseEs = s => Number(String(s??'').trim().replace(/\./g,'').replace(',', '.'))||0;

function setupMoneyLive(){
  document.querySelectorAll('input[data-money]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
    });
    inp.addEventListener('blur', ()=>{
      const n=parseEs(inp.value);
      if(Number.isFinite(n)) inp.value = fmtN0.format(Math.round(n));
    });
  });
}

const Store={
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}},
  set cfg(v){localStorage.setItem('cfg',JSON.stringify(v))},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))}
};

/* ============== Config por defecto (si falta) ============== */
function cfgOrDefault(){
  const c = Store.cfg||{};
  return {
    itp_pct: Number(c.itp_pct??8),
    notaria_eur: Number(c.notaria_eur??1500),
    psi_eur: Number(c.psi_eur??4235),                // PSI con IVA
    seg_hogar_eur: Number(c.seg_hogar_eur??210),
    seg_impago_trad_eur: Number(c.seg_impago_trad_eur??240),
    seg_impago_hab_eur: Number(c.seg_impago_hab_eur??0),
    gestion_trad_pct: Number(c.gestion_trad_pct??7.5),
    gestion_hab_pct: Number(c.gestion_hab_pct??15),
    obj_bruta_trad: Number(c.obj_bruta_trad??10),
    obj_bruta_hab: Number(c.obj_bruta_hab??12),
    obj_neta_trad: Number(c.obj_neta_trad??8),
    obj_neta_hab: Number(c.obj_neta_hab??10)
  };
}

/* ============== Localidades ============== */
const LOCS = [
  "Oviedo","Gijón","Mieres","Langreo","Avilés","Siero",
  "Allande","Cangas del Narcea","Grado","Llanera","Llanes","Noreña",
  "Pravia","Sama","La Felguera","El Entrego"
];
function fillLocalidades(){
  const sel=id('e_loc'); sel.innerHTML='';
  LOCS.forEach(l=>{ const o=document.createElement('option'); o.textContent=l; sel.appendChild(o); });
}

/* ============== Autocálculos ============== */
function autoAdquisicion(){
  const cfg=cfgOrDefault();
  const precio=parseEs(id('e_precio').value);
  id('e_itp_eur').value = fmtN0.format(Math.round(precio * cfg.itp_pct/100));
  id('e_notaria').value = fmtN0.format(cfg.notaria_eur);
}

function autoMantenimiento(){
  const cfg=cfgOrDefault();
  const tipo=id('e_tipo').value;
  const alq=parseEs(id('e_alq').value);
  const anual = alq*12;

  // hogar fijo de config
  id('e_hogar').value = fmtN0.format(cfg.seg_hogar_eur);

  // impago distinto por tipo (fijos €/año)
  const impago = (tipo==='Habitaciones') ? cfg.seg_impago_hab_eur : cfg.seg_impago_trad_eur;
  id('e_impago').value = fmtN0.format(impago);

  // gestión = % sobre alquiler anual (editable)
  const gPct = (tipo==='Habitaciones') ? cfg.gestion_hab_pct : cfg.gestion_trad_pct;
  id('e_gestion').value = fmtN0.format(Math.round(anual * gPct/100));
}

function calcPmaxObjetivo(){
  const cfg=cfgOrDefault();
  const itpPct = cfg.itp_pct;
  const notaria = cfg.notaria_eur;
  const psi = (id('e_incluir_psi').value==='si')? cfg.psi_eur : 0;
  const reforma = parseEs(id('e_reforma').value);
  const alq = parseEs(id('e_alq').value);
  if(!alq){ id('e_pmax').value=''; return 0; }

  const objBruta = (id('e_tipo').value==='Habitaciones')? cfg.obj_bruta_hab : cfg.obj_bruta_trad;
  const anual = alq*12;
  // pmax*(1+itpPct) = (anual*100/obj) - (notaria+psi+reforma)
  const rhs = (anual*100/objBruta) - (notaria + psi + reforma);
  const pmax = Math.max(0, Math.round(rhs / (1 + itpPct/100)));
  id('e_pmax').value = fmtN0.format(pmax);
  return pmax;
}

/* ============== Cálculo global ============== */
function calcular(){
  const cfg=cfgOrDefault();

  const precio=parseEs(id('e_precio').value);
  const itp=parseEs(id('e_itp_eur').value)||Math.round(precio*cfg.itp_pct/100);
  const notaria=parseEs(id('e_notaria').value)||cfg.notaria_eur;
  const psi=(id('e_incluir_psi').value==='si')? cfg.psi_eur : 0;
  const reforma=parseEs(id('e_reforma').value);

  const comunidad=parseEs(id('e_comunidad').value);
  const ibi=parseEs(id('e_ibi').value);
  const hogar=parseEs(id('e_hogar').value);
  const impago=parseEs(id('e_impago').value);
  const gestion=parseEs(id('e_gestion').value);

  const alq=parseEs(id('e_alq').value);
  const anual = alq*12;

  // inversión total
  const inv = precio + itp + notaria + psi + reforma;

  // bruta / neta
  const bruta = inv>0 ? anual/inv*100 : 0;
  const neta = inv>0 ? (anual - (comunidad+ibi+hogar+impago+gestion))/inv*100 : 0;

  // flujo
  const flujo = anual - (comunidad+ibi+hogar+impago+gestion);

  // pmax objetivo
  const pmax = calcPmaxObjetivo();

  // mostrar
  id('r_inv').textContent = e0(inv);
  id('r_bruta').textContent = pct(bruta);
  id('r_neta').textContent = pct(neta);
  id('r_flujo').textContent = e0(flujo);
  id('r_pmax').textContent = e0(pmax);

  // semáforos + diferencias contra objetivos Config
  const objB = (id('e_tipo').value==='Habitaciones')? cfg.obj_bruta_hab : cfg.obj_bruta_trad;
  const objN = (id('e_tipo').value==='Habitaciones')? cfg.obj_neta_hab : cfg.obj_neta_trad;
  const diffB = (bruta - objB);
  const diffN = (neta - objN);
  id('r_bruta_diff').textContent = (diffB>=0? ' (+' : ' (') + fmtN1.format(diffB) + ' pp)';
  id('r_neta_diff').textContent  = (diffN>=0? ' (+' : ' (') + fmtN1.format(diffN) + ' pp)';

  const sb=id('sb'), sn=id('sn');
  const clsB = diffB>=0? 'ok' : (diffB>-1? 'warn':'bad');
  const clsN = diffN>=0? 'ok' : (diffN>-1? 'warn':'bad');
  sb.className='dot '+clsB; sn.className='dot '+clsN;

  // sugerencias de clientes por match simple
  sugerirClientes(bruta, neta, flujo);

  id('e_result').hidden=false;

  // guardar evaluación mínima para listado (si quieres que se almacene al calcular)
  const ev = {
    id: 'ev_'+Date.now(),
    ts: Date.now(),
    loc: id('e_loc').value,
    calle: id('e_calle').value,
    url: id('e_url').value,
    tipo: id('e_tipo').value,
    precio, alq,
    kpi_bruta: bruta, kpi_neta: neta, kpi_flujo: flujo,
    pmax, inv_total: inv
  };
  const list=Store.evals||[]; list.push(ev); Store.evals=list;
}

function limpiar(){
  document.querySelectorAll('input').forEach(i=>i.value='');
  id('e_incluir_psi').value='si';
  id('e_tipo').value='Tradicional';
  autoAdquisicion(); autoMantenimiento(); id('e_result').hidden=true;
}

/* ============== Sugerencias clientes ============== */
function sugerirClientes(bruta, neta, flujo){
  const pros=Store.pros||[];
  if(!pros.length){ id('matchList').textContent='No hay prospects.'; return; }

  const tipo = id('e_tipo').value;
  const loc = id('e_loc').value;
  const filas = [];

  pros.forEach(p=>{
    const okTipo = !p.pref_tipo || p.pref_tipo===tipo;
    const okLoc  = !p.locs_text || (p.locs_text||'').toLowerCase().includes(loc.toLowerCase());
    // objetivo: si p.obj='Bruta %', comparamos con bruta, etc.
    let okObj=true, exceso=0, etiqueta='—';
    const obj = Number(p.obj_val||0);
    if((p.obj||'').toLowerCase().includes('bruta')){ exceso = bruta-obj; etiqueta='Bruta'; }
    else if((p.obj||'').toLowerCase().includes('neta')){ exceso = neta-obj; etiqueta='Neta'; }
    else if((p.obj||'').toLowerCase().includes('flujo')){ exceso = flujo-obj; etiqueta='Flujo €'; }
    okObj = exceso>=0;

    if(okTipo && okLoc && okObj){
      filas.push(<div class="pill">${p.nombre||'—'} · ${etiqueta} +${fmtN1.format(exceso)}${etiqueta==='Flujo €'?' €':''}</div>);
    }
  });

  id('matchList').innerHTML = filas.length? filas.join(' ') : 'Sin clientes potenciales';
}

/* ============== Cargar desde Evaluaciones ============== */
function intentarCargarEvaluacion(){
  const k='_load_eval_';
  const idEv = localStorage.getItem(k); if(!idEv) return;
  localStorage.removeItem(k);
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;

  id('e_loc').value=e.loc||'';
  id('e_calle').value=e.calle||'';
  id('e_url').value=e.url||'';
  id('e_tipo').value=e.tipo||'Tradicional';
  id('e_precio').value=fmtN0.format(e.precio||0);
  id('e_alq').value=fmtN0.format(e.alq||0);

  autoAdquisicion(); autoMantenimiento();
  calcular();
}

/* ============== Eventos ============== */
function attach(){
  fillLocalidades();
  setupMoneyLive();
  autoAdquisicion();
  autoMantenimiento();
  id('e_precio').addEventListener('input', autoAdquisicion);
  id('e_tipo').addEventListener('change', ()=>{ autoMantenimiento(); calcPmaxObjetivo(); });
  id('e_alq').addEventListener('input', ()=>{ autoMantenimiento(); calcPmaxObjetivo(); });
  id('e_incluir_psi').addEventListener('change', calcPmaxObjetivo);
  id('e_calc').addEventListener('click', calcular);
  id('e_clean').addEventListener('click', limpiar);
  intentarCargarEvaluacion();
}
document.addEventListener('DOMContentLoaded', attach);
})();
</script>
</body>
</html>
