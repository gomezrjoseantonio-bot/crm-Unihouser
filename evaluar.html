<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* mínimos locales */
.kpi .diff{margin-left:6px;font-size:12px;color:#667085}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px;vertical-align:middle}
.dot.g{background:#16a34a}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
.chart{height:160px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;padding:8px}
.card.suggest{margin-top:12px}
.grid3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- DATOS INMUEBLE -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="grid3">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://…"></div>

      <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
      <div class="field"><label>Necesita reforma</label>
        <select id="e_reforma_tipo"><option>No</option><option>Lavado de cara</option><option>Integral</option></select>
      </div>

      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
      <div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>

      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
      <div></div>
    </div>
  </div>

  <!-- ADQUISICIÓN -->
  <div class="section">
    <h3>Gastos de adquisición</h3>
    <div class="grid3">
      <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (€ — auto)</label><input id="e_itp" data-money></div>
      <div class="field"><label>Notaría y Registro (€ — auto)</label><input id="e_notaria" data-money></div>

      <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios (PSI)</label>
        <select id="e_incluir_psi"><option value="si">Sí</option><option value="no">No</option></select>
      </div>
      <div class="field"><label>Precio máx. compra (objetivo)</label><input id="e_pmax" data-money disabled></div>
    </div>
    <small class="hint">El “P. máx.” se calcula para cumplir la <b>bruta objetivo</b> del tipo elegido (según Config) y respeta si incluyes o no PSI.</small>
  </div>

  <!-- MANTENIMIENTO -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="grid3">
      <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>

      <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
      <div></div>
    </div>
    <small class="hint">Hogar/impago/gestión se autocalculan al indicar alquiler y tipo, según Config. Editables.</small>
  </div>

  <!-- EXPLOTACIÓN -->
  <div class="section">
    <h3>Tipo de explotación e ingresos</h3>
    <div class="grid3">
      <div class="field"><label>Tipo de alquiler</label>
        <select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
      </div>
      <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
      <div></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_clean">Limpiar</button>
  </div>

  <!-- RESULTADOS -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis">
      <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div>
        <div class="val"><span id="r_bruta">—</span><span class="diff" id="r_bruta_diff"></span></div>
      </div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div>
        <div class="val"><span id="r_neta">—</span><span class="diff" id="r_neta_diff"></span></div>
      </div>
      <div class="kpi"><div class="lab">Flujo de caja anual</div><div class="val" id="r_flujo">—</div></div>
      <div class="kpi"><div class="lab">Precio máx. compra</div><div class="val" id="r_pmax">—</div></div>
    </div>

    <div class="chart" id="chartBox"></div>

    <div class="card suggest">
      <h3 style="margin:0 0 6px">Clientes potenciales</h3>
      <div id="matchList" class="muted">—</div>
      <div class="actions" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <select id="assign_cli" size="4" style="min-width:280px"></select>
        <button class="btn" id="save_only">Guardar evaluación</button>
        <button class="btn primary" id="save_assign">Guardar y asignar</button>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
const id=x=>document.getElementById(x);
const fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0=v=>fmtE0.format(Number(v||0));
function parseEs(str){ if(str==null) return 0; const s=String(str).trim().replace(/\./g,'').replace(',', '.'); const n=Number(s); return Number.isFinite(n)?n:0; }
function toPct(raw){ let v=Number(raw||0); if(v>0&&v<=1)v*=100; return v; }
function dot(el, v, goal){ const d=id(el); const diff=v-goal; const cls= diff>=-0.2? (diff>=0? 'g':'y') : 'r'; d.className='dot '+cls; }

/* ===== Store ===== */
const Store={
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}},
  set cfg(v){localStorage.setItem('cfg',JSON.stringify(v));},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v));},
};

/* ===== Localidades ===== */
const LOCS=["Oviedo","Gijón","Avilés","Mieres","Langreo","Siero","Llanera","Castrillón","Corvera",
"Lena","Aller","San Martín","Laviana","Nava","Villaviciosa","Grado","Pravia","Cangas del Narcea",
"Tineo","Cangas de Onís","Ribadesella","Llanes","Gozón","Valdés","Siero (Pola)"];

/* ===== Config por defecto (solo si falta) ===== */
(function ensureCfg(){
  const cfg=Store.cfg||{};
  if(cfg.__ok) return;
  const def={
    itp_pct:8,
    notaria_eur:1500,
    psi_eur:4235, /* honorarios con IVA */
    seg_hogar_pct:1.5,          /* % sobre alquiler anual */
    seg_impago_pct_trad:3.0,    /* % sobre alquiler anual */
    seg_impago_pct_hab:4.0,
    gestion_pct_trad:7.0,
    gestion_pct_hab:10.0,
    objetivo_bruta_trad:10.0,
    objetivo_bruta_hab:12.0,
    match_w_locs:0.4, match_w_tipo:0.3, match_w_obj:0.3,
    __ok:true
  };
  Store.cfg=Object.assign(def,cfg);
})();

/* ===== Money inputs ===== */
function setupMoney(){
  document.querySelectorAll('input[data-money]').forEach(inp=>{
    inp.addEventListener('input',()=>{
      const digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
    });
    inp.addEventListener('blur',()=>{ const n=parseEs(inp.value); inp.value=fmtN0.format(Math.round(n)); });
  });
}

/* ===== Autocalc helpers ===== */
function itpFrom(price){ const r=(Store.cfg.itp_pct||8)/100; return Math.round(price*r); }
function notariaDef(){ return Math.round(Store.cfg.notaria_eur||1500); }
function psiDef(){ return Math.round(Store.cfg.psi_eur||4235); }

function autoAdquisicion(){
  const precio=parseEs(id('e_precio').value);
  id('e_itp').value=fmtN0.format(itpFrom(precio));
  if(!parseEs(id('e_notaria').value)) id('e_notaria').value=fmtN0.format(notariaDef());
  // Pmax provisional (con objetivo de bruta):
  calcPmax();
}
function autoMantenimiento(){
  const tipo=id('e_tipo').value||'Tradicional';
  const alqMes=parseEs(id('e_alq').value);
  const anual=alqMes*12;
  const cfg=Store.cfg||{};
  const hogar=Math.round(anual*(cfg.seg_hogar_pct||0)/100);
  const impago=Math.round(anual*((tipo==='Habitaciones'? cfg.seg_impago_pct_hab:cfg.seg_impago_pct_trad)||0)/100);
  const gest=Math.round(anual*((tipo==='Habitaciones'? cfg.gestion_pct_hab:cfg.gestion_pct_trad)||0)/100);
  if(!parseEs(id('e_hogar').value))   id('e_hogar').value=fmtN0.format(hogar);
  if(!parseEs(id('e_impago').value))  id('e_impago').value=fmtN0.format(impago);
  if(!parseEs(id('e_gestion').value)) id('e_gestion').value=fmtN0.format(gest);
  calcPmax();
}

/* ===== Precio máximo para cumplir BRUTA ===== */
function calcPmax(){
  const cfg=Store.cfg||{};
  const tipo=id('e_tipo').value||'Tradicional';
  const goal=(tipo==='Habitaciones'? cfg.objetivo_bruta_hab:cfg.objetivo_bruta_trad)||10;
  const alq=parseEs(id('e_alq').value)*12;
  const inclPSI=(id('e_incluir_psi').value==='si');
  const N=notariaDef() + (inclPSI? psiDef(): 0);
  const itpRate=(cfg.itp_pct||8)/100;
  if(alq<=0){ id('e_pmax').value=''; return; }
  // Resolver P en: goal% = alq / (P + N + P*itp)
  // P = (alq/goal - N) / (1+itp)
  const P=Math.max(0, Math.floor((alq/(goal/100) - N)/(1+itpRate)));
  id('e_pmax').value=fmtN0.format(P);
  // también refrescamos el campo ITP si el precio cambiado es el pmax? (no, se deja el ITP del precio real)
}

/* ===== Cálculo principal ===== */
function calcular(){
  const cfg=Store.cfg||{};
  const tipo=id('e_tipo').value||'Tradicional';
  const precio=parseEs(id('e_precio').value);
  const reforma=parseEs(id('e_reforma').value);
  const itp=parseEs(id('e_itp').value)||itpFrom(precio);
  const notaria=parseEs(id('e_notaria').value)||notariaDef();
  const inclPSI=(id('e_incluir_psi').value==='si');
  const psi= inclPSI? psiDef(): 0;

  const alqAnual=parseEs(id('e_alq').value)*12;
  const comunidad=parseEs(id('e_comunidad').value);
  const ibi=parseEs(id('e_ibi').value);
  const hogar=parseEs(id('e_hogar').value);
  const impago=parseEs(id('e_impago').value);
  const gestion=parseEs(id('e_gestion').value);

  const inv_total = precio + itp + notaria + reforma + psi;
  // Bruta: sobre compra + ITP + Notaría (sin PSI), siguiendo lo pactado
  const base_bruta = (precio + itp + notaria);
  const kpi_bruta = base_bruta>0 ? (alqAnual / base_bruta) * 100 : 0;

  const gastos = comunidad + ibi + hogar + impago + gestion;
  const neto = Math.max(0, alqAnual - gastos);
  const kpi_neta = inv_total>0 ? (neto / inv_total) * 100 : 0;

  id('r_inv').textContent=e0(inv_total);
  id('r_bruta').textContent=fmtN1.format(kpi_bruta)+' %';
  id('r_neta').textContent=fmtN1.format(kpi_neta)+' %';
  id('r_flujo').textContent=e0(neto);
  id('r_pmax').textContent=e0(parseEs(id('e_pmax').value));

  // Deltas y semáforos
  const goal_b=(tipo==='Habitaciones'? cfg.objetivo_bruta_hab:cfg.objetivo_bruta_trad)||10;
  const goal_n=goal_b*0.8; // aproximación: neta objetivo ~ 80% de bruta si no hay valor en Config
  id('r_bruta_diff').textContent=(${(kpi_bruta-goal_b>=0?'+':'')+fmtN1.format(kpi_bruta-goal_b)} pp);
  id('r_neta_diff').textContent =(${(kpi_neta-goal_n>=0?'+':'')+fmtN1.format(kpi_neta-goal_n)} pp);
  dot('sb', kpi_bruta, goal_b);
  dot('sn', kpi_neta, goal_n);

  drawChart(kpi_bruta, goal_b);

  // Sugerencias de clientes
  suggestClients(kpi_bruta, kpi_neta);
  id('e_result').hidden=false;
}

/* ===== Gráfico simple (bruta vs objetivo) ===== */
function drawChart(real, goal){
  const box=id('chartBox'); box.innerHTML='';
  const wrap=document.createElement('div'); wrap.style.display='grid'; wrap.style.gridTemplateColumns='1fr 1fr'; wrap.style.height='100%'; wrap.style.gap='8px';
  function bar(val,label){
    const outer=document.createElement('div'); outer.style.display='grid'; outer.style.gridTemplateRows='1fr auto'; outer.style.alignItems='end';
    const b=document.createElement('div'); b.style.height=Math.max(0,Math.min(100,val))+'%'; b.style.background='#16a34a'; b.style.borderRadius='6px';
    const l=document.createElement('div'); l.style.fontSize='12px'; l.style.textAlign='center'; l.textContent=label+' '+fmtN1.format(val)+'%';
    outer.appendChild(b); outer.appendChild(l); return outer;
  }
  wrap.appendChild(bar(real,'Bruta'));
  const g=bar(goal,'Objetivo'); g.firstChild.style.background='#f59e0b'; wrap.appendChild(g);
  box.appendChild(wrap);
}

/* ===== Sugerencias clientes ===== */
function scoreMatch(p, kpi_b, kpi_n){
  const cfg=Store.cfg||{};
  const wLoc=cfg.match_w_locs??0.4, wTipo=cfg.match_w_tipo??0.3, wObj=cfg.match_w_obj??0.3;
  let s=0;
  // Localidad: si contiene alguna
  const locSel=(id('e_loc').value||'').toLowerCase();
  const okLoc=((p.locs_text||'').toLowerCase().includes(locSel))?1:0;
  s+= okLoc * wLoc;
  // Tipo
  const tipo=id('e_tipo').value||'Tradicional';
  s+= ((p.pref_tipo||'').toLowerCase().includes(tipo.toLowerCase())?1:0) * wTipo;
  // Objetivo: si bruta >= objetivo o neta >= objetivo
  const obj=(p.obj_principal||'bruta').toLowerCase();
  const val=Number(p.obj_valor||0);
  const hit = obj.includes('neta') ? (kpi_n>=val) : (kpi_b>=val);
  s+= (hit?1:0) * wObj;
  return s;
}
function suggestClients(kpi_b, kpi_n){
  const list=Store.pros||[];
  const ok=list.map(p=>({p, s:scoreMatch(p,kpi_b,kpi_n)})).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).slice(0,8);
  const wrap=id('matchList'); const sel=id('assign_cli');
  wrap.innerHTML = ok.length? Sugeridos: ${ok.length}/${list.length} : 'Sin clientes potenciales';
  sel.innerHTML = ok.map(x=><option value="${x.p.id||x.p.email||x.p.nombre}">${(x.p.nombre||'—')} · ${(x.p.pref_tipo||'-')} · ${(x.p.locs_text||'')}</option>).join('');
}

/* ===== Guardar ===== */
function buildEval(){
  const tipo=id('e_tipo').value||'Tradicional';
  return {
    id:'ev-'+Date.now(),
    ts:Date.now(),
    loc:id('e_loc').value, calle:id('e_calle').value, url:id('e_url').value,
    anio:id('e_anio').value, m2:id('e_m2').value, reforma_tipo:id('e_reforma_tipo').value,
    alt:id('e_alt').value, asc:id('e_asc').value, bajo:id('e_bajo').value, habs:id('e_habs').value, banos:id('e_banos').value,
    tipo,
    precio:parseEs(id('e_precio').value), itp:parseEs(id('e_itp').value), notaria:parseEs(id('e_notaria').value),
    reforma:parseEs(id('e_reforma').value), incluir_psi:id('e_incluir_psi').value,
    comunidad:parseEs(id('e_comunidad').value), ibi:parseEs(id('e_ibi').value),
    hogar:parseEs(id('e_hogar').value), impago:parseEs(id('e_impago').value), gestion:parseEs(id('e_gestion').value),
    alq:parseEs(id('e_alq').value),
    kpi_bruta:toPct(parseEs(id('r_bruta').textContent)), kpi_neta:toPct(parseEs(id('r_neta').textContent)),
    kpi_flujo:parseEs(id('r_flujo').textContent),
    pmax:parseEs(id('e_pmax').value),
    inv_total:parseEs(id('r_inv').textContent),
    prospect_ids:[...id('assign_cli').selectedOptions].map(o=>o.value)
  };
}
function saveEval(assignToo){
  const e=buildEval();
  const list=Store.evals||[];
  list.push(e); Store.evals=list;
  if(assignToo && e.prospect_ids.length){ /* ya vienen en el objeto */ }
  alert('Evaluación guardada.');
}

/* ===== Cargar desde Evaluaciones (id en _load_eval_) ===== */
function loadFromId(idEv){
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;
  id('e_loc').value=e.loc||''; id('e_calle').value=e.calle||''; id('e_url').value=e.url||'';
  id('e_anio').value=e.anio||''; id('e_m2').value=e.m2||''; id('e_reforma_tipo').value=e.reforma_tipo||'No';
  id('e_alt').value=e.alt||''; id('e_asc').value=e.asc||'Sí'; id('e_bajo').value=e.bajo||'No';
  id('e_habs').value=e.habs||''; id('e_banos').value=e.banos||'';
  id('e_tipo').value=e.tipo||'Tradicional';
  id('e_precio').value=fmtN0.format(e.precio||0);
  id('e_itp').value=fmtN0.format(e.itp||0);
  id('e_notaria').value=fmtN0.format(e.notaria||notariaDef());
  id('e_reforma').value=fmtN0.format(e.reforma||0);
  id('e_incluir_psi').value=(e.incluir_psi||'no');
  id('e_comunidad').value=fmtN0.format(e.comunidad||0);
  id('e_ibi').value=fmtN0.format(e.ibi||0);
  id('e_hogar').value=fmtN0.format(e.hogar||0);
  id('e_impago').value=fmtN0.format(e.impago||0);
  id('e_gestion').value=fmtN0.format(e.gestion||0);
  id('e_alq').value=fmtN0.format(e.alq||0);
  calcPmax();
}

/* ===== Eventos ===== */
function attach(){
  // localidades
  id('e_loc').innerHTML = '<option></option>'+LOCS.map(x=><option>${x}</option>).join('');
  // money formatting
  setupMoney();
  // bindings
  id('e_precio').addEventListener('input',autoAdquisicion);
  id('e_tipo').addEventListener('change',()=>{autoMantenimiento(); calcPmax();});
  id('e_alq').addEventListener('input',autoMantenimiento);
  id('e_incluir_psi').addEventListener('change',calcPmax);

  id('e_calc').addEventListener('click',calcular);
  id('e_clean').addEventListener('click',()=>{location.href='evaluar.html'});

  id('save_only').addEventListener('click',()=>saveEval(false));
  id('save_assign').addEventListener('click',()=>saveEval(true));

  // abrir desde Evaluaciones
  const loadId=localStorage.getItem('_load_eval_');
  if(loadId){ localStorage.removeItem('_load_eval_'); loadFromId(loadId); calcular(); }
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>
</body>
</html>
