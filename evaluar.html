<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06);
  --ui-font: system-ui, -apple-system, Inter, Roboto, Arial, sans-serif;
  --ui-font-size: 12px;
  /* compat con código previo */
  --ff: var(--ui-font);
  --fz: var(--ui-font-size);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
a{color:var(--brand);text-decoration:none}
.container{max-width:1200px;margin:0 auto;padding:12px 14px}

/* Topbar */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);padding:6px 10px;border-radius:10px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}

/* Tarjetas / bloques */
.card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.section{border:1px dashed var(--line);border-radius:12px;padding:10px;margin:10px 0;background:#fff}
h2{margin:0 0 8px;font-size:16px}
h3{margin:0 0 8px;font-size:14px;color:#444}

/* Form layout */
.row{display:grid;gap:8px}
.row.three{grid-template-columns:repeat(3,1fr)}
@media(max-width:980px){.row.three{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:2px}
.field label{color:#555;font-size:11px}
input,select{border:1px solid var(--line);border-radius:10px;padding:6px 7px;min-height:26px;font-size:12px;background:#fff;color:#1a1f23}

/* Botones */
.actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:800;font-size:12px}
.btn:hover{background:#FAF8F7}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#fff}

/* KPIs */
.kpis{display:grid;gap:10px;grid-template-columns:repeat(5,1fr)}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.kpi .lab{font-size:11px;color:#667085}
.kpi .val{font-weight:800;font-size:18px}
.kpi .muted{color:#667085;font-weight:600;margin-left:6px}

/* Estado icons */
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
.dot.g{background:#16a34a}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
.star{display:inline-block;width:14px;height:14px;vertical-align:middle;margin-right:6px}
.star svg{width:14px;height:14px;fill:var(--brand)}

/* Clientes potenciales grid */
#candGrid{display:grid;gap:8px}
.crow{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px}
.cname{font-weight:700}
.cmeta{font-size:11px;color:#667085}
.cstate{display:flex;align-items:center;gap:6px}
.cstate .warn{font-size:11px;color:#b45309;display:inline-flex;align-items:center;gap:4px}
.cstate .warn svg{width:12px;height:12px}
.cact{display:flex;align-items:center;gap:10px}
.cact label{font-size:12px}

/* Avisos vacíos */
.empty{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}

/* Toasts */
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}

/* Footer */
.foot{margin:12px 0 20px;text-align:center;color:#888;font-size:11px}
</style>

<script>
/* Aplicar marca y tipografía desde cfg */
try{
  const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
  if(cfg.brand_color) document.documentElement.style.setProperty('--brand', cfg.brand_color);
  if(cfg.ui_font) document.documentElement.style.setProperty('--ui-font', cfg.ui_font);
  if(cfg.ui_font_size) document.documentElement.style.setProperty('--ui-font-size', (''+cfg.ui_font_size).replace('px','')+'px');
}catch(_){}
</script>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand">
        <div class="logo" id="logoBox">U</div>
        <div class="title" id="brandTitle">Unihouser — Evaluar</div>
      </div>
      <nav class="nav">
        <a href="evaluar.html" class="active">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <main class="container">
    <section class="card">
      <h2>Evaluar Activo</h2>

      <!-- DATOS DEL INMUEBLE -->
      <div class="section">
        <h3>Datos del inmueble</h3>
        <div class="row three">
          <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
          <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
          <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
        </div>
        <div class="row three">
          <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
          <div class="field"><label>Ascensor</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
          <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
        </div>
        <div class="row three">
          <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>
          <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
          <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
        </div>
        <div class="row three">
          <div class="field"><label>Necesita reforma</label>
            <select id="e_ref_nec">
              <option value="no">No</option>
              <option value="lavado">Lavado de cara</option>
              <option value="integral">Reforma integral</option>
            </select>
          </div>
          <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>
          <div class="field"></div>
        </div>
      </div>

      <!-- GASTOS DE ADQUISICIÓN -->
      <div class="section">
        <h3>Gastos de adquisición</h3>
        <div class="row three">
          <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
          <div class="field"><label>ITP (€ auto)</label><input id="e_itp_eur" data-money></div>
          <div class="field"><label>Notaría y Registro (€ auto)</label><input id="e_notaria" data-money></div>
        </div>
        <div class="row three">
          <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
          <div class="field"><label>Incluir honorarios PSI</label>
            <select id="e_honor"><option value="si">Sí</option><option value="no" selected>No</option></select>
          </div>
          <div class="field"><label>Precio máx. de compra (objetivo bruta)</label><input id="e_pmax" data-money disabled></div>
        </div>
      </div>

      <!-- GASTOS DE MANTENIMIENTO -->
      <div class="section">
        <h3>Gastos de mantenimiento</h3>
        <div class="row three">
          <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
          <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
          <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>
        </div>
        <div class="row three">
          <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
          <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
          <div class="field"><small class="hint" style="color:#667085">Hogar/impago/gestión se autocalculan desde Config al indicar alquiler (editables).</small></div>
        </div>
      </div>

      <!-- EXPLOTACIÓN E INGRESOS -->
      <div class="section">
        <h3>Tipo de explotación e ingresos</h3>
        <div class="row three">
          <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
          <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
          <div class="field"></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="e_calc">Calcular</button>
        <button class="btn" id="e_save">Guardar</button>
        <button class="btn" id="e_save_assign">Guardar y asignar</button>
        <button class="btn" id="e_clean">Limpiar</button>
      </div>

      <!-- RESULTADOS -->
      <div id="e_result" class="section" hidden>
        <h3>Resultados</h3>
        <div class="kpis">
          <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
          <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">—</span><span id="r_bruta_diff" class="muted"></span></div></div>
          <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">—</span><span id="r_neta_diff" class="muted"></span></div></div>
          <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">—</div></div>
          <div class="kpi"><div class="lab">Precio máx. de compra</div><div class="val" id="r_pmax">—</div></div>
        </div>

        <!-- CLIENTES POTENCIALES (grid único) -->
        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">Clientes potenciales</h3>
          <div id="candGrid"></div>
          <div id="noMatchMsg" class="empty" style="display:none"></div>
          <div class="actions" style="margin-top:10px">
            <button class="btn" id="save_only">Guardar evaluación</button>
            <button class="btn primary" id="save_assign">Guardar y asignar</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="foot"><div class="container">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* Marca (texto) */
(function(){
  try{
    var c = JSON.parse(localStorage.getItem('cfg')||'{}')||{};
    var name = c.brand_name || c.company_name || 'Unihouser';
    document.getElementById('brandTitle').textContent = name+' — Evaluar';
    document.getElementById('logoBox').textContent = (name||'U').toString().trim().charAt(0).toUpperCase() || 'U';
  }catch(_){}
})();

/* Utils formato ES */
var id=function(x){return document.getElementById(x);};
var fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
var fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function e0(v){return fmtE0.format(Number(v||0));}
function n0(v){return fmtN0.format(Number(v||0));}
function pct1(v){return fmtN1.format(Number(v||0))+' %';}
function parseEs(str){
  if(str==null) return 0;
  var s=String(str).trim().replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
  var n=Number(s); return Number.isFinite(n)? n : 0;
}
function moneyLive(){
  [].forEach.call(document.querySelectorAll('input[data-money]'),function(inp){
    inp.addEventListener('input',function(){
      var digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
    });
    inp.addEventListener('blur',function(){
      var n=Math.round(parseEs(inp.value));
      inp.value=n? n0(n) : '';
    });
  });
}
function toast(msg,kind){
  var wrap=document.getElementById('toasts')||(function(){
    var d=document.createElement('div'); d.id='toasts'; d.className='toast-wrap'; document.body.appendChild(d); return d;
  })();
  var el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(function(){el.style.opacity='0';},1600);
  setTimeout(function(){try{wrap.removeChild(el)}catch(_){}} ,2200);
}

/* Store (capa preparada para remoto) */
var Store={
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}, 
  set cfg(v){localStorage.setItem('cfg',JSON.stringify(v));},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v));},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v));}
};

/* Localidades (Asturias) */
var ASTURIAS=["Allande","Aller","Amieva","Avilés","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo","Cangas de Onís","Cangas del Narcea","Caravia","Carreño","Caso","Castrillón","Castropol","Coaña","Colunga","Corvera de Asturias","Cudillero","Degaña","Gijón","Gozón","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo","Laviana","Lena","Llanera","Llanes","Mieres","Morcín","Muros de Nalón","Nava","Navia","Noreña","Onís","Oviedo","Parres","Peñamellera Alta","Peñamellera Baja","Pesoz","Piloña","Pravia","Proaza","Quirós","Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San Martín de Oscos","San Martín del Rey Aurelio","San Tirso de Abres","Santa Eulalia de Oscos","Santo Adriano","Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","Valdés","Vegadeo","Villanueva de Oscos","Villaviciosa","Villayón"];
function loadLocalidades(){
  var s=id('e_loc'); s.innerHTML='';
  ASTURIAS.forEach(function(loc){var o=document.createElement('option');o.textContent=loc;s.appendChild(o);});
}

/* Defaults/compat cfg */
function def(v,fb){return (v===undefined||v===null)?fb:v;}
function getCfg(){
  var c=Store.cfg||{};
  var itp_raw=Number(def(c.itp_pct,def(c.itp,8))); if(!isFinite(itp_raw)) itp_raw=8;
  var itp_pct= itp_raw<1 ? itp_raw*100 : itp_raw;
  var notaria=Number(def(c.notaria,c.notaria_eur)); if(!isFinite(notaria)) notaria=1500;
  var honor=Number(def(c.honorarios,c.psi_fee_eur)); if(!isFinite(honor)) honor=4235;
  var hogar_pct=Number(def(c.hogar_pct,3.5));
  var imp_trad=Number(def(c.impago_trad_pct,4.0));
  var imp_hab =Number(def(c.impago_hab_pct,4.0));
  var g_trad  =Number(def(c.gestion_trad_pct,15.0));
  var g_hab   =Number(def(c.gestion_hab_pct,25.0));
  var o=c.objetivos||{}, t=o.tradicional||{}, h=o.habitaciones||{};
  var match=(c.match&&c.match.thresholds)?c.match:{thresholds:{green:1,amber:0.95},warnings_only_when_green:true};
  return {
    itp_pct:itp_pct, notaria_eur:notaria, psi_eur:honor,
    hogar_pct:hogar_pct, impago_pct_trad:imp_trad, impago_pct_hab:imp_hab,
    gestion_pct_trad:g_trad, gestion_pct_hab:g_hab,
    obj_bruta_trad:Number(def(t.bruta_pct,10.0)),
    obj_bruta_hab:Number(def(h.bruta_pct,12.0)),
    obj_neta_trad:Number(def(t.neta_pct,6.0)),
    obj_neta_hab:Number(def(h.neta_pct,7.0)),
    thresholds: match.thresholds,
    warnsOnlyGreen: !!match.warnings_only_when_green
  };
}

/* Autocálculos */
function bindAuto(){
  var cfg=getCfg();
  var tipoEl=id('e_tipo'), alqEl=id('e_alq'), itpEl=id('e_itp_eur'), notEl=id('e_notaria'), precioEl=id('e_precio');

  function updPrecio(){
    var precio=parseEs(precioEl.value);
    var itp=Math.round(precio*(cfg.itp_pct/100));
    itpEl.value=n0(itp);
    if(!parseEs(notEl.value)) notEl.value=n0(cfg.notaria_eur);
  }
  precioEl.addEventListener('input',updPrecio);
  precioEl.addEventListener('blur',updPrecio);

  function updAlq(){
    var alq_m=parseEs(alqEl.value), alq_a=alq_m*12;
    var tipo=(tipoEl.value||'Tradicional').toLowerCase();
    var impago_pct=(tipo==='habitaciones')?cfg.impago_pct_hab:cfg.impago_pct_trad;
    var gest_pct  =(tipo==='habitaciones')?cfg.gestion_pct_hab:cfg.gestion_pct_trad;
    id('e_hogar').value  = n0(Math.round(alq_a*(cfg.hogar_pct/100)));
    id('e_impago').value = n0(Math.round(alq_a*(impago_pct/100)));
    id('e_gestion').value= n0(Math.round(alq_a*(gest_pct/100)));
  }
  alqEl.addEventListener('input',updAlq);
  alqEl.addEventListener('blur',updAlq);
  tipoEl.addEventListener('change',updAlq);
}

/* Estado */
var CURRENT_ID=null;

/* Cálculos y render */
function calc(){
  var cfg=getCfg();
  var tipo=(id('e_tipo').value||'Tradicional');
  var precio=parseEs(id('e_precio').value);
  var itp   =parseEs(id('e_itp_eur').value)||Math.round(precio*(cfg.itp_pct/100));
  var notari=parseEs(id('e_notaria').value)||cfg.notaria_eur;
  var ref   =parseEs(id('e_reforma').value);
  var honor =(id('e_honor').value==='si')?cfg.psi_eur:0;

  var comu=parseEs(id('e_comunidad').value);
  var ibi =parseEs(id('e_ibi').value);
  var hogar=parseEs(id('e_hogar').value);
  var impago=parseEs(id('e_impago').value);
  var gest=parseEs(id('e_gestion').value);

  var alq_m=parseEs(id('e_alq').value);
  var alq_a=alq_m*12;

  var inv_total=precio+itp+notari+ref+honor;
  var gastos_a =comu+ibi+hogar+impago+gest;

  var bruta=inv_total>0?(alq_a/inv_total*100):0;
  var neta =inv_total>0?((alq_a-gastos_a)/inv_total*100):0;
  var flujo=alq_a-gastos_a;

  var obj_bruta=(tipo==='Habitaciones')?cfg.obj_bruta_hab:cfg.obj_bruta_trad;
  var gapB=bruta-obj_bruta;
  var obj_neta =(tipo==='Habitaciones')?cfg.obj_neta_hab:cfg.obj_neta_trad;
  var gapN=neta-obj_neta;

  var rate=cfg.itp_pct/100;
  var targetInv=(obj_bruta>0)?(alq_a/(obj_bruta/100)):0;
  var pmax=0;
  if(targetInv>0){
    var extras=(notari+ref+honor);
    pmax=Math.max(0,Math.floor((targetInv-extras)/(1+rate)));
  }

  id('r_inv').textContent=e0(inv_total);
  id('r_bruta').textContent=pct1(bruta);
  id('r_neta').textContent=pct1(neta);
  id('r_flujo').textContent=e0(flujo);
  id('r_pmax').textContent=e0(pmax);
  id('e_pmax').value=n0(pmax);

  paintDot('sb',gapB); paintDot('sn',gapN); paintDot('sf',flujo>=0?1:-1);
  id('r_bruta_diff').textContent=gapText(gapB);
  id('r_neta_diff').textContent =gapText(gapN);

  // Render grid de clientes potenciales
  renderCandidates({
    tipo:tipo, loc:id('e_loc').value||'',
    bruta:bruta, neta:neta, flujo:flujo,
    inv_total:inv_total,
    ref_tip:id('e_ref_nec').value||'no',
    asc:id('e_asc').value||'Sí',
    bajo:id('e_bajo').value||'No',
    alt: Number(id('e_alt').value||0)
  });

  id('e_result').hidden=false;

  return {
    id:CURRENT_ID||('ev_'+Date.now()), ts:Date.now(),
    loc:id('e_loc').value||'', calle:id('e_calle').value||'',
    m2:id('e_m2').value||'', anio:id('e_anio').value||'',
    asc:id('e_asc').value||'', alt:id('e_alt').value||'',
    bajo:id('e_bajo').value||'', habs:id('e_habs').value||'',
    banos:id('e_banos').value||'', ref_tip:id('e_ref_nec').value||'no',
    url:id('e_url').value||'', tipo:tipo,
    precio:precio, itp:itp, notaria:notari, psi:honor, reforma:ref,
    comu:comu, ibi:ibi, hogar:hogar, impago:impago, gestion:gest,
    alq:alq_m, inv_total:inv_total, kpi_bruta:bruta, kpi_neta:neta, kpi_flujo:flujo, pmax:pmax
  };
}
function gapText(g){ if(!isFinite(g))return ''; var s=(g>=0?'+':'−')+fmtN1.format(Math.abs(g))+' pts'; return ' ('+s+')'; }
function paintDot(dot,gap){ var el=id(dot); el.className='dot '+(gap>=0?'g':(gap>-1?'y':'r')); }

/* Helpers de fold y parse */
function fold(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();}
function parseMoney(v){if(v==null)return 0;return Number(String(v).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;}

/* Obtener preferencias del cliente con compat */
function getPref(p,k){
  var pf=p.prefs||{};
  if(k in pf) return pf[k];
  if(k==='tipo') return p.pref_tipo||'';
  if(k==='localidades') return p.locs_text||'';
  if(k==='ascensor') return p.ascensor||'';
  if(k==='reforma') return p.pref_reforma||'';
  if(k==='evitar_bajos') return p.no_bajo||'';
  if(k==='altura_min') return p.altura_min||'';
  if(k==='presupuesto_max') return p.presupuesto_max||'';
  return '';
}
/* Info objetivo principal del cliente */
function getTargetInfo(p){
  var main=(p.obj_main||p.obj_tipo||'').toString().toLowerCase().trim();
  var b=Number(p.obj_bruta||0), n=Number(p.obj_neta||0), fm=Number(p.obj_flujo||0), fa=Number(p.obj_flujo_anual||0);
  if(main==='bruta'&&b>0) return {kind:'bruta',val:b};
  if(main==='neta' &&n>0) return {kind:'neta', val:n};
  if(main==='flujo'&&(fm>0||fa>0)) return {kind:'flujo',val:(fa>0?fa:fm*12)};
  if(b>0) return {kind:'bruta',val:b};
  if(n>0) return {kind:'neta', val:n};
  if(fa>0||fm>0) return {kind:'flujo',val:(fa>0?fa:fm*12)};
  return {kind:'',val:0};
}
/* Clasificación KPI con thresholds */
function classifyRatio(actual,target,thresholds){
  if(!target||target<=0) return {cls:'r',ratio:0};
  var ratio = actual/target;
  var green = Number(thresholds.green||1);
  var amber = Number(thresholds.amber||0.95);
  var cls = ratio>=green ? 'g' : (ratio>=amber ? 'y' : 'r');
  return {cls:cls, ratio:ratio};
}

/* Cálculo CTO del cliente (como en Dashboard) */
function ctoCliente(p){
  var cfg=getCfg();
  var Pmax = Number(p.inv_pmax||0);
  if(!Pmax) return 0;
  var inclPsi = !!p.psi_in_presupuesto;
  // CTO cliente: si incluye PSI en presupuesto → es Pmax; si no → Pmax + PSI
  return Math.round(Pmax + (inclPsi?0:cfg.psi_eur));
}

/* Render grid único de clientes */
function renderCandidates(ctx){
  var grid=id('candGrid'); var empty=id('noMatchMsg'); grid.innerHTML=''; empty.style.display='none';
  var cfg=getCfg();
  var clients=(Store.pros||[]).filter(function(p){
    var f=fold(p.fase||'');
    if(f.includes('compra')||f.includes('compraventa')||f.includes('éxito')||f.includes('exito')) return false;
    if(p.archivado) return false;
    return true;
  });
  var any=false, selectedCount=0;

  // Para selección previa (si ya está asignado este eval)
  var evId = CURRENT_ID || localStorage.getItem('load_eval') || null;

  clients.forEach(function(p){
    var tgt=getTargetInfo(p); if(!tgt.val){ return; } // si no tiene objetivo, no mostramos

    // KPI principal del activo frente a objetivo del cliente
    var actual = (tgt.kind==='bruta')? Number(ctx.bruta||0)
               : (tgt.kind==='neta') ? Number(ctx.neta||0)
               : Number(ctx.flujo||0);
    var cls = classifyRatio(actual, Number(tgt.val), cfg.thresholds).cls;

    // Criterios “duros”
    var locs=(getPref(p,'localidades')||'').toString().split(',').map(fold).filter(Boolean);
    var locOk = (!locs.length) ? true : (locs.includes(fold(ctx.loc||'')));
    var tipoOk = (!getPref(p,'tipo')) ? true : (fold(getPref(p,'tipo'))===fold(ctx.tipo||''));
    var budget=ctoCliente(p); var budgetOk = (budget>0) ? (Number(ctx.inv_total||0) <= budget) : true;

    // Preferencias activo (ascensor/reforma/bajo/altura)
    var ascPref = fold(getPref(p,'ascensor')||'indiferente'); // 'indiferente'|'requiere'|'no'|'si'
    var ascOk = true;
    if(ascPref==='requiere'){ ascOk = (fold(ctx.asc)==='si' || fold(ctx.asc)==='sí'); }
    else if(ascPref==='no'){ ascOk = (fold(ctx.asc)==='no'); }

    var refPref = fold(getPref(p,'reforma')||'indiferente'); // 'indiferente'|'no'|'lavado'|'integral'|'si'
    var refOk = true;
    if(refPref==='no'){ refOk = (fold(ctx.ref_tip)==='no'); }

    var bajoPref = fold(getPref(p,'evitar_bajos')||'no'); // 'si'|'no'
    var bajoOk = true;
    if(bajoPref==='si'||bajoPref==='sí'){ bajoOk = (fold(ctx.bajo)!=='si'); }

    var altMin = Number(getPref(p,'altura_min')||0);
    var altOk = (altMin>0)? (Number(ctx.alt||0) >= altMin) : true;

    var allOk = locOk && tipoOk && budgetOk && ascOk && refOk && bajoOk && altOk;

    // Estado visual:
    // ★ si cls=g y allOk; ● verde+⚠ si cls=g pero !allOk; ● y/r si no alcanza
    var stateHTML='';
    var warnHTML='';
    if(cls==='g' && allOk){
      stateHTML = '<span class="star" title="Supermatch"><svg viewBox="0 0 24 24"><path d="M12 3.6l2.9 5.9 6.5.9-4.7 4.6 1.1 6.5L12 18.8 6.2 21.5l1.1-6.5-4.7-4.6 6.5-.9L12 3.6z"/></svg></span>';
      stateHTML += '<span class="dot g" title="Objetivo cumplido"></span>';
    }else if(cls==='g'){
      stateHTML = '<span class="dot g" title="Objetivo cumplido"></span>';
      if(cfg.warnsOnlyGreen!==false){ // por defecto solo avisamos cuando KPI está en verde
        warnHTML = '<span class="warn" title="Algún criterio no se cumple (localidad/tipo/presupuesto/preferencias)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="#b45309" stroke-width="1.4" fill="none"/><path d="M12 7v6m0 4h.01" stroke="#b45309" stroke-width="1.8" stroke-linecap="round"/></svg> Aviso</span>';
      }
    }else{
      var clsMap = (cls==='y')?'y':'r';
      stateHTML = '<span class="dot '+clsMap+'"></span>';
    }

    // ¿ya asignado?
    var already=false;
    try{
      var prosList=Store.pros||[];
      var idx=prosList.findIndex(function(pp){return pp.id===p.id;});
      if(idx>=0 && evId){
        var set=new Set(prosList[idx].asset_ids||[]);
        already = set.has(evId);
      }
    }catch(_){}

    var row=document.createElement('div'); row.className='crow';
    row.innerHTML =
      '<div class="cact"><input type="checkbox" class="cchk" data-pid="'+(p.id||'')+'" '+(already?'checked':'')+'> <label>Asignar</label></div>'+
      '<div>'+
        '<div class="cname">'+(p.nombre||'-')+' '+(p.apellidos||'')+'</div>'+
        '<div class="cmeta">Fase: '+(p.fase||'-')+'</div>'+
      '</div>'+
      '<div class="cstate">'+stateHTML+ (warnHTML||'') +'</div>'+
      '<div class="cmeta">'+(getPref(p,'tipo')||p.pref_tipo||'')+' · '+((getPref(p,'localidades')||'').toString().split(',')[0]||'')+'</div>';
    grid.appendChild(row);
    any=true;
  });

  // Mensajes cuando no hay matches (o ningún cliente activo)
  if(!any){
    // Si bruta >= objetivo mínimo de configuración → buen activo
    var tipoTxt=(ctx.tipo||'Tradicional');
    var objMin = (tipoTxt==='Habitaciones') ? cfg.obj_bruta_hab : cfg.obj_bruta_trad;
    var br = Number(ctx.bruta||0);
    if(br >= objMin){
      empty.innerHTML='Buen activo para guardar: la rentabilidad bruta ('+fmtN1.format(br)+' %) supera el objetivo mínimo ('+fmtN1.format(objMin)+' %).';
      empty.style.display='block';
    }else{
      // Sugerir rebaja de precio de compra para alcanzar objMin
      var alq_a = (parseEs(id('e_alq').value)||0) * 12;
      var rate = cfg.itp_pct/100;
      var notari = parseEs(id('e_notaria').value)||cfg.notaria_eur;
      var ref = parseEs(id('e_reforma').value)||0;
      var honor = (id('e_honor').value==='si')?cfg.psi_eur:0;
      var extras = notari + ref + honor;
      var targetInv = (objMin>0)? (alq_a/(objMin/100)) : 0;
      var pmax = targetInv>0 ? Math.max(0,Math.floor((targetInv-extras)/(1+rate))) : 0;
      var precioActual = parseEs(id('e_precio').value)||0;
      var rebaja = Math.max(0, precioActual - pmax);
      var pct = (precioActual>0)? (rebaja/precioActual*100) : 0;
      empty.innerHTML='Rentabilidad insuficiente. Sugerencia: precio objetivo aproximado '+e0(pmax)+' (rebaja de '+e0(rebaja)+' · '+fmtN1.format(pct)+' %).';
      empty.style.display='block';
    }
  }
}

/* Guardar / Asignar */
function gather(){return calc();}
function save(alsoAssign){
  var e=gather();
  var loaded=localStorage.getItem('load_eval'); var list=Store.evals||[];
  if(loaded){
    var idx=list.findIndex(function(x){return x.id===loaded;});
    if(idx>=0){e.id=list[idx].id; e.ts=list[idx].ts; CURRENT_ID=e.id;}
    localStorage.removeItem('load_eval');
  }
  if(CURRENT_ID) e.id=CURRENT_ID;

  // Persist evaluación
  var at=list.findIndex(function(x){return x.id===e.id;});
  if(at>=0) list[at]=e; else list.push(e);
  Store.evals=list; CURRENT_ID=e.id;

  // Asignaciones al Dashboard (pros[].asset_ids)
  if(alsoAssign){
    var checks=[].slice.call(document.querySelectorAll('#candGrid .cchk'));
    var selectedIds=checks.filter(function(c){return c.checked;}).map(function(c){return c.getAttribute('data-pid');});
    var prosList=Store.pros||[];
    var updated=0;
    selectedIds.forEach(function(pid){
      var i=prosList.findIndex(function(pp){return pp.id===pid;});
      if(i>=0){
        var set=new Set(prosList[i].asset_ids||[]);
        if(!set.has(e.id)){ set.add(e.id); updated++; }
        prosList[i].asset_ids=Array.from(set);
      }
    });
    Store.pros=prosList;
    toast('Guardado y asignado a '+selectedIds.length+' cliente(s)','ok');
  }else{
    toast('Evaluación guardada','ok');
  }
}

/* Limpiar */
function limpiar(){
  [].forEach.call(document.querySelectorAll('input'),function(i){i.value='';});
  [].forEach.call(document.querySelectorAll('select'),function(s){
    if(s.id==='e_tipo'){s.value='Tradicional';}
    else if(s.id==='e_honor'){s.value='no';}
    else s.selectedIndex=0;
  });
  document.getElementById('e_result').hidden=true; CURRENT_ID=null;
}

/* Precarga desde Evaluaciones */
function preloadIfAny(){
  var evId=localStorage.getItem('load_eval'); if(!evId)return;
  var e=(Store.evals||[]).find(function(x){return x.id===evId;}); if(!e)return;
  CURRENT_ID=e.id;
  id('e_loc').value=e.loc||''; id('e_calle').value=e.calle||''; id('e_m2').value=e.m2||'';
  id('e_anio').value=e.anio||''; id('e_asc').value=e.asc||'Sí'; id('e_alt').value=e.alt||'';
  id('e_bajo').value=e.bajo||'No'; id('e_habs').value=e.habs||''; id('e_banos').value=e.banos||'';
  id('e_ref_nec').value=e.ref_tip||'no'; id('e_url').value=e.url||'';
  id('e_tipo').value=e.tipo||'Tradicional';
  id('e_precio').value=n0(e.precio||0); id('e_itp_eur').value=n0(e.itp||0); id('e_notaria').value=n0(e.notaria||0);
  id('e_reforma').value=n0(e.reforma||0); id('e_honor').value=(e.psi&&e.psi>0)?'si':'no';
  id('e_comunidad').value=n0(e.comu||0); id('e_ibi').value=n0(e.ibi||0); id('e_hogar').value=n0(e.hogar||0);
  id('e_impago').value=n0(e.impago||0); id('e_gestion').value=n0(e.gestion||0); id('e_alq').value=n0(e.alq||0);
  calc();
}

/* Eventos */
function attach(){
  loadLocalidades(); moneyLive(); bindAuto();
  id('e_calc').addEventListener('click',calc);
  id('e_save').addEventListener('click',function(){save(false);});
  id('e_save_assign').addEventListener('click',function(){save(true);});
  if(id('save_only'))  id('save_only').addEventListener('click',function(){save(false);});
  if(id('save_assign'))id('save_assign').addEventListener('click',function(){save(true);});
  id('e_clean').addEventListener('click',limpiar);
  preloadIfAny();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>

<div id="toasts" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
