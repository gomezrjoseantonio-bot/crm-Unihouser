<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* ————— Estilos locales mínimos (respetando look & feel global) ————— */
.grid3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
@media(max-width:1100px){.grid3{grid-template-columns:1fr}}
.grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.field small{color:#6b7280}
.kpis{display:grid;gap:10px;grid-template-columns:repeat(5,1fr)}
.kpi{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
.kpi .lab{font-size:12px;color:#667085}
.kpi .val{font-weight:800;font-size:20px}
.result-card{margin-top:14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
.btn.sm{padding:8px 10px;font-size:13px;border-radius:10px}
.list-sug{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.sug{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff}
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;font-size:12px}
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}
canvas{width:100%;height:220px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Evaluar Activo</h2>

    <!-- ===== Datos del inmueble ===== -->
    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 10px">Datos del inmueble</h3>
      <div class="grid3">
        <div class="field">
          <label>Localidad</label>
          <select id="e_loc">
            <option>Oviedo</option><option>Gijón</option><option>Avilés</option>
            <option>Mieres</option><option>Langreo</option><option>Siero</option>
            <option>Llanera</option><option>Castrillón</option><option>Corvera</option>
            <option>Gozón</option><option>Aller</option><option>Lena</option>
            <option>San Martín del Rey Aurelio</option><option>Laviana</option>
            <option>Pravia</option><option>Noreña</option><option>Grado</option>
            <option>Cangas de Onís</option><option>Villaviciosa</option>
            <option>Navia</option><option>Valdés</option><option>Tineo</option>
            <option>Allande</option><option>Ribadesella</option><option>Luarca</option>
          </select>
        </div>
        <div class="field">
          <label>Calle</label>
          <input id="e_calle" placeholder="C/ Ejemplo 1">
        </div>
        <div class="field">
          <label>URL Idealista (opcional)</label>
          <input id="e_url" placeholder="https://...">
        </div>

        <div class="field">
          <label>Año construcción — opcional</label>
          <input id="e_anio" inputmode="numeric" placeholder="1975">
        </div>
        <div class="field">
          <label>Superficie (m²) — opcional</label>
          <input id="e_m2" inputmode="numeric" placeholder="72">
        </div>
        <div class="field">
          <label>Necesita reforma</label>
          <select id="e_reforma_tipo">
            <option value="no">No</option>
            <option value="lavado">Lavado de cara</option>
            <option value="integral">Integral</option>
          </select>
        </div>

        <div class="field">
          <label>Altura (planta)</label>
          <input id="e_altura" inputmode="numeric" placeholder="1">
        </div>
        <div class="field">
          <label>¿Ascensor?</label>
          <select id="e_asc">
            <option>Sí</option><option>No</option>
          </select>
        </div>
        <div class="field">
          <label>¿Es bajo?</label>
          <select id="e_bajo">
            <option>No</option><option>Sí</option>
          </select>
        </div>

        <div class="field">
          <label>Habitaciones</label>
          <input id="e_hab" inputmode="numeric" value="3">
        </div>
        <div class="field">
          <label>Baños</label>
          <input id="e_banos" inputmode="numeric" value="1">
        </div>
        <div></div>
      </div>
    </div>

    <!-- ===== Gastos de adquisición ===== -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 10px">Gastos de adquisición</h3>
      <div class="grid3">
        <div class="field">
          <label>Precio de compra (€)</label>
          <input id="e_precio" data-money placeholder="55.000">
        </div>
        <div class="field">
          <label>ITP (€ — auto)</label>
          <input id="e_itp" data-money disabled>
        </div>
        <div class="field">
          <label>Reforma (€)</label>
          <input id="e_reforma" data-money value="0">
        </div>

        <div class="field">
          <label>Notaría y Registro (€ — auto)</label>
          <input id="e_notaria" data-money disabled>
        </div>
        <div class="field">
          <label>Incluir honorarios PSI (con IVA)</label>
          <select id="e_incluir_psi"><option value="si">Sí</option><option value="no">No</option></select>
        </div>
        <div class="field">
          <label>Precio máx. compra (objetivo)</label>
          <input id="e_pmax" data-money disabled>
        </div>
      </div>
      <small>El precio máx. se calcula con Configuración (ITP/Notaría) y, si marcas “Sí”, con *PSI 4.235 €*.</small>
    </div>

    <!-- ===== Gastos de mantenimiento ===== -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 10px">Gastos de mantenimiento</h3>
      <div class="grid3">
        <div class="field"><label>Comunidad (€/año)</label><input id="e_comu" data-money value="0"></div>
        <div class="field"><label>IBI (€/año)</label><input id="e_ibi" data-money value="0"></div>
        <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" data-money value="0" disabled></div>
        <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" data-money value="0" disabled></div>
        <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" data-money value="0" disabled></div>
        <div></div>
      </div>
      <small>Hogar/impago/gestión se autocalculan al indicar *alquiler* y *tipo*.</small>
    </div>

    <!-- ===== Tipo e ingresos ===== -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 10px">Tipo de explotación e ingresos</h3>
      <div class="grid2">
        <div class="field">
          <label>Tipo de alquiler</label>
          <select id="e_tipo">
            <option>Tradicional</option>
            <option>Habitaciones</option>
          </select>
        </div>
        <div class="field">
          <label>Alquiler mensual (€)</label>
          <input id="e_alq" data-money placeholder="500">
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="b_calc" class="btn primary">Calcular</button>
        <button id="b_limpiar" class="btn">Limpiar</button>
        <button id="b_guardar" class="btn">Guardar evaluación</button>
      </div>
    </div>

    <!-- ===== Resultados ===== -->
    <div class="result-card" id="e_result" hidden>
      <div class="kpis">
        <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">0 €</div></div>
        <div class="kpi"><div class="lab">Rentabilidad bruta</div><div class="val" id="r_bruta">0,0 %</div></div>
        <div class="kpi"><div class="lab">Rentabilidad neta</div><div class="val" id="r_neta">0,0 %</div></div>
        <div class="kpi"><div class="lab">Flujo de caja anual</div><div class="val" id="r_flujo">0 €</div></div>
        <div class="kpi"><div class="lab">Precio máx. compra (estimado)</div><div class="val" id="r_pmax">0 €</div></div>
      </div>

      <div style="margin-top:12px">
        <canvas id="chart"></canvas>
      </div>

      <div style="margin-top:16px">
        <h3 style="margin:0 0 8px">Clientes potenciales</h3>
        <div class="list-sug" id="sugs"></div>
      </div>
    </div>
  </section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>
<div id="toasts" class="toast-wrap"></div>

<script>
(function(){
"use strict";

/* ===== Utils comunes ===== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
function parseEs(str){ if(str==null) return 0; const s=String(str).trim().replace(/\./g,'').replace(',', '.'); const n=Number(s); return Number.isFinite(n)?n:0; }
function toast(msg,kind){ const w=id('toasts'); const el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg; w.appendChild(el); setTimeout(()=>el.style.opacity='0',1600); setTimeout(()=>{try{w.removeChild(el)}catch(_){}} ,2200); }
const Store={ get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(){return{}}}, set cfg(v){localStorage.setItem('cfg',JSON.stringify(v))}, get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(){return[]}}, set evals(v){localStorage.setItem('evals',JSON.stringify(v))}, get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}}, set pros(v){localStorage.setItem('pros',JSON.stringify(v))} };

/* ===== Defaults de Config ===== */
function cfgOrDefault(){
  const c = Store.cfg||{};
  return {
    itp_pct: Number(c.itp_pct ?? c.itp ?? 8),
    notaria: Number(c.notaria ?? 1500),
    psi_iva: Number(c.psi_iva ?? 4235),
    hogar_pct: Number(c.hogar_pct ?? 1),
    impago_trad_pct: Number(c.impago_trad_pct ?? 2),
    impago_hab_pct: Number(c.impago_hab_pct ?? 3),
    gest_trad_pct: Number(c.gest_trad_pct ?? 8),
    gest_hab_pct: Number(c.gest_hab_pct ?? 12),
    obj_bruta_trad: Number(c.obj_bruta_trad ?? 10),
    obj_bruta_hab: Number(c.obj_bruta_hab ?? 12),
    match: c.match || {wLoc:0.4,wTipo:0.3,wObj:0.3,thresh:0.6}
  };
}

/* ===== Autocálculos ===== */
function autoAdquisicion(){
  const cfg = cfgOrDefault();
  const precio = parseEs(id('e_precio').value);
  const itp = Math.round(precio * (cfg.itp_pct/100));
  id('e_itp').value = fmtN0.format(itp);
  id('e_notaria').value = fmtN0.format(cfg.notaria);
}
function autoMantenimiento(){
  const cfg = cfgOrDefault();
  const tipo = id('e_tipo').value==='Habitaciones'?'hab':'trad';
  const alq = parseEs(id('e_alq').value);
  const anual = alq*12;
  const hogar = Math.round(anual * (cfg.hogar_pct/100));
  const impago = Math.round(anual * ((tipo==='hab'?cfg.impago_hab_pct:cfg.impago_trad_pct)/100));
  const gestion = Math.round(anual * ((tipo==='hab'?cfg.gest_hab_pct:cfg.gest_trad_pct)/100));
  id('e_hogar').value = fmtN0.format(hogar);
  id('e_impago').value = fmtN0.format(impago);
  id('e_gestion').value = fmtN0.format(gestion);
  // recalcular pmax con objetivo
  calcPmax();
}
function calcPmax(){
  const cfg = cfgOrDefault();
  const alq = parseEs(id('e_alq').value);
  const anual = alq*12;
  const notaria = cfg.notaria;
  const psi = (id('e_incluir_psi').value==='si') ? cfg.psi_iva : 0;
  const reforma = parseEs(id('e_reforma').value);
  const tipoSel = id('e_tipo').value;
  const objetivo = (tipoSel==='Habitaciones'?cfg.obj_bruta_hab:cfg.obj_bruta_trad)/100 || 0.10;
  if(!anual || !objetivo){ id('e_pmax').value=''; return; }
  const numerador = (anual/objetivo) - notaria - psi - reforma;
  const pmax = Math.max(0, Math.floor(numerador / (1 + cfg.itp_pct/100)));
  id('e_pmax').value = fmtN0.format(pmax);
}

/* ===== Cálculo principal ===== */
function calcular(){
  const cfg = cfgOrDefault();
  autoAdquisicion(); // asegura itp/notaria
  const precio   = parseEs(id('e_precio').value);
  const itp      = parseEs(id('e_itp').value);
  const notaria  = parseEs(id('e_notaria').value);
  const reforma  = parseEs(id('e_reforma').value);
  const incluirPsi = id('e_incluir_psi').value==='si';
  const psi = incluirPsi ? cfg.psi_iva : 0;

  const comu     = parseEs(id('e_comu').value);
  const ibi      = parseEs(id('e_ibi').value);
  const hogar    = parseEs(id('e_hogar').value);
  const impago   = parseEs(id('e_impago').value);
  const gestion  = parseEs(id('e_gestion').value);

  const alq_m    = parseEs(id('e_alq').value);
  const alq_a    = alq_m*12;

  const inv_total = precio + itp + notaria + psi + reforma;
  const gastos_an = comu + ibi + hogar + impago + gestion;
  const neto_an   = Math.max(0, alq_a - gastos_an);

  const bruta = inv_total>0 ? (alq_a/inv_total)*100 : 0;
  const neta  = inv_total>0 ? (neto_an/inv_total)*100 : 0;

  // Pmax objetivo (bruta objetivo)
  calcPmax();
  const pmax = parseEs(id('e_pmax').value);

  // Pinta KPIs
  id('r_inv').textContent   = e0(inv_total);
  id('r_bruta').textContent = fmtN1.format(bruta)+' %';
  id('r_neta').textContent  = fmtN1.format(neta)+' %';
  id('r_flujo').textContent = e0(neto_an);
  id('r_pmax').textContent  = e0(pmax);
  id('e_result').hidden=false;

  drawChart(bruta);

  // Sugerencias
  renderSugerencias({tipo:id('e_tipo').value, loc:id('e_loc').value, bruta, neto:neta, flujo:neto_an});
}

/* ===== Gráfico (bruta vs objetivo) ===== */
function drawChart(bruta){
  const cfg = cfgOrDefault();
  const tipoSel = id('e_tipo').value;
  const objetivo = (tipoSel==='Habitaciones'?cfg.obj_bruta_hab:cfg.obj_bruta_trad);
  const cvs = id('chart'); const ctx = cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const W=cvs.width, H=cvs.height, pad=30;

  // Ejes
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();

  const maxY = Math.max(objetivo, bruta, 20);
  const barW = 80, xBar = pad+50, base=H-pad;
  const scale = (val)=> base - (val/maxY)*(H-2*pad);

  // Barra Bruta
  ctx.fillStyle='#22c55e';
  ctx.fillRect(xBar, scale(bruta), barW, base - scale(bruta));
  ctx.fillStyle='#111827';
  ctx.fillText('Bruta', xBar+10, base+14);
  ctx.fillText(fmtN1.format(bruta)+'%', xBar+8, scale(bruta)-6);

  // Línea objetivo
  ctx.strokeStyle='#f97316'; ctx.setLineDash([6,6]);
  ctx.beginPath(); ctx.moveTo(pad, scale(objetivo)); ctx.lineTo(W-pad, scale(objetivo)); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='#f97316';
  ctx.fillText('Objetivo '+fmtN1.format(objetivo)+'%', pad+6, scale(objetivo)-6);
}

/* ===== Sugerencias (lee pesos de Configuración) ===== */
function renderSugerencias(ctx){
  const c = cfgOrDefault();
  const wLoc=c.match.wLoc??0.4, wTipo=c.match.wTipo??0.3, wObj=c.match.wObj??0.3;
  const thresh=c.match.thresh??0.6;
  const list = Store.pros||[];
  const arr = list.map(p=>{
    let s=0;
    // Localidad (texto contiene)
    const locsText = (p.locs_text||p.localidades||'').toString().toLowerCase();
    if(locsText.includes((ctx.loc||'').toLowerCase())) s+=wLoc;

    // Tipo coincide
    if( (p.pref_tipo||p.tipo||'').toString().toLowerCase() === (ctx.tipo||'').toLowerCase() ) s+=wTipo;

    // Objetivo
    const obj = (p.objetivo||p.obj||'').toLowerCase();
    const val = Number(p.valor_objetivo||p.obj_val||0);
    if(obj.includes('bruta') && ctx.bruta>=val) s+=wObj;
    else if(obj.includes('neta') && ctx.neto>=val) s+=wObj;
    else if(obj.includes('flujo') && ctx.flujo>=val) s+=wObj;

    return {p,score:s};
  }).filter(x=>x.score>=thresh).sort((a,b)=>b.score-a.score).slice(0,6);

  const wrap=id('sugs'); wrap.innerHTML='';
  if(!arr.length){ wrap.innerHTML='<div class="sug">Sin candidatos con el umbral actual.</div>'; return; }
  arr.forEach(({p,score})=>{
    const div=document.createElement('div'); div.className='sug';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${p.nombre||'—'}</strong>
        <span class="pill">${Math.round(score*100)}%</span>
      </div>
      <div style="margin-top:6px;color:#667085;font-size:13px">
        ${p.pref_tipo||'-'} · ${p.locs_text||p.localidades||'-'}
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn sm" data-asg="${p.id||p.email||p.nombre||''}">Asignar</button>
      </div>`;
    wrap.appendChild(div);
  });

  wrap.addEventListener('click',ev=>{
    const b=ev.target.closest('button[data-asg]'); if(!b) return;
    guardar(true, b.dataset.asg);
  }, {once:true});
}

/* ===== Guardado ===== */
function guardar(asignar, prospectId){
  // Calcula si no está calculado aún
  if(id('e_result').hidden) calcular();

  const obj = {
    id: 'ev_'+Date.now(),
    ts: Date.now(),
    loc: id('e_loc').value,
    calle: id('e_calle').value,
    url: id('e_url').value,
    tipo: id('e_tipo').value,
    precio: parseEs(id('e_precio').value),
    itp: parseEs(id('e_itp').value),
    notaria: parseEs(id('e_notaria').value),
    psi: (id('e_incluir_psi').value==='si') ? cfgOrDefault().psi_iva : 0,
    reforma: parseEs(id('e_reforma').value),
    comu: parseEs(id('e_comu').value),
    ibi: parseEs(id('e_ibi').value),
    hogar: parseEs(id('e_hogar').value),
    impago: parseEs(id('e_impago').value),
    gestion: parseEs(id('e_gestion').value),
    alq: parseEs(id('e_alq').value),
    inv_total: parseEs(id('r_inv').textContent),
    kpi_bruta: parseFloat(id('r_bruta').textContent.replace('%','').replace(',','.')),
    kpi_neta: parseFloat(id('r_neta').textContent.replace('%','').replace(',','.')),
    kpi_flujo: parseEs(id('r_flujo').textContent),
    pmax: parseEs(id('r_pmax').textContent),
    prospect_ids: asignar && prospectId ? [prospectId] : []
  };
  const list = Store.evals||[]; list.push(obj); Store.evals=list;
  toast('Evaluación guardada','ok');
}

/* ===== Cargar desde Evaluaciones ===== */
function loadFromEvaluaciones(){
  const key='_load_eval_'; const idEv=localStorage.getItem(key); if(!idEv) return;
  localStorage.removeItem(key);
  const e=(Store.evals||[]).find(x=>x.id===idEv); if(!e) return;

  id('e_loc').value = e.loc||'Oviedo';
  id('e_calle').value = e.calle||'';
  id('e_url').value = e.url||'';
  id('e_tipo').value = e.tipo||'Tradicional';

  id('e_precio').value = fmtN0.format(e.precio||0);
  id('e_reforma').value = fmtN0.format(e.reforma||0);
  id('e_incluir_psi').value = (e.psi&&e.psi>0)?'si':'no';
  autoAdquisicion();

  id('e_comu').value = fmtN0.format(e.comu||0);
  id('e_ibi').value = fmtN0.format(e.ibi||0);
  id('e_alq').value = fmtN0.format(e.alq||0);
  autoMantenimiento();

  calcular(); // pinta resultados
}

/* ===== Eventos ===== */
function bind(){
  id('e_precio').addEventListener('input', autoAdquisicion);
  id('e_alq').addEventListener('input', autoMantenimiento);
  id('e_tipo').addEventListener('change', autoMantenimiento);
  id('e_incluir_psi').addEventListener('change', calcPmax);
  id('e_reforma').addEventListener('input', calcPmax);

  id('b_calc').addEventListener('click', calcular);
  id('b_limpiar').addEventListener('click', ()=>{
    document.querySelectorAll('input').forEach(inp=>{ if(!inp.disabled) inp.value='';});
    id('e_tipo').value='Tradicional';
    id('e_incluir_psi').value='si';
    id('e_result').hidden=true;
  });
  id('b_guardar').addEventListener('click', ()=>guardar(false));
}

/* ===== Inicio ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  autoAdquisicion();
  bind();
  loadFromEvaluaciones();
});
})();
</script>
</body>
</html>
