<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<style>
:root{
--accent:#ff6a3d; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
--muted:#667085; --border:#e5e7eb; --text:#101828; --bg:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:1100px;margin:0 auto;padding:16px}
.topbar{background:#fff;border-bottom:1px solid var(--border)}
.brand .title{font-weight:800}
.nav a{margin:0 8px;text-decoration:none;color:#475467}
.nav a.active{color:var(--accent);font-weight:800}
.page-title{margin:14px 0 8px;color:#101828;font-weight:800;letter-spacing:-.02em;font-size:clamp(22px,2.4vw,28px)}
.card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(16,24,40,.04);padding:12px;margin-bottom:12px}
.section{margin:8px 0 10px}
.section h3{margin:0 0 8px}
.row{display:grid;gap:10px;grid-template-columns:1fr}
@media(min-width:680px){.row.two{grid-template-columns:1fr 1fr}.row.three{grid-template-columns:1fr 1fr 1fr}.row.four{grid-template-columns:1fr 1fr 1fr 1fr}}
.field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,button{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}
input[disabled]{background:#f9fafb}
.btn{background:#f9fafb;border:1px solid var(--border);color:var(--text);font-weight:700;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:transparent}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.kpis{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(min-width:900px){.kpis{grid-template-columns:repeat(5,1fr)}}
.kpi{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
.kpi .lab{font-size:12px;color:var(--muted)}
.kpi .val{font-size:20px;font-weight:800;margin-top:2px}
.dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-left:6px;vertical-align:middle}
.dot.green{background:var(--ok)} .dot.amber{background:var(--warn)} .dot.red{background:var(--bad)} .dot.gray{background:#d0d5dd}
.chartWrap{margin-top:10px;border:1px solid var(--border);border-radius:12px;padding:8px}
.muted{color:#667085}
.list{min-height:60px;border:1px dashed #e5e7eb;border-radius:10px;padding:8px}
.foot{text-align:center;color:#667085;margin:20px 0 10px}
.toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:80}
.toast{background:#111827;color:#fff;border-radius:10px;padding:10px 12px;box-shadow:0 10px 24px rgba(0,0,0,.25);opacity:.96}
.toast.ok{background:#15803d} .toast.warn{background:#b45309} .toast.bad{background:#b91c1c}
</style>
</head>
<body>
<header class="topbar">
<div class="container" style="display:flex;justify-content:space-between;align-items:center">
<div class="brand"><div class="title">Unihouser — CRM & BuyBox</div></div>
<nav class="nav">
<a href="evaluar.html" class="active">Evaluar</a>
<a href="evaluaciones.html">Evaluaciones</a>
<a href="prospectos.html">Prospectos</a>
<a href="dashboard.html">Dashboard</a>
<a href="configuracion.html">Configuración</a>
</nav>
</div>
</header>

<main class="container">
<h2 class="page-title">Evaluar Activo</h2>

<section class="card">
<div class="section">
<h3>Datos del inmueble</h3>
<div class="row three">
<div class="field"><label>Localidad</label><select id="e_loc"></select></div>
<div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
<div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>
</div>
<div class="row four">
<div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
<div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
<div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
<div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
</div>
<div class="row three">
<div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>
<div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
<div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
</div>
</div>

<div class="section">
<h3>Gastos de adquisición</h3>
<div class="row three">
<div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
<div class="field"><label>ITP (€ auto)</label><input id="e_itp_eur" data-money disabled></div>
<div class="field"><label>Notaría y Registro (€ auto)</label><input id="e_notaria" data-money disabled></div>
</div>
<div class="row three">
<div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
<div class="field"><label>Incluir honorarios PSI (con IVA)</label><select id="e_honor"><option value="si">Sí</option><option value="no">No</option></select></div>
<div class="field"><label>Precio máx. compra</label><input id="e_pmax" data-money disabled></div>
</div>
</div>

<div class="section">
<h3>Gastos de mantenimiento</h3>
<div class="row three">
<div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
<div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
<div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>
</div>
<div class="row three">
<div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
<div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
<div class="field"><small class="muted">Hogar/impago/gestión se autocalculan al indicar alquiler y tipo, según Config. Editables.</small></div>
</div>
</div>

<div class="section">
<h3>Tipo de explotación e ingresos</h3>
<div class="row three">
<div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
<div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
<div class="field"><label>Otros ingresos (€/mes)</label><input id="e_otros" value="0" data-money></div>
</div>
</div>

<div class="actions">
<button class="btn primary" id="e_calc">Calcular</button>
<button class="btn" id="e_clean">Limpiar</button>
</div>

<div id="e_result" class="section" hidden>
<h3>Resultados</h3>
<div class="kpis">
<div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
<div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot gray"></span></div><div class="val"><span id="r_bruta">—</span> <span id="r_bruta_diff" class="muted"></span></div></div>
<div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot gray"></span></div><div class="val"><span id="r_neta">—</span> <span id="r_neta_diff" class="muted"></span></div></div>
<div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot gray"></span></div><div class="val" id="r_flujo">—</div></div>
<div class="kpi"><div class="lab">Precio máx. compra (estimado)</div><div class="val" id="r_pmax">—</div></div>
</div>

<div class="chartWrap">
<canvas id="chartKPI" width="460" height="220"></canvas>
</div>

<div class="card" style="margin-top:12px">
<h3 style="margin:0 0 8px">Clientes potenciales</h3>
<div id="matchList" class="list muted">—</div>
<div class="actions" style="margin-top:10px">
<select id="assign_cli" size="4" style="min-width:280px"></select>
<button class="btn" id="save_only">Guardar evaluación</button>
<button class="btn primary" id="save_assign">Guardar y asignar</button>
</div>
</div>

<div id="clientMirror" class="card" style="margin-top:12px" hidden>
<h3 style="margin:0 0 6px">Resumen para el cliente seleccionado</h3>
<div class="kpis">
<div class="kpi"><div class="lab">Cliente</div><div class="val" id="cm_nombre">—</div></div>
<div class="kpi"><div class="lab">Objetivo principal</div><div class="val" id="cm_obj">—</div></div>
<div class="kpi"><div class="lab">Real (KPI)</div><div class="val" id="cm_real">—</div></div>
<div class="kpi"><div class="lab">Objetivo</div><div class="val" id="cm_goal">—</div></div>
<div class="kpi"><div class="lab">Gap</div><div class="val" id="cm_gap">—</div></div>
</div>
</div>
</div>
</section>
</main>

<div class="toast-wrap" id="toasts"></div>
<footer class="foot"><div class="container">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";
/* ===== Store & Config ===== */
var Store = {
get cfg(){ try{return JSON.parse(localStorage.getItem("cfg")||"{}");}catch(_){return{};} },
set cfg(v){ localStorage.setItem("cfg", JSON.stringify(v)); },
get pros(){ try{return JSON.parse(localStorage.getItem("pros")||"[]");}catch(_){return[];} },
set pros(v){ localStorage.setItem("pros", JSON.stringify(v)); },
get evals(){ try{return JSON.parse(localStorage.getItem("evals")||"[]");}catch(_){return[];} },
set evals(v){ localStorage.setItem("evals", JSON.stringify(v)); }
};
function cfgOrDefaults(){
const c = Store.cfg || {};
const itpPct = num(c.itp_pct) || 8; // %
const notaria = num(c.notaria) || 1500; // €
const basePsi = num(c.honorarios) || 3500; // base sin IVA
const honorIVA = Math.round(basePsi * 1.21); // con IVA
// %s para autocalcular sobre alquiler mensual *12
const hogarPct = num(c.hogar_pct) || 3.5;
const impagoTrad = num(c.impago_trad_pct) || 4;
const impagoHab = num(c.impago_hab_pct) || 4;
const gestTrad = num(c.gest_trad_pct) || 15;
const gestHab = num(c.gest_hab_pct) || 25;
// Objetivos por defecto (si no hay cliente): tipo→valor
const goals = {
bruta_trad: num(c.goal_bruta_trad)||10,
neta_trad: num(c.goal_neta_trad)||6,
flujo_trad: num(c.goal_flujo_trad)||0,
bruta_hab: num(c.goal_bruta_hab)||12,
neta_hab: num(c.goal_neta_hab)||7,
flujo_hab: num(c.goal_flujo_hab)||0
};
return { itpPct, notaria, honorIVA, hogarPct, impagoTrad, impagoHab, gestTrad, gestHab, goals };
}

/* ===== Utils ===== */
var fmtN0=new Intl.NumberFormat("es-ES",{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat("es-ES",{maximumFractionDigits:1});
function id(x){return document.getElementById(x);}
function text(n,t){ if(id(n)) id(n).textContent=t; }
function val(n){ return id(n)?id(n).value:""; }
function setv(n,v){ if(id(n)) id(n).value=v; }
function show(n,flag){ if(id(n)) id(n).hidden=!flag; }
function toast(msg,kind){const w=id("toasts"); if(!w) return; const d=document.createElement("div"); d.className="toast "+(kind||""); d.textContent=msg; w.appendChild(d); setTimeout(()=>d.style.opacity="0",1600); setTimeout(()=>{try{w.removeChild(d)}catch(_){}} ,2200);}
function num(v){const s=String(v||"").replace(/\./g,"").replace(",",".");const n=Number(s);return Number.isFinite(n)?n:0;}
function moneyInputLive(){
document.addEventListener("input", e=>{
const t=e.target; if(!t.matches||!t.matches("input[data-money]")) return;
const digits=(t.value||"").replace(/[^\d]/g,"");
t.value=digits?fmtN0.format(+digits):"";
});
document.addEventListener("blur", e=>{
const t=e.target; if(!t.matches||!t.matches("input[data-money]")) return;
t.value = num(t.value)?fmtN0.format(num(t.value)):"";
}, true);
}

/* ===== Localidades Asturias (combo) ===== */
const AST = ["Allande","Aller","Amieva","Avilés","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo","Cangas de Onís","Cangas del Narcea","Caravia","Carreño","Caso","Castrillón","Castropol","Coaña","Colunga","Corvera de Asturias","Cudillero","Degaña","Franco (El)","Gijón","Gozón","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo","Laviana","Lena","Llanera","Llanes","Mieres","Morcín","Muros de Nalón","Nava","Navia","Noreña","Onís","Oviedo","Parres","Peñamellera Alta","Peñamellera Baja","Pesoz","Piloña","Ponga","Pravia","Proaza","Quirós","Regueras (Las)","Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San Martín del Rey Aurelio","San Martín de Oscos","San Tirso de Abres","Santa Eulalia de Oscos","Santo Adriano","Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","Valdés","Vegadeo","Villanueva de Oscos","Villaviciosa"];
function fillLocalidades(){
const sel=id("e_loc"); sel.innerHTML="";
AST.forEach(n=>{ const o=document.createElement("option"); o.textContent=n; sel.appendChild(o); });
}

/* ===== Cálculos ===== */
function calcITP(precio, itpPct){ return Math.round(precio * (itpPct/100)); }
function calcHogar(anualRent, pct){ return Math.round(anualRent * (pct/100)); }
function calcImpago(anualRent, pct){ return Math.round(anualRent * (pct/100)); }
function calcGestion(anualRent, pct){ return Math.round(anualRent * (pct/100)); }

function calcular(){
const cfg = cfgOrDefaults();
const tipo = val("e_tipo"); // Tradicional / Habitaciones
const precio = num(val("e_precio"));
const itp = calcITP(precio, cfg.itpPct);
const notaria = cfg.notaria;
const reforma = num(val("e_reforma"));
const honorSi = val("e_honor")==="si";
const honor = honorSi ? cfg.honorIVA : 0;

setv("e_itp_eur", fmtN0.format(itp));
setv("e_notaria", fmtN0.format(notaria));

const invTotal = precio + itp + notaria + reforma + honor;
text("r_inv", fmtN0.format(invTotal)+" €");

const alqMes = num(val("e_alq"));
const otrosMes = num(val("e_otros"));
const anualRent = (alqMes + otrosMes) * 12;

// autocalcular gastos variables
const hogarPct = cfg.hogarPct;
const impagoPct = (tipo==="Habitaciones") ? cfg.impagoHab : cfg.impagoTrad;
const gestPct = (tipo==="Habitaciones") ? cfg.gestHab : cfg.gestTrad;

const hogarAuto = calcHogar(anualRent, hogarPct);
const impagoAuto= calcImpago(anualRent, impagoPct);
const gestAuto = calcGestion(anualRent, gestPct);

// si el usuario no rellenó, ponemos auto; si ya puso algo, respetamos
if(!num(val("e_hogar"))) setv("e_hogar", fmtN0.format(hogarAuto));
if(!num(val("e_impago"))) setv("e_impago", fmtN0.format(impagoAuto));
if(!num(val("e_gestion"))) setv("e_gestion", fmtN0.format(gestAuto));

const comunidad = num(val("e_comunidad"));
const ibi = num(val("e_ibi"));
const hogar = num(val("e_hogar"));
const impago= num(val("e_impago"));
const gestion = num(val("e_gestion"));

const gastosAnuales = comunidad + ibi + hogar + impago + gestion;

// KPIs
const bruta = invTotal>0 ? (anualRent / invTotal) * 100 : 0;
const neta = invTotal>0 ? ((anualRent - gastosAnuales) / invTotal) * 100 : 0;
const flujo = (anualRent - gastosAnuales);

text("r_bruta", fmtN1.format(bruta)+" %");
text("r_neta", fmtN1.format(neta)+" %");
text("r_flujo", fmtN0.format(flujo)+" €");

// Objetivos base (si no hay cliente asignado)
const g = cfg.goals;
const gbr = (tipo==="Habitaciones")? g.bruta_hab : g.bruta_trad;
const gne = (tipo==="Habitaciones")? g.neta_hab : g.neta_trad;
const gfl = (tipo==="Habitaciones")? g.flujo_hab : g.flujo_trad;

// Score luces
paintDot("sb", compareKPI(bruta, gbr,"pct"));
paintDot("sn", compareKPI(neta, gne,"pct"));
paintDot("sf", compareKPI(flujo, gfl,"eur"));

// Diffs
text("r_bruta_diff", diffTxt(bruta, gbr, "%"));
text("r_neta_diff", diffTxt(neta, gne, "%"));

// Precio máx estimado “neutro” (sin cliente): despejando por costes
const pmax = calcPrecioMaxNeutro(cfg, honorSi);
text("r_pmax", pmax?fmtN0.format(pmax)+" €":"—");
setv("e_pmax", pmax?fmtN0.format(pmax):"");

// Gráfico KPI vs Objetivo (según objetivo principal por defecto = bruta)
drawChart("chartKPI", {kpi: bruta, goal: gbr, label:"Rent. bruta %"});

// Candidatos
renderCandidates(tipo, val("e_loc"), invTotal, anualRent, bruta, neta, flujo);
show("e_result", true);
}

function calcPrecioMaxNeutro(cfg, includeHonor){
// cálculo práctico: P = (B - N - (H si incluido)) / (1+t)
// Como no hay B “presupuesto” aquí, aproximamos B≃Precio + itp + N + (H si) ⇒ P≈Precio actual (no tiene sentido sin cliente)
// Para utilidad, devolvemos un Pmáx teórico si el objetivo fuera mantener el coste sin superar el actual:
const precio = num(val("e_precio"));
if(!precio) return 0;
const t = cfg.itpPct/100, N=cfg.notaria, H=includeHonor?cfg.honorIVA:0;
const B = precio + Math.round(precio*t) + N + H; // coste total actual
const P = Math.floor((B - N - H)/(1+t));
return P;
}

function compareKPI(val, goal, kind){
if(kind==="eur"){
if(val>=goal) return "green";
if(val>=goal*0.9) return "amber";
return "red";
} else { // %
if(val>=goal) return "green";
if(val>=goal-1) return "amber";
return "red";
}
}
function paintDot(idDot, color){
const el = document.getElementById(idDot);
if(!el) return;
el.className = "dot "+color;
}
function diffTxt(val, goal, suf){
const d = Math.round((val - goal)*10)/10;
if(!goal && !val) return "";
if(d===0) return "(= objetivo)";
const sign = d>0?"+":"";
return "("+sign+fmtN1.format(d)+" "+suf+")";
}

/* ===== Gráfico simple (sin librerías) ===== */
function drawChart(cid, data){
const cvs = id(cid); if(!cvs) return;
const ctx = cvs.getContext("2d");
ctx.clearRect(0,0,cvs.width,cvs.height);
const pad=24, W=cvs.width-pad*2, H=cvs.height-pad*2;
// marco
ctx.strokeStyle="#e5e7eb"; ctx.strokeRect(pad,pad,W,H);
// escala
const maxv = Math.max(data.kpi, data.goal, 1);
const barW = 60;
// ejes
// barras: KPI (columna) y Objetivo (línea)
const kpiH = (data.kpi/maxv)*H;
ctx.fillStyle="#ff6a3d";
ctx.fillRect(pad+40, pad+(H-kpiH), barW, kpiH);
// objetivo (línea)
const yGoal = pad + (H - (data.goal/maxv)*H);
ctx.strokeStyle="#111827"; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(pad+10, yGoal); ctx.lineTo(pad+W-10, yGoal); ctx.stroke(); ctx.setLineDash([]);
// etiquetas
ctx.fillStyle="#111827"; ctx.font="12px Inter, Arial";
ctx.fillText(data.label, pad+20, pad+H+16);
ctx.fillText("KPI: "+data.kpi.toFixed(1), pad+40, pad-6);
ctx.fillText("Obj: "+data.goal.toFixed(1), pad+W-100, yGoal-6);
}

/* ===== Candidatos / Asignación ===== */
function renderCandidates(tipo, loc, costeTotal, anual, bruta, neta, flujo){
const list = id("matchList"); const sel = id("assign_cli");
const pros = Store.pros||[];
const matches = pros.filter(p=>{
// tipo
if(p.pref_tipo && p.pref_tipo!==tipo) return false;
// localidades match (si el prospecto tiene)
if(p.locs_text){
const want = String(p.locs_text).toLowerCase().split(",").map(s=>s.trim());
const aqui = String(loc||"").toLowerCase();
if(want.length && !want.some(w=>w && aqui.includes(w))) return false;
}
// presupuesto aproximado (si tiene budget)
if(p.budget){
if(costeTotal > (p.budget*1.1)) return false; // tolerancia 10%
}
return true;
});
if(!matches.length){
list.textContent="Sin clientes potenciales para este activo.";
sel.innerHTML="";
id("clientMirror").hidden=true;
return;
}
list.textContent = matches.map(m=>`${m.nombre||'—'} · ${m.pref_tipo||'—'} · ${m.locs_text||''}`).join(" | ");
sel.innerHTML = matches.map((m,i)=>`<option value="${m.id||('p'+i)}">${m.nombre||'—'} — ${m.pref_tipo||'—'}</option>`).join("");

// espejo del cliente seleccionado con KPI vs objetivo
sel.onchange = ()=>{
const pid = sel.value;
const p = matches.find(x=>x.id===pid) || matches[0];
mirrorClient(p, tipo, bruta, neta, flujo);
};
// preselecciona primero
mirrorClient(matches[0], tipo, bruta, neta, flujo);
}

function mirrorClient(p, tipo, bruta, neta, flujo){
if(!p){ id("clientMirror").hidden=true; return; }
const cfg = cfgOrDefaults();
// decidir KPI según objetivo principal del cliente
const objTipo = p.obj_tipo || "bruta";
const goal = (objTipo==="bruta") ? ((tipo==="Habitaciones")?cfg.goals.bruta_hab:cfg.goals.bruta_trad)
: (objTipo==="neta") ? ((tipo==="Habitaciones")?cfg.goals.neta_hab :cfg.goals.neta_trad)
: ((tipo==="Habitaciones")?cfg.goals.flujo_hab:cfg.goals.flujo_trad);
const real = (objTipo==="bruta")?bruta:(objTipo==="neta"?neta:flujo);
setv("cm_nombre", p.nombre||"—");
setv("cm_obj", String(objTipo).toUpperCase());
setv("cm_real", (objTipo==="flujo")? (fmtN0.format(real)+" €") : (fmtN1.format(real)+" %"));
setv("cm_goal", (objTipo==="flujo")? (fmtN0.format(goal)+" €") : (fmtN1.format(goal)+" %"));
const gap = Math.round((real - goal)*10)/10;
setv("cm_gap", (objTipo==="flujo")? (fmtN0.format(gap)+" €") : (fmtN1.format(gap)+" %"));
id("clientMirror").hidden=false;

// actualizar gráfico al KPI del cliente
const label = (objTipo==="flujo")? "Flujo €" : (objTipo==="neta"?"Rent. neta %":"Rent. bruta %");
drawChart("chartKPI", {kpi: (objTipo==="flujo"?real:real), goal:(objTipo==="flujo"?goal:goal), label});
}

/* ===== Guardar evaluación ===== */
function buildEvalObject(){
const now = new Date();
return {
id: "ev_"+now.getTime(),
ts: now.toISOString(),
loc: val("e_loc"), calle: val("e_calle"), url: val("e_url"),
m2: num(val("e_m2")), anio: num(val("e_anio")),
asc: val("e_asc"), alt: num(val("e_alt")), bajo: val("e_bajo"),
habs: num(val("e_habs")), banos: num(val("e_banos")),
tipo: val("e_tipo"),
precio: num(val("e_precio")), itp: num(val("e_itp_eur")), notaria: num(val("e_notaria")),
reforma: num(val("e_reforma")), honor_incl: val("e_honor")==="si",
comunidad: num(val("e_comunidad")), ibi: num(val("e_ibi")), hogar: num(val("e_hogar")),
impago: num(val("e_impago")), gestion: num(val("e_gestion")),
alq: num(val("e_alq")), otros: num(val("e_otros")),
inv_total: parseNumText(id("r_inv")?.textContent),
kpi_bruta: parseNumText(id("r_bruta")?.textContent),
kpi_neta : parseNumText(id("r_neta")?.textContent),
kpi_flujo: parseNumText(id("r_flujo")?.textContent),
pmax: num(val("e_pmax")),
kpi_tipo: id("cm_obj")?.textContent ? id("cm_obj").textContent.toLowerCase() : "bruta",
kpi_val: (id("cm_real")?.textContent||"").includes("€")? parseNumText(id("cm_real").textContent) : parseNumText(id("r_bruta")?.textContent),
prospect_ids:[]
};
}
function parseNumText(t){
if(!t) return 0;
return num(String(t).replace(/[^\d.,-]/g,""));
}
function saveEval(assign){
const ev = buildEvalObject();
const list = Store.evals||[];
if(assign){
const sel = id("assign_cli");
if(sel && sel.selectedOptions && sel.selectedOptions.length){
ev.prospect_ids = Array.from(sel.selectedOptions).map(o=>o.value);
}
}
list.unshift(ev); Store.evals=list;
toast(assign?"Guardado y asignado":"Guardado","ok");
}

/* ===== Eventos ===== */
function attach(){
moneyInputLive();
// localidades
fillLocalidades();

// recalcular ITP/seguros/gestión al cambiar precio/alquiler/tipo
id("e_precio").addEventListener("input", ()=>{ const cfg=cfgOrDefaults(); setv("e_itp_eur", fmtN0.format(calcITP(num(val("e_precio")), cfg.itpPct))); setv("e_notaria", fmtN0.format(cfg.notaria)); });
const recalcVars=()=>{ const cfg=cfgOrDefaults(); const tipo=val("e_tipo"); const alqMes=num(val("e_alq")); const otrosMes=num(val("e_otros")); const anual=(alqMes+otrosMes)*12;
const hogar=calcHogar(anual, cfg.hogarPct);
const impago=calcImpago(anual, (tipo==="Habitaciones")?cfg.impagoHab:cfg.impagoTrad);
const gest=calcGestion(anual, (tipo==="Habitaciones")?cfg.gestHab:cfg.gestTrad);
if(!num(val("e_hogar"))) setv("e_hogar", fmtN0.format(hogar));
if(!num(val("e_impago"))) setv("e_impago", fmtN0.format(impago));
if(!num(val("e_gestion"))) setv("e_gestion", fmtN0.format(gest));
};
id("e_alq").addEventListener("input", recalcVars);
id("e_otros").addEventListener("input", recalcVars);
id("e_tipo").addEventListener("change", recalcVars);

id("e_calc").addEventListener("click", calcular);
id("e_clean").addEventListener("click", ()=>{ document.querySelectorAll("input").forEach(i=>{ if(i.id!=="e_notaria" && i.id!=="e_itp_eur") i.value=""; }); id("e_honor").value="si"; id("e_tipo").value="Tradicional"; show("e_result",false); toast("Formulario limpiado","ok"); });

id("save_only").addEventListener("click", ()=>saveEval(false));
id("save_assign").addEventListener("click", ()=>saveEval(true));
}

/* ===== Init ===== */
document.addEventListener("DOMContentLoaded", ()=>{
try{ attach(); }catch(e){ console.error(e); toast("Error inicializando evaluación","bad"); }
});
})();
</script>
</body>
</html>
