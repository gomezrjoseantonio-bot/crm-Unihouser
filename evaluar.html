<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser â€” Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* Local tweaks manteniendo el look de style.css */
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
.dot.g{background:#16a34a}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
.small{font-size:12px;color:#667085}
.kpi .muted{color:#667085;font-weight:600;margin-left:6px}
#matchList .tag{display:inline-block;background:#eef2f7;color:#0f1112;border-radius:999px;padding:4px 8px;margin:2px 4px;font-size:12px}
.canvasWrap{background:#0f1112;border:1px solid #2a3238;border-radius:12px;padding:10px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser â€” CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">ConfiguraciÃ³n</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- =================== DATOS DEL INMUEBLE =================== -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="row three">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>Superficie (mÂ²) â€” opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
    </div>
    <div class="row three">
      <div class="field"><label>AÃ±o construcciÃ³n â€” opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Ascensor</label><select id="e_asc"><option>SÃ­</option><option>No</option></select></div>
      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Â¿Es bajo?</label><select id="e_bajo"><option>No</option><option>SÃ­</option></select></div>
      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>BaÃ±os</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
    </div>
    <div class="row three">
      <div class="field"><label>Necesita reforma</label>
        <select id="e_ref_nec">
          <option value="no">No</option>
          <option value="lavado">Lavado de cara</option>
          <option value="integral">Reforma integral</option>
        </select>
      </div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>
      <div class="field"></div>
    </div>
  </div>

  <!-- =================== GASTOS DE ADQUISICIÃ“N =================== -->
  <div class="section">
    <h3>Gastos de adquisiciÃ³n</h3>
    <div class="row three">
      <div class="field"><label>Precio de compra (â‚¬)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (â‚¬ auto)</label><input id="e_itp_eur" data-money></div>
      <div class="field"><label>NotarÃ­a y Registro (â‚¬ auto)</label><input id="e_notaria" data-money></div>
    </div>
    <div class="row three">
      <div class="field"><label>Reforma (â‚¬)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (4.235 â‚¬)</label>
        <select id="e_honor"><option value="si">SÃ­</option><option value="no" selected>No</option></select>
      </div>
      <div class="field"><label>Precio mÃ¡x. de compra (objetivo bruta)</label><input id="e_pmax" data-money disabled></div>
    </div>
  </div>

  <!-- =================== GASTOS DE MANTENIMIENTO =================== -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="row three">
      <div class="field"><label>Comunidad (â‚¬/aÃ±o)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (â‚¬/aÃ±o)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (â‚¬/aÃ±o â€” auto)</label><input id="e_hogar" value="0" data-money></div>
    </div>
    <div class="row three">
      <div class="field"><label>Seguro impago (â‚¬/aÃ±o â€” auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>GestiÃ³n (â‚¬/aÃ±o â€” auto)</label><input id="e_gestion" value="0" data-money></div>
      <div class="field"><small class="hint">Hogar/impago/gestiÃ³n se autocalculan desde Config al indicar alquiler. Puedes editar el importe.</small></div>
    </div>
  </div>

  <!-- =================== EXPLOTACIÃ“N E INGRESOS =================== -->
  <div class="section">
    <h3>Tipo de explotaciÃ³n e ingresos</h3>
    <div class="row three">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (â‚¬)</label><input id="e_alq" data-money></div>
      <div class="field"></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_save">Guardar</button>
    <button class="btn" id="e_save_assign">Guardar y asignar</button>
    <button class="btn ghost" id="e_clean">Limpiar</button>
  </div>

  <!-- =================== RESULTADOS =================== -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis">
      <div class="kpi"><div class="lab">InversiÃ³n total</div><div class="val" id="r_inv">â€”</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">â€”</span><span id="r_bruta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">â€”</span><span id="r_neta_diff" class="muted"></span></div></div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">â€”</div></div>
      <div class="kpi"><div class="lab">Precio mÃ¡x. de compra</div><div class="val" id="r_pmax">â€”</div></div>
    </div>

    <div class="canvasWrap" style="margin-top:10px">
      <canvas id="chartKPI" width="540" height="220"></canvas>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div id="matchList" class="muted">â€”</div>
      <div class="actions" style="margin-top:8px">
        <select id="assign_cli" size="6" style="min-width:320px"></select>
        <button class="btn" id="save_only">Guardar evaluaciÃ³n</button>
        <button class="btn primary" id="save_assign">Guardar y asignar</button>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">Â© 2025 Unihouser Â· unihouser.es Â· info@unihouser.es Â· 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Utils / formato ES ===== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES', { style:'currency', currency:'EUR', maximumFractionDigits:0 });
const fmtN0 = new Intl.NumberFormat('es-ES', { maximumFractionDigits:0 });
const fmtN1 = new Intl.NumberFormat('es-ES', { maximumFractionDigits:1 });
function e0(v){ return fmtE0.format(Number(v||0)); }
function n0(v){ return fmtN0.format(Number(v||0)); }
function pct1(v){ return fmtN1.format(Number(v||0))+' %'; }
function parseEs(str){
  if(str==null) return 0;
  const s=String(str).trim().replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
  const n=Number(s); return Number.isFinite(n)? n : 0;
}
function moneyLive(){
  document.querySelectorAll('input[data-money]').forEach(inp=>{
    inp.addEventListener('input',()=>{
      const digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
    });
    inp.addEventListener('blur',()=>{
      const n = Math.round(parseEs(inp.value));
      inp.value = n? n0(n) : '';
    });
  });
}

/* ===== Store (localStorage) ===== */
const Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}} },
  set cfg(v){ localStorage.setItem('cfg', JSON.stringify(v)); },
  get pros(){ try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]} },
  set pros(v){ localStorage.setItem('pros', JSON.stringify(v)); },
  get evals(){ try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]} },
  set evals(v){ localStorage.setItem('evals', JSON.stringify(v)); }
};

/* ===== Localidades Asturias ===== */
const ASTURIAS = [
"Allande","Aller","Amieva","AvilÃ©s","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo",
"Cangas de OnÃ­s","Cangas del Narcea","Caravia","CarreÃ±o","Caso","CastrillÃ³n","Castropol","CoaÃ±a","Colunga","Corvera de Asturias",
"Cudillero","DegaÃ±a","GijÃ³n","GozÃ³n","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo",
"Laviana","Lena","Llanera","Llanes","Mieres","MorcÃ­n","Muros de NalÃ³n","Nava","Navia","NoreÃ±a",
"OnÃ­s","Oviedo","Parres","PeÃ±amellera Alta","PeÃ±amellera Baja","Pesoz","PiloÃ±a","Pravia","Proaza","QuirÃ³s",
"Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San MartÃ­n de Oscos","San MartÃ­n del Rey Aurelio","San Tirso de Abres","Santa Eulalia de Oscos","Santo Adriano",
"Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","ValdÃ©s",
"Vegadeo","Villanueva de Oscos","Villaviciosa","VillayÃ³n"
];

/* ===== Cargar localidades ===== */
function loadLocalidades(){
  const s=id('e_loc'); s.innerHTML='';
  ASTURIAS.forEach(loc=>{
    const o=document.createElement('option'); o.textContent=loc; s.appendChild(o);
  });
}

/* ===== Leer cfg con defaults sensatos ===== */
function getCfg(){
  const c=Store.cfg||{};
  return {
    // impuestos y costes
    itp_pct: Number(c.itp_pct ?? 8),
    notaria_eur: Number(c.notaria_eur ?? 1500),
    psi_eur: Number(c.psi_eur ?? 4235),
    // % sobre alquiler anual
    hogar_pct: Number(c.hogar_pct ?? 3.5),
    impago_pct_trad: Number(c.impago_pct_trad ?? 4.0),
    impago_pct_hab: Number(c.impago_pct_hab ?? 4.0),
    gestion_pct_trad: Number(c.gestion_pct_trad ?? 15.0),
    gestion_pct_hab: Number(c.gestion_pct_hab ?? 25.0),
    // objetivos (solo usaremos bruta para Pmax y grÃ¡fico)
    obj_bruta_trad: Number(c.obj_bruta_trad ?? 10.0),
    obj_bruta_hab: Number(c.obj_bruta_hab ?? 12.0),
    obj_neta_trad: Number(c.obj_neta_trad ?? 6.0),
    obj_neta_hab: Number(c.obj_neta_hab ?? 8.0),
    // pesos de matching
    match_weights: c.match_weights || { tipo:0.5, localidad:0.3, gap:0.2 }
  };
}

/* ===== AutocÃ¡lculos dependientes del alquiler y precio ===== */
function bindAuto(){
  const cfg=getCfg();
  const tipoEl=id('e_tipo');
  const alqEl=id('e_alq');
  const itpEl=id('e_itp_eur');
  const notEl=id('e_notaria');
  const precioEl=id('e_precio');

  // Precio -> ITP & NotarÃ­a por defecto
  const updPrecio=()=>{
    const precio=parseEs(precioEl.value);
    const itp=Math.round(precio*(cfg.itp_pct/100));
    itpEl.value = n0(itp);
    if(!parseEs(notEl.value)) notEl.value=n0(cfg.notaria_eur);
  };
  precioEl.addEventListener('input',updPrecio);
  precioEl.addEventListener('blur',updPrecio);

  // Alquiler -> hogar/impago/gestion (anuales)
  const updAlq=()=>{
    const alq_m=parseEs(alqEl.value);
    const alq_a = alq_m*12;
    const tipo=(tipoEl.value||'Tradicional').toLowerCase();
    const impago_pct = (tipo==='habitaciones')? cfg.impago_pct_hab : cfg.impago_pct_trad;
    const gest_pct   = (tipo==='habitaciones')? cfg.gestion_pct_hab : cfg.gestion_pct_trad;

    const hogar   = Math.round(alq_a*(cfg.hogar_pct/100));
    const impago  = Math.round(alq_a*(impago_pct/100));
    const gestion = Math.round(alq_a*(gest_pct/100));

    id('e_hogar').value  = n0(hogar);
    id('e_impago').value = n0(impago);
    id('e_gestion').value= n0(gestion);
  };
  alqEl.addEventListener('input',updAlq);
  alqEl.addEventListener('blur',updAlq);
  tipoEl.addEventListener('change',updAlq);
}

/* ===== CÃ¡lculos financieros ===== */
function calc(){
  const cfg=getCfg();
  const tipo=(id('e_tipo').value||'Tradicional');
  const precio = parseEs(id('e_precio').value);
  const itp    = parseEs(id('e_itp_eur').value) || Math.round(precio*(cfg.itp_pct/100));
  const notari = parseEs(id('e_notaria').value) || cfg.notaria_eur;
  const ref    = parseEs(id('e_reforma').value);
  const honor  = (id('e_honor').value==='si') ? cfg.psi_eur : 0;

  const comu   = parseEs(id('e_comunidad').value);
  const ibi    = parseEs(id('e_ibi').value);
  const hogar  = parseEs(id('e_hogar').value);
  const impago = parseEs(id('e_impago').value);
  const gest   = parseEs(id('e_gestion').value);

  const alq_m  = parseEs(id('e_alq').value);
  const alq_a  = alq_m*12;

  const inv_total = precio + itp + notari + ref + honor;
  const gastos_a  = comu + ibi + hogar + impago + gest;

  const bruta = inv_total>0 ? (alq_a / inv_total * 100) : 0;
  const neta  = inv_total>0 ? ((alq_a - gastos_a) / inv_total * 100) : 0;
  const flujo = alq_a - gastos_a;

  const obj_bruta = (tipo==='Habitaciones')? cfg.obj_bruta_hab : cfg.obj_bruta_trad;
  const gapB = bruta - obj_bruta;
  const obj_neta = (tipo==='Habitaciones')? cfg.obj_neta_hab : cfg.obj_neta_trad;
  const gapN = neta - obj_neta;

  // Precio mÃ¡ximo para alcanzar objetivo bruta
  const rate = cfg.itp_pct/100;
  const targetInv = (obj_bruta>0)? (alq_a / (obj_bruta/100)) : 0;
  let pmax = 0;
  if(targetInv>0){
    const extras = (notari + ref + honor);
    pmax = Math.max(0, Math.floor((targetInv - extras) / (1+rate)));
  }

  // Pinta KPIs
  id('r_inv').textContent   = e0(inv_total);
  id('r_bruta').textContent = pct1(bruta);
  id('r_neta').textContent  = pct1(neta);
  id('r_flujo').textContent = e0(flujo);
  id('r_pmax').textContent  = e0(pmax);
  id('e_pmax').value        = n0(pmax);

  // Dots
  paintDot('sb', gapB);
  paintDot('sn', gapN);
  paintDot('sf', flujo>=0? 1 : -1);

  // Diff text
  id('r_bruta_diff').textContent = gapText(gapB);
  id('r_neta_diff').textContent  = gapText(gapN);

  // GrÃ¡fico
  drawChart(bruta, obj_bruta);

  // Sugerencias de prospects
  suggestProspects({ tipo, loc: id('e_loc').value||'', bruta, neta, flujo, obj_bruta, obj_neta });

  id('e_result').hidden=false;

  // Devuelve objeto evaluaciÃ³n (para guardar)
  return {
    id: 'ev_'+Date.now(),
    ts: Date.now(),
    loc: id('e_loc').value || '',
    calle: id('e_calle').value || '',
    m2: id('e_m2').value || '',
    anio: id('e_anio').value || '',
    asc: id('e_asc').value || '',
    alt: id('e_alt').value || '',
    bajo: id('e_bajo').value || '',
    habs: id('e_habs').value || '',
    banos: id('e_banos').value || '',
    ref_tip: id('e_ref_nec').value || 'no',
    url: id('e_url').value || '',
    tipo,
    precio, itp, notaria:notari, psi: honor, reforma: ref,
    comu:comu, ibi:ibi, hogar:hogar, impago:impago, gestion:gest,
    alq: alq_m,
    inv_total, kpi_bruta: bruta, kpi_neta: neta, kpi_flujo: flujo,
    pmax
  };
}

function gapText(g){
  if(!isFinite(g)) return '';
  const s = (g>=0? '+' : 'âˆ’') + fmtN1.format(Math.abs(g)) + ' pts';
  return ' ('+s+')';
}
function paintDot(idDot, gap){
  const el=id(idDot); el.className='dot '+(gap>=0?'g':(gap>-1?'y':'r'));
}

/* ===== Mini chart: barra (real) + lÃ­nea (objetivo) ===== */
function drawChart(real, objetivo){
  const c=id('chartKPI'); const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  // ejes
  const pad=40; const W=c.width, H=c.height;
  const max = Math.max( Math.ceil((Math.max(real, objetivo)+2)/2)*2 , 2);
  // grid
  ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.lineWidth=1;
  for(let y=0;y<=max;y+=2){
    const yy = H - pad - (H-2*pad)* (y/max);
    ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(W-pad,yy); ctx.stroke();
  }
  // barra real
  const barW=80;
  const realH=(H-2*pad)*(real/max);
  ctx.fillStyle='#ff5a1f';
  ctx.fillRect(W/2 - barW/2, H - pad - realH, barW, realH);
  // lÃ­nea objetivo
  const yObj = H - pad - (H-2*pad)*(objetivo/max);
  ctx.strokeStyle='#16a34a'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad, yObj); ctx.lineTo(W-pad, yObj); ctx.stroke();
  // etiquetas
  ctx.fillStyle='#e8eef3'; ctx.font='12px Inter, Arial';
  ctx.fillText('Bruta real', W/2 - 30, H - 8);
  ctx.fillText('Objetivo', pad, yObj - 6);
}

/* ===== Matching prospects ===== */
function suggestProspects(ctx){
  const cfg=getCfg();
  const W=cfg.match_weights||{tipo:0.5,localidad:0.3,gap:0.2};
  const list=Store.pros||[];
  const asignSel=id('assign_cli');
  const panel=id('matchList');

  if(!list.length){ panel.textContent='No hay prospects guardados.'; asignSel.innerHTML=''; return; }

  // scorers
  const rows=list.map(p=>{
    const tipoMatch = ( (p.pref_tipo||'').toLowerCase() === (ctx.tipo||'').toLowerCase() ) ? 1 : 0;
    const locs = (p.locs_text||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    const locMatch = locs.includes((ctx.loc||'').toLowerCase()) ? 1 : 0;
    // objetivo principal
    const objMain=(p.obj_main||'bruta').toLowerCase();
    let objVal = objMain==='neta'? Number(p.obj_neta||0) : objMain==='flujo'? Number(p.obj_flujo||0) : Number(p.obj_bruta||0);
    let realVal = objMain==='neta'? ctx.neta : objMain==='flujo'? ctx.flujo : ctx.bruta;
    let gap = realVal - objVal; // pts porcentaje o euros flujo
    const gapScore = (objMain==='flujo') ? (gap>=0?1:0) : (gap>=0?1:(gap>-1?0.5:0));

    const score = W.tipo*tipoMatch + W.localidad*locMatch + W.gap*gapScore;
    return {p, score, gap, objMain};
  }).sort((a,b)=>b.score-a.score).slice(0,12);

  // render tags y select
  panel.innerHTML='';
  rows.forEach(r=>{
    const span=document.createElement('span');
    const color = r.gap>=0 ? 'ðŸŸ¢' : (r.gap>-1? 'ðŸŸ¡':'ðŸ”´');
    span.className='tag';
    span.textContent = ${color} ${r.p.nombre||'-'} Â· ${r.p.pref_tipo||'-'} Â· ${r.p.locs_text||''};
    panel.appendChild(span);
  });

  asignSel.innerHTML='';
  rows.forEach(r=>{
    const opt=document.createElement('option');
    opt.value = r.p.id || r.p.email || r.p.nombre || ('p_'+Math.random().toString(36).slice(2,7));
    opt.textContent = ${r.p.nombre||'-'} (${r.p.pref_tipo||'-'});
    asignSel.appendChild(opt);
  });
}

/* ===== Guardar / Asignar ===== */
function gather(){
  // Reutiliza calc() para tener KPIs consistentes
  const e=calc();
  // completa con inputs base (por si calc no los leyÃ³ reciÃ©n)
  return e;
}
function save(alsoAssign){
  const e=gather();
  // si venimos para re-editar una eval guardada (_load_eval_)
  const loaded = localStorage.getItem('_load_eval_');
  let list=Store.evals||[];
  if(loaded){
    const idx=list.findIndex(x=>x.id===loaded);
    if(idx>=0){ e.id=list[idx].id; e.ts=list[idx].ts; }
    localStorage.removeItem('_load_eval_');
  }
  // asignaciÃ³n opcional
  if(alsoAssign){
    const sel=[...id('assign_cli').options].filter(o=>o.selected).map(o=>o.value);
    e.prospect_ids = sel;
  }
  // persist
  const idx2=list.findIndex(x=>x.id===e.id);
  if(idx2>=0) list[idx2]=e; else list.push(e);
  Store.evals = list;
  alert('EvaluaciÃ³n guardada');
}

/* ===== Limpiar ===== */
function limpiar(){
  document.querySelectorAll('input').forEach(i=>i.value='');
  document.querySelectorAll('select').forEach(s=>{
    if(s.id==='e_tipo'){ s.value='Tradicional'; }
    else if(s.id==='e_honor'){ s.value='no'; }
    else s.selectedIndex=0;
  });
  id('e_result').hidden=true;
}

/* ===== Cargar evaluaciÃ³n si nos llaman desde Evaluaciones ===== */
function preloadIfAny(){
  const evId = localStorage.getItem('_load_eval_');
  if(!evId) return;
  const e=(Store.evals||[]).find(x=>x.id===evId); if(!e) return;
  // Volcar en UI
  id('e_loc').value = e.loc || '';
  id('e_calle').value = e.calle||'';
  id('e_m2').value = e.m2||'';
  id('e_anio').value = e.anio||'';
  id('e_asc').value = e.asc||'SÃ­';
  id('e_alt').value = e.alt||'';
  id('e_bajo').value = e.bajo||'No';
  id('e_habs').value = e.habs||'';
  id('e_banos').value = e.banos||'';
  id('e_ref_nec').value = e.ref_tip||'no';
  id('e_url').value = e.url||'';
  id('e_tipo').value = e.tipo||'Tradicional';

  id('e_precio').value = n0(e.precio||0);
  id('e_itp_eur').value = n0(e.itp||0);
  id('e_notaria').value = n0(e.notaria||0);
  id('e_reforma').value = n0(e.reforma||0);
  id('e_honor').value = (e.psi&&e.psi>0)? 'si':'no';

  id('e_comunidad').value = n0(e.comu||0);
  id('e_ibi').value = n0(e.ibi||0);
  id('e_hogar').value = n0(e.hogar||0);
  id('e_impago').value = n0(e.impago||0);
  id('e_gestion').value = n0(e.gestion||0);

  id('e_alq').value = n0(e.alq||0);

  // recalcula y muestra
  calc();
}

/* ===== Eventos ===== */
function attach(){
  loadLocalidades();
  moneyLive();
  bindAuto();

  id('e_calc').addEventListener('click', calc);
  id('e_save').addEventListener('click', ()=>save(false));
  id('e_save_assign').addEventListener('click', ()=>save(true));
  id('e_clean').addEventListener('click', limpiar);

  preloadIfAny();
}

document.addEventListener('DOMContentLoaded', attach);
})();
</script>
</body>
</html>
