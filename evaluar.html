<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser â€” Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
  .green{background:#16a34a}.yellow{background:#f59e0b}.red{background:#ef4444}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpis5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
  .kpi .lab{color:#667085;font-size:12px}.kpi .val{font-weight:800}
  .muted{color:#667085}
  canvas{max-width:100%;height:auto}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser â€” CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">ConfiguraciÃ³n</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- Datos del inmueble -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="grid3">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>

      <div class="field"><label>AÃ±o construcciÃ³n â€” opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Superficie (mÂ²) â€” opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
      <div class="field"><label>Necesita reforma</label>
        <select id="e_reforma_tipo"><option>No</option><option>Lavado de cara</option><option>Integral</option></select>
      </div>

      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
      <div class="field"><label>Â¿Ascensor?</label><select id="e_asc"><option>SÃ­</option><option>No</option></select></div>
      <div class="field"><label>Â¿Es bajo?</label><select id="e_bajo"><option>No</option><option>SÃ­</option></select></div>

      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>BaÃ±os</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
      <div></div>
    </div>
  </div>

  <!-- Gastos de adquisiciÃ³n -->
  <div class="section">
    <h3>Gastos de adquisiciÃ³n</h3>
    <div class="grid3">
      <div class="field"><label>Precio de compra (â‚¬)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (â‚¬ â€” auto)</label><input id="e_itp_eur" data-money disabled></div>
      <div class="field"><label>NotarÃ­a y Registro (â‚¬ â€” auto)</label><input id="e_notaria" data-money disabled></div>

      <div class="field"><label>Reforma (â‚¬)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (con IVA)</label>
        <select id="e_incluir_psi"><option value="si">SÃ­</option><option value="no">No</option></select>
      </div>
      <div class="field"><label>Precio mÃ¡x. compra (cumplir BRUTA)</label><input id="e_pmax" data-money disabled></div>
    </div>
    <div class="muted" style="margin-top:6px">El objetivo BRUTA se toma de Config segÃºn tipo (Tradicional/Habitaciones).</div>
  </div>

  <!-- Gastos de mantenimiento -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="grid3">
      <div class="field"><label>Comunidad (â‚¬/aÃ±o)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (â‚¬/aÃ±o)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (â‚¬/aÃ±o â€” auto)</label><input id="e_hogar" value="0" data-money></div>

      <div class="field"><label>Seguro impago (â‚¬/aÃ±o â€” auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>GestiÃ³n (â‚¬/aÃ±o â€” auto)</label><input id="e_gestion" value="0" data-money></div>
      <div></div>
    </div>
    <div class="muted" style="margin-top:6px">Hogar/impago/gestiÃ³n se autocalculan al fijar el alquiler, segÃºn Config. Editables.</div>
  </div>

  <!-- ExplotaciÃ³n -->
  <div class="section">
    <h3>Tipo de explotaciÃ³n e ingresos</h3>
    <div class="grid3">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (â‚¬)</label><input id="e_alq" data-money></div>
      <div class="field"><label>Otros ingresos (â‚¬/mes) â€” opcional</label><input id="e_otros" value="0" data-money></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_clean">Limpiar</button>
    <button class="btn" id="save_only">Guardar evaluaciÃ³n</button>
  </div>

  <!-- Resultados -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis5">
      <div class="kpi"><div class="lab">InversiÃ³n total</div><div class="val" id="r_inv">â€”</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div>
        <div class="val"><span id="r_bruta">â€”</span> <span id="r_bruta_diff" class="muted"></span></div>
      </div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div>
        <div class="val"><span id="r_neta">â€”</span> <span id="r_neta_diff" class="muted"></span></div>
      </div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">â€”</div></div>
      <div class="kpi"><div class="lab">Precio mÃ¡x. de compra</div><div class="val" id="r_pmax">â€”</div></div>
    </div>

    <!-- GrÃ¡fico: SOLO rentabilidad bruta (barra real + lÃ­nea objetivo) -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">GrÃ¡fico Â· Rentabilidad bruta</h3>
      <canvas id="chartBruta" width="640" height="240" aria-label="Comparativa rentabilidad bruta"></canvas>
      <div class="muted" id="chartNote" style="margin-top:6px"></div>
    </div>

    <!-- Sugerencias de clientes -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div id="matchList" class="muted">â€”</div>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="save_assign">Guardar y asignar</button>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">Â© 2025 Unihouser Â· unihouser.es Â· info@unihouser.es Â· 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
const id = s=>document.getElementById(s);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0  = v=>fmtE0.format(Number(v||0));
const n0  = v=>fmtN0.format(Number(v||0));
const pct = v=>fmtN1.format(Number(v||0))+' %';
const esc = s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function parseEs(str){ if(str==null) return 0; const s=String(str).trim().replace(/\./g,'').replace(',', '.'); const n=Number(s); return Number.isFinite(n)?n:0; }
function setMoney(inp, v){ inp.value = n0(Math.round(Number(v||0))); }
function setDot(el, color){ el.classList.remove('green','yellow','red'); el.classList.add(color); }
function goalDot(val, goal){ if(val>=goal) return 'green'; if(val>=goal*0.9) return 'yellow'; return 'red'; }
function genId(){ const d=new Date(); const pad=x=>String(x).padStart(2,'0'); const rnd=Math.random().toString(36).slice(2,5); return ev_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}_${rnd}; }

/* ===== Store ===== */
const Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}} },
  set cfg(v){ localStorage.setItem('cfg', JSON.stringify(v)); },
  get pros(){ try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]} },
  set pros(v){ localStorage.setItem('pros', JSON.stringify(v)); },
  get evals(){ try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]} },
  set evals(v){ localStorage.setItem('evals', JSON.stringify(v)); }
};

/* ===== Localidades Asturias (completo) ===== */
const LOCS = ["Allande","Aller","Amieva","AvilÃ©s","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo","Cangas de OnÃ­s","Cangas del Narcea","Caravia","CarreÃ±o","Caso","CastrillÃ³n","Castropol","CoaÃ±a","Colunga","Corvera de Asturias","Cudillero","DegaÃ±a","GijÃ³n","GozÃ³n","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo","Laviana","Lena","Llanera","Llanes","Las Regueras","MorcÃ­n","Muros de NalÃ³n","Mieres","Nava","Navia","NoreÃ±a","OnÃ­s","Oviedo","Parres","PeÃ±amellera Alta","PeÃ±amellera Baja","Pesoz","PiloÃ±a","Pravia","Proaza","QuirÃ³s","Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San MartÃ­n del Rey Aurelio","San MartÃ­n de Oscos","Santa Eulalia de Oscos","Santo Adriano","Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","ValdÃ©s","Vegadeo","Villanueva de Oscos","Villaviciosa","VillayÃ³n","Yernes y Tameza"];

/* ===== Config con defaults + match ===== */
function CFG(){
  const c = Store.cfg || {};
  const match = c.match || {};
  return {
    itp_pct: Number(c.itp_pct ?? 8),
    notaria_eur: Number(c.notaria_eur ?? 1500),
    psi_eur: Number(c.psi_eur ?? 4235),
    hogar_pct: Number(c.hogar_pct ?? 2),
    impago_pct_trad: Number(c.impago_pct_trad ?? 0),
    impago_pct_rooms: Number(c.impago_pct_rooms ?? 4),
    gestion_pct_trad: Number(c.gestion_pct_trad ?? 15),
    gestion_pct_rooms: Number(c.gestion_pct_rooms ?? 25),
    obj_bruta_trad: Number(c.obj_bruta_trad ?? 10),
    obj_bruta_rooms: Number(c.obj_bruta_rooms ?? 12),
    obj_neta_trad: Number(c.obj_neta_trad ?? 7.5),
    obj_neta_rooms: Number(c.obj_neta_rooms ?? 8.5),
    match: {
      weight_bruta: Number(match.weight_bruta ?? 50),
      weight_presupuesto: Number(match.weight_presupuesto ?? 25),
      weight_ubicacion_tipo: Number(match.weight_ubicacion_tipo ?? 15),
      weight_condiciones: Number(match.weight_condiciones ?? 10),
      budget_tolerance_pct: Number(match.budget_tolerance_pct ?? 10),
      cutoff_green: Number(match.cutoff_green ?? 75),
      cutoff_amber: Number(match.cutoff_amber ?? 55),
      hard_require_ascensor: Boolean(match.hard_require_ascensor ?? false),
      penaliza_bajo: Boolean(match.penaliza_bajo ?? false),
      default_acepta_reforma: (match.default_acepta_reforma ?? 'cualquiera')
    }
  };
}

/* ===== Estado ediciÃ³n ===== */
let currentId = null; // si reabrimos, mantenemos id

/* ===== Montaje ===== */
function mount(){
  // localidades
  const sel = id('e_loc'); sel.innerHTML = LOCS.map(x=><option>${x}</option>).join('');
  // datos monetarios
  document.querySelectorAll('input[data-money]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value = n0(digits);
    });
    inp.addEventListener('blur', ()=>{ setMoney(inp, parseEs(inp.value)); });
  });

  // listeners
  id('e_precio').addEventListener('input', autoAdquisicion);
  id('e_tipo').addEventListener('change', ()=>{ autoMantenimiento(); recalcPmax(); });
  id('e_alq').addEventListener('input', ()=>{ autoMantenimiento(); recalcPmax(); });

  id('e_calc').addEventListener('click', calcular);
  id('e_clean').addEventListener('click', limpiar);
  id('save_only').addEventListener('click', guardar);
  id('save_assign').addEventListener('click', guardarYAsignar);

  // precarga si venimos de Evaluaciones
  preloadFromEvaluaciones();

  // arranque
  autoAdquisicion();
}

/* ===== Auto: ITP y NotarÃ­a ===== */
function autoAdquisicion(){
  const cfg = CFG();
  const precio = parseEs(id('e_precio').value);
  const itp = Math.round(precio * cfg.itp_pct/100);
  setMoney(id('e_itp_eur'), itp);
  setMoney(id('e_notaria'), cfg.notaria_eur);
  recalcPmax();
}

/* ===== Auto: hogar/impago/gestiÃ³n al teclear alquiler ===== */
function autoMantenimiento(){
  const cfg = CFG();
  const tipo = id('e_tipo').value;
  const alq = parseEs(id('e_alq').value);
  const anual = alq*12 + parseEs(id('e_otros').value)*12;

  const hogar = Math.round(anual * (cfg.hogar_pct/100));
  const impago = Math.round(anual * ((tipo==='Tradicional'? cfg.impago_pct_trad: cfg.impago_pct_rooms)/100));
  const gestion = Math.round(anual * ((tipo==='Tradicional'? cfg.gestion_pct_trad: cfg.gestion_pct_rooms)/100));

  if(!isNaN(hogar)) setMoney(id('e_hogar'), hogar);
  if(!isNaN(impago)) setMoney(id('e_impago'), impago);
  if(!isNaN(gestion)) setMoney(id('e_gestion'), gestion);
}

/* ===== Precio mÃ¡x compra para cumplir BRUTA objetivo ===== */
function recalcPmax(){
  const cfg = CFG();
  const tipo = id('e_tipo').value;
  const goal = (tipo==='Tradicional'? cfg.obj_bruta_trad : cfg.obj_bruta_rooms) / 100;

  const alq = parseEs(id('e_alq').value);
  const otros = parseEs(id('e_otros').value);
  const ingresoAnual = (alq+otros)*12;

  const notaria = parseEs(id('e_notaria').value) || cfg.notaria_eur;
  const reforma = parseEs(id('e_reforma').value);
  const incluyePSI = id('e_incluir_psi').value==='si';
  const psi = incluyePSI ? cfg.psi_eur : 0;

  const itp_pct = cfg.itp_pct/100;
  // ingreso / ( P*(1+itp_pct) + C ) = goal  ->  P = (ingreso/goal - C)/(1+itp_pct)
  const C = notaria + reforma + psi;
  const brutoObjetivoTotal = ingresoAnual/goal;
  const pmax = Math.max(0, Math.floor( (brutoObjetivoTotal - C) / (1+itp_pct) ));
  setMoney(id('e_pmax'), pmax);
}

/* ===== Calcular KPIs ===== */
function calcular(){
  const cfg = CFG();
  const precio = parseEs(id('e_precio').value);
  const itp = parseEs(id('e_itp_eur').value) || Math.round(precio*cfg.itp_pct/100);
  const notaria = parseEs(id('e_notaria').value) || cfg.notaria_eur;
  const reforma = parseEs(id('e_reforma').value);
  const incluyePSI = id('e_incluir_psi').value==='si';
  const psi = incluyePSI ? cfg.psi_eur : 0;

  const comunidad = parseEs(id('e_comunidad').value);
  const ibi = parseEs(id('e_ibi').value);
  const hogar = parseEs(id('e_hogar').value);
  const impago = parseEs(id('e_impago').value);
  const gestion = parseEs(id('e_gestion').value);

  const alq = parseEs(id('e_alq').value);
  const otros = parseEs(id('e_otros').value);

  const inversion = precio + itp + notaria + reforma + psi;
  const ingresoAnual = (alq+otros)*12;
  const gastosAnuales = comunidad + ibi + hogar + impago + gestion;

  const bruta = inversion>0 ? (ingresoAnual/inversion)*100 : 0;
  const neta  = inversion>0 ? ((ingresoAnual-gastosAnuales)/inversion)*100 : 0;
  const flujo = ingresoAnual - gastosAnuales;

  const tipo = id('e_tipo').value;
  const gB = (tipo==='Tradicional'? cfg.obj_bruta_trad : cfg.obj_bruta_rooms);
  const gN = (tipo==='Tradicional'? cfg.obj_neta_trad  : cfg.obj_neta_rooms);

  // pintar
  id('e_result').hidden=false;
  id('r_inv').textContent = e0(inversion);
  id('r_bruta').textContent = pct(bruta);
  id('r_neta').textContent = pct(neta);
  id('r_flujo').textContent = e0(flujo);
  id('r_pmax').textContent = id('e_pmax').value? id('e_pmax').value+' â‚¬' : e0(0);

  const diffB = bruta - gB, diffN = neta - gN;
  id('r_bruta_diff').textContent = (diffB>=0? ' (+':' (') + fmtN1.format(diffB) + ' p.p.)';
  id('r_neta_diff').textContent  = (diffN>=0? ' (+':' (') + fmtN1.format(diffN) + ' p.p.)';

  setDot(id('sb'), goalDot(bruta, gB));
  setDot(id('sn'), goalDot(neta, gN));
  setDot(id('sf'), flujo>0 ? 'green' : 'red');

  // grÃ¡fico bruta
  drawBrutaChart(bruta, gB);

  // sugerencias prospects
  sugerirClientes({bruta, inversion});
}

/* ===== Mini-grÃ¡fico canvas: bruta real vs objetivo ===== */
function drawBrutaChart(real, goal){
  const c = id('chartBruta'); const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const W=c.width, H=c.height, pad=40;
  const max = Math.max(goal, real, 20);
  // eje
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
  // barra real
  const barW=80; const x=pad+40; const y=H-pad; const h=(Math.max(real,0)/max)*(H-2*pad);
  ctx.fillStyle = real>=goal? '#16a34a' : (real>=goal*0.9? '#f59e0b':'#ef4444');
  ctx.fillRect(x, y-h, barW, h);
  // lÃ­nea objetivo
  const yGoal = y - (goal/max)*(H-2*pad);
  ctx.strokeStyle='#94a3b8'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(pad,yGoal); ctx.lineTo(W-pad,yGoal); ctx.stroke(); ctx.setLineDash([]);
  // labels
  ctx.fillStyle='#0f1112'; ctx.font='13px Inter, Arial';
  ctx.fillText(Real: ${fmtN1.format(real)} %, x, y-h-8);
  ctx.fillText(Objetivo: ${fmtN1.format(goal)} %, W-pad-170, yGoal-6);
  // gap
  const gap = real-goal; const gtxt = ${gap>=0?'+':''}${fmtN1.format(gap)} p.p.;
  ctx.fillStyle = gap>=0? '#16a34a':'#ef4444';
  ctx.fillText(Î” ${gtxt}, x+barW+16, y-h+14);
  // nota
  id('chartNote').textContent = (isFinite(real) && isFinite(goal))? '' : 'Introduce precio/alquiler para ver el grÃ¡fico.';
}

/* ===== Matching prospects (configurable) ===== */
function sugerirClientes({bruta, inversion}){
  const cfg = CFG();
  const M = cfg.match;
  const tipo = id('e_tipo').value;
  const loc = (id('e_loc').value||'').toLowerCase();
  const asc = id('e_asc').value==='SÃ­';
  const bajo = id('e_bajo').value==='SÃ­';
  const alt = parseEs(id('e_alt').value);
  const ref = id('e_reforma_tipo').value;

  const pros = Store.pros||[];
  const list = [];
  for(const p of pros){
    let score=0, hardFail=false;

    // 1) BRUTA
    const goalB = (p.obj_bruta>0? Number(p.obj_bruta): (tipo==='Tradicional'? cfg.obj_bruta_trad : cfg.obj_bruta_rooms));
    const partB = goalB>0? Math.max(0, Math.min(1, bruta/goalB)) : 0;
    score += partB * M.weight_bruta;

    // 2) Presupuesto (usa presupuesto_total del prospect; si no hay, no penaliza)
    const presu = Number(p.presupuesto_total||0);
    if(presu>0){
      if(inversion<=presu) score += M.weight_presupuesto;
      else{
        const tol = 1 + (M.budget_tolerance_pct/100);
        if(inversion<=presu*tol) score += 0.4*M.weight_presupuesto;
      }
    }

    // 3) UbicaciÃ³n + tipo
    const locs = (p.locs_text||'').toLowerCase();
    const okLoc = !locs || locs.includes(loc);
    const okTipo = !p.pref_tipo || p.pref_tipo===tipo;
    score += (okLoc? 0.67*M.weight_ubicacion_tipo:0) + (okTipo? 0.33*M.weight_ubicacion_tipo:0);

    // 4) Condiciones
    if(M.hard_require_ascensor && !asc) hardFail=true;
    if(M.penaliza_bajo && bajo) score += 0; else score += 0.3*M.weight_condiciones;
    if(alt>0 && p.altura_max>0 && alt<=p.altura_max) score += 0.3*M.weight_condiciones;
    const prefRef = (p.acepta_reforma || M.default_acepta_reforma);
    const okRef = prefRef==='cualquiera' || (prefRef==='no' && ref==='No') || (prefRef==='lavado' && (ref==='No'||ref==='Lavado de cara')) || (prefRef==='integral');
    if(okRef) score += 0.4*M.weight_condiciones;

    if(!hardFail) list.push({p,score:Math.round(score)});
  }

  list.sort((a,b)=>b.score-a.score);
  const out = [];
  for(const {p,score} of list){
    if(score < M.cutoff_amber) continue;
    const color = score>=M.cutoff_green? 'ðŸŸ¢':'ðŸŸ¡';
    const line = ${color} ${p.nombre||'â€”'} Â· ${p.pref_tipo||'-'} Â· ${(p.locs_text||'-')} Â· Score ${score};
    out.push(`<label style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #eef2f7">
      <input type="checkbox" value="${esc(p.id||p.email||p.nombre)}"> <span>${esc(line)}</span>
    </label>`);
  }
  id('matchList').innerHTML = out.length? out.join('') : 'Sin clientes potenciales.';
}

/* ===== Guardar ===== */
function buildEvalFromUI(){
  const cfg = CFG();
  const base = {
    id: currentId || genId(),
    ts: Date.now(),
    loc: id('e_loc').value, calle: id('e_calle').value, url: id('e_url').value||'',
    anio: id('e_anio').value, m2: id('e_m2').value,
    reforma_tipo: id('e_reforma_tipo').value, alt: id('e_alt').value,
    ascensor: id('e_asc').value, bajo: id('e_bajo').value,
    habs: id('e_habs').value, banos: id('e_banos').value,
    tipo: id('e_tipo').value,
    precio: parseEs(id('e_precio').value),
    itp: parseEs(id('e_itp_eur').value) || Math.round(parseEs(id('e_precio').value)*cfg.itp_pct/100),
    notaria: parseEs(id('e_notaria').value) || cfg.notaria_eur,
    psi_incluido: id('e_incluir_psi').value==='si',
    psi: (id('e_incluir_psi').value==='si')? cfg.psi_eur : 0,
    reforma: parseEs(id('e_reforma').value),
    comunidad: parseEs(id('e_comunidad').value),
    ibi: parseEs(id('e_ibi').value),
    hogar: parseEs(id('e_hogar').value),
    impago: parseEs(id('e_impago').value),
    gestion: parseEs(id('e_gestion').value),
    alq: parseEs(id('e_alq').value),
    otros: parseEs(id('e_otros').value)
  };
  const ingresoAnual = (base.alq+base.otros)*12;
  const inversion = base.precio+base.itp+base.notaria+base.reforma+base.psi;
  const gastos = base.comunidad+base.ibi+base.hogar+base.impago+base.gestion;
  const bruta = inversion>0? (ingresoAnual/inversion)*100 : 0;
  const neta  = inversion>0? ((ingresoAnual-gastos)/inversion)*100 : 0;
  const flujo = ingresoAnual-gastos;
  const pmax  = parseEs(id('e_pmax').value);

  return {
    ...base,
    inv_total: inversion,
    kpi_bruta: +fmtN1.format(bruta).replace(',','.'),
    kpi_neta:  +fmtN1.format(neta).replace(',','.'),
    kpi_flujo: flujo,
    pmax: pmax,
    prospect_ids: []
  };
}

function guardar(){
  if(id('e_result').hidden) calcular();
  const list = Store.evals || [];
  const ev = buildEvalFromUI();

  const idx = currentId? list.findIndex(x=>x.id===currentId) : -1;
  if(idx>=0) list[idx]=ev; else list.push(ev);

  Store.evals = list;
  alert('EvaluaciÃ³n guardada');
}

function guardarYAsignar(){
  guardar();
  // recoger checks
  const checks = [...(id('matchList').querySelectorAll('input[type=checkbox]')||[])].filter(x=>x.checked).map(x=>x.value);
  const list = Store.evals || [];
  const idx = (currentId? list.findIndex(x=>x.id===currentId) : list.length-1);
  if(idx>=0){
    list[idx].prospect_ids = checks;
    Store.evals = list;
    alert('EvaluaciÃ³n guardada y asignada');
  }
}

/* ===== Precarga desde Evaluaciones ===== */
function preloadFromEvaluaciones(){
  try{
    const mem = localStorage.getItem('_load_eval_');
    if(!mem) return;
    localStorage.removeItem('_load_eval_');
    const idToLoad = mem.replace(/"/g,'');
    const e = (Store.evals||[]).find(x=>x.id===idToLoad);
    if(!e) return;

    currentId = e.id;
    id('e_loc').value = e.loc||LOCS[0];
    id('e_calle').value = e.calle||'';
    id('e_url').value = e.url||'';
    id('e_anio').value = e.anio||'';
    id('e_m2').value = e.m2||'';
    id('e_reforma_tipo').value = e.reforma_tipo||'No';
    id('e_alt').value = e.alt||'';
    id('e_asc').value = e.ascensor||'SÃ­';
    id('e_bajo').value = e.bajo||'No';
    id('e_habs').value = e.habs||'';
    id('e_banos').value = e.banos||'';
    id('e_tipo').value = e.tipo||'Tradicional';

    setMoney(id('e_precio'), e.precio);
    setMoney(id('e_itp_eur'), e.itp);
    setMoney(id('e_notaria'), e.notaria);
    setMoney(id('e_reforma'), e.reforma);

    id('e_incluir_psi').value = e.psi_incluido? 'si':'no';

    setMoney(id('e_comunidad'), e.comunidad);
    setMoney(id('e_ibi'), e.ibi);
    setMoney(id('e_hogar'), e.hogar);
    setMoney(id('e_impago'), e.impago);
    setMoney(id('e_gestion'), e.gestion);

    setMoney(id('e_alq'), e.alq);
    setMoney(id('e_otros'), e.otros);

    autoMantenimiento(); autoAdquisicion(); calcular();
  }catch(_){}
}

/* ===== Limpiar ===== */
function limpiar(){
  currentId=null;
  document.querySelectorAll('input').forEach(i=>{
    if(['e_notaria','e_itp_eur'].includes(i.id)) return;
    i.value='';
  });
  id('e_incluir_psi').value='si';
  id('e_tipo').value='Tradicional';
  autoAdquisicion();
  id('e_result').hidden=true;
}

document.addEventListener('DOMContentLoaded', mount);
})();
</script>
</body>
</html>
