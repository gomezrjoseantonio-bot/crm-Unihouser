<!DOCTYPE html>
<html lang="es" data-theme="professional">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">

<script>
/* Apply brand settings from configuration */
try{
  const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
  if(cfg.brand_color) document.documentElement.style.setProperty('--brand-primary', cfg.brand_color);
  if(cfg.ui_font) document.documentElement.style.setProperty('--font-family', cfg.ui_font);
  if(cfg.ui_font_size) document.documentElement.style.setProperty('--font-size-base', (''+cfg.ui_font_size).replace('px','')+'px');
  if(cfg.ui_theme) document.documentElement.setAttribute('data-theme', cfg.ui_theme);
  if(cfg.brand_logo) {
    window.addEventListener('DOMContentLoaded', () => {
      const logoBox = document.getElementById('logoBox');
      if(logoBox && cfg.brand_logo) {
        logoBox.innerHTML = `<img src="${cfg.brand_logo}" alt="Logo">`;
      }
    });
  }
}catch(_){}
</script>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="brand">
        <div class="logo-container" id="logoBox">
          <div class="logo-fallback">U</div>
        </div>
        <div class="title" id="brandTitle">Unihouser — Evaluar</div>
      </div>
      <nav class="nav">
        <a href="evaluar.html" class="active">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a href="evaluaciones.html?mode=search">Buscar Activos</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <main class="container">
    <section class="card animate-slide-in">
      <h2>Evaluar Activo</h2>

      <!-- DATOS DEL INMUEBLE -->
      <div class="section">
        <h3>Datos del inmueble</h3>
        <div class="row three">
          <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
          <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
          <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
        </div>
        <div class="row three">
          <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
          <div class="field"><label>Ascensor</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
          <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
        </div>
        <div class="row three">
          <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>
          <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
          <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
        </div>
        <div class="row three">
          <div class="field"><label>Necesita reforma</label>
            <select id="e_ref_nec">
              <option value="no">No</option>
              <option value="lavado">Lavado de cara</option>
              <option value="integral">Reforma integral</option>
            </select>
          </div>
          <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://www.idealista.com/inmueble/..."></div>
          <div class="field"></div>
        </div>
      </div>

      <!-- GASTOS DE ADQUISICIÓN -->
      <div class="section">
        <h3>Gastos de adquisición</h3>
        <div class="row three">
          <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
          <div class="field"><label>ITP (€ auto)</label><input id="e_itp_eur" data-money></div>
          <div class="field"><label>Notaría y Registro (€ auto)</label><input id="e_notaria" data-money></div>
        </div>
        <div class="row three">
          <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
          <div class="field"><label>Incluir honorarios PSI (4.235 €)</label>
            <select id="e_honor"><option value="si">Sí</option><option value="no" selected>No</option></select>
          </div>
          <div class="field"><label>Precio máx. de compra (objetivo bruta)</label><input id="e_pmax" data-money disabled></div>
        </div>
      </div>

      <!-- GASTOS DE MANTENIMIENTO -->
      <div class="section">
        <h3>Gastos de mantenimiento</h3>
        <div class="row three">
          <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
          <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
          <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>
        </div>
        <div class="row three">
          <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
          <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
          <div class="field"><small class="hint" style="color:#667085">Hogar/impago/gestión se autocalculan desde Config al indicar alquiler (editables).</small></div>
        </div>
      </div>

      <!-- EXPLOTACIÓN E INGRESOS -->
      <div class="section">
        <h3>Tipo de explotación e ingresos</h3>
        <div class="row three">
          <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
          <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
          <div class="field"></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="e_calc">Calcular</button>
      </div>

      <!-- RESULTADOS -->
      <div id="e_result" class="section" hidden>
        <h3>Resultados</h3>
        <div class="kpis">
          <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
          <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">—</span><span id="r_bruta_diff" class="muted"></span></div></div>
          <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">—</span><span id="r_neta_diff" class="muted"></span></div></div>
          <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">—</div></div>
          <div class="kpi"><div class="lab">Precio máx. de compra</div><div class="val" id="r_pmax">—</div></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">Clientes potenciales</h3>

          <div class="tr">
            <div class="th">Cliente</div>
            <div class="th">Real vs Objetivo</div>
            <div class="th">Aviso</div>
            <div class="th">Ajuste sugerido</div>
          </div>
          <div id="pc_list"></div>

          <div class="actions" style="margin-top:10px;justify-content:flex-end">
            <button class="btn" id="btn_discard">Descartar</button>
            <button class="btn" id="btn_save_only">Guardar</button>
            <button class="btn primary" id="btn_save_assign" disabled>Guardar y asignar</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="foot"><div class="container">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* Marca (texto) */
(function(){
  try{
    var c = JSON.parse(localStorage.getItem('cfg')||'{}')||{};
    var name = c.brand_name || c.company_name || 'Unihouser';
    document.getElementById('brandTitle').textContent = name+' — Evaluar';
    document.getElementById('logoBox').textContent = (name||'U').toString().trim().charAt(0).toUpperCase() || 'U';
  }catch(_){}
})();

/* Utils ES */
var id=function(x){return document.getElementById(x);};
var fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
var fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function e0(v){return fmtE0.format(Number(v||0));}
function n0(v){return fmtN0.format(Number(v||0));}
function pct1(v){return fmtN1.format(Number(v||0))+' %';}
function parseEs(str){
  if(str==null) return 0;
  var s=String(str).trim().replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
  var n=Number(s); return Number.isFinite(n)? n : 0;
}
function moneyLive(){
  [].forEach.call(document.querySelectorAll('input[data-money]'),function(inp){
    inp.addEventListener('input',function(){
      var digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
    });
    inp.addEventListener('blur',function(){
      var n=Math.round(parseEs(inp.value));
      inp.value=n? n0(n) : '';
    });
  });
}
function toast(msg,kind){
  var wrap=document.getElementById('toasts')||(function(){
    var d=document.createElement('div'); d.id='toasts'; d.className='toast-wrap'; document.body.appendChild(d); return d;
  })();
  var el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(function(){el.style.opacity='0';},1600);
  setTimeout(function(){try{wrap.removeChild(el)}catch(_){}} ,2200);
}

/* Store */
var Store={
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}, 
  set cfg(v){localStorage.setItem('cfg',JSON.stringify(v));},                       
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}}, 
  set pros(v){localStorage.setItem('pros',JSON.stringify(v));},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v));}
};

/* Localidades (Asturias) */
var ASTURIAS=["Allande","Aller","Amieva","Avilés","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo","Cangas de Onís","Cangas del Narcea","Caravia","Carreño","Caso","Castrillón","Castropol","Coaña","Colunga","Corvera de Asturias","Cudillero","Degaña","Gijón","Gozón","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo","Laviana","Lena","Llanera","Llanes","Mieres","Morcín","Muros de Nalón","Nava","Navia","Noreña","Onís","Oviedo","Parres","Peñamellera Alta","Peñamellera Baja","Pesoz","Piloña","Pravia","Proaza","Quirós","Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San Martín de Oscos","San Martín del Rey Aurelio","San Tirso de Abres","Santa Eulalia de Oscos","Santo Adriano","Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","Valdés","Vegadeo","Villanueva de Oscos","Villaviciosa","Villayón"];
function loadLocalidades(){
  var s=id('e_loc'); s.innerHTML='';
  ASTURIAS.forEach(function(loc){var o=document.createElement('option');o.textContent=loc;s.appendChild(o);});
}

/* Config y objetivos mínimos */
function def(v,fb){return (v===undefined||v===null)?fb:v;}
function getCfg(){
  var c=Store.cfg||{};
  var itp_raw=Number(def(c.itp_pct,def(c.itp,8))); if(!isFinite(itp_raw)) itp_raw=8;
  var itp_pct= itp_raw<1 ? itp_raw*100 : itp_raw;
  var notaria=Number(def(c.notaria,c.notaria_eur)); if(!isFinite(notaria)) notaria=1500;
  var honor=Number(def(c.honorarios,c.psi_fee_eur)); if(!isFinite(honor)) honor=4235;
  var hogar_pct=Number(def(c.hogar_pct,3.5));
  var imp_trad=Number(def(c.impago_trad_pct,4.0));
  var imp_hab =Number(def(c.impago_hab_pct,4.0));
  var g_trad  =Number(def(c.gestion_trad_pct,15.0));
  var g_hab   =Number(def(c.gestion_hab_pct,25.0));
  var o=c.objetivos||{}, t=o.tradicional||{}, h=o.habitaciones||{};
  var match=(c.match&&c.match.thresholds)?c.match:{thresholds:{green:1,amber:0.95}};
  return {
    itp_pct:itp_pct/100, notaria_eur:notaria, psi_eur:honor,
    hogar_pct:hogar_pct, impago_pct_trad:imp_trad, impago_pct_hab:imp_hab,
    gestion_pct_trad:g_trad, gestion_pct_hab:g_hab,
    obj_bruta_trad:Number(def(t.bruta_pct,10.0)),
    obj_bruta_hab:Number(def(h.bruta_pct,12.0)),
    obj_neta_trad:Number(def(t.neta_pct,6.0)),
    obj_neta_hab:Number(def(h.neta_pct,7.0)),
    thresholds: match.thresholds
  };
}

/* Autocálculos */
function bindAuto(){
  var cfg=getCfg();
  var tipoEl=id('e_tipo'), alqEl=id('e_alq'), itpEl=id('e_itp_eur'), notEl=id('e_notaria'), precioEl=id('e_precio');

  function updPrecio(){
    var precio=parseEs(precioEl.value);
    var itp=Math.round(precio*(cfg.itp_pct));
    itpEl.value=n0(itp);
    if(!parseEs(notEl.value)) notEl.value=n0(cfg.notaria_eur);
  }
  precioEl.addEventListener('input',updPrecio);
  precioEl.addEventListener('blur',updPrecio);

  function updAlq(){
    var alq_m=parseEs(alqEl.value), alq_a=alq_m*12;
    var tipo=(tipoEl.value||'Tradicional').toLowerCase();
    var impago_pct=(tipo==='habitaciones')?cfg.impago_pct_hab:cfg.impago_pct_trad;
    var gest_pct  =(tipo==='habitaciones')?cfg.gestion_pct_hab:cfg.gestion_pct_trad;
    id('e_hogar').value  = n0(Math.round(alq_a*(cfg.hogar_pct/100)));
    id('e_impago').value = n0(Math.round(alq_a*(impago_pct/100)));
    id('e_gestion').value= n0(Math.round(alq_a*(gest_pct/100)));
  }
  alqEl.addEventListener('input',updAlq);
  alqEl.addEventListener('blur',updAlq);
  tipoEl.addEventListener('change',updAlq);
}

/* Estado */
var CURRENT_ID=null;

/* Cálculos y render */
function calc(){
  var cfg=getCfg();
  var tipo=(id('e_tipo').value||'Tradicional');
  var precio=parseEs(id('e_precio').value);
  var itp   =parseEs(id('e_itp_eur').value)||Math.round(precio*cfg.itp_pct);
  var notari=parseEs(id('e_notaria').value)||cfg.notaria_eur;
  var ref   =parseEs(id('e_reforma').value);
  var honor =(id('e_honor').value==='si')?cfg.psi_eur:0;

  var comu=parseEs(id('e_comunidad').value);
  var ibi =parseEs(id('e_ibi').value);
  var hogar=parseEs(id('e_hogar').value);
  var impago=parseEs(id('e_impago').value);
  var gest=parseEs(id('e_gestion').value);

  var alq_m=parseEs(id('e_alq').value);
  var alq_a=alq_m*12;

  var inv_total=precio+itp+notari+ref+honor;
  var gastos_a =comu+ibi+hogar+impago+gest;

  var bruta=inv_total>0?(alq_a/inv_total*100):0;
  var neta =inv_total>0?((alq_a-gastos_a)/inv_total*100):0;
  var flujo=alq_a-gastos_a;

  var objB=(tipo==='Habitaciones')?cfg.obj_bruta_hab:cfg.obj_bruta_trad;
  var targetInv=(objB>0)?(alq_a/(objB/100)):0;
  var pmax=0;
  if(targetInv>0){
    var extras=(notari+ref+honor);
    pmax=Math.max(0,Math.floor((targetInv-extras)/(1+cfg.itp_pct)));
  }

  id('r_inv').textContent=e0(inv_total);
  id('r_bruta').textContent=pct1(bruta);
  id('r_neta').textContent=pct1(neta);
  id('r_flujo').textContent=e0(flujo);
  id('r_pmax').textContent=e0(pmax);
  id('e_pmax').value=n0(pmax);

  paintDot('sb',bruta-objB);
  paintDot('sn',neta - (tipo==='Habitaciones'?cfg.obj_neta_hab:cfg.obj_neta_trad));
  paintDot('sf',flujo>=0?1:-1);
  id('r_bruta_diff').textContent=''; id('r_neta_diff').textContent='';

  buildCandidates({
    tipo:tipo, loc:id('e_loc').value||'',
    bruta:bruta, neta:neta, flujo:flujo,
    alq_m:alq_m, alq_a:alq_a,
    inv_total:inv_total, gastos_a:gastos_a,
    ref_tip:id('e_ref_nec').value||'no',
    asc:id('e_asc').value||'Sí',
    bajo:id('e_bajo').value||'No',
    precio:precio, notaria:notari, psi:honor, itp_pct:cfg.itp_pct, reforma:ref,
    obj_min_bruta: objB
  });

  id('e_result').hidden=false;

  return {
    id:CURRENT_ID||('ev_'+Date.now()), ts:Date.now(),
    loc:id('e_loc').value||'', calle:id('e_calle').value||'',
    m2:id('e_m2').value||'', anio:id('e_anio').value||'',
    asc:id('e_asc').value||'', alt:id('e_alt').value||'',
    bajo:id('e_bajo').value||'', habs:id('e_habs').value||'',
    banos:id('e_banos').value||'', ref_tip:id('e_ref_nec').value||'no',
    url:id('e_url').value||'', tipo:tipo,
    precio:precio, itp:itp, notaria:notari, psi:honor, reforma:ref,
    comu:comu, ibi:ibi, hogar:hogar, impago:impago, gestion:gest,
    alq:alq_m, inv_total:inv_total, kpi_bruta:bruta, kpi_neta:neta, kpi_flujo:flujo, pmax:pmax
  };
}
function paintDot(dot,gap){ var el=id(dot); el.className='dot '+(gap>=0?'g':(gap>-1?'y':'r')); }

/* Helpers matching */
function fold(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();}
function inCompra(p){var f=fold(p.fase||''); return !(f.includes('compra')||f.includes('éxito')||f.includes('exito')); }
function parseMoney(v){if(v==null)return 0;return Number(String(v).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;}
function prospectBudgetCTO(p){
  var cfg=getCfg(); 
  var pmax = Number(p.inv_pmax||p.pmax||0);
  var incPsi = !!p.psi_in_presupuesto;
  return incPsi ? pmax : (pmax + cfg.psi_eur);
}
function getTargetInfo(p){
  var main=(p.obj_main||p.obj_tipo||'').toString().toLowerCase().trim();
  var b=Number(p.obj_bruta||0), n=Number(p.obj_neta||0), fm=Number(p.obj_flujo||0), fa=Number(p.obj_flujo_anual||0);
  if(main==='bruta'&&b>0) return {kind:'bruta',val:b};
  if(main==='neta' &&n>0) return {kind:'neta', val:n};
  if(main==='flujo'&&(fm>0||fa>0)) return {kind:'flujo',val:(fa>0?fa:fm*12)};
  if(b>0) return {kind:'bruta',val:b};
  if(n>0) return {kind:'neta', val:n};
  if(fa>0||fm>0) return {kind:'flujo',val:(fa>0?fa:fm*12)};
  return {kind:'',val:0};
}
function classifyRatio(actual,target){
  var th=getCfg().thresholds;
  if(!target||target<=0) return {cls:'r',ratio:0};
  var ratio = actual/target;
  var green = Number(th.green||1);
  var amber = Number(th.amber||0.95);
  var cls = ratio>=green ? 'g' : (ratio>=amber ? 'y' : 'r');
  return {cls:cls, ratio:ratio};
}
function warnReasons(p,ctx,locOK){
  var reasons=[];
  if(!locOK) reasons.push('Otra localidad');
  var sinAscensor=fold(ctx.asc)==='no', esBajo=fold(ctx.bajo)==='si';
  var wantsElev = fold((p.prefs&&p.prefs.ascensor)||p.ascensor||'');
  var wantsNoBajos = fold((p.prefs&&p.prefs.evitar_bajos)||p.evitar_bajos||'');
  var wantsRef = fold((p.prefs&&p.prefs.reforma)||p.reforma||'');
  if(sinAscensor && (wantsElev==='requiere'||wantsElev==='si'||wantsElev==='sí')) reasons.push('Sin ascensor');
  if(esBajo && (wantsNoBajos==='si'||wantsNoBajos==='sí')) reasons.push('Bajo');
  if((ctx.ref_tip && ctx.ref_tip!=='no') && (wantsRef==='no')) reasons.push('Reforma');
  var budget=prospectBudgetCTO(p); if(budget>0 && Number(ctx.inv_total||0)>budget) reasons.push('Excede presupuesto');
  return reasons;
}
function adjustments(p,ctx,target){
  var out={price_down:0, rent_up:0};
  var rate=ctx.itp_pct; // decimal
  var extras=ctx.notaria + ctx.psi + ctx.reforma;
  if(target.kind==='flujo'){
    var need = Math.max(0, target.val - ctx.flujo);
    out.rent_up = Math.ceil(need/12);
    return out;
  }
  if(target.kind==='bruta'){
    var invNeed = ctx.alq_a/(target.val/100);
    var pNew = (invNeed - extras) / (1+rate);
    out.price_down = Math.max(0, Math.round(ctx.precio - pNew));
    var alqNeed = (target.val/100) * ctx.inv_total;
    out.rent_up = Math.max(0, Math.ceil((alqNeed - ctx.alq_a)/12));
    return out;
  }
  if(target.kind==='neta'){
    var invNeedN = ( (ctx.alq_a - ctx.gastos_a) / (target.val/100) );
    var pNewN = (invNeedN - extras) / (1+rate);
    out.price_down = Math.max(0, Math.round(ctx.precio - pNewN));
    var alqNeedN = ctx.gastos_a + (target.val/100)*ctx.inv_total;
    out.rent_up = Math.max(0, Math.ceil((alqNeedN - ctx.alq_a)/12));
    return out;
  }
  return out;
}

/* Construir candidatos */
function buildCandidates(ctx){
  var list=Store.pros||[];
  var pc=id('pc_list'); pc.innerHTML='';
  var rows=[];

  list.forEach(function(p){
    if(!inCompra(p)) return;

    // Tipo de alquiler debe coincidir
    if(fold(p.pref_tipo||((p.prefs&&p.prefs.tipo)||''))!==fold(ctx.tipo)) return;

    var target=getTargetInfo(p); if(!target.val) return;

    var actual = (target.kind==='bruta')?ctx.bruta : (target.kind==='neta'?ctx.neta:ctx.flujo);
    var cls = classifyRatio(actual, target.val).cls;

    var locs=( (p.locs_text)||((p.prefs&&p.prefs.localidades)||'') ).split(',').map(fold).filter(Boolean);
    var locOK = !locs.length ? false : locs.includes(fold(ctx.loc));

    var reasons = warnReasons(p,ctx,locOK);
    var superMatch = (cls==='g' && locOK && reasons.length===0);

    var adj = (cls==='g' ? {price_down:0,rent_up:0} : adjustments(p,ctx,target));

    rows.push({p:p, cls:cls, super:superMatch, reasons:reasons, target:target, actual:actual, adj:adj});
  });

  // Orden: super ★ → verdes con aviso → ámbar → rojo
  rows.sort(function(a,b){
    if(a.super!==b.super) return a.super? -1: 1;
    var rank={g:0,y:1,r:2};
    if(rank[a.cls]!==rank[b.cls]) return rank[a.cls]-rank[b.cls];
    return (a.reasons.length)-(b.reasons.length);
  });

  if(!rows.length){
    // Fallback sin candidatos: sugerir guardar/descartar según objetivo mínimo
    var objMin = ctx.obj_min_bruta||10;
    var cls0 = classifyRatio(ctx.bruta, objMin).cls;
    var target={kind:'bruta',val:objMin};
    var adj0 = (cls0==='g')?{price_down:0,rent_up:0}:adjustments({},ctx,target);

    var tr=document.createElement('div'); tr.className='tr';

    var c1=document.createElement('div'); c1.className='td';
    var dot=document.createElement('span'); dot.className='dot '+cls0; c1.appendChild(dot);
    var name=document.createElement('span'); name.style.fontWeight='800'; name.textContent='—'; c1.appendChild(name);

    var c2=document.createElement('div'); c2.className='td';
    c2.textContent='RB: '+fmtN1.format(ctx.bruta)+' % vs '+fmtN1.format(objMin)+' %';

    var c3=document.createElement('div'); c3.className='td';
    var b=document.createElement('span'); b.className='badge-warn';
    b.textContent = (cls0==='g') ? 'Sin candidatos · Sugerencia: guardar' : 'Sin candidatos · Sugerencia: descartar';
    c3.appendChild(b);

    var c4=document.createElement('div'); c4.className='td';
    var chips=[];
    if(adj0.price_down>0) chips.push('−'+fmtE0.format(adj0.price_down)+' precio');
    if(adj0.rent_up>0) chips.push('+'+fmtE0.format(adj0.rent_up).replace(' €',' €/mes')+' alquiler');
    c4.textContent = chips.length? chips.join(' · ') : '—';

    tr.appendChild(c1); tr.appendChild(c2); tr.appendChild(c3); tr.appendChild(c4);
    pc.appendChild(tr);
    toggleAssignButton();
    return;
  }

  rows.forEach(function(r){
    var tr=document.createElement('div'); tr.className='tr';

    // Cliente: check + dot + nombre + pill fase (sin email)
    var c1=document.createElement('div'); c1.className='td';
    var chk=document.createElement('input'); chk.type='checkbox'; chk.dataset.id=r.p.id||''; chk.addEventListener('change',toggleAssignButton);
    var dot=document.createElement('span'); dot.className='dot '+r.cls;
    var name=document.createElement('span'); name.style.fontWeight='800'; name.textContent=(r.p.nombre||'-');
    var fase=document.createElement('span'); fase.className='pill'; fase.textContent=(String(r.p.fase||'').toUpperCase()||'').replace('Á','A').replace('É','E');
    c1.appendChild(chk); c1.appendChild(dot); c1.appendChild(name); c1.appendChild(fase);

    // Real vs Objetivo
    var c2=document.createElement('div'); c2.className='td';
    var label = (r.target.kind==='bruta'?'RB':(r.target.kind==='neta'?'RN':'FL'));
    var txt = (r.target.kind==='flujo')
      ? 'FL: '+fmtE0.format(ctx.flujo)+' vs '+fmtE0.format(r.target.val)
      : label+': '+fmtN1.format(r.actual)+' % vs '+fmtN1.format(r.target.val)+' %';
    c2.textContent = txt;

    // Avisos (motivos)
    var c3=document.createElement('div'); c3.className='td';
    if(r.reasons.length){ r.reasons.forEach(function(t){ var w=document.createElement('span'); w.className='badge-warn'; w.textContent='⚠ '+t; c3.appendChild(w); }); }
    else { c3.textContent='—'; }

    // Ajuste sugerido
    var c4=document.createElement('div'); c4.className='td';
    var chips=[];
    if(r.adj.price_down>0){ chips.push('−'+fmtE0.format(r.adj.price_down)+' precio'); }
    if(r.adj.rent_up>0){ chips.push('+'+fmtE0.format(r.adj.rent_up).replace(' €',' €/mes')+' alquiler'); }
    c4.textContent = chips.length? chips.join(' · ') : '—';

    tr.appendChild(c1); tr.appendChild(c2); tr.appendChild(c3); tr.appendChild(c4);
    pc.appendChild(tr);
  });
  toggleAssignButton();
}
function toggleAssignButton(){
  var any = !!document.querySelector('#pc_list input[type="checkbox"]:checked');
  id('btn_save_assign').disabled = !any;
}

/* Guardar / Asignar / Descartar */
function gather(){return calc();}
function save(alsoAssign){
  var e=gather();
  var list=Store.evals||[];
  if(CURRENT_ID) e.id=CURRENT_ID;
  var at=list.findIndex(function(x){return x.id===e.id;});
  if(alsoAssign){
    var ids=[].slice.call(document.querySelectorAll('#pc_list input[type="checkbox"]:checked')).map(function(i){return i.dataset.id;});
    e.prospect_ids=ids;
  }
  if(at>=0) list[at]=e; else list.push(e);
  Store.evals=list; CURRENT_ID=e.id;
  toast(alsoAssign?('Guardado y asignado'):('Evaluación guardada'),'ok');
}
function discard(){ id('e_result').hidden=true; }

/* Precarga */
function preloadIfAny(){
  var evId=localStorage.getItem('load_eval'); if(!evId)return;
  var e=(Store.evals||[]).find(function(x){return x.id===evId;}); if(!e)return;
  CURRENT_ID=e.id;
  id('e_loc').value=e.loc||''; id('e_calle').value=e.calle||''; id('e_m2').value=e.m2||'';
  id('e_anio').value=e.anio||''; id('e_asc').value=e.asc||'Sí'; id('e_alt').value=e.alt||'';
  id('e_bajo').value=e.bajo||'No'; id('e_habs').value=e.habs||''; id('e_banos').value=e.banos||'';
  id('e_ref_nec').value=e.ref_tip||'no'; id('e_url').value=e.url||'';
  id('e_tipo').value=e.tipo||'Tradicional';
  id('e_precio').value=n0(e.precio||0); id('e_itp_eur').value=n0(e.itp||0); id('e_notaria').value=n0(e.notaria||0);
  id('e_reforma').value=n0(e.reforma||0); id('e_honor').value=(e.psi&&e.psi>0)?'si':'no';
  id('e_comunidad').value=n0(e.comu||0); id('e_ibi').value=n0(e.ibi||0); id('e_hogar').value=n0(e.hogar||0);
  id('e_impago').value=n0(e.impago||0); id('e_gestion').value=n0(e.gestion||0); id('e_alq').value=n0(e.alq||0);
  calc();
}

/* Eventos */
function attach(){
  loadLocalidades(); moneyLive(); bindAuto();
  id('e_calc').addEventListener('click',calc);
  id('btn_save_only').addEventListener('click',function(){ save(false); });
  id('btn_save_assign').addEventListener('click',function(){ save(true); });
  id('btn_discard').addEventListener('click',discard);
  preloadIfAny();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>

<div id="toasts" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
