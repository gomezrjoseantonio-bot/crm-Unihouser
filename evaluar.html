<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* estilos mínimos locales */
.grid3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
@media(max-width:1100px){.grid3{grid-template-columns:1fr}}
.kpis{display:grid;gap:10px;grid-template-columns:repeat(5,1fr)}
.kpi .lab{color:#667085;font-size:12px}.kpi .val{font-weight:800}
.dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-left:6px;vertical-align:middle;background:#d1d5db}
.dot.ok{background:#16a34a}.dot.warn{background:#f59e0b}.dot.bad{background:#ef4444}
.muted{color:#667085}
.hint{color:#667085;font-size:12px}
.btn.sm{padding:8px 10px;font-size:13px;border-radius:10px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <!-- DATOS INMUEBLE -->
  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="grid3">
      <div class="field"><label>Localidad</label>
        <select id="e_loc">
          <option>Oviedo</option><option>Gijón</option><option>Avilés</option>
          <option>Mieres</option><option>Langreo</option><option>Allande</option>
        </select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://..."></div>

      <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric" placeholder="1975"></div>
      <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric" placeholder="72"></div>
      <div class="field"><label>Necesita reforma</label>
        <select id="e_ref"><option>No</option><option>Lavado de cara</option><option>Integral</option></select></div>

      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
      <div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>

      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric" placeholder="3"></div>
      <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric" placeholder="1"></div>
      <div></div>
    </div>
  </div>

  <!-- ADQUISICIÓN -->
  <div class="section">
    <h3>Gastos de adquisición</h3>
    <div class="grid3">
      <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (€ — auto)</label><input id="e_itp_eur" data-money disabled></div>
      <div class="field"><label>Notaría y Registro (€ — auto)</label><input id="e_notaria" data-money disabled></div>

      <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (con IVA)</label><select id="e_honor"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>Precio máx. compra (para cumplir BRUTA)</label><input id="e_pmax" data-money disabled></div>
    </div>
    <div class="hint">Se toma el objetivo de <strong>rentabilidad bruta</strong> definido en Configuración para el tipo elegido.</div>
  </div>

  <!-- MANTENIMIENTO -->
  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="grid3">
      <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>

      <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
      <div class="field"><small class="hint">Hogar/impago/gestión se autocalculan al indicar alquiler, según Config. Editables.</small></div>
    </div>
  </div>

  <!-- EXPLOTACIÓN -->
  <div class="section">
    <h3>Tipo de explotación e ingresos</h3>
    <div class="grid3">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
      <div></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn ghost" id="e_clean">Limpiar</button>
  </div>

  <!-- RESULTADOS -->
  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis">
      <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div><div class="val"><span id="r_bruta">—</span></div></div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div><div class="val"><span id="r_neta">—</span></div></div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">—</div></div>
      <div class="kpi"><div class="lab">Precio máx. compra</div><div class="val" id="r_pmax">—</div></div>
    </div>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="save_only">Guardar evaluación</button>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Utils/Store ===== */
const id=x=>document.getElementById(x);
const fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0=v=>fmtE0.format(Number(v||0));
const pct=v=>fmtN1.format(Number(v||0))+' %';
const parseEs=s=>Number(String(s??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.'))||0;
const Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}} },
  set cfg(v){ localStorage.setItem('cfg',JSON.stringify(v)); },
  get evals(){ try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]} },
  set evals(v){ localStorage.setItem('evals',JSON.stringify(v)); }
};
/* robustez: lee múltiples nombres posibles de config */
const CFG=(k,def)=>{
  const c=Store.cfg||{};
  const cand=[k,k.toLowerCase(),k.toUpperCase(),
    {itp_pct:'itp_pct',notaria:'notaria',
     hogar_pct:'hogar_pct',impago_trad_pct:'impago_trad_pct',impago_hab_pct:'impago_hab_pct',
     gestion_trad_pct:'gestion_trad_pct',gestion_hab_pct:'gestion_hab_pct',
     obj_bruta_trad:'obj_bruta_trad',obj_bruta_hab:'obj_bruta_hab'}[k]];
  for(const key of cand){ if(key!=null && c[key]!=null) return Number(c[key]); }
  return Number(def);
};

/* ===== Money live formatting ===== */
function setupMoneyLive(){
  document.querySelectorAll('input[data-money]').forEach(inp=>{
    inp.addEventListener('input',()=>{
      const digits=(inp.value||'').replace(/[^\d]/g,'');
      if(!digits){inp.value='';return;}
      inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Number(digits));
      if(inp.id==='e_alq') autoFromRent();          // autocalcula gastos desde alquiler
      if(inp.id==='e_precio') autoFromPrice();      // itp/notaria y pmax
    });
    inp.addEventListener('blur',()=>{
      const n=parseEs(inp.value);
      inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Math.round(n));
    });
  });
}

/* ===== Autocalculados ===== */
function autoFromPrice(){
  const precio=parseEs(id('e_precio').value);
  const itp_pct = CFG('itp_pct', 8);
  id('e_itp_eur').value = fmtN0.format(Math.round(precio*itp_pct/100));
  id('e_notaria').value = fmtN0.format(Math.round(CFG('notaria',1500)));
  recalcPmax();
}
function autoFromRent(){
  const alq=parseEs(id('e_alq').value);
  const anual=alq*12;
  const tipo=id('e_tipo').value||'Tradicional';
  const hogar_pct   = CFG('hogar_pct',   3);  // %
  const impago_pct  = tipo==='Habitaciones'? CFG('impago_hab_pct',10): CFG('impago_trad_pct',5);
  const gestion_pct = tipo==='Habitaciones'? CFG('gestion_hab_pct',20): CFG('gestion_trad_pct',12);
  id('e_hogar').value   = fmtN0.format(Math.round(anual*hogar_pct/100));
  id('e_impago').value  = fmtN0.format(Math.round(anual*impago_pct/100));
  id('e_gestion').value = fmtN0.format(Math.round(anual*gestion_pct/100));
  recalcPmax();
}
function psiCost(){ return (id('e_honor').value==='Sí')? 4235 : 0; }

function recalcPmax(){
  const alqM=parseEs(id('e_alq').value);
  if(!alqM) { id('e_pmax').value=''; return; }
  const anual = alqM*12;
  const itp_pct = CFG('itp_pct',8)/100;
  const notaria = CFG('notaria',1500);
  const reforma = parseEs(id('e_reforma').value||0);
  const psi = psiCost();
  const tipo=id('e_tipo').value||'Tradicional';
  const obj = (tipo==='Habitaciones')? CFG('obj_bruta_hab',12) : CFG('obj_bruta_trad',10); // %
  const invTarget = anual/(obj/100);
  const fijo = notaria + reforma + psi;
  const pmax = Math.max(0, (invTarget - fijo) / (1+itp_pct));
  id('e_pmax').value = fmtN0.format(Math.round(pmax));
}

/* ===== Cálculo KPIs ===== */
function calcular(){
  // entradas
  const precio=parseEs(id('e_precio').value);
  const itp   = parseEs(id('e_itp_eur').value);
  const nota  = parseEs(id('e_notaria').value);
  const ref   = parseEs(id('e_reforma').value);
  const psi   = psiCost();
  const comunidad=parseEs(id('e_comunidad').value);
  const ibi=parseEs(id('e_ibi').value);
  const hogar=parseEs(id('e_hogar').value);
  const impago=parseEs(id('e_impago').value);
  const gestion=parseEs(id('e_gestion').value);
  const alqM=parseEs(id('e_alq').value);

  const inv = precio + itp + nota + ref + psi;
  const anual = alqM*12;
  const gastos = comunidad+ibi+hogar+impago+gestion;
  const flujo = anual - gastos;
  const bruta = inv>0 ? (anual/inv*100) : 0;
  const neta  = inv>0 ? (flujo/inv*100) : 0;

  id('r_inv').textContent = e0(inv);
  id('r_bruta').textContent = pct(bruta);
  id('r_neta').textContent  = pct(neta);
  id('r_flujo').textContent = e0(flujo);
  id('r_pmax').textContent  = fmtE0.format(parseEs(id('e_pmax').value)||0);

  // semáforos vs objetivo
  const tipo=id('e_tipo').value||'Tradicional';
  const goal = (tipo==='Habitaciones')? CFG('obj_bruta_hab',12) : CFG('obj_bruta_trad',10);
  const setDot=(el,val)=>{ el.classList.remove('ok','warn','bad');
    if(val>=goal) el.classList.add('ok');
    else if(val>=goal-1) el.classList.add('warn');
    else el.classList.add('bad'); };
  setDot(id('sb'),bruta);
  setDot(id('sn'),neta);
  setDot(id('sf'),flujo>=0?100:0);

  id('e_result').hidden=false;
}

/* ===== Guardar evaluación ===== */
function collect(){
  const get = k=>document.getElementById(k);
  const o={
    id: (get('e_id')?.value)||('ev_'+Date.now()),
    ts: Date.now(),
    loc: get('e_loc').value, calle:get('e_calle').value, url:get('e_url').value,
    anio:get('e_anio').value, m2:get('e_m2').value, ref:get('e_ref').value,
    alt:get('e_alt').value, asc:get('e_asc').value, bajo:get('e_bajo').value,
    habs:get('e_habs').value, banos:get('e_banos').value,
    tipo:get('e_tipo').value,
    precio: parseEs(get('e_precio').value),
    itp_eur: parseEs(get('e_itp_eur').value),
    notaria: parseEs(get('e_notaria').value),
    reforma: parseEs(get('e_reforma').value),
    honor: get('e_honor').value,
    pmax: parseEs(get('e_pmax').value),
    comunidad: parseEs(get('e_comunidad').value),
    ibi: parseEs(get('e_ibi').value),
    hogar: parseEs(get('e_hogar').value),
    impago: parseEs(get('e_impago').value),
    gestion: parseEs(get('e_gestion').value),
    alq: parseEs(get('e_alq').value),
    inv_total: parseEs((id('r_inv').textContent||'').replace(/[^\d,.-]/g,'')),
    kpi_bruta: Number(String(id('r_bruta').textContent).replace(/[^\d,.-]/g,'').replace(',','.')),
    kpi_neta:  Number(String(id('r_neta').textContent ).replace(/[^\d,.-]/g,'').replace(',','.')),
    kpi_flujo: parseEs((id('r_flujo').textContent||'').replace(/[^\d,.-]/g,'')),
    prospect_ids: []
  };
  return o;
}
function guardar(){
  const list=Store.evals||[];
  const data=collect();
  const ix=list.findIndex(x=>x.id===data.id);
  if(ix>=0) list[ix]=data; else list.push(data);
  Store.evals=list;
  alert('Evaluación guardada');
}

/* ===== Limpiar ===== */
function limpiar(){
  document.querySelectorAll('input').forEach(i=>{ if(i.disabled) return; i.value=''; });
  id('e_honor').value='Sí'; id('e_tipo').value='Tradicional';
  id('e_result').hidden=true;
}

/* ===== Carga previa desde _load_eval_ o #open=ID ===== */
function loadIfRequested(){
  const hashId=(location.hash||'').split('open=')[1]; 
  const stored=localStorage.getItem('_load_eval_')||'';
  const target = hashId? decodeURIComponent(hashId) : stored;
  if(!target) return;
  const e=(Store.evals||[]).find(x=>x.id===target); if(!e) return;
  // vuelca en formulario
  const set=(k,v)=>{const el=id(k); if(!el) return; el.value=(String(v??'')); if(el.hasAttribute('data-money')) el.dispatchEvent(new Event('input'));};
  set('e_loc',e.loc); set('e_calle',e.calle); set('e_url',e.url);
  set('e_anio',e.anio); set('e_m2',e.m2); set('e_ref',e.ref);
  set('e_alt',e.alt); set('e_asc',e.asc); set('e_bajo',e.bajo);
  set('e_habs',e.habs); set('e_banos',e.banos);
  set('e_tipo',e.tipo);
  set('e_precio',fmtN0.format(e.precio)); autoFromPrice();
  set('e_reforma',fmtN0.format(e.reforma)); set('e_honor',e.honor);
  set('e_comunidad',fmtN0.format(e.comunidad)); set('e_ibi',fmtN0.format(e.ibi));
  set('e_hogar',fmtN0.format(e.hogar)); set('e_impago',fmtN0.format(e.impago)); set('e_gestion',fmtN0.format(e.gestion));
  set('e_alq',fmtN0.format(e.alq)); autoFromRent();
  // id oculto para sobrescribir al guardar
  let hid=document.getElementById('e_id'); if(!hid){ hid=document.createElement('input'); hid.type='hidden'; hid.id='e_id'; document.body.appendChild(hid); }
  hid.value=e.id;
}

function attach(){
  setupMoneyLive();
  document.getElementById('e_tipo').addEventListener('change',()=>{autoFromRent();recalcPmax();});
  id('e_honor').addEventListener('change',recalcPmax);
  id('e_alq').addEventListener('input',recalcPmax);
  id('e_reforma').addEventListener('input',recalcPmax);
  id('e_calc').addEventListener('click',calcular);
  id('e_clean').addEventListener('click',limpiar);
  id('save_only').addEventListener('click',guardar);
  // inicializaciones
  autoFromPrice(); loadIfRequested();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>
</body>
</html>
