<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Evaluar</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* Utilidades locales (no pisan tu style.css) */
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.kpis5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
.kpi .lab{color:#667085;font-size:12px}.kpi .val{font-weight:800}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-left:6px}
.green{background:#16a34a}.yellow{background:#f59e0b}.red{background:#ef4444}
.muted{color:#667085}
canvas{max-width:100%;height:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html" class="active">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
<section class="card">
  <h2>Evaluar Activo</h2>

  <div class="section">
    <h3>Datos del inmueble</h3>
    <div class="grid3">
      <div class="field"><label>Localidad</label><select id="e_loc"></select></div>
      <div class="field"><label>Calle</label><input id="e_calle" placeholder="C/ Ejemplo 1"></div>
      <div class="field"><label>URL Idealista (opcional)</label><input id="e_url" placeholder="https://..."></div>

      <div class="field"><label>Año construcción — opcional</label><input id="e_anio" inputmode="numeric"></div>
      <div class="field"><label>Superficie (m²) — opcional</label><input id="e_m2" inputmode="numeric"></div>
      <div class="field"><label>¿Necesita reforma?</label>
        <select id="e_reforma_tipo"><option>No</option><option>Lavado de cara</option><option>Integral</option></select>
      </div>

      <div class="field"><label>Altura (planta)</label><input id="e_alt" inputmode="numeric" value="1"></div>
      <div class="field"><label>¿Ascensor?</label><select id="e_asc"><option>Sí</option><option>No</option></select></div>
      <div class="field"><label>¿Es bajo?</label><select id="e_bajo"><option>No</option><option>Sí</option></select></div>

      <div class="field"><label>Habitaciones</label><input id="e_habs" inputmode="numeric"></div>
      <div class="field"><label>Baños</label><input id="e_banos" inputmode="numeric"></div>
      <div></div>
    </div>
  </div>

  <div class="section">
    <h3>Gastos de adquisición</h3>
    <div class="grid3">
      <div class="field"><label>Precio de compra (€)</label><input id="e_precio" data-money></div>
      <div class="field"><label>ITP (€ — auto)</label><input id="e_itp_eur" data-money disabled></div>
      <div class="field"><label>Notaría y Registro (€ — auto)</label><input id="e_notaria" data-money disabled></div>

      <div class="field"><label>Reforma (€)</label><input id="e_reforma" value="0" data-money></div>
      <div class="field"><label>Incluir honorarios PSI (4.235 € IVA inc.)</label>
        <select id="e_incluir_psi"><option value="si">Sí</option><option value="no">No</option></select>
      </div>
      <div class="field"><label>Precio máx. compra (cumplir BRUTA)</label><input id="e_pmax" data-money disabled></div>
    </div>
    <div class="muted" style="margin-top:6px">El objetivo BRUTA se toma de Config según tipo (Tradicional/Habitaciones).</div>
  </div>

  <div class="section">
    <h3>Gastos de mantenimiento</h3>
    <div class="grid3">
      <div class="field"><label>Comunidad (€/año)</label><input id="e_comunidad" value="0" data-money></div>
      <div class="field"><label>IBI (€/año)</label><input id="e_ibi" value="0" data-money></div>
      <div class="field"><label>Seguro hogar (€/año — auto)</label><input id="e_hogar" value="0" data-money></div>

      <div class="field"><label>Seguro impago (€/año — auto)</label><input id="e_impago" value="0" data-money></div>
      <div class="field"><label>Gestión (€/año — auto)</label><input id="e_gestion" value="0" data-money></div>
      <div></div>
    </div>
    <div class="muted" style="margin-top:6px">Hogar/impago/gestión se autocalculan al fijar el alquiler según Config.</div>
  </div>

  <div class="section">
    <h3>Tipo de explotación e ingresos</h3>
    <div class="grid3">
      <div class="field"><label>Tipo de alquiler</label><select id="e_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
      <div class="field"><label>Alquiler mensual (€)</label><input id="e_alq" data-money></div>
      <div></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="e_calc">Calcular</button>
    <button class="btn" id="e_clean">Limpiar</button>
    <button class="btn" id="save_only">Guardar evaluación</button>
  </div>

  <div id="e_result" class="section" hidden>
    <h3>Resultados</h3>
    <div class="kpis5">
      <div class="kpi"><div class="lab">Inversión total</div><div class="val" id="r_inv">—</div></div>
      <div class="kpi"><div class="lab">Rentabilidad bruta <span id="sb" class="dot"></span></div>
        <div class="val"><span id="r_bruta">—</span> <span id="r_bruta_diff" class="muted"></span></div>
      </div>
      <div class="kpi"><div class="lab">Rentabilidad neta <span id="sn" class="dot"></span></div>
        <div class="val"><span id="r_neta">—</span> <span id="r_neta_diff" class="muted"></span></div>
      </div>
      <div class="kpi"><div class="lab">Flujo de caja anual <span id="sf" class="dot"></span></div><div class="val" id="r_flujo">—</div></div>
      <div class="kpi"><div class="lab">Precio máx. de compra</div><div class="val" id="r_pmax">—</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Gráfico · Bruta vs Objetivo</h3>
      <canvas id="chartBruta" width="660" height="220"></canvas>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Clientes potenciales</h3>
      <div id="matchList" class="muted">—</div>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="save_assign">Guardar y asignar</button>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<script>
(function(){
"use strict";

/* ===== Helpers ===== */
function id(s){return document.getElementById(s);}
var fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
var fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function e0(v){return fmtE0.format(Number(v||0));}
function n0(v){return fmtN0.format(Number(v||0));}
function pct(v){return fmtN1.format(Number(v||0))+' %';}
function parseEs(str){if(str==null)return 0;var s=String(str).trim().replace(/\./g,'').replace(',', '.');var n=Number(s);return isFinite(n)?n:0;}
function setMoney(inp,v){if(!inp)return;inp.value=n0(Math.round(Number(v||0)));}

function setDot(el,cls){el.className='dot '+cls;}
function dotByGoal(val,goal){return val>=goal?'green':(val>=goal*0.9?'yellow':'red');}
function genId(){var d=new Date();function p(x){return String(x).padStart(2,'0');}return 'ev_'+d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+''+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds())+''+Math.random().toString(36).slice(2,6);}

/* ===== Store ===== */
var Store={
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(e){return{}} },
  set cfg(v){localStorage.setItem('cfg',JSON.stringify(v));},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(e){return[]} },
  set pros(v){localStorage.setItem('pros',JSON.stringify(v));},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(e){return[]} },
  set evals(v){localStorage.setItem('evals',JSON.stringify(v));}
};

/* ===== Localidades (Asturias) ===== */
var LOCS=["Allande","Aller","Amieva","Avilés","Belmonte de Miranda","Bimenes","Boal","Cabrales","Cabranes","Candamo","Cangas de Onís","Cangas del Narcea","Caravia","Carreño","Caso","Castrillón","Castropol","Coaña","Colunga","Corvera de Asturias","Cudillero","Degaña","Gijón","Gozón","Grado","Grandas de Salime","Ibias","Illano","Illas","Langreo","Laviana","Lena","Llanera","Llanes","Las Regueras","Morcín","Muros de Nalón","Mieres","Nava","Navia","Noreña","Onís","Oviedo","Parres","Peñamellera Alta","Peñamellera Baja","Pesoz","Piloña","Pravia","Proaza","Quirós","Ribadedeva","Ribadesella","Ribera de Arriba","Riosa","Salas","San Martín del Rey Aurelio","San Martín de Oscos","Santa Eulalia de Oscos","Santo Adriano","Sariego","Siero","Sobrescobio","Somiedo","Soto del Barco","Tapia de Casariego","Taramundi","Teverga","Tineo","Valdés","Vegadeo","Villanueva de Oscos","Villaviciosa","Villayón","Yernes y Tameza"];

/* ===== Config (por defecto si falta) ===== */
function CFG(){
  var c=Store.cfg||{}, d={};
  d.itp_pct=Number(c.itp_pct!=null?c.itp_pct:8);
  d.notaria_eur=Number(c.notaria_eur!=null?c.notaria_eur:1500);
  d.psi_eur=Number(c.psi_eur!=null?c.psi_eur:4235);
  d.hogar_pct=Number(c.hogar_pct!=null?c.hogar_pct:3.5);
  d.impago_pct_trad=Number(c.impago_pct_trad!=null?c.impago_pct_trad:0);
  d.impago_pct_rooms=Number(c.impago_pct_rooms!=null?c.impago_pct_rooms:4);
  d.gestion_pct_trad=Number(c.gestion_pct_trad!=null?c.gestion_pct_trad:15);
  d.gestion_pct_rooms=Number(c.gestion_pct_rooms!=null?c.gestion_pct_rooms:25);
  d.obj_bruta_trad=Number(c.obj_bruta_trad!=null?c.obj_bruta_trad:10);
  d.obj_bruta_rooms=Number(c.obj_bruta_rooms!=null?c.obj_bruta_rooms:12);
  d.obj_neta_trad=Number(c.obj_neta_trad!=null?c.obj_neta_trad:7.5);
  d.obj_neta_rooms=Number(c.obj_neta_rooms!=null?c.obj_neta_rooms:8.5);
  return d;
}

/* ===== Estado ===== */
var currentId=null;

/* ===== Montaje ===== */
function mount(){
  // Localidades
  var sel=id('e_loc'); sel.innerHTML=LOCS.map(function(n){return '<option>'+n+'</option>';}).join('');

  // Formato dinero en inputs
  document.querySelectorAll('input[data-money]').forEach(function(inp){
    inp.addEventListener('input',function(){ var dig=(inp.value||'').replace(/[^\d]/g,''); inp.value=dig? n0(dig):''; });
    inp.addEventListener('blur', function(){ setMoney(inp, parseEs(inp.value)); });
  });

  // Eventos
  id('e_precio').addEventListener('input', autoAdquisicion);
  id('e_tipo').addEventListener('change', function(){ autoMantenimiento(); recalcPmax(); });
  id('e_alq').addEventListener('input', function(){ autoMantenimiento(); recalcPmax(); });
  id('e_reforma').addEventListener('input', recalcPmax);
  id('e_incluir_psi').addEventListener('change', recalcPmax);

  id('e_calc').addEventListener('click', calcular);
  id('e_clean').addEventListener('click', limpiar);
  id('save_only').addEventListener('click', guardar);
  id('save_assign').addEventListener('click', guardarYAsignar);

  preloadFromEvaluaciones();
  autoAdquisicion();
}

/* ===== Auto ITP/Notaría ===== */
function autoAdquisicion(){
  var cfg=CFG(); var precio=parseEs(id('e_precio').value);
  setMoney(id('e_itp_eur'), Math.round(precio*(cfg.itp_pct/100)));
  setMoney(id('e_notaria'), cfg.notaria_eur);
  recalcPmax();
}

/* ===== Auto mantenimiento ===== */
function autoMantenimiento(){
  var cfg=CFG(), tipo=id('e_tipo').value;
  var anual=parseEs(id('e_alq').value)*12;

  setMoney(id('e_hogar'),  Math.round(anual*(cfg.hogar_pct/100)));
  setMoney(id('e_impago'), Math.round(anual*(((tipo==='Tradicional')?cfg.impago_pct_trad:cfg.impago_pct_rooms)/100)));
  setMoney(id('e_gestion'),Math.round(anual*(((tipo==='Tradicional')?cfg.gestion_pct_trad:cfg.gestion_pct_rooms)/100)));
}

/* ===== Precio máx (cumplir BRUTA) ===== */
function recalcPmax(){
  var cfg=CFG(), tipo=id('e_tipo').value;
  var goal=((tipo==='Tradicional')?cfg.obj_bruta_trad:cfg.obj_bruta_rooms)/100;
  if(!goal){ setMoney(id('e_pmax'),0); id('r_pmax').textContent='—'; return; }

  var anual=parseEs(id('e_alq').value)*12;
  var notaria=parseEs(id('e_notaria').value)||cfg.notaria_eur;
  var reforma=parseEs(id('e_reforma').value);
  var psi=(id('e_incluir_psi').value==='si')? cfg.psi_eur : 0;
  var itpR=cfg.itp_pct/100;

  // pmax = (anual/goal - (notaria+reforma+psi)) / (1+itpR)
  var pmax = (anual/goal - (notaria+reforma+psi)) / (1+itpR);
  pmax = Math.max(0, Math.floor(pmax));
  setMoney(id('e_pmax'), pmax);
  var rp=id('r_pmax'); if(rp) rp.textContent=e0(pmax);
}

/* ===== Calcular KPIs ===== */
function calcular(){
  var cfg=CFG();
  var precio=parseEs(id('e_precio').value);
  var itp=parseEs(id('e_itp_eur').value)||Math.round(precio*(cfg.itp_pct/100));
  var notaria=parseEs(id('e_notaria').value)||cfg.notaria_eur;
  var reforma=parseEs(id('e_reforma').value);
  var psi=(id('e_incluir_psi').value==='si')? cfg.psi_eur : 0;

  var comunidad=parseEs(id('e_comunidad').value);
  var ibi=parseEs(id('e_ibi').value);
  var hogar=parseEs(id('e_hogar').value);
  var impago=parseEs(id('e_impago').value);
  var gestion=parseEs(id('e_gestion').value);

  var alq=parseEs(id('e_alq').value);

  var inversion=precio+itp+notaria+reforma+psi;
  var ingresoAnual=alq*12;
  var gastosAnuales=comunidad+ibi+hogar+impago+gestion;

  var bruta=inversion>0? (ingresoAnual/inversion)*100:0;
  var neta =inversion>0? ((ingresoAnual-gastosAnuales)/inversion)*100:0;
  var flujo=ingresoAnual-gastosAnuales;

  var tipo=id('e_tipo').value;
  var gB=(tipo==='Tradicional'?cfg.obj_bruta_trad:cfg.obj_bruta_rooms);
  var gN=(tipo==='Tradicional'?cfg.obj_neta_trad :cfg.obj_neta_rooms);

  id('e_result').hidden=false;
  id('r_inv').textContent=e0(inversion);
  id('r_bruta').textContent=pct(bruta);
  id('r_neta').textContent=pct(neta);
  id('r_flujo').textContent=e0(flujo);
  id('r_pmax').textContent=e0(parseEs(id('e_pmax').value));

  var diffB=bruta-gB, diffN=neta-gN;
  id('r_bruta_diff').textContent=(diffB>=0?' (+' :' (')+fmtN1.format(diffB)+' p.p.)';
  id('r_neta_diff').textContent =(diffN>=0?' (+' :' (')+fmtN1.format(diffN)+' p.p.)';

  setDot(id('sb'), dotByGoal(bruta,gB));
  setDot(id('sn'), dotByGoal(neta,gN));
  setDot(id('sf'), flujo>0?'green':'red');

  drawBrutaChart(bruta,gB);
  sugerirClientes({bruta:bruta,inversion:inversion});
}

/* ===== Gráfico simple en canvas (dos barras: Real vs Objetivo) ===== */
function drawBrutaChart(real,goal){
  var c=id('chartBruta'), ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  var W=c.width,H=c.height,pad=32,max=Math.max(20, real, goal);
  var baseY=H-pad, areaH=H-2*pad;

  // Ejes
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,baseY); ctx.lineTo(W-pad,baseY); ctx.stroke();

  // Barras
  var barW=80, gap=40, x0=pad+40;
  // Real
  var hR= (real/max)*areaH; ctx.fillStyle='#16a34a'; ctx.fillRect(x0, baseY-hR, barW, hR);
  // Objetivo
  var hG= (goal/max)*areaH; ctx.fillStyle='#94a3b8'; ctx.fillRect(x0+barW+gap, baseY-hG, barW, hG);

  // Etiquetas
  ctx.fillStyle='#0f1112'; ctx.font='12px Inter, Arial';
  ctx.fillText('Real '+fmtN1.format(real)+' %', x0, baseY-hR-6);
  ctx.fillText('Objetivo '+fmtN1.format(goal)+' %', x0+barW+gap, baseY-hG-6);
}

/* ===== Matching prospects ===== */
function sugerirClientes(args){
  var bruta=args.bruta, inversion=args.inversion;
  var cfg=CFG();
  var tipo=id('e_tipo').value;
  var loc=(id('e_loc').value||'').toLowerCase();

  var pros=Store.pros||[], html=[];
  for(var i=0;i<pros.length;i++){
    var p=pros[i];
    var okTipo = !p.pref_tipo || p.pref_tipo===tipo;
    var okLoc  = !(p.locs_text||'') || String(p.locs_text).toLowerCase().indexOf(loc)>=0;
    var goalB  = Number(p.obj_bruta||0) || (tipo==='Tradicional'?cfg.obj_bruta_trad:cfg.obj_bruta_rooms);
    var okBruta= bruta>=goalB*0.9; // tolerancia

    if(okTipo && okLoc && okBruta){
      var line=(p.nombre||'—')+' · '+(p.pref_tipo||'-')+' · '+(p.locs_text||'-')+' · Obj '+(goalB.toString().replace('.',','))+'%';
      html.push('<label style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #eef2f7"><input type="checkbox" value="'+(p.id||p.email||p.nombre)+'"> <span>'+line+'</span></label>');
    }
  }
  id('matchList').innerHTML = html.length? html.join('') : 'Sin clientes potenciales.';
}

/* ===== Guardar ===== */
function buildEvalFromUI(){
  var cfg=CFG();
  var base={
    id: currentId || genId(),
    ts: Date.now(),
    loc: id('e_loc').value, calle: id('e_calle').value, url: id('e_url').value||'',
    anio: id('e_anio').value, m2: id('e_m2').value,
    reforma_tipo: id('e_reforma_tipo').value, alt: id('e_alt').value,
    ascensor: id('e_asc').value, bajo: id('e_bajo').value,
    habs: id('e_habs').value, banos: id('e_banos').value,
    tipo: id('e_tipo').value,
    precio: parseEs(id('e_precio').value),
    itp: parseEs(id('e_itp_eur').value) || Math.round(parseEs(id('e_precio').value)*(cfg.itp_pct/100)),
    notaria: parseEs(id('e_notaria').value) || cfg.notaria_eur,
    psi_incluido: id('e_incluir_psi').value==='si',
    psi: (id('e_incluir_psi').value==='si')? cfg.psi_eur : 0,
    reforma: parseEs(id('e_reforma').value),
    comunidad: parseEs(id('e_comunidad').value),
    ibi: parseEs(id('e_ibi').value),
    hogar: parseEs(id('e_hogar').value),
    impago: parseEs(id('e_impago').value),
    gestion: parseEs(id('e_gestion').value),
    alq: parseEs(id('e_alq').value)
  };
  var ingresoAnual=base.alq*12;
  var inversion=base.precio+base.itp+base.notaria+base.reforma+base.psi;
  var gastos=base.comunidad+base.ibi+base.hogar+base.impago+base.gestion;
  var bruta=inversion>0? (ingresoAnual/inversion)*100:0;
  var neta =inversion>0? ((ingresoAnual-gastos)/inversion)*100:0;
  var flujo=ingresoAnual-gastos;
  var pmax=parseEs(id('e_pmax').value);

  return {
    id: base.id, ts: base.ts, loc: base.loc, calle: base.calle, url: base.url,
    anio: base.anio, m2: base.m2, reforma_tipo: base.reforma_tipo, alt: base.alt,
    ascensor: base.ascensor, bajo: base.bajo, habs: base.habs, banos: base.banos,
    tipo: base.tipo, precio: base.precio, itp: base.itp, notaria: base.notaria,
    psi_incluido: base.psi_incluido, psi: base.psi, reforma: base.reforma,
    comunidad: base.comunidad, ibi: base.ibi, hogar: base.hogar, impago: base.impago, gestion: base.gestion,
    alq: base.alq,
    inv_total: inversion, kpi_bruta: Number(fmtN1.format(bruta).replace(',','.')), kpi_neta: Number(fmtN1.format(neta).replace(',','.')),
    kpi_flujo: flujo, pmax: pmax, prospect_ids: []
  };
}

function guardar(){
  if(id('e_result').hidden) calcular();
  var list=Store.evals||[], ev=buildEvalFromUI();
  var idx=currentId? list.findIndex(function(x){return x.id===currentId;}): -1;
  if(idx>=0) list[idx]=ev; else list.push(ev);
  Store.evals=list;
  alert('Evaluación guardada');
}

function guardarYAsignar(){
  guardar();
  var checks=(id('matchList').querySelectorAll('input[type=checkbox]')||[]);
  var ids=[]; for(var i=0;i<checks.length;i++){ if(checks[i].checked) ids.push(checks[i].value); }
  var list=Store.evals||[];
  var idx=currentId? list.findIndex(function(x){return x.id===currentId;}): list.length-1;
  if(idx>=0){ list[idx].prospect_ids=ids; Store.evals=list; alert('Evaluación guardada y asignada'); }
}

/* ===== Precarga desde Evaluaciones ===== */
function preloadFromEvaluaciones(){
  try{
    var mem=localStorage.getItem('_load_eval_'); if(!mem) return;
    localStorage.removeItem('_load_eval_');
    var idToLoad=String(mem).replace(/"/g,'');
    var list=Store.evals||[]; var e=null;
    for(var i=0;i<list.length;i++){ if(list[i].id===idToLoad){ e=list[i]; break; } }
    if(!e) return;

    currentId=e.id;
    id('e_loc').value=e.loc||LOCS[0];
    id('e_calle').value=e.calle||'';
    id('e_url').value=e.url||'';
    id('e_anio').value=e.anio||'';
    id('e_m2').value=e.m2||'';
    id('e_reforma_tipo').value=e.reforma_tipo||'No';
    id('e_alt').value=e.alt||'';
    id('e_asc').value=e.ascensor||'Sí';
    id('e_bajo').value=e.bajo||'No';
    id('e_habs').value=e.habs||'';
    id('e_banos').value=e.banos||'';
    id('e_tipo').value=e.tipo||'Tradicional';

    setMoney(id('e_precio'),e.precio);
    setMoney(id('e_itp_eur'),e.itp);
    setMoney(id('e_notaria'),e.notaria);
    setMoney(id('e_reforma'),e.reforma);
    id('e_incluir_psi').value=e.psi_incluido?'si':'no';
    setMoney(id('e_comunidad'),e.comunidad);
    setMoney(id('e_ibi'),e.ibi);
    setMoney(id('e_hogar'),e.hogar);
    setMoney(id('e_impago'),e.impago);
    setMoney(id('e_gestion'),e.gestion);
    setMoney(id('e_alq'),e.alq);

    autoMantenimiento(); autoAdquisicion(); recalcPmax(); calcular();
  }catch(e){}
}

/* ===== Limpiar ===== */
function limpiar(){
  currentId=null;
  document.querySelectorAll('input').forEach(function(el){
    if(el.id==='e_notaria'||el.id==='e_itp_eur') return;
    el.value='';
  });
  id('e_incluir_psi').value='si';
  id('e_tipo').value='Tradicional';
  autoAdquisicion();
  id('e_result').hidden=true;
}

/* ===== Start ===== */
document.addEventListener('DOMContentLoaded', mount);
})();
</script>
</body>
</html>
