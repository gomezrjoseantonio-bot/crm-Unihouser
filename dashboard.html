<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unihouser — Dashboard CRM</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
/* Topbar */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}

/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:10px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:4px}
.kpi .row{display:flex;align-items:center;justify-content:space-between}
.kpi .big{font-weight:800;font-size:15px}

/* Board */
.board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;min-height:520px;box-shadow:var(--shadow)}
.col h3{margin:0 0 6px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;font-size:13px}
.count{font-weight:700;color:#666}

/* Filtros + crear */
.filters{display:grid;grid-template-columns:2fr 2fr 1fr 2fr 2fr auto;gap:8px;margin:0 0 10px}
.filters input,.filters select{border:1px solid var(--line);border-radius:10px;padding:7px 9px;min-height:30px;background:#fff;font-size:12px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:800;font-size:12px}
.btn.primary{background:var(--brand);color:#fff;border:none}

/* Tarjeta */
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:6px;cursor:grab;margin-bottom:8px}
.card header{display:flex;align-items:center;gap:6px}
.name{font-weight:800;font-size:13px}
.small{color:#8a8f95;font-size:11px}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 6px;display:inline-flex;align-items:center;gap:6px;font-size:11px}
.badge i{font-style:normal;opacity:.8}
.actions{margin-left:auto;display:flex;gap:6px;align-items:center}
.btn-ic{width:26px;height:26px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.btn-ic svg{width:15px;height:15px;stroke-width:2;fill:none;stroke:#555}
.btn-ic.view{border-color:var(--brand)} .btn-ic.view svg{stroke:var(--brand)}
.btn-ic.assign{border-color:var(--brand)} .btn-ic.assign svg{stroke:var(--brand)}
.btn-ic.mail{border-color:#888}.btn-ic.wh{border-color:#25d366}
.btn-ic.del{border-color:#999} .btn-ic.arch{border-color:var(--ok)}
.card.dragging{opacity:.5} .col.drop{outline:2px dashed var(--brand);outline-offset:-6px}

/* Toast */
.toast{position:fixed;top:12px;right:12px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);padding:8px 10px;border-radius:12px;display:none;z-index:100}
.toast.ok{border-color:var(--ok)} .toast.bad{border-color:var(--bad)} .toast.warn{border-color:var(--accent)}
.toast.show{display:block}

/* ===== Modales ===== */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:50}
.modal{width:980px;max-width:95vw;max-height:88vh;background:#fff;border:2px solid #fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.22);display:flex;flex-direction:column;overflow:hidden}
.modal header{padding:8px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:#fff}
.modal h4{margin:0;font-size:14px}
.modal .close{width:28px;height:28px;border-radius:999px;border:2px solid var(--brand);background:#fff;color:#fff;display:grid;place-items:center;cursor:pointer;position:relative}
.modal .close:before{content:'×';color:var(--brand);font-weight:800}
.modal .body{padding:8px 10px;display:grid;gap:6px;flex:1 1 auto;overflow:auto;background:#fff}
.block{border:1px dashed var(--line);border-radius:12px;padding:6px;background:#fff}
.block h5{margin:0 0 4px;color:#666;font-weight:700;font-size:11px;letter-spacing:.2px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.field{display:flex;flex-direction:column;gap:2px}
.field label{color:#555;font-size:11px}
.field input,.field select,.field textarea,.chips-input{border:1px solid var(--line);border-radius:10px;padding:5px 7px;min-height:24px;font-size:12px;background:#fff;color:#000}
.field textarea{resize:none}
.row2{grid-column:span 2} .row3{grid-column:span 3}
.chips{display:flex;gap:6px;flex-wrap:wrap;line-height:18px}
.chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 8px;display:inline-flex;gap:6px;align-items:center}
.chip .x{cursor:pointer;color:#999}
.chips-input{width:220px}
.modal footer{padding:8px 10px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;background:#fff}
.save{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 11px;font-weight:800;cursor:pointer;font-size:12px}

/* Modal de asignación */
.modal.small{width:820px}
.eval-list{border:1px solid var(--line);border-radius:10px;max-height:46vh;overflow:auto;padding:6px;background:#fff}
.eval-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border-bottom:1px dashed var(--line);padding:6px 2px;font-size:12px}
.eval-item:last-child{border-bottom:none}
.eval-title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.dot{width:9px;height:9px;border-radius:50%;display:inline-block}
.dot.green{background:var(--brand)} .dot.amber{background:var(--accent)} .dot.red{background:var(--bad)}
.tag{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:1px 6px;margin-left:0;font-size:11px}
.warns{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.kpiRight{display:flex;align-items:center;gap:8px}
.icon-mini{font-style:normal;opacity:.9}
.footer{margin:16px 0 14px;text-align:center;color:#888;font-size:11px}
@media (max-width:980px){.board{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}.col{min-height:unset}.filters{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo">U</div><div class="title">Unihouser — Dashboard</div></div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <!-- filtros y crear -->
    <div class="filters">
      <input id="f_name" placeholder="Nombre y apellidos"/>
      <input id="f_email" placeholder="Email"/>
      <input id="f_phone" placeholder="Móvil (+34 …)"/>
      <select id="f_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
      <input id="f_locs" placeholder="Localidades (coma)"/>
      <input id="f_pmax" placeholder="P. máx Inversión (€)"/>
      <button id="btnCreate" class="btn primary" style="grid-column:6">Crear contacto</button>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="row"><span>Prospects</span><span id="k_total" class="big">0</span></div></div>
      <div class="kpi"><div class="row"><span>En búsqueda</span><span id="k_busq" class="big">0</span></div></div>
      <div class="kpi"><div class="row"><span>Con coincidencias</span><span id="k_match" class="big">0</span></div></div>
      <div class="kpi"><div class="row"><span>Éxitos</span><span id="k_ex" class="big">0</span></div></div>
      <div class="kpi"><div class="row"><span>Tradicional</span><span id="k_trad" class="big">0</span></div></div>
      <div class="kpi"><div class="row"><span>Habitaciones</span><span id="k_hab" class="big">0</span></div></div>
    </div>

    <!-- tablero -->
    <div class="board" id="board">
      <div class="col" data-fase="CONTACTO"><h3>CONTACTO <span class="count" id="c_CONTACTO">0</span></h3><div class="dropzone"></div></div>
      <div class="col" data-fase="REUNION"><h3>REUNION <span class="count" id="c_REUNION">0</span></h3><div class="dropzone"></div></div>
      <div class="col" data-fase="BUSQUEDA"><h3>BÚSQUEDA <span class="count" id="c_BUSQUEDA">0</span></h3><div class="dropzone"></div></div>
      <div class="col" data-fase="COMPRAVENTA"><h3>COMPRAVENTA <span class="count" id="c_COMPRAVENTA">0</span></h3><div class="dropzone"></div></div>
      <div class="col" data-fase="EXITO"><h3>ÉXITO <span class="count" id="c_EXITO">0</span></h3><div class="dropzone"></div></div>
    </div>
  </div>

  <div class="footer">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div>
  <div class="toast" id="toast"></div>

  <!-- Modal ficha cliente -->
  <div class="modal-back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Ficha del cliente">
      <header>
        <h4 id="m_title">Ficha del cliente</h4>
        <button class="close" id="m_close"></button>
      </header>
      <div class="body">
        <!-- Datos personales -->
        <div class="block">
          <h5>Datos personales</h5>
          <div class="grid">
            <div class="field"><label>Nombre</label><input id="p_nombre"/></div>
            <div class="field"><label>Apellidos</label><input id="p_apellidos"/></div>
            <div class="field"><label>DNI</label><input id="p_dni"/></div>
            <div class="field"><label>Email</label><input id="p_email"/></div>
            <div class="field"><label>Móvil</label><input id="p_movil"/></div>
            <div class="field"><label>Dirección</label><input id="p_dir"/></div>
            <div class="field"><label>Código postal</label><input id="p_cp"/></div>
            <div class="field"><label>Localidad</label><input id="p_loc"/></div>
            <div class="field"><label>Fase</label>
              <select id="p_fase"><option>CONTACTO</option><option>REUNION</option><option>BUSQUEDA</option><option>COMPRAVENTA</option><option>EXITO</option></select>
            </div>
            <div class="field row3"><label>Notas</label><textarea id="p_notas" rows="2"></textarea></div>
          </div>
        </div>

        <!-- Preferencias activo -->
        <div class="block">
          <h5>Datos del activo (preferencias)</h5>
          <div class="grid">
            <div class="field row3">
              <label>Localidades (chips)</label>
              <div class="chips" id="chips_locs"></div>
              <input class="chips-input" id="add_loc" placeholder="Añadir y Enter"/>
            </div>
            <div class="field"><label>Tipo alquiler preferido</label><select id="p_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
            <div class="field"><label>Altura (1-9)</label><input id="p_altura" inputmode="numeric" placeholder="1"></div>
            <div class="field"><label>Acepta bajo</label><select id="p_bajo"><option>Sí</option><option>No</option></select></div>
            <div class="field"><label>Ascensor</label><select id="p_asc"><option>Sí</option><option>No</option></select></div>
            <div class="field"><label>Acepta reforma</label><select id="p_ref"><option>Sí</option><option>No</option></select></div>
          </div>
        </div>

        <!-- Objetivos -->
        <div class="block">
          <h5>Objetivos de la inversión</h5>
          <div class="grid5">
            <div class="field"><label>Objetivo principal</label>
              <select id="p_obj_main"><option value="bruta">Bruta</option><option value="neta">Neta</option><option value="flujo">Flujo</option></select>
            </div>
            <div class="field"><label>Bruta (%)</label><input id="p_obj_bruta" inputmode="decimal" placeholder="10"></div>
            <div class="field"><label>Neta (%)</label><input id="p_obj_neta" inputmode="decimal" placeholder="6"></div>
            <div class="field"><label>Flujo (€/mes)</label><input id="p_obj_flujo" inputmode="numeric" placeholder="0"></div>
            <div class="field"><label style="display:block">&nbsp;</label><label><input type="checkbox" id="p_inc_psi_rent"/> Incluir PSI en rentabilidad</label></div>
          </div>
        </div>

        <!-- Presupuesto -->
        <div class="block">
          <h5>Presupuesto de la inversión</h5>
          <div class="grid">
            <div class="field"><label>P. máx Inversión (€)</label><input id="p_pmax" inputmode="numeric" placeholder="100.000"></div>
            <div class="field row2"><label style="display:block">&nbsp;</label><label><input type="checkbox" id="p_inc_psi_pmax"/> Incluir PSI en presupuesto máx</label></div>
            <div class="field"><label>Coste total operación (€)</label><input id="p_coste_op" disabled/></div>
            <div class="field"><label>Valor máx de compra (€)</label><input id="p_vcompra" disabled/></div>
          </div>
        </div>

        <!-- Financiación -->
        <div class="block">
          <h5>Financiación</h5>
          <div class="grid">
            <div class="field"><label>% LTV</label><input id="p_ltv" inputmode="decimal" placeholder="80"></div>
            <div class="field"><label>Capital financiado (€)</label><input id="p_cap_fin" disabled/></div>
            <div class="field"><label>Fondos propios (€)</label><input id="p_propios" disabled/></div>
          </div>
          <small class="small">Fondos propios = (1−LTV)·ValorCompra + ITP(ValorCompra) + Notaría + PSI (PSI siempre se suma).</small>
        </div>
      </div>
      <footer>
        <button class="btn" id="m_cancel">Cancelar</button>
        <button class="save" id="m_save">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- Modal asignar activos -->
  <div class="modal-back" id="asigBack">
    <div class="modal small" role="dialog" aria-modal="true" aria-label="Asignar activos">
      <header>
        <h4>Asignar activos al cliente</h4>
        <button class="close" id="asigClose"></button>
      </header>
      <div class="body">
        <div class="eval-list" id="evalList">Cargando…</div>
      </div>
      <footer>
        <button class="btn" id="asigCancel">Cancelar</button>
        <button class="save" id="asigSave">Guardar asignación</button>
      </footer>
    </div>
  </div>

<script>
"use strict";
/* ===== Utils + store ===== */
const id=x=>document.getElementById(x);
const toast=(m,k)=>{const t=id('toast');t.textContent=m;t.className='toast '+(k||'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);};
const fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0=v=>fmtE0.format(Number(v||0));
const n0=v=>fmtN0.format(Number(v||0));
const p1=v=>fmtN1.format(Number(v||0))+' %';
const num=(s)=>Number(String(s??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const Store={
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}},
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))}
};
/* brand color */
try{const c=Store.cfg;document.documentElement.style.setProperty('--brand', c.brand_color||'#c7530c');}catch(_){}

/* ===== Chips localidades en ficha ===== */
let CHIP_LOCS=[];
const chipWrap=()=>id('chips_locs');
function paintChips(){
  chipWrap().innerHTML='';
  CHIP_LOCS.forEach(l=>{
    const sp=document.createElement('span'); sp.className='chip';
    sp.innerHTML='<span>'+esc(l)+'</span> <span class="x" data-del="'+esc(l)+'">×</span>';
    chipWrap().appendChild(sp);
  });
}
id('add_loc').addEventListener('keydown',function(e){
  if(e.key!=='Enter')return; e.preventDefault();
  const v=(e.target.value||'').trim(); if(!v) return;
  if(CHIP_LOCS.indexOf(v)===-1) CHIP_LOCS.push(v); e.target.value=''; paintChips();
});
chipWrap().addEventListener('click',function(e){
  const del=e.target.getAttribute && e.target.getAttribute('data-del'); if(!del) return;
  CHIP_LOCS=CHIP_LOCS.filter(x=>x!==del); paintChips();
});

/* ===== Datos cfg para cálculos ===== */
function cfgCalc(){
  const c=Store.cfg||{};
  const itp_raw=Number(c.itp_pct!=null?c.itp_pct:(c.itp!=null?c.itp:8));
  const itp_pct= itp_raw>1? itp_raw : itp_raw*100;
  const notaria=Number(c.notaria_eur!=null?c.notaria_eur:c.notaria!=null?c.notaria:1500)||1500;
  const psi=Number(c.psi_fee_eur!=null?c.psi_fee_eur:c.honorarios!=null?c.honorarios:4235)||4235;
  return {itp_pct,notaria,psi};
}

/* ===== Render board ===== */
function render(){
  const list=(Store.pros||[]).filter(p=>!p.archivado);
  const byFase={CONTACTO:[],REUNION:[],BUSQUEDA:[],COMPRAVENTA:[],EXITO:[]};
  list.forEach(p=>{byFase[p.fase||'CONTACTO'].push(p);});
  ['CONTACTO','REUNION','BUSQUEDA','COMPRAVENTA','EXITO'].forEach(f=>{
    const col=document.querySelector('.col[data-fase="'+f+'"] .dropzone'); col.innerHTML='';
    byFase[f].forEach(p=>col.appendChild(cardEl(p)));
    id('c_'+f).textContent=byFase[f].length;
  });
  // KPIs
  id('k_total').textContent=list.length;
  id('k_busq').textContent=byFase.BUSQUEDA.length;
  id('k_ex').textContent=byFase.EXITO.length;
  id('k_trad').textContent=list.filter(p=>(p.pref_tipo||'Tradicional')==='Tradicional').length;
  id('k_hab').textContent=list.filter(p=>(p.pref_tipo||'Tradicional')==='Habitaciones').length;
  // matches estimados (simple: prospects con obj y pmax definidos)
  id('k_match').textContent=list.filter(p=>p.obj_main && (p.obj_bruta||p.obj_neta||p.obj_flujo)).length;
}
function cardEl(p){
  const el=document.createElement('div'); el.className='card'; el.draggable=true; el.dataset.id=p.id;
  el.addEventListener('dragstart',()=>{el.classList.add('dragging');});
  el.addEventListener('dragend',()=>{el.classList.remove('dragging');});
  const name=(p.nombre||'').toUpperCase()+' '+(p.apellidos||'').toUpperCase();
  const tipo=p.pref_tipo||'Tradicional';
  const loc=(p.locs_text||'').split(',').map(s=>s.trim()).filter(Boolean)[0]||'-';
  el.innerHTML=
    '<header>'+
      '<div class="name">'+esc(name||'—')+'</div>'+
      '<div class="badges">'+
        '<span class="badge"><i>🏷</i>'+esc(tipo)+'</span>'+
        (loc?'<span class="badge"><i>📍</i>'+esc(loc)+'</span>':'')+
      '</div>'+
      '<div class="actions">'+
        '<button class="btn-ic mail" title="Email" data-act="mail">'+icon('mail')+'</button>'+
        '<button class="btn-ic wh" title="WhatsApp" data-act="wa">'+icon('wa')+'</button>'+
        (p.fase==='BUSQUEDA'?'<button class="btn-ic assign" title="Asignar activos" data-act="assign">'+icon('link')+'</button>':'')+
        '<button class="btn-ic view" title="Ver/editar" data-act="edit">'+icon('eye')+'</button>'+
        (p.fase==='EXITO'?'<button class="btn-ic arch" title="Archivar" data-act="arch">'+icon('archive')+'</button>':'')+
        '<button class="btn-ic del" title="Borrar" data-act="del">'+icon('trash')+'</button>'+
      '</div>'+
    '</header>'+
    '<div class="small">'+esc(p.email||'')+' · '+esc(p.movil||'')+'</div>';
  el.addEventListener('click',function(e){
    const b=e.target.closest('button'); if(!b){openModal(p.id); return;}
    const act=b.getAttribute('data-act');
    if(act==='edit') openModal(p.id);
    if(act==='del'){ if(confirm('¿Borrar contacto?')){ Store.pros=(Store.pros||[]).filter(x=>x.id!==p.id); render(); } }
    if(act==='arch'){ archiveProspect(p.id); }
    if(act==='assign'){ openAssign(p.id); }
    if(act==='mail'){ quickMail(p); }
    if(act==='wa'){ quickWA(p); }
  });
  return el;
}
function icon(kind){
  if(kind==='eye')return '<svg viewBox="0 0 24 24"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z"/><circle cx="12" cy="12" r="3.2"/></svg>';
  if(kind==='trash')return '<svg viewBox="0 0 24 24"><path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 7l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12"/><path d="M10 10v7M14 10v7"/></svg>';
  if(kind==='link')return '<svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7 0l2-2a5 5 0 0 0-7-7l-1 1"/><path d="M14 11a5 5 0 0 0-7 0l-2 2a5 5 0 0 0 7 7l1-1"/></svg>';
  if(kind==='mail')return '<svg viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/><path d="m4 6 8 6 8-6"/></svg>';
  if(kind==='wa')return '<svg viewBox="0 0 24 24"><path d="M5 20l1.5-4A7 7 0 1 1 20 12a7 7 0 0 1-10 6z"/></svg>';
  if(kind==='archive')return '<svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="M3 4h18v3H3z"/><path d="M9 12h6"/></svg>';
  return '';
}

/* ===== Drag & drop ===== */
document.querySelectorAll('.col').forEach(col=>{
  const dz=col.querySelector('.dropzone');
  dz.addEventListener('dragover',ev=>{ev.preventDefault();col.classList.add('drop');});
  dz.addEventListener('dragleave',()=>col.classList.remove('drop'));
  dz.addEventListener('drop',ev=>{
    ev.preventDefault(); col.classList.remove('drop');
    const dragging=document.querySelector('.card.dragging'); if(!dragging) return;
    dz.appendChild(dragging);
    const idp=dragging.dataset.id; const nueva=col.getAttribute('data-fase');
    const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i>=0){list[i].fase=nueva; Store.pros=list; render();}
  });
});

/* ===== Crear contacto rápido ===== */
id('btnCreate').onclick=function(){
  const v={
    id:'p_'+Date.now(), ts:Date.now(),
    nombre:(id('f_name').value||'').trim().split(' ')[0]||'',
    apellidos: (id('f_name').value||'').trim().split(' ').slice(1).join(' '),
    email:(id('f_email').value||'').trim(),
    movil:(id('f_phone').value||'').trim(),
    pref_tipo:id('f_tipo').value,
    locs_text:(id('f_locs').value||'').trim(),
    pmax_inv:num(id('f_pmax').value)||0,
    fase:'CONTACTO',
    obj_main:'bruta', obj_bruta:(Store.cfg?.objetivos?.tradicional?.bruta_pct)||10
  };
  const list=Store.pros||[]; list.push(v); Store.pros=list; render();
  id('f_name').value=id('f_email').value=id('f_phone').value=id('f_locs').value=id('f_pmax').value='';
  toast('Contacto creado','ok');
};

/* ===== Modal ficha ===== */
let OPEN_ID=null;
function openModal(idp){
  const list=Store.pros||[]; const p=list.find(x=>x.id===idp) || {id:'p_'+Date.now(),ts:Date.now(),fase:'CONTACTO'};
  OPEN_ID=p.id;
  id('m_title').textContent='Ficha — '+(p.nombre||'Nuevo');
  // personales
  id('p_nombre').value=p.nombre||''; id('p_apellidos').value=p.apellidos||''; id('p_dni').value=p.dni||'';
  id('p_email').value=p.email||''; id('p_movil').value=p.movil||'';
  id('p_dir').value=p.direccion||''; id('p_cp').value=p.cp||''; id('p_loc').value=p.localidad||'';
  id('p_fase').value=p.fase||'CONTACTO'; id('p_notas').value=p.notas||'';
  // preferencias
  CHIP_LOCS=(p.locs_text||'').split(',').map(s=>s.trim()).filter(Boolean); paintChips();
  id('p_tipo').value=p.pref_tipo||'Tradicional';
  id('p_altura').value=p.altura||''; id('p_bajo').value=(p.no_bajo?'No':(p.bajo||'Sí'));
  id('p_asc').value=(p.ascensor==='No'?'No':'Sí'); id('p_ref').value=(p.no_reforma?'No':(p.pref_reforma||'Sí'));
  // objetivos
  id('p_obj_main').value=p.obj_main||'bruta';
  id('p_obj_bruta').value=p.obj_bruta!=null?p.obj_bruta:''; id('p_obj_neta').value=p.obj_neta!=null?p.obj_neta:'';
  id('p_obj_flujo').value=p.obj_flujo!=null?p.obj_flujo:''; id('p_inc_psi_rent').checked=!!p.inc_psi_rent;
  // presupuesto/financiación
  id('p_pmax').value=p.pmax_inv? n0(p.pmax_inv):''; id('p_inc_psi_pmax').checked=!!p.inc_psi_pmax;
  id('p_ltv').value=p.ltv_pct!=null?p.ltv_pct:80;
  recalcFin(); // rellena coste op / vcompra / cap fin / propios
  // abrir
  id('modalBack').style.display='flex';
}
function gatherFromModal(){
  const pmax=num(id('p_pmax').value);
  const vals=calcValores(pmax, id('p_inc_psi_pmax').checked, num(id('p_ltv').value));
  return {
    id:OPEN_ID||('p_'+Date.now()), ts:Date.now(),
    // personales
    nombre:id('p_nombre').value.trim(), apellidos:id('p_apellidos').value.trim(), dni:id('p_dni').value.trim(),
    email:id('p_email').value.trim(), movil:id('p_movil').value.trim(),
    direccion:id('p_dir').value.trim(), cp:id('p_cp').value.trim(), localidad:id('p_loc').value.trim(),
    fase:id('p_fase').value, notas:id('p_notas').value,
    // pref
    locs_text:CHIP_LOCS.join(', '),
    pref_tipo:id('p_tipo').value,
    altura:id('p_altura').value.trim(),
    bajo:id('p_bajo').value, no_bajo:(id('p_bajo').value==='No'),
    ascensor:id('p_asc').value, requiere_ascensor:(id('p_asc').value==='Sí'),
    pref_reforma:(id('p_ref').value), no_reforma:(id('p_ref').value==='No'),
    // objetivos
    obj_main:id('p_obj_main').value,
    obj_bruta:num(id('p_obj_bruta').value), obj_neta:num(id('p_obj_neta').value), obj_flujo:num(id('p_obj_flujo').value),
    inc_psi_rent:id('p_inc_psi_rent').checked,
    // presupuesto / financiación
    pmax_inv:pmax, inc_psi_pmax:id('p_inc_psi_pmax').checked,
    ltv_pct:num(id('p_ltv').value),
    vcompra:vals.vcompra, coste_op:vals.coste_op, cap_fin:vals.cap_fin, propios:vals.propios
  };
}
id('m_save').onclick=function(){
  const e=gatherFromModal(); const list=Store.pros||[]; const i=list.findIndex(x=>x.id===e.id);
  if(i>=0) list[i]=e; else list.push(e); Store.pros=list; id('modalBack').style.display='none'; render(); toast('Guardado','ok');
};
id('m_cancel').onclick=id('m_close').onclick=function(){ id('modalBack').style.display='none'; };

/* ===== Cálculos presupuesto / financiación (según doc) ===== */
function calcValores(pmax, incPsiPmax, ltv){
  const {itp_pct,notaria,psi}=cfgCalc();
  const rate=itp_pct/100;
  const vcompra = Math.max(0, (pmax - notaria - (incPsiPmax?psi:0)) / (1+rate) );
  const coste_op = pmax + (incPsiPmax?0:psi);
  const cap_fin = Math.max(0, Math.min(vcompra, vcompra*(ltv/100)));
  const itp_eur = Math.round(vcompra*rate);
  const propios = Math.max(0, (vcompra - cap_fin) + itp_eur + notaria + psi);
  return {vcompra:Math.round(vcompra), coste_op:Math.round(coste_op), cap_fin:Math.round(cap_fin), propios:Math.round(propios)};
}
function recalcFin(){
  const pmax=num(id('p_pmax').value||'0');
  const vals=calcValores(pmax, id('p_inc_psi_pmax').checked, num(id('p_ltv').value||'0'));
  id('p_vcompra').value = n0(vals.vcompra);
  id('p_coste_op').value = n0(vals.coste_op);
  id('p_cap_fin').value = n0(vals.cap_fin);
  id('p_propios').value = n0(vals.propios);
}
['p_pmax','p_inc_psi_pmax','p_ltv'].forEach(k=>{
  const el=id(k);
  el.addEventListener('input',recalcFin);
  if(el.type==='checkbox') el.addEventListener('change',recalcFin);
});

/* ===== Asignación de activos ===== */
let ASIG_ID=null;
function openAssign(idp){
  ASIG_ID=idp;
  const box=id('evalList'); box.innerHTML='';
  const cl=(Store.pros||[]).find(x=>x.id===idp); if(!cl){toast('Cliente no encontrado','bad');return;}
  const evals=Store.evals||[];
  if(!evals.length){ box.textContent='No hay evaluaciones guardadas.'; }
  evals.forEach(ev=>{
    const m=matchEvalProspect(cl,ev);
    const row=document.createElement('div'); row.className='eval-item';
    const left=document.createElement('div'); left.className='eval-title';
    const dot=document.createElement('span'); dot.className='dot '+(m.ok? 'green' : (m.why==='kpi'?'amber':'red'));
    left.appendChild(dot);
    const ttl=document.createElement('div');
    ttl.innerHTML='<strong>'+esc(ev.loc||'-')+'</strong> · '+esc(ev.calle||'-')+
      ' <span class="tag">€ '+n0(ev.precio||0)+'</span>'+
      (ev.habs? ' <span class="tag"><span class="icon-mini">🛏</span> '+esc(ev.habs)+'</span>':'')+
      (ev.banos? ' <span class="tag"><span class="icon-mini">🛁</span> '+esc(ev.banos)+'</span>':'')+
      (ev.alt? ' <span class="tag"><span class="icon-mini">⬆</span> '+esc(ev.alt)+'</span>':'')+
      (String(ev.ref_tip||'no')!=='no'? ' <span class="tag"><span class="icon-mini">🛠</span> '+esc(ev.ref_tip)+'</span>':'' )+
      (ev.alq? ' <span class="tag"><span class="icon-mini">€</span> '+n0(ev.alq)+'/mes</span>':'' );
    left.appendChild(ttl);

    const warns=document.createElement('div'); warns.className='warns';
    warnBadges(cl,ev).forEach(w=>{ const b=document.createElement('span'); b.className='tag'; b.textContent=w; warns.appendChild(b);});
    left.appendChild(warns);

    const right=document.createElement('div'); right.className='kpiRight';
    right.innerHTML=
      '<span class="tag">B '+fmtN1.format(Number(ev.kpi_bruta||0))+'%</span>'+
      '<span class="tag">N '+fmtN1.format(Number(ev.kpi_neta||0))+'%</span>'+
      '<span class="tag">'+e0(ev.kpi_flujo||0)+'</span>'+
      '<button class="btn" data-act="ver">Ver</button>'+
      '<button class="btn" data-act="send">Enviar</button>'+
      '<label style="display:flex;align-items:center;gap:6px"><input type="checkbox" data-act="sel"> asignar</label>';
    row.appendChild(left); row.appendChild(right);
    row.dataset.id=ev.id;
    row.addEventListener('click',function(e){
      const btn=e.target.closest('button'); if(!btn) return;
      if(btn.dataset.act==='ver'){ localStorage.setItem('load_eval', ev.id); window.open('evaluaciones.html','_blank'); }
      if(btn.dataset.act==='send'){ openSend(ev,cl); }
    });
    box.appendChild(row);
  });

  // pre-seleccionar los ya asignados
  const clEv=(cl.eval_ids||[]);
  box.querySelectorAll('input[type=checkbox][data-act=sel]').forEach(ch=>{
    if(clEv.includes(ch.closest('.eval-item').dataset.id)) ch.checked=true;
  });

  id('asigBack').style.display='flex';
}
id('asigSave').onclick=function(){
  const box=id('evalList');
  const selected=[...box.querySelectorAll('input[type=checkbox][data-act=sel]:checked')].map(ch=>ch.closest('.eval-item').dataset.id);
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===ASIG_ID); if(i>=0){ list[i].eval_ids=selected; Store.pros=list; }
  id('asigBack').style.display='none'; toast('Asignación guardada','ok');
};
id('asigCancel').onclick=id('asigClose').onclick=function(){ id('asigBack').style.display='none'; };

/* ===== Matching / warnings (mismo criterio que Evaluaciones) ===== */
function fold(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
function isSearching(p){ return fold(p.fase||'').includes('busq'); }
function wantsNoReform(p){ const s=fold(p.pref_reforma||p.no_reforma?'no':''); return s==='no' || s.includes('no'); }
function wantsElevator(p){ const s=fold(p.ascensor||''); return s==='si'||s==='sí'||s==='true'||s==='1'; }
function wantsNoGround(p){ const b=fold(p.bajo||'si'); return b==='no'||b.includes('evitar'); }
function prospectBudget(p){ const raw=p.pmax_inv; return Number(raw||0); }
function getTargetInfo(p){
  const kind=fold(p.obj_main||''); const b=Number(p.obj_bruta||0), n=Number(p.obj_neta||0), fm=Number(p.obj_flujo||0);
  if(kind==='bruta' && b>0) return {kind:'bruta',val:b};
  if(kind==='neta' && n>0) return {kind:'neta',val:n};
  if(kind==='flujo'&& fm>0) return {kind:'flujo',val:fm*12};
  if(b>0) return {kind:'bruta',val:b}; if(n>0) return {kind:'neta',val:n}; if(fm>0) return {kind:'flujo',val:fm*12};
  return {kind:'',val:0};
}
function matchEvalProspect(p,e){
  if(!isSearching(p)) return {ok:false,why:'fase'};
  if(fold(p.pref_tipo)!==fold(e.tipo||'Tradicional')) return {ok:false,why:'tipo'};
  const locs=(p.locs_text||'').split(',').map(fold).filter(Boolean);
  if(locs.length && !locs.includes(fold(e.loc||''))) return {ok:false,why:'localidad'};
  const tgt=getTargetInfo(p); if(!tgt.val) return {ok:false,why:'objetivo'};
  const br=Number(e.kpi_bruta||0), nt=Number(e.kpi_neta||0), fl=Number(e.kpi_flujo||0);
  if(tgt.kind==='bruta' && br>=tgt.val) return {ok:true,kind:'bruta'};
  if(tgt.kind==='neta'  && nt>=tgt.val) return {ok:true,kind:'neta'};
  if(tgt.kind==='flujo' && fl>=tgt.val) return {ok:true,kind:'flujo'};
  return {ok:false,why:'kpi'};
}
function warnBadges(p,e){
  const warns=[];
  const incPsiPmax=!!p.inc_psi_pmax;
  const {itp_pct,notaria,psi}=cfgCalc(); const rate=itp_pct/100;
  const vcompra = Math.max(0, ((p.pmax_inv||0) - notaria - (incPsiPmax?psi:0))/(1+rate));
  if((e.inv_total||0) > (p.pmax_inv||0)) warns.push('Excede presupuesto');
  if((e.precio||0) > vcompra) warns.push('Precio > compra máx');
  const necesitaReforma = (e.ref_tip && e.ref_tip!=='no');
  if(necesitaReforma && wantsNoReform(p)) warns.push('Requiere reforma');
  const sinAscensor = String(e.asc||'Sí').toLowerCase()==='no';
  if(sinAscensor && wantsElevator(p)) warns.push('Sin ascensor');
  const esBajo = String(e.bajo||'No').toLowerCase().includes('sí') || String(e.bajo||'No').toLowerCase()==='si';
  if(esBajo && wantsNoGround(p)) warns.push('Bajo');
  return warns;
}

/* ===== Envío rápido (usa plantillas de Config) ===== */
function getCfgNotifs(){
  const c=Store.cfg||{}; const brand=(c.brand_name||'Unihouser'); const n=c.notifs||{};
  const subj = (n.email_subject_tpl && String(n.email_subject_tpl).trim()) ? n.email_subject_tpl : (brand+' · {loc} · {calle}');
  const body = (n.email_body_tpl && String(n.email_body_tpl).trim()) ? n.email_body_tpl :
'Hola {name},\n\nTe comparto una oportunidad en {loc} · {calle} ({tipo}).\n• Precio: {precio} · Inversión: {inv}\n• Bruta: {rb}% · Neta: {rn}% · Flujo anual: {fl}\n• P. máx orientativo: {pmax}\n{url}\n\nUn saludo,\n'+brand;
  const wa   = (n.wa_text_tpl && String(n.wa_text_tpl).trim()) ? n.wa_text_tpl :
'Hola {name}, te comparto oportunidad: {loc} · {calle} ({tipo})\nPrecio {precio} | Inv {inv}\nBruta {rb}% · Neta {rn}% · Flujo {fl}\nPmax {pmax}\n{url}';
  return {brand:brand, subjectTpl:subj, bodyTpl:body, waTpl:wa};
}
function fillTpl(tpl, e, person){
  const rb = (Math.round(Number(e.kpi_bruta||0)*10)/10).toFixed(1).replace('.',',');
  const rn = (Math.round(Number(e.kpi_neta ||0)*10)/10).toFixed(1).replace('.',',');
  return tpl
    .replace(/\{name\}/g, (person&&person.nombre)||'')
    .replace(/\{loc\}/g, e.loc||'')
    .replace(/\{calle\}/g, e.calle||'')
    .replace(/\{tipo\}/g, e.tipo||'')
    .replace(/\{precio\}/g, e0(e.precio||0))
    .replace(/\{inv\}/g, e0(e.inv_total||0))
    .replace(/\{rb\}/g, rb)
    .replace(/\{rn\}/g, rn)
    .replace(/\{fl\}/g, e0(e.kpi_flujo||0))
    .replace(/\{pmax\}/g, e0(e.pmax||0))
    .replace(/\{url\}/g, e.url||'');
}
function quickMail(p){ const s='Hola '+(p.nombre||'')+','; window.open('mailto:'+(p.email||'')+'?subject='+encodeURIComponent('Unihouser')+'&body='+encodeURIComponent(s),'_blank'); }
function quickWA(p){ const msg='Hola '+(p.nombre||'')+'!'; const n=(p.movil||'').replace(/[^\d]/g,''); window.open('https://wa.me/'+n+'?text='+encodeURIComponent(msg),'_blank'); }
function openSend(ev, person){
  const nf=getCfgNotifs();
  const subject = fillTpl(nf.subjectTpl, ev, person);
  const body    = fillTpl(nf.bodyTpl, ev, person);
  const waBody  = fillTpl(nf.waTpl, ev, person);
  if(confirm('¿Abrir email (Aceptar) o WhatsApp (Cancelar)?')){
    window.open('mailto:?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body),'_blank');
  }else{
    window.open('https://wa.me/?text='+encodeURIComponent(waBody),'_blank');
  }
}

/* ===== Archivar ===== */
function archiveProspect(idp){
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i<0)return;
  list[i].archivado=true; Store.pros=list; render(); toast('Archivado','ok');
}

/* ===== Init ===== */
render();
</script>
</body>
</html>
