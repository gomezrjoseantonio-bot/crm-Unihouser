<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unihouser — Dashboard CRM</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
/* Topbar */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}
/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}
/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:6px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:4px}
.kpi .big{font-weight:800;font-size:15px}
.kpi .lab{font-size:11px;color:#667085}
/* Toolbar local */
.toolbar{display:flex;gap:8px;justify-content:flex-end;margin:6px 0 10px}
.toolbar .btn-icon{width:28px;height:28px;border:1px solid var(--line);border-radius:999px;background:#fff;display:grid;place-items:center;cursor:pointer}
.toolbar .btn-icon svg{width:17px;height:17px}
/* Board */
.board{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;min-height:520px;box-shadow:var(--shadow)}
.col h3{margin:0 0 6px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;font-size:13px}
.count{font-weight:700;color:#666}
/* Crear contacto */
.create{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:8px;display:grid;gap:6px;margin-bottom:10px}
.create .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}
.create input{border:1px solid var(--line);border-radius:10px;padding:7px 9px;min-height:30px}
.create .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 9px;font-weight:700;cursor:pointer;font-size:12px}
/* Tarjeta */
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:6px;cursor:grab}
.card header{display:flex;align-items:center;gap:8px}
.name{font-weight:800;font-size:13px}
.meta{font-size:11px;color:#6b7280}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 7px;display:inline-flex;align-items:center;gap:6px;font-size:11px}
.actions{display:flex;gap:6px;align-items:center;margin-left:auto}
.btn-icon{width:26px;height:26px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.btn-icon svg{width:15px;height:15px;stroke-width:2;fill:none;stroke:#555}
.btn-icon.view{border-color:var(--brand)} .btn-icon.view svg{stroke:var(--brand)}
.btn-icon.del{border-color:#999} .btn-icon.del svg{stroke:#999}
.btn-icon.mail{border-color:var(--brand)} .btn-icon.mail svg{stroke:var(--brand)}
.btn-icon.wa{border-color:#25D366} .btn-icon.wa svg{stroke:#25D366}
.btn-icon.cal{border-color:#6b7280} .btn-icon.cal svg{stroke:#6b7280}
.btn-icon.arch{border-color:#6b7280} .btn-icon.arch svg{stroke:#6b7280}
.btn-icon.asig{border-color:var(--brand)} .btn-icon.asig svg{stroke:var(--brand)}
.squares{display:flex;gap:4px;margin-left:auto}
.squares i{width:9px;height:9px;border-radius:2px;border:1px solid var(--line);background:#eee;display:inline-block}
.squares i.on{background:var(--brand);border-color:var(--brand)}
.card.dragging{opacity:.5} .col.drop{outline:2px dashed var(--brand);outline-offset:-6px}
/* Toast */
.toast{position:fixed;top:12px;right:12px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);padding:8px 10px;border-radius:12px;display:none;z-index:100}
.toast.ok{border-color:var(--ok)} .toast.bad{border-color:var(--bad)} .toast.warn{border-color:var(--accent)}
.toast.show{display:block}
/* Drawer */
.overlay{position:fixed;inset:0;background:rgba(15,18,20,.28);backdrop-filter:blur(2px);display:none;z-index:80}
.overlay.open{display:block}
.drawer{position:fixed;top:0;right:-560px;height:100%;width:560px;max-width:100%;background:#fff;border-left:1px solid var(--line);box-shadow:0 10px 24px rgba(0,0,0,.25);transition:right .2s ease;z-index:90;display:flex;flex-direction:column}
.drawer.open{right:0}
.d-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
.d-body{padding:10px 12px 16px;overflow:auto;flex:1;display:grid;gap:10px}
.block{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:8px}
.block h4{margin:0 0 6px}
.row{display:grid;gap:8px}
.row.two{grid-template-columns:1fr 1fr}
.row.three{grid-template-columns:1fr 1fr 1fr}
.field{display:flex;flex-direction:column;gap:4px}
.field input,.field select,.field textarea{border:1px solid var(--line);border-radius:10px;padding:6px 8px;background:#fff;font-size:12px;color:#1a1f23}
textarea{min-height:72px;resize:vertical}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 8px;display:inline-flex;gap:6px;align-items:center;font-size:12px}
.chip .x{cursor:pointer;color:#999}
/* Seeds (sin label) */
.seed{display:flex;gap:6px;flex-wrap:wrap}
.seed .badge .lab{display:none}
/* Lista de activos */
.a-wrap{position:fixed;left:12px;right:12px;bottom:12px;z-index:85}
.a-box{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:10px}
.a-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.a-row{border:1px solid var(--line);border-radius:10px;padding:8px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:flex-start;margin-bottom:6px}
.a-head{display:flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.g{background:#16a34a}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
.a-info{font-size:12px}
.a-info .addr{font-weight:700}
.a-icons{display:flex;gap:8px;color:#555;margin-top:2px}
.a-warn{margin-top:6px}
.a-warn .badge{background:#fff7ed;border-color:#fde68a;color:#b45309}
.a-actions{display:flex;gap:6px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer;font-weight:700;font-size:12px}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
/* Mini modal picker */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,18,20,.25);z-index:120}
.modal.open{display:flex}
.modal-box{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px;min-width:280px;display:grid;gap:10px}
/* Footer */
.footer{margin:24px 0 16px;text-align:center;color:#667085;font-size:11px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo" id="logoBox">U</div><div class="title" id="brandTitle">Unihouser — Dashboard</div></div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <!-- KPIs -->
    <div id="kpis" class="kpis">
      <div class="kpi"><div class="lab">Clientes</div><div class="big" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">En Búsqueda</div><div class="big" id="k_busq">0</div></div>
      <div class="kpi"><div class="lab">Compraventa</div><div class="big" id="k_compra">0</div></div>
      <div class="kpi"><div class="lab">Éxito</div><div class="big" id="k_exito">0</div></div>
      <div class="kpi"><div class="lab">Activos asignados</div><div class="big" id="k_asig">0</div></div>
      <div class="kpi"><div class="lab">Archivados</div><div class="big" id="k_arch">0</div></div>
    </div>

    <!-- Toolbar local -->
    <div class="toolbar" id="toolbar">
      <button class="btn-icon" id="btn_arch_toggle" title="Mostrar archivados" aria-label="Mostrar archivados">
        <svg viewBox="0 0 24 24" stroke="#6b7280" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 7h18M7 7v12h10V7M7 7l2-3h6l2 3"/>
        </svg>
      </button>
      <button class="btn-icon" id="btn_export" title="Exportar CSV" aria-label="Exportar CSV">
        <svg viewBox="0 0 24 24" stroke="#6b7280" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 3v10M8 9l4 4 4-4"/><path d="M4 17h16v3H4z"/>
        </svg>
      </button>
    </div>

    <!-- Crear contacto -->
    <div class="create">
      <div class="row">
        <input id="c_nombre" placeholder="Nombre">
        <input id="c_apellidos" placeholder="Apellidos">
        <input id="c_email" placeholder="Email">
        <input id="c_movil" placeholder="Móvil">
      </div>
      <button class="btn" id="btn_create">Crear contacto</button>
      <small class="small">El resto de datos se completan en Contacto o Reunión.</small>
    </div>

    <!-- Board -->
    <div class="board" id="board"></div>
  </div>

  <div class="footer">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div>

  <div class="toast" id="toast"></div>

  <!-- Drawer -->
  <div class="overlay" id="ov"></div>
  <aside class="drawer" id="dr">
    <div class="d-head">
      <strong id="dr_title">Ficha</strong>
      <div style="display:flex;gap:6px">
        <button class="btn" id="dr_close">Cerrar</button>
      </div>
    </div>
    <div class="d-body" id="dr_body"></div>
  </aside>

  <!-- Mini modal datetime -->
  <div class="modal" id="mmodal">
    <div class="modal-box">
      <div class="row">
        <label for="mm_dt" class="small">Fecha y hora de reunión</label>
        <input type="datetime-local" id="mm_dt">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="mm_clear">Quitar</button>
        <button class="btn primary" id="mm_save">Guardar</button>
      </div>
    </div>
  </div>

<script>
(function(){
"use strict";

/* ===== Brand from cfg ===== */
try{
  const c=JSON.parse(localStorage.getItem('cfg')||'{}')||{};
  const col=c.brand_color||'#c7530c'; document.documentElement.style.setProperty('--brand', col);
  const name=c.brand_name||c.company_name||'Unihouser';
  document.getElementById('brandTitle').textContent = name+' — Dashboard';
  document.getElementById('logoBox').textContent = (name||'U').toString().trim().charAt(0).toUpperCase() || 'U';
}catch(_){}

/* ===== Utils ===== */
const id=x=>document.getElementById(x);
const toast=(m,k)=>{const t=id('toast');t.textContent=m;t.className='toast '+(k||'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500);}
const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const e0=v=>fmtE0.format(Number(v||0));
const parseNum = v=>Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
const fold = s=>(s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
const cap = s=>{s=String(s||''); return s.charAt(0).toUpperCase()+s.slice(1);};

/* ===== Store ===== */
const Store={
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}
};

/* ===== Matching thresholds & warnings policy ===== */
function thresholds(){
  const c=Store.cfg||{}; const th=(c.match&&c.match.thresholds)||{green:1,amber:0.95};
  return {g:Number(th.green||1), a:Number(th.amber||0.95), warnOnlyGreen:!!((c.match||{}).warnings_only_when_green)};
}

/* ===== Costs & helpers ===== */
function cfgCosts(){
  const c=Store.cfg||{}; const k=c.costs||{};
  let itp = Number(k.itp_pct ?? c.itp_pct ?? 0.08); // 0.08 ó 8
  if(itp>1) itp = itp/100;
  const notaria = Number(k.notaria ?? c.notaria ?? 1500);
  const psi = Number(k.honorarios ?? k.psi ?? c.honorarios ?? c.psi ?? 0);
  const reforma = Number(k.reforma ?? 0);
  return {itp, notaria, psi, reforma};
}

/* ===== Columns ===== */
const PHASES=['CONTACTO','REUNIÓN','CONTRATO','BÚSQUEDA','COMPRAVENTA','ÉXITO'];

/* ===== Archivados toggle ===== */
let SHOW_ARCH = !!JSON.parse(localStorage.getItem('show_arch')||'false');
const archBtn = id('btn_arch_toggle');
function paintArchBtn(){ archBtn.style.borderColor = SHOW_ARCH ? 'var(--brand)' : 'var(--line)'; }
archBtn.onclick = ()=>{ SHOW_ARCH=!SHOW_ARCH; localStorage.setItem('show_arch',JSON.stringify(SHOW_ARCH)); paintArchBtn(); render(); };
paintArchBtn();

/* ===== Export CSV ===== */
id('btn_export').onclick=function(){
  const list = Store.pros||[];
  const cols = [
    'id','Nombre','Apellidos','DNI','Email','Movil','Direccion','Localidad','CP','Fase','Archivado','ReunionTS',
    'Pref_Tipo','Pref_Localidades','Pref_Ascensor','Pref_Altura','Pref_Bajo','Pref_Reforma',
    'Obj_Principal','Obj_Bruta','Obj_Neta','Obj_FlujoAnual','PSI_en_Rentab',
    'Inv_Pmax','PSI_en_Pres','ITP_EUR','Notaria_EUR','PSI_EUR','ValorCompra','CTO','LTV','FondosPropios','ActivosAsignados'
  ];
  const c = cfgCosts();
  const rows = list.map(p=>{
    const pres = !!p.psi_in_presupuesto;
    const rent = !!p.psi_en_rentab;
    // recomputar V, ITP, CTO, FP para export
    const V = (Number(p.inv_pmax||0) - c.notaria - (pres?c.psi:0)) / (1+c.itp);
    const ITPe = Math.max(0, V*c.itp);
    const CTO = pres ? Number(p.inv_pmax||0) : (Number(p.inv_pmax||0)+c.psi);
    const ltv = Number(p.ltv||0);
    const capFin = V*(ltv/100);
    const fondos = (V - capFin) + ITPe + c.notaria + c.psi;

    const prefs = p.prefs||{};
    return [
      p.id, p.nombre||'', p.apellidos||'', p.dni||'', p.email||'', p.phone||p.movil||'', p.dir||'', p.city||p.localidad||'',
      p.cp||'', p.fase||'', p.archivado?1:0, p.meeting_ts||'',
      prefs.tipo||p.pref_tipo||'', (prefs.localidades||p.locs_text||''), prefs.ascensor||'', prefs.altura||'',
      (prefs.bajo||prefs.evitar_bajos||''), prefs.reforma||'',
      (p.obj_main||''), p.obj_bruta||'', p.obj_neta||'', p.obj_flujo_anual||'', rent?1:0,
      p.inv_pmax||'', pres?1:0, Math.round(ITPe), c.notaria, c.psi, Math.round(V), Math.round(CTO), p.ltv||0, Math.round(fondos),
      (p.asset_ids||[]).length
    ];
  });

  // CSV con BOM
  let csv = '\ufeff'+cols.join(',')+'\n';
  rows.forEach(r=>{
    csv += r.map(v=>{
      const s=String(v==null?'':v).replace(/"/g,'""');
      return '"'+s+'"';
    }).join(',')+'\n';
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'unihouser_clientes.csv';
  document.body.appendChild(a); a.click(); a.remove();
};

/* ===== Render board ===== */
function render(){
  const all=(Store.pros||[]);
  const pros = all.filter(p=>SHOW_ARCH || !p.archivado);
  const byPhase=PHASES.map(ph=>pros.filter(p=>p.fase===ph));

  // KPIs
  id('k_total').textContent = pros.length;
  id('k_busq').textContent  = byPhase[3].length;
  id('k_compra').textContent= byPhase[4].length;
  id('k_exito').textContent = byPhase[5].length;
  id('k_arch').textContent  = (all||[]).filter(p=>p.archivado).length;
  id('k_asig').textContent  = pros.reduce((a,p)=>a+((p.asset_ids||[]).length),0);

  const board=id('board'); board.innerHTML='';
  PHASES.forEach((ph,idx)=>{
    const col=document.createElement('div'); col.className='col'; col.dataset.phase=ph;
    col.innerHTML='<h3><span>'+ph+'</span><span class="count" id="c_'+idx+'">'+byPhase[idx].length+'</span></h3><div class="col-body"></div>';
    const body=col.querySelector('.col-body');
    byPhase[idx].forEach(p=> body.appendChild(card(p)) );
    setupDroppable(col);
    board.appendChild(col);
  });
}

/* ===== Card ===== */
function card(p){
  const d=document.createElement('div'); d.className='card'; d.draggable=true; d.dataset.id=p.id;
  const email=esc(p.email||'—'), tel=esc(p.phone||p.movil||'—');
  const sq = squares((p.asset_ids||[]).length);
  const extraBtns = [];

  if(p.fase==='CONTACTO') extraBtns.push(iconBtn('cal','Fijar reunión'));
  if(p.fase==='ÉXITO' && !p.archivado) extraBtns.push(iconBtn('arch','Archivar'));
  if(p.fase==='BÚSQUEDA') extraBtns.push(iconBtn('asig','Asignar activos'));

  d.innerHTML =
    '<header>'+
      '<div style="display:flex;flex-direction:column;gap:2px">'+
        '<div class="name">'+esc(p.nombre||'-')+' '+esc(p.apellidos||'')+'</div>'+
        '<div class="meta">'+email+' · '+tel+'</div>'+
      '</div>'+
      '<div class="actions">'+
        iconBtn('mail','Email')+iconBtn('wa','WhatsApp')+extraBtns.join('')+iconBtn('view','Abrir')+iconBtn('del','Borrar')+
      '</div>'+
    '</header>'+
    '<div class="badges seed">'+ seeds(p).map(htmlBadge).join('') +'</div>'+
    '<div class="squares" aria-label="Activos asignados">'+sq+'</div>';

  d.addEventListener('dragstart',ev=>{ d.classList.add('dragging'); ev.dataTransfer.setData('text/plain', p.id); });
  d.addEventListener('dragend',()=> d.classList.remove('dragging'));
  d.addEventListener('click',ev=>{
    const btn=ev.target.closest('button[data-act]'); if(btn) return; openDrawer(p.id);
  });
  d.querySelector('[data-act="view"]').onclick=()=>openDrawer(p.id);
  d.querySelector('[data-act="del"]').onclick=()=>delProspect(p.id);
  d.querySelector('[data-act="mail"]').onclick=()=>quickMail(p);
  d.querySelector('[data-act="wa"]').onclick=()=>quickWA(p);
  const cal=d.querySelector('[data-act="cal"]'); if(cal) cal.onclick=()=>openMeetingPicker(p.id);
  const ar=d.querySelector('[data-act="arch"]'); if(ar) ar.onclick=()=>archivarDesdeCard(p.id);
  const as=d.querySelector('[data-act="asig"]'); if(as) as.onclick=()=>openAssignBar(p.id);
  return d;
}
function squares(n){ let s=''; for(let i=0;i<n;i++) s+='<i class="on"></i>'; return s; }
function iconBtn(act,title){
  const paths={
    view:'<path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z"/><circle cx="12" cy="12" r="3.2"/>',
    del:'<path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 7l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12"/><path d="M10 10v7M14 10v7"/>',
    mail:'<path d="M3 6h18v12H3z"/><path d="m3 7 9 7 9-7"/>',
    wa:'<path d="M12 3a9 9 0 0 1 9 9c0 5-4 9-9 9a9.6 9.6 0 0 1-4-1l-4 1 1-4a9.6 9.6 0 0 1-1-4 9 9 0 0 1 9-9"/><path d="M8 9c0 4 4 6 4 6l2-1 2 2"/>',
    cal:'<path d="M7 3v4M17 3v4M3 9h18M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z"/>',
    arch:'<path d="M3 7h18M7 7v12h10V7M7 7l2-3h6l2 3"/><path d="M10 12h4"/>',
    asig:'<path d="M4 12h16M12 4v16M6 6h6M6 10h4M6 14h8M6 18h6"/>'
  };
  return '<button class="btn-icon '+act+'" data-act="'+act+'" title="'+esc(title)+'" aria-label="'+esc(title)+'">'+
    '<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">'+paths[act]+'</svg></button>';
}
function seeds(p){
  const out=[];
  const main=(fold(p.obj_main||'')||'bruta');
  if(main==='bruta' && p.obj_bruta) out.push({t:'RB',v:fmtN1.format(normPct(p.obj_bruta))+' %'});
  if(main==='neta'  && p.obj_neta ) out.push({t:'RN',v:fmtN1.format(normPct(p.obj_neta ))+' %'});
  if(main==='flujo' && (p.obj_flujo_anual)){
    out.push({t:'FL',v:e0(p.obj_flujo_anual)+' /año'});
  }
  const tipo=(p.prefs&&p.prefs.tipo)||p.pref_tipo||'Tradicional'; out.push({t:'T',v:tipo});
  const locs=((p.prefs&&p.prefs.localidades)||p.locs_text||'').toString().split(',').map(s=>s.trim()).filter(Boolean);
  if(locs.length) out.push({t:'L',v:locs.join(' · ')});
  if(p.meeting_ts){
    const d=new Date(Number(p.meeting_ts)); const dd=d.toLocaleString('es-ES',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    out.push({t:'MT',v:'Reunión: '+dd});
  }
  return out;
}
function htmlBadge(b){ return '<span class="badge"><span class="lab">'+esc(b.t)+'</span><strong>'+esc(b.v)+'</strong></span>'; }
function normPct(v){ v=Number(v||0); if(v>0 && v<=1) v=v*100; return v; }

/* ===== DnD ===== */
function setupDroppable(col){
  col.addEventListener('dragover',ev=>{ ev.preventDefault(); col.classList.add('drop'); });
  col.addEventListener('dragleave',()=> col.classList.remove('drop'));
  col.addEventListener('drop',ev=>{
    ev.preventDefault(); col.classList.remove('drop');
    const idp=ev.dataTransfer.getData('text/plain');
    moveToPhase(idp, col.dataset.phase);
  });
}
function moveToPhase(idp, phase){
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i<0) return;
  list[i].fase = phase;
  Store.pros=list; render();
}

/* ===== Crear / borrar ===== */
id('btn_create').onclick=function(){
  const nombre=(id('c_nombre').value||'').trim();
  const ap=(id('c_apellidos').value||'').trim();
  const email=(id('c_email').value||'').trim();
  const mov=(id('c_movil').value||'').trim();
  if(!nombre || !email){ toast('Nombre y email son obligatorios','warn'); return; }
  const list=Store.pros||[];
  list.push({id:'p_'+Date.now(), ts:Date.now(), nombre:nombre, apellidos:ap, email:email, phone:mov, fase:'CONTACTO',
    prefs:{tipo:'Tradicional', localidades:'' , ascensor:'Sí', altura:'', bajo:'No', reforma:'No'},
    obj_main:'bruta', obj_bruta:10, asset_ids:[]});
  Store.pros=list; id('c_nombre').value=''; id('c_apellidos').value=''; id('c_email').value=''; id('c_movil').value=''; render(); toast('Creado','ok');
};
function delProspect(idp){
  if(!confirm('¿Borrar este contacto?')) return;
  Store.pros=(Store.pros||[]).filter(p=>p.id!==idp); render(); toast('Borrado','ok');
}
function archivarDesdeCard(idp){
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i<0) return;
  list[i].archivado=true; Store.pros=list; render(); toast('Archivado','ok');
}

/* ===== Drawer ===== */
let OPEN_ID=null;
function openDrawer(idp){
  OPEN_ID=idp;
  const p=(Store.pros||[]).find(x=>x.id===idp); if(!p) return;
  const ov=id('ov'), dr=id('dr'), body=id('dr_body');
  id('dr_title').textContent = (p.nombre||'-')+' '+(p.apellidos||'');
  body.innerHTML='';
  // 1) Datos del cliente
  body.appendChild(blockDatosCliente(p));
  // 2) Preferencias del activo
  body.appendChild(blockPreferencias(p));
  // 3) Objetivos inversión
  body.appendChild(blockObjetivos(p));
  // 4) Presupuesto inversión
  body.appendChild(blockPresupuesto(p));
  // 5) Financiación
  body.appendChild(blockFinanciacion(p));
  // 6) Notas reunión
  body.appendChild(blockNotas(p));
  // Botón único Guardar
  body.appendChild(blockGuardar(p));

  ov.classList.add('open'); dr.classList.add('open');
}
function closeDrawer(){ id('ov').classList.remove('open'); id('dr').classList.remove('open'); OPEN_ID=null; }
id('ov').onclick=closeDrawer; id('dr_close').onclick=closeDrawer;

/* ========== Bloques Drawer ========== */
function inputKV(label, idd, val, ro){
  return '<div class="field"><label>'+esc(label)+'</label><input '+(ro?'readonly':'')+' id="'+idd+'" value="'+esc(val??'')+'"></div>';
}
function selectKV(label, idd, opts, val){
  return '<div class="field"><label>'+esc(label)+'</label><select id="'+idd+'">'+
    opts.map(o=>'<option '+(o===val?'selected':'')+'>'+esc(o)+'</option>').join('')+'</select></div>';
}

/* ----- 1) Datos del cliente ----- */
function blockDatosCliente(p){
  const b=document.createElement('div'); b.className='block';
  b.innerHTML =
    '<h4>Datos del cliente</h4>'+
    '<div class="row two">'+
      inputKV('Nombre','dc_nom',p.nombre)+
      inputKV('Apellidos','dc_ape',p.apellidos)+
    '</div>'+
    '<div class="row two">'+
      inputKV('DNI','dc_dni',p.dni||'')+
      inputKV('Móvil','dc_tel',p.phone||p.movil||'')+
    '</div>'+
    '<div class="row two">'+
      inputKV('Email','dc_em',p.email||'')+
      inputKV('Dirección','dc_dir',p.dir||'')+
    '</div>'+
    '<div class="row two">'+
      inputKV('Localidad','dc_city',p.city||p.localidad||'')+
      inputKV('Código postal','dc_cp',p.cp||'')+
    '</div>';
  return b;
}

/* ----- 2) Preferencias del activo ----- */
function blockPreferencias(p){
  const prefs=Object.assign({tipo:'Tradicional',localidades:'',ascensor:'Sí',altura:'',bajo:'No',reforma:'No'}, p.prefs||{});
  const b=document.createElement('div'); b.className='block';
  b.innerHTML =
    '<h4>Preferencias del activo</h4>'+
    '<div class="row two">'+
      selectKV('Tipo de alquiler','pf_tipo',['Tradicional','Habitaciones'],prefs.tipo)+
      '<div class="field"><label>Localidades (Enter para añadir)</label>'+
        '<div class="chips" id="pf_chips"></div>'+
        '<input id="pf_add" placeholder="Añadir y Enter">'+
      '</div>'+
    '</div>'+
    '<div class="row three">'+
      selectKV('Ascensor','pf_asc',['Sí','No'],prefs.ascensor)+
      inputKV('Altura (1–9)','pf_alt',prefs.altura||'')+
      selectKV('Bajo','pf_bajo',['No','Sí'],prefs.bajo)+
    '</div>'+
    '<div class="row two">'+
      selectKV('Reforma','pf_ref',['No','Sí'],prefs.reforma)+
      '<div></div>'+
    '</div>';
  const chips=b.querySelector('#pf_chips'); const add=b.querySelector('#pf_add');
  function paint(){
    const arr=(prefs.localidades||'').toString().split(',').map(s=>s.trim()).filter(Boolean);
    chips.innerHTML='';
    arr.forEach(l=>{
      const c=document.createElement('span'); c.className='chip'; c.innerHTML='<span class="t">'+esc(l)+'</span> <span class="x" data-del="'+esc(l)+'">×</span>'; chips.appendChild(c);
    });
  }
  paint();
  add.addEventListener('keydown',function(e){
    if(e.key!=='Enter') return; e.preventDefault();
    const v=(add.value||'').trim(); if(!v) return;
    let arr=(prefs.localidades||'').toString().split(',').map(s=>s.trim()).filter(Boolean);
    if(!arr.includes(v)) arr.push(v);
    if(arr.length>12){ toast('Máximo 12 localidades','warn'); return; }
    prefs.localidades=arr.join(', ');
    paint(); add.value='';
  });
  chips.addEventListener('click',function(e){
    const del=e.target.getAttribute && e.target.getAttribute('data-del'); if(!del) return;
    let arr=(prefs.localidades||'').toString().split(',').map(s=>s.trim()).filter(Boolean).filter(x=>x!==del);
    prefs.localidades=arr.join(', '); paint();
  });
  // guardado diferido (lo recoge el Guardar general)
  b.getValues = ()=>({
    prefs:{
      tipo: b.querySelector('#pf_tipo').value,
      localidades: prefs.localidades||'',
      ascensor: b.querySelector('#pf_asc').value,
      altura: b.querySelector('#pf_alt').value,
      bajo: b.querySelector('#pf_bajo').value,
      reforma: b.querySelector('#pf_ref').value
    }
  });
  return b;
}

/* ----- 3) Objetivos de la inversión ----- */
function blockObjetivos(p){
  const b=document.createElement('div'); b.className='block';
  const main = cap(p.obj_main||'Bruta');
  b.innerHTML =
    '<h4>Objetivos de la inversión</h4>'+
    '<div class="row two">'+
      selectKV('Objetivo principal','ob_main',['Bruta','Neta','Flujo'],main)+
      selectKV('Incluir PSI en rentabilidad','ob_psir',['No','Sí'], (p.psi_en_rentab?'Sí':'No'))+
    '</div>'+
    '<div class="row three">'+
      inputKV('Bruta %','ob_br', p.obj_bruta||'')+
      inputKV('Neta %','ob_ne', p.obj_neta||'')+
      inputKV('Flujo €/mes','ob_fl', (p.obj_flujo_anual? Math.round(p.obj_flujo_anual/12):''))+
    '</div>';
  b.getValues = ()=>({
    obj_main: fold(b.querySelector('#ob_main').value),
    obj_bruta: parseNum(b.querySelector('#ob_br').value),
    obj_neta: parseNum(b.querySelector('#ob_ne').value),
    obj_flujo_anual: parseNum(b.querySelector('#ob_fl').value)*12,
    psi_en_rentab: (b.querySelector('#ob_psir').value==='Sí')
  });
  return b;
}

/* ----- 4) Presupuesto de la inversión ----- */
function blockPresupuesto(p){
  const c=cfgCosts();
  const b=document.createElement('div'); b.className='block';
  b.innerHTML =
   '<h4>Presupuesto de la inversión</h4>'+
   '<div class="row two">'+
     inputKV('P. máx inversión (€)','bp_pmax', p.inv_pmax||'')+
     selectKV('Incluir PSI en presupuesto máx','bp_psipres',['No','Sí'], (p.psi_in_presupuesto?'Sí':'No'))+
   '</div>'+
   '<div class="row three">'+
     inputKV('PSI (Honorarios) · Config','bp_psi', e0(c.psi), true)+
     inputKV('Notaría (€) · Config','bp_not', e0(c.notaria), true)+
     inputKV('ITP (€) (calculado)','bp_itp', '', true)+
   '</div>'+
   '<div class="row two">'+
     inputKV('Valor máximo de compra (estimado)','bp_vmax','',true)+
     inputKV('Coste total operación','bp_cto','',true)+
   '</div>'+
   '<div class="row two">'+
     inputKV('Alquiler objetivo mensual (si objetivo BRUTA)','bp_alq','',true)+
     '<div></div>'+
   '</div>';
  function recalc(){
    const Pmax = parseNum(b.querySelector('#bp_pmax').value);
    const inclPsiPres = (b.querySelector('#bp_psipres').value==='Sí');
    const inclPsiRent = (id('dr_body').querySelector('#ob_psir')?.value==='Sí') || !!p.psi_en_rentab;

    const itp=c.itp, not=c.notaria, psi=c.psi;
    const psiTerm = inclPsiPres ? psi : 0;
    const V = (Pmax - not - psiTerm) / (1 + itp);
    const ITPe = Math.max(0, V*itp);
    const CTO = inclPsiPres ? Pmax : (Pmax + psi);

    let alq=''; const main = fold(id('dr_body').querySelector('#ob_main')?.value || p.obj_main || 'bruta');
    if(main==='bruta'){
      const br = (parseNum(id('dr_body').querySelector('#ob_br')?.value)||p.obj_bruta||0)/100;
      const den = V + ITPe + not + (inclPsiRent? psi : 0);
      alq = den>0 ? (den*br/12) : 0;
    }

    b.querySelector('#bp_vmax').value = isFinite(V)? e0(V): '—';
    b.querySelector('#bp_itp').value  = isFinite(ITPe)? e0(ITPe): '—';
    b.querySelector('#bp_cto').value  = isFinite(CTO)? e0(CTO): '—';
    b.querySelector('#bp_alq').value  = (alq!=='' && isFinite(alq))? e0(alq): '—';
  }
  b.recalc = recalc;
  setTimeout(recalc,0);
  b.addEventListener('input', (e)=>{
    if(['bp_pmax'].includes(e.target.id)) recalc();
  });
  b.querySelector('#bp_psipres').addEventListener('change', recalc);
  // valores para guardar
  b.getValues = ()=>{
    // devolver últimos cálculos numéricos también
    const Pmax = parseNum(b.querySelector('#bp_pmax').value);
    const inclPsiPres = (b.querySelector('#bp_psipres').value==='Sí');
    return { inv_pmax:Pmax, psi_in_presupuesto:inclPsiPres };
  };
  return b;
}

/* ----- 5) Financiación ----- */
function blockFinanciacion(p){
  const c=cfgCosts();
  const b=document.createElement('div'); b.className='block';
  const ltv0 = (p.ltv==null ? 0 : p.ltv);
  b.innerHTML =
   '<h4>Financiación</h4>'+
   '<div class="row two">'+
     inputKV('LTV (%)','bp_ltv', ltv0)+
     inputKV('Fondos propios (€)','bp_fp','',true)+
   '</div>';
  function recalc(){
    const Pmax = parseNum(id('dr_body').querySelector('#bp_pmax').value);
    const inclPsiPres = (id('dr_body').querySelector('#bp_psipres').value==='Sí');
    const itp=c.itp, not=c.notaria, psi=c.psi;
    const V = (Pmax - not - (inclPsiPres?psi:0)) / (1 + itp);
    const ITPe = Math.max(0, V*itp);
    const ltv = Math.max(0,Math.min(100, parseNum(b.querySelector('#bp_ltv').value)||0));
    const capFin = V*(ltv/100);
    const fondos = (V - capFin) + ITPe + not + psi; // PSI SIEMPRE cuenta en fondos
    b.querySelector('#bp_fp').value = isFinite(fondos)? e0(fondos): '—';
  }
  b.recalc = recalc;
  setTimeout(recalc,0);
  b.addEventListener('input', (e)=>{
    if(['bp_ltv'].includes(e.target.id)) recalc();
  });
  b.getValues = ()=>({ ltv: parseNum(b.querySelector('#bp_ltv').value)||0 });
  return b;
}

/* ----- 6) Notas reunión ----- */
function blockNotas(p){
  const b=document.createElement('div'); b.className='block';
  b.innerHTML = '<h4>Notas de la reunión</h4><div class="row"><div class="field"><textarea id="dc_notes" placeholder="Notas...">'+esc(p.notes||'')+'</textarea></div></div>';
  b.getValues = ()=>({ notes: b.querySelector('#dc_notes').value||'' });
  return b;
}

/* ----- Botón único Guardar ----- */
function blockGuardar(p){
  const b=document.createElement('div'); b.className='block';
  b.innerHTML = '<div class="row"><button class="btn primary" id="b_save_all">Guardar</button></div>';
  b.querySelector('#b_save_all').onclick=function(){
    const body=id('dr_body');
    const list=Store.pros||[]; const i=list.findIndex(x=>x.id===p.id); if(i<0) return;

    // 1 Datos cliente
    list[i].nombre = body.querySelector('#dc_nom').value.trim();
    list[i].apellidos = body.querySelector('#dc_ape').value.trim();
    list[i].dni = body.querySelector('#dc_dni').value.trim();
    list[i].phone = body.querySelector('#dc_tel').value.trim();
    list[i].email = body.querySelector('#dc_em').value.trim();
    list[i].dir = body.querySelector('#dc_dir').value.trim();
    list[i].city = body.querySelector('#dc_city').value.trim();
    list[i].cp = body.querySelector('#dc_cp').value.trim();

    // 2 Prefs
    const pf = (body.querySelectorAll('.block'))[1].getValues().prefs;
    list[i].prefs = Object.assign({}, list[i].prefs||{}, pf);

    // 3 Objetivos
    const ob = (body.querySelectorAll('.block'))[2].getValues();
    list[i].obj_main = ob.obj_main;
    list[i].obj_bruta = ob.obj_bruta;
    list[i].obj_neta = ob.obj_neta;
    list[i].obj_flujo_anual = ob.obj_flujo_anual;
    list[i].psi_en_rentab = ob.psi_en_rentab;

    // 4 Presupuesto
    const pr = (body.querySelectorAll('.block'))[3].getValues();
    list[i].inv_pmax = pr.inv_pmax;
    list[i].psi_in_presupuesto = pr.psi_in_presupuesto;

    // 5 Financiación
    const fi = (body.querySelectorAll('.block'))[4].getValues();
    list[i].ltv = fi.ltv;

    // 6 Notas
    const nt = (body.querySelectorAll('.block'))[5].getValues();
    list[i].notes = nt.notes;

    Store.pros=list; render(); toast('Guardado','ok'); closeDrawer();
  };
  return b;
}

/* ======= Mini picker de reunión ======= */
let MEETING_FOR=null;
function openMeetingPicker(idp){
  MEETING_FOR=idp;
  const p=(Store.pros||[]).find(x=>x.id===idp); if(!p) return;
  const m=id('mmodal'); const inp=id('mm_dt');
  inp.value = p.meeting_ts? (new Date(Number(p.meeting_ts))).toISOString().slice(0,16) : '';
  m.classList.add('open');
}
id('mm_save').onclick=function(){
  const idp=MEETING_FOR; if(!idp) return;
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i<0) return;
  const v=id('mm_dt').value;
  list[i].meeting_ts = v? (new Date(v)).getTime() : null;
  Store.pros=list; id('mmodal').classList.remove('open'); render(); toast('Reunión guardada','ok');
};
id('mm_clear').onclick=function(){
  const idp=MEETING_FOR; if(!idp) return;
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i<0) return;
  list[i].meeting_ts = null; Store.pros=list; id('mmodal').classList.remove('open'); render(); toast('Reunión quitada','ok');
};
id('mmodal').addEventListener('click',e=>{if(e.target.id==='mmodal') e.currentTarget.classList.remove('open');});

/* ===== Asignación (barra flotante) ===== */
function openAssignBar(idp){
  const p=(Store.pros||[]).find(x=>x.id===idp); if(!p) return;
  const c=thresholds();
  const evals=Store.evals||[];

  // no filtramos por localidad; mostraremos warning "Otra localidad"
  const cand = evals; 

  let wrap=document.querySelector('.a-wrap'); if(wrap) wrap.remove();
  wrap=document.createElement('div'); wrap.className='a-wrap';
  const box=document.createElement('div'); box.className='a-box';
  box.innerHTML='<div class="a-top"><strong>Asignar activos · '+esc(p.nombre||'')+' '+esc(p.apellidos||'')+'</strong><button class="btn" id="as_close">Cerrar</button></div>';
  const list=document.createElement('div'); box.appendChild(list); wrap.appendChild(box); document.body.appendChild(wrap);
  id('as_close').onclick=()=>wrap.remove();

  cand.forEach(ev=>{
    const sc = score(ev,p,c);
    const row=document.createElement('div'); row.className='a-row';
    row.innerHTML =
      '<div class="a-info">'+
        '<div class="a-head"><span class="dot '+sc.dot+'"></span><div class="addr">'+esc(ev.calle||'-')+' · '+esc(ev.loc||'')+'</div></div>'+
        '<div class="a-icons">'+
          iconMini('habs')+' '+esc(ev.habs||'—')+
          ' &nbsp;'+iconMini('banos')+' '+esc(ev.banos||'—')+
          ' &nbsp;'+iconMini('planta')+' '+esc(ev.alt||'—')+
          ' &nbsp;'+iconMini('reforma')+' '+esc(refText(ev.ref_tip))+
          ' &nbsp;'+iconMini('alq')+' '+e0(ev.alq||0)+
        '</div>'+
        (sc.warns.length?('<div class="a-warn">'+sc.warns.map(w=>'<span class="badge">! '+esc(w)+'</span>').join(' ')+'</div>'):'')+
      '</div>'+
      '<div class="a-actions">'+
        '<button class="btn" data-act="toggle" data-id="'+ev.id+'">'+( (p.asset_ids||[]).includes(ev.id)?'Quitar':'Asignar' )+'</button>'+
        '<button class="btn primary" data-act="comprar" data-id="'+ev.id+'">Comprar</button>'+
        '<button class="btn" data-act="ver" data-id="'+ev.id+'">Ver</button>'+
        '<button class="btn" data-act="wa" data-id="'+ev.id+'">WA</button>'+
        '<button class="btn" data-act="mail" data-id="'+ev.id+'">Email</button>'+
      '</div>';
    list.appendChild(row);
  });

  list.addEventListener('click',function(e){
    const b=e.target.closest('button[data-act]'); if(!b) return;
    const eid=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
    if(act==='ver'){ localStorage.setItem('load_eval', eid); window.open('evaluaciones.html','_blank'); }
    if(act==='mail'){ sendAssetMail(p, eid); }
    if(act==='wa'){ sendAssetWA(p, eid); }
    if(act==='comprar'){ aceptarActivo(p.id, eid); /* mueve a COMPRAVENTA */ wrap.remove(); }
    if(act==='toggle'){ toggleAsignacion(p.id, eid, b); }
  });
}
function toggleAsignacion(pid,eid,btn){
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===pid); if(i<0) return;
  const set=new Set(list[i].asset_ids||[]);
  if(set.has(eid)){ set.delete(eid); btn.textContent='Asignar'; } else { set.add(eid); btn.textContent='Quitar'; }
  list[i].asset_ids=Array.from(set); Store.pros=list; render();
}
function refText(x){ if(!x) return '—'; if(x==='no')return'No'; if(x==='lavado')return'Lavado'; if(x==='integral')return'Integral'; return x; }
function iconMini(kind){
  const M={
    habs:'<svg viewBox="0 0 24 24" width="14" height="14"><path d="M4 11h16M6 11V8a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v3"/></svg>',
    banos:'<svg viewBox="0 0 24 24" width="14" height="14"><path d="M5 10h14v3a5 5 0 0 1-5 5H10a5 5 0 0 1-5-5v-3z"/><path d="M7 7h10"/></svg>',
    planta:'<svg viewBox="0 0 24 24" width="14" height="14"><path d="M7 20V4h10v16M7 8h10M7 12h10M7 16h10"/></svg>',
    reforma:'<svg viewBox="0 0 24 24" width="14" height="14"><path d="M3 21h18M7 17l10-10 3 3-10 10H7v-3z"/></svg>',
    alq:'<svg viewBox="0 0 24 24" width="14" height="14"><path d="M4 7h16M4 12h16M4 17h10"/></svg>'
  };
  return '<span class="small" style="display:inline-flex;align-items:center;gap:4px">'+M[kind]+'</span>';
}

/* — Semáforos: contra objetivo principal + advertencias — */
function score(ev,p,th){
  const main=fold(p.obj_main||'bruta');
  const rb = Number(ev.kpi_bruta||0);
  const rn = Number(ev.kpi_neta||0);
  const fl = Number(ev.kpi_flujo||0);
  let asset=0, target=0;
  if(main==='bruta'){ asset=rb; target=normPct(p.obj_bruta||10); }
  if(main==='neta'){  asset=rn; target=normPct(p.obj_neta ||6 ); }
  if(main==='flujo'){ asset=fl; target=Number(p.obj_flujo_anual||0); }

  let ratio=0; if(target>0) ratio = asset/target;
  let dot='r'; if(ratio>=th.g) dot='g'; else if(ratio>=th.a) dot='y';

  const warns = [];
  // Warnings: solo presupuesto obligatorio; el resto bajo política warnOnlyGreen
  const c = cfgCosts();
  // CTO cliente
  const pres = !!p.psi_in_presupuesto;
  const V = (Number(p.inv_pmax||0) - c.notaria - (pres?c.psi:0)) / (1+c.itp);
  const CTOc = pres ? Number(p.inv_pmax||0) : (Number(p.inv_pmax||0)+c.psi);
  const ctoAsset = Number(ev.inv_total||0);
  if(ctoAsset > CTOc) warns.push('Presupuesto');

  const showOthers = (!th.warnOnlyGreen) || (th.warnOnlyGreen && dot==='g');
  if(showOthers){
    const necesitaReforma = (ev.ref_tip && ev.ref_tip!=='no');
    const sinAscensor = String(ev.asc||ev.ascensor||'Sí').toLowerCase()==='no';
    const esBajo = /^(si|sí)$/i.test(String(ev.bajo||'No')) || String(ev.bajo||'').toLowerCase()==='si';
    const pref = p.prefs||{};
    if(necesitaReforma && String((pref.reforma||'No')).toLowerCase()==='no') warns.push('Reforma');
    if(sinAscensor && String((pref.ascensor||'Sí')).toLowerCase()==='sí'){} // ok
    if(sinAscensor && String((pref.ascensor||'')).toLowerCase()==='si'){} // normalizado
    if(sinAscensor && String((pref.ascensor||'')).toLowerCase()==='no-requiere'){} // no-op
    if(sinAscensor && String((pref.ascensor||'')).toLowerCase()==='requiere') warns.push('Sin ascensor');
    if(esBajo && String((pref.bajo||pref.evitar_bajos||'No')).toLowerCase()==='si') warns.push('Bajo');
    // Otra localidad
    const locs=(pref.localidades||'').toString().split(',').map(fold).filter(Boolean);
    const isOtherLoc = locs.length && !locs.includes(fold(ev.loc||''));
    if(isOtherLoc) warns.push('Otra localidad');
  }
  return {dot:dot, warns:warns};
}

/* ===== Aceptar activo → COMPRAVENTA ===== */
function aceptarActivo(idp, eid){
  const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i<0) return;
  list[i].accepted_eval_id = eid;
  list[i].fase = 'COMPRAVENTA';
  const set=new Set(list[i].asset_ids||[]); set.add(eid); list[i].asset_ids=Array.from(set);
  Store.pros=list; render(); toast('Activo aceptado','ok'); openDrawer(idp);
}

/* ===== Enviar por correo / WA ===== */
function getCfgNotifs(){
  const c=Store.cfg||{}; const brand=(c.brand_name||'Unihouser'); const n=c.notifs||{};
  const subj = (n.email_subject_tpl && String(n.email_subject_tpl).trim()) ? n.email_subject_tpl : (brand+' · {loc} · {calle}');
  const body = (n.email_body_tpl && String(n.email_body_tpl).trim()) ? n.email_body_tpl :
'Hola {name},\n\nTe comparto una oportunidad en {loc} · {calle} ({tipo}).\n• Precio: {precio} · Inversión: {inv}\n• Bruta: {rb}% · Neta: {rn}% · Flujo anual: {fl}\n• P. máx orientativo: {pmax}\n{url}\n\nUn saludo,\n'+brand;
  const wa   = (n.wa_text_tpl && String(n.wa_text_tpl).trim()) ? n.wa_text_tpl :
'Hola {name}, te comparto oportunidad: {loc} · {calle} ({tipo})\nPrecio {precio} | Inv {inv}\nBruta {rb}% · Neta {rn}% · Flujo {fl}\nPmax {pmax}\n{url}';
  return {brand:brand, subjectTpl:subj, bodyTpl:body, waTpl:wa};
}
function fillAssetTpl(tpl, p, e){
  const rb = (Math.round(Number(e.kpi_bruta||0)*10)/10).toFixed(1).replace('.',',');
  const rn = (Math.round(Number(e.kpi_neta ||0)*10)/10).toFixed(1).replace('.',',');
  return tpl
    .replace(/\{name\}/g, (p.nombre||'').trim())
    .replace(/\{loc\}/g, e.loc||'')
    .replace(/\{calle\}/g, e.calle||'')
    .replace(/\{tipo\}/g, e.tipo||'')
    .replace(/\{precio\}/g, e0(e.precio||0))
    .replace(/\{inv\}/g, e0(e.inv_total||0))
    .replace(/\{rb\}/g, rb)
    .replace(/\{rn\}/g, rn)
    .replace(/\{fl\}/g, e0(e.kpi_flujo||0))
    .replace(/\{pmax\}/g, e0(e.pmax||0))
    .replace(/\{url\}/g, e.url||'');
}
function sendAssetMail(p, eid){
  const e=(Store.evals||[]).find(x=>x.id===eid); if(!e){toast('Activo no encontrado','warn');return;}
  const nf=getCfgNotifs();
  const subj=fillAssetTpl(nf.subjectTpl,p,e);
  const body=fillAssetTpl(nf.bodyTpl,p,e);
  const mailto='mailto:'+encodeURIComponent(p.email||'')+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body);
  window.open(mailto,'_blank');
}
function sendAssetWA(p, eid){
  const e=(Store.evals||[]).find(x=>x.id===eid); if(!e){toast('Activo no encontrado','warn');return;}
  const nf=getCfgNotifs(); const body=fillAssetTpl(nf.waTpl,p,e);
  const phone = String(p.phone||p.movil||'').replace(/[^\d]/g,'');
  const url='https://wa.me/'+(phone||'')+'?text='+encodeURIComponent(body);
  window.open(url,'_blank');
}

/* ===== Comms rápidos en tarjeta ===== */
function quickMail(p){
  const nf=getCfgNotifs();
  const subj = nf.subjectTpl.replace('{loc}','').replace('{calle}','').replace(/\s·\s$/, '').replace(/\{\w+\}/g,'');
  const body = 'Hola '+(p.nombre||'')+',\n\n';
  const mailto='mailto:'+encodeURIComponent(p.email||'')+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body);
  window.open(mailto,'_blank');
}
function quickWA(p){
  const nf=getCfgNotifs(); const body='Hola '+(p.nombre||'')+', ';
  const phone = String(p.phone||p.movil||'').replace(/[^\d]/g,'');
  const url='https://wa.me/'+(phone||'')+'?text='+encodeURIComponent(body);
  window.open(url,'_blank');
}

/* ===== Helpers ===== */
function load(){
  try{
    const c=Store.cfg||{}; if(c.brand_color) document.documentElement.style.setProperty('--brand', c.brand_color);
  }catch(_){}
  render();
}

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded',load);
})();
</script>
</body>
</html>
