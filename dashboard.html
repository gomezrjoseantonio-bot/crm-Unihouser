<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Unihouser ‚Äî Dashboard CRM</title>
<style>
  :root{
    --granate:#B53928; --terracota:#DB824B; --verde:#58736F; --gris:#DDD5D2;
    --texto:#2b2b2b; --muted:#7a6f6b; --bg:#faf8f7; --card:#fff;
    --shadow:0 8px 26px rgba(0,0,0,.08); --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--gris) 0%, var(--bg) 22%);color:var(--texto)}
  /* Topbar */
  .topbar{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);position:sticky;top:0;z-index:100}
  .container{max-width:1200px;margin:0 auto;padding:10px 16px}
  .flex{display:flex;gap:12px}
  .between{justify-content:space-between}.center{align-items:center}
  .brand{gap:10px}
  .brand img{height:28px}
  .title{font-weight:700}
  .nav a{padding:8px 10px;border-radius:10px;text-decoration:none;color:#4a3f3b}
  .nav a.active{background:rgba(181,57,40,.12);color:var(--granate)}
  /* KPIs */
  .kpis{margin:14px 16px 18px;display:grid;grid-template-columns:repeat(6,minmax(160px,1fr));gap:12px}
  .kpi{background:var(--card);border-radius:14px;padding:12px 12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:6px;min-height:68px}
  .kpi h3{font-size:12px;margin:0;font-weight:700;color:#594f4b;letter-spacing:.3px;text-transform:uppercase}
  .kpi .row{display:flex;justify-content:space-between;align-items:baseline}
  .kpi b{font-size:20px}
  .kpi .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#f1ece9}
  .kpi.ok .pill{background:rgba(88,115,111,.12);color:var(--verde)}
  .kpi.warn .pill{background:rgba(219,130,75,.12);color:var(--terracota)}
  .kpi.bad .pill{background:rgba(181,57,40,.12);color:var(--granate)}
  /* Board */
  .board{padding:0 16px 40px;display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
  .col{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);min-height:60vh;display:flex;flex-direction:column}
  .col header{padding:10px 12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .col header h2{margin:0;font-size:14px;text-transform:uppercase;letter-spacing:.6px}
  .content{padding:10px;display:flex;flex-direction:column;gap:10px}
  /* New contact */
  .new-contact{border:1px dashed #c9beb9;border-radius:12px;padding:10px;background:#fbf9f8;display:flex;flex-direction:column;gap:8px}
  input,select,textarea,button{font:inherit;border:1px solid #d8cfca;border-radius:10px;padding:8px 10px;background:#fff;color:var(--texto);outline:none}
  button{cursor:pointer;background:#f6efe9;border-color:#eadfd9}
  .primary{background:var(--verde);color:#fff;border-color:transparent}
  .ghost{background:#fff}
  .bad{background:var(--granate);color:#fff;border-color:transparent}
  .accent{background:var(--terracota);color:#fff;border-color:transparent}
  /* Card */
  .card{border:1px solid #eee3de;border-radius:14px;padding:10px;background:#fff;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:6px}
  .card .top{display:flex;justify-content:space-between;align-items:center}
  .name{font-weight:800}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:12px;background:#f3efed;border:1px solid #eadfd9;border-radius:999px;padding:3px 8px;display:inline-flex;gap:6px;align-items:center}
  .days{font-size:12px;color:#6f6460}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .iconbtn{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;border-radius:10px;border:1px solid #eadfd9;background:#fff}
  .iconbtn.small{padding:4px 6px}
  .emoji{font-size:16px;line-height:1}
  /* Toaster */
  .toaster{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:8px;z-index:400}
  .toast{background:#fff;border-left:6px solid var(--verde);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);min-width:260px}
  .toast.warn{border-left-color:var(--terracota)}
  .toast.bad{border-left-color:var(--granate)}
  .small{font-size:12px;color:var(--muted)}
  /* Modal centrado */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.2s;z-index:250}
  #overlay.open{opacity:1;pointer-events:auto}
  #modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:300;pointer-events:none}
  #modal .sheet{width:920px;max-width:96vw;background:#fff;border-radius:18px;box-shadow:0 30px 60px rgba(0,0,0,.2);transform:translateY(12px) scale(.98);opacity:0;transition:.22s;pointer-events:auto}
  #modal.open .sheet{transform:none;opacity:1}
  .sheet header{padding:12px 14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .sheet h3{margin:0}
  .sheet .body{padding:12px;display:flex;flex-direction:column;gap:10px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .grid.two{grid-template-columns:repeat(2,1fr)}
  .grid.four{grid-template-columns:repeat(4,1fr)}
  .group{border:1px solid #eee3de;border-radius:12px;padding:10px;background:#fbf9f8}
  .group h4{margin:0 0 6px 0;font-size:13px;text-transform:uppercase;letter-spacing:.4px}
  .sheet footer{padding:12px 14px;border-top:1px solid #eee;display:flex;justify-content:flex-end}
  /* Eval list */
  .eval-list{display:flex;flex-direction:column;gap:8px;border:1px solid #eee;border-radius:10px;padding:8px;background:#faf9f8;max-height:36vh;overflow:auto}
  .eval-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid #eee3de;border-radius:10px;padding:8px;background:#fff}
  .eval-title{font-weight:700}
  .match.ok{color:var(--verde)} .match.warn{color:var(--terracota)} .match.bad{color:var(--granate)}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:#f3efed;border:1px solid #eadfd9;border-radius:999px;padding:4px 8px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
  /* Drag & drop helpers */
  .col.drag-over{outline:2px dashed var(--terracota);outline-offset:-6px}
</style>
</head>
<body>
  <!-- Topbar con navegaci√≥n -->
  <header class="topbar">
    <div class="container flex between center">
      <div class="brand flex center">
        <img src="logo-unihouser.svg" alt="Unihouser" onerror="logoFallback(event)">
        <div class="title">Unihouser ‚Äî CRM & BuyBox</div>
      </div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="configuracion.html">Configuraci√≥n</a>
      </nav>
    </div>
  </header>

  <section class="kpis container" id="kpis"></section>

  <main class="board" id="board">
    <section class="col" data-phase="CONTACTO">
      <header><h2>üì• Contacto</h2><span class="small" id="count-CONTACTO"></span></header>
      <div class="content" id="col-CONTACTO">
        <div class="new-contact" id="newContactBox">
          <div class="flex">
            <input id="nc_name" placeholder="Nombre y apellidos">
          </div>
          <div class="flex">
            <input id="nc_email" placeholder="Email" type="email">
            <input id="nc_phone" placeholder="Tel√©fono">
          </div>
          <button class="primary" id="btnCreate">‚ûï Crear contacto</button>
          <p class="small">Se autocompleta un mensaje inicial (editable en la tarjeta). ‚úâÔ∏è</p>
        </div>
      </div>
    </section>
    <section class="col" data-phase="REUNION">
      <header><h2>üìÜ Reuni√≥n</h2><span class="small" id="count-REUNION"></span></header>
      <div class="content" id="col-REUNION"></div>
    </section>
    <section class="col" data-phase="CONTRATO">
      <header><h2>üñãÔ∏è Contrato</h2><span class="small" id="count-CONTRATO"></span></header>
      <div class="content" id="col-CONTRATO"></div>
    </section>
    <section class="col" data-phase="BUSQUEDA">
      <header><h2>üîé B√∫squeda</h2><span class="small" id="count-BUSQUEDA"></span></header>
      <div class="content" id="col-BUSQUEDA"></div>
    </section>
    <section class="col" data-phase="COMPRAVENTA">
      <header><h2>üèÅ Compraventa</h2><span class="small" id="count-COMPRAVENTA"></span></header>
      <div class="content" id="col-COMPRAVENTA"></div>
    </section>
  </main>

  <!-- Modal central -->
  <div id="overlay" aria-hidden="true"></div>
  <div id="modal" aria-hidden="true" role="dialog" aria-label="Ficha del cliente">
    <div class="sheet">
      <header>
        <h3 id="modalTitle">Ficha</h3>
        <button class="iconbtn" id="btnCloseModal"><span class="emoji">‚úñÔ∏è</span> Cerrar</button>
      </header>
      <div class="body" id="modalBody"></div>
      <footer>
        <button class="primary" id="modalSave">üíæ Guardar</button>
      </footer>
    </div>
  </div>

  <div class="toaster" id="toaster" aria-live="polite" aria-atomic="true"></div>

<script>
'use strict';

/* ======= CONSTS & HELPERS ======= */
const PHASES = ['CONTACTO','REUNION','CONTRATO','BUSQUEDA','COMPRAVENTA']; // sin Papelera
const ES='es-ES';
const fmtPct = new Intl.NumberFormat(ES,{style:'percent',minimumFractionDigits:0,maximumFractionDigits:0});
const eur = n => new Intl.NumberFormat(ES,{style:'currency',currency:'EUR'}).format(n||0);
const uid = p => p+'_'+Math.random().toString(36).slice(2,8);
const daysSince = ts => ts? Math.max(0, Math.floor((Date.now()-ts)/(86400000))) : 0;
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const bytes=n=> n<1024? n+' B' : n<1048576? (n/1024).toFixed(1).replace('.',',')+' KB' : (n/1048576).toFixed(1).replace('.',',')+' MB';
const escapeHtml=s=>(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

/* normaliza %: 9.8 => 0.098, 0.098 => 0.098, 98 => 0.98 */
function normPct(v){
  if(v==null||isNaN(v)) return null;
  const x = Number(v);
  if(x>1 && x<=100) return x/100;
  if(x>100) return 1;
  if(x<0) return 0;
  return x;
}

function logoFallback(e){
  e.target.onerror=null;
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='28' viewBox='0 0 120 28'>
    <rect rx='6' ry='6' width='120' height='28' fill='%23B53928'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-size='14' fill='white'>Unihouser</text>
  </svg>`;
  e.target.src='data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

function toast(msg,type='ok'){
  const t=document.createElement('div'); t.className='toast'+(type==='warn'?' warn':type==='bad'?' bad':''); t.textContent=msg;
  document.getElementById('toaster').appendChild(t);
  setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),240)},2600);
}

/* ======= STORAGE ======= */
const LS={
  getCfg(){try{return JSON.parse(localStorage.getItem('cfg')||'null')}catch(_){return null}},
  setCfg(o){localStorage.setItem('cfg',JSON.stringify(o))},
  getPros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return []}},
  setPros(a){localStorage.setItem('pros',JSON.stringify(a))},
  getEvals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return []}},
  setEvals(a){localStorage.setItem('evals',JSON.stringify(a))},
};

const DEFAULT_CFG={
  itp_pct:0.08, notaria:1200, honorarios:3630,
  messages:{ initial_subject:'Inicio ‚Äî Unihouser', initial:`Hola!

Gracias por escribirnos y por el inter√©s en lo que hacemos en Unihouser.

üè† ¬øEn qu√© podemos ayudarte?

‚úî Analizamos y filtramos oportunidades con sentido real (n√∫meros, zonas, estado).
‚úî Estimamos contigo todos los costes asociados.
‚úî Te damos una visi√≥n clara del rendimiento esperado.

üí¨ ¬øQu√© necesitamos de ti?
Presupuesto orientativo, zonas y expectativas de rentabilidad.

Gracias,
Equipo Unihouser` },
  emailTemplates:{contract:{subject:'Propuesta de Contrato ‚Äî Unihouser', body:'Hola, te adjuntamos la plantilla de contrato para revisi√≥n.\n\nGracias,\nEquipo Unihouser'}}
};

function ensureCfgShape(c){
  const x=c&&typeof c==='object'?c:{};
  x.itp_pct=typeof x.itp_pct==='number'?x.itp_pct:DEFAULT_CFG.itp_pct;
  x.notaria=typeof x.notaria==='number'?x.notaria:DEFAULT_CFG.notaria;
  x.honorarios=typeof x.honorarios==='number'?x.honorarios:DEFAULT_CFG.honorarios;
  x.messages=Object.assign({},DEFAULT_CFG.messages,x.messages||{});
  x.emailTemplates=Object.assign({},DEFAULT_CFG.emailTemplates,x.emailTemplates||{});
  return x;
}

/* ======= EVALS helpers ======= */
function evId(e){return e.id||e.ev_id||e.key||e.uuid||null}
function evEnsureId(e){if(!evId(e)) e.id='ev_'+Math.random().toString(36).slice(2,8); return evId(e)}
function evTitle(e){return e.titulo||e.title||e.nombre||e.direccion||e.direcci√≥n||e.ref||('Evaluaci√≥n '+(evId(e)||''))}
function evYieldNeta(e){
  const keys=['neta','kpi_neta','rent_neta','rentabilidad_neta','rn']; for(const k of keys){ if(typeof e[k]==='number') return normPct(e[k]) }
  if(e.kpis&&typeof e.kpis.neta==='number') return normPct(e.kpis.neta);
  return null;
}
function evYieldBruta(e){
  const keys=['bruta','kpi_bruta','rent_bruta','rentabilidad_bruta','rb']; for(const k of keys){ if(typeof e[k]==='number') return normPct(e[k]) }
  if(e.kpis&&typeof e.kpis.bruta==='number') return normPct(e.kpis.bruta);
  return null;
}

/* ======= STATE ======= */
let CFG=ensureCfgShape(LS.getCfg()); LS.setCfg(CFG);
let PROS=LS.getPros();
let EVALS=LS.getEvals();
(function ensureEvalIds(){let changed=false;for(const e of EVALS){if(!evId(e)){evEnsureId(e);changed=true}} if(changed) LS.setEvals(EVALS)})();

/* ======= RENDER ======= */
function renderAll(){ renderKPIs(); renderColumns(); }

function renderKPIs(){
  const wrap=document.getElementById('kpis'); wrap.innerHTML='';
  const counts={}; for(const ph of PHASES) counts[ph]=0;
  for(const p of PROS){ if(PHASES.includes(p.phase)) counts[p.phase]++; }
  const per=(ok,ko)=>{const tot=ok+ko; return tot?fmtPct.format(ok/tot):fmtPct.format(0);}
  // Para % OK/KO por fase, usamos history registrado
  const hist={}; for(const ph of PHASES) hist[ph]={ok:0,ko:0};
  for(const p of PROS){
    const h=p.history||{};
    for(const k in h){ if(hist[k]){ if(h[k]==='OK') hist[k].ok++; else if(h[k]==='KO') hist[k].ko++; } }
  }
  const add=(title,phase)=>{
    const card=document.createElement('div'); card.className='kpi';
    const h=hist[phase]||{ok:0,ko:0};
    card.innerHTML=`<h3>${title}</h3>
      <div class="row"><b>${per(h.ok,h.ko)}</b><span class="pill">${counts[phase]} clientes</span></div>`;
    const pct=h.ok+(h.ko)||0? h.ok/(h.ok+h.ko):0;
    if(pct>=.7) card.classList.add('ok'); else if(pct>=.4) card.classList.add('warn'); else card.classList.add('bad');
    wrap.appendChild(card);
  };
  add('Contacto','CONTACTO'); add('Reuni√≥n','REUNION'); add('Contrato','CONTRATO'); add('B√∫squeda','BUSQUEDA'); add('Compraventa','COMPRAVENTA');
}

function renderColumns(){
  for(const ph of PHASES){
    const col=document.getElementById('col-'+ph); if(!col) continue;
    const keep= ph==='CONTACTO' ? [document.getElementById('newContactBox')] : [];
    col.innerHTML=''; for(const k of keep){ if(k) col.appendChild(k) }
    // dragover highlight
    const s = document.querySelector(`section[data-phase="${ph}"]`);
    s.addEventListener('dragover', e=>{e.preventDefault(); s.classList.add('drag-over')});
    s.addEventListener('dragleave', ()=>s.classList.remove('drag-over'));
    s.addEventListener('drop', e=>{
      e.preventDefault(); s.classList.remove('drag-over');
      const id=e.dataTransfer.getData('text/plain'); const p=PROS.find(x=>x.id===id); if(!p) return;
      const from=PHASES.indexOf(p.phase), to=PHASES.indexOf(ph);
      if(Math.abs(from-to)!==1){ toast('Solo puedes mover a la fase anterior/siguiente. ‚ö†Ô∏è','warn'); return; }
      // avanzar / retroceder con traza OK solo al avanzar
      if(to>from){ p.history=p.history||{}; p.history[p.phase]='OK'; }
      p.phase=ph; p.phase_entered_at=Date.now();
      LS.setPros(PROS); renderAll(); toast(`Movido a ${ph} ‚ûú`, 'ok');
    });
  }
  // ordenar REUNION por proximidad a hoy
  const now=Date.now();
  const listReu=PROS.filter(p=>p.phase==='REUNION').sort((a,b)=>{
    const ad=a.meeting?.date? Math.abs(new Date(a.meeting.date).getTime()-now) : Number.MAX_SAFE_INTEGER;
    const bd=b.meeting?.date? Math.abs(new Date(b.meeting.date).getTime()-now) : Number.MAX_SAFE_INTEGER;
    return ad-bd;
  });
  const byPhase={}; for(const ph of PHASES) byPhase[ph]=[];
  for(const p of PROS){ byPhase[p.phase||'CONTACTO'].push(p); }
  byPhase['REUNION']=listReu;

  for(const ph of PHASES){
    const col=document.getElementById('col-'+ph);
    for(const p of byPhase[ph]){
      const card=makeCard(p); col.appendChild(card);
    }
    document.getElementById('count-'+ph).textContent = `${byPhase[ph].length} clientes`;
  }
}

function makeCard(p){
  const el=document.createElement('div'); el.className='card'; el.dataset.id=p.id; el.draggable=true;
  el.addEventListener('dragstart', e=>{e.dataTransfer.setData('text/plain', p.id)});
  const d=daysSince(p.phase_entered_at);
  const pr=p.profile||{};
  const tipo = pr.tipo || 'Tradicional';
  const objt = pr.objt ? (pr.objt==='bruta'?'Rb%':pr.objt==='neta'?'Rn%':'Flujo') : 'Obj';
  el.innerHTML=`
    <div class="top">
      <div>
        <div class="name">üë§ ${escapeHtml(p.name||'Sin nombre')}</div>
        <div class="badges">
          <span class="badge">üè∑Ô∏è ${escapeHtml(tipo)}</span>
          <span class="badge">üéØ ${escapeHtml(objt)}</span>
        </div>
      </div>
      <div class="days">‚è±Ô∏è ${d} ${d===1?'d√≠a':'d√≠as'}</div>
    </div>
    <div class="actions">
      <button class="iconbtn small" data-act="details"><span class="emoji">üëÅÔ∏è</span></button>
      <div class="iconbtn small" data-act="contact"><span class="emoji">üìû</span></div>
      <button class="iconbtn small" data-act="back"><span class="emoji">‚¨ÖÔ∏è</span></button>
      <button class="iconbtn small primary" data-act="advance"><span class="emoji">‚û°Ô∏è</span></button>
      <button class="iconbtn small bad" data-act="discard"><span class="emoji">üóëÔ∏è</span></button>
    </div>
  `;
  el.querySelector('[data-act="details"]').addEventListener('click', ()=>openModalFor(p));
  el.querySelector('[data-act="advance"]').addEventListener('click', ()=>advanceProspect(p));
  el.querySelector('[data-act="back"]').addEventListener('click', ()=>backProspect(p));
  el.querySelector('[data-act="discard"]').addEventListener('click', ()=>discardProspect(p));
  // contacto pop
  el.querySelector('[data-act="contact"]').addEventListener('click', (ev)=>openContactMenu(ev.currentTarget, p));
  return el;
}

/* ======= ACTIONS ======= */
function advanceProspect(p){
  const i=PHASES.indexOf(p.phase); if(i===PHASES.length-1){ toast('Ya est√°s en la √∫ltima fase.','warn'); return; }
  const to=PHASES[i+1]; p.history=p.history||{}; p.history[p.phase]='OK'; p.phase=to; p.phase_entered_at=Date.now();
  LS.setPros(PROS); renderAll(); toast(`‚û°Ô∏è Avanzado a ${to}`,'ok');
}
function backProspect(p){
  const i=PHASES.indexOf(p.phase); if(i<=0){ toast('No puedes retroceder m√°s.','warn'); return; }
  const to=PHASES[i-1]; p.phase=to; p.phase_entered_at=Date.now();
  LS.setPros(PROS); renderAll(); toast(`‚¨ÖÔ∏è Devuelto a ${to}`,'warn');
}
function discardProspect(p){
  if(p.phase==='CONTACTO'){
    PROS = PROS.filter(x=>x.id!==p.id);
    LS.setPros(PROS); renderAll(); toast('Prospecto descartado y eliminado. üóëÔ∏è','bad');
  }else{
    PROS = PROS.filter(x=>x.id!==p.id); // fuera de flujo tambi√©n lo quitamos (sin Papelera)
    LS.setPros(PROS); renderAll(); toast('Prospecto eliminado.','bad');
  }
}

/* ======= CONTACT MENU ======= */
function mailtoHref(p, subject, body){
  const s=encodeURIComponent(subject||CFG.messages.initial_subject||'Unihouser');
  const b=encodeURIComponent((body||'').trim());
  const to=encodeURIComponent(p.email||'');
  return `mailto:${to}?subject=${s}&body=${b}`;
}
function whatsappHref(p, body){
  const txt = encodeURIComponent((body||'').trim());
  const phone = (p.phone||'').replace(/\D/g,'');
  return `https://wa.me/${phone}?text=${txt}`;
}
function openContactMenu(anchor, p){
  // mini popover simple
  const menu=document.createElement('div');
  menu.style.position='absolute'; const r=anchor.getBoundingClientRect();
  menu.style.left=(window.scrollX+r.left)+'px'; menu.style.top=(window.scrollY+r.bottom+6)+'px';
  menu.style.background='#fff'; menu.style.border='1px solid #eadfd9'; menu.style.borderRadius='10px';
  menu.style.padding='6px'; menu.style.boxShadow='var(--shadow)'; menu.style.zIndex=500;
  menu.innerHTML=`
    <div style="display:flex;flex-direction:column;gap:6px;min-width:220px">
      <button class="iconbtn" data-a="copy">üìã Copiar mensaje inicial</button>
      <a class="iconbtn" target="_blank" data-a="email">‚úâÔ∏è Email</a>
      <a class="iconbtn" target="_blank" data-a="wa">üü¢ WhatsApp</a>
    </div>`;
  document.body.appendChild(menu);
  const msg=(p.message)||(CFG.messages.initial);
  menu.querySelector('[data-a="copy"]').addEventListener('click',()=>{const ta=document.createElement('textarea');ta.value=msg;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();toast('Mensaje copiado','ok'); menu.remove();});
  menu.querySelector('[data-a="email"]').setAttribute('href', mailtoHref(p, CFG.messages.initial_subject, msg));
  menu.querySelector('[data-a="wa"]').setAttribute('href', whatsappHref(p, msg));
  const closer=ev=>{ if(!menu.contains(ev.target) && ev.target!==anchor){ menu.remove(); document.removeEventListener('mousedown', closer);} };
  setTimeout(()=>document.addEventListener('mousedown', closer),0);
}

/* ======= MODAL (central, una hoja, un bot√≥n Guardar) ======= */
const overlay=document.getElementById('overlay');
const modal=document.getElementById('modal');
const modalBody=document.getElementById('modalBody');
const modalTitle=document.getElementById('modalTitle');
document.getElementById('btnCloseModal').addEventListener('click', closeModal);
document.getElementById('modalSave').addEventListener('click', saveModal);

let CURRENT=null;
function openModalFor(p){
  CURRENT=p;
  modalTitle.textContent = `üë§ ${p.name||'Sin nombre'} ‚Äî Detalle`;
  const pr=p.profile||(p.profile={});
  const m=p.meeting||(p.meeting={date:'',notas:''});
  modalBody.innerHTML=`
    <div class="group">
      <h4>Datos personales</h4>
      <div class="grid three">
        <div><label>Nombre</label><input id="f_name" value="${escapeHtml(p.name||'')}"></div>
        <div><label>Tel√©fono</label><input id="f_tel" value="${escapeHtml(p.phone||'')}"></div>
        <div><label>Email</label><input id="f_email" value="${escapeHtml(p.email||'')}"></div>
      </div>
      <div class="grid three">
        <div><label>DNI</label><input id="f_dni" value="${escapeHtml(pr.dni||'')}"></div>
        <div><label>Localidad</label><input id="f_locres" value="${escapeHtml(pr.locres||'')}"></div>
        <div><label>Direcci√≥n</label><input id="f_dir" value="${escapeHtml(pr.dir||'')}"></div>
      </div>
    </div>

    <div class="group">
      <h4>Inversi√≥n</h4>
      <div class="grid three">
        <div><label>Localidades objetivo</label><input id="f_locs" value="${escapeHtml(pr.locs||'')}" placeholder="Oviedo, Gij√≥n, Avil√©s"></div>
        <div><label>Tipo de alquiler</label>
          <select id="f_tipo">
            <option ${pr.tipo==='Tradicional'?'selected':''}>Tradicional</option>
            <option ${pr.tipo==='Habitaciones'?'selected':''}>Habitaciones</option>
          </select>
        </div>
        <div><label>N¬∫ activos</label><input id="f_nact" value="${escapeHtml(pr.nact||'')}" inputmode="numeric"></div>
      </div>
      <div class="grid three">
        <div><label>¬øAscensor?</label><select id="f_asc"><option ${pr.asc!=='No'?'selected':''}>S√≠</option><option ${pr.asc==='No'?'selected':''}>No</option></select></div>
        <div><label>Altura m√°x.</label><input id="f_alt" value="${escapeHtml(pr.alt||'')}" inputmode="numeric"></div>
        <div><label>¬øBajos?</label><select id="f_bajos"><option ${pr.bajos!=='S√≠'?'selected':''}>No</option><option ${pr.bajos==='S√≠'?'selected':''}>S√≠</option></select></div>
      </div>
      <div class="grid three">
        <div><label>Acepta reforma</label>
          <select id="f_ref"><option ${pr.ref==='No'?'selected':''}>No</option><option ${pr.ref==='Lavado de cara'?'selected':''}>Lavado de cara</option><option ${pr.ref==='Integral'?'selected':''}>Integral</option></select>
        </div>
        <div><label>Presupuesto TOTAL (‚Ç¨)</label><input id="f_budget" value="${pr.budget!=null?Math.round(pr.budget):''}" inputmode="numeric"></div>
        <div><label>Precio m√°x. COMPRA</label><input id="f_pmax" value="${pr.pmax!=null?Math.round(pr.pmax):''}" disabled></div>
      </div>
    </div>

    <div class="group">
      <h4>Financiaci√≥n</h4>
      <div class="grid three">
        <div><label>Financiaci√≥n bancaria</label><select id="f_fin"><option ${pr.fin!=='No'?'selected':''}>S√≠</option><option ${pr.fin==='No'?'selected':''}>No</option></select></div>
        <div><label>¬øBroker?</label><select id="f_broker"><option ${pr.broker!=='S√≠'?'selected':''}>No</option><option ${pr.broker==='S√≠'?'selected':''}>S√≠</option></select></div>
        <div><label>% financiaci√≥n</label><input id="f_pct" value="${pr.pct!=null?String(pr.pct).replace('.',','):''}" placeholder="80,0"></div>
      </div>
      <div class="grid three">
        <div><label>Hipoteca estimada</label><input id="f_hip" value="${pr.hip!=null?Math.round(pr.hip):''}" disabled></div>
        <div><label>Fondos propios</label><input id="f_prop" value="${pr.prop!=null?Math.round(pr.prop):''}" disabled></div>
        <div></div>
      </div>
    </div>

    <div class="group">
      <h4>Objetivos</h4>
      <div class="grid three">
        <div><label>Objetivo principal</label>
          <select id="f_objt">
            <option value="bruta" ${pr.objt==='bruta'?'selected':''}>Rentabilidad bruta (%)</option>
            <option value="neta" ${pr.objt==='neta'?'selected':''}>Rentabilidad neta (%)</option>
            <option value="flujo" ${pr.objt==='flujo'?'selected':''}>Flujo de caja (‚Ç¨/mes)</option>
          </select>
        </div>
        <div><label>Valor objetivo</label><input id="f_objv" value="${pr.objv!=null?String(pr.objv).replace('.',','):''}" placeholder="7,5 o 300"></div>
        <div class="grid two">
          <input id="f_ini" placeholder="Inicio MM/AAAA" value="${escapeHtml(pr.ini||'')}">
          <input id="f_finmes" placeholder="Fin MM/AAAA" value="${escapeHtml(pr.finmes||'')}">
        </div>
      </div>
      <div class="grid two" id="row_alq" style="display:${(pr.objt||'bruta')==='bruta'?'grid':'none'}">
        <div><label>Alquiler m√°x. orientativo (‚Ç¨/mes)</label><input id="f_alq" value="${pr.alq!=null?Math.round(pr.alq):''}" disabled></div>
      </div>
    </div>

    <div class="group">
      <h4>Reuni√≥n</h4>
      <div class="grid two">
        <div><label>Fecha y hora</label><input type="datetime-local" id="f_meet" value="${m.date? toLocalDT(m.date):''}"></div>
        <div><label>Notas</label><input id="f_notas" value="${escapeHtml(m.notas||'')}" placeholder="Ej. confirmada por WhatsApp ‚úÖ"></div>
      </div>
      <p class="small">Si guardas una fecha desde Contacto, el cliente avanza autom√°ticamente a <b>Reuni√≥n</b> y se ordena por proximidad. üìÜ</p>
    </div>
  `;
  // listeners de c√°lculo
  ['f_budget','f_pct','f_fin','f_objt','f_objv'].forEach(id=>{
    document.getElementById(id).addEventListener('input', recalcDerived);
    document.getElementById(id).addEventListener('change', recalcDerived);
  });
  document.getElementById('f_ini').addEventListener('blur', autoPeriod);
  recalcDerived();
  openModal();
}
function toLocalDT(v){ const d=new Date(v); const pad=x=>String(x).padStart(2,'0'); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); }

function num(s){ if(typeof s==='number') return s; const t=(s||'').toString().replace(/\./g,'').replace(',','.'); const v=parseFloat(t); return isNaN(v)?0:v; }
function recalcDerived(){
  const budget=num(document.getElementById('f_budget').value);
  const itp=CFG.itp_pct||0, not=CFG.notaria||0, hon=CFG.honorarios||0;
  const base=budget-(not+hon); const pmax=base>0? base/(1+itp):0;
  document.getElementById('f_pmax').value = pmax?Math.round(pmax):'';
  const fin=document.getElementById('f_fin').value; const pct=num(document.getElementById('f_pct').value)/100;
  const hip = fin==='S√≠'? pmax*pct : 0;
  const costeTotal = pmax*(1+itp)+not+hon;
  const prop = costeTotal - hip;
  document.getElementById('f_hip').value = hip?Math.round(hip):'';
  document.getElementById('f_prop').value = prop?Math.round(prop):'';
  const objt=document.getElementById('f_objt').value;
  const objv=num(document.getElementById('f_objv').value);
  const row=document.getElementById('row_alq');
  if(objt==='bruta'){
    row.style.display='grid';
    const alq=(objv/100)*(budget/12);
    document.getElementById('f_alq').value = alq?Math.round(alq):'';
  }else{
    row.style.display='none';
    document.getElementById('f_alq').value='';
  }
}
function autoPeriod(){
  const ini=(document.getElementById('f_ini').value||'').trim();
  const finI=document.getElementById('f_finmes');
  if(!ini || (finI.value||'').trim()) return;
  const m=ini.split('/'); if(m.length!==2) return;
  const mm=parseInt(m[0],10)-1, yyyy=parseInt(m[1],10);
  if(isNaN(mm)||isNaN(yyyy)) return;
  const d=new Date(yyyy,mm,1); d.setMonth(d.getMonth()+5);
  finI.value=String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
}

function openModal(){ overlay.classList.add('open'); modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); overlay.setAttribute('aria-hidden','false'); }
function closeModal(){ overlay.classList.remove('open'); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); overlay.setAttribute('aria-hidden','true'); CURRENT=null; }

function saveModal(){
  if(!CURRENT) return;
  const p=CURRENT;
  const pr=p.profile||(p.profile={});
  // personales
  p.name=document.getElementById('f_name').value.trim();
  p.phone=document.getElementById('f_tel').value.trim();
  p.email=document.getElementById('f_email').value.trim();
  pr.dni=document.getElementById('f_dni').value.trim();
  pr.locres=document.getElementById('f_locres').value.trim();
  pr.dir=document.getElementById('f_dir').value.trim();
  // inversi√≥n
  pr.locs=document.getElementById('f_locs').value.trim();
  pr.tipo=document.getElementById('f_tipo').value;
  pr.nact=document.getElementById('f_nact').value.trim();
  pr.asc=document.getElementById('f_asc').value;
  pr.alt=document.getElementById('f_alt').value.trim();
  pr.bajos=document.getElementById('f_bajos').value;
  pr.ref=document.getElementById('f_ref').value;
  pr.budget=num(document.getElementById('f_budget').value);
  pr.pmax=num(document.getElementById('f_pmax').value);
  // financiaci√≥n
  pr.fin=document.getElementById('f_fin').value;
  pr.broker=document.getElementById('f_broker').value;
  pr.pct=num(document.getElementById('f_pct').value);
  pr.hip=num(document.getElementById('f_hip').value);
  pr.prop=num(document.getElementById('f_prop').value);
  // objetivos
  pr.objt=document.getElementById('f_objt').value;
  pr.objv=num(document.getElementById('f_objv').value);
  pr.ini=document.getElementById('f_ini').value.trim();
  pr.finmes=document.getElementById('f_finmes').value.trim();
  pr.alq=num(document.getElementById('f_alq').value);
  // reuni√≥n
  const dt=document.getElementById('f_meet').value; const notas=document.getElementById('f_notas').value.trim();
  p.meeting={date:dt, notas};
  // avanzar a REUNION si procede
  if(p.phase==='CONTACTO' && dt){
    p.history=p.history||{}; p.history['CONTACTO']='OK';
    p.phase='REUNION'; p.phase_entered_at=Date.now();
  }
  LS.setPros(PROS);
  renderAll();
  toast('Ficha guardada ‚úÖ','ok'); closeModal();
}

/* ======= CREACI√ìN CONTACTO ======= */
document.getElementById('btnCreate').addEventListener('click', ()=>{
  const name=(document.getElementById('nc_name').value||'').trim();
  const email=(document.getElementById('nc_email').value||'').trim();
  const phone=(document.getElementById('nc_phone').value||'').trim();
  if(!name){ toast('Pon un nombre para crear el contacto.','warn'); return; }
  const p={ id:uid('p'), name,email,phone, phase:'CONTACTO', phase_entered_at:Date.now(), history:{}, message:CFG.messages.initial, meeting:{date:'',notas:''}, profile:{}, contract:{template:null}, busqueda:{propuestas:[],adjuntos:[]}, compraventa:{financiacion:0,notaria:''}};
  PROS.push(p); LS.setPros(PROS); renderAll();
  document.getElementById('nc_name').value=''; document.getElementById('nc_email').value=''; document.getElementById('nc_phone').value='';
  toast('Contacto creado üéâ','ok');
});

/* ======= BUSQUEDA (match seg√∫n objetivo) ======= */
function renderBusquedaUI(p, root){
  const b = p.busqueda || (p.busqueda={propuestas:[], adjuntos:[]});
  root.innerHTML = `
    <div class="grid two">
      <div>
        <label>Buscar evaluaciones</label>
        <input id="b_q_${p.id}" placeholder="Filtrar por texto‚Ä¶">
      </div>
      <div>
        <label>Seleccionadas (m√°x 4)</label>
        <div id="b_chips_${p.id}" class="chips"></div>
      </div>
    </div>
    <div class="eval-list" id="b_list_${p.id}"></div>
    <div class="small">Adjuntar im√°genes / v√≠deos / PDFs (para compilar un env√≠o √∫nico).</div>
    <input type="file" id="b_files_${p.id}" multiple accept="image/*,video/*,application/pdf">
    <button class="iconbtn" id="b_merge_${p.id}">üß© Fusionar PDFs (BETA)</button>
    <a class="iconbtn" target="_blank" id="b_sendmail_${p.id}">‚úâÔ∏è Enviar Email</a>
    <a class="iconbtn" target="_blank" id="b_sendwa_${p.id}">üü¢ Enviar WhatsApp</a>
  `;
  const EVS=EVALS.map(ev=>({ _raw:ev, id:(evEnsureId(ev),evId(ev)), title:evTitle(ev), rn:evYieldNeta(ev), rb:evYieldBruta(ev) }));

  const q = document.getElementById(`b_q_${p.id}`);
  const list = document.getElementById(`b_list_${p.id}`);
  const chips = document.getElementById(`b_chips_${p.id}`);
  function objMatch(ev){
    const pr=p.profile||{}; const kind=pr.objt||'neta'; const val=pr.objv||0;
    if(kind==='neta' || kind==='bruta'){
      const k = kind==='neta'? ev.rn : ev.rb;
      if(k==null) return {ok:false, why:'sin dato', cls:'warn', txt:'‚ö™ s/d'};
      const target = normPct(val);
      const ok = (k >= target);
      return {ok, why: ok?'match':'bajo', cls: ok?'ok':'bad', txt: ( (k*100).toFixed(1).replace('.',',')+'%') };
    }else{ // flujo: no tenemos dato
      return {ok:false, why:'flujo no disponible', cls:'warn', txt:'‚ö™ s/d'};
    }
  }
  function renderChips(){
    chips.innerHTML='';
    for(const id of b.propuestas){
      const e=EVS.find(x=>x.id===id); const label=e?e.title:id;
      const span=document.createElement('span'); span.className='chip'; span.innerHTML=`${escapeHtml(label)} <button data-id="${escapeHtml(id)}">√ó</button>`;
      chips.appendChild(span);
    }
    chips.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const id=btn.getAttribute('data-id'); b.propuestas=b.propuestas.filter(x=>x!==id); LS.setPros(PROS); renderChips(); renderList(); toast('Quitado','warn'); });
    });
  }
  function renderList(){
    list.innerHTML='';
    const txt=(q.value||'').toLowerCase();
    const filtered=EVS.filter(x=>!txt||(x.title||'').toLowerCase().includes(txt));
    for(const it of filtered){
      const sel=b.propuestas.includes(it.id);
      const mt=objMatch(it);
      const row=document.createElement('div'); row.className='eval-item';
      row.innerHTML=`
        <div>
          <div class="eval-title">${escapeHtml(it.title)}</div>
          <div class="small">üéØ <span class="match ${mt.cls}">${mt.ok?'‚úÖ Match':''} ${mt.txt}</span></div>
        </div>
        <div>
          <button class="${sel?'bad':'primary'}" data-id="${escapeHtml(it.id)}">${sel?'Quitar':'A√±adir'}</button>
        </div>`;
      row.querySelector('button').addEventListener('click',()=>{
        const id=it.id;
        if(sel){ b.propuestas=b.propuestas.filter(x=>x!==id); toast('Quitado','warn'); }
        else { if(b.propuestas.length>=4){ toast('M√°ximo 4 propuestas','bad'); return;} b.propuestas.push(id); toast('A√±adido','ok'); }
        LS.setPros(PROS); renderChips(); renderList();
      });
      list.appendChild(row);
    }
  }
  function buildMessage(){
    const pr=p.profile||{};
    const lines=[`Hola ${p.name||''},`, '', `Te compartimos una selecci√≥n para ${pr.tipo||'alquiler'}:`];
    for(const id of b.propuestas){
      const e=EVS.find(x=>x.id===id);
      if(!e) continue;
      const mt=objMatch(e);
      lines.push(`‚Ä¢ ${e.title} ‚Äî ${mt.ok?'‚úÖ match':'‚ö†Ô∏è bajo objetivo'} (${mt.txt})`);
    }
    lines.push('', 'Dinos qu√© te encaja y avanzamos.'); return lines.join('\n');
  }
  document.getElementById(`b_sendmail_${p.id}`).addEventListener('click', (ev)=>{ ev.currentTarget.href = mailtoHref(p,'Selecci√≥n de oportunidades ‚Äî Unihouser', buildMessage()); });
  document.getElementById(`b_sendwa_${p.id}`).addEventListener('click', (ev)=>{ ev.currentTarget.href = whatsappHref(p, buildMessage()); });

  renderChips(); renderList();
}

/* ======= COLUMN DETAILS RENDERER ======= */
function openPhaseDetails(p){
  // reutilizamos modal para ver/editar en fases posteriores (solo lectura ligera + bot√≥n Guardar por consistencia)
  openModalFor(p);
}

/* ======= RENDER CADA COLUMNA ======= */
function phaseLabel(ph){switch(ph){case 'CONTACTO':return 'Contacto';case 'REUNION':return 'Reuni√≥n';case 'CONTRATO':return 'Contrato';case 'BUSQUEDA':return 'B√∫squeda';case 'COMPRAVENTA':return 'Compraventa';default:return ph}}

function renderColumnExtras(){
  // Inserta UIs especiales dentro de tarjetas si abrimos detalles: usamos modal, as√≠ que nada extra aqu√≠.
}

/* ======= INIT ======= */
document.addEventListener('DOMContentLoaded', ()=>{
  renderAll();
  // Dentro de BUSQUEDA, cuando pulsamos üëÅÔ∏è abrimos modal, y si queremos UI de propuestas, la pintamos en BUSQUEDA al abrir detalles:
  // (sobreescribimos openModalFor para fases distintas si quieres; de momento la ficha √∫nica cubre todas las fases)
});

/* ======= UTIL ======= */
function openDrawerFor(p){ openPhaseDetails(p); } // compat con c√≥digo previo
</script>
</body>
</html>
