<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Unihouser ‚Äî Dashboard CRM</title>
  <style>
    /* ====== ESTILOS BASE ====== */
    body { font-family: Arial, sans-serif; margin: 0; background:#f6f6f6; }
    header { background:#ff6a3d; color:white; padding:15px; font-size:20px; }
    #kpis { display:flex; gap:20px; padding:10px; background:#fff; }
    #kpis div { background:#eee; padding:10px; border-radius:6px; }
    .kanban { display:grid; grid-template-columns: repeat(6,1fr); gap:10px; padding:10px; }
    .column { background:#fff; border-radius:6px; padding:10px; min-height:400px; }
    .column h3 { margin-top:0; text-align:center; }
    .card { background:#fefefe; border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:8px; }
    .actions button { margin-right:4px; }
    #drawer { position:fixed; right:-400px; top:0; width:400px; height:100%; background:#fff;
              border-left:1px solid #ccc; transition: right 0.3s; overflow-y:auto; padding:15px; }
    #drawer.open { right:0; }
    textarea { width:100%; height:120px; }
    #toast { position:fixed; bottom:20px; right:20px; background:#333; color:#fff; padding:10px; border-radius:6px; display:none; }
    .config { background:#fff; padding:15px; margin:10px; border-radius:6px; }
  </style>
</head>
<body>
<header>üìä Unihouser Dashboard CRM</header>
<div id="kpis"></div>

<!-- ====== KANBAN ====== -->
<div class="kanban" id="kanban">
  <div class="column" data-phase="CONTACTO"><h3>Contacto</h3></div>
  <div class="column" data-phase="REUNION"><h3>Reuni√≥n</h3></div>
  <div class="column" data-phase="CONTRATO"><h3>Contrato</h3></div>
  <div class="column" data-phase="BUSQUEDA"><h3>B√∫squeda</h3></div>
  <div class="column" data-phase="COMPRAVENTA"><h3>Compraventa</h3></div>
  <div class="column" data-phase="NOTARIA"><h3>Notar√≠a</h3></div>
</div>

<!-- ====== DRAWER ====== -->
<div id="drawer">
  <h3 id="drawerTitle"></h3>
  <div id="drawerContent"></div>
  <button onclick="closeDrawer()">Cerrar</button>
</div>

<!-- ====== CONFIGURACI√ìN MENSAJES ====== -->
<div class="config">
  <h3>‚öôÔ∏è Configuraci√≥n de mensajes</h3>
  <label>Mensaje primer contacto:</label>
  <textarea id="msg_contacto"></textarea><br><br>
  <label>Mensaje reuni√≥n:</label>
  <textarea id="msg_reunion"></textarea><br><br>
  <label>Mensaje contrato:</label>
  <textarea id="msg_contrato"></textarea><br><br>
  <button onclick="saveConfig()">Guardar configuraci√≥n</button>
</div>

<div id="toast"></div>

<!-- ====== SCRIPTS ====== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
<script>
/* ====== DATA Y LOCALSTORAGE ====== */
let data = JSON.parse(localStorage.getItem("crmData")) || {
  contactos: [
    {id:1, nombre:"Laura Fern√°ndez", fase:"CONTACTO", entered_at:Date.now()},
    {id:2, nombre:"Carlos P√©rez", fase:"REUNION", entered_at:Date.now(), reunion:{fecha:"2025-08-25", notas:"Quiere inversi√≥n en Oviedo"}},
    {id:3, nombre:"Mar√≠a L√≥pez", fase:"CONTRATO", entered_at:Date.now(), contrato:{enviado:true}}
  ],
  mensajes: JSON.parse(localStorage.getItem("crmMsgs")) || {
    contacto: `Hola Sergio!

Gracias por escribirme y por el inter√©s en lo que hacemos desde Unihouser 

Cada inversor es distinto ‚Äîalgunos busc√°is dar vuestro primer paso, otros ya ten√©is experiencia o hab√©is trabajado con Personal Shoppers‚Äî as√≠ que prefiero contarte de forma clara c√≥mo trabajo y qu√© puedo aportar, para que t√∫ decidas si tiene sentido avanzar juntos.

üè† ¬øEn qu√© puedo ayudarte?
‚úîÔ∏è Analizo y filtro oportunidades con sentido real, mirando n√∫meros, zonas y estado del inmueble.
‚úîÔ∏è Estimo contigo todos los costes asociados: compra, reforma, gesti√≥n, posibles imprevistos.
‚úîÔ∏è Te doy una visi√≥n clara del rendimiento esperado.

üí¨ ¬øQu√© necesito de ti?
Solo que tengas ganas de avanzar si aparece la oportunidad adecuada.

‚ú® ¬øTe apetece que sigamos hablando?
Dime cu√°nto quieres invertir, qu√© tipo de inmueble y el modelo (habitaciones/tradicional/mixto).

Gracias por tu inter√©s,
Jose Antonio ‚Äì Unihouser`,
    reunion: "Hola {{NOMBRE}}, gracias por la reuni√≥n del {{FECHA}}. Resumen: {{NOTAS}}.",
    contrato: "Hola {{NOMBRE}}, te env√≠o el contrato de servicios Unihouser. Av√≠same cuando lo revises."
  }
};

/* ====== RENDER KANBAN ====== */
function render(){
  document.querySelectorAll(".column").forEach(c=>c.innerHTML="<h3>"+c.dataset.phase+"</h3>");
  data.contactos.forEach(p=>{
    const col=document.querySelector(`.column[data-phase='${p.fase}']`);
    if(!col) return;
    const card=document.createElement("div"); card.className="card";
    let days=Math.floor((Date.now()-p.entered_at)/(1000*60*60*24));
    card.innerHTML=`<b>${p.nombre}</b><br>D+${days}
      <div class="actions">
        <button onclick="advance(${p.id})">üü¢</button>
        <button onclick="discard(${p.id})">üî¥</button>
        <button onclick="openDrawer(${p.id})">Abrir</button>
      </div>`;
    col.appendChild(card);
  });
  updateKpis();
}
function updateKpis(){
  let tot=data.contactos.length;
  let ok=data.contactos.filter(c=>c.fase=="NOTARIA").length;
  let ko=0; // simplificado
  document.getElementById("kpis").innerHTML=`<div>Total: ${tot}</div><div>OK: ${ok}</div><div>KO: ${ko}</div>`;
}

/* ====== ACCIONES ====== */
function advance(id){
  let order=["CONTACTO","REUNION","CONTRATO","BUSQUEDA","COMPRAVENTA","NOTARIA"];
  let p=data.contactos.find(c=>c.id==id);
  let idx=order.indexOf(p.fase);
  if(idx<order.length-1){ p.fase=order[idx+1]; p.entered_at=Date.now(); }
  save(); render();
}
function discard(id){ data.contactos=data.contactos.filter(c=>c.id!=id); save(); render(); }

/* ====== DRAWER ====== */
function openDrawer(id){
  let p=data.contactos.find(c=>c.id==id);
  document.getElementById("drawerTitle").innerText=p.nombre+" ("+p.fase+")";
  let html="";
  if(p.fase=="REUNION"){
    html=`<label>Fecha:</label><input type="date" value="${p.reunion?.fecha||""}"><br>
          <label>Notas:</label><textarea>${p.reunion?.notas||""}</textarea><br>
          <button onclick="sendMsg(${p.id},'reunion')">Enviar mensaje</button>`;
  } else if(p.fase=="CONTRATO"){
    html=`<button onclick="genContrato('${p.nombre}')">Descargar contrato PDF</button><br>
          <button onclick="sendMsg(${p.id},'contrato')">Enviar mensaje</button>`;
  } else if(p.fase=="CONTACTO"){
    html=`<button onclick="sendMsg(${p.id},'contacto')">Enviar mensaje</button>`;
  }
  document.getElementById("drawerContent").innerHTML=html;
  document.getElementById("drawer").classList.add("open");
}
function closeDrawer(){ document.getElementById("drawer").classList.remove("open"); }

/* ====== CONTRATO PDF ====== */
function genContrato(nombre){
  let docDefinition={ content:[{text:"Contrato PSI 2025 ‚Äî Unihouser", style:"header"},
    {text:"Cliente: "+nombre},{text:"Cl√°usulas resumidas (demo)."},],
    styles:{header:{fontSize:18,bold:true,color:"#ff6a3d"}}};
  pdfMake.createPdf(docDefinition).download("Contrato_"+nombre+".pdf");
}

/* ====== MENSAJES ====== */
function sendMsg(id,tipo){
  let p=data.contactos.find(c=>c.id==id);
  let msg=data.mensajes[tipo]
    .replace("{{NOMBRE}}",p.nombre)
    .replace("{{FECHA}}",p.reunion?.fecha||"")
    .replace("{{NOTAS}}",p.reunion?.notas||"");
  navigator.clipboard.writeText(msg);
  toast("Mensaje copiado al portapapeles");
}

/* ====== CONFIGURACI√ìN ====== */
function saveConfig(){
  data.mensajes.contacto=document.getElementById("msg_contacto").value;
  data.mensajes.reunion=document.getElementById("msg_reunion").value;
  data.mensajes.contrato=document.getElementById("msg_contrato").value;
  save();
  toast("Configuraci√≥n guardada");
}
function loadConfig(){
  document.getElementById("msg_contacto").value=data.mensajes.contacto;
  document.getElementById("msg_reunion").value=data.mensajes.reunion;
  document.getElementById("msg_contrato").value=data.mensajes.contrato;
}

/* ====== UTIL ====== */
function save(){ localStorage.setItem("crmData",JSON.stringify(data)); }
function toast(txt){ let t=document.getElementById("toast"); t.innerText=txt; t.style.display="block"; setTimeout(()=>t.style.display="none",3000); }

/* INIT */
loadConfig(); render();
</script>
</body>
</html>
