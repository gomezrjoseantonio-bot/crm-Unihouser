<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unihouser — Dashboard CRM</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}

/* Topbar */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}

/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:10px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:2px}
.kpi .lab{font-size:11px;color:#667085}
.kpi .big{font-weight:800;font-size:18px}

/* Board */
.board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;min-height:520px;box-shadow:var(--shadow)}
.col h3{margin:0 0 6px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;font-size:13px}
.count{font-weight:700;color:#666}

/* Crear */
.create{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:8px;display:grid;gap:6px;margin-bottom:10px}
.create .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}
.create input, .create select{border:1px solid var(--line);border-radius:10px;padding:7px 9px;min-height:30px}
.create .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 9px;font-weight:700;cursor:pointer;font-size:12px}

/* Tarjeta */
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:6px;cursor:pointer}
.card header{display:flex;align-items:center;gap:6px}
.name{font-weight:800;font-size:13px}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 7px;display:inline-flex;align-items:center;gap:6px;font-size:11px}
.actions{display:flex;gap:6px;margin-left:auto}
.btn-icon{width:26px;height:26px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.btn-icon svg{width:15px;height:15px;stroke-width:2;fill:none;stroke:#555}
.btn-icon.del{border-color:#999} .btn-icon.del svg{stroke:#999}

/* Drawer */
.overlay{position:fixed;inset:0;background:rgba(15,18,20,.28);backdrop-filter:blur(2px);display:none;z-index:80}
.overlay.open{display:block}
.drawer{position:fixed;top:0;right:-640px;height:100%;width:640px;max-width:100%;background:#fff;border-left:1px solid var(--line);box-shadow:0 10px 24px rgba(0,0,0,.25);transition:right .2s ease;z-index:90}
.drawer.open{right:0}
.d-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
.d-title{font-weight:800}
.d-body{padding:10px 12px 16px;overflow:auto;height:calc(100% - 48px)}
.block{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:8px;margin:8px 0}
.block h4{margin:0 0 6px}
.row{display:grid;gap:8px}
.row.two{grid-template-columns:1fr 1fr}
.row.three{grid-template-columns:1fr 1fr 1fr}
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:11px;color:#555}
input,select,textarea{border:1px solid var(--line);border-radius:10px;padding:6px 7px;background:#fff;font-size:12px;color:var(--ink)}
textarea{min-height:70px;resize:vertical}
.small{font-size:11px;color:#667085}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:800;font-size:12px}
.btn.primary{background:var(--brand);color:#fff;border:none}

/* Matches */
.match-list{display:grid;gap:6px}
.match-item{border:1px solid var(--line);border-radius:10px;padding:8px;display:grid;gap:6px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
.kv .k{color:#667085;font-size:11px}
.kv .v{font-weight:700}
.warn{display:inline-flex;align-items:center;gap:6px;font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid #fde68a;background:#fff7ed;color:#b45309}
.footer{margin:16px 0 14px;text-align:center;color:#888;font-size:11px}
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:#16a34a}.toast.warn{background:#f59e0b}.toast.bad{background:#ef4444}
@media (max-width:980px){.create .row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div id="logoBox" class="logo">U</div><div id="brandTitle" class="title">Unihouser — Dashboard</div></div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <div class="container">

    <!-- Crear rápido -->
    <section class="create">
      <div class="row">
        <input id="c_name" placeholder="Nombre y apellidos">
        <input id="c_email" placeholder="Email">
        <input id="c_phone" placeholder="Móvil (+34…)" />
        <select id="c_phase">
          <option>CONTACTO</option><option>REUNION</option><option>BUSQUEDA</option><option>COMPRAVENTA</option><option>EXITO</option>
        </select>
      </div>
      <div class="row">
        <select id="c_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
        <input id="c_locs" placeholder="Localidades (coma)">
        <input id="c_budget" placeholder="P. máx (€)">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
          <select id="c_obj_main"><option value="bruta">Objetivo: Bruta %</option><option value="neta">Objetivo: Neta %</option><option value="flujo">Objetivo: Flujo €/mes</option></select>
          <input id="c_obj_val" placeholder="Valor objetivo">
        </div>
      </div>
      <button class="btn" id="c_add">Crear contacto</button>
    </section>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi"><div class="lab">Prospects</div><div class="big" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">En búsqueda</div><div class="big" id="k_busq">0</div></div>
      <div class="kpi"><div class="lab">Con coincidencias</div><div class="big" id="k_match">0</div></div>
      <div class="kpi"><div class="lab">Éxitos</div><div class="big" id="k_exito">0</div></div>
      <div class="kpi"><div class="lab">Tradicional</div><div class="big" id="k_trad">0</div></div>
      <div class="kpi"><div class="lab">Habitaciones</div><div class="big" id="k_hab">0</div></div>
    </section>

    <!-- Tablero -->
    <section class="board" id="board"></section>

  </div>

  <div id="overlay" class="overlay"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <span class="d-title" id="d_title">Ficha del cliente</span>
      <div style="display:flex;gap:6px">
        <button class="btn" id="d_save">Guardar</button>
        <button class="btn primary" id="d_save_assign">Guardar + asignar</button>
        <button class="btn" id="d_close">Cerrar</button>
      </div>
    </div>
    <div class="d-body" id="d_body">

      <!-- DATOS DEL CLIENTE -->
      <div class="block">
        <h4>Datos del cliente</h4>
        <div class="row two">
          <div class="field"><label>Nombre</label><input id="f_nombre"></div>
          <div class="field"><label>Fase</label>
            <select id="f_fase">
              <option>CONTACTO</option><option>REUNION</option><option>BUSQUEDA</option><option>COMPRAVENTA</option><option>EXITO</option>
            </select>
          </div>
        </div>
        <div class="row two">
          <div class="field"><label>Email</label><input id="f_email" type="email"></div>
          <div class="field"><label>Móvil</label><input id="f_phone"></div>
        </div>
        <div class="row">
          <div class="field"><label>Notas</label><textarea id="f_notas" placeholder="Preferencias, contexto…"></textarea></div>
        </div>
      </div>

      <!-- DATOS DE LA INVERSIÓN / ACTIVO -->
      <div class="block">
        <h4>Datos de la inversión / Activo</h4>
        <div class="row two">
          <div class="field"><label>Tipo preferido</label><select id="f_pref_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
          <div class="field"><label>Localidades (coma)</label><input id="f_locs" placeholder="Oviedo,Gijón,Avilés"></div>
        </div>
        <div class="row three">
          <div class="field"><label>Prefiere sin reforma</label><select id="f_no_reforma"><option>No</option><option>Sí</option></select></div>
          <div class="field"><label>Requiere ascensor</label><select id="f_ascensor"><option>No</option><option>Sí</option></select></div>
          <div class="field"><label>Evitar bajos</label><select id="f_no_bajos"><option>No</option><option>Sí</option></select></div>
        </div>
      </div>

      <!-- FINANCIACIÓN -->
      <div class="block">
        <h4>Financiación</h4>
        <div class="row three">
          <div class="field"><label>Presupuesto máx (€)</label><input id="f_budget"></div>
          <div class="field"><label>% financiación</label><input id="f_pct_fin" placeholder="80"></div>
          <div class="field"><label>Ahorro (€)</label><input id="f_ahorro"></div>
        </div>
        <div class="row three">
          <div class="field"><label>Ingresos/mes (€)</label><input id="f_ingresos"></div>
          <div class="field"><label>Plazo (años)</label><input id="f_plazo"></div>
          <div class="field"><label>Interés (%)</label><input id="f_interes"></div>
        </div>
        <div class="small">Sólo “Presupuesto máx” participa en el matching; el resto se guarda para tu ficha.</div>
      </div>

      <!-- OBJETIVOS -->
      <div class="block">
        <h4>Objetivos</h4>
        <div class="row two">
          <div class="field"><label>Objetivo principal</label>
            <select id="f_obj_main">
              <option value="bruta">Bruta %</option>
              <option value="neta">Neta %</option>
              <option value="flujo">Flujo €/mes</option>
            </select>
          </div>
          <div class="field"><label>Valor objetivo</label><input id="f_obj_val" placeholder="Ej: 10"></div>
        </div>
        <div class="row three">
          <div class="field"><label>Bruta %</label><input id="f_obj_bruta"></div>
          <div class="field"><label>Neta %</label><input id="f_obj_neta"></div>
          <div class="field"><label>Flujo €/mes</label><input id="f_obj_flujo"></div>
        </div>
      </div>

      <!-- MATCHES -->
      <div class="block">
        <h4>Coincidencias con evaluaciones</h4>
        <div class="small" id="m_info">—</div>
        <div id="m_list" class="match-list">—</div>
      </div>

    </div>
  </aside>

  <div id="toasts" class="toast-wrap"></div>
  <div class="footer">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div>

<script>
(function(){
"use strict";

/* ===== Marca desde cfg ===== */
try{
  var _cfg=JSON.parse(localStorage.getItem('cfg')||'{}')||{};
  var col=_cfg.brand_color||_cfg.brand||'#c7530c';
  document.documentElement.style.setProperty('--brand', col);
  var name=_cfg.brand_name||_cfg.company_name||'Unihouser';
  document.getElementById('brandTitle').textContent=name+' — Dashboard';
  document.getElementById('logoBox').textContent=(name||'U').toString().trim().charAt(0).toUpperCase()||'U';
}catch(_){}

/* ===== Utils ===== */
var id=function(x){return document.getElementById(x);};
var fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
var fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function e0(v){return fmtE0.format(Number(v||0));}
function n0(v){return fmtN0.format(Number(v||0));}
function parseNum(v){return Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;}
function toast(msg,kind){var w=id('toasts'); var el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg; w.appendChild(el); setTimeout(function(){el.style.opacity='0';},1600); setTimeout(function(){try{w.removeChild(el)}catch(_){}} ,2200);}

/* ===== Store ===== */
var Store={
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))}
};

/* ===== Estado ===== */
var PHASES=['CONTACTO','REUNION','BUSQUEDA','COMPRAVENTA','EXITO'];
var openId=null;

/* ===== Crear rápido ===== */
id('c_add').onclick=function(){
  var p={
    id:'p_'+Date.now(), ts:Date.now(),
    nombre:id('c_name').value||'',
    email:id('c_email').value||'',
    phone:id('c_phone').value||'',
    fase:id('c_phase').value||'CONTACTO',
    pref_tipo:id('c_tipo').value||'Tradicional',
    locs_text:id('c_locs').value||'',
    presupuesto_max:parseNum(id('c_budget').value),
    obj_main:id('c_obj_main').value,
    obj_raw:parseNum(id('c_obj_val').value),
    obj_bruta:null, obj_neta:null, obj_flujo:null, obj_flujo_anual:null,
    notas:'', no_reforma:'No', requiere_ascensor:'No', evitar_bajos:'No'
  };
  var list=Store.pros||[]; list.push(p); Store.pros=list;
  id('c_name').value=id('c_email').value=id('c_phone').value=id('c_locs').value=id('c_budget').value=id('c_obj_val').value='';
  renderBoard(); kpis();
  toast('Contacto creado','ok');
};

/* ===== KPIs ===== */
function kpis(){
  var list=Store.pros||[];
  id('k_total').textContent=list.length;
  id('k_busq').textContent=list.filter(function(p){return fold(p.fase).includes('busq')}).length;
  id('k_exito').textContent=list.filter(function(p){return fold(p.fase)==='exito'}).length;
  id('k_trad').textContent=list.filter(function(p){return (p.pref_tipo||'').toLowerCase()==='tradicional'}).length;
  id('k_hab').textContent=list.filter(function(p){return (p.pref_tipo||'').toLowerCase()==='habitaciones'}).length;
  id('k_match').textContent=list.filter(function(p){return getMatches(p).length>0}).length;
}

/* ===== Board ===== */
function renderBoard(){
  var wrap=id('board'); wrap.innerHTML='';
  var list=Store.pros||[];
  PHASES.forEach(function(ph){
    var col=document.createElement('div'); col.className='col'; col.dataset.phase=ph;
    var arr=list.filter(function(p){return (p.fase||'').toUpperCase()===ph;});
    col.innerHTML='<h3>'+ph+' <span class="count">'+arr.length+'</span></h3>';
    arr.forEach(function(p){ col.appendChild(card(p)); });
    wrap.appendChild(col);
  });
}
function card(p){
  var div=document.createElement('div'); div.className='card'; div.dataset.id=p.id;
  var objTxt=goalSummary(p);
  var budget=Number(p.presupuesto_max||0);
  var bset=getMatches(p).length;
  div.innerHTML=
    '<header>'+
      '<span class="name">'+esc(p.nombre||'—')+'</span>'+
      '<span class="badges">'+
        chip(p.pref_tipo||'-')+
        chip((p.locs_text||'').split(',').filter(Boolean).length+' locs')+
        (objTxt? chip(objTxt):'')+
        (budget? chip('Pmax '+e0(budget)):'')+
        (bset? chip('Matches '+bset):'')+
      '</span>'+
      '<span class="actions">'+
        '<button class="btn-icon del" data-del="'+p.id+'" title="Borrar">'+trashIcon()+'</button>'+
      '</span>'+
    '</header>';
  div.addEventListener('click',function(ev){
    if(ev.target.closest('button[data-del]')) return;
    openDrawer(p.id);
  });
  div.querySelector('button[data-del]').onclick=function(e){
    e.stopPropagation();
    if(confirm('¿Borrar este contacto?')){
      Store.pros=(Store.pros||[]).filter(function(x){return x.id!==p.id}); renderBoard(); kpis();
    }
  };
  return div;
}
function chip(t){ var s=document.createElement('span'); s.className='badge'; s.textContent=t; return s;}
function esc(s){return (s==null?'':String(s)).replace(/[&<>"']/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])});}
function trashIcon(){return '<svg viewBox="0 0 24 24"><path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 7l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12" stroke="#999" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 10v7M14 10v7" stroke="#999" stroke-width="1.6" stroke-linecap="round"/></svg>'; }
function goalSummary(p){
  var main=(p.obj_main||'').toLowerCase(); var v=Number(p.obj_raw||0);
  if(main==='bruta'&&v>0) return 'Bruta '+fmtN1.format(v)+' %';
  if(main==='neta' &&v>0) return 'Neta '+fmtN1.format(v)+' %';
  if(main==='flujo'&&v>0) return 'Flujo '+e0(v);
  if(Number(p.obj_bruta||0)>0) return 'Bruta '+fmtN1.format(p.obj_bruta)+' %';
  if(Number(p.obj_neta ||0)>0) return 'Neta '+fmtN1.format(p.obj_neta)+' %';
  if(Number(p.obj_flujo||0)>0) return 'Flujo '+e0(p.obj_flujo);
  return '';
}

/* ===== Drawer ===== */
function openDrawer(pid){
  openId=pid;
  var p=(Store.pros||[]).find(function(x){return x.id===pid}); if(!p) return;
  id('d_title').textContent='Ficha: '+(p.nombre||'—');
  // Datos cliente
  id('f_nombre').value=p.nombre||''; id('f_fase').value=(p.fase||'CONTACTO').toUpperCase();
  id('f_email').value=p.email||''; id('f_phone').value=p.phone||'';
  id('f_notas').value=p.notas||'';
  // Inversión/Activo
  id('f_pref_tipo').value=p.pref_tipo||'Tradicional';
  id('f_locs').value=p.locs_text||'';
  id('f_no_reforma').value=truthy(p.no_reforma)?'Sí':'No';
  id('f_ascensor').value=truthy(p.requiere_ascensor)?'Sí':'No';
  id('f_no_bajos').value=truthy(p.evitar_bajos)?'Sí':'No';
  // Financiación
  id('f_budget').value = p.presupuesto_max? n0(p.presupuesto_max):'';
  id('f_pct_fin').value=p.pct_fin||''; id('f_ahorro').value=p.ahorro||'';
  id('f_ingresos').value=p.ingresos||''; id('f_plazo').value=p.plazo||''; id('f_interes').value=p.interes||'';
  // Objetivos
  id('f_obj_main').value=(p.obj_main||'bruta').toLowerCase();
  id('f_obj_val').value= p.obj_raw? n0(p.obj_raw):'';
  id('f_obj_bruta').value=p.obj_bruta? n0(p.obj_bruta):'';
  id('f_obj_neta').value =p.obj_neta ? n0(p.obj_neta):'';
  id('f_obj_flujo').value=p.obj_flujo? n0(p.obj_flujo):'';

  renderMatches(p);

  id('overlay').classList.add('open'); id('drawer').classList.add('open');
}
function closeDrawer(){ id('overlay').classList.remove('open'); id('drawer').classList.remove('open'); openId=null;}
id('d_close').onclick=closeDrawer; id('overlay').onclick=closeDrawer;

/* Guardar ficha */
id('d_save').onclick=function(){ save(false); };
id('d_save_assign').onclick=function(){ save(true); };

function save(withAssign){
  if(!openId) return;
  var list=Store.pros||[]; var idx=list.findIndex(function(x){return x.id===openId}); if(idx<0) return;
  var p=list[idx];
  // Datos cliente
  p.nombre=id('f_nombre').value.trim(); p.fase=(id('f_fase').value||'CONTACTO').toUpperCase();
  p.email=id('f_email').value.trim(); p.phone=id('f_phone').value.trim();
  p.notas=id('f_notas').value;
  // Inversión/Activo
  p.pref_tipo=id('f_pref_tipo').value; p.locs_text=id('f_locs').value;
  p.no_reforma=(id('f_no_reforma').value||'No')==='Sí'; 
  p.requiere_ascensor=(id('f_ascensor').value||'No')==='Sí';
  p.evitar_bajos=(id('f_no_bajos').value||'No')==='Sí';
  // Financiación
  p.presupuesto_max=parseNum(id('f_budget').value);
  p.pct_fin=id('f_pct_fin').value; p.ahorro=id('f_ahorro').value; p.ingresos=id('f_ingresos').value;
  p.plazo=id('f_plazo').value; p.interes=id('f_interes').value;
  // Objetivos
  p.obj_main=(id('f_obj_main').value||'bruta').toLowerCase();
  p.obj_raw=parseNum(id('f_obj_val').value);
  p.obj_bruta=parseNum(id('f_obj_bruta').value);
  p.obj_neta =parseNum(id('f_obj_neta').value);
  p.obj_flujo=parseNum(id('f_obj_flujo').value);

  list[idx]=p; Store.pros=list;

  if(withAssign){ applyAssignToEvals(p); }

  renderBoard(); kpis(); toast('Ficha guardada'+(withAssign?' y asignaciones':''), 'ok');
}

/* ===== Matching (misma lógica que Evaluaciones, invertida p↔e) ===== */
function fold(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();}
function truthy(x){ if(x===true) return true; if(x===false) return false; var s=fold(x); return s==='si'||s==='sí'||s==='true'||s==='1'; }
function isSearching(p){var f=fold(p.fase||'');return f.includes('busq');}
function toPct(raw){ var v=Number(raw||0); if(v>0&&v<=1)v*=100; while(v>=100)v/=10; return v;}
function getTargetInfo(p){
  var main=(p.obj_main||p.obj_tipo||'').toString().toLowerCase().trim();
  var raw=Number(p.obj_raw||0);
  var b =Number(p.obj_bruta||0), n=Number(p.obj_neta||0), fm=Number(p.obj_flujo||0), fa=Number(p.obj_flujo_anual||0);
  if(main==='bruta'&&raw>0) return {kind:'bruta',val:raw};
  if(main==='neta' &&raw>0) return {kind:'neta', val:raw};
  if(main==='flujo'&&(raw>0||fm>0||fa>0)) return {kind:'flujo',val: fa>0?fa:(raw>0?raw*12:fm*12)};
  if(b>0) return {kind:'bruta',val:b};
  if(n>0) return {kind:'neta', val:n};
  if(fa>0||fm>0) return {kind:'flujo',val:(fa>0?fa:fm*12)};
  return {kind:'',val:0};
}
function warnBadgesFor(e,p){
  var warns=[], necesitaReforma=(e.ref_tip&&e.ref_tip!=='no');
  var sinAscensor=String(e.asc||'Sí').toLowerCase()==='no';
  var esBajo=String(e.bajo||'No').toLowerCase()==='sí'||String(e.bajo||'No').toLowerCase()==='si';
  var budget=Number(p.presupuesto_max||0);
  if(necesitaReforma && truthy(p.no_reforma)) warns.push('Requiere reforma y el cliente no quiere');
  if(sinAscensor && truthy(p.requiere_ascensor)) warns.push('Sin ascensor y el cliente requiere ascensor');
  if(esBajo && truthy(p.evitar_bajos)) warns.push('Es bajo y el cliente evita bajos');
  if(budget>0 && Number(e.inv_total||0) > budget) warns.push('Excede presupuesto');
  return warns;
}
function matchProspectEval(p,e){
  if(!isSearching(p)) return {ok:false,why:'fase'};
  if(fold(p.pref_tipo)!==fold(e.tipo)) return {ok:false,why:'tipo'};
  var locs=(p.locs_text||'').split(',').map(fold).filter(Boolean);
  if(locs.length && locs.indexOf(fold(e.loc))===-1) return {ok:false,why:'localidad'};
  var tgt=getTargetInfo(p); if(!tgt.val) return {ok:false,why:'objetivo'};
  var br=toPct(e.kpi_bruta), nt=toPct(e.kpi_neta), fl=Number(e.kpi_flujo||0);
  if(tgt.kind==='bruta' && br>=tgt.val) return {ok:true,kind:'bruta'};
  if(tgt.kind==='neta'  && nt>=tgt.val) return {ok:true,kind:'neta'};
  if(tgt.kind==='flujo' && fl>=tgt.val) return {ok:true,kind:'flujo'};
  return {ok:false,why:'kpi'};
}
function getMatches(p){
  var evs=Store.evals||[]; var res=[];
  evs.forEach(function(e){
    var m=matchProspectEval(p,e);
    if(m.ok) res.push({e:e, why:m.kind, warns:warnBadgesFor(e,p)});
  });
  return res;
}
function renderMatches(p){
  var box=id('m_list'); var info=id('m_info'); box.innerHTML=''; 
  var matches=getMatches(p); info.textContent=matches.length+' coincidencia(s) con tus evaluaciones.';
  if(!matches.length){ box.textContent='—'; return; }

  // set de evals ya asignadas a este prospect
  var assignedSet=new Set();
  (Store.evals||[]).forEach(function(ev){
    var arr=ev.prospect_ids||[]; if(arr.indexOf(p.id)!==-1) assignedSet.add(ev.id);
  });

  matches.forEach(function(m){
    var e=m.e;
    var row=document.createElement('div'); row.className='match-item';
    var chk=document.createElement('input'); chk.type='checkbox'; chk.checked=assignedSet.has(e.id); chk.dataset.eid=e.id;
    var head=document.createElement('div');
    head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
    var ttl=document.createElement('div'); ttl.innerHTML='<strong>'+esc(e.loc||'-')+' · '+esc(e.calle||'-')+'</strong>';
    var why=document.createElement('span'); why.className='badge'; why.textContent='Coincide por '+m.why;
    head.appendChild(ttl); head.appendChild(why);

    var kv=document.createElement('div'); kv.className='kv';
    kv.innerHTML=
      '<div class="k">Tipo</div><div class="v">'+esc(e.tipo||'-')+'</div>'+
      '<div class="k">Bruta</div><div class="v">'+fmtN1.format(toPct(e.kpi_bruta))+' %</div>'+
      '<div class="k">Neta</div><div class="v">'+fmtN1.format(toPct(e.kpi_neta))+' %</div>'+
      '<div class="k">Flujo</div><div class="v">'+e0(e.kpi_flujo)+'</div>'+
      '<div class="k">P. máx</div><div class="v">'+e0(e.pmax)+'</div>';

    var warnsWrap=document.createElement('div');
    m.warns.forEach(function(w){ var b=document.createElement('span'); b.className='warn'; b.textContent=w; warnsWrap.appendChild(b); });

    row.appendChild(chk); row.appendChild(head); row.appendChild(kv); row.appendChild(warnsWrap);
    box.appendChild(row);
  });
}

/* Aplicar asignaciones desde la ficha (checkboxes de matches) */
function applyAssignToEvals(p){
  var checks=[].slice.call(document.querySelectorAll('#m_list input[type=checkbox][data-eid]'));
  var mustAssign = new Set(checks.filter(function(c){return c.checked}).map(function(c){return c.dataset.eid;}));
  var evs=Store.evals||[];
  evs.forEach(function(e){
    e.prospect_ids = e.prospect_ids || [];
    var has = e.prospect_ids.indexOf(p.id)!==-1;
    if(mustAssign.has(e.id) && !has){ e.prospect_ids.push(p.id); }
    if(!mustAssign.has(e.id) && has){ e.prospect_ids = e.prospect_ids.filter(function(x){return x!==p.id}); }
  });
  Store.evals=evs;
}

/* ===== Helpers ===== */
function escHtml(el, v){ el.textContent=(v==null||v==='')? '—' : String(v); }

/* ===== Init ===== */
function attach(){
  renderBoard(); kpis();
}
document.addEventListener('DOMContentLoaded',attach);
})();
</script>
</body>
</html>
