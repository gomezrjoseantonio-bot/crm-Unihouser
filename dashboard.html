<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FinanceManager — Dashboard Financiero</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#2E7D32; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
/* Topbar */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}
/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}
/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:8px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:4px}
.kpi .big{font-weight:800;font-size:15px}
.kpi .lab{font-size:11px;color:#667085}
/* Iconos de barra */
.kbar{display:flex;align-items:center;justify-content:flex-end;gap:8px;margin:4px 0 12px}
.kicon{width:30px;height:30px;border:1px solid var(--line);background:#fff;border-radius:10px;display:grid;place-items:center;cursor:pointer}
.kicon svg{width:16px;height:16px;stroke:#555;fill:none;stroke-width:2}
.kicon.active{border-color:var(--brand)}
/* Crear transacción */
.create{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:8px;display:grid;gap:6px;margin-bottom:10px}
.create .row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:6px}
.create input,.create select{border:1px solid var(--line);border-radius:10px;padding:7px 9px;min-height:30px}
.create .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 9px;font-weight:700;cursor:pointer;font-size:12px}
/* Board */
.board{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;min-height:520px;box-shadow:var(--shadow)}
.col h3{margin:0 0 6px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;font-size:13px}
.count{font-weight:700;color:#666}
/* Tarjeta */
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:6px;margin-bottom:8px}
.card header{display:flex;align-items:center;gap:8px}
.name{font-weight:800;font-size:13px}
/* Progress bar */
.progress{background:#f0f0f0;border-radius:4px;height:6px;margin-top:4px}
.progress-fill{height:100%;border-radius:4px;transition:width 0.3s ease}
/* Toast */
.toast{position:fixed;top:80px;right:20px;background:var(--ink);color:#fff;padding:12px 16px;border-radius:10px;box-shadow:var(--shadow);z-index:100;transform:translateX(100%);transition:transform 0.3s ease}
.toast.show{transform:translateX(0)}
.toast.ok{background:var(--ok)}
.toast.warn{background:#f59e0b}
.toast.error{background:var(--bad)}
/* Footer */
.footer{max-width:1200px;margin:18px auto;padding:6px 14px;text-align:center;color:#777;font-size:11px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo" id="logoBox">₱</div><div class="title" id="brandTitle">FinanceManager — Dashboard</div></div>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="ingresos.html">Ingresos</a>
        <a href="gastos.html">Gastos</a>
        <a href="presupuestos.html">Presupuestos</a>
        <a href="reportes.html">Reportes</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <!-- KPIs Financieros -->
    <div id="kpis" class="kpis">
      <div class="kpi"><div class="lab">Balance Total</div><div class="big" id="k_balance">€0</div></div>
      <div class="kpi"><div class="lab">Ingresos (Mes)</div><div class="big" id="k_ingresos">€0</div></div>
      <div class="kpi"><div class="lab">Gastos (Mes)</div><div class="big" id="k_gastos">€0</div></div>
      <div class="kpi"><div class="lab">Ahorros</div><div class="big" id="k_ahorros">€0</div></div>
      <div class="kpi"><div class="lab">Presupuesto Restante</div><div class="big" id="k_presupuesto">€0</div></div>
      <div class="kpi"><div class="lab">Transacciones</div><div class="big" id="k_transacciones">0</div></div>
    </div>
    <div class="kbar">
      <button id="btn_add_income" class="kicon" title="Añadir Ingreso" aria-label="Añadir Ingreso">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18"/><path d="M5 12h14"/></svg>
      </button>
      <button id="btn_add_expense" class="kicon" title="Añadir Gasto" aria-label="Añadir Gasto">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
      </button>
      <button id="btn_export" class="kicon" title="Exportar Datos" aria-label="Exportar Datos">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 19h14"/></svg>
      </button>
    </div>

    <!-- Transacción Rápida -->
    <div class="create">
      <div class="row">
        <input id="t_descripcion" placeholder="Descripción">
        <input id="t_cantidad" placeholder="Cantidad (€)" type="number" step="0.01">
        <select id="t_categoria">
          <option value="">Seleccionar categoría</option>
          <option value="ingresos">Ingresos</option>
          <option value="alimentacion">Alimentación</option>
          <option value="transporte">Transporte</option>
          <option value="vivienda">Vivienda</option>
          <option value="salud">Salud</option>
          <option value="entretenimiento">Entretenimiento</option>
          <option value="otros">Otros</option>
        </select>
        <select id="t_tipo">
          <option value="gasto">Gasto</option>
          <option value="ingreso">Ingreso</option>
        </select>
      </div>
      <button class="btn" id="btn_create_transaction">Añadir Transacción</button>
      <small class="small">Registra tus ingresos y gastos de forma rápida.</small>
    </div>

    <!-- Dashboard Financiero -->
    <div class="board" id="financial_board">
      <div class="col">
        <h3>Transacciones Recientes <span class="count" id="recent_count">0</span></h3>
        <div id="recent_transactions"></div>
      </div>
      
      <div class="col">
        <h3>Gastos por Categoría <span class="count" id="categories_count">0</span></h3>
        <div id="expense_categories"></div>
      </div>
      
      <div class="col">
        <h3>Presupuestos <span class="count" id="budgets_count">0</span></h3>
        <div id="budgets_overview"></div>
      </div>
      
      <div class="col">
        <h3>Metas de Ahorro <span class="count" id="goals_count">0</span></h3>
        <div id="savings_goals"></div>
      </div>
      
      <div class="col">
        <h3>Resumen Mensual <span class="count"></span></h3>
        <div id="monthly_summary"></div>
      </div>
      
      <div class="col">
        <h3>Alertas <span class="count" id="alerts_count">0</span></h3>
        <div id="financial_alerts"></div>
      </div>
    </div>
  </div>

  <div class="footer">© 2025 FinanceManager · Control de Finanzas Personales</div>

  <div class="toast" id="toast"></div>

<script>
(function(){
"use strict";

/* ===== Brand ===== */
try{
  const c=JSON.parse(localStorage.getItem('cfg')||'{}')||{};
  const col=c.brand_color||'#c7530c'; document.documentElement.style.setProperty('--brand', col);
  const name=c.brand_name||c.company_name||'FinanceManager';
  document.getElementById('brandTitle').textContent = name+' — Dashboard';
  document.getElementById('logoBox').textContent = '₱';
}catch(e){}

/* ===== Utils ===== */
const $=function(id){return document.getElementById(id);};
const toast=function(m,k){const t=$('toast');t.textContent=m;t.className='toast '+(k||'');t.classList.add('show');setTimeout(function(){t.classList.remove('show');},1400);};
const esc=function(s){return (s??'').toString().replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});};
const fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtE2=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:2});
const e0=function(v){return fmtE0.format(Number(v||0));};
const e2=function(v){return fmtE2.format(Number(v||0));};
const parseNum=function(v){return Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;};

/* ===== Storage ===== */
const Store={
  get transactions(){try{return JSON.parse(localStorage.getItem('transactions')||'[]')}catch(_){return[]}}, 
  set transactions(v){localStorage.setItem('transactions',JSON.stringify(v));},
  get budgets(){try{return JSON.parse(localStorage.getItem('budgets')||'[]')}catch(_){return[]}}, 
  set budgets(v){localStorage.setItem('budgets',JSON.stringify(v));},
  get goals(){try{return JSON.parse(localStorage.getItem('goals')||'[]')}catch(_){return[]}}, 
  set goals(v){localStorage.setItem('goals',JSON.stringify(v));},
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}, 
  set cfg(v){localStorage.setItem('cfg',JSON.stringify(v));}
};

/* ===== Financial Logic ===== */
function getCurrentMonth() {
  const now = new Date();
  return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
}

function calculateBalance() {
  const transactions = Store.transactions;
  return transactions.reduce((sum, t) => {
    return sum + (t.type === 'ingreso' ? t.amount : -t.amount);
  }, 0);
}

function getMonthlyTotal(type) {
  const currentMonth = getCurrentMonth();
  const transactions = Store.transactions;
  return transactions
    .filter(t => t.type === type && t.date.startsWith(currentMonth))
    .reduce((sum, t) => sum + t.amount, 0);
}

function getCategoryTotals() {
  const currentMonth = getCurrentMonth();
  const transactions = Store.transactions;
  const expenses = transactions.filter(t => t.type === 'gasto' && t.date.startsWith(currentMonth));
  
  const categories = {};
  expenses.forEach(t => {
    categories[t.category] = (categories[t.category] || 0) + t.amount;
  });
  
  return categories;
}

function updateKPIs() {
  const balance = calculateBalance();
  const monthlyIncome = getMonthlyTotal('ingreso');
  const monthlyExpenses = getMonthlyTotal('gasto');
  const savings = monthlyIncome - monthlyExpenses;
  const transactions = Store.transactions;
  
  // Calculate remaining budget
  const budgets = Store.budgets;
  const currentMonth = getCurrentMonth();
  const monthlyBudget = budgets.find(b => b.month === currentMonth);
  const budgetRemaining = monthlyBudget ? monthlyBudget.amount - monthlyExpenses : 0;
  
  $('k_balance').textContent = e0(balance);
  $('k_ingresos').textContent = e0(monthlyIncome);
  $('k_gastos').textContent = e0(monthlyExpenses);
  $('k_ahorros').textContent = e0(savings);
  $('k_presupuesto').textContent = e0(budgetRemaining);
  $('k_transacciones').textContent = transactions.length;
}

function renderRecentTransactions() {
  const container = $('recent_transactions');
  const transactions = Store.transactions
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 10);
  
  $('recent_count').textContent = transactions.length;
  
  container.innerHTML = transactions.map(t => `
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 700; font-size: 12px;">${esc(t.description)}</div>
          <div style="font-size: 11px; color: #666;">${t.category} • ${t.date}</div>
        </div>
        <div style="font-weight: 700; color: ${t.type === 'ingreso' ? 'var(--ok)' : 'var(--bad)'};">
          ${t.type === 'ingreso' ? '+' : '-'}${e2(t.amount)}
        </div>
      </div>
    </div>
  `).join('');
}

function renderExpenseCategories() {
  const container = $('expense_categories');
  const categories = getCategoryTotals();
  const categoryEntries = Object.entries(categories).sort((a, b) => b[1] - a[1]);
  
  $('categories_count').textContent = categoryEntries.length;
  
  container.innerHTML = categoryEntries.map(([category, amount]) => `
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="font-weight: 700; font-size: 12px; text-transform: capitalize;">${esc(category)}</div>
        <div style="font-weight: 700; color: var(--bad);">${e2(amount)}</div>
      </div>
    </div>
  `).join('');
}

function renderBudgetsOverview() {
  const container = $('budgets_overview');
  const budgets = Store.budgets;
  const currentMonth = getCurrentMonth();
  const monthlyExpenses = getMonthlyTotal('gasto');
  
  $('budgets_count').textContent = budgets.length;
  
  if (budgets.length === 0) {
    container.innerHTML = '<div class="card"><div style="text-align: center; color: #666; font-size: 12px;">No hay presupuestos configurados</div></div>';
    return;
  }
  
  container.innerHTML = budgets.map(budget => {
    const isCurrentMonth = budget.month === currentMonth;
    const spent = isCurrentMonth ? monthlyExpenses : 0;
    const remaining = budget.amount - spent;
    const percentage = budget.amount > 0 ? (spent / budget.amount * 100) : 0;
    
    return `
      <div class="card">
        <div style="font-weight: 700; font-size: 12px;">${budget.name}</div>
        <div style="font-size: 11px; color: #666;">${budget.month}</div>
        <div style="margin-top: 6px;">
          <div style="display: flex; justify-content: space-between; font-size: 11px;">
            <span>Gastado: ${e2(spent)}</span>
            <span>Restante: ${e2(remaining)}</span>
          </div>
          <div class="progress">
            <div class="progress-fill" style="background: ${percentage > 100 ? 'var(--bad)' : percentage > 80 ? '#f59e0b' : 'var(--ok)'}; width: ${Math.min(percentage, 100)}%;"></div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSavingsGoals() {
  const container = $('savings_goals');
  const goals = Store.goals;
  
  $('goals_count').textContent = goals.length;
  
  if (goals.length === 0) {
    container.innerHTML = '<div class="card"><div style="text-align: center; color: #666; font-size: 12px;">No hay metas de ahorro configuradas</div></div>';
    return;
  }
  
  container.innerHTML = goals.map(goal => {
    const percentage = goal.target > 0 ? (goal.current / goal.target * 100) : 0;
    
    return `
      <div class="card">
        <div style="font-weight: 700; font-size: 12px;">${esc(goal.name)}</div>
        <div style="margin-top: 6px;">
          <div style="display: flex; justify-content: space-between; font-size: 11px;">
            <span>Actual: ${e2(goal.current)}</span>
            <span>Meta: ${e2(goal.target)}</span>
          </div>
          <div class="progress">
            <div class="progress-fill" style="background: var(--ok); width: ${Math.min(percentage, 100)}%;"></div>
          </div>
          <div style="text-align: center; font-size: 11px; margin-top: 4px; color: #666;">${percentage.toFixed(1)}%</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderMonthlySummary() {
  const container = $('monthly_summary');
  const currentMonth = getCurrentMonth();
  const monthlyIncome = getMonthlyTotal('ingreso');
  const monthlyExpenses = getMonthlyTotal('gasto');
  const netIncome = monthlyIncome - monthlyExpenses;
  
  container.innerHTML = `
    <div class="card">
      <div style="text-align: center;">
        <div style="font-size: 11px; color: #666; margin-bottom: 8px;">${currentMonth}</div>
        <div style="margin-bottom: 8px;">
          <div style="color: var(--ok); font-weight: 700;">+${e2(monthlyIncome)}</div>
          <div style="font-size: 11px;">Ingresos</div>
        </div>
        <div style="margin-bottom: 8px;">
          <div style="color: var(--bad); font-weight: 700;">-${e2(monthlyExpenses)}</div>
          <div style="font-size: 11px;">Gastos</div>
        </div>
        <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
        <div>
          <div style="color: ${netIncome >= 0 ? 'var(--ok)' : 'var(--bad)'}; font-weight: 700; font-size: 14px;">
            ${netIncome >= 0 ? '+' : ''}${e2(netIncome)}
          </div>
          <div style="font-size: 11px;">Neto</div>
        </div>
      </div>
    </div>
  `;
}

function renderAlerts() {
  const container = $('financial_alerts');
  const alerts = [];
  
  // Check budget alerts
  const currentMonth = getCurrentMonth();
  const monthlyExpenses = getMonthlyTotal('gasto');
  const budgets = Store.budgets;
  const currentBudget = budgets.find(b => b.month === currentMonth);
  
  if (currentBudget && monthlyExpenses > currentBudget.amount * 0.8) {
    alerts.push({
      type: 'warning',
      message: `Has gastado el ${Math.round(monthlyExpenses / currentBudget.amount * 100)}% del presupuesto mensual`
    });
  }
  
  // Check negative balance
  const balance = calculateBalance();
  if (balance < 0) {
    alerts.push({
      type: 'danger',
      message: `Balance negativo: ${e2(balance)}`
    });
  }
  
  $('alerts_count').textContent = alerts.length;
  
  if (alerts.length === 0) {
    container.innerHTML = '<div class="card"><div style="text-align: center; color: var(--ok); font-size: 12px;">✓ Todo en orden</div></div>';
    return;
  }
  
  container.innerHTML = alerts.map(alert => `
    <div class="card" style="border-left: 4px solid ${alert.type === 'danger' ? 'var(--bad)' : '#f59e0b'};">
      <div style="font-size: 12px; color: ${alert.type === 'danger' ? 'var(--bad)' : '#666'};">
        ${esc(alert.message)}
      </div>
    </div>
  `).join('');
}

function render() {
  updateKPIs();
  renderRecentTransactions();
  renderExpenseCategories();
  renderBudgetsOverview();
  renderSavingsGoals();
  renderMonthlySummary();
  renderAlerts();
}

/* ===== Event Handlers ===== */
$('btn_create_transaction').onclick = function() {
  const description = $('t_descripcion').value.trim();
  const amount = parseNum($('t_cantidad').value);
  const category = $('t_categoria').value;
  const type = $('t_tipo').value;
  
  if (!description || !amount || !category) {
    toast('Por favor completa todos los campos', 'warn');
    return;
  }
  
  const transaction = {
    id: Date.now(),
    description,
    amount,
    category,
    type,
    date: new Date().toISOString().split('T')[0]
  };
  
  const transactions = Store.transactions;
  transactions.push(transaction);
  Store.transactions = transactions;
  
  // Clear form
  $('t_descripcion').value = '';
  $('t_cantidad').value = '';
  $('t_categoria').value = '';
  
  render();
  toast('Transacción añadida correctamente', 'ok');
};

$('btn_add_income').onclick = function() {
  $('t_tipo').value = 'ingreso';
  $('t_categoria').value = 'ingresos';
};

$('btn_add_expense').onclick = function() {
  $('t_tipo').value = 'gasto';
  $('t_categoria').value = '';
};

$('btn_export').onclick = function() {
  const transactions = Store.transactions;
  const headers = ['Fecha', 'Descripción', 'Tipo', 'Categoría', 'Cantidad'];
  const rows = [headers.join(',')];
  
  transactions.forEach(t => {
    rows.push([
      t.date,
      `"${t.description}"`,
      t.type,
      t.category,
      t.amount
    ].join(','));
  });
  
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'transacciones_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  toast('Datos exportados correctamente', 'ok');
};

/* ===== Initialize ===== */
render();

// Add some sample data if none exists
if (Store.transactions.length === 0) {
  Store.transactions = [
    {id: 1, description: 'Salario', amount: 2500, category: 'ingresos', type: 'ingreso', date: '2025-01-01'},
    {id: 2, description: 'Supermercado', amount: 150, category: 'alimentacion', type: 'gasto', date: '2025-01-02'},
    {id: 3, description: 'Gasolina', amount: 45, category: 'transporte', type: 'gasto', date: '2025-01-03'},
    {id: 4, description: 'Alquiler', amount: 800, category: 'vivienda', type: 'gasto', date: '2025-01-01'}
  ];
}

if (Store.budgets.length === 0) {
  Store.budgets = [
    {id: 1, name: 'Presupuesto Mensual', amount: 2000, month: getCurrentMonth()}
  ];
}

if (Store.goals.length === 0) {
  Store.goals = [
    {id: 1, name: 'Fondo de Emergencia', current: 1500, target: 5000},
    {id: 2, name: 'Vacaciones', current: 300, target: 1200}
  ];
}

render();

})();
</script>
</body>
</html>