<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unihouser ‚Äî Dashboard CRM</title>
<style>
:root{
  --brand:#c7530c;          /* naranja vivo */
  --accent:#DB824B;
  --ok:#2e7d32;             /* verde ok */
  --bad:#c0392b;            /* rojo ko */
  --line:#E7E1DE;
  --chip:#F3EEE9;
  --bg:#FAF8F7;
  --ink:#1a1f23;
  --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06);
  --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif;
  --fz:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}

/* Topbar (compacta) */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}

/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}

/* KPIs (solo contadores claros) */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:10px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow)}
.kpi .row{display:flex;align-items:center;justify-content:space-between}
.kpi .big{font-weight:800;font-size:15px}
.kpi small{color:#7b7f83}

/* Board */
.board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;min-height:520px;box-shadow:var(--shadow)}
.col h3{margin:0 0 6px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;font-size:13px}
.count{font-weight:700;color:#666}

/* Crear contacto (col CONTACTO) */
.create{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:8px;display:grid;gap:6px}
.create .row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.create input{border:1px solid var(--line);border-radius:10px;padding:7px 9px;min-height:30px}
.create .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 9px;font-weight:700;cursor:pointer;font-size:12px}

/* Tarjeta */
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:6px;cursor:grab}
.card header{display:flex;align-items:center;justify-content:space-between}
.name{font-weight:800;font-size:13px}
.age{color:#8a8f95;font-size:12px}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 7px;display:inline-flex;align-items:center;gap:6px;font-size:11px}
.actions{display:flex;gap:6px;align-items:center}
.btn-icon{width:26px;height:26px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.btn-icon svg{width:15px;height:15px;stroke-width:2;fill:none;stroke:#555}
.btn-icon.view{border-color:var(--brand)} .btn-icon.view svg{stroke:var(--brand)}
.btn-icon.ok{border-color:var(--ok)} .btn-icon.ok svg{stroke:var(--ok)}
.btn-icon.ko{border-color:var(--bad)} .btn-icon.ko svg{stroke:var(--bad)}
.btn-icon.del{border-color:#999} .btn-icon.del svg{stroke:#999}
.btn-icon.assign{border-color:var(--brand)} .btn-icon.assign svg{stroke:var(--brand)}
.btn-icon.contact{border-color:#555} .btn-icon.contact svg{stroke:#555}
.houses{display:flex;gap:4px;margin-left:auto}
.houses i{width:9px;height:9px;border-radius:2px;border:1px solid var(--line);background:#eee;display:inline-block}
.houses i.on{background:var(--brand);border-color:var(--brand)}
.card.dragging{opacity:.5} .col.drop{outline:2px dashed var(--brand);outline-offset:-6px}

/* Toast */
.toast{position:fixed;top:12px;right:12px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);padding:8px 10px;border-radius:12px;display:none;z-index:100}
.toast.ok{border-color:var(--ok)} .toast.bad{border-color:var(--bad)} .toast.warn{border-color:var(--accent)}
.toast.show{display:block}

/* ===== Modales ===== */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:50}
.modal{width:980px;max-width:95vw;max-height:88vh;background:#fff;border:2px solid #fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.22);display:flex;flex-direction:column;overflow:hidden}
.modal header{padding:8px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:#fff}
.modal h4{margin:0;font-size:14px}
.modal .close{width:28px;height:28px;border-radius:999px;border:2px solid var(--brand);background:#fff;color:var(--brand);display:grid;place-items:center;font-weight:800;cursor:pointer}
.modal .body{padding:8px 10px;display:grid;gap:6px;flex:1 1 auto;overflow:auto;background:#fff}
.block{border:1px dashed var(--line);border-radius:12px;padding:6px;background:#fff}
.block h5{margin:0 0 4px;color:#666;font-weight:700;font-size:11px;letter-spacing:.2px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.field{display:flex;flex-direction:column;gap:2px}
.field label{color:#555;font-size:11px}
.field input,.field select,.field textarea,.chips-input{border:1px solid var(--line);border-radius:10px;padding:5px 7px;min-height:24px;font-size:12px;background:#fff;color:var(--ink)}
.field textarea{resize:none}
.row2{grid-column:span 2} .row3{grid-column:span 3}
.chips{display:flex;gap:6px;flex-wrap:wrap;line-height:18px}
.chips.limit2{max-height:40px;overflow:hidden}
.chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 8px;display:inline-flex;gap:6px;align-items:center}
.chip .x{cursor:pointer;color:#999}
.chips-input{width:220px}
.modal footer{padding:8px 10px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;background:#fff}
.save{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 11px;font-weight:800;cursor:pointer;font-size:12px}

/* Modal de asignaci√≥n */
.modal.small{width:780px}
.eval-list{border:1px solid var(--line);border-radius:10px;max-height:46vh;overflow:auto;padding:6px;background:#fff}
.eval-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border-bottom:1px dashed var(--line);padding:6px 2px;font-size:12px}
.eval-item:last-child{border-bottom:none}
.eval-title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.dot{width:10px;height:10px;border-radius:50%}
.dot.green{background:#2ecc71} .dot.amber{background:#f1c40f} .dot.red{background:#e74c3c}
.tag{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:1px 6px;margin-left:0;font-size:11px}
.warns{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.kpiRight{display:flex;align-items:center;gap:8px}
.sel-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.sel-chips .chip .x{color:#999;cursor:pointer}

/* Modal Contacto */
.modal.contact{width:820px}
.contact-body .grid{grid-template-columns:1fr 1fr}
.contact-header{display:flex;gap:8px;align-items:center}
.contact-header select{border:1px solid var(--line);border-radius:10px;padding:5px 7px;font-size:12px}
.copybtn{border:1px solid var(--line);border-radius:8px;padding:5px 8px;background:#fff;cursor:pointer}
.copyrow{display:flex;gap:6px;align-items:center;margin-top:6px}

.footer{margin:16px 0 14px;text-align:center;color:#888;font-size:11px}
@media (max-width:980px){.board{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}.col{min-height:unset}}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo">U</div><div class="title">Unihouser ‚Äî CRM & BuyBox</div></div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuraci√≥n</a>
        <a id="btn-xls" href="javascript:void(0)">Exportar XLS</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div id="kpis" class="kpis"></div>
    <div id="board" class="board"></div>
  </div>

  <!-- Modal FICHA -->
  <div class="modal-back" id="mb">
    <div class="modal" role="dialog" aria-label="Ficha del cliente" aria-modal="true">
      <header>
        <h4 id="mh">Ficha</h4>
        <button class="close" id="mclose" title="Cerrar">√ó</button>
      </header>
      <div class="body" id="mbody"></div>
      <footer><button class="save" id="msave">Guardar</button></footer>
    </div>
  </div>

  <!-- Modal ASIGNACI√ìN -->
  <div class="modal-back" id="ab">
    <div class="modal small" role="dialog" aria-label="Asignar activos" aria-modal="true">
      <header>
        <h4 id="ah">Asignar activos (m√°x 4)</h4>
        <button class="close" id="aclose" title="Cerrar">√ó</button>
      </header>
      <div class="body" id="abody"></div>
      <footer><button class="save" id="asave">Guardar</button></footer>
    </div>
  </div>

  <!-- Modal CONTACTO -->
  <div class="modal-back" id="cb">
    <div class="modal contact" role="dialog" aria-label="Contactar" aria-modal="true">
      <header>
        <h4 id="ch">Contactar</h4>
        <button class="close" id="cclose" title="Cerrar">√ó</button>
      </header>
      <div class="body contact-body" id="cbody"></div>
      <footer><button class="save" id="csave">Cerrar</button></footer>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="footer">¬© 2025 Unihouser ¬∑ unihouser.es ¬∑ info@unihouser.es ¬∑ 644 300 200</div>

<script>
/* ========== Utils ========== */
const LS={get:(k,fb)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):fb}catch(_){return fb}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
const fmtEUR=n=>new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Math.round(+n||0));
const toThousands=v=>(Math.round(+v||0)).toLocaleString('es-ES');
function num(v){ if(typeof v==='number')return v; const s=String(v||'').replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,''); const n=parseFloat(s); return isNaN(n)?0:n; }
const h=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
function toast(msg,cls='ok',ms=1500){const t=document.getElementById('toast');t.className='toast '+cls;t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}

/* ========== Config normalizada ========== */
var CFG=(function(c){
  c=c&&typeof c==='object'?JSON.parse(JSON.stringify(c)):{};
  if(typeof c.notaria_eur==='number')c.notaria=c.notaria_eur;
  if(typeof c.psi_fee_eur==='number')c.honorarios=c.psi_fee_eur;
  if(typeof c.itp_pct==='number'&&c.itp_pct>1)c.itp_pct=c.itp_pct/100;
  c.itp_pct=(typeof c.itp_pct==='number')?c.itp_pct:.08;
  c.notaria=(typeof c.notaria==='number')?c.notaria:1200;
  c.honorarios=(typeof c.honorarios==='number')?c.honorarios:3630;
  c.localidades=Array.isArray(c.localidades)&&c.localidades.length?c.localidades:['Oviedo','Gij√≥n','Avil√©s','Mieres','Pola de Siero','Langreo','Goz√≥n'];
  c.objetivos=c.objetivos||{tradicional:{bruta_pct:10,neta_pct:6,flujo_mes_eur:0},habitaciones:{bruta_pct:12,neta_pct:7,flujo_mes_eur:0}};
  c.match=c.match||{thresholds:{green:1,amber:0.95},warnings_only_when_green:true};
  c.bruta=c.bruta||{include_honorarios_default:false};
  c.neta=c.neta||{include_honorarios_default:false};
  const pres=(c.presupuesto||{});
  if(typeof c.incluir_psi_por_defecto==='boolean' && pres.honorarios_incluidos_default==null){
    pres.honorarios_incluidos_default=c.incluir_psi_por_defecto;
  }
  if(pres.honorarios_incluidos_default==null) pres.honorarios_incluidos_default=true;
  c.presupuesto=pres;
  return c;
})(LS.get('cfg',{}));
LS.set('cfg',CFG);

/* ========== Datos ========== */
function allPros(){return LS.get('pros',[])||[]}
function savePros(a){LS.set('pros',a)}
let PROS=allPros().filter(p=>!p.archived);
const EVALS=LS.get('evals',[]);

/* ========== KPIs (solo n¬∫ de clientes y OK/KO por fase) ========== */
const PHASES=['CONTACTO','REUNION','CONTRATO','BUSQUEDA','COMPRAVENTA'];
function headerKPIs(){
  const wrap=document.getElementById('kpis'); wrap.innerHTML='';
  PHASES.concat('EXITOS').forEach(ph=>{
    const items = (ph==='EXITOS') ? allPros().filter(x=>x.archived&&x.archived_reason==='SUCCESS') : PROS.filter(x=>x.phase===ph);
    const ok=items.filter(p=>p.history&&p.history[ph]==='OK').length;
    const ko=items.filter(p=>p.history&&p.history[ph]==='KO').length;
    const box=document.createElement('div'); box.className='kpi';
    box.innerHTML='<div class="row"><span>'+h(ph)+'</span><span class="big">'+items.length+'</span></div>'+
                  '<div class="row"><small>OK: '+ok+' ¬∑ KO: '+ko+'</small><span></span></div>';
    wrap.appendChild(box);
  });
}

/* ========== Tarjetas y board ========== */
function daysInPhase(p){const t=p.phase_entered_at?+p.phase_entered_at:Date.now();return Math.max(0,Math.floor((Date.now()-t)/86400000))}
function shortDate(dt){ if(!dt) return ''; try{ const d=new Date(dt); const dd=('0'+d.getDate()).slice(-2); const mm=('0'+(d.getMonth()+1)).slice(-2); const hh=('0'+d.getHours()).slice(-2); const mi=('0'+d.getMinutes()).slice(-2); return dd+'/'+mm+' '+hh+':'+mi; }catch(_){ return ''; } }
function makeCreate(){
  const c=document.createElement('div'); c.className='create';
  c.innerHTML='<div class="row"><input id="new_name" placeholder="Nombre y apellidos" maxlength="30"/><input id="new_phone" placeholder="Tel√©fono" maxlength="9"/></div>'+
              '<input id="new_email" placeholder="Email" maxlength="35"/>'+
              '<button class="btn" id="btn_create">Crear contacto</button>'+
              '<small style="color:#777">Pon fecha en el modal para pasar a <b>Reuni√≥n</b>.</small>';
  return c;
}
function houseDots(p){
  const n=(p.busqueda&&Array.isArray(p.busqueda.propuestas))?p.busqueda.propuestas.length:0;
  let s='<span class="houses">'; for(let i=0;i<4;i++){ s+= i<n ? '<i class="on"></i>' : '<i></i>'; } return s+'</span>';
}
function makeCard(p){
  const el=document.createElement('div'); el.className='card'; el.draggable=true; el.dataset.id=p.id;
  const pr=p.profile||{}, age=daysInPhase(p), objt=(pr.objt||'neta').toLowerCase(), objtxt=(objt==='bruta'?'Rb%':(objt==='neta'?'Rn%':'Flujo'));
  const meetLabel=(p.phase==='REUNION' && p.meeting && p.meeting.date)?'<span class="badge">‚è∞ '+h(shortDate(p.meeting.date))+'</span>':'';
  const header='<header><div class="name">'+h(p.name||'‚Äî')+'</div><div class="age">‚è± '+age+' d√≠as</div></header>';
  const badges='<div class="badges"><span class="badge">üè∑ '+h(pr.tipo||'Tradicional')+'</span><span class="badge">üéØ '+objtxt+'</span>'+meetLabel+'</div>';
  let acts='<div class="actions">';
  acts+='<button class="btn-icon view" data-act="view" title="Ver / editar"><svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z"/><circle cx="12" cy="12" r="3"/></svg></button>';
  if(p.phase==='BUSQUEDA'){
    acts+='<button class="btn-icon assign" data-act="assign" title="Asignar activos (m√°x 4)"><svg viewBox="0 0 24 24"><path d="M4 17l6-6 4 4 6-6"/><path d="M3 7h7v7"/></svg></button>';
  }
  acts+='<button class="btn-icon contact" data-act="contact" title="Contactar"><svg viewBox="0 0 24 24"><path d="M4 4h16v12H4z"/><path d="M4 4l8 7 8-7"/></svg></button>';
  acts+='<button class="btn-icon ok" data-act="ok" title="Interesa (avanzar)"><svg viewBox="0 0 24 24"><path d="M20 6 9 17l-5-5"/></svg></button>';
  acts+='<button class="btn-icon ko" data-act="ko" title="No interesa (descartar)"><svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg></button>';
  if(p.phase==='CONTACTO'){
    acts+='<button class="btn-icon del" data-act="del" title="Eliminar contacto (sin traza)"><svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M6 6l1 14h10l1-14"/></svg></button>';
  }
  if(p.phase==='BUSQUEDA'){ acts+=houseDots(p); }
  acts+='</div>';
  el.innerHTML=header+badges+acts;
  return el;
}
function renderBoard(){
  const wrap=document.getElementById('board'); wrap.innerHTML='';
  PHASES.forEach(ph=>{
    const col=document.createElement('div'); col.className='col'; col.dataset.phase=ph;
    const items=PROS.filter(p=>p.phase===ph);
    const h3=document.createElement('h3'); h3.innerHTML='<span>'+h(ph)+'</span><span class="count">'+items.length+' clientes</span>';
    col.appendChild(h3);
    if(ph==='CONTACTO') col.appendChild(makeCreate());
    items.forEach(p=> col.appendChild(makeCard(p)) );
    wrap.appendChild(col);
  });
}

/* ========== Modal FICHA (reuni√≥n) ========== */
const MB=document.getElementById('mb'), MH=document.getElementById('mh'), MBODY=document.getElementById('mbody'); let MODAL_ID=null;
function moneyifyInput(el){ el.addEventListener('blur',()=>{ el.value = el.value? toThousands(num(el.value)) : ''; }); }

function recalcFinancials(){
  const total=num(MBODY.querySelector('#f_budget').value);
  const budIncl = MBODY.querySelector('#f_bud_incl').checked;
  let pmax=0, itp=0;
  if(total>0){
    if(budIncl){ pmax=Math.max(0, Math.round((total - CFG.notaria - CFG.honorarios)/(1+CFG.itp_pct))); }
    else{ pmax=Math.max(0, Math.round((total - CFG.notaria)/(1+CFG.itp_pct))); }
    itp=Math.round(pmax*CFG.itp_pct);
    MBODY.querySelector('#f_pmax').value = pmax?toThousands(pmax):'';
    MBODY.querySelector('#f_itp').value = itp?toThousands(itp):'';
  }else{
    MBODY.querySelector('#f_pmax').value='';
    MBODY.querySelector('#f_itp').value='';
  }

  const fin=MBODY.querySelector('#f_fin').value==='S√≠';
  const pct=num(MBODY.querySelector('#f_pct').value);
  let hip=0, prop=0;
  if(fin && pmax>0 && pct>0){ hip=Math.round(pmax*(pct/100)); prop=Math.max(0, total-hip); }
  else{ hip=0; prop=Math.max(0,total); }
  MBODY.querySelector('#f_hip').value=hip?toThousands(hip):'';
  MBODY.querySelector('#f_prop').value=prop?toThousands(prop):'';

  const objt=MBODY.querySelector('#f_objt').value;
  const objv=num(MBODY.querySelector('#f_objv').value);
  if(objt==='bruta' && total>0 && objv>0){
    const incluir=MBODY.querySelector('#f_inc_hon').checked;
    const base=incluir?total:(total-CFG.honorarios);
    const alq=Math.max(0,Math.round((objv/100)*base/12));
    MBODY.querySelector('#f_alq').value=alq?toThousands(alq):'';
  }else{
    MBODY.querySelector('#f_alq').value='';
  }
}

function openModal(p){
  MODAL_ID=p.id; MH.textContent=(p.name||'Ficha')+' ‚Äî Detalle';
  const pr=p.profile||{}, meet=p.meeting||{};
  const locs=Array.isArray(pr.locs)?pr.locs:(pr.locs?String(pr.locs).split(',').map(s=>s.trim()).filter(Boolean):[]);
  const budIncl = (typeof pr.budget_incl_honorarios==='boolean') ? pr.budget_incl_honorarios : !!CFG.presupuesto.honorarios_incluidos_default;

  let html='';
  /* DATOS PERSONALES ‚Äì 2 filas */
  html+='<div class="block"><h5>DATOS PERSONALES</h5><div class="grid">';
  html+='<div class="field"><label>Nombre y apellidos</label><input id="f_name" maxlength="30" value="'+h(p.name||'')+'"/></div>';
  html+='<div class="field"><label>Tel√©fono</label><input id="f_phone" maxlength="9" value="'+h(p.phone||'')+'"/></div>';
  html+='<div class="field"><label>Email</label><input id="f_email" type="email" maxlength="35" value="'+h(p.email||'')+'"/></div>';
  html+='<div class="field"><label>DNI/NIE</label><input id="f_dni" maxlength="10" value="'+h(pr.dni||'')+'"/></div>';
  html+='<div class="field row2"><label>Direcci√≥n</label><input id="f_dir" maxlength="120" value="'+h(pr.dir||'')+'"/></div>';
  html+='<div class="field"><label>Localidad</label><input id="f_locres" maxlength="10" value="'+h(pr.locres||'')+'"/></div>';
  html+='</div></div>';

  /* INVERSI√ìN ‚Äì 3 filas, compacta */
  html+='<div class="block"><h5>INVERSI√ìN</h5><div class="grid">';
  html+='<div class="field row2"><label>Localidades (m√°x 6)</label><div class="chips limit2" id="chips_locs">';
  for(let i=0;i<locs.length;i++){ html+='<span class="chip"><span class="t">'+h(locs[i])+'</span> <span class="x" data-del="'+h(locs[i])+'">√ó</span></span>'; }
  html+='</div><input class="chips-input" id="add_loc" list="cfg_locs" placeholder="A√±adir y Enter" maxlength="10"/></div>';
  html+='<datalist id="cfg_locs">'+(CFG.localidades.map(l=>'<option value="'+h(l)+'"></option>').join(''))+'</datalist>';
  html+='<div class="field"><label>Tipo</label><select id="f_tipo"><option'+((pr.tipo||'Tradicional')==='Tradicional'?' selected':'')+'>Tradicional</option><option'+((pr.tipo||'Tradicional')==='Habitaciones'?' selected':'')+'>Habitaciones</option></select></div>';
  html+='<div class="field"><label>Reforma</label><select id="f_ref"><option'+((pr.ref||'No')==='No'?' selected':'')+'>No</option><option'+((pr.ref||'No')==='Lavado de cara'?' selected':'')+'>Lavado de cara</option><option'+((pr.ref||'No')==='Integral'?' selected':'')+'>Integral</option></select></div>';
  html+='<div class="field"><label>Ascensor</label><select id="f_asc"><option'+((pr.asc||'No')==='S√≠'?' selected':'')+'>S√≠</option><option'+((pr.asc||'No')==='No'?' selected':'')+'>No</option></select></div>';
  html+='<div class="field"><label>Altura m√°x.</label><input id="f_alt" inputmode="numeric" maxlength="1" value="'+h(pr.alt||'')+'"/></div>';
  html+='<div class="field"><label>¬øBajos?</label><select id="f_bajos"><option'+((pr.bajos||'No')==='S√≠'?' selected':'')+'>S√≠</option><option'+((pr.bajos||'No')==='No'?' selected':'')+'>No</option></select></div>';
  html+='<div class="field"><label>Presupuesto (‚Ç¨)</label><input id="f_budget" value="'+(pr.budget?toThousands(pr.budget):'')+'"/></div>';
  html+='<div class="field"><label>P. m√°x / ITP</label><div style="display:flex;gap:6px"><input id="f_pmax" disabled style="width:50%" value="'+(pr.pmax?toThousands(pr.pmax):'')+'"/><input id="f_itp" disabled style="width:50%" value="'+(pr.itp?toThousands(pr.itp):'')+'"/></div><small><label><input type="checkbox" id="f_bud_incl"'+(budIncl?' checked':'')+'> Incluir honorarios en presupuesto</label></small></div>';
  html+='</div></div>';

  /* FINANCIACI√ìN */
  html+='<div class="block"><h5>FINANCIACI√ìN</h5><div class="grid5">';
  html+='<div class="field"><label>Financiaci√≥n</label><select id="f_fin"><option'+((pr.fin||'S√≠')==='S√≠'?' selected':'')+'>S√≠</option><option'+((pr.fin||'S√≠')==='No'?' selected':'')+'>No</option></select></div>';
  html+='<div class="field"><label>Broker</label><select id="f_broker"><option'+((pr.broker||'No')==='S√≠'?' selected':'')+'>S√≠</option><option'+((pr.broker||'No')==='No'?' selected':'')+'>No</option></select></div>';
  html+='<div class="field"><label>% fin.</label><input id="f_pct" maxlength="4" value="'+h(pr.pct||'80')+'"/></div>';
  html+='<div class="field"><label>Hipoteca</label><input id="f_hip" disabled value="'+(pr.hip?toThousands(pr.hip):'')+'"/></div>';
  html+='<div class="field"><label>Fondos</label><input id="f_prop" disabled value="'+(pr.prop?toThousands(pr.prop):'')+'"/></div>';
  html+='</div></div>';

  /* OBJETIVO */
  const objt=(pr.objt||'neta').toLowerCase();
  const inc=typeof pr.bruta_incluye_honorarios==='boolean'?pr.bruta_incluye_honorarios:!!CFG.bruta.include_honorarios_default;
  html+='<div class="block"><h5>OBJETIVO</h5><div class="grid">';
  html+='<div class="field"><label>Principal</label><select id="f_objt"><option value="bruta"'+(objt==='bruta'?' selected':'')+'>Rent. bruta (%)</option><option value="neta"'+(objt==='neta'?' selected':'')+'>Rent. neta (%)</option><option value="flujo"'+(objt==='flujo'?' selected':'')+'>Flujo (‚Ç¨/mes)</option></select></div>';
  html+='<div class="field"><label>Valor</label><input id="f_objv" maxlength="4" value="'+h(pr.objv||'')+'"/></div>';
  html+='<div class="field"><label>Alquiler orientativo</label><input id="f_alq" disabled value="'+(pr.alq?toThousands(pr.alq):'')+'"/></div>';
  html+='<div class="field row3"><label><input type="checkbox" id="f_inc_hon"'+(inc?' checked':'')+'> Incluir honorarios en Bruta</label></div>';
  html+='</div></div>';

  /* REUNI√ìN / NOTAS */
  html+='<div class="block"><h5>REUNI√ìN / NOTAS</h5><div class="grid">';
  if(p.phase==='CONTACTO'){
    html+='<div class="field"><label>Fecha y hora</label><input id="f_meet" type="datetime-local" value="'+h(meet.date||'')+'"/></div><div class="field row2"></div>';
  }else{
    const fv = meet.date? shortDate(meet.date) : '';
    html+='<div class="field"><label>Fecha y hora</label><input id="f_meet_ro" value="'+h(fv)+'" disabled/></div><div class="field row2"></div>';
  }
  html+='<div class="field row3"><label>Notas (m√°x 300)</label><textarea id="f_notas" rows="2" maxlength="300" style="line-height:1.3">'+h(meet.notas||'')+'</textarea></div>';
  html+='</div></div>';

  MBODY.innerHTML=html;

  /* chips localidades */
  const chipsWrap=MBODY.querySelector('#chips_locs');
  if(chipsWrap){ chipsWrap.onclick=(e)=>{ const del=e.target.getAttribute('data-del'); if(!del)return; e.target.parentElement.remove(); }; }
  const add=MBODY.querySelector('#add_loc');
  if(add){ add.onkeydown=(e)=>{ if(e.key==='Enter'){e.preventDefault(); const v=(add.value||'').trim(); if(!v)return;
      const cont=MBODY.querySelector('#chips_locs');
      if(cont.querySelectorAll('.chip').length>=6){toast('M√°ximo 6 localidades','warn');return;}
      const s=document.createElement('span'); s.className='chip'; s.innerHTML='<span class="t">'+h(v)+'</span> <span class="x" data-del="'+h(v)+'">√ó</span>';
      cont.appendChild(s); add.value=''; } }; }

  /* money blur y c√°lculos */
  ['#f_budget','#f_pct'].forEach(sel=>{const el=MBODY.querySelector(sel); if(el) moneyifyInput(el);});
  ['#f_budget','#f_pct','#f_objt','#f_objv','#f_fin','#f_inc_hon','#f_bud_incl'].forEach(sel=>{const el=MBODY.querySelector(sel); if(el) el.addEventListener('input',recalcFinancials);});
  recalcFinancials();

  MB.style.display='flex';
}
function closeModal(){MB.style.display='none'; MODAL_ID=null;}
function saveModal(){
  if(!MODAL_ID) return;
  let list=allPros(); const i=list.findIndex(x=>x.id===MODAL_ID); if(i<0) return;
  const p=list[i]; const pr=p.profile||(p.profile={}); const q=sel=>MBODY.querySelector(sel);
  p.name=q('#f_name').value.trim(); p.phone=q('#f_phone').value.trim(); p.email=q('#f_email').value.trim();
  pr.dni=q('#f_dni').value.trim(); pr.dir=q('#f_dir').value.trim(); pr.locres=q('#f_locres').value.trim();
  pr.locs=[...MBODY.querySelectorAll('#chips_locs .chip .t')].map(n=>n.textContent.trim());
  pr.tipo=q('#f_tipo').value; pr.ref=q('#f_ref').value; pr.asc=q('#f_asc').value; pr.alt=q('#f_alt').value; pr.bajos=q('#f_bajos').value;
  pr.budget=num(q('#f_budget').value); pr.pmax=num(q('#f_pmax').value); pr.itp=num(q('#f_itp').value);
  pr.budget_incl_honorarios=!!q('#f_bud_incl').checked;
  pr.fin=q('#f_fin').value; pr.broker=q('#f_broker').value; pr.pct=q('#f_pct').value;
  pr.hip=num(q('#f_hip').value); pr.prop=num(q('#f_prop').value);
  pr.objt=q('#f_objt').value; pr.objv=num(q('#f_objv').value);
  pr.bruta_incluye_honorarios=!!q('#f_inc_hon').checked;
  pr.alq=num(q('#f_alq').value);
  p.meeting=p.meeting||{}; p.meeting.notas=q('#f_notas').value.slice(0,300);
  if(p.phase==='CONTACTO'){
    const dt=q('#f_meet').value; if(dt){ p.meeting.date=dt; p.phase='REUNION'; p.phase_entered_at=Date.now(); p.history=p.history||{}; p.history.CONTACTO='OK'; }
  }
  list[i]=p; savePros(list); PROS=list.filter(x=>!x.archived);
  toast('Guardado','ok'); closeModal(); headerKPIs(); renderBoard();
}

/* ========== Matching helpers ========== */
function adaptEval(ev){
  const n=x=>num(x);
  const o={};
  o.id=ev.id||ev.ev_id||('ev_'+Math.random().toString(36).slice(2,8));
  o.titulo=ev.titulo||ev.title||ev.nombre||ev.direccion||ev.dir||ev.ref||('Evaluaci√≥n '+o.id);
  o.localidad=ev.localidad||ev.municipio||'';
  o.tipo=ev.tipo||ev.alquiler_tipo||'Tradicional';
  o.precio=n(ev.precio_compra??ev.precio??ev.p_venta);
  let ing_m=n(ev.ing_m??ev.alquiler_mensual??ev.renta_mensual);
  let ing_a=n(ev.ing_a??ev.ingresos_anuales);
  let gas_m=n(ev.gas_m??ev.gastos_mensuales);
  let gas_a=n(ev.gas_a??ev.gastos_anuales);
  if(!ing_a && ing_m) ing_a=ing_m*12;
  if(!ing_m && ing_a) ing_m=Math.round(ing_a/12);
  if(!gas_a && gas_m) gas_a=gas_m*12;
  if(!gas_m && gas_a) gas_m=Math.round(gas_a/12);
  o.ing_m=ing_m; o.ing_a=ing_a; o.gas_m=gas_m; o.gas_a=gas_a;
  o.flujo_m = ev.flujo_m!=null ? n(ev.flujo_m) : (ing_m - gas_m);
  o.ascensor=(ev.ascensor===true||ev.ascensor==='S√≠'||ev.ascensor==='si');
  o.bajos=(ev.bajos===true||ev.planta===0||ev.es_bajo===true);
  o.altura=parseInt(ev.altura!=null?ev.altura:(ev.planta!=null?ev.planta:''),10)||0;
  let ref=(ev.reforma||ev.reforma_tipo||'No'); if(!['No','Lavado de cara','Integral'].includes(ref)) ref='No';
  o.reforma=ref;
  o.hab=parseInt(ev.habitaciones||ev.habs||ev.dormitorios||ev.num_habitaciones||0,10)||0;
  return o;
}
function clientObjective(p){
  const pr=p.profile||{}; const objt=(pr.objt||'neta').toLowerCase();
  let objv=num(pr.objv||0);
  if(!objv || objv<=0){
    const tipo=(pr.tipo||'Tradicional').toLowerCase();
    const def = (tipo==='habitaciones'? CFG.objetivos.habitaciones : CFG.objetivos.tradicional);
    objv = (objt==='bruta') ? def.bruta_pct : (objt==='neta') ? def.neta_pct : def.flujo_mes_eur;
  }
  return {objt,objv};
}
function scoreEvalForPros(evRaw, p){
  const ev = adaptEval(evRaw);
  const pr = p.profile || {};
  const {objt, objv} = clientObjective(p);

  /* ¬øIncluir honorarios en base? depende del flag del cliente */
  const incBruta = !!pr.bruta_incluye_honorarios || !!pr.budget_incl_honorarios;
  const incNeta  = (typeof pr.neta_incluye_honorarios==='boolean') ? pr.neta_incluye_honorarios
                   : !!CFG.neta.include_honorarios_default || !!pr.budget_incl_honorarios;

  const itp     = Math.round((CFG.itp_pct ?? 0.08) * (ev.precio || 0));
  const notaria = CFG.notaria || 1200;
  const honor   = CFG.honorarios || 0;

  const baseBruta = (ev.precio||0) + itp + notaria + (incBruta ? honor : 0);
  const baseNeta  = (ev.precio||0) + itp + notaria + (incNeta  ? honor : 0);

  const rb = baseBruta>0 ? (((ev.ing_a||0) / baseBruta) * 100) : 0;
  const rn = baseNeta>0  ? ((((ev.ing_a||0)-(ev.gas_a||0)) / baseNeta) * 100) : 0;
  const fl = (typeof ev.flujo_m === 'number') ? ev.flujo_m : ((ev.ing_m||0)-(ev.gas_m||0));

  const kpi = (objt==='bruta') ? rb : (objt==='neta') ? rn : fl;
  const target = Number(objv||0);
  const ratio  = target>0 ? (kpi/target) : 0;
  return { ev, rb, rn, fl, kpi, objt, objv:target, ratio };
}
function colorForRatio(r){
  const th=CFG.match?.thresholds||{green:1,amber:0.95};
  if(r>=(th.green??1)) return 'green';
  if(r>=(th.amber??0.95)) return 'amber';
  return 'red';
}
function warningsFor(ev,p){
  const pr=p.profile||{};
  const warns=[];
  const locs=(Array.isArray(pr.locs)?pr.locs:[]).map(x=>String(x).toLowerCase());
  if(locs.length && !locs.includes(String(ev.localidad||'').toLowerCase())) warns.push('üìç localidad');
  if(pr.tipo && ev.tipo && pr.tipo!==ev.tipo) warns.push('üè∑ tipo');
  if(pr.asc==='S√≠' && !ev.ascensor) warns.push('üõó ascensor');
  if(pr.alt && ev.altura>num(pr.alt)) warns.push('‚¨Ü planta');
  if(pr.bajos==='No' && ev.bajos) warns.push('‚¨á bajos');
  const rank={'No':0,'Lavado de cara':1,'Integral':2};
  if(rank[ev.reforma]>rank[pr.ref||'No']) warns.push('üîß reforma');
  return warns;
}

/* ========== Modal ASIGNACI√ìN ========== */
const AB=document.getElementById('ab'), ABODY=document.getElementById('abody'); let ASSIGN_ID=null;

function renderAssignList(p){
  const guardadas = (p.busqueda && Array.isArray(p.busqueda.propuestas)) ? p.busqueda.propuestas : [];
  const guardadasSet = new Set(guardadas.map(x => (typeof x==='string'? x : x.ev_id)));

  let html = '';
  /* Seleccionadas */
  html += '<div class="block"><h5>Seleccionadas</h5><div class="sel-chips" id="selchips">';
  guardadasSet.forEach(id=>{
    const raw = EVALS.find(e=>e.id===id) || {titulo:id};
    const ev  = adaptEval(raw);
    html += '<span class="chip" data-ev="'+h(id)+'"><span class="t">'+h(ev.titulo||id)+'</span> <span class="x" data-un="'+h(id)+'">√ó</span></span>';
  });
  html += '</div></div>';

  /* Lista */
  html += '<div class="block"><h5 style="margin:0">Evaluaciones disponibles</h5><div class="eval-list" id="evlist">';
  if(!EVALS.length){
    html += '<div class="eval-item"><span>No hay evaluaciones en el sistema</span></div>';
  }else{
    const scored = EVALS.map(ev => scoreEvalForPros(ev, p)).sort((a,b)=>b.ratio-a.ratio);
    scored.forEach(s=>{
      const ev    = adaptEval(s.ev);
      const color = colorForRatio(s.ratio);
      const warns = (color==='green' && CFG.match.warnings_only_when_green) ? warningsFor(ev,p) : [];
      const checked = guardadasSet.has(ev.id) ? 'checked' : ''; // solo las ya guardadas
      const semillas = [
        (ev.ascensor?'üõó S√≠':'üõó No'),
        ('Pl: '+(ev.altura||0)),
        ('üõè '+(ev.hab||'-')),
        ('üîß '+ev.reforma)
      ].map(t=>'<span class="tag">'+h(t)+'</span>').join('');
      html += '<label class="eval-item">'+
                '<div>'+
                  '<div class="eval-title"><span class="dot '+color+'"></span><span>'+h(ev.titulo)+'</span>'+semillas+'</div>'+
                  (warns.length?('<div class="warns">'+warns.map(w=>'<span class="tag">'+h(w)+'</span>').join('')+'</div>'):'')+
                '</div>'+
                '<div class="kpiRight">'+
                  '<span class="tag">'+h(fmtEUR(ev.precio||0))+'</span>'+
                  '<input type="checkbox" data-ev="'+h(ev.id)+'" '+checked+'>'+
                '</div>'+
              '</label>';
    });
  }
  html += '</div></div>';

  ABODY.innerHTML = html;

  // Quitar chip -> desmarcar
  ABODY.onclick = e=>{
    const id = e.target.getAttribute && e.target.getAttribute('data-un');
    if(!id) return;
    const chip = e.target.closest('.chip'); if(chip) chip.remove();
    const chk = ABODY.querySelector('input[type="checkbox"][data-ev="'+CSS.escape(id)+'"]');
    if(chk) chk.checked = false;
  };
  // Marcar check -> a√±adir chip (m√°x 4)
  ABODY.onchange = e=>{
    const el = e.target;
    if(el.tagName!=='INPUT' || el.type!=='checkbox') return;
    const id = el.getAttribute('data-ev');
    const wrap = ABODY.querySelector('#selchips');
    const exists = wrap.querySelector('.chip[data-ev="'+CSS.escape(id)+'"]');
    const chips  = wrap.querySelectorAll('.chip');
    if(el.checked){
      if(chips.length>=4){ el.checked=false; toast('M√°ximo 4 activos','warn'); return; }
      if(!exists){
        const raw = EVALS.find(x=>x.id===id) || {titulo:id};
        const ev  = adaptEval(raw);
        const chip = document.createElement('span'); chip.className='chip'; chip.setAttribute('data-ev',id);
        chip.innerHTML = '<span class="t">'+h(ev.titulo||id)+'</span> <span class="x" data-un="'+h(id)+'">√ó</span>';
        wrap.appendChild(chip);
      }
    }else{
      if(exists) exists.remove();
    }
  };
}

/* Preselecci√≥n autom√°tica: primero VERDES, luego √ÅMBAR, luego top */
function autoMatchPreselect(p){
  const ya = (p.busqueda && Array.isArray(p.busqueda.propuestas) && p.busqueda.propuestas.length>0);
  if(ya || !EVALS.length) return;

  const scored = EVALS.map(ev=>scoreEvalForPros(ev,p)).sort((a,b)=>b.ratio-a.ratio);
  const th = CFG.match?.thresholds || {green:1,amber:0.95};
  const chosen=[];
  // Verdes primero
  for(const r of scored){ if(chosen.length>=4) break; if(r.ratio >= (th.green??1)) chosen.push(r.ev.id||r.ev.ev_id); }
  // Luego √°mbar
  for(const r of scored){ if(chosen.length>=4) break; if(r.ratio >= (th.amber??0.95) && !chosen.includes(r.ev.id||r.ev.ev_id)) chosen.push(r.ev.id||r.ev.ev_id); }
  // Si no llega, completa con mejores
  for(const r of scored){ if(chosen.length>=4) break; const id=r.ev.id||r.ev.ev_id; if(!chosen.includes(id)) chosen.push(id); }

  const evlist = ABODY.querySelector('#evlist');
  const sel    = ABODY.querySelector('#selchips');
  if(!evlist || !sel) return;
  sel.innerHTML='';
  [...evlist.querySelectorAll('input[type="checkbox"]')].forEach(chk=>{
    const id = chk.getAttribute('data-ev');
    const pick = chosen.includes(id);
    chk.checked = pick;
    if(pick){
      const raw = EVALS.find(x=>x.id===id) || {titulo:id};
      const ev  = adaptEval(raw);
      const chip = document.createElement('span'); chip.className='chip'; chip.setAttribute('data-ev',id);
      chip.innerHTML = '<span class="t">'+h(ev.titulo||id)+'</span> <span class="x" data-un="'+h(id)+'">√ó</span>';
      sel.appendChild(chip);
    }
  });
}

function openAssignModal(p){
  ASSIGN_ID=p.id;
  renderAssignList(p);
  autoMatchPreselect(p);
  AB.style.display='flex';
}
function closeAssignModal(){ AB.style.display='none'; ASSIGN_ID=null; ABODY.onclick=null; ABODY.onchange=null; }
function saveAssignModal(){
  if(!ASSIGN_ID) return;
  let list=allPros(); const i=list.findIndex(x=>x.id===ASSIGN_ID); if(i<0) return;
  const p=list[i];
  const chips=[...ABODY.querySelectorAll('#selchips .chip')].map(ch=>ch.getAttribute('data-ev'));
  p.busqueda=p.busqueda||{}; p.busqueda.propuestas=chips.slice(0,4);
  list[i]=p; savePros(list); PROS=list.filter(x=>!x.archived);
  toast('Propuestas actualizadas','ok'); closeAssignModal(); headerKPIs(); renderBoard();
}

/* ========== Modal CONTACTO ========== */
const CB=document.getElementById('cb'), CBODY=document.getElementById('cbody'); let CONTACT_ID=null;
function fillTemplate(tpl, p, ev){
  const pr=p.profile||{};
  const nombre=p.name||'';
  const localidad=ev?.localidad || (Array.isArray(pr.locs)&&pr.locs[0]||'');
  const calle=ev?.titulo || '';
  const precio=fmtEUR(ev?.precio||0);
  const alquiler=fmtEUR(ev?.ing_m||0);
  const pmax=pr.pmax?fmtEUR(pr.pmax):'';
  const link=ev?.link || '#';
  return (tpl||'')
    .replaceAll('{NOMBRE}', nombre)
    .replaceAll('{LOCALIDAD}', localidad)
    .replaceAll('{CALLE}', calle)
    .replaceAll('{PRECIO}', precio)
    .replaceAll('{ALQUILER}', alquiler)
    .replaceAll('{P_MAX}', pmax)
    .replaceAll('{LINK}', link);
}
function openContactModal(p){
  CONTACT_ID=p.id;
  const cfgCom=CFG.comms||{};
  const propuestas=(p.busqueda&&Array.isArray(p.busqueda.propuestas))?p.busqueda.propuestas:[];
  const evs=propuestas.map(id=>EVALS.find(e=>e.id===id)).filter(Boolean).map(adaptEval);
  const selectHtml = evs.length
    ? '<label>Activo</label><select id="c_ev">'+ evs.map((e,i)=>'<option value="'+h(e.id)+'">'+h(e.titulo)+'</option>').join('') +'</select>'
    : '<div style="color:#888">No hay activos asignados. Puedes enviar mensaje gen√©rico.</div>';
  const ev0 = evs[0] || null;
  const mailSubj = fillTemplate(cfgCom.mail_subj || 'Oportunidad en {LOCALIDAD}: {CALLE}', p, ev0);
  const mailBody = fillTemplate(cfgCom.mail_body || 'Hola {NOMBRE},\nTe encaja este piso en {LOCALIDAD}, {CALLE}? Precio {PRECIO}, alquiler {ALQUILER}. P. m√°x compra {P_MAX}.\n{LINK}', p, ev0);
  const waBody   = fillTemplate(cfgCom.wa_body   || 'Hola {NOMBRE}! Mira este activo: {CALLE}, {LOCALIDAD}. {LINK}', p, ev0);

  let html='';
  html += '<div class="block"><div class="contact-header">'+selectHtml+'</div></div>';
  html += '<div class="grid">';
  html +=   '<div class="block"><h5>WhatsApp</h5><div class="field"><label>Mensaje</label><textarea id="wa_txt" rows="8">'+h(waBody)+'</textarea></div>'+
            '<div class="copyrow"><button class="copybtn" id="wa_copy">Copiar</button>'+
            (p.phone?('<a class="copybtn" id="wa_open" target="_blank" rel="noopener">Abrir WhatsApp</a>'):'')+
            '</div></div>';
  html +=   '<div class="block"><h5>Email</h5><div class="field"><label>Asunto</label><input id="em_subj" value="'+h(mailSubj)+'"/></div>'+
            '<div class="field"><label>Cuerpo</label><textarea id="em_body" rows="8">'+h(mailBody)+'</textarea></div>'+
            '<div class="copyrow"><button class="copybtn" id="em_copy">Copiar</button></div></div>';
  html += '</div>';

  CBODY.innerHTML=html;
  // listeners din√°micos
  const sel=CBODY.querySelector('#c_ev');
  function refreshWith(id){
    const ev = (id && EVALS.find(e=>e.id===id)) ? adaptEval(EVALS.find(e=>e.id===id)) : null;
    CBODY.querySelector('#wa_txt').value = fillTemplate(cfgCom.wa_body || 'Hola {NOMBRE}! Mira este activo: {CALLE}, {LOCALIDAD}. {LINK}', p, ev);
    CBODY.querySelector('#em_subj').value= fillTemplate(cfgCom.mail_subj || 'Oportunidad en {LOCALIDAD}: {CALLE}', p, ev);
    CBODY.querySelector('#em_body').value= fillTemplate(cfgCom.mail_body || 'Hola {NOMBRE},\nTe encaja este piso en {LOCALIDAD}, {CALLE}? Precio {PRECIO}, alquiler {ALQUILER}. P. m√°x compra {P_MAX}.\n{LINK}', p, ev);
    const waOpen=CBODY.querySelector('#wa_open');
    if(waOpen && p.phone){
      const text=encodeURIComponent(CBODY.querySelector('#wa_txt').value);
      const tel = String(p.phone).replace(/[^\d]/g,'');
      waOpen.href='https://wa.me/'+tel+'?text='+text;
    }
  }
  if(sel){ sel.onchange=()=>refreshWith(sel.value); refreshWith(sel.value); } else { refreshWith(null); }

  const copy=(id)=>{ const el=CBODY.querySelector(id); el.select(); el.setSelectionRange(0,99999); document.execCommand('copy'); toast('Copiado','ok'); };
  const waCopy=CBODY.querySelector('#wa_copy'); if(waCopy) waCopy.onclick=()=>copy('#wa_txt');
  const emCopy=CBODY.querySelector('#em_copy'); if(emCopy) emCopy.onclick=()=>copy('#em_body');

  document.getElementById('cb').style.display='flex';
}
function closeContactModal(){ document.getElementById('cb').style.display='none'; CONTACT_ID=null; CBODY.innerHTML=''; }

/* ========== Eventos globales ========== */
document.addEventListener('click',e=>{
  /* FICHA */
  if(e.target.id==='mclose'){ closeModal(); return; }
  if(e.target.id==='msave'){ saveModal(); return; }

  /* ASIGNACI√ìN */
  if(e.target.id==='aclose'){ closeAssignModal(); return; }
  if(e.target.id==='asave'){ saveAssignModal(); return; }

  /* CONTACTO */
  if(e.target.id==='cclose' || e.target.id==='csave'){ closeContactModal(); return; }

  /* Crear contacto */
  if(e.target.id==='btn_create'){
    const name=document.getElementById('new_name').value.trim();
    const phone=document.getElementById('new_phone').value.trim();
    const email=document.getElementById('new_email').value.trim();
    if(!name||!phone){toast('Nombre y tel√©fono son obligatorios','warn');return;}
    let list=allPros();
    const p={id:'p_'+Math.random().toString(36).slice(2,8),name,phone,email,phase:'CONTACTO',phase_entered_at:Date.now(),history:{},profile:{tipo:'Tradicional',objt:'neta',objv:6,budget_incl_honorarios:CFG.presupuesto.honorarios_incluidos_default}};
    list.push(p); savePros(list); PROS=list.filter(x=>!x.archived); toast('Contacto creado','ok'); headerKPIs(); renderBoard(); return;
  }

  /* Botones de tarjeta (delegaci√≥n robusta) */
  const btn=e.target.closest('.btn-icon'); if(!btn) return;
  const id=btn.closest('.card').dataset.id;
  let list=allPros(); const i=list.findIndex(x=>x.id===id); if(i<0)return;
  const p=list[i]; const act=btn.dataset.act;

  if(act==='view'){ openModal(p); return; }
  if(act==='assign' && p.phase==='BUSQUEDA'){ openAssignModal(p); return; }
  if(act==='contact'){ openContactModal(p); return; }

  if(act==='ok'){
    const ph=p.phase; const idx=PHASES.indexOf(ph);
    p.history=p.history||{}; p.history[ph]='OK';
    if(ph==='COMPRAVENTA'){ p.archived=true; p.archived_reason='SUCCESS'; }
    else if(idx<PHASES.length-1){ p.phase=PHASES[idx+1]; p.phase_entered_at=Date.now(); }
    list[i]=p; savePros(list); PROS=list.filter(x=>!x.archived); toast('Avanzado','ok'); headerKPIs(); renderBoard(); return;
  }
  if(act==='ko'){
    const ph2=p.phase; p.history=p.history||{}; p.history[ph2]='KO';
    if(ph2==='CONTACTO'){ list=list.filter(x=>x.id!==p.id); }
    else{ p.archived=true; p.archived_reason='KO'; list[i]=p; }
    savePros(list); PROS=list.filter(x=>!x.archived); toast('Descartado','bad'); headerKPIs(); renderBoard(); return;
  }
  if(act==='del' && p.phase==='CONTACTO'){
    list=list.filter(x=>x.id!==p.id); savePros(list); PROS=list.filter(x=>!x.archived); toast('Eliminado','bad'); headerKPIs(); renderBoard(); return;
  }
});

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if(MB.style.display==='flex'){ closeModal(); return; }
    if(AB.style.display==='flex'){ closeAssignModal(); return; }
    if(document.getElementById('cb').style.display==='flex'){ closeContactModal(); return; }
  }
});

/* Drag & drop */
let dragId=null;
document.addEventListener('dragstart',e=>{const c=e.target.closest('.card'); if(!c)return; dragId=c.dataset.id; c.classList.add('dragging');});
document.addEventListener('dragend',e=>{const c=e.target.closest('.card'); if(c)c.classList.remove('dragging'); document.querySelectorAll('.col.drop').forEach(x=>x.classList.remove('drop'));});
document.addEventListener('dragover',e=>{const col=e.target.closest('.col'); if(!col)return; e.preventDefault(); col.classList.add('drop');});
document.addEventListener('dragleave',e=>{const col=e.target.closest('.col'); if(col) col.classList.remove('drop');});
document.addEventListener('drop',e=>{
  const col=e.target.closest('.col'); if(!col||!dragId) return;
  let list=allPros(); const i=list.findIndex(x=>x.id===dragId); if(i<0) return;
  const p=list[i]; const to=col.dataset.phase;
  if(p.phase!==to){ p.phase=to; p.phase_entered_at=Date.now(); list[i]=p; savePros(list); PROS=list.filter(x=>!x.archived); headerKPIs(); renderBoard(); toast('Movido','ok'); }
});

/* Export CSV */
document.getElementById('btn-xls').addEventListener('click',function(){
  const all=allPros(); const rows=[];
  rows.push(['id','nombre','email','tel','fase','ok_contacto','ok_reunion','ok_contrato','ok_busqueda','ok_compraventa','archivado','motivo','propuestas'].join(';'));
  all.forEach(p=>{
    const hst=p.history||{}, props=(p.busqueda&&p.busqueda.propuestas)?p.busqueda.propuestas.length:0;
    rows.push([p.id, (p.name||'').replace(/;/g,','), (p.email||'').replace(/;/g,','), (p.phone||'').replace(/;/g,','), p.phase||'',
      hst.CONTACTO||'', hst.REUNION||'', hst.CONTRATO||'', hst.BUSQUEDA||'', hst.COMPRAVENTA||'', !!p.archived, p.archived_reason||'', props].join(';'));
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='unihouser_prospectos.csv'; a.click(); URL.revokeObjectURL(a.href);
  toast('CSV exportado','ok');
});

/* Init demo si est√° vac√≠o */
(function(){
  if(!PROS.length){
    PROS=[{id:'p_demo',name:'Cliente demo',phone:'',email:'',phase:'CONTACTO',phase_entered_at:Date.now(),profile:{tipo:'Tradicional',objt:'neta',objv:6,budget_incl_honorarios:CFG.presupuesto.honorarios_incluidos_default},history:{}}];
    savePros(PROS);
  }
  headerKPIs(); renderBoard();
})();
</script>
</body>
</html>
