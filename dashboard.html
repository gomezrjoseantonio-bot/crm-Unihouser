<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Unihouser ‚Äî Dashboard CRM</title>

  <style>
    :root{
      --naranja:#c7530c;  /* Naranja vivo */
      --granate:#B53928;
      --verde:#58736F;
      --gris:#DDD5D2;

      --card:#ffffff;
      --texto:#2b2b2b;
      --muted:#7a6f6b;
      --bg:#faf8f7;

      --shadow:0 10px 26px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--texto);
      background:linear-gradient(180deg,var(--gris) 0%, var(--bg) 24%);
    }

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .container{max-width:1200px;margin:0 auto;padding:10px 16px}
    .flex{display:flex;gap:12px}
    .between{justify-content:space-between}
    .center{align-items:center}
    .brand img{height:28px}
    .title{font-weight:700;margin-left:8px}
    .nav a{padding:8px 10px;border-radius:10px;text-decoration:none;color:#4a3f3b}
    .nav a.active{background:rgba(199,83,12,.16);color:var(--naranja)}
    .actions-top{display:flex;gap:8px;align-items:center}

    /* Controles */
    input,select,textarea,button{
      font:inherit;
      border:1px solid #d8cfca;
      border-radius:8px;
      padding:4px 8px;
      background:#fff;
      color:#2b2b2b;
      outline:none;
      height:28px;         /* m√°s compacto */
    }
    label{font-size:12px;color:#4d4542}
    small.small{font-size:11px;color:#7a6f6b}
    textarea{height:28px}
    button{cursor:pointer;background:#fff}
    .primary{background:var(--naranja);color:#fff;border-color:transparent}
    .bad{background:var(--granate);color:#fff;border-color:transparent}
    .ok{background:var(--verde);color:#fff;border-color:transparent}
    .circle{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;border:1px solid #eadfd9;background:#fff}
    .circle.ok{background:rgba(88,115,111,.12);color:#2e4743;border-color:rgba(88,115,111,.25)}
    .circle.ko{background:rgba(181,57,40,.12);color:#7f2b20;border-color:rgba(181,57,40,.25)}

    /* KPIs */
    .kpis{margin:14px 16px 18px;display:grid;grid-template-columns:repeat(6,minmax(160px,1fr));gap:12px}
    .kpi{background:var(--card);border-radius:14px;padding:8px 10px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:2px}
    .kpi h3{font-size:12px;margin:0;font-weight:800;letter-spacing:.3px;text-transform:uppercase}
    .kpi .row{display:flex;justify-content:space-between;align-items:baseline}
    .kpi b{font-size:20px}
    .kpi .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#f1ece9}
    .kpi.ok .pill{background:rgba(88,115,111,.12);color:var(--verde)}
    .kpi.warn .pill{background:rgba(199,83,12,.18);color:var(--naranja)}
    .kpi.bad .pill{background:rgba(181,57,40,.12);color:var(--granate)}

    /* Board */
    .board{padding:0 16px 40px;display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
    .col{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);min-height:60vh;display:flex;flex-direction:column}
    .col header{padding:10px 12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .col header h2{margin:0;font-size:14px;text-transform:uppercase;letter-spacing:.6px}
    .content{padding:10px;display:flex;flex-direction:column;gap:10px}
    .new-contact{border:1px dashed #c9beb9;border-radius:12px;padding:10px;background:#fbf9f8;display:flex;flex-direction:column;gap:8px}

    /* Card */
    .card{border:1px solid #eee3de;border-radius:14px;padding:10px;background:#fff;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:6px}
    .card .top{display:flex;justify-content:space-between;align-items:center}
    .name{font-weight:800;display:flex;align-items:center;gap:6px}
    .grip{width:16px;height:16px;border-radius:4px;background:rgba(199,83,12,.15);border:1px solid rgba(199,83,12,.35);display:inline-flex;align-items:center;justify-content:center;cursor:grab}
    .grip:before{content:'‚â°';font-size:12px;color:#8b3c05;line-height:1}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:12px;background:#fff4ec;border:1px solid #ffd8bf;color:#a04f26;border-radius:999px;padding:3px 8px;display:inline-flex;gap:6px;align-items:center}
    .badge.gray{background:#f3efed;border:1px solid #eadfd9;color:#544a46}
    .days{font-size:12px;color:#6f6460}
    .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .iconbtn{display:inline-flex;gap:6px;align-items:center;padding:4px 6px;border-radius:10px;border:1px solid #eadfd9;background:#fff;height:28px}
    .houses{display:flex;gap:4px}
    .house{width:12px;height:12px;border-radius:3px;background:#e8e1dc;border:1px solid #d8cfca}
    .house.on{background:var(--naranja);border-color:#a64708}
    .small{font-size:12px;color:var(--muted)}

    /* Toasts */
    .toaster{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:8px;z-index:400}
    .toast{background:#fff;border-left:6px solid var(--verde);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);min-width:260px}
    .toast.warn{border-left-color:var(--naranja)}
    .toast.bad{border-left-color:var(--granate)}

    /* Modal (sin scroll) */
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.2s;z-index:250}
    #overlay.open{opacity:1;pointer-events:auto}
    #modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:300;pointer-events:none}
    #modal .sheet{
      width:1024px;max-width:96vw;background:#fff;border-radius:18px;
      box-shadow:0 30px 60px rgba(0,0,0,.2);transform:translateY(12px) scale(.98);
      opacity:0;transition:.22s;pointer-events:auto;display:flex;flex-direction:column;max-height:92vh
    }
    #modal.open .sheet{transform:none;opacity:1}
    .sheet header{padding:8px 12px;border-bottom:2px solid rgba(199,83,12,.25);display:flex;justify-content:space-between;align-items:center;background:#fff}
    .sheet h3{margin:0;font-size:15px}
    .sheet .body{padding:8px;display:flex;flex-direction:column;gap:8px;overflow:hidden}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .grid.two{grid-template-columns:repeat(2,1fr)}
    .group{border:1px solid #ffe1ce;background:#fff7f2;border-radius:12px;padding:8px}
    .group h4{margin:0 0 4px 0;font-size:11px;text-transform:uppercase;letter-spacing:.4px;color:#a04f26}
    .sheet footer{position:sticky;bottom:0;background:#fff;border-top:2px solid rgba(199,83,12,.25);padding:8px 12px;display:flex;justify-content:flex-end;gap:8px}

    /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:#f3efed;border:1px solid #eadfd9;border-radius:999px;padding:3px 7px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
    .chip button{border:none;background:transparent;cursor:pointer}

    /* Listado evaluaciones */
    .eval-list{display:flex;flex-direction:column;gap:6px;max-height:32vh;overflow:auto;border:1px dashed #eadfd9;border-radius:10px;padding:6px}
    .eval-item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:6px;border:1px solid #f0e6e1;border-radius:10px;background:#fff}
    .eval-title{font-weight:600}
    .match.ok{color:#2e4743}.match.bad{color:#7f2b20}.match.warn{color:#a86f00}

    /* Drag feedback */
    .col.drag-over{outline:2px dashed var(--naranja);outline-offset:-6px}

    @media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}
  </style>

  <script>
    /* Fallback del logo si el SVG no existe */
    function logoFallback(e){
      var svg="<svg xmlns='http://www.w3.org/2000/svg' width='120' height='28' viewBox='0 0 120 28'><rect rx='6' ry='6' width='120' height='28' fill='%23c7530c'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-size='14' fill='white'>Unihouser</text></svg>";
      e.target.onerror=null;
      e.target.src='data:image/svg+xml;utf8,'+encodeURIComponent(svg);
    }
  </script>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="container flex between center">
      <div class="brand flex center">
        <img src="logo-unihouser.svg" alt="Unihouser" onerror="logoFallback(event)">
        <div class="title">Unihouser ‚Äî CRM & BuyBox</div>
      </div>

      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="configuracion.html">Configuraci√≥n</a>
      </nav>

      <div class="actions-top">
        <button class="iconbtn" id="btnExport">‚¨áÔ∏è Exportar XLS</button>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <section class="kpis container" id="kpis"></section>

  <!-- Board -->
  <main class="board" id="board">
    <section class="col" data-phase="CONTACTO">
      <header><h2>üì• Contacto</h2><span class="small" id="count-CONTACTO"></span></header>
      <div class="content" id="col-CONTACTO">
        <div class="new-contact" id="newContactBox">
          <div class="flex"><input id="nc_name" placeholder="Nombre y apellidos"></div>
          <div class="flex"><input id="nc_email" type="email" placeholder="Email"><input id="nc_phone" placeholder="Tel√©fono"></div>
          <button class="primary" id="btnCreate">‚ûï Crear contacto</button>
          <p class="small">Guarda fecha en el modal para pasar a <b>Reuni√≥n</b>. üìÜ</p>
        </div>
      </div>
    </section>

    <section class="col" data-phase="REUNION">
      <header><h2>üìÜ Reuni√≥n</h2><span class="small" id="count-REUNION"></span></header>
      <div class="content" id="col-REUNION"></div>
    </section>

    <section class="col" data-phase="CONTRATO">
      <header><h2>üñãÔ∏è Contrato</h2><span class="small" id="count-CONTRATO"></span></header>
      <div class="content" id="col-CONTRATO"></div>
    </section>

    <section class="col" data-phase="BUSQUEDA">
      <header><h2>üîé B√∫squeda</h2><span class="small" id="count-BUSQUEDA"></span></header>
      <div class="content" id="col-BUSQUEDA"></div>
    </section>

    <section class="col" data-phase="COMPRAVENTA">
      <header><h2>üèÅ Compraventa</h2><span class="small" id="count-COMPRAVENTA"></span></header>
      <div class="content" id="col-COMPRAVENTA"></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="overlay" aria-hidden="true"></div>
  <div id="modal" role="dialog" aria-modal="true" aria-label="Ficha del cliente">
    <div class="sheet">
      <header>
        <h3 id="modalTitle">Ficha</h3>
        <button class="iconbtn" id="btnCloseModal" draggable="false">‚úñÔ∏è Cerrar</button>
      </header>
      <div class="body" id="modalBody"></div>
      <footer>
        <button class="primary" id="modalSave" draggable="false">üíæ Guardar</button>
      </footer>
    </div>
  </div>

  <div class="toaster" id="toaster" aria-live="polite" aria-atomic="true"></div>

  <script>
    'use strict';

    /* ========= Helpers ========= */
    const PHASES=['CONTACTO','REUNION','CONTRATO','BUSQUEDA','COMPRAVENTA'];
    const ES='es-ES';
    const fmtPct=new Intl.NumberFormat(ES,{style:'percent',minimumFractionDigits:0,maximumFractionDigits:0});
    const eur=n=>new Intl.NumberFormat(ES,{style:'currency',currency:'EUR'}).format(n||0);
    const uid=p=>p+'_'+Math.random().toString(36).slice(2,8);
    const daysSince=ts=>ts?Math.max(0,Math.floor((Date.now()-ts)/86400000)):0;
    const escapeHtml=s=>(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    function toast(msg,type='ok'){const t=document.createElement('div');t.className='toast'+(type==='warn'?' warn':type==='bad'?' bad':'');t.textContent=msg;document.getElementById('toaster').appendChild(t);setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),240)},2600)}
    function num(s){if(typeof s==='number')return s;const t=(s||'').toString().replace(/\./g,'').replace(',','.');const v=parseFloat(t);return isNaN(v)?0:v}
    function normPct(v){if(v==null||isNaN(v))return 0;const x=Number(v);if(x>1&&x<=100)return x/100;if(x>100)return 1;if(x<0)return 0;return x}
    function toLocalDT(v){const d=new Date(v);const pad=x=>String(x).padStart(2,'0');return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes())}
    function shortDateTime(v){if(!v)return'';const d=new Date(v);return d.toLocaleString(ES,{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}

    /* ========= Storage ========= */
    const LS={getCfg(){try{return JSON.parse(localStorage.getItem('cfg')||'null')}catch(_){return null}},setCfg(o){localStorage.setItem('cfg',JSON.stringify(o))},getPros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return []}},setPros(a){localStorage.setItem('pros',JSON.stringify(a))},getEvals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return []}},setEvals(a){localStorage.setItem('evals',JSON.stringify(a))}};
    const DEFAULT_CFG={itp_pct:0.08,notaria:1200,honorarios:3630,localidades:['Oviedo','Gij√≥n','Avil√©s','Mieres','Pola de Siero','Langreo','Goz√≥n']};
    function ensureCfgShape(c){const x=c&&typeof c==='object'?c:{};x.itp_pct=normPct(typeof x.itp_pct==='number'?x.itp_pct:DEFAULT_CFG.itp_pct);x.notaria=typeof x.notaria==='number'?x.notaria:DEFAULT_CFG.notaria;x.honorarios=typeof x.honorarios==='number'?x.honorarios:DEFAULT_CFG.honorarios;x.localidades=Array.isArray(x.localidades)&&x.localidades.length?x.localidades:DEFAULT_CFG.localidades;return x}

    /* ========= Evals helpers ========= */
    function evId(e){return e.id||e.ev_id||e.key||e.uuid||null}
    function evEnsureId(e){if(!evId(e))e.id='ev_'+Math.random().toString(36).slice(2,8);return evId(e)}
    function evTitle(e){return e.titulo||e.title||e.nombre||e.direccion||e.direcci√≥n||e.ref||('Evaluaci√≥n '+(evId(e)||''))}
    function evYieldNeta(e){const ks=['neta','kpi_neta','rent_neta','rentabilidad_neta','rn'];for(const k of ks){if(typeof e[k]==='number')return normPct(e[k])}if(e.kpis&&typeof e.kpis.neta==='number')return normPct(e.kpis.neta);return null}
    function evYieldBruta(e){const ks=['bruta','kpi_bruta','rent_bruta','rentabilidad_bruta','rb'];for(const k of ks){if(typeof e[k]==='number')return normPct(e[k])}if(e.kpis&&typeof e.kpis.bruta==='number')return normPct(e.kpis.bruta);return null}
    function evFlujoMensual(e){const m=['flujo_mensual','cashflow_mensual','cf_mensual','flujo'];for(const k of m){if(typeof e[k]==='number')return e[k]}const a=['flujo_anual','cashflow_anual','cf_anual'];for(const k of a){if(typeof e[k]==='number')return e[k]/12}if(e.kpis){if(typeof e.kpis.flujo_mensual==='number')return e.kpis.flujo_mensual;if(typeof e.kpis.flujo_anual==='number')return e.kpis.flujo_anual/12}return null}

    /* ========= State ========= */
    let CFG=ensureCfgShape(LS.getCfg());LS.setCfg(CFG);
    let PROS=LS.getPros();
    let EVALS=LS.getEvals();(function(){let ch=false;for(const e of EVALS){if(!evId(e)){evEnsureId(e);ch=true}}if(ch)LS.setEvals(EVALS)})();

    /* ========= Render ========= */
    function renderAll(){renderKPIs();renderColumns()}
    function renderKPIs(){
      const wrap=document.getElementById('kpis');wrap.innerHTML='';
      const counts={};for(const ph of PHASES)counts[ph]=0;
      for(const p of PROS){if(!p.archived&&PHASES.includes(p.phase))counts[p.phase]++}
      const hist={};for(const ph of PHASES)hist[ph]={ok:0,ko:0};let exitos=0;
      for(const p of PROS){if(p.success)exitos++;const h=p.history||{};for(const k in h){if(hist[k]){if(h[k]==='OK')hist[k].ok++;else if(h[k]==='KO')hist[k].ko++}}}
      const per=(ok,ko)=>{const tot=ok+ko;return tot?fmtPct.format(ok/tot):fmtPct.format(0)}
      const add=(title,phase)=>{const card=document.createElement('div');card.className='kpi';const h=hist[phase]||{ok:0,ko:0};card.innerHTML=`<h3>${title}</h3><div class="row"><b>${per(h.ok,h.ko)}</b><span class="pill">${counts[phase]} clientes</span></div>`;const pct=h.ok+(h.ko)||0?h.ok/(h.ok+h.ko):0;if(pct>=.7)card.classList.add('ok');else if(pct>=.4)card.classList.add('warn');else card.classList.add('bad');wrap.appendChild(card)}
      add('Contacto','CONTACTO');add('Reuni√≥n','REUNION');add('Contrato','CONTRATO');add('B√∫squeda','BUSQUEDA');add('Compraventa','COMPRAVENTA');
      const ex=document.createElement('div');ex.className='kpi ok';ex.innerHTML=`<h3>√âxitos</h3><div class="row"><b>${exitos}</b><span class="pill">Total</span></div>`;wrap.appendChild(ex)
    }
    function renderColumns(){
      for(const ph of PHASES){
        const col=document.getElementById('col-'+ph);if(!col)continue;
        const keep=ph==='CONTACTO'?[document.getElementById('newContactBox')]:[];col.innerHTML='';for(const k of keep){if(k)col.appendChild(k)}
        const s=document.querySelector(`section[data-phase="${ph}"]`);
        s.addEventListener('dragover',e=>{e.preventDefault();s.classList.add('drag-over')});
        s.addEventListener('dragleave',()=>s.classList.remove('drag-over'));
        s.addEventListener('drop',e=>{e.preventDefault();s.classList.remove('drag-over');const id=e.dataTransfer.getData('text/plain');const p=PROS.find(x=>x.id===id&&!x.archived);if(!p)return;const from=PHASES.indexOf(p.phase),to=PHASES.indexOf(ph);if(Math.abs(from-to)!==1){toast('Solo puedes mover a la fase anterior/siguiente. ‚ö†Ô∏è','warn');return}p.phase=ph;p.phase_entered_at=Date.now();LS.setPros(PROS);renderAll();toast(`Movido a ${ph} ‚ûú`,'ok')});
      }
      const now=Date.now();const byPhase={};for(const ph of PHASES)byPhase[ph]=[];
      for(const p of PROS){if(!p.archived)byPhase[p.phase||'CONTACTO'].push(p)}
      byPhase.REUNION.sort((a,b)=>{const ad=a.meeting?.date?Math.abs(new Date(a.meeting.date).getTime()-now):Number.MAX_SAFE_INTEGER;const bd=b.meeting?.date?Math.abs(new Date(b.meeting.date).getTime()-now):Number.MAX_SAFE_INTEGER;return ad-bd});
      for(const ph of PHASES){const col=document.getElementById('col-'+ph);for(const p of byPhase[ph]) col.appendChild(makeCard(p));document.getElementById('count-'+ph).textContent=`${byPhase[ph].length} clientes`}
    }
    function makeCard(p){
      const el=document.createElement('div');el.className='card';
      const d=daysSince(p.phase_entered_at);const pr=p.profile||{};
      const tipo=pr.tipo||'Tradicional';const objt=pr.objt?(pr.objt==='bruta'?'Rb%':pr.objt==='neta'?'Rn%':'Flujo'):'Obj';
      const meetBadge=(p.phase==='REUNION'&&p.meeting&&p.meeting.date)?`<span class="badge gray">üìÖ ${shortDateTime(p.meeting.date)}</span>`:'';
      const busqHouses=p.phase==='BUSQUEDA'?`<div class="houses" title="Env√≠os realizados"><div class="house ${p.busqueda?.sent_count>0?'on':''}"></div><div class="house ${p.busqueda?.sent_count>1?'on':''}"></div><div class="house ${p.busqueda?.sent_count>2?'on':''}"></div><div class="house ${p.busqueda?.sent_count>3?'on':''}"></div></div>`:'';
      el.innerHTML=`<div class="top"><div class="name"><span class="grip" title="Arrastrar"></span><span>üë§ ${escapeHtml(p.name||'Sin nombre')}</span></div><div class="days">‚è±Ô∏è ${d} ${d===1?'d√≠a':'d√≠as'}</div></div><div class="badges"><span class="badge">üè∑Ô∏è ${escapeHtml(tipo)}</span><span class="badge">üéØ ${escapeHtml(objt)}</span>${meetBadge}</div><div class="actions"><button class="iconbtn" data-act="details" draggable="false" title="Ver/editar">üëÅÔ∏è</button>${p.phase==='CONTACTO'?`<button class="iconbtn bad" data-act="trash" draggable="false" title="Descartar (solo Contacto)">üóëÔ∏è</button>`:`<button class="circle ok" data-act="ok" draggable="false" title="Interesa">‚úî</button><button class="circle ko" data-act="ko" draggable="false" title="No interesa">‚úñ</button>`}${busqHouses}</div>`;
      const grip=el.querySelector('.grip');grip.setAttribute('draggable','true');grip.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',p.id)});
      el.querySelectorAll('[data-act]').forEach(b=>b.addEventListener('click',ev=>ev.stopPropagation()));
      el.querySelector('[data-act="details"]').addEventListener('click',()=>openModalFor(p));
      if(p.phase==='CONTACTO')el.querySelector('[data-act="trash"]').addEventListener('click',()=>discardContact(p));else{el.querySelector('[data-act="ok"]').addEventListener('click',()=>markOK(p));el.querySelector('[data-act="ko"]').addEventListener('click',()=>markKO(p))}
      return el
    }

    /* ========= Actions ========= */
    function markOK(p){const i=PHASES.indexOf(p.phase);if(i===PHASES.length-1){p.history=p.history||{};p.history[p.phase]='OK';p.success=true;p.archived=true;p.archived_reason='SUCCESS';p.archived_at=new Date().toISOString();toast('üéâ Compraventa finalizada. ¬°√âxito!','ok')}else{p.history=p.history||{};p.history[p.phase]='OK';p.phase=PHASES[i+1];p.phase_entered_at=Date.now();toast(`Avanzado a ${p.phase} ‚úÖ`,'ok')}LS.setPros(PROS);renderAll()}
    function markKO(p){p.history=p.history||{};p.history[p.phase]='KO';p.archived=true;p.archived_reason='KO';p.archived_at=new Date().toISOString();LS.setPros(PROS);renderAll();toast('Marcado como NO interesa. Archivado.','bad')}
    function discardContact(p){PROS=PROS.filter(x=>x.id!==p.id);LS.setPros(PROS);renderAll();toast('Descartado en Contacto (no computa). üóëÔ∏è','bad')}

    /* ========= Modal / Accesibilidad ========= */
    const overlay=document.getElementById('overlay');
    const modal=document.getElementById('modal');
    const modalBody=document.getElementById('modalBody');
    const modalTitle=document.getElementById('modalTitle');
    const btnClose=document.getElementById('btnCloseModal');
    const btnSave=document.getElementById('modalSave');

    // WRAPPERS para evitar ReferenceError
    function openModal(){ _openModal(); }
    function closeModal(){ _closeModal(); }

    btnClose.addEventListener('click',closeModal);
    btnSave.addEventListener('click',saveModal);
    overlay.addEventListener('click',closeModal);
    document.addEventListener('keydown',e=>{if(e.key==='Escape'&&modal.classList.contains('open'))closeModal()});

    let CURRENT=null,lastOpener=null,inertNodes=[];

    function setBackgroundInert(on){
      const kids=[...document.body.children];
      inertNodes=kids.filter(n=>n!==modal&&n!==overlay);
      inertNodes.forEach(n=>{if(on){n.setAttribute('aria-hidden','true');n.inert=true}else{n.removeAttribute('aria-hidden');try{n.inert=false}catch(_){}}})
    }
    function trapFocus(e){
      if(!modal.classList.contains('open')||e.key!=='Tab')return;
      const list=Array.from(modal.querySelectorAll('a[href],button:not([disabled]),textarea,input,select,[tabindex]:not([tabindex="-1"])')).filter(el=>el.offsetParent!==null);
      if(!list.length)return;
      const first=list[0],last=list[list.length-1];
      if(e.shiftKey&&document.activeElement===first){last.focus();e.preventDefault()}
      else if(!e.shiftKey&&document.activeElement===last){first.focus();e.preventDefault()}
    }
    function _openModal(){overlay.classList.add('open');modal.classList.add('open');setBackgroundInert(true);document.addEventListener('keydown',trapFocus);const focusables=Array.from(modal.querySelectorAll('input,select,button,textarea'));if(focusables.length)focusables[0].focus()}
    function _closeModal(){if(lastOpener&&document.body.contains(lastOpener))lastOpener.focus();document.removeEventListener('keydown',trapFocus);setBackgroundInert(false);overlay.classList.remove('open');modal.classList.remove('open');CURRENT=null}

    /* ---- abrir modal p/ cliente ---- */
    function openModalFor(p){
      CURRENT=p;lastOpener=document.activeElement;
      modalTitle.textContent=`üë§ ${p.name||'Sin nombre'} ‚Äî Detalle`;

      const pr=p.profile||(p.profile={});
      const m=p.meeting||(p.meeting={date:'',notas:''});
      if(typeof pr.locs==='string')pr.locs=pr.locs.split(',').map(s=>s.trim()).filter(Boolean);
      if(!Array.isArray(pr.locs))pr.locs=[];
      const itp=CFG.itp_pct,not=CFG.notaria,hon=CFG.honorarios;

      /* ‚Äî‚Äî‚Äî Hoja √∫nica, orden l√≥gico y campos compactos ‚Äî‚Äî‚Äî */
      modalBody.innerHTML=
      `<div class="group">
        <h4>Datos personales</h4>
        <div class="grid">
          <div><label>Nombre</label><input id="f_name" value="${escapeHtml(p.name||'')}"></div>
          <div><label>Tel√©fono</label><input id="f_tel" value="${escapeHtml(p.phone||'')}"></div>
          <div><label>Email</label><input id="f_email" value="${escapeHtml(p.email||'')}"></div>
        </div>
        <div class="grid">
          <div><label>DNI</label><input id="f_dni" value="${escapeHtml(pr.dni||'')}"></div>
          <div style="grid-column:span 2"><label>Direcci√≥n</label><input id="f_dir" value="${escapeHtml(pr.dir||'')}" placeholder="C/ ‚Ä¶ n¬∫ ‚Ä¶"></div>
        </div>
      </div>

      <div class="group">
        <h4>Inversi√≥n</h4>
        <div class="grid">
          <div>
            <label>Localidades (multi)</label>
            <div class="chips" id="loc_chips"></div>
            <input id="loc_input" list="loc_list" placeholder="A√±adir localidad y Enter">
            <datalist id="loc_list">${CFG.localidades.map(l=>`<option value="${escapeHtml(l)}">`).join('')}</datalist>
          </div>
          <div>
            <label>Tipo de alquiler</label>
            <select id="f_tipo">
              <option ${pr.tipo==='Tradicional'?'selected':''}>Tradicional</option>
              <option ${pr.tipo==='Habitaciones'?'selected':''}>Habitaciones</option>
            </select>
          </div>
          <div>
            <label>Acepta reforma</label>
            <select id="f_ref">
              <option ${pr.ref==='No'?'selected':''}>No</option>
              <option ${pr.ref==='Lavado de cara'?'selected':''}>Lavado de cara</option>
              <option ${pr.ref==='Integral'?'selected':''}>Integral</option>
            </select>
          </div>
        </div>
        <div class="grid">
          <div><label>¬øAscensor?</label><select id="f_asc"><option ${pr.asc!=='No'?'selected':''}>S√≠</option><option ${pr.asc==='No'?'selected':''}>No</option></select></div>
          <div><label>Altura m√°x.</label><input id="f_alt" value="${escapeHtml(pr.alt||'')}" inputmode="numeric"></div>
          <div><label>¬øBajos?</label><select id="f_bajos"><option ${pr.bajos!=='S√≠'?'selected':''}>No</option><option ${pr.bajos==='S√≠'?'selected':''}>S√≠</option></select></div>
        </div>
        <div class="grid">
          <div><label>Presupuesto TOTAL (‚Ç¨)</label><input id="f_budget" value="${pr.budget!=null?Math.round(pr.budget):''}" inputmode="numeric"></div>
          <div><label>Precio m√°x. COMPRA (auto)</label><input id="f_pmax" value="${pr.pmax!=null?Math.round(pr.pmax):''}" disabled></div>
          <div><label>ITP estimado (auto)</label><input id="f_itp" value="${pr.pmax?Math.round(pr.pmax*itp):''}" disabled></div>
        </div>
        <div class="grid two" style="align-items:center">
          <div><small class="small">Notar√≠a: ${eur(not)} ¬∑ Honorarios: ${eur(hon)} (Config)</small></div>
        </div>
      </div>

      <div class="group">
        <h4>Financiaci√≥n</h4>
        <div class="grid">
          <div><label>Financiaci√≥n bancaria</label><select id="f_fin"><option ${pr.fin!=='No'?'selected':''}>S√≠</option><option ${pr.fin==='No'?'selected':''}>No</option></select></div>
          <div><label>% financiaci√≥n</label><input id="f_pct" value="${pr.pct!=null?String(pr.pct).replace('.',','):''}" placeholder="80,0"></div>
          <div><label>Hipoteca (auto)</label><input id="f_hip" value="${pr.hip!=null?Math.round(pr.hip):''}" disabled></div>
        </div>
        <div class="grid two">
          <div><label>Fondos propios</label><input id="f_prop" value="${pr.prop!=null?Math.round(pr.prop):''}" disabled></div>
        </div>
      </div>

      <div class="group">
        <h4>Objetivo</h4>
        <div class="grid">
          <div><label>Objetivo principal</label>
            <select id="f_objt">
              <option value="bruta" ${pr.objt==='bruta'?'selected':''}>Rentabilidad bruta (%)</option>
              <option value="neta"  ${pr.objt==='neta'?'selected':''}>Rentabilidad neta (%)</option>
              <option value="flujo" ${pr.objt==='flujo'?'selected':''}>Flujo de caja (‚Ç¨/mes)</option>
            </select>
          </div>
          <div><label>Valor objetivo</label><input id="f_objv" value="${pr.objv!=null?String(pr.objv).replace('.',','):''}" placeholder="7,5 o 300"></div>
          <div class="grid two" id="row_alq" style="display:${(pr.objt||'bruta')==='bruta'?'grid':'none'}">
            <div><label>Alquiler orientativo (‚Ç¨/mes)</label><input id="f_alq" value="${pr.alq!=null?Math.round(pr.alq):''}" disabled></div>
          </div>
        </div>
        <small class="small">F√≥rmula Rb%: <b>((Total ‚àí Honorarios) √ó Rb%) / 12</b>.</small>
      </div>

      <div class="group">
        <h4>${p.phase==='CONTACTO'?'Reuni√≥n':'Notas'}</h4>
        <div class="grid two">
          ${p.phase==='CONTACTO'?`<div><label>Fecha y hora</label><input type="datetime-local" id="f_meet" value="${m.date?toLocalDT(m.date):''}"></div>`:''}
          <div><label>Notas</label><input id="f_notas" value="${escapeHtml(m.notas||'')}" placeholder="Ej. confirmada por WhatsApp ‚úÖ"></div>
        </div>

        ${p.phase==='BUSQUEDA'?`
          <div class="grid two" style="margin-top:6px">
            <div><label>Buscar evaluaciones</label><input id="b_q_${p.id}" placeholder="Filtrar por texto‚Ä¶"></div>
            <div><label>Selecci√≥n (m√°x 4)</label><div id="b_chips_${p.id}" class="chips"></div></div>
          </div>
          <div class="eval-list" id="b_list_${p.id}"></div>
          <div class="flex" style="gap:6px;margin-top:6px"><button class="iconbtn" id="b_send_${p.id}">üì§ Enviar documentaci√≥n</button></div>
        `:'<p class="small">La selecci√≥n de activos se gestiona en <b>B√∫squeda</b>.</p>'}
      </div>`;

      // Chips de localidades
      const chipsBox=document.getElementById('loc_chips'),locInput=document.getElementById('loc_input');
      function renderLocs(){chipsBox.innerHTML='';pr.locs.forEach(v=>{const el=document.createElement('span');el.className='chip';el.innerHTML=`${escapeHtml(v)} <button data-v="${escapeHtml(v)}">√ó</button>`;chipsBox.appendChild(el)});chipsBox.querySelectorAll('button[data-v]').forEach(b=>b.addEventListener('click',()=>{const v=b.getAttribute('data-v');pr.locs=pr.locs.filter(x=>x!==v);renderLocs()}))}
      function addLoc(v){v=(v||'').trim();if(!v)return;if(!pr.locs.includes(v))pr.locs.push(v);locInput.value='';renderLocs()}
      locInput.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===','){e.preventDefault();addLoc(locInput.value)}});locInput.addEventListener('change',()=>addLoc(locInput.value));renderLocs();

      // Derivados
      ['f_budget','f_pct','f_fin','f_objt','f_objv'].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.addEventListener('input',recalcDerived);el.addEventListener('change',recalcDerived)});
      recalcDerived();

      if(p.phase==='BUSQUEDA')mountBusquedaInModal(p);

      openModal();
    }

    /* Derivados */
    function recalcDerived(){
      const budget=num(document.getElementById('f_budget').value);
      const itp=CFG.itp_pct,not=CFG.notaria,hon=CFG.honorarios;
      const base=budget-(not+hon);const pmax=base>0?base/(1+itp):0;
      const pmaxEl=document.getElementById('f_pmax');if(pmaxEl)pmaxEl.value=pmax?Math.round(pmax):'';
      const itpEl=document.getElementById('f_itp');if(itpEl)itpEl.value=pmax?Math.round(pmax*itp):'';
      const finEl=document.getElementById('f_fin'),pctEl=document.getElementById('f_pct');
      if(finEl&&pctEl){const fin=finEl.value;const pct=num(pctEl.value)/100;const hip=fin==='S√≠'?pmax*pct:0;const costeTotal=pmax*(1+itp)+not+hon;const prop=costeTotal-hip;const hipEl=document.getElementById('f_hip');if(hipEl)hipEl.value=hip?Math.round(hip):'';const propEl=document.getElementById('f_prop');if(propEl)propEl.value=prop?Math.round(prop):''}
      const objtEl=document.getElementById('f_objt'),objvEl=document.getElementById('f_objv'),alqEl=document.getElementById('f_alq');if(objtEl&&objvEl&&alqEl){const objt=objtEl.value;const row=document.getElementById('row_alq');if(row)row.style.display=objt==='bruta'?'grid':'none';if(objt==='bruta'){const rb=num(objvEl.value)/100;const alq=((budget-CFG.honorarios)*rb)/12;alqEl.value=alq?Math.round(alq):''}else{alqEl.value=''}}
    }

    /* Guardar modal */
    function saveModal(){
      if(!CURRENT){closeModal();return}
      const p=CURRENT;const pr=p.profile||(p.profile={});
      p.name=document.getElementById('f_name').value.trim();
      p.phone=document.getElementById('f_tel').value.trim();
      p.email=document.getElementById('f_email').value.trim();
      pr.dni=document.getElementById('f_dni').value.trim();
      pr.dir=document.getElementById('f_dir').value.trim();
      pr.tipo=document.getElementById('f_tipo').value;
      pr.ref=document.getElementById('f_ref').value;
      pr.asc=document.getElementById('f_asc').value;
      pr.alt=document.getElementById('f_alt').value.trim();
      pr.bajos=document.getElementById('f_bajos').value;
      pr.budget=num(document.getElementById('f_budget').value);
      pr.pmax=num(document.getElementById('f_pmax').value);
      pr.fin=document.getElementById('f_fin').value;
      pr.pct=num(document.getElementById('f_pct').value);
      pr.hip=num(document.getElementById('f_hip').value);
      pr.prop=num(document.getElementById('f_prop').value);
      pr.objt=document.getElementById('f_objt').value;
      pr.objv=num(document.getElementById('f_objv').value);
      const alqEl=document.getElementById('f_alq');pr.alq=alqEl?num(alqEl.value):0;
      const notas=document.getElementById('f_notas').value.trim();
      let dt=null;if(p.phase==='CONTACTO'){const el=document.getElementById('f_meet');dt=el?el.value:''}
      p.meeting={date:dt||p.meeting?.date||'',notas};
      if(p.phase==='CONTACTO'&&dt){p.phase='REUNION';p.phase_entered_at=Date.now()}
      LS.setPros(PROS);renderAll();toast('Ficha guardada ‚úÖ','ok');closeModal();
    }

    /* B√∫squeda */
    function mountBusquedaInModal(p){
      const q=document.getElementById(`b_q_${p.id}`),list=document.getElementById(`b_list_${p.id}`),chips=document.getElementById(`b_chips_${p.id}`),btnSend=document.getElementById(`b_send_${p.id}`);
      const b=p.busqueda||(p.busqueda={propuestas:[],sent_count:0});
      const EVS=EVALS.map(ev=>({_raw:ev,id:(evEnsureId(ev),evId(ev)),title:evTitle(ev),rn:evYieldNeta(ev),rb:evYieldBruta(ev),flujo:evFlujoMensual(ev)}));
      function objMatch(it){const pr=p.profile||{};const kind=pr.objt||'neta';const val=pr.objv||0;if(kind==='neta'||kind==='bruta'){const k=kind==='neta'?it.rn:it.rb;if(k==null)return{ok:false,txt:'s/d',cls:'warn'};const target=normPct(val);const ok=k>=target;return{ok,txt:((k*100).toFixed(1).replace('.',',')+'%'),cls:ok?'ok':'bad'}}else{const k=it.flujo;if(k==null)return{ok:false,txt:'s/d',cls:'warn'};const ok=k>=val;return{ok,txt:eur(k)+'/mes',cls:ok?'ok':'bad'}}}
      function renderChips(){chips.innerHTML='';for(const id of b.propuestas){const e=EVS.find(x=>x.id===id);const label=e?e.title:id;const span=document.createElement('span');span.className='chip';span.innerHTML=`${escapeHtml(label)} <button data-id="${escapeHtml(id)}">√ó</button>`;chips.appendChild(span)}chips.querySelectorAll('button[data-id]').forEach(btn=>btn.addEventListener('click',()=>{const id=btn.getAttribute('data-id');b.propuestas=b.propuestas.filter(x=>x!==id);LS.setPros(PROS);renderChips();renderList();toast('Quitado','warn')}))}
      function renderList(){list.innerHTML='';const txt=(q.value||'').toLowerCase();const filtered=EVS.filter(x=>!txt||(x.title||'').toLowerCase().includes(txt));for(const it of filtered){const sel=b.propuestas.includes(it.id);const mt=objMatch(it);const row=document.createElement('div');row.className='eval-item';row.innerHTML=`<div><div class="eval-title">${escapeHtml(it.title)}</div><div class="small">üéØ <span class="match ${mt.cls}">${mt.ok?'‚úÖ match':'‚ö†Ô∏è bajo objetivo'} ‚Äî ${mt.txt}</span></div></div><div><button class="${sel?'bad':'primary'}" data-id="${escapeHtml(it.id)}">${sel?'Quitar':'A√±adir'}</button></div>`;row.querySelector('button').addEventListener('click',()=>{const id=it.id;if(sel){b.propuestas=b.propuestas.filter(x=>x!==id);toast('Quitado','warn')}else{if(b.propuestas.length>=4){toast('M√°ximo 4 propuestas','bad');return}b.propuestas.push(id);toast('A√±adido','ok')}LS.setPros(PROS);renderChips();renderList()});list.appendChild(row)}}
      if(q)q.addEventListener('input',renderList);
      btnSend.addEventListener('click',()=>{b.sent_count=Math.min(4,b.propuestas.length);b.last_sent_ids=b.propuestas.slice(0,4);b.last_sent_at=new Date().toISOString();LS.setPros(PROS);renderAll();toast('üì§ Documentaci√≥n registrada como enviada.','ok')});
      renderChips();renderList();
    }

    /* Crear contacto */
    document.getElementById('btnCreate').addEventListener('click',()=>{const name=(document.getElementById('nc_name').value||'').trim();const email=(document.getElementById('nc_email').value||'').trim();const phone=(document.getElementById('nc_phone').value||'').trim();if(!name){toast('Pon un nombre para crear el contacto.','warn');return}const p={id:uid('p'),name,email,phone,phase:'CONTACTO',phase_entered_at:Date.now(),history:{},meeting:{date:'',notas:''},profile:{locs:[]},busqueda:{propuestas:[],sent_count:0},compraventa:{}};PROS.push(p);LS.setPros(PROS);renderAll();document.getElementById('nc_name').value='';document.getElementById('nc_email').value='';document.getElementById('nc_phone').value='';toast('Contacto creado üéâ','ok')});

    /* Exportar XLS */
    document.getElementById('btnExport').addEventListener('click',exportXLS);
    function exportXLS(){const rows=[['id','nombre','fase','archivado','motivo_archivo','exito','fecha_fase','email','telefono','tipo','objetivo','objetivo_valor','reunion_fecha','localidades','propuestas_enviadas','propuestas_ids']];for(const p of PROS){const pr=p.profile||{};const locs=Array.isArray(pr.locs)?pr.locs.join(', '):'';rows.push([p.id,p.name||'',p.phase||'',p.archived?'s√≠':'no',p.archived_reason||'',p.success?'s√≠':'no',p.phase_entered_at?new Date(p.phase_entered_at).toLocaleDateString(ES):'',p.email||'',p.phone||'',pr.tipo||'',pr.objt||'',pr.objv||'',p.meeting&&p.meeting.date?new Date(p.meeting.date).toLocaleString(ES):'',locs,p.busqueda&&p.busqueda.sent_count||0,p.busqueda&&Array.isArray(p.busqueda.last_sent_ids)?p.busqueda.last_sent_ids.join('|'):''])}const xml=xlsFromArray(rows,'Prospectos');download('unihouser_prospectos.xls',xml)}
    function xlsFromArray(rows,sheetName){const header=`<?xml version="1.0"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Worksheet ss:Name="${sheetName}"><Table>`;const body=rows.map(r=>`<Row>`+r.map(c=>`<Cell><Data ss:Type="${typeof c==='number'?'Number':'String'}">${String(c).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</Data></Cell>`).join('')+`</Row>`).join('');const footer=`</Table></Worksheet></Workbook>`;return header+body+footer}
    function download(filename,data){const blob=new Blob([data],{type:'application/vnd.ms-excel'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),2000)}

    /* Init */
    document.addEventListener('DOMContentLoaded',()=>{renderAll()});
  </script>
</body>
</html>
