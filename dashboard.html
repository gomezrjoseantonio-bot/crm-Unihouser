<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unihouser ‚Äî Dashboard CRM</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box}
html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}

/* Topbar */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}

/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}

/* KPIs finos y filtros */
.filters{display:grid;grid-template-columns:1.2fr 1fr 1fr 0.8fr 1.2fr 1.2fr auto;gap:6px}
.filters input,.filters select{border:1px solid var(--line);border-radius:10px;padding:7px 9px;background:#fff;font-size:12px}
.btn-new{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}

/* Board */
.board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;min-height:520px;box-shadow:var(--shadow)}
.col h3{margin:0 0 6px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;font-size:13px}
.col .count{font-weight:700;color:#666}
.drop{min-height:460px}
.col.drop-target{outline:2px dashed var(--brand);outline-offset:-6px}

/* Card */
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:6px;margin-bottom:8px;cursor:grab}
.card.dragging{opacity:.55}
.card header{display:flex;align-items:center;justify-content:space-between;gap:6px}
.name{font-weight:800;font-size:13px}
.meta{font-size:11px;color:#8a8f95}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 7px;display:inline-flex;align-items:center;gap:6px;font-size:11px}
.actions{display:flex;gap:6px;align-items:center;margin-left:auto}
.btn-ic{width:26px;height:26px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.btn-ic svg{width:15px;height:15px;stroke:#555;fill:none;stroke-width:2}
.btn-ic.view{border-color:var(--brand)} .btn-ic.view svg{stroke:var(--brand)}
.btn-ic.assign{border-color:var(--brand)} .btn-ic.assign svg{stroke:var(--brand)}
.btn-ic.mail{border-color:#666}
.btn-ic.wa{border-color:#1fa855} .btn-ic.wa svg{stroke:#1fa855}
.btn-ic.arch{border-color:#999} .btn-ic.arch svg{stroke:#999}
.houses{display:flex;gap:3px;margin-left:4px}
.houses i{width:9px;height:9px;border-radius:2px;border:1px solid var(--line);background:#eee;display:inline-block}
.houses i.on{background:var(--brand);border-color:var(--brand)}

/* Modales */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:50}
.modal{width:980px;max-width:95vw;max-height:88vh;background:#fff;border:2px solid #fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.22);display:flex;flex-direction:column;overflow:hidden}
.modal header{padding:8px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:#fff}
.modal h4{margin:0;font-size:14px}
.modal .close{width:28px;height:28px;border-radius:999px;border:2px solid var(--brand);background:#fff;color:var(--brand);display:grid;place-items:center;font-weight:800;cursor:pointer}
.modal .body{padding:8px 10px;display:grid;gap:6px;flex:1 1 auto;overflow:auto;background:#fff}
.block{border:1px dashed var(--line);border-radius:12px;padding:6px;background:#fff}
.block h5{margin:0 0 4px;color:#666;font-weight:700;font-size:11px;letter-spacing:.2px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.field{display:flex;flex-direction:column;gap:2px}
.field label{color:#555;font-size:11px}
.field input,.field select,.field textarea,.chips-input{border:1px solid var(--line);border-radius:10px;padding:5px 7px;min-height:24px;font-size:12px;background:#fff;color:#000}
.field textarea{resize:none}
.inline{display:flex;gap:6px;align-items:center}
.row2{grid-column:span 2} .row3{grid-column:span 3}
.chips{display:flex;gap:6px;flex-wrap:wrap;line-height:18px}
.chips.limit2{max-height:40px;overflow:hidden}
.chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 8px;display:inline-flex;gap:6px;align-items:center}
.chip .x{cursor:pointer;color:#999}
.chips-input{width:220px}
.modal footer{padding:8px 10px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;background:#fff}
.save{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 11px;font-weight:800;cursor:pointer;font-size:12px}

/* Modal asignaci√≥n */
.modal.small{width:780px}
.eval-list{border:1px solid var(--line);border-radius:10px;max-height:46vh;overflow:auto;padding:6px;background:#fff}
.eval-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border-bottom:1px dashed var(--line);padding:6px 2px;font-size:12px}
.eval-item:last-child{border-bottom:none}
.eval-title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.dot{width:9px;height:9px;border-radius:50%;display:inline-block}
.dot.green{background:var(--brand)} .dot.amber{background:var(--accent)} .dot.red{background:var(--bad)}
.tag{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:1px 6px;margin-left:0;font-size:11px}
.warns{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.kpiRight{display:flex;align-items:center;gap:8px}
.sel-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.sel-chips .chip .x{color:#999;cursor:pointer}

.footer{margin:16px 0 14px;text-align:center;color:#888;font-size:11px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo" id="logo">U</div><div class="title" id="brandTitle">Unihouser ‚Äî Dashboard</div></div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuraci√≥n</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="filters">
      <input id="q_name" placeholder="Nombre y apellidos"/>
      <input id="q_email" placeholder="Email"/>
      <input id="q_phone" placeholder="M√≥vil (+34 ‚Ä¶)"/>
      <select id="q_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
      <input id="q_locs" placeholder="Localidades (coma)"/>
      <input id="q_pmax" placeholder="P. m√°x inversi√≥n (‚Ç¨)"/>
      <button id="btn_new" class="btn-new">Crear contacto</button>
    </div>

    <div class="board" id="board">
      <!-- Columnas -->
    </div>
  </div>

  <div class="footer">¬© 2025 Unihouser ¬∑ unihouser.es ¬∑ info@unihouser.es ¬∑ 644 300 200</div>

  <!-- Modal Crear/Editar -->
  <div class="modal-back" id="editBack">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Ficha de cliente">
      <header>
        <h4 id="editTitle">Ficha de cliente</h4>
        <button class="close" id="editClose">√ó</button>
      </header>
      <div class="body">
        <!-- Datos personales -->
        <div class="block">
          <h5>Datos personales</h5>
          <div class="grid">
            <div class="field"><label>Nombre</label><input id="p_nombre"/></div>
            <div class="field"><label>Apellidos</label><input id="p_apellidos"/></div>
            <div class="field"><label>DNI</label><input id="p_dni"/></div>
            <div class="field"><label>Email</label><input id="p_email"/></div>
            <div class="field"><label>M√≥vil</label><input id="p_movil"/></div>
            <div class="field"><label>Direcci√≥n</label><input id="p_dir"/></div>
            <div class="field"><label>C√≥digo Postal</label><input id="p_cp"/></div>
            <div class="field"><label>Localidad</label><input id="p_loc"/></div>
            <div class="field"><label>Fase</label>
              <select id="p_fase">
                <option>CONTACTO</option><option>REUNION</option><option>BUSQUEDA</option>
                <option>COMPRAVENTA</option><option>EXITO</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin-top:6px"><label>Notas</label><textarea id="p_notas" rows="2"></textarea></div>
        </div>

        <!-- Activo (preferencias) -->
        <div class="block">
          <h5>Datos del activo (preferencias)</h5>
          <div class="grid">
            <div class="field row3"><label>Localidades (chips)</label>
              <div class="chips limit2" id="p_lchips"></div>
              <div class="inline"><input class="chips-input" id="p_ladd" placeholder="A√±adir y Enter"/><small style="color:#888">M√°x 10</small></div>
            </div>
            <div class="field"><label>Tipo alquiler preferido</label><select id="p_pref_tipo"><option>Tradicional</option><option>Habitaciones</option></select></div>
            <div class="field"><label>Altura (1‚Äì9)</label><input id="p_altura" inputmode="numeric" placeholder="1"/></div>
            <div class="field"><label>Acepta bajo</label><select id="p_bajo"><option>S√≠</option><option>No</option></select></div>
            <div class="field"><label>Ascensor</label><select id="p_asc"><option>S√≠</option><option>No</option></select></div>
            <div class="field"><label>Acepta reforma</label><select id="p_reforma"><option>S√≠</option><option>No</option></select></div>
          </div>
        </div>

        <!-- Objetivos -->
        <div class="block">
          <h5>Objetivos de la inversi√≥n</h5>
          <div class="grid5">
            <div class="field"><label>Objetivo principal</label>
              <select id="p_obj_main"><option value="bruta">Bruta</option><option value="neta">Neta</option><option value="flujo">Flujo</option></select>
            </div>
            <div class="field"><label>Bruta (%)</label><input id="p_obj_bruta" inputmode="decimal" placeholder="10"/></div>
            <div class="field"><label>Neta (%)</label><input id="p_obj_neta" inputmode="decimal" placeholder="6"/></div>
            <div class="field"><label>Flujo (‚Ç¨/mes)</label><input id="p_obj_flujo" inputmode="numeric" placeholder="0"/></div>
            <div class="field inline"><label><input type="checkbox" id="p_inc_psi_rent"/> Incluir PSI en rentabilidad</label></div>
          </div>
          <div class="field" id="wrap_alq_obj" style="margin-top:6px;display:none">
            <label>Alquiler objetivo (‚Ç¨/mes)</label>
            <input id="p_alq_obj" disabled/>
          </div>
        </div>

        <!-- Presupuesto & Financiaci√≥n -->
        <div class="block">
          <h5>Presupuesto & financiaci√≥n</h5>
          <div class="grid">
            <div class="field"><label>P. m√°x inversi√≥n (‚Ç¨)</label><input id="p_pmax" inputmode="numeric"/></div>
            <div class="field inline row2"><label><input type="checkbox" id="p_inc_psi_pmax"/> Incluir PSI en presupuesto m√°x</label></div>

            <div class="field"><label>Valor m√°x. compra (auto)</label><input id="p_vcompra" disabled/></div>
            <div class="field"><label>ITP (‚Ç¨ auto)</label><input id="p_itp" disabled/></div>
            <div class="field"><label>Notar√≠a (‚Ç¨ cfg)</label><input id="p_notaria" disabled/></div>
            <div class="field"><label>Coste total operaci√≥n</label><input id="p_total" disabled/></div>
          </div>

          <div class="grid">
            <div class="field"><label>LTV (%)</label><input id="p_ltv" inputmode="decimal" value="80"/></div>
            <div class="field"><label>Capital financiado (‚Ç¨)</label><input id="p_financiado" disabled/></div>
            <div class="field"><label>Fondos propios (‚Ç¨)</label><input id="p_propios" disabled/></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="save" id="saveClient">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- Modal Asignar activos -->
  <div class="modal-back" id="asigBack">
    <div class="modal small" role="dialog" aria-modal="true" aria-label="Asignar activos">
      <header>
        <h4>Asignar activos al cliente</h4>
        <button class="close" id="asigClose">√ó</button>
      </header>
      <div class="body">
        <div class="eval-list" id="evalList">‚Äî</div>
        <div class="sel-chips" id="selChips"></div>
      </div>
      <footer>
        <button class="save" id="asigSave">Guardar asignaci√≥n</button>
      </footer>
    </div>
  </div>

<script>
"use strict";

/* ===== Brand desde cfg ===== */
(function(){
  try{
    const c=JSON.parse(localStorage.getItem('cfg')||'{}')||{};
    const col=c.brand_color||c.brand||'#c7530c';
    document.documentElement.style.setProperty('--brand', col);
    const name=c.brand_name||c.company_name||'Unihouser';
    document.getElementById('brandTitle').textContent=name+' ‚Äî Dashboard';
    document.getElementById('logo').textContent=(name||'U').toString().trim().charAt(0).toUpperCase()||'U';
  }catch(_){}
})();

/* ===== Utils ===== */
const id = x=>document.getElementById(x);
const fmtE0 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1 = new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0 = v=>fmtE0.format(Number(v||0));
const n0 = v=>fmtN0.format(Number(v||0));
const parseEs = s=>Number(String(s??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function toast(msg){ let t=document.getElementById('toast'); if(!t){t=document.createElement('div');t.id='toast';t.className='toast show';document.body.appendChild(t);} t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1300);}

/* ===== Store ===== */
const Store={
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}
};

/* ===== Config numbers ===== */
function cfgCalc(){
  const c=Store.cfg||{};
  let itp_raw = Number(c.itp_pct!=null?c.itp_pct:(c.itp!=null?c.itp:8));
  if(!isFinite(itp_raw)) itp_raw=8; if(itp_raw<=1) itp_raw*=100;
  const itp_pct = itp_raw;
  const notaria = Number((c.notaria_eur!=null?c.notaria_eur:c.notaria)) || 1500;
  const psi     = Number((c.psi_fee_eur!=null?c.psi_fee_eur:c.honorarios)) || 4235;
  const amber_ratio = Number((c.match&&c.match.thresholds&&c.match.thresholds.amber)!=null? c.match.thresholds.amber : 0.95);
  const warn_only_green = !!(c.match && c.match.warnings_only_when_green);
  return {itp_pct, notaria, psi, amber_ratio, warn_only_green};
}

/* ===== Datos iniciales filtros ===== */
(function seedFilters(){
  const c=Store.cfg||{};
  id('q_tipo').value='Tradicional';
  id('q_locs').value=(Array.isArray(c.localidades)&&c.localidades.length)? c.localidades.slice(0,3).join(', ') : '';
})();

/* ===== Render tablero ===== */
const FASES=['CONTACTO','REUNION','BUSQUEDA','COMPRAVENTA','EXITO'];
let DRAG_ID=null;

function render(){
  const board=id('board'); board.innerHTML='';
  FASES.forEach(f=>{
    const col=document.createElement('div'); col.className='col'; col.setAttribute('data-fase',f);
    const head=document.createElement('h3');
    const count=(Store.pros||[]).filter(p=>p.fase===f && !p.archived).length;
    head.innerHTML = '<span>'+f+'</span><span class="count">'+count+'</span>';
    const drop=document.createElement('div'); drop.className='drop';
    drop.addEventListener('dragover',ev=>{ev.preventDefault(); col.classList.add('drop-target');});
    drop.addEventListener('dragleave',()=>col.classList.remove('drop-target'));
    drop.addEventListener('drop',ev=>{
      ev.preventDefault(); col.classList.remove('drop-target');
      const idp = DRAG_ID || (ev.dataTransfer && ev.dataTransfer.getData('text/plain'));
      if(!idp) return;
      const list=Store.pros||[]; const i=list.findIndex(x=>x.id===idp); if(i<0) return;
      list[i].fase=f; Store.pros=list; render();
    });
    col.appendChild(head); col.appendChild(drop); board.appendChild(col);
  });

  (Store.pros||[]).filter(p=>!p.archived).forEach(p=>{
    const col=document.querySelector('.col[data-fase="'+p.fase+'"] .drop');
    col && col.appendChild(cardEl(p));
  });
}

/* ===== Card ===== */
function iconMail(){return '<svg viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/><path d="m4 7 8 6 8-6"/></svg>'}
function iconWA(){return '<svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 0-7.7 13.5L3 21l4.7-1.3A9 9 0 1 0 12 3z"/></svg>'}
function iconEye(){return '<svg viewBox="0 0 24 24"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3.2"/></svg>'}
function iconLink(){return '<svg viewBox="0 0 24 24"><path d="M10 14 6 18a4 4 0 0 1-6-6l4-4"/><path d="M14 10 18 6a4 4 0 1 1 6 6l-4 4"/></svg>'}
function iconAssign(){return '<svg viewBox="0 0 24 24"><path d="M4 13h9M4 17h13M4 9h6"/><circle cx="17" cy="6" r="2.5"/></svg>'}
function iconArchive(){return '<svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="M3 7h18l-2-3H5z"/><path d="M9 12h6"/></svg>'}

function cardEl(p){
  const el=document.createElement('div'); el.className='card'; el.draggable=true; el.setAttribute('data-id',p.id);
  el.addEventListener('dragstart',(ev)=>{ el.classList.add('dragging'); DRAG_ID=p.id; try{ev.dataTransfer.setData('text/plain', p.id);}catch(_){ } });
  el.addEventListener('dragend',()=>{ el.classList.remove('dragging'); DRAG_ID=null; });

  const name=(p.nombre||'')+' '+(p.apellidos||'');
  const meta=(p.email?(' ¬∑ '+p.email):'')+(p.movil?(' ¬∑ '+p.movil):'');
  const locs=(p.locs_text||'').split(',').filter(Boolean).slice(0,2).map(s=>s.trim()).join(', ');
  const badges = []
    .concat(locs?['Loc: '+locs]:[])
    .concat(p.pref_tipo?['Tipo: '+p.pref_tipo]:[])
    .concat(p.eval_ids&&p.eval_ids.length?['Activos: '+p.eval_ids.length]:[]);

  el.innerHTML =
    '<header><div><div class="name">'+esc(name||'(Sin nombre)')+'</div><div class="meta">'+esc(p.fase||'')+esc(meta)+'</div></div>'+
    '<div class="actions">'+
      '<button class="btn-ic view" data-act="edit" title="Abrir ficha">'+iconEye()+'</button>'+
      '<button class="btn-ic assign" data-act="asig" title="Asignar activos">'+iconAssign()+'</button>'+
      '<button class="btn-ic mail" data-act="mail" title="Email">'+iconMail()+'</button>'+
      '<button class="btn-ic wa" data-act="wa" title="WhatsApp">'+iconWA()+'</button>'+
      (p.fase==='EXITO'?('<button class="btn-ic arch" data-act="arch" title="Archivar">'+iconArchive()+'</button>'):'')+
    '</div></header>'+
    '<div class="badges">'+badges.map(b=>'<span class="badge">'+esc(b)+'</span>').join('')+
      ((p.eval_ids&&p.eval_ids.length)?('<span class="badge" title="Activos propuestos">üè†'.repeat(Math.min(5,p.eval_ids.length))+(p.eval_ids.length>5?(' +'+(p.eval_ids.length-5)):'')+'</span>'):'')+
    '</div>';

  el.addEventListener('click',ev=>{
    const btn=ev.target.closest('.btn-ic'); if(!btn) return;
    const act=btn.dataset.act;
    if(act==='edit') openModal(p.id);
    if(act==='asig') openAssign(p.id);
    if(act==='mail') quickMail(p);
    if(act==='wa')   quickWA(p);
    if(act==='arch'){ p.archived=true; const list=Store.pros||[]; const i=list.findIndex(x=>x.id===p.id); if(i>=0){list[i]=p; Store.pros=list;} render(); toast('Archivado'); }
  });

  return el;
}

/* ===== Ficha modal ===== */
let CURR_ID=null;
const chipsWrap=id('p_lchips');
function paintChips(arr){
  chipsWrap.innerHTML='';
  (arr||[]).slice(0,10).forEach(function(l){
    const sp=document.createElement('span'); sp.className='chip';
    sp.innerHTML='<span class="t">'+esc(l)+'</span> <span class="x" data-del="'+esc(l)+'">√ó</span>';
    chipsWrap.appendChild(sp);
  });
}
id('p_ladd').addEventListener('keydown',function(e){
  if(e.key!=='Enter') return;
  e.preventDefault();
  const c=getEditing()||{}; c.locs=c.locs||[];
  const v=(e.target.value||'').trim(); if(!v) return;
  if(c.locs.length>=10){toast('M√°ximo 10');return;}
  if(!c.locs.includes(v)) c.locs.push(v);
  e.target.value=''; paintChips(c.locs);
});
chipsWrap.addEventListener('click',function(e){
  const del=e.target.getAttribute && e.target.getAttribute('data-del'); if(!del) return;
  const c=getEditing()||{}; c.locs=(c.locs||[]).filter(x=>x!==del); paintChips(c.locs);
});

function openModal(idp){
  const list=Store.pros||[]; let p=list.find(x=>x.id===idp);
  CURR_ID = idp || null;
  id('editBack').style.display='flex';
  id('editTitle').textContent = p? 'Editar cliente' : 'Crear cliente';

  const set=(k,v)=>{ const el=id(k); if(el) el.value=(v==null?'':v); };
  const c=Store.cfg||{};
  const defLocs=(Array.isArray(c.localidades)&&c.localidades.length)?c.localidades.slice(0,5):[];
  p = p || {
    id:'p_'+Date.now(), fase:(id('q_name').value||id('q_email').value||id('q_phone').value)?'BUSQUEDA':'CONTACTO',
    nombre:id('q_name').value||'', apellidos:'', email:id('q_email').value||'',
    movil:id('q_phone').value||'', locs:defLocs, locs_text:defLocs.join(', '),
    pref_tipo:id('q_tipo').value||'Tradicional', obj_main:'bruta',
    obj_bruta:Number((Store.cfg?.objetivos?.tradicional?.bruta_pct)??10),
    obj_neta:Number((Store.cfg?.objetivos?.tradicional?.neta_pct)??6),
    obj_flujo:0, inc_psi_rent:false, inc_psi_pmax:false,
    pmax:parseEs(id('q_pmax').value||''),
    ltv:80
  };

  set('p_nombre',p.nombre); set('p_apellidos',p.apellidos); set('p_dni',p.dni);
  set('p_email',p.email); set('p_movil',p.movil); set('p_dir',p.direccion);
  set('p_cp',p.cp); set('p_loc',p.localidad); set('p_fase',p.fase||'CONTACTO');
  id('p_notas').value=p.notas||'';

  paintChips(p.locs||[]);
  id('p_ladd').value='';

  set('p_pref_tipo',p.pref_tipo||'Tradicional');
  set('p_altura',p.altura||'1'); set('p_bajo',p.bajo||'S√≠'); set('p_asc',p.ascensor||'S√≠');
  set('p_reforma', (p.pref_reforma==='no'||p.reforma==='No')?'No':'S√≠');

  // Objetivos
  set('p_obj_main', (p.obj_main||p.obj_tipo||'bruta').toLowerCase());
  set('p_obj_bruta', p.obj_bruta||''); set('p_obj_neta', p.obj_neta||''); set('p_obj_flujo', p.obj_flujo||'');
  id('p_inc_psi_rent').checked=!!p.inc_psi_rent;

  // Presupuesto & financiaci√≥n
  set('p_pmax', p.pmax||''); id('p_inc_psi_pmax').checked=!!p.inc_psi_pmax;
  recalcFin(); recalcAlq();

  // listeners para alquiler objetivo
  ['p_obj_main','p_obj_bruta','p_inc_psi_rent','p_inc_psi_pmax','p_pmax'].forEach(k=>{
    const el=id(k); if(!el) return;
    el.addEventListener(el.type==='checkbox'?'change':'input', recalcAlq);
  });
}
id('editClose').onclick=()=>{ id('editBack').style.display='none'; };
function getEditing(){
  if(!CURR_ID) return null;
  const list=Store.pros||[]; return list.find(x=>x.id===CURR_ID) || null;
}

/* ===== C√°lculos Pmax / financiaci√≥n / alquiler objetivo ===== */
function calcCompraDesdePmax(pmax, incPsiPmax){
  const {itp_pct,notaria,psi} = cfgCalc();
  const rate=itp_pct/100;
  const precio = Math.max(0, (pmax - notaria - (incPsiPmax?psi:0)) / (1+rate));
  const itp_eur = Math.round(precio*rate);
  const totalOp = pmax + (incPsiPmax?0:psi); // si el PSI ya est√° incluido, total==pmax
  return {precio:Math.round(precio), itp:itp_eur, notaria, psi, total:totalOp};
}
function recalcFin(){
  const pmax = parseEs(id('p_pmax').value||'0'); const incPsi = id('p_inc_psi_pmax').checked;
  const r = calcCompraDesdePmax(pmax, incPsi);
  id('p_vcompra').value = n0(r.precio);
  id('p_itp').value     = n0(r.itp);
  id('p_notaria').value = n0(r.notaria);
  id('p_total').value   = n0(r.total);

  const ltv = Math.max(0, Math.min(100, parseEs(id('p_ltv').value||'80')));
  const capFin = Math.round(r.precio * (ltv/100));
  const propios = Math.round((r.precio - capFin) + r.itp + r.notaria + r.psi); // PSI SIEMPRE en propios
  id('p_financiado').value=n0(capFin);
  id('p_propios').value=n0(propios);
}
['p_pmax','p_inc_psi_pmax','p_ltv'].forEach(k=>{
  id(k).addEventListener(k==='p_inc_psi_pmax'?'change':'input', recalcFin);
});
function calcAlquilerObjetivo(pmax, incPsiPmax, incPsiRent, bruta_pct){
  const {itp_pct,notaria,psi} = cfgCalc();
  const rate = itp_pct/100;
  const vcompra = Math.max(0, (pmax - notaria - (incPsiPmax?psi:0)) / (1+rate));
  const itp_eur = Math.round(vcompra*rate);
  const reforma = 0; // si en alg√∫n momento quieres una semilla de reforma, se podr√≠a leer de cfg
  const baseInv = vcompra + itp_eur + notaria + reforma + (incPsiRent?psi:0);
  const alqMensual = (Number(bruta_pct||0)/100) * baseInv / 12;
  return Math.round(alqMensual);
}
function recalcAlq(){
  const show=(id('p_obj_main').value==='bruta');
  id('wrap_alq_obj').style.display = show? '' : 'none';
  if(!show){ id('p_alq_obj').value=''; return; }
  const alq = calcAlquilerObjetivo(
    parseEs(id('p_pmax').value||'0'),
    id('p_inc_psi_pmax').checked,
    id('p_inc_psi_rent').checked,
    parseEs(id('p_obj_bruta').value||'0')
  );
  id('p_alq_obj').value = n0(alq);
}

/* ===== Guardar cliente ===== */
id('saveClient').onclick=function(){
  const list=Store.pros||[]; let p=CURR_ID? list.find(x=>x.id===CURR_ID):null;
  const vals={
    id: p? p.id : ('p_'+Date.now()),
    nombre:id('p_nombre').value.trim(), apellidos:id('p_apellidos').value.trim(),
    dni:id('p_dni').value.trim(), email:id('p_email').value.trim(), movil:id('p_movil').value.trim(),
    direccion:id('p_dir').value.trim(), cp:id('p_cp').value.trim(), localidad:id('p_loc').value.trim(),
    fase:id('p_fase').value, notas:id('p_notas').value,
    locs: (function(){const arr=[]; chipsWrap.querySelectorAll('.t').forEach(t=>arr.push(t.textContent)); return arr;})(),
    locs_text: (function(){const arr=[]; chipsWrap.querySelectorAll('.t').forEach(t=>arr.push(t.textContent)); return arr.join(', ');})(),
    pref_tipo:id('p_pref_tipo').value, altura:id('p_altura').value, bajo:id('p_bajo').value,
    ascensor:id('p_asc').value, pref_reforma: (id('p_reforma').value==='No'?'no':'si'),
    obj_main: id('p_obj_main').value, obj_tipo:id('p_obj_main').value,
    obj_bruta: parseEs(id('p_obj_bruta').value), obj_neta: parseEs(id('p_obj_neta').value),
    obj_flujo: parseEs(id('p_obj_flujo').value), inc_psi_rent: id('p_inc_psi_rent').checked,
    pmax: parseEs(id('p_pmax').value), inc_psi_pmax: id('p_inc_psi_pmax').checked,
    ltv: Math.max(0,Math.min(100,parseEs(id('p_ltv').value||'80'))),
    // caches para filtros/finanzas
    max_compra: parseEs(id('p_vcompra').value), itp_eur:parseEs(id('p_itp').value),
    notaria_eur:parseEs(id('p_notaria').value), total_operacion:parseEs(id('p_total').value),
    cap_fin:parseEs(id('p_financiado').value), fondos_propios:parseEs(id('p_propios').value)
  };
  if(p){ Object.assign(p,vals); } else { list.push(vals); }
  Store.pros=list; id('editBack').style.display='none'; render(); toast('Guardado');
};

/* ===== Crear contacto desde filtros ===== */
id('btn_new').onclick=function(){
  CURR_ID=null; openModal(null);
  id('p_nombre').value=(id('q_name').value||'').trim();
  id('p_email').value=(id('q_email').value||'').trim();
  id('p_movil').value=(id('q_phone').value||'').trim();
  id('p_pref_tipo').value=id('q_tipo').value;
  const locs=(id('q_locs').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  paintChips(locs);
  id('p_pmax').value = id('q_pmax').value||'';
  recalcFin(); recalcAlq();
};

/* ===== Comunicaci√≥n r√°pida ===== */
function getNotifs(){
  const c=Store.cfg||{}; const n=c.notifs||{};
  const brand=(c.brand_name||'Unihouser');
  const subj = (n.email_subject_tpl && String(n.email_subject_tpl).trim()) ? n.email_subject_tpl : (brand+' ¬∑ oportunidad {loc}');
  const body = (n.email_body_tpl && String(n.email_body_tpl).trim()) ? n.email_body_tpl :
'Hola {NOMBRE},\n\nTe contacto desde '+brand+'.\nHablemos cuando te venga bien.';
  const wa   = (n.wa_text_tpl && String(n.wa_text_tpl).trim()) ? n.wa_text_tpl :
'Hola {NOMBRE}, ¬øpuedes hablar?';
  return {brand, subj, body, wa};
}
function quickMail(p){
  const nf=getNotifs();
  const subject = nf.subj.replace(/\{NOMBRE\}/g, (p.nombre||'')).replace(/\{LOC(ALIDAD)?\}/g,(p.locs||[])[0]||'');
  const body = nf.body.replace(/\{NOMBRE\}/g,(p.nombre||''));
  window.open('mailto:'+encodeURIComponent(p.email||'')+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body),'_blank');
}
function quickWA(p){
  const nf=getNotifs();
  const msg = nf.wa.replace(/\{NOMBRE\}/g,(p.nombre||''));
  const phone=(p.movil||'').replace(/[^\d]/g,'');
  window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(msg),'_blank');
}

/* ===== Asignaci√≥n de activos ===== */
let ASIG_ID=null;
function colorForMainKPI(p, e){
  const {amber_ratio}=cfgCalc();
  const kind=(p.obj_main||'bruta').toLowerCase();
  const tgt=Number(kind==='bruta'?p.obj_bruta:kind==='neta'?p.obj_neta:(p.obj_flujo? p.obj_flujo*12:0))||0;
  let val=0;
  if(kind==='bruta') val=Number(e.kpi_bruta||0);
  else if(kind==='neta') val=Number(e.kpi_neta||0);
  else if(kind==='flujo') val=Number(e.kpi_flujo||0);
  if(!tgt || !val) return {color:'red',val};
  if(val>=tgt) return {color:'green',val};
  if(val>=tgt*amber_ratio) return {color:'amber',val};
  return {color:'red',val};
}
function warnBadges(p,e){
  const {warn_only_green}=cfgCalc();
  // S√≥lo se pintan si lo llamamos desde un contexto verde (controlado fuera)
  const warns=[];
  const necesitaReforma=(e.ref_tip && e.ref_tip!=='no');
  const sinAsc=(String(e.asc||'S√≠').toLowerCase()==='no');
  const esBajo=(String(e.bajo||'No').toLowerCase().startsWith('s'));
  const presupuestoMax = Number(p.pmax||0);
  if(necesitaReforma && (p.pref_reforma==='no')) warns.push('Requiere reforma');
  if(sinAsc && (String(p.ascensor||'S√≠').toLowerCase().startsWith('s')===false)) warns.push('Sin ascensor');
  if(esBajo && (String(p.bajo||'S√≠').toLowerCase().startsWith('s')===false)) warns.push('Bajo');
  if(presupuestoMax>0 && Number(e.inv_total||0) > (p.inc_psi_pmax?presupuestoMax:(presupuestoMax+ (Store.cfg?.psi_fee_eur??Store.cfg?.honorarios??4235)))) warns.push('Excede presupuesto');
  return warns;
}
function openAssign(idp){
  ASIG_ID=idp;
  const p=(Store.pros||[]).find(x=>x.id===idp); if(!p){toast('No encontrado');return;}
  id('asigBack').style.display='flex';
  const list=Store.evals||[];
  const box=id('evalList'); box.innerHTML='';
  const chips=id('selChips'); chips.innerHTML='';

  list.forEach(e=>{
    const row=document.createElement('div'); row.className='eval-item'; row.dataset.id=e.id;
    const left=document.createElement('div'); left.className='eval-title';
    const right=document.createElement('div'); right.className='kpiRight';

    const mcol=colorForMainKPI(p,e);
    const dot=document.createElement('span'); dot.className='dot '+mcol.color; left.appendChild(dot);

    const label=document.createElement('div');
    label.innerHTML = '<strong>'+esc(e.loc||'-')+'</strong> ¬∑ '+esc(e.calle||'-')+
      ' <span class="tag">'+esc(e.tipo||'-')+'</span>'+
      ' <span class="tag">'+esc((e.habs||'-')+' hab ¬∑ '+(e.banos||'-')+' ba√±o ¬∑ Alt '+(e.alt||'-')+(String(e.ref_tip||'no')!=='no'?' ¬∑ Reforma':'') )+'</span>'+
      ' <span class="tag">'+esc('Alq '+fmtN0.format(Number(e.alq||0)))+'</span>';
    left.appendChild(label);

    if(mcol.color==='green'){
      const warns=warnBadges(p,e); if(warns.length){
        const wwrap=document.createElement('div'); wwrap.className='warns';
        warns.forEach(w=>{ const b=document.createElement('span'); b.className='tag'; b.textContent=w; wwrap.appendChild(b); });
        left.appendChild(wwrap);
      }
    }

    right.innerHTML=
      '<button class="btn-ic view" data-act="ver" title="Ver">'+iconEye()+'</button>'+
      '<button class="btn-ic mail" data-act="send" title="Enviar">'+iconMail()+'</button>'+
      '<button class="btn-ic" data-act="accept" title="Aceptar" style="border-color:var(--brand);color:var(--brand)">‚úì</button>'+
      '<label class="btn-ic" title="Seleccionar" style="display:inline-grid;place-items:center"><input type="checkbox" data-act="pick" style="width:14px;height:14px"></label>';

    row.appendChild(left); row.appendChild(right); box.appendChild(row);

    row.addEventListener('click',ev=>{
      const b=ev.target.closest('[data-act]'); if(!b) return;
      const act=b.dataset.act;
      if(act==='ver'){ localStorage.setItem('load_eval', e.id); window.location.href='evaluar.html'; }
      if(act==='send'){
        const nf=getNotifs();
        const rb=(Math.round(Number(e.kpi_bruta||0)*10)/10).toFixed(1).replace('.',',');
        const rn=(Math.round(Number(e.kpi_neta ||0)*10)/10).toFixed(1).replace('.',',');
        const subject=(nf.subj||'Oportunidad {loc}').replace('{loc}',e.loc||'');
        const body = (nf.body||'').replace('{NOMBRE}',(p.nombre||''))
          .replace('{loc}',e.loc||'').replace('{calle}',e.calle||'').replace('{tipo}',e.tipo||'')
          .replace('{precio}',e0(e.precio||0)).replace('{inv}',e0(e.inv_total||0))
          .replace('{rb}',rb).replace('{rn}',rn).replace('{fl}',e0(e.kpi_flujo||0))
          .replace('{pmax}',e0(e.pmax||0)).replace('{url}',e.url||'');
        window.open('mailto:'+encodeURIComponent(p.email||'')+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body),'_blank');
      }
      if(act==='accept'){
        const pros=Store.pros||[]; const i=pros.findIndex(x=>x.id===ASIG_ID); if(i>=0){
          const set=new Set(pros[i].eval_ids||[]); set.add(e.id);
          pros[i].eval_ids=[...set]; pros[i].accepted_eval_id=e.id; pros[i].fase='COMPRAVENTA';
          Store.pros=pros;
          id('asigBack').style.display='none'; render(); toast('Activo aceptado ¬∑ a COMPRAVENTA');
        }
      }
      if(act==='pick'){
        const chip=document.createElement('span'); chip.className='chip'; chip.dataset.id=e.id;
        chip.innerHTML=esc((e.loc||'-')+' ¬∑ '+(e.calle||'-'))+' <span class="x" title="Quitar">√ó</span>';
        chip.querySelector('.x').onclick=function(){ chip.remove(); };
        id('selChips').appendChild(chip);
      }
    });
  });

  id('asigSave').onclick=function(){
    const chips=[...id('selChips').querySelectorAll('.chip')].map(c=>c.dataset.id);
    const pros=Store.pros||[]; const i=pros.findIndex(x=>x.id===ASIG_ID); if(i>=0){
      const set=new Set(pros[i].eval_ids||[]); chips.forEach(x=>set.add(x));
      pros[i].eval_ids=[...set]; Store.pros=pros; toast('Asignaci√≥n guardada');
    }
    id('asigBack').style.display='none'; render();
  };
}
id('asigClose').onclick=()=>{ id('asigBack').style.display='none'; };

/* ===== Filtros no destructivos (solo sirven de ‚Äúsemilla‚Äù al crear) ===== */

/* ===== Init ===== */
render();
</script>
</body>
</html>
