<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unihouser ‚Äî Dashboard CRM</title>
  <style>
    :root{
      --granate:#B53928;
      --terracota:#DB824B;
      --verde:#58736F;
      --gris:#DDD5D2;
      --texto:#2b2b2b;
      --bg:#faf8f7;
      --card:#ffffff;
      --muted:#7a6f6b;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial,sans-serif;
      color:var(--texto);
      background:linear-gradient(180deg,var(--gris) 0%, var(--bg) 18%);
    }
    header{display:flex;align-items:center;gap:16px;padding:16px 20px;}
    header .brand{display:flex;align-items:center;gap:12px;}
    header img{height:36px;width:auto}
    header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
    .kpis{margin:6px 20px 18px;display:grid;grid-template-columns:repeat(6,minmax(160px,1fr));gap:12px;}
    .kpi{background:var(--card);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:6px;min-height:64px;}
    .kpi h3{font-size:12px;margin:0;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
    .kpi .val{display:flex;align-items:baseline;justify-content:space-between}
    .kpi .val b{font-size:20px}
    .kpi .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#f1ece9}
    .kpi.ok .pill{background:rgba(88,115,111,.12);color:var(--verde)}
    .kpi.warn .pill{background:rgba(219,130,75,.12);color:var(--terracota)}
    .kpi.bad .pill{background:rgba(181,57,40,.12);color:var(--granate)}
    .board{padding:0 20px 40px;display:grid;grid-template-columns:repeat(6,1fr);gap:14px;}
    .col{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);min-height:60vh;display:flex;flex-direction:column;}
    .col header{padding:12px 12px 8px;border-bottom:1px solid #eee;}
    .col header h2{margin:0;font-size:14px;text-transform:uppercase;letter-spacing:.8px;color:#4a3f3b}
    .col .content{padding:10px;display:flex;flex-direction:column;gap:10px}
    .new-contact{border:1px dashed #c9beb9;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;background:#fbf9f8;}
    .row{display:flex;gap:8px}
    .row input{flex:1}
    input,select,textarea,button{font:inherit;border:1px solid #d8cfca;border-radius:10px;padding:8px 10px;background:#fff;color:var(--texto);outline:none;}
    textarea{resize:vertical;min-height:64px}
    button{cursor:pointer;background:#f6efe9;border-color:#eadfd9}
    button.primary{background:var(--verde);color:#fff;border-color:transparent}
    button.bad{background:var(--granate);color:#fff;border-color:transparent}
    button.accent{background:var(--terracota);color:#fff;border-color:transparent}
    .card{border:1px solid #eee3de;border-radius:14px;padding:10px;background:#fff;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;}
    .card .top{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .name{font-weight:700}
    .days{font-size:12px;color:var(--muted);background:#f3efed;border-radius:999px;padding:3px 8px}
    .msg{display:flex;flex-direction:column;gap:6px}
    .actions{display:flex;flex-wrap:wrap;gap:6px}
    .iconbtn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid #eadfd9;background:#fff;}
    .icon{display:inline-flex;width:16px;height:16px;align-items:center;justify-content:center}
    .icon svg{width:16px;height:16px;display:block}
    .icon.eye svg{fill:var(--verde)}
    .icon.trash svg{fill:var(--granate)}
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.2s ease;z-index:50;}
    #drawer{position:fixed;top:0;right:0;width:560px;max-width:96vw;height:100vh;background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.18);transform:translateX(100%);transition:.28s cubic-bezier(.2,.8,.2,1);z-index:60;display:flex;flex-direction:column;}
    #drawer.open{transform:none}
    #overlay.open{opacity:1;pointer-events:all}
    .dr-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 14px 10px;border-bottom:1px solid #eee}
    .dr-title{font-weight:700}
    /* Cuerpo sin scroll ‚Äî usamos tabs para dividir la info */
    .dr-body{display:flex;flex-direction:column;gap:10px;padding:12px;height:calc(100vh - 66px);}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tabs button{border:1px solid #eadfd9;background:#fbf9f8;border-radius:999px;padding:6px 10px}
    .tabs button.active{background:var(--granate);color:#fff;border-color:transparent}
    .tabarea{flex:1;min-height:0;border:1px solid #eee3de;border-radius:12px;background:#fff;padding:10px;display:flex}
    .tab{display:none;flex:1}
    .tab.active{display:block}
    .frow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .frow.three{grid-template-columns:1fr 1fr 1fr}
    .fcol small.hint{display:block;color:#6f6460;margin-top:4px}
    .pin-actions{display:flex;justify-content:space-between;gap:8px}
    .toaster{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:8px;z-index:100}
    .toast{background:#fff;border-left:6px solid var(--verde);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);min-width:260px;}
    .toast.warn{border-left-color:var(--terracota)}
    .toast.bad{border-left-color:var(--granate)}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;}
    .small{font-size:12px}
    .tight{margin:0}

    /* Lista visual de evaluaciones */
    .eval-list{display:flex;flex-direction:column;gap:8px;max-height:32vh;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px;background:#faf9f8}
    .eval-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid #eee3de;border-radius:10px;padding:8px;background:#fff}
    .eval-title{font-weight:600}
    .eval-sub{color:#6f6460;font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:#f3efed;border:1px solid #eadfd9;border-radius:999px;padding:4px 8px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
    .chip button{background:transparent;border:none;padding:0 2px;cursor:pointer}
    .thumbs{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;}
    .thumbs img,.thumbs video,.thumbs .pdf{width:100%;aspect-ratio:1/1;object-fit:cover;border:1px solid #e7ded9;border-radius:8px;background:#f7f3f1;}
    .pdf{display:flex;align-items:center;justify-content:center;font-size:10px;color:#6b5e58}
    .beta-stack{display:flex;flex-direction:column;gap:8px;max-height:42vh;overflow:auto;border:1px solid #eee;border-radius:12px;padding:8px;}
    .beta-stack object{width:100%;height:260px;border:1px solid #eee;border-radius:8px;}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logo-unihouser.svg" alt="Unihouser" onerror="logoFallback(event)">
      <h1>Dashboard CRM</h1>
    </div>
  </header>

  <section class="kpis" id="kpis"></section>

  <main class="board" id="board">
    <section class="col" data-phase="CONTACTO">
      <header><h2>Contacto</h2></header>
      <div class="content" id="col-CONTACTO">
        <div class="new-contact" id="newContactBox">
          <div class="row">
            <input id="nc_name" placeholder="Nombre y apellidos" />
          </div>
          <div class="row">
            <input id="nc_email" placeholder="Email" type="email" />
            <input id="nc_phone" placeholder="Tel√©fono" />
          </div>
          <button class="primary" id="btnCreate">Crear contacto</button>
          <p class="small muted tight">El mensaje inicial se autocompleta desde Config y queda editable en la tarjeta.</p>
        </div>
      </div>
    </section>

    <section class="col" data-phase="REUNION">
      <header><h2>Reuni√≥n</h2></header>
      <div class="content" id="col-REUNION"></div>
    </section>

    <section class="col" data-phase="CONTRATO">
      <header><h2>Contrato</h2></header>
      <div class="content" id="col-CONTRATO"></div>
    </section>

    <section class="col" data-phase="BUSQUEDA">
      <header><h2>B√∫squeda</h2></header>
      <div class="content" id="col-BUSQUEDA"></div>
    </section>

    <section class="col" data-phase="COMPRAVENTA">
      <header><h2>Compraventa</h2></header>
      <div class="content" id="col-COMPRAVENTA"></div>
    </section>

    <section class="col" data-phase="PAPELERA">
      <header><h2>Papelera</h2></header>
      <div class="content" id="col-PAPELERA"></div>
    </section>
  </main>

  <div id="overlay" aria-hidden="true"></div>
  <aside id="drawer" aria-hidden="true" aria-label="Panel lateral">
    <div class="dr-head">
      <div class="dr-title" id="drTitle">Detalle</div>
      <button id="btnCloseDrawer" class="iconbtn"><span class="icon">
        <svg viewBox="0 0 24 24"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4z"/></svg>
      </span>Cerrar</button>
    </div>
    <div class="dr-body" id="drBody"></div>
  </aside>

  <div class="toaster" id="toaster" aria-live="polite" aria-atomic="true"></div>

  <script>
  'use strict';

  /* ======= DEFAULTS & HELPERS ======= */
  const PHASES = ['CONTACTO','REUNION','CONTRATO','BUSQUEDA','COMPRAVENTA','PAPELERA'];
  const ES = 'es-ES';
  const fmtPct = new Intl.NumberFormat(ES,{style:'percent',minimumFractionDigits:0,maximumFractionDigits:0});

  const DEFAULT_INITIAL_MESSAGE = `Hola!

Gracias por escribirnos y por el inter√©s en lo que hacemos en Unihouser.

Cada inversor es distinto ‚Äîalgunos busc√°is dar vuestro primer paso, otros ya ten√©is experiencia‚Äî as√≠ que preferimos contar de forma clara c√≥mo trabajamos y qu√© aportamos, para que t√∫ decidas si tiene sentido avanzar juntos.

üè† ¬øEn qu√© podemos ayudarte?

‚úî Analizamos y filtramos oportunidades con sentido real, mirando n√∫meros, zonas y estado del inmueble.
‚úî Estimamos contigo todos los costes asociados: compra, reforma, gesti√≥n, posibles imprevistos.
‚úî Te damos una visi√≥n clara del rendimiento esperado (habitaciones, tradicional o mixto).

üí¨ ¬øQu√© necesitamos de ti?
Ganas de avanzar si aparece la oportunidad adecuada. Nos ayuda saber presupuesto orientativo, zonas de inter√©s y expectativas de rentabilidad.

üí∂ ¬øC√≥mo trabajamos?
Honorario fijo y transparente, sin comisiones de agencia. Estamos de tu parte, no del vendedor.

‚ú® ¬øSeguimos hablando?
Si te encaja, cu√©ntanos:
1) Presupuesto aproximado
2) Tipo de inmueble
3) Modelo (habitaciones / tradicional / mixto)

Gracias,
Equipo Unihouser`;

  const DEFAULT_CFG = {
    itp_pct: 0.08,
    notaria: 1200,
    honorarios: 3630,
    kpis: {},
    messages:{ initial: DEFAULT_INITIAL_MESSAGE, initial_subject: 'Inicio ‚Äî Unihouser' },
    emailTemplates:{ contract:{ subject:'Propuesta de Contrato ‚Äî Unihouser', body:`Hola,

Te adjuntamos la plantilla de contrato para revisi√≥n. Si te encaja, d√≠noslo y avanzamos con la firma.

Gracias,
Equipo Unihouser` } }
  };

  const num = (s)=>{ if(typeof s==='number') return s; const t=(s||'').toString().replace(/\./g,'').replace(',','.'); const v=parseFloat(t); return isNaN(v)?0:v; };
  const fmtMoney = (v)=>{ if(v==null||isNaN(v)) return ''; return Math.round(v).toString(); };
  function eur(n){ return new Intl.NumberFormat(ES,{style:'currency',currency:'EUR'}).format(n||0); }
  function uid(prefix){ return prefix + '_' + Math.random().toString(36).slice(2,8); }
  function daysSince(ts){ if(!ts) return 0; const d = Math.floor((Date.now()-ts)/(1000*60*60*24)); return d<0?0:d; }
  function nextPhase(ph){ const i = PHASES.indexOf(ph); return i>=0 && i<PHASES.length-2 ? PHASES[i+1] : (ph==='COMPRAVENTA'?'COMPRAVENTA':'PAPELERA'); }
  function toast(msg,type='ok'){
    const t = document.createElement('div');
    t.className = 'toast' + (type==='warn'?' warn': type==='bad'?' bad':'');
    t.textContent = msg;
    document.getElementById('toaster').appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),240); }, 2500);
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function bytes(n){ if(n<1024) return n+' B'; if(n<1048576) return (n/1024).toFixed(1).replace('.',',')+' KB'; return (n/1048576).toFixed(1).replace('.',',')+' MB'; }
  function isoLocal(v){ const d=new Date(v); const p=x=>String(x).padStart(2,'0'); return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+'T'+p(d.getHours())+':'+p(d.getMinutes()); }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m])); }

  function logoFallback(e){
    e.target.onerror=null;
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='120' height='36' viewBox='0 0 120 36'>
      <rect rx='6' ry='6' width='120' height='36' fill='%23B53928'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-size='16' fill='white'>Unihouser</text>
    </svg>`;
    e.target.src = 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  }

  /* ======= LOCALSTORAGE ======= */
  const LS = {
    getRawCfg(){ const raw = localStorage.getItem('cfg'); if(!raw) return null; try{ return JSON.parse(raw); }catch(_){ return null; } },
    setCfg(cfg){ localStorage.setItem('cfg', JSON.stringify(cfg)); },
    getPros(){ const raw = localStorage.getItem('pros'); if(!raw) return []; try{ return JSON.parse(raw); }catch(_){ return []; } },
    setPros(list){ localStorage.setItem('pros', JSON.stringify(list)); },
    getEvals(){ const raw = localStorage.getItem('evals'); if(!raw) return []; try{ return JSON.parse(raw); }catch(_){ return []; } },
    setEvals(list){ localStorage.setItem('evals', JSON.stringify(list)); },
  };

  function ensureCfgShape(cfgIn){
    const cfg = cfgIn && typeof cfgIn==='object' ? cfgIn : {};
    cfg.itp_pct = typeof cfg.itp_pct==='number' ? cfg.itp_pct : DEFAULT_CFG.itp_pct;
    cfg.notaria = typeof cfg.notaria==='number' ? cfg.notaria : DEFAULT_CFG.notaria;
    cfg.honorarios = typeof cfg.honorarios==='number' ? cfg.honorarios : DEFAULT_CFG.honorarios;
    cfg.kpis = cfg.kpis && typeof cfg.kpis==='object' ? cfg.kpis : {};
    cfg.messages = Object.assign({}, DEFAULT_CFG.messages, cfg.messages||{});
    cfg.emailTemplates = cfg.emailTemplates && typeof cfg.emailTemplates==='object' ? cfg.emailTemplates : {};
    cfg.emailTemplates.contract = Object.assign({}, DEFAULT_CFG.emailTemplates.contract, (cfg.emailTemplates&&cfg.emailTemplates.contract)||{});
    return cfg;
  }

  function getInitialMessage(){
    return (CFG.messages && typeof CFG.messages.initial==='string' && CFG.messages.initial.trim())
      ? CFG.messages.initial
      : DEFAULT_INITIAL_MESSAGE;
  }
  function getInitialSubject(){
    return (CFG.messages && CFG.messages.initial_subject) ? CFG.messages.initial_subject : 'Unihouser';
  }

  /* ======= EVALS helpers (tolerantes) ======= */
  function evId(ev){ return ev.id || ev.ev_id || ev.key || ev.uuid; }
  function evEnsureId(ev){ if(!evId(ev)){ ev.id = 'ev_'+Math.random().toString(36).slice(2,8); } return evId(ev); }
  function evTitle(ev){
    return ev.titulo || ev.title || ev.nombre || ev.direccion || ev.direcci√≥n || ev.ref || ('Evaluaci√≥n '+(evId(ev)||''));
  }
  function evPrice(ev){
    const keys = ['precio','precio_compra','p_compra','price','pmax','precioMax'];
    for(const k of keys){ if(typeof ev[k]==='number') return ev[k]; }
    if(ev.costes && typeof ev.costes.compra==='number') return ev.costes.compra;
    return null;
  }
  function evYieldBruta(ev){
    const keys = ['bruta','kpi_bruta','rent_bruta','rentabilidad_bruta','rb'];
    for(const k of keys){ if(typeof ev[k]==='number') return ev[k]; }
    if(ev.kpis && typeof ev.kpis.bruta==='number') return ev.kpis.bruta;
    return null;
  }
  function evYieldNeta(ev){
    const keys = ['neta','kpi_neta','rent_neta','rentabilidad_neta','rn'];
    for(const k of keys){ if(typeof ev[k]==='number') return ev[k]; }
    if(ev.kpis && typeof ev.kpis.neta==='number') return ev.kpis.neta;
    return null;
  }

  /* ======= Estado ======= */
  let CFG = ensureCfgShape(LS.getRawCfg());
  LS.setCfg(CFG);
  let PROS = LS.getPros();
  let EVALS = LS.getEvals();

  (function ensureEvalIds(){
    let changed = false;
    for(const ev of EVALS){ if(!evId(ev)){ evEnsureId(ev); changed = true; } }
    if(changed){ LS.setEvals(EVALS); }
  })();

  function renderAll(){ renderKPIs(); renderColumns(); }

  function renderKPIs(){
    const wrap = document.getElementById('kpis'); wrap.innerHTML = '';
    const counts = {}; let exitos = 0;
    for(const ph of PHASES) counts[ph] = {ok:0,ko:0};
    for(const p of PROS){
      if(p.success) exitos++;
      if(p.phase==='PAPELERA') continue;
      const h = p.history||{};
      for(const ph of Object.keys(h)){
        if(!counts[ph]) counts[ph] = {ok:0,ko:0};
        const v = h[ph];
        if(v==='OK') counts[ph].ok++; else if(v==='KO') counts[ph].ko++;
      }
    }
    const makeCard = (title, ok, ko) =>{
      const tot = ok+ko, okPct = tot? (ok/tot):0;
      const div = document.createElement('div'); div.className='kpi';
      div.innerHTML = `<h3>${title}</h3>
        <div class="val"><b>${fmtPct.format(okPct)}</b><span class="pill">${ok} OK / ${ko} KO</span></div>`;
      if(okPct>=.7) div.classList.add('ok'); else if(okPct>=.4) div.classList.add('warn'); else div.classList.add('bad');
      return div;
    };
    wrap.appendChild(makeCard('Contacto', counts.CONTACTO.ok, counts.CONTACTO.ko));
    wrap.appendChild(makeCard('Reuni√≥n', counts.REUNION.ok, counts.REUNION.ko));
    wrap.appendChild(makeCard('Contrato', counts.CONTRATO.ok, counts.CONTRATO.ko));
    wrap.appendChild(makeCard('B√∫squeda', counts.BUSQUEDA.ok, counts.BUSQUEDA.ko));
    wrap.appendChild(makeCard('Compraventa', counts.COMPRAVENTA.ok, counts.COMPRAVENTA.ko));
    const ex = document.createElement('div'); ex.className='kpi ok';
    ex.innerHTML = `<h3>√âxitos</h3><div class="val"><b>${exitos}</b><span class="pill">Cierres notar√≠a</span></div>`;
    wrap.appendChild(ex);
  }

  function renderColumns(){
    for(const ph of PHASES){
      const col = document.getElementById('col-'+ph);
      if(!col) continue;
      const keep = ph==='CONTACTO' ? [document.getElementById('newContactBox')] : [];
      col.innerHTML = '';
      for(const k of keep){ if(k) col.appendChild(k); }
    }
    const copy = PROS.slice();
    const prosByPhase = {}; for(const ph of PHASES){ prosByPhase[ph]=[]; }
    for(const p of copy){ prosByPhase[p.phase||'CONTACTO'].push(p); }
    prosByPhase['REUNION'].sort((a,b)=>{
      const ad = a.meeting?.date ? new Date(a.meeting.date).getTime(): Number.MAX_SAFE_INTEGER;
      const bd = b.meeting?.date ? new Date(b.meeting.date).getTime(): Number.MAX_SAFE_INTEGER;
      return ad - bd;
    });
    for(const ph of PHASES){
      const list = prosByPhase[ph];
      for(const p of list){
        if(p.success) continue;
        const card = makeCard(p);
        document.getElementById('col-'+ph).appendChild(card);
      }
    }
  }

  function makeCard(p){
    const el = document.createElement('div');
    el.className='card'; el.dataset.id = p.id;
    const d = daysSince(p.phase_entered_at);
    const msgVal = (typeof p.message==='string' && p.message.trim()) ? p.message : getInitialMessage();
    el.innerHTML = `
      <div class="top">
        <div class="name">${escapeHtml(p.name||'Sin nombre')}</div>
        <div class="days">${d} ${d===1?'d√≠a':'d√≠as'}</div>
      </div>
      <div class="msg">
        <textarea data-role="msg">${escapeHtml(msgVal)}</textarea>
        <div class="actions">
          <button class="iconbtn" data-act="copy"><span class="icon">
            <svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg>
          </span>Copiar</button>
          <a class="iconbtn" data-act="email" href="${mailtoHref(p, msgVal)}"><span class="icon">
            <svg viewBox="0 0 24 24"><path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 2v.01L12 13 4 6.01V6h16zM4 18V8l8 6 8-6v10H4z"/></svg>
          </span>Email</a>
          <button class="iconbtn" data-act="details"><span class="icon eye">
            <svg viewBox="0 0 24 24"><path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10zm0-8a3 3 0 100 6 3 3 0 000-6z"/></svg>
          </span>Detalles</button>
          ${p.phase!=='PAPELERA' ? `<button class="primary" data-act="advance">Avanzar</button>
          <button class="bad" data-act="discard">Descartar</button>` :
          `<button class="accent" data-act="restore">Restaurar</button>
           <button class="bad" data-act="delete">Eliminar</button>`}
        </div>
      </div>
    `;
    el.querySelector('[data-role="msg"]').addEventListener('input', (e)=>{
      p.message = e.target.value; persistPros();
    });
    el.querySelector('[data-act="copy"]').addEventListener('click', ()=>{
      copyToClipboard((p.message||getInitialMessage())); toast('Mensaje copiado','ok');
    });
    el.querySelector('[data-act="email"]').addEventListener('click', (ev)=>{
      ev.currentTarget.setAttribute('href', mailtoHref(p, (p.message||getInitialMessage())));
    });
    const det = el.querySelector('[data-act="details"]'); if(det) det.addEventListener('click', ()=> openDrawerFor(p));
    const adv = el.querySelector('[data-act="advance"]'); if(adv) adv.addEventListener('click', ()=> advanceProspect(p));
    const disc = el.querySelector('[data-act="discard"]'); if(disc) disc.addEventListener('click', ()=> discardProspect(p));
    const rest = el.querySelector('[data-act="restore"]'); if(rest) rest.addEventListener('click', ()=> restoreFromBin(p));
    const del = el.querySelector('[data-act="delete"]'); if(del) del.addEventListener('click', ()=> deleteForever(p));
    return el;
  }

  function mailtoHref(p, bodyText){
    const subj = encodeURIComponent(getInitialSubject());
    const body = encodeURIComponent((bodyText||'').trim());
    const to = encodeURIComponent(p.email||'');
    return `mailto:${to}?subject=${subj}&body=${body}`;
  }

  function copyToClipboard(text){
    const ta = document.createElement('textarea');
    ta.className='sr-only'; ta.value = text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
  }
  function persistPros(){ LS.setPros(PROS); renderKPIs(); }

  function advanceProspect(p){
    const from = p.phase;
    const to = nextPhase(from);
    if(to===from){ toast('Ya est√°s en la √∫ltima fase.','warn'); return; }
    p.history = p.history||{}; p.history[from] = 'OK';
    p.phase = to; p.phase_entered_at = Date.now();
    persistPros(); renderColumns(); toast(`Avanzado a ${to}`,'ok');
  }
  function discardProspect(p){
    const from = p.phase;
    p.history = p.history||{}; p.history[from] = 'KO';
    p.phase = 'PAPELERA'; p.phase_entered_at = Date.now();
    persistPros(); renderColumns(); toast('Movido a Papelera','bad');
  }
  function restoreFromBin(p){ p.phase = 'CONTACTO'; p.phase_entered_at = Date.now(); persistPros(); renderColumns(); toast('Restaurado a Contacto','ok'); }
  function deleteForever(p){ PROS = PROS.filter(x=>x.id!==p.id); persistPros(); renderColumns(); toast('Prospecto eliminado','bad'); }

  /* ======= CREACI√ìN CONTACTO ======= */
  document.getElementById('btnCreate').addEventListener('click', ()=>{
    const name = (document.getElementById('nc_name').value||'').trim();
    const email = (document.getElementById('nc_email').value||'').trim();
    const phone = (document.getElementById('nc_phone').value||'').trim();
    if(!name){ toast('Pon un nombre para crear el contacto.','warn'); return; }
    const p = {
      id: uid('p'),
      name, email, phone,
      phase: 'CONTACTO',
      phase_entered_at: Date.now(),
      history: {},
      message: getInitialMessage(),
      meeting: { date:'', notas:'' },         // ‚Üê sin ‚Äúcanal‚Äù, una sola ‚ÄúNotas‚Äù
      profile: {},
      contract: { template:null },
      busqueda: { propuestas:[], adjuntos:[] },
      compraventa: { financiacion:0, notaria:'' },
      success: false
    };
    PROS.push(p); persistPros(); renderColumns();
    document.getElementById('nc_name').value='';
    document.getElementById('nc_email').value='';
    document.getElementById('nc_phone').value='';
    toast('Contacto creado','ok');
  });

  /* ======= DRAWER ======= */
  const overlay = document.getElementById('overlay');
  const drawer = document.getElementById('drawer');
  const drTitle = document.getElementById('drTitle');
  const drBody = document.getElementById('drBody');
  document.getElementById('btnCloseDrawer').addEventListener('click', closeDrawer);
  overlay.addEventListener('click', closeDrawer);
  let CURRENT = null;

  function openDrawerFor(p){
    CURRENT = p;
    drTitle.textContent = `${p.name||'Sin nombre'} ‚Äî ${phaseLabel(p.phase)}`;
    drBody.innerHTML = '';
    if(p.phase==='REUNION'){ renderMeeting(p); }
    else if(p.phase==='CONTRATO'){ renderContract(p); }
    else if(p.phase==='BUSQUEDA'){ renderBusqueda(p); }
    else if(p.phase==='COMPRAVENTA'){ renderCompraventa(p); }
    else { renderQuick(p); }
    overlay.classList.add('open'); drawer.classList.add('open');
    drawer.setAttribute('aria-hidden','false'); overlay.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){
    drawer.classList.remove('open'); overlay.classList.remove('open');
    drawer.setAttribute('aria-hidden','true'); overlay.setAttribute('aria-hidden','true');
    setTimeout(()=>{ drBody.innerHTML=''; CURRENT=null; }, 220);
  }
  function phaseLabel(ph){
    switch(ph){
      case 'CONTACTO': return 'Contacto';
      case 'REUNION': return 'Reuni√≥n';
      case 'CONTRATO': return 'Contrato';
      case 'BUSQUEDA': return 'B√∫squeda';
      case 'COMPRAVENTA': return 'Compraventa';
      case 'PAPELERA': return 'Papelera';
      default: return ph;
    }
  }

  function renderQuick(p){
    drBody.innerHTML = `
      <div class="frow">
        <div><label>Nombre</label><input value="${escapeHtml(p.name||'')}" id="q_name"/></div>
        <div><label>Tel√©fono</label><input value="${escapeHtml(p.phone||'')}" id="q_phone"/></div>
      </div>
      <div><label>Email</label><input value="${escapeHtml(p.email||'')}" id="q_email"/></div>
      <button class="primary" id="q_save">Guardar</button>
    `;
    document.getElementById('q_save').addEventListener('click', ()=>{
      p.name = document.getElementById('q_name').value;
      p.phone = document.getElementById('q_phone').value;
      p.email = document.getElementById('q_email').value;
      persistPros(); renderColumns(); toast('Guardado','ok');
      drTitle.textContent = `${p.name||'Sin nombre'} ‚Äî ${phaseLabel(p.phase)}`;
    });
  }

  /* ======= REUNI√ìN (sin scroll, orden l√≥gico, tabs) ======= */
  function renderMeeting(p){
    const m = p.meeting || (p.meeting={date:'', notas:''});
    const pr = p.profile || (p.profile={});

    drBody.innerHTML = `
      <div class="tabs" role="tablist">
        <button class="active" data-tab="t1" role="tab" aria-selected="true">Datos</button>
        <button data-tab="t2" role="tab">Inversi√≥n</button>
        <button data-tab="t3" role="tab">Financiaci√≥n</button>
        <button data-tab="t4" role="tab">Objetivos</button>
        <button data-tab="t5" role="tab">Notas</button>
      </div>

      <div class="tabarea">
        <div id="t1" class="tab active" role="tabpanel" aria-labelledby="Datos">
          <div class="frow three">
            <div class="fcol"><label>Fecha y hora</label><input type="datetime-local" id="m_date" value="${m.date? isoLocal(m.date):''}"></div>
            <div class="fcol"><label>DNI</label><input id="pf_dni" value="${escapeHtml(pr.dni||'')}" placeholder="00000000X"></div>
            <div class="fcol"><label>Localidad (residencia)</label><input id="pf_locres" value="${escapeHtml(pr.locres||'')}"></div>
          </div>
          <div class="frow three">
            <div class="fcol"><label>Tel√©fono</label><input id="pf_tel" value="${escapeHtml(p.phone||pr.tel||'')}"></div>
            <div class="fcol"><label>Email</label><input id="pf_email" value="${escapeHtml(p.email||pr.email||'')}"></div>
            <div class="fcol"><label>Direcci√≥n</label><input id="pf_dir" value="${escapeHtml(pr.dir||'')}" placeholder="C/ ‚Ä¶ n¬∫ ‚Ä¶"></div>
          </div>
        </div>

        <div id="t2" class="tab" role="tabpanel" aria-labelledby="Inversi√≥n">
          <div class="frow three">
            <div class="fcol"><label>Localidades objetivo</label><input id="pf_locs" value="${escapeHtml(pr.locs||'')}" placeholder="Oviedo, Gij√≥n, Avil√©s"></div>
            <div class="fcol"><label>Tipo de alquiler</label>
              <select id="pf_tipo">
                <option ${pr.tipo==='Tradicional'?'selected':''}>Tradicional</option>
                <option ${pr.tipo==='Habitaciones'?'selected':''}>Habitaciones</option>
              </select>
            </div>
            <div class="fcol"><label>N¬∫ activos</label><input id="pf_nact" value="${escapeHtml(pr.nact||'')}" inputmode="numeric" placeholder="1"></div>
          </div>
          <div class="frow three">
            <div class="fcol"><label>¬øAscensor?</label><select id="pf_asc"><option ${pr.asc!=='No'?'selected':''}>S√≠</option><option ${pr.asc==='No'?'selected':''}>No</option></select></div>
            <div class="fcol"><label>Altura m√°x.</label><input id="pf_alt" value="${escapeHtml(pr.alt||'')}" inputmode="numeric" placeholder="3"></div>
            <div class="fcol"><label>¬øBajos?</label><select id="pf_bajos"><option ${pr.bajos!=='S√≠'?'selected':''}>No</option><option ${pr.bajos==='S√≠'?'selected':''}>S√≠</option></select></div>
          </div>
          <div class="frow three">
            <div class="fcol"><label>Acepta reforma</label>
              <select id="pf_ref"><option ${pr.ref==='No'?'selected':''}>No</option><option ${pr.ref==='Lavado de cara'?'selected':''}>Lavado de cara</option><option ${pr.ref==='Integral'?'selected':''}>Integral</option></select>
            </div>
            <div class="fcol"><label>Presupuesto TOTAL (‚Ç¨)</label><input id="pf_budget" value="${pr.budget!=null?fmtMoney(pr.budget):''}" placeholder="150000"></div>
            <div class="fcol"><label>Precio m√°x. COMPRA</label><input id="pf_pmax" value="${pr.pmax!=null?fmtMoney(pr.pmax):''}" disabled><small class="small muted">Usa ITP/Notar√≠a/Honorarios de Config.</small></div>
          </div>
        </div>

        <div id="t3" class="tab" role="tabpanel" aria-labelledby="Financiaci√≥n">
          <div class="frow three">
            <div class="fcol"><label>Financiaci√≥n bancaria</label><select id="pf_fin"><option ${pr.fin!=='No'?'selected':''}>S√≠</option><option ${pr.fin==='No'?'selected':''}>No</option></select></div>
            <div class="fcol"><label>¬øNecesita broker?</label><select id="pf_broker"><option ${pr.broker!=='S√≠'?'selected':''}>No</option><option ${pr.broker==='S√≠'?'selected':''}>S√≠</option></select></div>
            <div class="fcol"><label>% financiaci√≥n</label><input id="pf_pct" value="${pr.pct!=null?String(pr.pct).replace('.',','):''}" placeholder="80,0"></div>
          </div>
          <div class="frow three">
            <div class="fcol"><label>Hipoteca estimada</label><input id="pf_hip" value="${pr.hip!=null?fmtMoney(pr.hip):''}" disabled></div>
            <div class="fcol"><label>Fondos propios</label><input id="pf_prop" value="${pr.prop!=null?fmtMoney(pr.prop):''}" disabled></div>
            <div class="fcol"><small class="small muted">El % se aplica al P. m√°x. compra.</small></div>
          </div>
        </div>

        <div id="t4" class="tab" role="tabpanel" aria-labelledby="Objetivos">
          <div class="frow three">
            <div class="fcol"><label>Objetivo principal</label>
              <select id="pf_objt">
                <option value="bruta" ${pr.objt==='bruta'?'selected':''}>Rentabilidad bruta (%)</option>
                <option value="neta" ${pr.objt==='neta'?'selected':''}>Rentabilidad neta (%)</option>
                <option value="flujo" ${pr.objt==='flujo'?'selected':''}>Flujo de caja (‚Ç¨/mes)</option>
              </select>
            </div>
            <div class="fcol"><label>Valor objetivo</label><input id="pf_objv" value="${pr.objv!=null?String(pr.objv).replace('.',','):''}" placeholder="7,5 o 300"></div>
            <div class="fcol"><label>Periodo</label>
              <div class="frow"><input id="pf_ini" value="${escapeHtml(pr.ini||'')}" placeholder="MM/AAAA"><input id="pf_finmes" value="${escapeHtml(pr.finmes||'')}" placeholder="MM/AAAA"></div>
            </div>
          </div>
          <div class="frow" id="row_alq">
            <div class="fcol">
              <label>Alquiler m√°x. orientativo (‚Ç¨/mes)</label>
              <input id="pf_alq" value="${pr.alq!=null?fmtMoney(pr.alq):''}" disabled>
              <small class="small muted">Rb% √ó (Presupuesto TOTAL / 12).</small>
            </div>
          </div>
        </div>

        <div id="t5" class="tab" role="tabpanel" aria-labelledby="Notas">
          <div><label>Notas (final)</label><textarea id="m_notas" rows="6">${escapeHtml(m.notas||'')}</textarea></div>
        </div>
      </div>

      <div class="pin-actions">
        <button class="primary" id="pf_saveall">Guardar ficha</button>
        <button class="iconbtn" id="m_save">Guardar fecha y notas</button>
      </div>
    `;

    // Tabs
    drBody.querySelectorAll('.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        drBody.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        drBody.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.getAttribute('data-tab');
        const tab = document.getElementById(id);
        if(tab) tab.classList.add('active');
      });
    });

    // Referencias ficha
    const get = (id)=>document.getElementById(id);
    const inputs = {
      dni:get('pf_dni'), tel:get('pf_tel'), locres:get('pf_locres'),
      email:get('pf_email'), dir:get('pf_dir'),
      locs:get('pf_locs'), tipo:get('pf_tipo'), nact:get('pf_nact'),
      asc:get('pf_asc'), alt:get('pf_alt'), bajos:get('pf_bajos'), ref:get('pf_ref'),
      budget:get('pf_budget'), pmax:get('pf_pmax'),
      fin:get('pf_fin'), broker:get('pf_broker'), pct:get('pf_pct'),
      hip:get('pf_hip'), prop:get('pf_prop'),
      objt:get('pf_objt'), objv:get('pf_objv'),
      ini:get('pf_ini'), finmes:get('pf_finmes'),
      alq:get('pf_alq')
    };

    function readProfile(){
      return {
        dni: inputs.dni.value.trim(), tel: inputs.tel.value.trim(), locres: inputs.locres.value.trim(),
        email: inputs.email.value.trim(), dir: inputs.dir.value.trim(),
        locs: inputs.locs.value.trim(), tipo: inputs.tipo.value, nact: inputs.nact.value.trim(),
        asc: inputs.asc.value, alt: inputs.alt.value.trim(), bajos: inputs.bajos.value, ref: inputs.ref.value,
        budget: num(inputs.budget.value), pmax: num(inputs.pmax.value),
        fin: inputs.fin.value, broker: inputs.broker.value, pct: num(inputs.pct.value),
        hip: num(inputs.hip.value), prop: num(inputs.prop.value),
        objt: inputs.objt.value, objv: num(inputs.objv.value),
        ini: inputs.ini.value.trim(), finmes: inputs.finmes.value.trim(),
        alq: num(inputs.alq.value)
      };
    }

    function writeProfile(prx){
      inputs.dni.value = prx.dni||'';
      inputs.tel.value = (p.phone||prx.tel||'');
      inputs.locres.value = prx.locres||'';
      inputs.email.value = (p.email||prx.email||'');
      inputs.dir.value = prx.dir||'';
      inputs.locs.value = prx.locs||'';
      inputs.tipo.value = prx.tipo||'Tradicional';
      inputs.nact.value = prx.nact||'';
      inputs.asc.value = prx.asc==='No'?'No':'S√≠';
      inputs.alt.value = prx.alt||'';
      inputs.bajos.value = prx.bajos==='S√≠'?'S√≠':'No';
      inputs.ref.value = prx.ref||'No';
      inputs.budget.value = prx.budget!=null?fmtMoney(prx.budget):'';
      inputs.pmax.value = prx.pmax!=null?fmtMoney(prx.pmax):'';
      inputs.fin.value = prx.fin==='No'?'No':'S√≠';
      inputs.broker.value = prx.broker==='S√≠'?'S√≠':'No';
      inputs.pct.value = prx.pct!=null?String(prx.pct).replace('.',','):'';
      inputs.hip.value = prx.hip!=null?fmtMoney(prx.hip):'';
      inputs.prop.value = prx.prop!=null?fmtMoney(prx.prop):'';
      inputs.objt.value = prx.objt||'bruta';
      inputs.objv.value = prx.objv!=null?String(prx.objv).replace('.',','):'';
      inputs.ini.value = prx.ini||'';
      inputs.finmes.value = prx.finmes||'';
      inputs.alq.value = prx.alq!=null?fmtMoney(prx.alq):'';
      document.getElementById('row_alq').style.display = inputs.objt.value==='bruta' ? 'grid' : 'none';
    }
    writeProfile(pr);

    function calcDerived(){
      const budget = num(inputs.budget.value);
      const itp = CFG.itp_pct||0; const notaria = CFG.notaria||0; const honor = CFG.honorarios||0;
      let pmax = 0;
      if(budget>0){
        const base = budget - (notaria + honor);
        pmax = base>0 ? base / (1+itp) : 0;
      }
      inputs.pmax.value = pmax?fmtMoney(pmax):'';

      const pct = num(inputs.pct.value)/100;
      let hip = 0, prop = 0;
      if(inputs.fin.value==='S√≠'){ hip = pmax * pct; }
      const costeTotal = pmax*(1+itp) + notaria + honor;
      prop = costeTotal - hip;
      inputs.hip.value = hip?fmtMoney(hip):'';
      inputs.prop.value = prop?fmtMoney(prop):'';

      if(inputs.objt.value==='bruta'){
        const rb = num(inputs.objv.value)/100;
        const alq = rb * (budget/12);
        inputs.alq.value = alq?fmtMoney(alq):'';
        document.getElementById('row_alq').style.display = 'grid';
      }else{
        inputs.alq.value='';
        document.getElementById('row_alq').style.display = 'none';
      }
    }
    function maybeAutofin(){
      const v = (inputs.ini.value||'').trim();
      if(!v || (inputs.finmes.value||'').trim()) return;
      const m = v.split('/'); if(m.length!==2) return;
      const mm = parseInt(m[0],10)-1; const yyyy = parseInt(m[1],10);
      if(isNaN(mm)||isNaN(yyyy)) return;
      const d = new Date(yyyy, mm, 1); d.setMonth(d.getMonth()+5);
      const mm2 = String(d.getMonth()+1).padStart(2,'0'); const yyyy2 = d.getFullYear();
      inputs.finmes.value = `${mm2}/${yyyy2}`;
    }

    ['pf_budget','pf_pct','pf_fin','pf_objt','pf_objv'].forEach(id=>{
      document.getElementById(id).addEventListener('input', calcDerived);
      document.getElementById(id).addEventListener('change', calcDerived);
    });
    inputs.ini.addEventListener('blur', maybeAutofin);
    calcDerived();

    // Guardar ficha y reuni√≥n/NOTAS (al final)
    document.getElementById('pf_saveall').addEventListener('click', ()=>{
      p.email = inputs.email.value.trim();
      p.phone = inputs.tel.value.trim();
      p.profile = readProfile();
      calcDerived();                       // rehace c√°lculos y guarda resultados
      p.profile = readProfile();
      toast('Ficha de prospecto guardada','ok');
      persistPros();
    });

    document.getElementById('m_save').addEventListener('click', ()=>{
      m.date = document.getElementById('m_date').value;
      m.notas = document.getElementById('m_notas').value;
      p.meeting = m;
      persistPros(); renderColumns(); toast('Fecha y notas guardadas','ok');
    });
  }

  function renderContract(p){
    const c = p.contract || (p.contract={template:null});
    const tplName = c.template?.name || 'Sin plantilla';
    const tplInfo = c.template ? `${tplName} (${bytes(c.template.size)})` : '‚Äî';
    drBody.innerHTML = `
      <div><label>Plantilla de contrato (.docx/.pdf)</label>
        <input type="file" id="c_tpl" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
        <p class="small muted tight">Se guarda referencia (nombre y tama√±o) ‚Äî sin subir contenido.</p>
      </div>
      <div><b>Actual:</b> <span id="c_tpl_info">${escapeHtml(tplInfo)}</span></div>
      <div class="frow">
        <div><label>Asunto (Config)</label><input id="c_subj" value="${escapeHtml(CFG.emailTemplates.contract.subject)}"/></div>
        <div style="display:flex;align-items:end;justify-content:flex-end"><a id="c_mailto" class="iconbtn" target="_blank">Abrir mail</a></div>
      </div>
      <div><label>Cuerpo (Config)</label><textarea id="c_body" rows="6">${escapeHtml(CFG.emailTemplates.contract.body)}</textarea></div>
      <button class="primary" id="c_save">Guardar</button>
    `;
    const f = document.getElementById('c_tpl');
    f.addEventListener('change', ()=>{
      const file = f.files && f.files[0];
      if(!file) return;
      if(!/pdf|doc|word/i.test(file.type) && !/\.(pdf|docx?|DOCX?)$/.test(file.name)){ toast('Formato no soportado','warn'); return; }
      p.contract = { template:{ name:file.name, size:file.size, type:file.type, at: Date.now() } };
      document.getElementById('c_tpl_info').textContent = `${file.name} (${bytes(file.size)})`;
      persistPros(); toast('Plantilla referenciada','ok');
    });
    const mailA = document.getElementById('c_mailto');
    const subjI = document.getElementById('c_subj');
    const bodyI = document.getElementById('c_body');
    function refreshMailto(){
      const s = encodeURIComponent(subjI.value||'Unihouser');
      const b = encodeURIComponent(bodyI.value||'');
      const to = encodeURIComponent(p.email||'');
      mailA.href = `mailto:${to}?subject=${s}&body=${b}`;
    }
    subjI.addEventListener('input', refreshMailto);
    bodyI.addEventListener('input', refreshMailto);
    refreshMailto();
    document.getElementById('c_save').addEventListener('click', ()=>{
      CFG.emailTemplates.contract.subject = subjI.value;
      CFG.emailTemplates.contract.body = bodyI.value;
      LS.setCfg(CFG);
      toast('Contrato actualizado (Config + prospecto)','ok');
    });
  }

  function renderBusqueda(p){
    const b = p.busqueda || (p.busqueda={propuestas:[], adjuntos:[]});

    drBody.innerHTML = `
      <div class="frow">
        <div>
          <label>Buscar evaluaciones</label>
          <input id="b_q" placeholder="Filtrar por texto..." />
        </div>
        <div>
          <label>Seleccionados (m√°x 4)</label>
          <div id="b_chips" class="chips"></div>
        </div>
      </div>

      <div class="eval-list" id="b_list"></div>

      <div class="small muted">Adjuntar im√°genes / v√≠deos / PDFs</div>
      <input type="file" id="b_files" multiple accept="image/*,video/*,application/pdf" />
      <p class="small muted tight">V√≠deos > 2 MB ‚Üí error (toast) y se descartan.</p>
      <div class="thumbs" id="b_thumbs"></div>
      <button class="iconbtn" id="b_merge">Fusionar PDFs (BETA)</button>
      <div id="b_stack" class="beta-stack" style="display:none;"></div>
      <button class="primary" id="b_save">Guardar b√∫squeda</button>
    `;

    const EVS = EVALS.map(ev=>{
      evEnsureId(ev);
      return { _raw: ev, id: evId(ev), title: evTitle(ev), price: evPrice(ev), rb: evYieldBruta(ev), rn: evYieldNeta(ev) };
    });

    const chips = document.getElementById('b_chips');
    function renderChips(){
      chips.innerHTML = '';
      for(const id of b.propuestas){
        const ev = EVS.find(x=>x.id===id);
        const lab = ev ? ev.title : id;
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `${escapeHtml(lab)} <button aria-label="Quitar" data-id="${escapeHtml(id)}">√ó</button>`;
        chips.appendChild(chip);
      }
      chips.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          b.propuestas = b.propuestas.filter(x=>x!==id);
          persistPros(); renderChips(); renderList();
          toast('Propuesta quitada','warn');
        });
      });
    }

    const list = document.getElementById('b_list');
    const q = document.getElementById('b_q');

    function renderList(){
      const txt = (q.value||'').toLowerCase();
      const maxed = b.propuestas.length>=4;
      const filtered = EVS.filter(x=> !txt || (x.title||'').toLowerCase().includes(txt));
      list.innerHTML = '';
      for(const it of filtered){
        const sel = b.propuestas.includes(it.id);
        const price = (typeof it.price==='number') ? ' ¬∑ '+eur(it.price) : '';
        const rb = (typeof it.rb==='number') ? ` ¬∑ Bruta ${(it.rb*100).toFixed(1).replace('.',',')}%` : '';
        const rn = (typeof it.rn==='number') ? ` ¬∑ Neta ${(it.rn*100).toFixed(1).replace('.',',')}%` : '';
        const div = document.createElement('div');
        div.className = 'eval-item';
        div.innerHTML = `
          <div>
            <div class="eval-title">${escapeHtml(it.title)}</div>
            <div class="eval-sub small muted">ID: ${escapeHtml(it.id)}${price}${rb}${rn}</div>
          </div>
          <div>
            <button class="${sel?'bad':'primary'}" data-id="${escapeHtml(it.id)}">${sel?'Quitar':'A√±adir'}</button>
          </div>
        `;
        const btn = div.querySelector('button');
        btn.addEventListener('click', ()=>{
          const id = it.id;
          if(b.propuestas.includes(id)){
            b.propuestas = b.propuestas.filter(x=>x!==id);
            toast('Propuesta quitada','warn');
          }else{
            if(b.propuestas.length>=4){ toast('L√≠mite 4 propuestas','bad'); return; }
            b.propuestas.push(id);
            toast('Propuesta a√±adida','ok');
          }
          persistPros(); renderChips(); renderList();
        });
        if(maxed && !sel){ btn.disabled = true; }
        list.appendChild(div);
      }
    }

    renderChips(); renderList();

    const thumbs = document.getElementById('b_thumbs');
    function renderThumbs(){
      thumbs.innerHTML='';
      for(const a of (b.adjuntos||[])){
        if(a.kind==='image'){
          const img = document.createElement('img'); img.alt=a.name; if(a.preview){ img.src = a.preview; }
          thumbs.appendChild(img);
        }else if(a.kind==='video'){
          const v = document.createElement('video'); v.muted=true; v.controls=false; v.loop=true; if(a.preview){ v.src=a.preview; }
          thumbs.appendChild(v);
        }else if(a.kind==='pdf'){
          const div = document.createElement('div'); div.className='pdf'; div.textContent='PDF';
          thumbs.appendChild(div);
        }
      }
    }
    renderThumbs();

    document.getElementById('b_files').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files||[]);
      b.adjuntos = b.adjuntos||[];
      for(const f of files){
        const isVideo = /^video\//i.test(f.type);
        if(isVideo && f.size> (2*1024*1024)){ toast(`V√≠deo demasiado grande: ${f.name}`,'bad'); continue; }
        const kind = /^image\//i.test(f.type) ? 'image' : (isVideo ? 'video' : (/pdf/i.test(f.type)||/\.pdf$/i.test(f.name) ? 'pdf' : 'other'));
        const item = { name:f.name, size:f.size, type:f.type, kind, at:Date.now() };
        if(kind==='image' || kind==='video'){ item.preview = URL.createObjectURL(f); }
        b.adjuntos.push(item);
      }
      renderThumbs(); persistPros(); e.target.value=''; toast('Adjuntos a√±adidos','ok');
    });

    document.getElementById('b_merge').addEventListener('click', ()=>{
      const stack = document.getElementById('b_stack');
      const pdfs = (b.adjuntos||[]).filter(x=>x.kind==='pdf');
      if(!pdfs.length){ toast('No hay PDFs para previsualizar.','warn'); stack.style.display='none'; stack.innerHTML=''; return; }
      stack.innerHTML='';
      for(const ppdf of pdfs){
        const box = document.createElement('div');
        box.innerHTML = `<div class="small muted">${escapeHtml(ppdf.name)} (${bytes(ppdf.size)})</div>`;
        const obj = document.createElement('object'); obj.type='application/pdf'; obj.data='';
        box.appendChild(obj); stack.appendChild(box);
      }
      stack.style.display='flex'; toast('Vista apilada generada (BETA)','ok');
    });

    document.getElementById('b_save').addEventListener('click', ()=>{
      p.busqueda = b; persistPros(); toast('B√∫squeda guardada','ok');
    });

    document.getElementById('b_q').addEventListener('input', renderList);
  }

  function renderCompraventa(p){
    const c = p.compraventa || (p.compraventa={financiacion:0,notaria:''});
    drBody.innerHTML = `
      <div class="frow">
        <div><label>Financiaci√≥n (d√≠as 0‚Äì90)</label><input type="number" min="0" max="90" id="cv_fin" value="${Number(c.financiacion)||0}" /></div>
        <div><label>Notar√≠a (fecha)</label><input type="date" id="cv_not" value="${c.notaria||''}" /></div>
      </div>
      <button class="primary" id="cv_save">Guardar</button>
      <button class="accent" id="cv_done">Finalizar notar√≠a</button>
    `;
    document.getElementById('cv_save').addEventListener('click', ()=>{
      c.financiacion = clamp(parseInt(document.getElementById('cv_fin').value||'0',10),0,90);
      c.notaria = document.getElementById('cv_not').value||'';
      p.compraventa = c; persistPros(); toast('Compraventa guardada','ok');
    });
    document.getElementById('cv_done').addEventListener('click', ()=>{
      const date = document.getElementById('cv_not').value;
      if(!date){ toast('Pon la fecha de notar√≠a antes de finalizar.','warn'); return; }
      p.compraventa = c; p.success = true;
      p.history = p.history||{}; p.history['COMPRAVENTA']='OK';
      p.phase = 'COMPRAVENTA';
      persistPros(); renderAll(); toast('¬°√âxito registrado!','ok'); closeDrawer();
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{ renderAll(); });
  </script>
</body>
</html>
