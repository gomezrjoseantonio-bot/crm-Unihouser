<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unihouser ‚Äî Dashboard CRM</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928; --line:#E7E1DE;
  --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63; --shadow:0 4px 22px rgba(0,0,0,.06);
  --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
/* Topbar */
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}
/* Layout */
.container{max-width:1200px;margin:12px auto;padding:0 14px}
/* KPI strip */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:8px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow)}
.kpi .lab{font-size:11px;color:#667085}.kpi .val{font-weight:800;font-size:16px}
/* Board */
.board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;min-height:520px;box-shadow:var(--shadow)}
.col h3{margin:0 0 6px;color:var(--ink2);display:flex;align-items:center;justify-content:space-between;font-size:13px}
.count{font-weight:700;color:#666}
/* Crear contacto (m√≠nimo) */
.create{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.create input{border:1px solid var(--line);border-radius:10px;padding:7px 9px;min-height:30px}
.create .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 10px;font-weight:800;cursor:pointer}
/* Tarjeta */
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);display:grid;gap:6px;cursor:grab}
.card header{display:flex;align-items:center;justify-content:space-between}
.name{font-weight:800;font-size:13px}
.meta{font-size:11px;color:#737a81}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:2px 7px;display:inline-flex;align-items:center;gap:6px;font-size:10.5px}
.actions{display:flex;gap:6px;align-items:center}
.btn-icon{width:26px;height:26px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.btn-icon svg{width:15px;height:15px;stroke-width:2;fill:none;stroke:#555}
.btn-icon.view{border-color:var(--brand)} .btn-icon.view svg{stroke:var(--brand)}
.btn-icon.assign{border-color:var(--brand)}
.btn-icon.del{border-color:#999} .btn-icon.del svg{stroke:#999}
.btn-icon.mail svg{stroke:#58736F}.btn-icon.wa svg{stroke:#25D366}
.squares{display:flex;gap:4px;margin-left:auto}
.square{width:8px;height:8px;border-radius:2px;background:#e5e7eb;border:1px solid var(--line)}
.square.on{background:var(--brand);border-color:var(--brand)}
.card.dragging{opacity:.5} .col.drop{outline:2px dashed var(--brand);outline-offset:-6px}
/* Toast */
.toast{position:fixed;top:12px;right:12px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);padding:8px 10px;border-radius:12px;display:none;z-index:100}
.toast.ok{border-color:var(--ok)} .toast.bad{border-color:var(--bad)} .toast.warn{border-color:var(--accent)}
.toast.show{display:block}
/* Modal gen√©rico */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:980px;max-width:95vw;max-height:88vh;background:#fff;border:2px solid #fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.22);display:flex;flex-direction:column;overflow:hidden}
.modal header{padding:8px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:#fff}
.modal h4{margin:0;font-size:14px}
.modal .close{width:28px;height:28px;border-radius:999px;border:2px solid var(--brand);background:#fff;color:var(--brand);display:grid;place-items:center;font-weight:800;cursor:pointer}
.modal .body{padding:8px 10px;display:grid;gap:8px;flex:1 1 auto;overflow:auto;background:#fff}
.block{border:1px dashed var(--line);border-radius:12px;padding:6px;background:#fff}
.block h5{margin:0 0 4px;color:#666;font-weight:700;font-size:11px;letter-spacing:.2px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.field{display:flex;flex-direction:column;gap:2px}
.field label{color:#555;font-size:11px}
.field input,.field select,.field textarea{border:1px solid var(--line);border-radius:10px;padding:6px 8px;min-height:26px;font-size:12px;background:#fff;color:#000}
.modal footer{padding:8px 10px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;background:#fff}
.save{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:7px 11px;font-weight:800;cursor:pointer;font-size:12px}
/* Modal asignaci√≥n */
.modal.small{width:800px}
.eval-list{border:1px solid var(--line);border-radius:10px;max-height:46vh;overflow:auto;padding:6px;background:#fff}
.eval-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border-bottom:1px dashed var(--line);padding:6px 2px;font-size:12px}
.eval-title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.dot{width:9px;height:9px;border-radius:50%;display:inline-block}
.dot.green{background:#16a34a}.dot.amber{background:#f59e0b}.dot.red{background:#ef4444}
.iconline{display:flex;gap:6px;align-items:center}
.warns{display:flex;gap:6px;flex-wrap:wrap;margin-top:3px}
.tag{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:1px 6px;font-size:10.5px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo">U</div><div class="title">Unihouser ‚Äî Dashboard</div></div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="configuracion.html">Configuraci√≥n</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <!-- Crear contacto m√≠nimo -->
    <div class="create">
      <input id="c_nombre" placeholder="Nombre y apellidos">
      <input id="c_email" placeholder="Email">
      <button class="btn" id="btnCrear">Crear contacto</button>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="lab">Prospects</div><div class="val" id="k_total">0</div></div>
      <div class="kpi"><div class="lab">En b√∫squeda</div><div class="val" id="k_busq">0</div></div>
      <div class="kpi"><div class="lab">Con coincidencias</div><div class="val" id="k_match">0</div></div>
      <div class="kpi"><div class="lab">√âxitos</div><div class="val" id="k_exito">0</div></div>
      <div class="kpi"><div class="lab">Tradicional</div><div class="val" id="k_trad">0</div></div>
      <div class="kpi"><div class="lab">Habitaciones</div><div class="val" id="k_hab">0</div></div>
    </div>

    <!-- Board -->
    <div class="board">
      <div class="col" data-fase="CONTACTO"><h3>CONTACTO <span class="count" id="cnt_CONTACTO">0</span></h3><div class="pile" id="col_CONTACTO"></div></div>
      <div class="col" data-fase="REUNION"><h3>REUNION <span class="count" id="cnt_REUNION">0</span></h3><div class="pile" id="col_REUNION"></div></div>
      <div class="col" data-fase="BUSQUEDA"><h3>BUSQUEDA <span class="count" id="cnt_BUSQUEDA">0</span></h3><div class="pile" id="col_BUSQUEDA"></div></div>
      <div class="col" data-fase="COMPRAVENTA"><h3>COMPRAVENTA <span class="count" id="cnt_COMPRAVENTA">0</span></h3><div class="pile" id="col_COMPRAVENTA"></div></div>
      <div class="col" data-fase="EXITO"><h3>EXITO <span class="count" id="cnt_EXITO">0</span></h3><div class="pile" id="col_EXITO"></div></div>
    </div>
  </div>

  <!-- Modal ficha cliente -->
  <div class="modal-back" id="mbFicha">
    <div class="modal" role="dialog" aria-label="Ficha cliente">
      <header><h4 id="f_ttl">Ficha</h4><button class="close" id="f_close">√ó</button></header>
      <div class="body">
        <div class="block">
          <h5>Datos personales</h5>
          <div class="grid">
            <div class="field"><label>Nombre y apellidos</label><input id="f_nombre"></div>
            <div class="field"><label>Email</label><input id="f_email"></div>
            <div class="field"><label>M√≥vil (+34‚Ä¶)</label><input id="f_phone"></div>
            <div class="field"><label>Direcci√≥n</label><input id="f_addr"></div>
            <div class="field"><label>CP</label><input id="f_cp"></div>
            <div class="field"><label>Localidad</label><input id="f_city"></div>
            <div class="field row3"><label>Notas</label><textarea id="f_notas" rows="2"></textarea></div>
          </div>
        </div>

        <div class="block">
          <h5>Preferencias del activo</h5>
          <div class="grid">
            <div class="field"><label>Localidades (coma)</label><input id="f_locs" placeholder="Oviedo, Gij√≥n"></div>
            <div class="field"><label>Tipo</label>
              <select id="f_tipo"><option>Tradicional</option><option>Habitaciones</option></select>
            </div>
            <div class="field"><label>Altura (1-9)</label><input id="f_alt" type="number" min="1" max="9"></div>
            <div class="field"><label>¬øBajo?</label><select id="f_bajo"><option>No</option><option>S√≠</option></select></div>
            <div class="field"><label>Ascensor</label><select id="f_asc"><option>S√≠</option><option>No</option></select></div>
            <div class="field"><label>Acepta reforma</label><select id="f_ref"><option value="no">No</option><option value="lavado">Lavado</option><option value="integral">Integral</option></select></div>
          </div>
        </div>

        <div class="block">
          <h5>Objetivos</h5>
          <div class="grid">
            <div class="field"><label>Objetivo principal</label>
              <select id="f_obj_main"><option value="bruta">Bruta</option><option value="neta">Neta</option><option value="flujo">Flujo</option></select>
            </div>
            <div class="field"><label>Bruta (%)</label><input id="f_obj_b" type="number" step="0.1"></div>
            <div class="field"><label>Neta (%)</label><input id="f_obj_n" type="number" step="0.1"></div>
            <div class="field"><label>Flujo (‚Ç¨/mes)</label><input id="f_obj_f" type="number" step="10"></div>
            <div class="field"><label>Incluir PSI en rentabilidad</label><select id="f_rent_psi"><option value="no">No</option><option value="si">S√≠</option></select></div>
          </div>
        </div>

        <div class="block">
          <h5>Presupuesto & financiaci√≥n</h5>
          <div class="grid">
            <div class="field"><label>P. m√°x inversi√≥n (‚Ç¨)</label><input id="f_pmax" inputmode="numeric"></div>
            <div class="field"><label>Incluir PSI en presupuesto</label><select id="f_presu_psi"><option value="no">No</option><option value="si">S√≠</option></select></div>
            <div class="field"><label>LTV (%)</label><input id="f_ltv" type="number" min="0" max="100" value="80"></div>
            <div class="field"><label>Coste total operaci√≥n (‚Ç¨)</label><input id="f_cto" disabled></div>
            <div class="field"><label>Valor m√°x. compra (‚Ç¨)</label><input id="f_pcompra" disabled></div>
            <div class="field"><label>Fondos propios (‚Ç¨)</label><input id="f_fp" disabled></div>
          </div>
          <div class="grid">
            <div class="field row3"><label>Alquiler objetivo (‚Ç¨/mes)</label><input id="f_alq_obj" disabled></div>
          </div>
          <small class="meta">Alquiler objetivo = %Bruta * (Coste total operaci√≥n) / 12. Si PSI en rentabilidad = ‚Äús√≠‚Äù, el coste incluye PSI.</small>
        </div>
      </div>
      <footer>
        <button class="save" id="f_save">Guardar</button>
      </footer>
    </div>
  </div>

  <!-- Modal asignar activos -->
  <div class="modal-back" id="mbAssign">
    <div class="modal small" role="dialog" aria-label="Asignar activos">
      <header><h4 id="a_ttl">Asignar activos</h4><button class="close" id="a_close">√ó</button></header>
      <div class="body">
        <div class="eval-list" id="a_list">‚Äî</div>
      </div>
      <footer>
        <button class="save" id="a_save">Guardar asignaci√≥n</button>
      </footer>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
"use strict";
/* ===== Store helpers ===== */
const Store={
  get pros(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return[]}},
  set pros(v){localStorage.setItem('pros',JSON.stringify(v))},
  get evals(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return[]}},
  set evals(v){localStorage.setItem('evals',JSON.stringify(v))},
  get cfg(){try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}}}
};
const id=x=>document.getElementById(x);
function toast(msg,kind){const t=id('toast'); t.textContent=msg; t.className='toast show '+(kind||''); setTimeout(()=>t.classList.remove('show'),1300);}

/* ===== Brand color from cfg ===== */
try{const c=Store.cfg; const col=c.brand_color||c.brand||'#c7530c'; document.documentElement.style.setProperty('--brand', col);}catch(_){}

/* ===== Number/format utils ===== */
const fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
const fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
const e0=v=>fmtE0.format(Number(v||0));
const n0=v=>fmtN0.format(Number(v||0));
const parseNum=v=>Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
function toPct(raw){ let v=Number(raw||0); if(v>0&&v<=1)v*=100; return v; }

/* ===== KPI calc from cfg (itp/notaria/psi) ===== */
function cfgMoney(){
  const c=Store.cfg||{};
  const itp_raw=Number(c.itp_pct??c.itp??8); const itp_pct= itp_raw<1? itp_raw*100: itp_raw;
  const notaria=Number(c.notaria_eur??c.notaria??1500);
  const psi=Number(c.psi_fee_eur??c.honorarios??4235);
  const match=c.match||{thresholds:{green:1,amber:.95},warnings_only_when_green:true};
  return {itp_pct, notaria, psi, match};
}

/* ===== Board render ===== */
const COLS=["CONTACTO","REUNION","BUSQUEDA","COMPRAVENTA","EXITO"];
function render(){
  const pros=Store.pros||[];
  COLS.forEach(f=>{
    const pile=id('col_'+f); pile.innerHTML=''; const list=pros.filter(p=> (p.arch||false)? f==='EXITO'&&false : (p.fase||'CONTACTO')===f);
    id('cnt_'+f).textContent=list.length;
    list.forEach(p=> pile.appendChild(card(p)));
  });
  kpis();
  enableDnD();
}
function kpis(){
  const pros=Store.pros||[];
  id('k_total').textContent = pros.length;
  id('k_busq').textContent  = pros.filter(p=>p.fase==='BUSQUEDA').length;
  id('k_exito').textContent = pros.filter(p=>p.fase==='EXITO').length;
  id('k_trad').textContent  = pros.filter(p=>String(p.pref_tipo||'Tradicional').toLowerCase()==='tradicional').length;
  id('k_hab').textContent   = pros.filter(p=>String(p.pref_tipo||'Tradicional').toLowerCase()==='habitaciones').length;
  // ‚ÄúCon coincidencias‚Äù se calcula mirando si tiene assigned_eval_ids no vac√≠os
  id('k_match').textContent = pros.filter(p=> (p.assigned||[]).length>0).length;
}

/* ===== Card ===== */
function card(p){
  const el=document.createElement('div'); el.className='card'; el.draggable=true; el.dataset.id=p.id;
  const squares=document.createElement('div'); squares.className='squares';
  const n=(p.assigned||[]).length; for(let i=0;i<5;i++){const s=document.createElement('div'); s.className='square'+(i<n?' on':''); squares.appendChild(s);}
  const header=document.createElement('header');
  const L=document.createElement('div'); L.innerHTML='<div class="name">'+escapeHtml(p.nombre||'‚Äî')+'</div>'+
    '<div class="meta">'+escapeHtml(p.email||'')+' ¬∑ '+escapeHtml(p.phone||'')+'</div>';
  const R=document.createElement('div'); R.className='actions';
  R.appendChild(iconBtn('view','Ver',()=>openFicha(p.id)));
  // Asignar solo en B√öSQUEDA
  const canAssign = (p.fase==='BUSQUEDA');
  R.appendChild(iconBtn('assign','Asignar',()=>{ if(!canAssign){toast('Solo en B√öSQUEDA', 'warn'); return;} openAssign(p.id);} ));
  R.appendChild(iconBtn('mail','Email',()=>quickMail(p)));
  R.appendChild(iconBtn('wa','WhatsApp',()=>quickWA(p)));
  R.appendChild(iconBtn('del','Borrar',()=>delProspect(p.id)));
  header.appendChild(L); header.appendChild(R);
  const body=document.createElement('div');
  const locs=(p.locs_text||'').trim(); const tipo=p.pref_tipo||'Tradicional';
  const badges=document.createElement('div'); badges.className='badges';
  if(locs) badges.appendChild(pill('Loc: '+locs));
  badges.appendChild(pill('Tipo: '+tipo));
  body.appendChild(badges);
  el.appendChild(header);
  el.appendChild(body);
  el.appendChild(squares);
  return el;
}
function pill(t){const s=document.createElement('span'); s.className='badge'; s.textContent=t; return s;}
function iconBtn(kind,title,fn){
  const b=document.createElement('button'); b.className='btn-icon '+kind; b.title=title; b.setAttribute('aria-label',title);
  b.innerHTML = svgIcon(kind); b.onclick=fn; return b;
}
function svgIcon(k){
  if(k==='view') return '<svg viewBox="0 0 24 24"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z"/><circle cx="12" cy="12" r="3.2"/></svg>';
  if(k==='assign') return '<svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>';
  if(k==='mail') return '<svg viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/><path d="m4 7 8 6 8-6"/></svg>';
  if(k==='wa') return '<svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 0-7.5 14l-1.5 4 4-1.5A9 9 0 1 0 12 3Z"/></svg>';
  if(k==='del') return '<svg viewBox="0 0 24 24"><path d="M4 7h16M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 7l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12"/><path d="M10 10v7M14 10v7"/></svg>';
  if(k==='open') return '<svg viewBox="0 0 24 24"><path d="M14 3h7v7M21 3 10 14"/><path d="M5 12v7h7"/></svg>';
  if(k==='ok') return '<svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>';
  if(k==='send') return '<svg viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4 20-7Z"/></svg>';
  return '';
}
function escapeHtml(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* ===== Crear contacto ===== */
id('btnCrear').onclick=function(){
  const nombre=(id('c_nombre').value||'').trim(); const email=(id('c_email').value||'').trim();
  if(!nombre){toast('A√±ade un nombre','warn');return;}
  const p={
    id:'p_'+Date.now(), nombre, email, phone:'', fase:'CONTACTO',
    pref_tipo:'Tradicional', locs_text:'', alt:'', bajo:'No', asc:'S√≠', acepta_reforma:'no',
    obj_main:'bruta', obj_bruta:10, obj_neta:6, obj_flujo:0, rentab_include_psi:false, presu_include_psi:false,
    pmax_inversion:0, ltv:80, assigned:[]
  };
  const pros=Store.pros||[]; pros.push(p); Store.pros=pros; id('c_nombre').value=''; id('c_email').value='';
  render();
};

/* ===== Borrar ===== */
function delProspect(idp){
  if(!confirm('¬øBorrar este contacto?')) return;
  Store.pros=(Store.pros||[]).filter(x=>x.id!==idp); render();
}

/* ===== DnD ===== */
function enableDnD(){
  document.querySelectorAll('.card').forEach(c=>{
    c.addEventListener('dragstart',ev=>{ c.classList.add('dragging'); ev.dataTransfer.setData('text/plain', c.dataset.id); });
    c.addEventListener('dragend',()=>c.classList.remove('dragging'));
  });
  document.querySelectorAll('.col').forEach(col=>{
    col.addEventListener('dragover',ev=>{ev.preventDefault(); col.classList.add('drop');});
    col.addEventListener('dragleave',()=>col.classList.remove('drop'));
    col.addEventListener('drop',ev=>{
      ev.preventDefault(); col.classList.remove('drop');
      const idp=ev.dataTransfer.getData('text/plain'); const fase=col.dataset.fase;
      const pros=Store.pros||[]; const idx=pros.findIndex(x=>x.id===idp); if(idx<0)return;
      pros[idx].fase=fase; Store.pros=pros; render();
    });
  });
}

/* ===== Ficha cliente (editar) ===== */
let OPEN_ID=null;
function openFicha(idp){
  OPEN_ID=idp; const p=(Store.pros||[]).find(x=>x.id===idp); if(!p) return;
  id('mbFicha').style.display='flex'; id('f_ttl').textContent=p.nombre||'Ficha';
  id('f_nombre').value=p.nombre||''; id('f_email').value=p.email||''; id('f_phone').value=p.phone||'';
  id('f_addr').value=p.addr||''; id('f_cp').value=p.cp||''; id('f_city').value=p.city||'';
  id('f_notas').value=p.notas||'';
  id('f_locs').value=p.locs_text||''; id('f_tipo').value=p.pref_tipo||'Tradicional';
  id('f_alt').value=p.alt||''; id('f_bajo').value=p.bajo||'No'; id('f_asc').value=p.asc||'S√≠'; id('f_ref').value=p.acepta_reforma||'no';
  id('f_obj_main').value=p.obj_main||'bruta'; id('f_obj_b').value=p.obj_bruta||0; id('f_obj_n').value=p.obj_neta||0; id('f_obj_f').value=p.obj_flujo||0;
  id('f_rent_psi').value=p.rentab_include_psi?'si':'no'; id('f_presu_psi').value=p.presu_include_psi?'si':'no';
  id('f_pmax').value=p.pmax_inversion? n0(p.pmax_inversion):''; id('f_ltv').value=p.ltv||80;
  recalcFin();
}
id('f_close').onclick=()=>id('mbFicha').style.display='none';
id('f_pmax').addEventListener('input',recalcFin);
id('f_presu_psi').addEventListener('change',recalcFin);
id('f_rent_psi').addEventListener('change',recalcFin);
id('f_ltv').addEventListener('input',recalcFin);
function recalcFin(){
  const {itp_pct,notaria,psi}=cfgMoney();
  const pmax=parseNum(id('f_pmax').value);
  const incPsiPres=id('f_presu_psi').value==='si';
  const incPsiRent=id('f_rent_psi').value==='si';
  // Coste total de operaci√≥n
  const cto = pmax + (incPsiPres?0:psi); // si PSI va aparte, el coste ‚Äútotal‚Äù = Pmax + PSI (visualizamos ambos)
  const ctoVisual = incPsiPres ? pmax : (pmax + psi);
  id('f_cto').value = n0(ctoVisual);
  // Valor m√°ximo de compra (quitando ITP, Notar√≠a y PSI si no va dentro de pmax)
  // pmax = Compra + ITP + Notar√≠a + (incPsiPres? PSI:0)
  // ITP = itp% * Compra
  // => Compra = (pmax - Notar√≠a - (incPsiPres?PSI:0)) / (1 + itp%)
  const compra = Math.max(0, Math.floor((pmax - notaria - (incPsiPres?psi:0)) / (1 + itp_pct/100)));
  id('f_pcompra').value = n0(compra);
  // Fondos propios = ITP(compra) + Notar√≠a + PSI + (1-LTV)*compra
  const ltv = Math.min(100, Math.max(0, Number(id('f_ltv').value||80)));
  const itpEur = Math.round(compra * (itp_pct/100));
  const propios = itpEur + notaria + psi + Math.round(compra*(1 - ltv/100));
  id('f_fp').value = n0(propios);
  // Alquiler objetivo mensual (desde Bruta % y coste de operaci√≥n relevante)
  const br = Number(id('f_obj_b').value||0);
  const baseRent = (incPsiRent ? (compra+itpEur+notaria+psi) : (compra+itpEur+notaria)); // coste para rentabilidad
  const alqObj = Math.round((br/100) * baseRent / 12);
  id('f_alq_obj').value = n0(alqObj);
}
id('f_save').onclick=function(){
  if(!OPEN_ID) return;
  const pros=Store.pros||[]; const i=pros.findIndex(x=>x.id===OPEN_ID); if(i<0) return;
  const p=pros[i];
  p.nombre=id('f_nombre').value.trim(); p.email=id('f_email').value.trim(); p.phone=id('f_phone').value.trim();
  p.addr=id('f_addr').value.trim(); p.cp=id('f_cp').value.trim(); p.city=id('f_city').value.trim();
  p.notas=id('f_notas').value.trim();
  p.locs_text=id('f_locs').value.trim(); p.pref_tipo=id('f_tipo').value; p.alt=id('f_alt').value; p.bajo=id('f_bajo').value; p.asc=id('f_asc').value;
  p.acepta_reforma=id('f_ref').value;
  p.obj_main=id('f_obj_main').value; p.obj_bruta=Number(id('f_obj_b').value||0); p.obj_neta=Number(id('f_obj_n').value||0); p.obj_flujo=Number(id('f_obj_f').value||0);
  p.rentab_include_psi = (id('f_rent_psi').value==='si');
  p.presu_include_psi  = (id('f_presu_psi').value==='si');
  p.pmax_inversion = parseNum(id('f_pmax').value); p.ltv = Math.min(100, Math.max(0, Number(id('f_ltv').value||80)));
  pros[i]=p; Store.pros=pros; toast('Guardado','ok'); id('mbFicha').style.display='none'; render();
};

/* ===== Asignaci√≥n ===== */
let ASSIGN_ID=null;
function openAssign(idp){
  ASSIGN_ID=idp; const p=(Store.pros||[]).find(x=>x.id===idp); if(!p) return;
  id('mbAssign').style.display='flex';
  id('a_ttl').textContent='Asignar activos a '+(p.nombre||'');
  paintAssignList(p);
}
id('a_close').onclick=()=>id('mbAssign').style.display='none';
id('a_save').onclick=function(){
  if(!ASSIGN_ID) return;
  const pros=Store.pros||[]; const idx=pros.findIndex(x=>x.id===ASSIGN_ID); if(idx<0) return;
  const checks=[...document.querySelectorAll('#a_list input[data-evid]')];
  pros[idx].assigned = checks.filter(c=>c.checked).map(c=>c.dataset.evid);
  Store.pros=pros; toast('Asignaci√≥n guardada','ok'); id('mbAssign').style.display='none'; render();
};
function paintAssignList(p){
  const wrap=id('a_list'); wrap.innerHTML='';
  const evals=Store.evals||[]; if(!evals.length){wrap.textContent='No hay evaluaciones.';return;}
  const sel=new Set(p.assigned||[]);
  const {match}=cfgMoney();
  evals.forEach(e=>{
    const row=document.createElement('div'); row.className='eval-item';
    const L=document.createElement('div'); L.className='eval-title';
    const k = kpiForClient(p,e); // {color, text, warns[]}
    const dot=document.createElement('span'); dot.className='dot '+k.color;
    const text=document.createElement('div');
    const icons=miniIcons(e);
    text.innerHTML='<strong>'+escapeHtml((e.loc||'')+' ¬∑ '+(e.calle||''))+'</strong> '+icons+' <span class="tag">'+fmtN1.format(toPct(e.kpi_bruta))+'%B / '+fmtN1.format(toPct(e.kpi_neta))+'%N / '+e0(e.kpi_flujo)+'</span>';
    L.appendChild(dot); L.appendChild(text);
    const warns=document.createElement('div'); warns.className='warns';
    if(k.showWarns) k.warns.forEach(w=>{const s=document.createElement('span'); s.className='tag'; s.textContent=w; warns.appendChild(s);});
    const R=document.createElement('div'); R.className='iconline';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.evid=e.id; cb.checked=sel.has(e.id);
    const btnOpen=iconBtn('open','Abrir evaluaci√≥n',()=>{ localStorage.setItem('load_eval', e.id); window.open('evaluaciones.html','_blank'); });
    const btnMail=iconBtn('mail','Email',()=>sendEvalEmail(p,e));
    const btnWA=iconBtn('wa','WhatsApp',()=>sendEvalWA(p,e));
    const btnOK=iconBtn('ok','Aceptar y pasar a Compraventa',()=>acceptEval(p.id,e.id));
    R.appendChild(cb); R.appendChild(btnOpen); R.appendChild(btnMail); R.appendChild(btnWA); R.appendChild(btnOK);
    row.appendChild(L); row.appendChild(R);
    wrap.appendChild(row); if(k.showWarns && k.warns.length) wrap.appendChild(warns);
  });
}
function miniIcons(e){
  const h=Number(e.habs||0), b=Number(e.banos||0), alt=String(e.alt||'');
  const ref = (e.ref_tip==='integral')?'üîß':'';
  const asc = (String(e.asc||'S√≠').toLowerCase()==='no')?'üõó√ó':'üõó';
  const bajo = (String(e.bajo||'No').toLowerCase().startsWith('s'))?'‚¨á':'';
  const alq = e0(e.alq||0);
  return <span class="tag">üè†${h} ¬∑ üõÅ${b} ¬∑ ‚¨Ü${escapeHtml(alt)} ${ref} ${asc} ${bajo} ¬∑ üí∂ ${alq}</span>;
}
/* Sem√°foro contra objetivo principal del cliente */
function kpiForClient(p,e){
  const {match}=cfgMoney();
  const th=match.thresholds||{green:1,amber:.95}; const main=(p.obj_main||'bruta');
  let ratio=0,val=0,tgt=0;
  if(main==='bruta'){ val=toPct(e.kpi_bruta); tgt=Number(p.obj_bruta||0); }
  if(main==='neta'){  val=toPct(e.kpi_neta);  tgt=Number(p.obj_neta ||0); }
  if(main==='flujo'){ val=Number(e.kpi_flujo||0); tgt=Number(p.obj_flujo||0)*12; }
  ratio = (tgt>0)? (val / tgt) : 0;
  let color='red'; if(ratio>=th.green) color='green'; else if(ratio>=th.amber) color='amber';
  // Warnings: solo cuando KPI principal est√° en verde
  const showWarns = (color==='green') && !!match.warnings_only_when_green;
  const warns=[];
  // Ejemplos: presupuesto, reforma, bajo, ascensor, localidades
  const inv=Number(e.inv_total||0); const pmax=Number(p.pmax_inversion||0);
  if(pmax>0 && inv>pmax) warns.push('Excede presupuesto');
  const necesitaRef=(e.ref_tip&&e.ref_tip!=='no'); if(necesitaRef && (p.acepta_reforma||'no')==='no') warns.push('Requiere reforma');
  const sinAsc=(String(e.asc||'S√≠').toLowerCase()==='no'); if(sinAsc && String(p.asc||'S√≠').toLowerCase()==='s√≠') warns.push('Sin ascensor');
  const esBajo=(String(e.bajo||'No').toLowerCase().startsWith('s')); if(esBajo && String(p.bajo||'No').toLowerCase().startsWith('s')) warns.push('Es bajo');
  const locs=(p.locs_text||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  if(locs.length && !locs.includes(String(e.loc||'').toLowerCase())) warns.push('Fuera de zona');
  return {color, warns, showWarns, text:val};
}

/* Aceptar activo => mover a COMPRAVENTA */
function acceptEval(pid,eid){
  const pros=Store.pros||[]; const i=pros.findIndex(x=>x.id===pid); if(i<0) return;
  pros[i].accepted_eval=eid; pros[i].fase='COMPRAVENTA';
  if(!pros[i].assigned) pros[i].assigned=[];
  if(!pros[i].assigned.includes(eid)) pros[i].assigned.push(eid);
  Store.pros=pros; toast('Aceptado. Pasado a COMPRAVENTA','ok'); render();
}

/* ===== Quick comms ===== */
function nf(){ const c=Store.cfg||{}; const brand=(c.brand_name||'Unihouser'); const n=c.notifs||{};
  const subj = (n.email_subject_tpl && String(n.email_subject_tpl).trim()) ? n.email_subject_tpl : (brand+' ¬∑ {loc} ¬∑ {calle}');
  const body = (n.email_body_tpl && String(n.email_body_tpl).trim()) ? n.email_body_tpl :
'Hola {name},\n\nTe comparto una oportunidad en {loc} ¬∑ {calle} ({tipo}).\n‚Ä¢ Precio: {precio} ¬∑ Inversi√≥n: {inv}\n‚Ä¢ Bruta: {rb}% ¬∑ Neta: {rn}% ¬∑ Flujo anual: {fl}\n‚Ä¢ P. m√°x orientativo: {pmax}\n{url}\n\nUn saludo,\n'+brand;
  const wa   = (n.wa_text_tpl && String(n.wa_text_tpl).trim()) ? n.wa_text_tpl :
'Hola {name}, te comparto oportunidad: {loc} ¬∑ {calle} ({tipo})\nPrecio {precio} | Inv {inv}\nBruta {rb}% ¬∑ Neta {rn}% ¬∑ Flujo {fl}\nPmax {pmax}\n{url}';
  return {brand, subj, body, wa};
}
function fillEvalTpl(tpl, p, e){
  const rb=(Math.round(Number(e.kpi_bruta||0)*10)/10).toFixed(1).replace('.',',');
  const rn=(Math.round(Number(e.kpi_neta ||0)*10)/10).toFixed(1).replace('.',',');
  return tpl
    .replace(/\{name\}/g, p.nombre||'')
    .replace(/\{loc\}/g, e.loc||'')
    .replace(/\{calle\}/g, e.calle||'')
    .replace(/\{tipo\}/g, e.tipo||'')
    .replace(/\{precio\}/g, e0(e.precio||0))
    .replace(/\{inv\}/g, e0(e.inv_total||0))
    .replace(/\{rb\}/g, rb)
    .replace(/\{rn\}/g, rn)
    .replace(/\{fl\}/g, e0(e.kpi_flujo||0))
    .replace(/\{pmax\}/g, e0(e.pmax||0))
    .replace(/\{url\}/g, e.url||'');
}
function sendEvalEmail(p,e){
  const n=nf(); const subject=fillEvalTpl(n.subj, p, e); const body=fillEvalTpl(n.body, p, e);
  window.open('mailto:'+encodeURIComponent(p.email||'')+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body),'_blank');
}
function sendEvalWA(p,e){
  const n=nf(); const body=fillEvalTpl(n.wa, p, e);
  const phone=(p.phone||'').replace(/[^\d]/g,'');
  window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(body),'_blank');
}
function quickMail(p){
  const n=nf(); const subj=n.subj.replace('{loc}','').replace('{calle}',''); const body='Hola '+(p.nombre||'')+'\n\n';
  window.open('mailto:'+encodeURIComponent(p.email||'')+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body),'_blank');
}
function quickWA(p){
  const n=nf(); const phone=(p.phone||'').replace(/[^\d]/g,''); const body='Hola '+(p.nombre||'');
  window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(body),'_blank');
}

/* ===== Init ===== */
render();
</script>
</body>
</html>
