<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Unihouser — Dashboard CRM</title>
<style>
  :root{
    --naranja:#c7530c;
    --granate:#B53928;
    --verde:#58736F;
    --gris:#DDD5D2;
    --card:#fff;
    --texto:#2b2b2b;
    --muted:#7a6f6b;
    --bg:#faf8f7;
    --shadow:0 10px 26px rgba(0,0,0,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--texto);
    background:linear-gradient(180deg,var(--gris) 0%, var(--bg) 24%);
  }

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
  .container{max-width:1200px;margin:0 auto;padding:10px 16px}
  .flex{display:flex;gap:12px}.between{justify-content:space-between}.center{align-items:center}
  .brand img{height:28px}.title{font-weight:700;margin-left:8px}
  .nav a{padding:8px 10px;border-radius:10px;text-decoration:none;color:#4a3f3b}
  .nav a.active{background:rgba(199,83,12,.16);color:var(--naranja)}
  .actions-top{display:flex;gap:8px;align-items:center}

  /* Controles */
  label{font-size:12px;color:#4d4542}
  input,select,textarea,button{
    font-size:12px;border:1px solid #d8cfca;border-radius:8px;padding:4px 8px;background:#fff;color:#2b2b2b;
    height:26px;line-height:1.2;outline:none
  }
  textarea{height:auto}
  small.small{font-size:11px;color:#7a6f6b}
  button{cursor:pointer;background:#fff;user-select:none}
  .primary{background:var(--naranja);color:#fff;border-color:transparent}
  .bad{background:var(--granate);color:#fff;border-color:transparent}
  .ok{background:var(--verde);color:#fff;border-color:transparent}
  .circle{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;border:1px solid #eadfd9;background:#fff}
  .circle.ok{background:rgba(88,115,111,.12);color:#2e4743;border-color:rgba(88,115,111,.25)}
  .circle.ko{background:rgba(181,57,40,.12);color:#7f2b20;border-color:rgba(181,57,40,.25)}

  /* KPIs */
  .kpis{margin:14px 16px 18px;display:grid;grid-template-columns:repeat(6,minmax(160px,1fr));gap:12px}
  .kpi{background:var(--card);border-radius:14px;padding:8px 10px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:4px}
  .kpi h3{font-size:12px;margin:0;font-weight:800;letter-spacing:.3px;text-transform:uppercase}
  .kpi .row{display:flex;justify-content:space-between;align-items:baseline}
  .kpi b{font-size:20px}
  .kpi .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#f1ece9}
  .kpi .meta{display:flex;justify-content:space-between;font-size:12px;color:#6e6763}
  .kpi.ok .pill{background:rgba(88,115,111,.12);color:var(--verde)}
  .kpi.warn .pill{background:rgba(199,83,12,.18);color:var(--naranja)}
  .kpi.bad .pill{background:rgba(181,57,40,.12);color:var(--granate)}

  /* Board */
  .board{padding:0 16px 40px;display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
  .col{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);min-height:60vh;display:flex;flex-direction:column}
  .col header{padding:10px 12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .col header h2{margin:0;font-size:14px;text-transform:uppercase;letter-spacing:.6px}
  .content{padding:10px;display:flex;flex-direction:column;gap:10px}
  .new-contact{border:1px dashed #c9beb9;border-radius:12px;padding:10px;background:#fbf9f8;display:flex;flex-direction:column;gap:8px}

  /* Card */
  .card{border:1px solid #eee3de;border-radius:14px;padding:10px;background:#fff;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:6px}
  .card .top{display:flex;justify-content:space-between;align-items:center}
  .name{font-weight:800;display:flex;align-items:center;gap:6px}
  .grip{width:16px;height:16px;border-radius:4px;background:rgba(199,83,12,.15);border:1px solid rgba(199,83,12,.35);display:inline-flex;align-items:center;justify-content:center;cursor:grab}
  .grip:before{content:'≡';font-size:12px;color:#8b3c05;line-height:1}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:12px;background:#fff4ec;border:1px solid #ffd8bf;color:#a04f26;border-radius:999px;padding:3px 8px;display:inline-flex;gap:6px;align-items:center}
  .badge.gray{background:#f3efed;border:1px solid #eadfd9;color:#544a46}
  .days{font-size:12px;color:#6f6460}
  .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .iconbtn{display:inline-flex;gap:6px;align-items:center;padding:4px 6px;border-radius:10px;border:1px solid #eadfd9;background:#fff;height:28px;user-select:none}

  .houses{display:flex;gap:4px}.house{width:12px;height:12px;border-radius:3px;background:#e8e1dc;border:1px solid #d8cfca}
  .house.on{background:var(--naranja);border-color:#a64708}
  .small{font-size:12px;color:var(--muted)}

  /* Toasts */
  .toaster{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:400}
  .toast{background:#fff;border-left:6px solid var(--verde);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);min-width:260px}
  .toast.warn{border-left-color:var(--naranja)} .toast.bad{border-left-color:var(--granate)}

  /* Modal */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.2s;z-index:250}
  #overlay.open{opacity:1;pointer-events:auto}
  #modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:300;pointer-events:none}
  #modal .sheet{width:1024px;max-width:96vw;background:#fff;border-radius:18px;box-shadow:0 30px 60px rgba(0,0,0,.2);transform:translateY(12px) scale(.98);opacity:0;transition:.22s;pointer-events:auto;display:flex;flex-direction:column;max-height:92vh}
  #modal.open .sheet{transform:none;opacity:1}
  .sheet header{padding:8px 12px;border-bottom:2px solid rgba(199,83,12,.25);display:flex;justify-content:space-between;align-items:center;background:#fff}
  .sheet h3{margin:0;font-size:15px}
  .sheet .body{padding:8px;display:flex;flex-direction:column;gap:8px;overflow:hidden}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .grid.two{grid-template-columns:repeat(2,1fr)}
  .span-2{grid-column:span 2}.span-3{grid-column:span 3}
  .tall-2 textarea{min-height:130px}
  .group{border:1px solid #ffe1ce;background:#fff7f2;border-radius:12px;padding:8px}
  .group h4{margin:0 0 4px 0;font-size:11px;text-transform:uppercase;letter-spacing:.4px;color:#a04f26}
  .sheet footer{position:sticky;bottom:0;background:#fff;border-top:2px solid rgba(199,83,12,.25);padding:8px 12px;display:flex;justify-content:flex-end;gap:8px}
  #btnCloseModal{color:var(--naranja);border-color:rgba(199,83,12,.35)}

  /* Chips */
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:#f3efed;border:1px solid #eadfd9;border-radius:999px;padding:3px 7px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
  .chip button{border:none;background:transparent;cursor:pointer}

  /* Listado evaluaciones */
  .eval-list{display:flex;flex-direction:column;gap:6px;max-height:32vh;overflow:auto;border:1px dashed #eadfd9;border-radius:10px;padding:6px}
  .eval-item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:6px;border:1px solid #f0e6e1;border-radius:10px;background:#fff}
  .eval-title{font-weight:600}

  /* Drag feedback */
  .col.drag-over{outline:2px dashed var(--naranja);outline-offset:-6px}

  @media(max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:680px){.grid{grid-template-columns:1fr}}
</style>

<script>
  function logoFallback(e){
    var svg="<svg xmlns='http://www.w3.org/2000/svg' width='120' height='28' viewBox='0 0 120 28'><rect rx='6' ry='6' width='120' height='28' fill='%23c7530c'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-size='14' fill='white'>Unihouser</text></svg>";
    e.target.onerror=null; e.target.src='data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  }
</script>
</head>

<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center">
      <img src="logo-unihouser.svg" alt="Unihouser" onerror="logoFallback(event)">
      <div class="title">Unihouser — CRM & BuyBox</div>
    </div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="dashboard.html" class="active">Dashboard</a>
      <a href="configuracion.html">Configuración</a>
    </nav>
    <div class="actions-top">
      <button class="iconbtn" id="btnExport" type="button">⬇ Exportar XLS</button>
    </div>
  </div>
</header>

<section class="kpis container" id="kpis"></section>

<main class="board" id="board">
  <section class="col" data-phase="CONTACTO">
    <header><h2>📥 Contacto</h2><span class="small" id="count-CONTACTO"></span></header>
    <div class="content" id="col-CONTACTO">
      <div class="new-contact" id="newContactBox">
        <div class="flex"><input id="nc_name" placeholder="Nombre y apellidos"></div>
        <div class="flex"><input id="nc_email" type="email" placeholder="Email"><input id="nc_phone" placeholder="Teléfono"></div>
        <button class="primary" id="btnCreate" type="button">➕ Crear contacto</button>
        <p class="small">Guarda fecha en el modal para pasar a <b>Reunión</b>. 📆</p>
      </div>
    </div>
  </section>

  <section class="col" data-phase="REUNION">
    <header><h2>📆 Reunión</h2><span class="small" id="count-REUNION"></span></header>
    <div class="content" id="col-REUNION"></div>
  </section>

  <section class="col" data-phase="CONTRATO">
    <header><h2>🖋 Contrato</h2><span class="small" id="count-CONTRATO"></span></header>
    <div class="content" id="col-CONTRATO"></div>
  </section>

  <section class="col" data-phase="BUSQUEDA">
    <header><h2>🔎 Búsqueda</h2><span class="small" id="count-BUSQUEDA"></span></header>
    <div class="content" id="col-BUSQUEDA"></div>
  </section>

  <section class="col" data-phase="COMPRAVENTA">
    <header><h2>🏁 Compraventa</h2><span class="small" id="count-COMPRAVENTA"></span></header>
    <div class="content" id="col-COMPRAVENTA"></div>
  </section>
</main>

<!-- Modal -->
<div id="overlay"></div>
<div id="modal" role="dialog" aria-modal="true" aria-label="Ficha del cliente">
  <div class="sheet">
    <header><h3 id="modalTitle">Ficha</h3><button class="iconbtn" id="btnCloseModal" type="button">× Cerrar</button></header>
    <div class="body" id="modalBody"></div>
    <footer><button class="primary" id="modalSave" type="button">💾 Guardar</button></footer>
  </div>
</div>

<div class="toaster" id="toaster" aria-live="polite" aria-atomic="true"></div>

<script>
'use strict';
/* ===== Helpers ===== */
var PHASES=['CONTACTO','REUNION','CONTRATO','BUSQUEDA','COMPRAVENTA'];
var ES='es-ES';
var fmtPct=new Intl.NumberFormat(ES,{style:'percent',minimumFractionDigits:0,maximumFractionDigits:0});
function eur(n){return new Intl.NumberFormat(ES,{style:'currency',currency:'EUR'}).format(n||0)}
function fmtInt(n){return new Intl.NumberFormat(ES,{maximumFractionDigits:0}).format(Math.round(n||0))}
function uid(p){return p+'_'+Math.random().toString(36).slice(2,8)}
function daysSince(ts){return ts?Math.max(0,Math.floor((Date.now()-ts)/86400000)):0}
function toastThrottle(){
  var t=0;
  return function(msg,type){
    var now=Date.now(); if(now-t<250) return; t=now;
    var div=document.createElement('div');
    div.className='toast'+(type==='warn'?' warn':type==='bad'?' bad':'');
    div.textContent=msg;
    document.getElementById('toaster').appendChild(div);
    setTimeout(function(){div.style.opacity='0';setTimeout(function(){div.remove();},240);},2600);
  };
}
var toast=toastThrottle();
function num(s){if(typeof s==='number')return s;var t=(s||'').toString().replace(/\./g,'').replace(',','.');var v=parseFloat(t);return isNaN(v)?0:v}
function normPct(v){if(v==null||isNaN(v))return 0;var x=Number(v);if(x>1&&x<=100)return x/100;if(x>100)return 1;if(x<0)return 0;return x}
function toLocalDT(v){var d=new Date(v);function pad(x){return String(x).padStart(2,'0')}return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes())}
function shortDateTime(v){if(!v)return'';var d=new Date(v);return d.toLocaleString(ES,{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}

/* ===== Storage ===== */
var LS={
  getCfg:function(){try{return JSON.parse(localStorage.getItem('cfg')||'null')}catch(_){return null}},
  setCfg:function(o){localStorage.setItem('cfg',JSON.stringify(o))},
  getPros:function(){try{return JSON.parse(localStorage.getItem('pros')||'[]')}catch(_){return []}},
  setPros:function(a){localStorage.setItem('pros',JSON.stringify(a))},
  getEvals:function(){try{return JSON.parse(localStorage.getItem('evals')||'[]')}catch(_){return []}},
  setEvals:function(a){localStorage.setItem('evals',JSON.stringify(a))}
};
var DEFAULT_CFG={itp_pct:0.08,notaria:1200,honorarios:3630,localidades:['Oviedo','Gijon','Aviles','Mieres','Pola de Siero','Langreo','Gozon']};
function ensureCfg(c){
  var x=(c&&typeof c==='object')?c:{};
  x.itp_pct=normPct(typeof x.itp_pct==='number'?x.itp_pct:DEFAULT_CFG.itp_pct);
  x.notaria=typeof x.notaria==='number'?x.notaria:DEFAULT_CFG.notaria;
  x.honorarios=typeof x.honorarios==='number'?x.honorarios:DEFAULT_CFG.honorarios;
  x.localidades=(Array.isArray(x.localidades)&&x.localidades.length)?x.localidades:DEFAULT_CFG.localidades;
  return x;
}

/* ===== Eval helpers ===== */
function evId(e){return e.id||e.ev_id||e.key||e.uuid||null}
function evEnsureId(e){if(!evId(e))e.id='ev_'+Math.random().toString(36).slice(2,8);return evId(e)}
function evTitle(e){return e.titulo||e.title||e.nombre||e.direccion||e.ref||('Evaluacion '+(evId(e)||''))}

/* ===== State ===== */
var CFG=ensureCfg(LS.getCfg()); LS.setCfg(CFG);
var PROS=LS.getPros();
var EVALS=LS.getEvals();(function(){var ch=false,i;for(i=0;i<EVALS.length;i++){if(!evId(EVALS[i])){evEnsureId(EVALS[i]);ch=true}}if(ch)LS.setEvals(EVALS)})();

/* ===== Icons (SVG) ===== */
function svg(str){var d=document.createElement('div');d.innerHTML=str.trim();return d.firstChild;}
function icoEye(){return svg('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6Z" stroke="#c7530c" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="3" fill="#c7530c"/></svg>')}
function icoTrash(){return svg('<svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18" stroke="#c7530c" stroke-width="2"/><path d="M8 6V4h8v2" stroke="#c7530c" stroke-width="2"/><path d="M6 6l1 14h10l1-14" stroke="#c7530c" stroke-width="2" fill="none"/></svg>')}
function icoCheck(){return svg('<svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5" stroke="#58736F" stroke-width="2" fill="none"/></svg>')}
function icoCross(){return svg('<svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="#B53928" stroke-width="2"/></svg>')}

/* ===== Render ===== */
function renderAll(){renderKPIs();renderColumns()}

/* KPIs */
function renderKPIs(){
  var wrap=document.getElementById('kpis');wrap.innerHTML='';
  var counts={},i;for(i=0;i<PHASES.length;i++)counts[PHASES[i]]=0;
  for(i=0;i<PROS.length;i++){var p=PROS[i];if(!p.archived&&PHASES.indexOf(p.phase)>=0)counts[p.phase]++}
  var hist={},exitos=0;for(i=0;i<PHASES.length;i++)hist[PHASES[i]]={ok:0,ko:0};
  for(i=0;i<PROS.length;i++){
    var q=PROS[i],h=q.history||{},k;
    if(q.success)exitos++;
    for(k in h){if(hist[k]){if(h[k]==='OK')hist[k].ok++;else if(h[k]==='KO')hist[k].ko++;}}
  }
  function per(ok,ko){var tot=ok+ko;return tot?fmtPct.format(ok/tot):fmtPct.format(0)}
  function card(tit,ph){
    var d=document.createElement('div');d.className='kpi';
    var hh=hist[ph]||{ok:0,ko:0};
    d.innerHTML='<h3>'+tit+'</h3>'+
      '<div class="row"><b>'+per(hh.ok,hh.ko)+'</b><span class="pill">'+counts[ph]+' clientes</span></div>'+
      '<div class="meta"><span>OK: '+hh.ok+'</span><span>KO: '+hh.ko+'</span></div>';
    var tot=hh.ok+hh.ko,p=tot?hh.ok/tot:0;
    if(p>=.7)d.classList.add('ok');else if(p>=.4)d.classList.add('warn');else d.classList.add('bad');
    wrap.appendChild(d);
  }
  card('Contacto','CONTACTO');card('Reunión','REUNION');card('Contrato','CONTRATO');card('Búsqueda','BUSQUEDA');card('Compraventa','COMPRAVENTA');
  var ex=document.createElement('div');ex.className='kpi ok';
  ex.innerHTML='<h3>Éxitos</h3><div class="row"><b>'+exitos+'</b><span class="pill">Total</span></div>';
  wrap.appendChild(ex);
}

/* Columnas + DnD */
function renderColumns(){
  var i,ph;
  for(i=0;i<PHASES.length;i++){
    ph=PHASES[i];
    var col=document.getElementById('col-'+ph);
    if(!col) continue;
    var keep=ph==='CONTACTO'?[document.getElementById('newContactBox')]:[];
    col.innerHTML=''; for(var j=0;j<keep.length;j++) if(keep[j]) col.appendChild(keep[j]);

    var sec=document.querySelector('section[data-phase="'+ph+'"]');
    if(!sec.getAttribute('data-bound')){
      sec.addEventListener('dragover',function(e){e.preventDefault();this.classList.add('drag-over')});
      sec.addEventListener('dragleave',function(){this.classList.remove('drag-over')});
      sec.addEventListener('drop',function(e){
        e.preventDefault();this.classList.remove('drag-over');
        var id=e.dataTransfer.getData('text/plain');var p=PROS.find(function(x){return x.id===id && !x.archived});if(!p)return;
        var from=PHASES.indexOf(p.phase),to=PHASES.indexOf(this.getAttribute('data-phase'));
        if(Math.abs(from-to)!==1){toast('Solo puedes mover ±1 fase. ⚠','warn');return}
        p.phase=this.getAttribute('data-phase');p.phase_entered_at=Date.now();LS.setPros(PROS);renderAll();toast('Movido a '+p.phase+' ➜','ok');
      });
      sec.setAttribute('data-bound','1');
    }
  }

  var now=Date.now(),by={};for(i=0;i<PHASES.length;i++)by[PHASES[i]]=[];
  for(i=0;i<PROS.length;i++){var p=PROS[i];if(!p.archived)by[p.phase||'CONTACTO'].push(p)}
  by.REUNION.sort(function(a,b){
    var ad=(a.meeting&&a.meeting.date)?Math.abs(new Date(a.meeting.date).getTime()-now):1e15;
    var bd=(b.meeting&&b.meeting.date)?Math.abs(new Date(b.meeting.date).getTime()-now):1e15;return ad-bd;
  });

  for(i=0;i<PHASES.length;i++){
    ph=PHASES[i];
    var col2=document.getElementById('col-'+ph),list=by[ph]; for(var t=0;t<list.length;t++) col2.appendChild(makeCard(list[t]));
    document.getElementById('count-'+ph).textContent=list.length+' clientes';
  }
}

function makeCard(p){
  var d=daysSince(p.phase_entered_at),pr=p.profile||{},tipo=pr.tipo||'Tradicional',objt=pr.objt?(pr.objt==='bruta'?'Rb%':pr.objt==='neta'?'Rn%':'Flujo'):'Obj';
  var el=document.createElement('div'); el.className='card';

  var top=document.createElement('div'); top.className='top';
  var nm=document.createElement('div'); nm.className='name';
  var grip=document.createElement('span'); grip.className='grip'; grip.setAttribute('data-drag',p.id); grip.setAttribute('title','Arrastrar');
  var nmt=document.createElement('span'); nmt.textContent='👤 '+(p.name||'Sin nombre');
  nm.appendChild(grip); nm.appendChild(nmt);
  var dd=document.createElement('div'); dd.className='days'; dd.textContent='⏱ '+d+' '+(d===1?'día':'días');
  top.appendChild(nm); top.appendChild(dd);

  var badges=document.createElement('div'); badges.className='badges';
  function pill(txt,gray){var s=document.createElement('span'); s.className='badge'+(gray?' gray':''); s.textContent=txt; return s;}
  badges.appendChild(pill('🏷 '+tipo,false));
  badges.appendChild(pill('🎯 '+objt,false));
  if(p.phase==='REUNION' && p.meeting && p.meeting.date){ badges.appendChild(pill('📅 '+shortDateTime(p.meeting.date),true)); }

  var actions=document.createElement('div'); actions.className='actions';
  function bIcon(cls,act,iconEl){
    var b=document.createElement('button'); b.className=cls; b.setAttribute('data-act',act); b.setAttribute('data-id',p.id); b.setAttribute('type','button'); b.appendChild(iconEl); return b;
  }
  actions.appendChild(bIcon('iconbtn','details',icoEye()));
  if(p.phase==='CONTACTO'){ actions.appendChild(bIcon('iconbtn bad','trash',icoTrash())); }
  else{
    actions.appendChild(bIcon('circle ok','ok',icoCheck()));
    actions.appendChild(bIcon('circle ko','ko',icoCross()));
  }

  if(p.phase==='BUSQUEDA'){
    var houses=document.createElement('div'); houses.className='houses';
    var sc=(p.busqueda && p.busqueda.sent_count) ? p.busqueda.sent_count : 0;
    for(var i=0;i<4;i++){var h=document.createElement('div'); h.className='house'+(i<sc?' on':''); houses.appendChild(h)}
    actions.appendChild(houses);
  }

  el.appendChild(top); el.appendChild(badges); el.appendChild(actions);

  grip.setAttribute('draggable','true');
  grip.addEventListener('dragstart',function(e){ e.dataTransfer.setData('text/plain', p.id); });
  return el;
}

/* Delegación de clicks (sin closest) */
function findActionButton(node){
  while(node && node !== document && node.nodeType===1){
    if(node.hasAttribute('data-act')) return node;
    node = node.parentNode;
  }
  return null;
}
document.getElementById('board').addEventListener('click',function(e){
  try{
    var btn=findActionButton(e.target); if(!btn) return;
    e.preventDefault(); e.stopPropagation();
    var id=btn.getAttribute('data-id'); var act=btn.getAttribute('data-act');
    var p=PROS.find(function(x){return x.id===id}); if(!p) return;
    if(act==='details') openModalFor(p);
    else if(act==='trash') discardContact(p);
    else if(act==='ok') markOK(p);
    else if(act==='ko') markKO(p);
  }catch(err){ console.error(err); toast('Ups, algo falló. Vuelve a intentar.','bad'); }
});

/* Actions */
function markOK(p){
  var i=PHASES.indexOf(p.phase);
  if(i===PHASES.length-1){
    p.history=p.history||{}; p.history[p.phase]='OK';
    p.success=true; p.archived=true; p.archived_reason='SUCCESS'; p.archived_at=new Date().toISOString();
    toast('🎉 Compraventa finalizada. ¡Éxito!','ok');
  }else{
    p.history=p.history||{}; p.history[p.phase]='OK';
    p.phase=PHASES[i+1]; p.phase_entered_at=Date.now();
    toast('Avanzado a '+p.phase+' ✅','ok');
  }
  LS.setPros(PROS); renderAll();
}
function markKO(p){
  p.history=p.history||{}; p.history[p.phase]='KO';
  p.archived=true; p.archived_reason='KO'; p.archived_at=new Date().toISOString();
  LS.setPros(PROS); renderAll(); toast('Marcado como NO interesa. Archivado.','bad');
}
function discardContact(p){
  PROS=PROS.filter(function(x){return x.id!==p.id}); LS.setPros(PROS); renderAll(); toast('Descartado en Contacto (no computa).','bad');
}

/* Modal */
var overlay=document.getElementById('overlay');
var modal=document.getElementById('modal');
var modalBody=document.getElementById('modalBody');
var modalTitle=document.getElementById('modalTitle');
document.getElementById('btnCloseModal').addEventListener('click',closeModal);
document.getElementById('modalSave').addEventListener('click',function(){ try{ saveModal(); }catch(e){ console.error(e); toast('No se pudo guardar. Revisa los campos.','bad'); }});
overlay.addEventListener('click',closeModal);
document.addEventListener('keydown',function(e){ if(e.key==='Escape' && modal.classList.contains('open')) closeModal(); });
var CURRENT=null,lastOpener=null;
function openModal(){ overlay.classList.add('open'); modal.classList.add('open'); var f=modal.querySelector('input,select,textarea,button'); if(f) f.focus(); }
function closeModal(){ overlay.classList.remove('open'); modal.classList.remove('open'); CURRENT=null; if(lastOpener && document.body.contains(lastOpener)) lastOpener.focus(); }

/* Utils DOM */
function elt(tag,attrs,children){
  var n=document.createElement(tag); attrs=attrs||{};
  for(var k in attrs){ if(k==='text'){n.textContent=attrs[k]} else n.setAttribute(k,attrs[k]); }
  if(children){
    if(children instanceof Array){ for(var i=0;i<children.length;i++){ if(children[i]) n.appendChild(children[i]); } }
    else n.appendChild(children);
  }
  return n;
}
function field(lbl,control,cls){
  var w=elt('div',cls?{class:cls}:{});
  var lab=elt('label',{text:lbl}); w.appendChild(lab); w.appendChild(control); return w;
}
function selectStr(arr,val,id){
  var s=elt('select',id?{id:id}:{});
  for(var i=0;i<arr.length;i++){
    var o=elt('option',{text:arr[i]}); if(arr[i]===val) o.setAttribute('selected',''); s.appendChild(o);
  }
  return s;
}

/* Formato dinero: focus raw / blur formateado */
function applyMoneyFormat(id){
  var el=document.getElementById(id); if(!el) return;
  function showRaw(){ el.value = el.value ? String(num(el.value)).replace('.',',') : ''; }
  function showFmt(){ if(el.value==='') return; el.value = fmtInt(num(el.value)); }
  el.addEventListener('focus',showRaw); el.addEventListener('blur',showFmt);
  showFmt();
}

/* Modal detalle */
function openModalFor(p){
  CURRENT=p; lastOpener=document.activeElement;
  modalTitle.textContent='👤 '+(p.name||'Sin nombre')+' — Detalle';
  var pr=p.profile||(p.profile={}); var m=p.meeting||(p.meeting={date:'',notas:''});
  if(typeof pr.locs==='string'){ pr.locs=pr.locs.split(',').map(function(s){return s.trim()}).filter(Boolean); }
  if(!Array.isArray(pr.locs)) pr.locs=[];
  var itp=CFG.itp_pct,not=CFG.notaria,hon=CFG.honorarios;

  modalBody.innerHTML='';

  /* Datos personales */
  var g1=elt('div',{class:'group'},[
    elt('h4',{text:'Datos personales'}),
    elt('div',{class:'grid'},[
      field('Nombre', elt('input',{id:'f_name',value:p.name||''})),
      field('Teléfono', elt('input',{id:'f_tel',value:p.phone||''})),
      field('Email', elt('input',{id:'f_email',value:p.email||''})),
      field('DNI', elt('input',{id:'f_dni',value:pr.dni||''})),
      field('Dirección', elt('input',{id:'f_dir',value:pr.dir||'',placeholder:'C/ … nº …'}),'span-2'),
      field('Localidad (residencia)', elt('input',{id:'f_locres',value:pr.loc_res||''}))
    ])
  ]);

  /* Inversión */
  var chips=elt('div',{class:'chips',id:'loc_chips'});
  var locInput=elt('input',{id:'loc_input',placeholder:'Añadir localidad y Enter',list:'loc_list'});
  var dat=elt('datalist',{id:'loc_list'}); for(var j=0;j<(CFG.localidades||[]).length;j++) dat.appendChild(elt('option',{value:CFG.localidades[j]}));
  var g2=elt('div',{class:'group'},[
    elt('h4',{text:'Inversión'}),
    elt('div',{class:'grid'},[
      (function(){var w=elt('div'); w.appendChild(elt('label',{text:'Localidades (multi)'})); w.appendChild(chips); w.appendChild(locInput); w.appendChild(dat); return w;})(),
      field('Tipo de alquiler', (function(){var s=selectStr(['Tradicional','Habitaciones'], pr.tipo||'Tradicional','f_tipo'); return s;})()),
      field('Acepta reforma', (function(){var s=selectStr(['No','Lavado de cara','Integral'], pr.ref||'No','f_ref'); return s;})()),
      field('¿Ascensor?', (function(){var s=selectStr(['Sí','No'], pr.asc==='No'?'No':'Sí','f_asc'); return s;})()),
      field('Altura máx.', elt('input',{id:'f_alt',value:pr.alt||'',inputmode:'numeric'})),
      field('¿Bajos?', (function(){var s=selectStr(['No','Sí'], pr.bajos==='Sí'?'Sí':'No','f_bajos'); return s;})()),
      field('Presupuesto TOTAL (€)', elt('input',{id:'f_budget',value:pr.budget!=null?fmtInt(pr.budget):'',inputmode:'numeric'})),
      field('Precio máx. COMPRA (auto)', elt('input',{id:'f_pmax',value:pr.pmax!=null?fmtInt(pr.pmax):'',disabled:''})),
      field('ITP estimado (auto)', elt('input',{id:'f_itp',value:pr.pmax?fmtInt(pr.pmax*itp):'',disabled:''}))
    ]),
    elt('small',{text:'Notaría: '+eur(not)+' · Honorarios: '+eur(hon)+' (Config)',class:'small'})
  ]);

  /* Financiación */
  var g3=elt('div',{class:'group'},[
    elt('h4',{text:'Financiación'}),
    elt('div',{class:'grid'},[
      field('Financiación bancaria', (function(){var s=selectStr(['Sí','No'], pr.fin==='No'?'No':'Sí','f_fin'); return s;})()),
      field('% financiación', elt('input',{id:'f_pct',value:pr.pct!=null?String(pr.pct).replace('.',','):'',placeholder:'80,0'})),
      field('Hipoteca (auto)', elt('input',{id:'f_hip',value:pr.hip!=null?fmtInt(pr.hip):'',disabled:''})),
      field('Fondos propios', elt('input',{id:'f_prop',value:pr.prop!=null?fmtInt(pr.prop):'',disabled:''})),
      elt('div'),elt('div')
    ])
  ]);

  /* Objetivo */
  var sObj=elt('select',{id:'f_objt'});
  sObj.appendChild(elt('option',{text:'Rentabilidad bruta (%)',value:'bruta'}));
  sObj.appendChild(elt('option',{text:'Rentabilidad neta (%)',value:'neta'}));
  sObj.appendChild(elt('option',{text:'Flujo de caja (€/mes)',value:'flujo'}));
  sObj.value=pr.objt||'neta';
  var g4=elt('div',{class:'group'},[
    elt('h4',{text:'Objetivo'}),
    elt('div',{class:'grid'},[
      field('Objetivo principal', sObj),
      field('Valor objetivo', elt('input',{id:'f_objv',value:pr.objv!=null?String(pr.objv).replace('.',','):'',placeholder:'7,5 o 300'})),
      (function(){var w=field('Alquiler orientativo (€/mes)', elt('input',{id:'f_alq',value:pr.alq!=null?fmtInt(pr.alq):'',disabled:''})); w.id='row_alq'; return w;})()
    ]),
    elt('small',{text:'Fórmula Rb%: ((Total − Honorarios) × Rb%) / 12.',class:'small'})
  ]);

  /* Reunión / Notas — Notas 3×2 */
  var g5=elt('div',{class:'group'},[ elt('h4',{text:(p.phase==='CONTACTO'?'Reunión':'Notas')}) ]);
  if(p.phase==='CONTACTO'){
    var rowMeet=elt('div',{class:'grid'},[
      field('Fecha y hora', elt('input',{type:'datetime-local',id:'f_meet',value:m.date?toLocalDT(m.date):''})),
      elt('div'),elt('div')
    ]);
    var rowNotes=elt('div',{class:'grid'},[
      (function(){var n=field('Notas', elt('textarea',{id:'f_notas'}),'span-3 tall-2'); n.querySelector('textarea').value=m.notas||''; return n;})()
    ]);
    g5.appendChild(rowMeet); g5.appendChild(rowNotes);
  } else {
    var rowOnlyNotes=elt('div',{class:'grid'},[
      (function(){var n=field('Notas', elt('textarea',{id:'f_notas'}),'span-3 tall-2'); n.querySelector('textarea').value=m.notas||''; return n;})()
    ]);
    g5.appendChild(rowOnlyNotes);
  }

  if(p.phase==='BUSQUEDA'){
    var qId='b_q_'+p.id, chipsId='b_chips_'+p.id, listId='b_list_'+p.id, btnId='b_send_'+p.id;
    var searchRow=elt('div',{class:'grid two',style:'margin-top:6px'},[
      field('Buscar evaluaciones', elt('input',{id:qId,placeholder:'Filtrar por texto…'})),
      (function(){var box=elt('div'); box.appendChild(elt('label',{text:'Selección (máx 4)'})); box.appendChild(elt('div',{id:chipsId,class:'chips'})); return box;})()
    ]);
    var list=elt('div',{class:'eval-list',id:listId});
    var sendWrap=elt('div',{class:'flex',style:'gap:6px;margin-top:6px'},[ elt('button',{class:'iconbtn',id:btnId,type:'button',text:'📤 Enviar documentación'}) ]);
    g5.appendChild(searchRow); g5.appendChild(list); g5.appendChild(sendWrap);
  } else {
    g5.appendChild(elt('p',{class:'small',text:'La selección de activos se gestiona en Búsqueda.'}));
  }

  [g1,g2,g3,g4,g5].forEach(function(n){modalBody.appendChild(n)});

  /* chips localidades */
  function renderLocs(){
    chips.innerHTML='';
    for(var c=0;c<pr.locs.length;c++){
      var v=pr.locs[c]; var cEl=elt('span',{class:'chip'});
      cEl.appendChild(document.createTextNode(v+' '));
      var b=elt('button',{type:'button'}); b.textContent='×';
      b.addEventListener('click',function(val){ return function(){ pr.locs=pr.locs.filter(function(x){return x!==val}); renderLocs(); };}(v));
      cEl.appendChild(b); chips.appendChild(cEl);
    }
  }
  function addLoc(v){ v=(v||'').trim(); if(!v) return; if(pr.locs.indexOf(v)<0) pr.locs.push(v); locInput.value=''; renderLocs(); }
  locInput.addEventListener('keydown',function(e){ if(e.key==='Enter'||e.key===','){ e.preventDefault(); addLoc(locInput.value);} });
  locInput.addEventListener('change',function(){ addLoc(locInput.value); });
  renderLocs();

  /* derivados + formateo */
  ['f_budget','f_pct','f_fin','f_objt','f_objv'].forEach(function(id){
    var el=document.getElementById(id); if(!el) return; el.addEventListener('input',recalcDerived); el.addEventListener('change',recalcDerived);
  });
  applyMoneyFormat('f_budget');
  recalcDerived();

  if(p.phase==='BUSQUEDA') mountBusquedaInModal(p);
  openModal();
}

function recalcDerived(){
  var budget=num((document.getElementById('f_budget')||{}).value);
  var itp=CFG.itp_pct,not=CFG.notaria,hon=CFG.honorarios;
  var base=budget-(not+hon); var pmax=base>0? base/(1+itp) : 0;
  var pmaxEl=document.getElementById('f_pmax'); if(pmaxEl) pmaxEl.value=pmax?fmtInt(pmax):'';
  var itpEl=document.getElementById('f_itp');  if(itpEl)  itpEl.value=pmax?fmtInt(pmax*itp):'';
  var finEl=document.getElementById('f_fin'), pctEl=document.getElementById('f_pct');
  if(finEl&&pctEl){
    var fin=finEl.value; var pct=num(pctEl.value)/100; var hip=fin==='Sí'? pmax*pct : 0;
    var costeTotal=pmax*(1+itp)+not+hon; var prop=costeTotal-hip;
    var hipEl=document.getElementById('f_hip'); if(hipEl) hipEl.value=hip?fmtInt(hip):'';
    var propEl=document.getElementById('f_prop'); if(propEl) propEl.value=prop?fmtInt(prop):'';
  }
  var objtEl=document.getElementById('f_objt'), objvEl=document.getElementById('f_objv'), alqEl=document.getElementById('f_alq');
  if(objtEl&&objvEl&&alqEl){
    var objt=objtEl.value; document.getElementById('row_alq').style.display=(objt==='bruta'?'block':'none');
    if(objt==='bruta'){ var rb=num(objvEl.value)/100; var alq=((budget-CFG.honorarios)*rb)/12; alqEl.value=alq?fmtInt(alq):''; } else { alqEl.value=''; }
  }
}

function saveModal(){
  if(!CURRENT){closeModal();return}
  var p=CURRENT; var pr=p.profile||(p.profile={});
  p.name=(document.getElementById('f_name')||{}).value||'';
  p.phone=(document.getElementById('f_tel')||{}).value||'';
  p.email=(document.getElementById('f_email')||{}).value||'';
  pr.dni=(document.getElementById('f_dni')||{}).value||'';
  pr.dir=(document.getElementById('f_dir')||{}).value||'';
  pr.loc_res=(document.getElementById('f_locres')||{}).value||'';
  pr.tipo=(document.getElementById('f_tipo')||{}).value||'Tradicional';
  pr.ref=(document.getElementById('f_ref')||{}).value||'No';
  pr.asc=(document.getElementById('f_asc')||{}).value||'Sí';
  pr.alt=(document.getElementById('f_alt')||{}).value||'';
  pr.bajos=(document.getElementById('f_bajos')||{}).value||'No';
  pr.budget=num((document.getElementById('f_budget')||{}).value);
  pr.pmax=num((document.getElementById('f_pmax')||{}).value);
  pr.fin=(document.getElementById('f_fin')||{}).value||'Sí';
  pr.pct=num((document.getElementById('f_pct')||{}).value);
  pr.hip=num((document.getElementById('f_hip')||{}).value);
  pr.prop=num((document.getElementById('f_prop')||{}).value);
  pr.objt=(document.getElementById('f_objt')||{}).value||'neta';
  pr.objv=num((document.getElementById('f_objv')||{}).value);
  var alqEl=document.getElementById('f_alq'); pr.alq=alqEl?num(alqEl.value):0;

  var notas=(document.getElementById('f_notas')||{}).value||'';
  var dt=null; if(p.phase==='CONTACTO'){ var el=document.getElementById('f_meet'); dt=el?el.value:null }
  p.meeting={date:dt || (p.meeting?p.meeting.date:''), notas:notas};
  if(p.phase==='CONTACTO'&&dt){ p.phase='REUNION'; p.phase_entered_at=Date.now(); }

  LS.setPros(PROS); renderAll(); toast('Ficha guardada ✅','ok'); closeModal();
}

/* Búsqueda (sin MATCH) */
function mountBusquedaInModal(p){
  var q=document.getElementById('b_q_'+p.id),list=document.getElementById('b_list_'+p.id),chips=document.getElementById('b_chips_'+p.id),btnSend=document.getElementById('b_send_'+p.id);
  var b=p.busqueda||(p.busqueda={propuestas:[],sent_count:0});
  var EVS=EVALS.map(function(ev){return {_raw:ev,id:(evEnsureId(ev),evId(ev)),title:evTitle(ev)}});
  function renderChips(){
    chips.innerHTML='';
    b.propuestas.forEach(function(id){
      var e=EVS.find(function(x){return x.id===id}); var label=e?e.title:id;
      var span=elt('span',{class:'chip'}); span.appendChild(document.createTextNode(label+' '));
      var bt=elt('button',{type:'button'}); bt.textContent='×';
      bt.addEventListener('click',function(){ b.propuestas=b.propuestas.filter(function(x){return x!==id}); LS.setPros(PROS); renderChips(); renderList(); toast('Quitado','warn'); });
      span.appendChild(bt); chips.appendChild(span);
    });
  }
  function renderList(){
    list.innerHTML='';
    var txt=(q.value||'').toLowerCase();
    EVS.forEach(function(it){
      if(txt && (it.title||'').toLowerCase().indexOf(txt)===-1) return;
      var sel=b.propuestas.indexOf(it.id)>=0;
      var row=elt('div',{class:'eval-item'},[
        (function(){var l=elt('div'); l.appendChild(elt('div',{class:'eval-title',text:it.title})); return l;})(),
        (function(){var box=elt('div'); var btt=elt('button',{class:(sel?'bad':'primary'),type:'button'}); btt.textContent=(sel?'Quitar':'Añadir');
          btt.addEventListener('click',function(){ if(sel){ b.propuestas=b.propuestas.filter(function(x){return x!==it.id}); toast('Quitado','warn'); }
            else { if(b.propuestas.length>=4){ toast('Máx. 4','bad'); return } b.propuestas.push(it.id); toast('Añadido','ok'); }
            LS.setPros(PROS); renderChips(); renderList(); }); box.appendChild(btt); return box;})()
      ]);
      list.appendChild(row);
    });
  }
  if(q) q.addEventListener('input',renderList);
  btnSend.addEventListener('click',function(){
    b.sent_count=Math.min(4,b.propuestas.length);
    b.last_sent_ids=b.propuestas.slice(0,4);
    b.last_sent_at=new Date().toISOString();
    LS.setPros(PROS); renderAll(); toast('📤 Documentación registrada.','ok');
  });
  renderChips(); renderList();
}

/* Crear contacto */
document.getElementById('btnCreate').addEventListener('click',function(){
  var name=(document.getElementById('nc_name').value||'').trim();
  var email=(document.getElementById('nc_email').value||'').trim();
  var phone=(document.getElementById('nc_phone').value||'').trim();
  if(!name){toast('Pon un nombre para crear el contacto.','warn');return}
  var p={id:uid('p'),name:name,email:email,phone:phone,phase:'CONTACTO',phase_entered_at:Date.now(),history:{},meeting:{date:'',notas:''},profile:{locs:[]},busqueda:{propuestas:[],sent_count:0},compraventa:{}};
  PROS.push(p); LS.setPros(PROS); renderAll();
  document.getElementById('nc_name').value='';document.getElementById('nc_email').value='';document.getElementById('nc_phone').value='';
  toast('Contacto creado 🎉','ok');
});

/* Exportar XLS */
document.getElementById('btnExport').addEventListener('click',exportXLS);
function exportXLS(){
  var rows=[['id','nombre','fase','archivado','motivo_archivo','exito','fecha_fase','email','telefono','tipo','objetivo','objetivo_valor','reunion_fecha','localidad_residencia','localidades','propuestas_enviadas','propuestas_ids']];
  for(var i=0;i<PROS.length;i++){
    var p=PROS[i]; var pr=p.profile||{}; var locs=Array.isArray(pr.locs)?pr.locs.join(', '):'';
    rows.push([p.id,p.name||'',p.phase||'',p.archived?'sí':'no',p.archived_reason||'',p.success?'sí':'no',
      p.phase_entered_at?new Date(p.phase_entered_at).toLocaleDateString(ES):'',
      p.email||'',p.phone||'',pr.tipo||'',pr.objt||'',pr.objv||'',
      (p.meeting&&p.meeting.date)?new Date(p.meeting.date).toLocaleString(ES):'',
      pr.loc_res||'',locs,(p.busqueda&&p.busqueda.sent_count)||0,(p.busqueda&&Array.isArray(p.busqueda.last_sent_ids))?p.busqueda.last_sent_ids.join('|'):'']);
  }
  var xml=xlsFromArray(rows,'Prospectos'); download('unihouser_prospectos.xls',xml);
}
function xlsFromArray(rows,sheetName){
  var header='<?xml version="1.0"?>'+'<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Worksheet ss:Name="'+sheetName+'"><Table>';
  var body=rows.map(function(r){return '<Row>'+r.map(function(c){return '<Cell><Data ss:Type="'+(typeof c==='number'?'Number':'String')+'">'+String(c).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</Data></Cell>'}).join('')+'</Row>'}).join('');
  return header+body+'</Table></Worksheet></Workbook>';
}
function download(filename,data){
  var blob=new Blob([data],{type:'application/vnd.ms-excel'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();
  setTimeout(function(){URL.revokeObjectURL(a.href)},2000);
}

/* Init */
document.addEventListener('DOMContentLoaded',renderAll);
</script>
</body>
</html>
