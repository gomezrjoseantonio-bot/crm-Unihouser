<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Smaartflip - Gestión de Préstamos</title>
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#58736F; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06);
  --ui-font: system-ui, -apple-system, Inter, Roboto, Arial, sans-serif;
  --ui-font-size: 14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ui-font);font-size:var(--ui-font-size)}

.topbar{
  background:#fff;
  border-bottom:1px solid var(--line);
  padding:16px 0;
  position:sticky;
  top:0;
  z-index:10;
}

.topbar-content{
  max-width:1200px;
  margin:0 auto;
  padding:0 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
}

.logo{
  width:32px;
  height:32px;
  border-radius:8px;
  background:var(--brand);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:16px;
}

.brand-name{
  font-weight:800;
  font-size:18px;
  color:var(--ink);
}

.nav a{
  margin:0 16px;
  text-decoration:none;
  color:var(--ink);
  font-weight:600;
}

.nav a:hover{
  color:var(--brand);
}

.container{
  max-width:1200px;
  margin:0 auto;
  padding:20px;
}

.card{
  background:#fff;
  border-radius:16px;
  padding:24px;
  box-shadow:var(--shadow);
  margin-bottom:24px;
}

.card h2{
  margin:0 0 16px;
  font-size:20px;
  font-weight:700;
  color:var(--ink);
}

.field{
  margin-bottom:16px;
}

.field label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
  color:var(--ink);
  font-size:13px;
}

.field input, .field select{
  width:100%;
  padding:12px;
  border:1px solid var(--line);
  border-radius:8px;
  background:#fff;
  color:var(--ink);
  font-size:14px;
}

.field input:focus, .field select:focus{
  outline:none;
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(199,83,12,0.1);
}

.row{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}

@media (min-width: 768px) {
  .row.two {
    grid-template-columns:1fr 1fr;
  }
  .row.three {
    grid-template-columns:1fr 1fr 1fr;
  }
}

.btn{
  padding:12px 20px;
  background:var(--brand);
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  text-decoration:none;
  display:inline-block;
}

.btn:hover{
  background:#a0460a;
}

.btn.secondary{
  background:transparent;
  color:var(--brand);
  border:1px solid var(--brand);
}

.btn.secondary:hover{
  background:var(--brand);
  color:#fff;
}

.btn.danger{
  background:var(--bad);
}

.btn.danger:hover{
  background:#9a2828;
}

.client-list{
  display:grid;
  gap:16px;
}

.client-item{
  border:1px solid var(--line);
  border-radius:12px;
  padding:16px;
  background:#fff;
}

.client-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

.client-name{
  font-weight:700;
  font-size:16px;
  color:var(--ink);
}

.client-info{
  color:var(--ink2);
  font-size:13px;
  margin-bottom:12px;
}

.loans-section{
  border-top:1px solid var(--line);
  padding-top:12px;
  margin-top:12px;
}

.loan-item{
  border:1px solid var(--line);
  border-radius:8px;
  padding:12px;
  margin:8px 0;
  background:var(--chip);
}

.loan-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.loan-concept{
  font-weight:600;
  color:var(--ink);
}

.loan-status{
  padding:4px 8px;
  border-radius:4px;
  font-size:11px;
  font-weight:600;
}

.loan-status.activo{
  background:#d1fae5;
  color:#065f46;
}

.loan-status.pagado{
  background:#dbeafe;
  color:#1e40af;
}

.loan-status.vencido{
  background:#fee2e2;
  color:#dc2626;
}

.loan-details{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));
  gap:8px;
  font-size:12px;
  color:var(--ink2);
}

.modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.5);
  z-index:1000;
}

.modal.show{
  display:flex;
  align-items:center;
  justify-content:center;
}

.modal-content{
  background:#fff;
  border-radius:16px;
  padding:24px;
  max-width:500px;
  width:90%;
  max-height:90vh;
  overflow-y:auto;
}

.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.modal-title{
  font-size:18px;
  font-weight:700;
  color:var(--ink);
}

.close-btn{
  background:none;
  border:none;
  font-size:24px;
  cursor:pointer;
  color:var(--ink2);
}

.amortization-table{
  width:100%;
  border-collapse:collapse;
  margin-top:16px;
  font-size:12px;
}

.amortization-table th,
.amortization-table td{
  padding:8px;
  text-align:right;
  border-bottom:1px solid var(--line);
}

.amortization-table th{
  background:var(--chip);
  font-weight:600;
}

.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:var(--ok);
  color:#fff;
  padding:12px 20px;
  border-radius:8px;
  font-weight:600;
  z-index:1001;
  display:none;
}

.toast.error{
  background:var(--bad);
}

.toast.show{
  display:block;
}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-content">
    <div class="brand">
      <div class="logo">S</div>
      <div class="brand-name">Smaartflip Admin</div>
    </div>
    <nav class="nav">
      <a href="dashboard.html">Dashboard CRM</a>
      <a href="cliente-login.html">Portal Cliente</a>
    </nav>
  </div>
</div>

<div class="container">
  <div class="card">
    <h2>Gestión de Clientes y Préstamos</h2>
    <p>Administra los préstamos de tus clientes, genera cuadros de amortización y programa envíos automatizados.</p>
  </div>

  <div class="card">
    <h2>Clientes Registrados</h2>
    <div class="client-list" id="clientList">
      <div>Cargando clientes...</div>
    </div>
  </div>
</div>

<!-- Modal para agregar préstamo -->
<div class="modal" id="loanModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Nuevo Préstamo</h3>
      <button class="close-btn" onclick="closeLoanModal()">&times;</button>
    </div>
    
    <form id="loanForm">
      <input type="hidden" id="clientId" value="">
      
      <div class="field">
        <label for="loanConcept">Concepto del préstamo</label>
        <input type="text" id="loanConcept" placeholder="Ej: Préstamo personal" required>
      </div>
      
      <div class="row two">
        <div class="field">
          <label for="loanAmount">Monto (€)</label>
          <input type="number" id="loanAmount" min="1" step="0.01" placeholder="10000" required>
        </div>
        <div class="field">
          <label for="loanRate">Tasa de interés (%)</label>
          <input type="number" id="loanRate" min="0" step="0.01" placeholder="5.5" required>
        </div>
      </div>
      
      <div class="row two">
        <div class="field">
          <label for="loanTerm">Plazo (meses)</label>
          <input type="number" id="loanTerm" min="1" placeholder="24" required>
        </div>
        <div class="field">
          <label for="loanStatus">Estado</label>
          <select id="loanStatus">
            <option value="Activo">Activo</option>
            <option value="Pagado">Pagado</option>
            <option value="Vencido">Vencido</option>
          </select>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:20px;">
        <button type="submit" class="btn">Crear Préstamo</button>
        <button type="button" class="btn secondary" onclick="closeLoanModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para ver cuadro de amortización -->
<div class="modal" id="amortizationModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Cuadro de Amortización</h3>
      <button class="close-btn" onclick="closeAmortizationModal()">&times;</button>
    </div>
    
    <div id="amortizationContent">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
"use strict";

const Store = {
  get pros() {
    try {
      return JSON.parse(localStorage.getItem('pros') || '[]');
    } catch(_) {
      return [];
    }
  },
  
  set pros(value) {
    localStorage.setItem('pros', JSON.stringify(value));
  }
};

function formatNumber(num) {
  return new Intl.NumberFormat('es-ES', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  }).format(num || 0);
}

function showToast(message, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function loadClients() {
  const clients = Store.pros;
  const container = document.getElementById('clientList');
  
  if (clients.length === 0) {
    container.innerHTML = '<div>No hay clientes registrados. <a href="dashboard.html">Crear cliente en el CRM</a></div>';
    return;
  }
  
  container.innerHTML = clients.map(client => {
    const loans = client.prestamos || [];
    const activeLoans = loans.filter(l => l.estado === 'Activo');
    const totalDebt = activeLoans.reduce((sum, loan) => sum + (loan.monto || 0), 0);
    
    return `
      <div class="client-item">
        <div class="client-header">
          <div class="client-name">${client.nombre || ''} ${client.apellidos || ''}</div>
          <button class="btn" onclick="openLoanModal('${client.id}')">+ Nuevo Préstamo</button>
        </div>
        <div class="client-info">
          DNI: ${client.dni || 'N/A'} | Email: ${client.email || 'N/A'} | Móvil: ${client.movil || 'N/A'}
        </div>
        <div class="client-info">
          Préstamos activos: ${activeLoans.length} | Deuda total: €${formatNumber(totalDebt)}
        </div>
        
        ${loans.length > 0 ? `
          <div class="loans-section">
            <h4>Préstamos:</h4>
            ${loans.map(loan => `
              <div class="loan-item">
                <div class="loan-header">
                  <div class="loan-concept">${loan.concepto || 'Sin concepto'}</div>
                  <div class="loan-status ${loan.estado.toLowerCase()}">${loan.estado}</div>
                </div>
                <div class="loan-details">
                  <div>Monto: €${formatNumber(loan.monto)}</div>
                  <div>Tasa: ${loan.tasa}%</div>
                  <div>Plazo: ${loan.plazo} meses</div>
                  <div>
                    <button class="btn secondary" style="font-size:11px;padding:4px 8px;" onclick="showAmortization('${client.id}', '${loan.id}')">Ver Cuadro</button>
                    <button class="btn danger" style="font-size:11px;padding:4px 8px;" onclick="deleteLoan('${client.id}', '${loan.id}')">Eliminar</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        ` : '<div class="loans-section">No tiene préstamos registrados</div>'}
      </div>
    `;
  }).join('');
}

function openLoanModal(clientId) {
  document.getElementById('clientId').value = clientId;
  document.getElementById('loanModal').classList.add('show');
}

function closeLoanModal() {
  document.getElementById('loanModal').classList.remove('show');
  document.getElementById('loanForm').reset();
}

function generateAmortizationTable(loan) {
  const { monto, tasa, plazo } = loan;
  const tasaMensual = (tasa / 100) / 12;
  const cuota = (monto * tasaMensual * Math.pow(1 + tasaMensual, plazo)) / (Math.pow(1 + tasaMensual, plazo) - 1);
  
  const cuadro = [];
  let saldoPendiente = monto;
  
  for(let mes = 1; mes <= plazo; mes++) {
    const interes = saldoPendiente * tasaMensual;
    const capital = cuota - interes;
    saldoPendiente -= capital;
    
    cuadro.push({
      mes,
      cuota: Math.round(cuota * 100) / 100,
      capital: Math.round(capital * 100) / 100,
      interes: Math.round(interes * 100) / 100,
      saldoPendiente: Math.round(Math.max(0, saldoPendiente) * 100) / 100
    });
  }
  
  return cuadro;
}

function showAmortization(clientId, loanId) {
  const clients = Store.pros;
  const client = clients.find(c => c.id === clientId);
  if (!client) return;
  
  const loan = (client.prestamos || []).find(l => l.id === loanId);
  if (!loan) return;
  
  const cuadro = generateAmortizationTable(loan);
  
  const content = `
    <h4>${loan.concepto || 'Préstamo'}</h4>
    <p>Monto: €${formatNumber(loan.monto)} | Tasa: ${loan.tasa}% | Plazo: ${loan.plazo} meses</p>
    
    <table class="amortization-table">
      <thead>
        <tr>
          <th>Mes</th>
          <th>Cuota</th>
          <th>Capital</th>
          <th>Interés</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody>
        ${cuadro.map(row => `
          <tr>
            <td>${row.mes}</td>
            <td>€${formatNumber(row.cuota)}</td>
            <td>€${formatNumber(row.capital)}</td>
            <td>€${formatNumber(row.interes)}</td>
            <td>€${formatNumber(row.saldoPendiente)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  document.getElementById('amortizationContent').innerHTML = content;
  document.getElementById('amortizationModal').classList.add('show');
}

function closeAmortizationModal() {
  document.getElementById('amortizationModal').classList.remove('show');
}

function deleteLoan(clientId, loanId) {
  if (!confirm('¿Estás seguro de que quieres eliminar este préstamo?')) return;
  
  const clients = Store.pros;
  const clientIndex = clients.findIndex(c => c.id === clientId);
  if (clientIndex === -1) return;
  
  const loanIndex = (clients[clientIndex].prestamos || []).findIndex(l => l.id === loanId);
  if (loanIndex === -1) return;
  
  clients[clientIndex].prestamos.splice(loanIndex, 1);
  Store.pros = clients;
  
  loadClients();
  showToast('Préstamo eliminado correctamente');
}

document.getElementById('loanForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const clientId = document.getElementById('clientId').value;
  const concept = document.getElementById('loanConcept').value;
  const amount = parseFloat(document.getElementById('loanAmount').value);
  const rate = parseFloat(document.getElementById('loanRate').value);
  const term = parseInt(document.getElementById('loanTerm').value);
  const status = document.getElementById('loanStatus').value;
  
  if (!clientId || !concept || !amount || !rate || !term) {
    showToast('Por favor completa todos los campos', true);
    return;
  }
  
  const clients = Store.pros;
  const clientIndex = clients.findIndex(c => c.id === clientId);
  if (clientIndex === -1) {
    showToast('Cliente no encontrado', true);
    return;
  }
  
  if (!clients[clientIndex].prestamos) {
    clients[clientIndex].prestamos = [];
  }
  
  const newLoan = {
    id: 'loan_' + Date.now(),
    concepto: concept,
    monto: amount,
    tasa: rate,
    plazo: term,
    estado: status,
    fechaCreacion: new Date().toISOString(),
    fechaInicio: new Date().toISOString().split('T')[0]
  };
  
  clients[clientIndex].prestamos.push(newLoan);
  Store.pros = clients;
  
  closeLoanModal();
  loadClients();
  showToast('Préstamo creado correctamente');
});

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', loadClients);
</script>

</body>
</html>