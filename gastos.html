<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FinanceManager — Gestión de Gastos</title>
<link rel="stylesheet" href="css/style.css">
<style>
:root{
  --brand:#c7530c; --accent:#DB824B; --ok:#2E7D32; --bad:#B53928;
  --line:#E7E1DE; --chip:#F3EEE9; --bg:#FAF8F7; --ink:#1a1f23; --ink2:#535b63;
  --shadow:0 4px 22px rgba(0,0,0,.06); --ff:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif; --fz:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff);font-size:var(--fz)}
.topbar{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.top-inner{max-width:1200px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:8px}
.logo{width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800;font-size:12px}
.title{font-weight:700;color:var(--ink2);font-size:13px}
.nav a{color:var(--ink2);text-decoration:none;padding:5px 8px;border-radius:8px;font-size:12px}
.nav a.active{background:var(--brand);color:#fff}
.nav a:hover{background:#f3efe9}
.container{max-width:1200px;margin:12px auto;padding:0 14px}
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:var(--shadow);margin:16px 0}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:700;color:var(--ink2)}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;font-size:14px}
.btn{background:var(--brand);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:700}
.btn:hover{opacity:0.9}
.btn-secondary{background:#f0f0f0;color:var(--ink)}
.expense-item{background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.expense-amount{font-weight:700;color:var(--bad);font-size:16px}
.expense-meta{font-size:12px;color:#666}
.category-summary{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin:16px 0}
.category-card{background:#f8f9fa;border:1px solid var(--line);border-radius:8px;padding:12px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand"><div class="logo">₱</div><div class="title">FinanceManager — Gastos</div></div>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="ingresos.html">Ingresos</a>
        <a class="active" href="gastos.html">Gastos</a>
        <a href="presupuestos.html">Presupuestos</a>
        <a href="reportes.html">Reportes</a>
        <a href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <h1>Gestión de Gastos</h1>
    
    <div class="card">
      <h2>Añadir Nuevo Gasto</h2>
      <form id="expense-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label for="expense-description">Descripción</label>
            <input type="text" id="expense-description" placeholder="Ej: Supermercado, Gasolina, Restaurante" required>
          </div>
          <div class="form-group">
            <label for="expense-amount">Cantidad (€)</label>
            <input type="number" id="expense-amount" step="0.01" placeholder="0.00" required>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label for="expense-category">Categoría</label>
            <select id="expense-category" required>
              <option value="">Seleccionar categoría</option>
              <option value="alimentacion">Alimentación</option>
              <option value="transporte">Transporte</option>
              <option value="vivienda">Vivienda</option>
              <option value="salud">Salud</option>
              <option value="entretenimiento">Entretenimiento</option>
              <option value="educacion">Educación</option>
              <option value="ropa">Ropa</option>
              <option value="tecnologia">Tecnología</option>
              <option value="servicios">Servicios</option>
              <option value="otros">Otros</option>
            </select>
          </div>
          <div class="form-group">
            <label for="expense-date">Fecha</label>
            <input type="date" id="expense-date" required>
          </div>
          <div class="form-group">
            <label for="expense-payment">Método de Pago</label>
            <select id="expense-payment">
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="transferencia">Transferencia</option>
              <option value="paypal">PayPal</option>
              <option value="otros">Otros</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="expense-notes">Notas (opcional)</label>
          <textarea id="expense-notes" rows="3" placeholder="Información adicional..."></textarea>
        </div>
        <button type="submit" class="btn">Añadir Gasto</button>
      </form>
    </div>

    <div class="card">
      <h2>Resumen por Categorías (Mes Actual)</h2>
      <div id="category-summary" class="category-summary">
        <!-- Resumen de categorías se carga aquí -->
      </div>
    </div>

    <div class="card">
      <h2>Gastos Registrados</h2>
      <div style="margin-bottom: 16px;">
        <label for="filter-month">Filtrar por mes:</label>
        <select id="filter-month" style="margin-left: 8px; padding: 6px;">
          <option value="">Todos los meses</option>
        </select>
      </div>
      <div id="expense-list">
        <!-- Los gastos se cargarán aquí dinámicamente -->
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    
    const Store = {
      get transactions(){try{return JSON.parse(localStorage.getItem('transactions')||'[]')}catch(_){return[]}}, 
      set transactions(v){localStorage.setItem('transactions',JSON.stringify(v));}
    };
    
    const $ = id => document.getElementById(id);
    const esc = s => (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtE2 = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:2});
    const e2 = v => fmtE2.format(Number(v||0));
    const parseNum = v => Number(String(v??'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'))||0;
    
    function toast(msg, type='info') {
      const toast = document.createElement('div');
      toast.textContent = msg;
      toast.style.cssText = `position:fixed;top:20px;right:20px;background:${type==='ok'?'var(--ok)':'var(--bad)'};color:#fff;padding:12px 16px;border-radius:8px;z-index:1000`;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3000);
    }
    
    function getCurrentMonth() {
      const now = new Date();
      return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
    }
    
    function renderCategorySummary() {
      const currentMonth = getCurrentMonth();
      const expenses = Store.transactions.filter(t => t.type === 'gasto' && t.date.startsWith(currentMonth));
      
      const categories = {};
      expenses.forEach(expense => {
        categories[expense.category] = (categories[expense.category] || 0) + expense.amount;
      });
      
      const container = $('category-summary');
      const entries = Object.entries(categories).sort((a, b) => b[1] - a[1]);
      
      if (entries.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No hay gastos este mes</p>';
        return;
      }
      
      container.innerHTML = entries.map(([category, amount]) => `
        <div class="category-card">
          <div style="font-weight: 700; text-transform: capitalize; margin-bottom: 4px;">${esc(category)}</div>
          <div style="font-size: 18px; font-weight: 700; color: var(--bad);">${e2(amount)}</div>
        </div>
      `).join('');
    }
    
    function renderExpenses() {
      const filterMonth = $('filter-month').value;
      let expenses = Store.transactions.filter(t => t.type === 'gasto');
      
      if (filterMonth) {
        expenses = expenses.filter(t => t.date.startsWith(filterMonth));
      }
      
      const container = $('expense-list');
      
      if (expenses.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No hay gastos registrados</p>';
        return;
      }
      
      container.innerHTML = expenses
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .map(expense => `
          <div class="expense-item">
            <div>
              <div style="font-weight: 700;">${esc(expense.description)}</div>
              <div class="expense-meta">
                ${esc(expense.category)} • ${expense.date}
                ${expense.payment ? ' • ' + esc(expense.payment) : ''}
              </div>
              ${expense.notes ? `<div class="expense-meta">${esc(expense.notes)}</div>` : ''}
            </div>
            <div class="expense-amount">-${e2(expense.amount)}</div>
          </div>
        `).join('');
    }
    
    function populateMonthFilter() {
      const expenses = Store.transactions.filter(t => t.type === 'gasto');
      const months = [...new Set(expenses.map(t => t.date.substring(0, 7)))].sort().reverse();
      
      const select = $('filter-month');
      select.innerHTML = '<option value="">Todos los meses</option>' + 
        months.map(month => `<option value="${month}">${month}</option>`).join('');
    }
    
    // Set today's date as default
    $('expense-date').value = new Date().toISOString().split('T')[0];
    
    $('expense-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const expense = {
        id: Date.now(),
        description: $('expense-description').value.trim(),
        amount: parseNum($('expense-amount').value),
        category: $('expense-category').value,
        date: $('expense-date').value,
        type: 'gasto',
        payment: $('expense-payment').value,
        notes: $('expense-notes').value.trim()
      };
      
      if (!expense.description || !expense.amount || !expense.category) {
        toast('Por favor completa todos los campos requeridos', 'error');
        return;
      }
      
      const transactions = Store.transactions;
      transactions.push(expense);
      Store.transactions = transactions;
      
      // Clear form
      this.reset();
      $('expense-date').value = new Date().toISOString().split('T')[0];
      
      renderExpenses();
      renderCategorySummary();
      populateMonthFilter();
      toast('Gasto añadido correctamente', 'ok');
    });
    
    $('filter-month').addEventListener('change', renderExpenses);
    
    // Initial render
    renderExpenses();
    renderCategorySummary();
    populateMonthFilter();
    
    // Apply brand configuration
    try{
      const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
      if(cfg.brand_color) document.documentElement.style.setProperty('--brand', cfg.brand_color);
    }catch(_){}
  })();
  </script>
</body>
</html>