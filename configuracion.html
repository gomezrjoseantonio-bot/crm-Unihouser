<!DOCTYPE html>
<html lang="es" data-theme="professional">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unihouser — Configuración</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* Configuration specific styles */
.config{display:grid;grid-template-columns:220px 1fr;gap:var(--space-4);min-height:70vh}
.sidebar{background:var(--bg-elevated);border:1px solid var(--border-light);border-radius:var(--radius-xl);padding:var(--space-4);box-shadow:var(--shadow-md);height:fit-content}
.tabbtn{display:block;width:100%;padding:var(--space-3);margin-bottom:var(--space-2);background:transparent;border:1px solid var(--border-light);border-radius:var(--radius-lg);cursor:pointer;text-align:left;color:var(--text-secondary);font-weight:600;transition:all var(--transition-fast)}
.tabbtn:hover{background:var(--bg-secondary);border-color:var(--border-medium)}
.tabbtn.active{background:var(--gradient-primary);color:white;border-color:transparent;box-shadow:var(--shadow-md)}
.content{background:var(--bg-elevated);border:1px solid var(--border-light);border-radius:var(--radius-xl);padding:var(--space-6);box-shadow:var(--shadow-md)}
.panel{display:none}
.panel.active{display:block}
.block{margin-bottom:var(--space-6);padding:var(--space-5);background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-lg)}
.grid{display:grid;gap:var(--space-4);grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
.row2{grid-column:span 2}
.row3{grid-column:span 3}
.inline{display:flex;align-items:center;gap:var(--space-2)}
.chips{display:flex;flex-wrap:wrap;gap:var(--space-2);margin:var(--space-2) 0}
.chip{background:var(--bg-tertiary);border:1px solid var(--border-light);border-radius:var(--radius-full);padding:var(--space-1) var(--space-3);font-size:var(--font-size-sm);display:flex;align-items:center;gap:var(--space-2)}
.chip .remove{cursor:pointer;color:var(--text-muted);font-weight:bold}
.chip .remove:hover{color:var(--error)}
.chips-input{flex:1;min-width:150px}

/* Logo upload section */
.logo-upload-section{display:flex;gap:var(--space-4);align-items:flex-start}
.logo-preview{width:80px;height:80px;border:2px dashed var(--border-light);border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);transition:all var(--transition-base)}
.logo-preview:hover{border-color:var(--brand-primary)}
.logo-preview img{width:100%;height:100%;object-fit:cover;border-radius:var(--radius-lg)}
.logo-placeholder{color:var(--text-muted);font-size:var(--font-size-xs);text-align:center}
.logo-upload-controls{display:flex;flex-direction:column;gap:var(--space-2)}
</style>

<script>
/* Apply brand settings from configuration */
try{
  const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
  if(cfg.brand_color) document.documentElement.style.setProperty('--brand-primary', cfg.brand_color);
  if(cfg.ui_font) document.documentElement.style.setProperty('--font-family', cfg.ui_font);
  if(cfg.ui_font_size) document.documentElement.style.setProperty('--font-size-base', (''+cfg.ui_font_size).replace('px','')+'px');
  if(cfg.ui_theme) document.documentElement.setAttribute('data-theme', cfg.ui_theme);
}catch(_){}
</script>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="brand">
        <div class="logo-container" id="logoBox">
          <div class="logo-fallback">U</div>
        </div>
        <div class="title">Unihouser — Configuración</div>
      </div>
      <nav class="nav">
        <a href="evaluar.html">Evaluar</a>
        <a href="evaluaciones.html">Evaluaciones</a>
        <a href="evaluaciones.html?mode=search">Buscar Activos</a>
        <a href="dashboard.html">Dashboard</a>
        <a class="active" href="configuracion.html">Configuración</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="config animate-slide-in">
      <aside class="sidebar" id="tabs">
        <button class="tabbtn active" data-tab="general">General</button>
        <button class="tabbtn" data-tab="temas">Temas y Apariencia</button>
        <button class="tabbtn" data-tab="presu">Presupuesto</button>
        <button class="tabbtn" data-tab="matching">Matching</button>
        <button class="tabbtn" data-tab="mensajeria">Mensajería</button>
        <button class="tabbtn" data-tab="eval">Parámetros de evaluación</button>
        <button class="tabbtn" data-tab="backup">Exportar / Importar</button>
      </aside>

      <section class="content">
        <!-- GENERAL -->
        <div class="panel active" id="panel-general">
          <h3>Configuración General</h3>
          <div class="block">
            <h5>Información de la Empresa</h5>
            <div class="grid">
              <div class="field"><label>Nombre de la marca</label><input id="g_name" maxlength="40" placeholder="Unihouser"/></div>
              <div class="field"><label>Correo electrónico</label><input id="g_email" type="email" maxlength="50" placeholder="info@unihouser.es"/></div>
              <div class="field"><label>Teléfono</label><input id="g_phone" maxlength="15" placeholder="644 300 200"/></div>
            </div>
          </div>
          <div class="actions"><button class="btn primary" onclick="saveGeneral()">Guardar</button></div>
        </div>

        <!-- TEMAS Y APARIENCIA -->
        <div class="panel" id="panel-temas">
          <h3>Temas y Apariencia</h3>
          <div class="block">
            <h5>Personalización Visual</h5>
            <div class="grid">
              <div class="field">
                <label>Tema de la aplicación</label>
                <select id="g_theme" onchange="changeTheme()">
                  <option value="professional">Profesional (Mejorado)</option>
                  <option value="fintech">Fintech (Moderno & Gradientes)</option>
                  <option value="minimal">Minimalista (Limpio & Espacioso)</option>
                  <option value="dark">Oscuro</option>
                </select>
              </div>
              <div class="field"><label>Color de marca (hex)</label><input id="g_brand" maxlength="7" placeholder="#c7530c" onchange="changeBrandColor()"/></div>
            </div>
          </div>

          <div class="block">
            <h5>Logo de la Marca</h5>
            <div class="logo-upload-section">
              <div class="logo-preview" id="logoPreview">
                <div class="logo-placeholder">Sin logo</div>
              </div>
              <div class="logo-upload-controls">
                <input type="file" id="logoInput" accept="image/*" style="display:none">
                <button type="button" class="btn ghost" onclick="document.getElementById('logoInput').click()">Subir Logo</button>
                <button type="button" class="btn ghost" id="removeLogoBtn" onclick="removeLogo()" style="display:none">Eliminar</button>
                <small class="muted">Recomendado: 64x64px, formato PNG/JPG</small>
              </div>
            </div>
          </div>

          <div class="actions"><button class="btn primary" onclick="saveAppearance()">Guardar Cambios</button></div>
        </div>

        <!-- PRESUPUESTO -->
        <div class="panel" id="panel-presu">
          <h3>Presupuesto & Cálculos</h3>
          <div class="block">
            <h5>Configuración de Costos</h5>
            <div class="grid">
              <div class="field"><label>ITP (%)</label><input id="p_itp" type="number" min="0" max="21" step="0.1" placeholder="8"/></div>
              <div class="field"><label>Notaría (€)</label><input id="p_not" type="number" min="0" step="100" placeholder="1500"/></div>
              <div class="field"><label>Honorarios (€)</label><input id="p_fee" type="number" min="0" step="10" placeholder="4235"/></div>
            </div>
          </div>
          <div class="actions"><button class="btn primary" onclick="savePresupuesto()">Guardar</button></div>
        </div>

        <!-- MATCHING -->
        <div class="panel" id="panel-matching">
          <h3>Configuración de Matching</h3>
          <div class="block">
            <h5>Umbrales de Evaluación</h5>
            <div class="grid">
              <div class="field">
                <label>Umbral Verde (ratio)</label>
                <input id="m_green" type="number" min="0.1" max="2" step="0.01" placeholder="1.00"/>
                <small class="muted">Valores iguales o superiores se consideran excelentes</small>
              </div>
              <div class="field">
                <label>Umbral Ámbar (ratio)</label>
                <input id="m_amber" type="number" min="0.1" max="2" step="0.01" placeholder="0.95"/>
                <small class="muted">Valores entre ámbar y verde se consideran buenos</small>
              </div>
            </div>
          </div>
          <div class="actions"><button class="btn primary" onclick="saveMatching()">Guardar</button></div>
        </div>

        <!-- MENSAJERÍA -->
        <div class="panel" id="panel-mensajeria">
          <h3>Mensajería</h3>
          <div class="block">
            <h5>Notificaciones Globales</h5>
            <div class="grid">
              <div class="field row3"><label>Email remitente (por defecto)</label><input id="n_email_from" type="email" maxlength="60"/></div>
              <div class="field row3"><label>Asunto email — plantilla</label><input id="n_email_subj" maxlength="80" placeholder="{brand} — {name}"/></div>
              <div class="field row3"><label>Cuerpo email — plantilla</label><textarea id="n_email_body" rows="3" maxlength="500" placeholder="Hola {name}"></textarea></div>
              <div class="field row3"><label>WhatsApp — plantilla</label><textarea id="n_wa_body" rows="3" maxlength="350" placeholder="Hola {name}"></textarea></div>
            </div>
            <small class="muted">Placeholders disponibles: {brand}, {name}, {loc}, {calle}, {tipo}, {precio}, {inv}, {rb}, {rn}, {fl}, {pmax}, {url}</small>
          </div>
          <div class="actions"><button class="btn primary" onclick="saveMensajeria()">Guardar</button></div>
        </div>

        <!-- PARÁMETROS EVALUACIÓN -->
        <div class="panel" id="panel-eval">
          <h3>Parámetros de Evaluación</h3>
          <div class="block">
            <h5>Porcentajes de Gestión</h5>
            <div class="grid">
              <div class="field"><label>Seguro hogar (%)</label><input id="e_hogar" type="number" min="0" max="20" step="0.1" placeholder="2.0"/></div>
              <div class="field"><label>Impago Tradicional (%)</label><input id="e_imp_trad" type="number" min="0" max="20" step="0.1" placeholder="5.0"/></div>
              <div class="field"><label>Impago Habitaciones (%)</label><input id="e_imp_hab" type="number" min="0" max="20" step="0.1" placeholder="8.0"/></div>
              <div class="field"><label>Gestión Tradicional (%)</label><input id="e_g_trad" type="number" min="0" max="50" step="0.1" placeholder="10.0"/></div>
              <div class="field"><label>Gestión Habitaciones (%)</label><input id="e_g_hab" type="number" min="0" max="50" step="0.1" placeholder="15.0"/></div>
            </div>
          </div>
          <div class="block">
            <h5>Localidades por Defecto</h5>
            <div class="inline">
              <div class="chips" id="chips_locs"></div>
            </div>
            <div class="inline">
              <input class="chips-input" id="add_loc" maxlength="20" placeholder="Añadir localidad y Enter"/>
              <small class="muted">Máximo 12 localidades</small>
            </div>
          </div>
          <div class="actions"><button class="btn primary" onclick="saveEval()">Guardar</button></div>
        </div>

        <!-- EXPORTAR / IMPORTAR -->
        <div class="panel" id="panel-backup">
          <h3>Exportar / Importar</h3>
          <div class="block">
            <h5>Copia de Seguridad</h5>
            <p class="muted">Exporta todos los datos de la aplicación para hacer una copia de seguridad o transferir a otro dispositivo.</p>
            <div class="actions">
              <button class="btn primary" onclick="exportBackup()">Exportar Datos Completos</button>
            </div>
          </div>
          <div class="block">
            <h5>Restaurar desde Copia</h5>
            <p class="muted">Importa datos previamente exportados. <strong>Atención:</strong> Esto sobrescribirá todos los datos actuales.</p>
            <div class="field">
              <input type="file" id="importFile" accept=".json" style="margin-bottom: var(--space-3);">
              <button class="btn ghost" onclick="importBackup()">Importar Datos</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer class="foot">
    <div>© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div>
  </footer>

<script>
// Simple configuration management
let CFG = JSON.parse(localStorage.getItem('cfg') || '{}');

// Normalize config with defaults
function normalizeCfg(cfg) {
  return {
    brand_name: cfg.brand_name || 'Unihouser',
    company_email: cfg.company_email || 'info@unihouser.es',
    company_phone: cfg.company_phone || '644 300 200',
    brand_color: cfg.brand_color || '#c7530c',
    ui_theme: cfg.ui_theme || 'professional',
    ui_font: cfg.ui_font || 'Inter, system-ui, sans-serif',
    ui_font_size: cfg.ui_font_size || 16,
    brand_logo: cfg.brand_logo || null,
    itp_pct: cfg.itp_pct || 8,
    notaria_eur: cfg.notaria_eur || 1500,
    psi_fee_eur: cfg.psi_fee_eur || 4235,
    match: cfg.match || {thresholds: {green: 1, amber: 0.95}},
    ...cfg
  };
}

CFG = normalizeCfg(CFG);

// Tab switching
document.querySelectorAll('.tabbtn').forEach(btn => {
  btn.addEventListener('click', () => {
    const targetTab = btn.dataset.tab;
    
    // Update active tab button
    document.querySelectorAll('.tabbtn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Update active panel
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-' + targetTab).classList.add('active');
  });
});

// Load values
function loadValues() {
  document.getElementById('g_name').value = CFG.brand_name;
  document.getElementById('g_email').value = CFG.company_email;
  document.getElementById('g_phone').value = CFG.company_phone;
  document.getElementById('g_brand').value = CFG.brand_color;
  document.getElementById('g_theme').value = CFG.ui_theme;
  document.getElementById('p_itp').value = CFG.itp_pct;
  document.getElementById('p_not').value = CFG.notaria_eur;
  document.getElementById('p_fee').value = CFG.psi_fee_eur;
  document.getElementById('m_green').value = CFG.match.thresholds.green;
  document.getElementById('m_amber').value = CFG.match.thresholds.amber;
  
  // Load messaging values
  document.getElementById('n_email_from').value = CFG.notifs?.email_from || '';
  document.getElementById('n_email_subj').value = CFG.notifs?.email_subject_tpl || '{brand} — {name}';
  document.getElementById('n_email_body').value = CFG.notifs?.email_body_tpl || 'Hola {name}';
  document.getElementById('n_wa_body').value = CFG.notifs?.wa_text_tpl || 'Hola {name}';
  
  // Load evaluation params
  document.getElementById('e_hogar').value = CFG.eval_params?.hogar_pct || 2;
  document.getElementById('e_imp_trad').value = CFG.eval_params?.impago_trad_pct || 5;
  document.getElementById('e_imp_hab').value = CFG.eval_params?.impago_hab_pct || 8;
  document.getElementById('e_g_trad').value = CFG.eval_params?.gestion_trad_pct || 10;
  document.getElementById('e_g_hab').value = CFG.eval_params?.gestion_hab_pct || 15;
  
  // Load default locations
  loadLocations();
  
  // Load logo if exists
  if(CFG.brand_logo) {
    document.getElementById('logoPreview').innerHTML = `<img src="${CFG.brand_logo}" alt="Logo">`;
    document.getElementById('removeLogoBtn').style.display = 'inline-block';
  }
}

// Save functions
function saveGeneral() {
  CFG.brand_name = document.getElementById('g_name').value.trim() || 'Unihouser';
  CFG.company_email = document.getElementById('g_email').value.trim() || 'info@unihouser.es';
  CFG.company_phone = document.getElementById('g_phone').value.trim() || '644 300 200';
  localStorage.setItem('cfg', JSON.stringify(CFG));
  showToast('Configuración general guardada');
}

function saveAppearance() {
  CFG.brand_color = document.getElementById('g_brand').value.trim() || '#c7530c';
  CFG.ui_theme = document.getElementById('g_theme').value || 'professional';
  localStorage.setItem('cfg', JSON.stringify(CFG));
  
  // Apply changes immediately
  document.documentElement.style.setProperty('--brand-primary', CFG.brand_color);
  document.documentElement.setAttribute('data-theme', CFG.ui_theme);
  
  showToast('Tema y apariencia guardados');
}

function savePresupuesto() {
  CFG.itp_pct = parseFloat(document.getElementById('p_itp').value) || 8;
  CFG.notaria_eur = parseInt(document.getElementById('p_not').value) || 1500;
  CFG.psi_fee_eur = parseInt(document.getElementById('p_fee').value) || 4235;
  localStorage.setItem('cfg', JSON.stringify(CFG));
  showToast('Configuración de presupuesto guardada');
}

function saveMatching() {
  CFG.match.thresholds.green = parseFloat(document.getElementById('m_green').value) || 1;
  CFG.match.thresholds.amber = parseFloat(document.getElementById('m_amber').value) || 0.95;
  localStorage.setItem('cfg', JSON.stringify(CFG));
  showToast('Configuración de matching guardada');
}

function saveMensajeria() {
  CFG.notifs = CFG.notifs || {};
  CFG.notifs.email_from = document.getElementById('n_email_from').value.trim();
  CFG.notifs.email_subject_tpl = document.getElementById('n_email_subj').value.trim() || '{brand} — {name}';
  CFG.notifs.email_body_tpl = document.getElementById('n_email_body').value.trim() || 'Hola {name}';
  CFG.notifs.wa_text_tpl = document.getElementById('n_wa_body').value.trim() || 'Hola {name}';
  localStorage.setItem('cfg', JSON.stringify(CFG));
  showToast('Configuración de mensajería guardada');
}

function saveEval() {
  CFG.eval_params = CFG.eval_params || {};
  CFG.eval_params.hogar_pct = parseFloat(document.getElementById('e_hogar').value) || 2;
  CFG.eval_params.impago_trad_pct = parseFloat(document.getElementById('e_imp_trad').value) || 5;
  CFG.eval_params.impago_hab_pct = parseFloat(document.getElementById('e_imp_hab').value) || 8;
  CFG.eval_params.gestion_trad_pct = parseFloat(document.getElementById('e_g_trad').value) || 10;
  CFG.eval_params.gestion_hab_pct = parseFloat(document.getElementById('e_g_hab').value) || 15;
  localStorage.setItem('cfg', JSON.stringify(CFG));
  showToast('Parámetros de evaluación guardados');
}

// Location management
function loadLocations() {
  const container = document.getElementById('chips_locs');
  const locations = CFG.default_locations || [];
  container.innerHTML = '';
  
  locations.forEach(loc => {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `<span class="t">${escapeHtml(loc)}</span> <span class="remove" onclick="removeLocation('${escapeHtml(loc)}')">×</span>`;
    container.appendChild(chip);
  });
}

function addLocation() {
  const input = document.getElementById('add_loc');
  const value = input.value.trim();
  if (!value) return;
  
  CFG.default_locations = CFG.default_locations || [];
  if (CFG.default_locations.includes(value)) {
    showToast('La localidad ya existe', 'error');
    return;
  }
  
  if (CFG.default_locations.length >= 12) {
    showToast('Máximo 12 localidades', 'error');
    return;
  }
  
  CFG.default_locations.push(value);
  localStorage.setItem('cfg', JSON.stringify(CFG));
  input.value = '';
  loadLocations();
}

function removeLocation(loc) {
  CFG.default_locations = (CFG.default_locations || []).filter(l => l !== loc);
  localStorage.setItem('cfg', JSON.stringify(CFG));
  loadLocations();
}

// Backup functions
function exportBackup() {
  const data = {
    cfg: JSON.parse(localStorage.getItem('cfg') || '{}'),
    evals: JSON.parse(localStorage.getItem('evals') || '[]'),
    pros: JSON.parse(localStorage.getItem('pros') || '[]'),
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `unihouser-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('Copia de seguridad exportada');
}

function importBackup() {
  const file = document.getElementById('importFile').files[0];
  if (!file) {
    showToast('Selecciona un archivo primero', 'error');
    return;
  }
  
  if (!confirm('¿Estás seguro? Esto sobrescribirá todos los datos actuales.')) {
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (data.cfg) localStorage.setItem('cfg', JSON.stringify(data.cfg));
      if (data.evals) localStorage.setItem('evals', JSON.stringify(data.evals));
      if (data.pros) localStorage.setItem('pros', JSON.stringify(data.pros));
      
      showToast('Datos importados correctamente');
      setTimeout(() => location.reload(), 1500);
    } catch (err) {
      showToast('Error al importar: archivo inválido', 'error');
    }
  };
  reader.readAsText(file);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Theme and color changes
function changeTheme() {
  const theme = document.getElementById('g_theme').value;
  document.documentElement.setAttribute('data-theme', theme);
}

function changeBrandColor() {
  const color = document.getElementById('g_brand').value;
  document.documentElement.style.setProperty('--brand-primary', color);
}

// Logo management
document.getElementById('logoInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    showToast('Por favor selecciona una imagen válida', 'error');
    return;
  }
  
  if (file.size > 2 * 1024 * 1024) {
    showToast('El archivo es muy grande. Máximo 2MB', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    CFG.brand_logo = dataUrl;
    
    document.getElementById('logoPreview').innerHTML = `<img src="${dataUrl}" alt="Logo">`;
    document.getElementById('removeLogoBtn').style.display = 'inline-block';
    
    // Update header logo
    const logoBox = document.getElementById('logoBox');
    if(logoBox) logoBox.innerHTML = `<img src="${dataUrl}" alt="Logo">`;
    
    localStorage.setItem('cfg', JSON.stringify(CFG));
    showToast('Logo cargado correctamente');
  };
  reader.readAsDataURL(file);
});

function removeLogo() {
  delete CFG.brand_logo;
  document.getElementById('logoPreview').innerHTML = '<div class="logo-placeholder">Sin logo</div>';
  document.getElementById('removeLogoBtn').style.display = 'none';
  
  // Reset header logo
  const logoBox = document.getElementById('logoBox');
  if(logoBox) logoBox.innerHTML = '<div class="logo-fallback">U</div>';
  
  localStorage.setItem('cfg', JSON.stringify(CFG));
  showToast('Logo eliminado');
}

// Toast notifications
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Initialize
loadValues();

// Add location on Enter key
document.getElementById('add_loc').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    addLocation();
  }
});
</script>
</body>
</html>