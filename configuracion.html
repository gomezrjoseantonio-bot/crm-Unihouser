<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Unihouser — Configuración</title>
<link rel="stylesheet" href="css/style.css">
<style>
.grid-2{display:grid;gap:12px;grid-template-columns:1fr}
.grid-3{display:grid;gap:12px;grid-template-columns:1fr}
.grid-4{display:grid;gap:12px;grid-template-columns:1fr}
@media(min-width:760px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:repeat(3,1fr)}.grid-4{grid-template-columns:repeat(4,1fr)}}
small.hint{color:var(--muted)}
.range-row{display:grid;grid-template-columns:160px 1fr 70px;gap:8px;align-items:center;margin-bottom:8px}
.range-row output{display:inline-block;min-width:54px;text-align:right}
.kpi-pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#f1f5f9;color:#0f1112;font-size:12px}
.toast-wrap{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:8px;z-index:100}
.toast{background:#0f1112;color:#fff;padding:10px 12px;border-radius:10px;opacity:.98}
.toast.ok{background:var(--ok)} .toast.warn{background:var(--warn)} .toast.bad{background:var(--bad)}
textarea{min-height:120px;resize:vertical}
.switch{display:flex;align-items:center;gap:10px}
.switch input{width:auto}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;background:#0f1214;border:1px solid #2b343a;border-radius:8px;padding:8px;color:var(--text)}
</style>
</head>
<body>
<header class="topbar">
  <div class="container flex between center">
    <div class="brand flex center"><div class="title">Unihouser — CRM & BuyBox</div></div>
    <nav class="nav">
      <a href="evaluar.html">Evaluar</a>
      <a href="evaluaciones.html">Evaluaciones</a>
      <a href="prospectos.html">Prospectos</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="configuracion.html" class="active">Configuración</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Configuración</h2>

    <!-- Costes & impuestos -->
    <div class="section">
      <h3>Costes de adquisición e impuestos</h3>
      <div class="grid-4">
        <div class="field">
          <label>ITP (%)</label>
          <input id="itp_pct" inputmode="decimal" data-percent>
          <small class="hint">Asturias por defecto 8,0</small>
        </div>
        <div class="field">
          <label>Notaría y Registro (€)</label>
          <input id="notaria_eur" inputmode="numeric" data-money>
          <small class="hint">Importe fijo recomendado: 1.500</small>
        </div>
        <div class="field">
          <label>Honorarios PSI (€ con IVA)</label>
          <input id="psi_eur" inputmode="numeric" data-money>
          <small class="hint">Recomendado: 4.235 (3.500 + IVA)</small>
        </div>
        <div class="field switch">
          <input type="checkbox" id="psi_incluir">
          <label for="psi_incluir">Incluir PSI por defecto en los cálculos</label>
        </div>
      </div>
    </div>

    <!-- Seguros & gestión -->
    <div class="section">
      <h3>Seguros y gestión (sobre alquiler anual)</h3>
      <div class="grid-4">
        <div class="field">
          <label>Seguro hogar (%)</label>
          <input id="hogar_pct" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Seguro impago — Tradicional (%)</label>
          <input id="impago_trad_pct" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Seguro impago — Habitaciones (%)</label>
          <input id="impago_hab_pct" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Gestión — Tradicional (%)</label>
          <input id="gestion_trad_pct" inputmode="decimal" data-percent>
        </div>
      </div>
      <div class="grid-4">
        <div class="field">
          <label>Gestión — Habitaciones (%)</label>
          <input id="gestion_hab_pct" inputmode="decimal" data-percent>
        </div>
      </div>
      <small class="hint">Se aplican automáticamente al cambiar alquiler/tipo en <strong>Evaluar</strong>.</small>
    </div>

    <!-- Objetivos por tipo -->
    <div class="section">
      <h3>Objetivos por tipo de alquiler</h3>
      <div class="grid-4">
        <div class="field">
          <label>Objetivo Bruta — Tradicional (%)</label>
          <input id="obj_bruta_trad" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Objetivo Bruta — Habitaciones (%)</label>
          <input id="obj_bruta_hab" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Objetivo Neta — Tradicional (%)</label>
          <input id="obj_neta_trad" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Objetivo Neta — Habitaciones (%)</label>
          <input id="obj_neta_hab" inputmode="decimal" data-percent>
        </div>
      </div>
      <div class="field" style="max-width:320px;margin-top:8px">
        <label>KPI por defecto</label>
        <select id="kpi_default">
          <option>Bruta</option>
          <option>Neta</option>
          <option>Flujo</option>
        </select>
      </div>
    </div>

    <!-- Matching sugerencias -->
    <div class="section">
      <h3>Ponderaciones de matching (sugerir clientes)</h3>
      <div class="mono" style="margin-bottom:8px">0 = no importa · 5 = muy importante</div>
      <div>
        <div class="range-row">
          <label>Zonas/localidades</label>
          <input id="w_zona" type="range" min="0" max="5" step="1"><output id="w_zona_o">0</output>
        </div>
        <div class="range-row">
          <label>Tipo de alquiler</label>
          <input id="w_tipo" type="range" min="0" max="5" step="1"><output id="w_tipo_o">0</output>
        </div>
        <div class="range-row">
          <label>Objetivo principal (KPI)</label>
          <input id="w_obj" type="range" min="0" max="5" step="1"><output id="w_obj_o">0</output>
        </div>
        <div class="range-row">
          <label>Rango de alquiler</label>
          <input id="w_rango" type="range" min="0" max="5" step="1"><output id="w_rango_o">0</output>
        </div>
        <div class="range-row">
          <label>Ascensor/altura/bajo</label>
          <input id="w_altura" type="range" min="0" max="5" step="1"><output id="w_altura_o">0</output>
        </div>
        <div class="range-row">
          <label>Reforma necesaria</label>
          <input id="w_reforma" type="range" min="0" max="5" step="1"><output id="w_reforma_o">0</output>
        </div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div class="field">
          <label>Umbral Score — Verde (≥ %)</label>
          <input id="t_green" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Umbral Score — Ámbar (≥ %)</label>
          <input id="t_amber" inputmode="decimal" data-percent>
        </div>
        <div class="field">
          <label>Rojo (&lt; Ámbar)</label>
          <input value="auto" disabled>
        </div>
      </div>
      <small class="hint">Estos pesos y umbrales se usan para “Clientes potenciales” en <strong>Evaluar</strong>.</small>
    </div>

    <!-- Plantillas -->
    <div class="section">
      <h3>Plantillas de comunicación</h3>
      <div class="kpi-pills">
        <span class="pill">{{nombre}}</span><span class="pill">{{calle}}</span><span class="pill">{{localidad}}</span>
        <span class="pill">{{bruta}}</span><span class="pill">{{neta}}</span><span class="pill">{{flujo}}</span><span class="pill">{{url}}</span>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="field">
          <label>Asunto Email</label>
          <input id="email_subject" placeholder="Informe Unihouser — {{calle}}, {{localidad}}">
        </div>
        <div class="field">
          <label>WhatsApp (plantilla)</label>
          <textarea id="wa_tpl" class="mono" placeholder="Hola {{nombre}}, te envío el informe del activo {{calle}}, {{localidad}}. Bruta: {{bruta}}%. {{url}}"></textarea>
        </div>
      </div>
      <div class="field">
        <label>Cuerpo Email (HTML permitido)</label>
        <textarea id="email_body" class="mono" placeholder="<p>Hola {{nombre}},</p><p>Adjuntamos el informe del activo {{calle}} ({{localidad}}).</p><p>Rentabilidad bruta: {{bruta}}% · neta: {{neta}}%.</p><p>Un saludo,<br>Unihouser</p>"></textarea>
      </div>
    </div>

    <!-- Acciones -->
    <div class="actions">
      <button class="btn" id="b_reset">Restablecer recomendado</button>
      <button class="btn primary" id="b_save">Guardar configuración</button>
    </div>
    <div id="save_note" class="muted" style="margin-top:6px"></div>
  </section>
</main>

<footer class="foot"><div class="container foot-inner">© 2025 Unihouser · unihouser.es · info@unihouser.es · 644 300 200</div></footer>

<div class="toast-wrap"></div>

<script>
(function(){
"use strict";

/* ===== Utils ===== */
var id=function(x){return document.getElementById(x)};
var fmtE0=new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0});
var fmtN0=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
var fmtN1=new Intl.NumberFormat('es-ES',{maximumFractionDigits:1});
function parseEs(str){
  if(str==null) return NaN;
  var s=String(str).trim().replace(/\./g,'').replace(',', '.');
  if(!s) return NaN;
  var n=Number(s);
  return isFinite(n)?n:NaN;
}
function toast(msg,kind){
  var wrap=document.querySelector('.toast-wrap'); if(!wrap) return;
  var el=document.createElement('div'); el.className='toast '+(kind||''); el.textContent=msg;
  wrap.appendChild(el); setTimeout(function(){el.style.opacity='0'},1600);
  setTimeout(function(){try{wrap.removeChild(el)}catch(_){}} ,2200);
}

/* ===== Store ===== */
var Store={
  get cfg(){ try{return JSON.parse(localStorage.getItem('cfg')||'{}')}catch(_){return{}} },
  set cfg(v){ localStorage.setItem('cfg', JSON.stringify(v)); }
};

/* ===== Defaults ===== */
var DEFAULTS={
  itp_pct:8.0, notaria_eur:1500, psi_eur:4235, psi_incluir:true,
  hogar_pct:3.5, impago_trad_pct:4.0, impago_hab_pct:4.0, gestion_trad_pct:15.0, gestion_hab_pct:25.0,
  obj_bruta_trad:10.0, obj_bruta_hab:12.0, obj_neta_trad:6.0, obj_neta_hab:7.0, kpi_default:"Bruta",
  match_weights:{zona:4,tipo:4,objetivo:5,rango:3,altura:2,reforma:2},
  match_thresholds:{green:75,amber:50},
  email_subject:"Informe Unihouser — {{calle}}, {{localidad}}",
  email_body:"<p>Hola {{nombre}},</p><p>Adjuntamos el informe del activo {{calle}} ({{localidad}}).</p><p>Rentabilidad bruta: {{bruta}}% · neta: {{neta}}%.</p><p>Un saludo,<br>Unihouser</p>",
  wa_tpl:"Hola {{nombre}}, te envío el informe del activo {{calle}}, {{localidad}}. Bruta: {{bruta}}%. {{url}}"
};

/* ===== Formateadores de inputs ===== */
function moneyify(inp){
  inp.addEventListener('input', function(){
    var digits=(inp.value||'').replace(/[^\d]/g,'');
    if(!digits){inp.value='';return;}
    var n=Number(digits);
    inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(n);
  });
  inp.addEventListener('blur', function(){
    var n=parseEs(inp.value);
    if(isFinite(n)) inp.value=new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(Math.round(n));
  });
}
function percentify(inp){
  inp.addEventListener('input', function(){
    var s=(inp.value||'').replace(/[^\d,.-]/g,'').replace(/,/g,'.');
    var n=Number(s); if(!isFinite(n)) return;
    inp.value=fmtN1.format(n).replace('.',',');
  });
  inp.addEventListener('blur', function(){
    var n=parseEs(inp.value);
    if(isFinite(n)) inp.value=fmtN1.format(n).replace('.',',');
  });
}
function bindRanges(){
  [['w_zona','w_zona_o'],['w_tipo','w_tipo_o'],['w_obj','w_obj_o'],['w_rango','w_rango_o'],['w_altura','w_altura_o'],['w_reforma','w_reforma_o']]
  .forEach(function(pair){
    var rr=id(pair[0]), oo=id(pair[1]);
    var sync=function(){ oo.textContent=rr.value; };
    rr.addEventListener('input', sync); sync();
  });
}

/* ===== Cargar CFG -> Form ===== */
function loadCfgToForm(){
  var cfg=Object.assign({},DEFAULTS,Store.cfg||{});

  id('itp_pct').value=fmtN1.format(cfg.itp_pct).replace('.',',');
  id('notaria_eur').value=fmtN0.format(cfg.notaria_eur);
  id('psi_eur').value=fmtN0.format(cfg.psi_eur);
  id('psi_incluir').checked=!!cfg.psi_incluir;

  id('hogar_pct').value=fmtN1.format(cfg.hogar_pct).replace('.',',');
  id('impago_trad_pct').value=fmtN1.format(cfg.impago_trad_pct).replace('.',',');
  id('impago_hab_pct').value=fmtN1.format(cfg.impago_hab_pct).replace('.',',');
  id('gestion_trad_pct').value=fmtN1.format(cfg.gestion_trad_pct).replace('.',',');
  id('gestion_hab_pct').value=fmtN1.format(cfg.gestion_hab_pct).replace('.',',');

  id('obj_bruta_trad').value=fmtN1.format(cfg.obj_bruta_trad).replace('.',',');
  id('obj_bruta_hab').value=fmtN1.format(cfg.obj_bruta_hab).replace('.',',');
  id('obj_neta_trad').value=fmtN1.format(cfg.obj_neta_trad).replace('.',',');
  id('obj_neta_hab').value=fmtN1.format(cfg.obj_neta_hab).replace('.',',');
  id('kpi_default').value=cfg.kpi_default||'Bruta';

  var mw=(cfg.match_weights||{});
  id('w_zona').value=Number(mw.zona!=null?mw.zona:DEFAULTS.match_weights.zona);
  id('w_tipo').value=Number(mw.tipo!=null?mw.tipo:DEFAULTS.match_weights.tipo);
  id('w_obj').value=Number(mw.objetivo!=null?mw.objetivo:DEFAULTS.match_weights.objetivo);
  id('w_rango').value=Number(mw.rango!=null?mw.rango:DEFAULTS.match_weights.rango);
  id('w_altura').value=Number(mw.altura!=null?mw.altura:DEFAULTS.match_weights.altura);
  id('w_reforma').value=Number(mw.reforma!=null?mw.reforma:DEFAULTS.match_weights.reforma);

  var th=(cfg.match_thresholds||{});
  id('t_green').value=fmtN1.format((th.green!=null?th.green:DEFAULTS.match_thresholds.green)).replace('.',',');
  id('t_amber').value=fmtN1.format((th.amber!=null?th.amber:DEFAULTS.match_thresholds.amber)).replace('.',',');

  id('email_subject').value=cfg.email_subject||DEFAULTS.email_subject;
  id('email_body').value=cfg.email_body||DEFAULTS.email_body;
  id('wa_tpl').value=cfg.wa_tpl||DEFAULTS.wa_tpl;

  bindRanges();
}

/* ===== Form -> CFG ===== */
function getCfgFromForm(){
  function pct(el){var v=parseEs(id(el).value); return isFinite(v)?v:0}
  function eur(el){var v=parseEs(id(el).value); return isFinite(v)?v:0}
  function rng(el){return Number(id(el).value||0)}

  var cfg=Object.assign({},DEFAULTS,Store.cfg||{});

  cfg.itp_pct=pct('itp_pct');
  cfg.notaria_eur=eur('notaria_eur');
  cfg.psi_eur=eur('psi_eur');
  cfg.psi_incluir=!!id('psi_incluir').checked;

  cfg.hogar_pct=pct('hogar_pct');
  cfg.impago_trad_pct=pct('impago_trad_pct');
  cfg.impago_hab_pct=pct('impago_hab_pct');
  cfg.gestion_trad_pct=pct('gestion_trad_pct');
  cfg.gestion_hab_pct=pct('gestion_hab_pct');

  cfg.obj_bruta_trad=pct('obj_bruta_trad');
  cfg.obj_bruta_hab=pct('obj_bruta_hab');
  cfg.obj_neta_trad=pct('obj_neta_trad');
  cfg.obj_neta_hab=pct('obj_neta_hab');
  cfg.kpi_default=id('kpi_default').value;

  cfg.match_weights={
    zona:rng('w_zona'),
    tipo:rng('w_tipo'),
    objetivo:rng('w_obj'),
    rango:rng('w_rango'),
    altura:rng('w_altura'),
    reforma:rng('w_reforma')
  };
  cfg.match_thresholds={
    green:parseEs(id('t_green').value)||DEFAULTS.match_thresholds.green,
    amber:parseEs(id('t_amber').value)||DEFAULTS.match_thresholds.amber
  };

  cfg.email_subject=(id('email_subject').value||'').trim();
  cfg.email_body=(id('email_body').value||'').trim();
  cfg.wa_tpl=(id('wa_tpl').value||'').trim();

  return cfg;
}

/* ===== Bind ===== */
function bindFormatting(){
  Array.prototype.forEach.call(document.querySelectorAll('input[data-money]'),moneyify);
  Array.prototype.forEach.call(document.querySelectorAll('input[data-percent]'),percentify);
}
function attach(){
  bindFormatting();
  loadCfgToForm();

  id('b_save').addEventListener('click', function(){
    var cfg=getCfgFromForm();
    Store.cfg=cfg;
    toast('Configuración guardada','ok');
    var t=new Date();
    id('save_note').textContent='Nueva configuración guardada con éxito · '+t.toLocaleTimeString('es-ES');
  });

  id('b_reset').addEventListener('click', function(){
    if(!confirm('¿Restablecer valores recomendados?')) return;
    Store.cfg=DEFAULTS;
    loadCfgToForm();
    toast('Valores recomendados aplicados','warn');
  });
}

document.addEventListener('DOMContentLoaded', attach);
})();
</script>
</body>
</html>
